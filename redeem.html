<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>Activer mon code cadeau ‚Äî Cinq</title>
    
    <!-- SEO -->
    <meta name="description" content="Activez votre code cadeau Cinq et rejoignez l'anti-r√©seau social. 5 personnes. Pas 500.">
    <meta name="keywords" content="cinq, cadeau, activation, r√©seau social, anti social">
    <meta name="author" content="Cinq">
    
    <!-- Canonical -->
    <link rel="canonical" href="https://cinq.app/redeem">
    
    <!-- Open Graph -->
    <meta property="og:title" content="üéÅ Activer mon code cadeau ‚Äî Cinq">
    <meta property="og:description" content="Tu as re√ßu un code cadeau Cinq ? Active-le ici et rejoins l'anti-r√©seau social.">
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://cinq.app/redeem">
    <meta property="og:image" content="https://cinq.app/og-redeem.png">
    <meta property="og:site_name" content="Cinq">
    <meta property="og:locale" content="fr_FR">
    
    <!-- Twitter -->
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:title" content="üéÅ Activer mon code Cinq">
    <meta name="twitter:description" content="5 personnes. Pas 500. Active ton acc√®s.">
    <meta name="twitter:image" content="https://cinq.app/og-redeem.png">
    <meta name="twitter:site" content="@cinqapp">
    
    <!-- Favicon -->
    <link rel="icon" type="image/svg+xml" href="/favicon.svg">
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
    <link rel="apple-touch-icon" sizes="180x180" href="/assets/icons/icon-192x192.png">
    <meta name="theme-color" content="#0a0a0b">
    
    <!-- PWA -->
    <link rel="manifest" href="/manifest.json">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Cinq">
    
    <!-- Content Security Policy -->
    <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' 'unsafe-inline' https://cdn.tailwindcss.com https://plausible.io; style-src 'self' 'unsafe-inline' https://fonts.googleapis.com; font-src https://fonts.gstatic.com; connect-src 'self' https://api.cinq.app https://*.netlify.app https://plausible.io; img-src 'self' data: https:;">
    
    <!-- Design System -->
    <link rel="stylesheet" href="/design/styles.min.css">
    <link rel="stylesheet" href="/css/mobile-responsive.min.css">
    
    <!-- Theme initialization (before body to prevent flash) -->
    <script>
        (function() {
            const saved = localStorage.getItem('cinq_theme');
            if (saved) {
                document.documentElement.setAttribute('data-theme', saved);
            } else if (window.matchMedia('(prefers-color-scheme: light)').matches) {
                document.documentElement.setAttribute('data-theme', 'light');
            }
        })();
        
        function toggleTheme() {
            const html = document.documentElement;
            const current = html.getAttribute('data-theme');
            const next = current === 'light' ? 'dark' : 'light';
            html.setAttribute('data-theme', next);
            localStorage.setItem('cinq_theme', next);
        }
    </script>
    
    <!-- Analytics (Plausible - RGPD compliant, no cookies) -->
    <script defer src="/analytics.js"></script>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;500;600;700&family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
    
    <style>
        body { font-family: 'Inter', sans-serif; }
        h1, h2, h3, h4, h5, h6, .font-display { font-family: 'Space Grotesk', sans-serif; }
        
        /* Background gradient - coh√©rent avec gift.html */
        .gradient-bg {
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
        }
        
        /* Effet glow pour les √©l√©ments importants */
        .glow {
            box-shadow: 0 0 60px rgba(99, 102, 241, 0.3);
        }
        .glow-success {
            box-shadow: 0 0 60px rgba(34, 197, 94, 0.4);
        }
        
        /* Animation des cercles d√©coratifs */
        .circle {
            animation: pulse 4s ease-in-out infinite;
        }
        @keyframes pulse {
            0%, 100% { transform: scale(1); opacity: 0.5; }
            50% { transform: scale(1.05); opacity: 0.8; }
        }
        
        /* Animation de fade pour les transitions d'√©cran */
        .screen {
            animation: fadeIn 0.3s ease-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        /* Animation loader */
        .loader-dot {
            animation: loaderPulse 1.4s ease-in-out infinite;
        }
        .loader-dot:nth-child(2) { animation-delay: 0.2s; }
        .loader-dot:nth-child(3) { animation-delay: 0.4s; }
        @keyframes loaderPulse {
            0%, 80%, 100% { transform: scale(0.6); opacity: 0.5; }
            40% { transform: scale(1); opacity: 1; }
        }
        
        /* Animation celebration */
        @keyframes celebrate {
            0% { transform: scale(0.5); opacity: 0; }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); opacity: 1; }
        }
        .celebrate {
            animation: celebrate 0.5s ease-out;
        }
        
        /* Input styling */
        .code-input {
            font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
            letter-spacing: 0.1em;
            text-transform: uppercase;
        }
        .code-input::placeholder {
            text-transform: none;
            letter-spacing: normal;
            color: rgba(255, 255, 255, 0.5);
        }
        .code-input:focus {
            outline: none;
            border-color: rgba(99, 102, 241, 0.8);
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.2);
        }
        .code-input.valid {
            border-color: rgba(34, 197, 94, 0.8);
            box-shadow: 0 0 0 3px rgba(34, 197, 94, 0.2);
        }
        .code-input.invalid {
            border-color: rgba(239, 68, 68, 0.8);
            box-shadow: 0 0 0 3px rgba(239, 68, 68, 0.2);
        }
        
        /* Email input styling */
        .email-input:focus {
            outline: none;
            border-color: rgba(99, 102, 241, 0.8);
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.2);
        }
        
        /* Accessibilit√©: Focus visible */
        button:focus-visible,
        a:focus-visible,
        input:focus-visible {
            outline: 2px solid rgba(99, 102, 241, 0.8);
            outline-offset: 2px;
            border-radius: 0.5rem;
        }
        
        /* Accessibilit√©: Reduced motion */
        @media (prefers-reduced-motion: reduce) {
            .circle,
            .loader-dot,
            .celebrate,
            .screen {
                animation: none !important;
            }
        }
        
        /* √âtats d'erreur */
        .error-state {
            background: rgba(239, 68, 68, 0.1);
            border-color: rgba(239, 68, 68, 0.5);
        }
        
        /* Bouton disabled */
        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
    </style>
    <script src="/fun.js"></script>
</head>
<body class="gradient-bg min-h-screen text-white">
    <!-- Theme Toggle -->
    <button class="theme-toggle" onclick="toggleTheme()" aria-label="Basculer mode clair/sombre" style="position: fixed; top: 1rem; right: 1rem; z-index: 100;">
        <svg class="icon-sun" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg>
        <svg class="icon-moon" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/></svg>
    </button>
    
    <!-- Cercles d√©coratifs -->
    <div class="fixed inset-0 overflow-hidden pointer-events-none" aria-hidden="true">
        <div class="circle absolute -top-20 -left-20 w-96 h-96 bg-indigo-500/20 rounded-full blur-3xl"></div>
        <div class="circle absolute top-1/2 -right-32 w-80 h-80 bg-purple-500/20 rounded-full blur-3xl" style="animation-delay: -2s;"></div>
        <div class="circle absolute -bottom-20 left-1/3 w-72 h-72 bg-blue-500/20 rounded-full blur-3xl" style="animation-delay: -1s;"></div>
    </div>

    <!-- Container principal -->
    <main class="relative z-10 min-h-screen flex flex-col items-center justify-center px-4 py-8" role="main">
        
        <!-- Zone d'annonces pour lecteurs d'√©cran -->
        <div id="sr-announcements" class="sr-only" aria-live="assertive" aria-atomic="true"></div>
        
        <!-- ==========================================
             √âCRAN 1: Saisie du code
             ========================================== -->
        <section id="screen-code" class="screen w-full max-w-md" aria-labelledby="code-title">
            
            <!-- Logo -->
            <div class="flex justify-center mb-8">
                <div class="w-24 h-24 rounded-full border-4 border-white/20 flex items-center justify-center glow bg-white/5 backdrop-blur" aria-hidden="true">
                    <svg class="text-4xl" width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="var(--color-brand)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="8" width="18" height="13" rx="2"/><path d="M12 8v13"/><path d="M3 12h18"/><path d="M12 8c-2.5-3-6-2-6 0s3.5 2 6 0"/><path d="M12 8c2.5-3 6-2 6 0s-3.5 2-6 0"/></svg>
                </div>
            </div>
            
            <!-- Titre -->
            <h1 id="code-title" class="text-2xl md:text-3xl font-bold mb-4 text-center leading-tight">
                Tu as re√ßu un cadeau
            </h1>
            
            <!-- Sous-titre -->
            <p class="text-lg text-center text-white/80 mb-8">
                Entre ton code pour activer ton acc√®s √† <span class="font-semibold text-white">Cinq</span>
            </p>
            
            <!-- Formulaire code -->
            <form id="code-form" onsubmit="CinqRedeem.verifyCode(event)" class="space-y-6">
                
                <!-- Input code -->
                <div>
                    <label for="gift-code" class="block text-sm font-medium text-white/90 mb-2">
                        Code cadeau
                    </label>
                    <input 
                        type="text" 
                        id="gift-code"
                        name="code"
                        class="code-input w-full px-4 py-4 bg-white/10 border-2 border-white/20 rounded-xl text-xl text-center placeholder-white/40 transition-all"
                        placeholder="CINQ-XXXX-XXXX-XXXX"
                        maxlength="19"
                        autocomplete="off"
                        autocapitalize="characters"
                        spellcheck="false"
                        oninput="CinqRedeem.formatCode(this)"
                        aria-describedby="code-hint code-error"
                        required
                    >
                    <p id="code-hint" class="mt-2 text-sm text-white/60">
                        Format: CINQ-XXXX-XXXX-XXXX
                    </p>
                    <p id="code-error" class="hidden mt-2 text-sm text-red-400" role="alert"></p>
                </div>
                
                <!-- Bouton -->
                <button 
                    type="submit"
                    id="verify-btn"
                    class="w-full py-4 px-6 bg-indigo-500 hover:bg-indigo-400 disabled:hover:bg-indigo-500 rounded-xl font-semibold text-lg transition transform hover:scale-[1.02] active:scale-[0.98] flex items-center justify-center gap-3"
                >
                    <span id="verify-btn-icon" aria-hidden="true">üîì</span>
                    <span id="verify-btn-text">Activer mon acc√®s</span>
                </button>
                
            </form>
            
            <!-- Lien acheter -->
            <div class="mt-8 text-center">
                <a href="/gift" class="text-white/60 hover:text-white/80 text-sm transition">
                    Pas encore de code ? <span class="underline">Acheter un acc√®s ‚Üí</span>
                </a>
            </div>
            
        </section>

        <!-- ==========================================
             √âCRAN 2: Cr√©ation de compte (email + password)
             ========================================== -->
        <section id="screen-email" class="screen w-full max-w-md hidden" aria-labelledby="email-title">
            
            <!-- Header avec retour -->
            <button onclick="CinqRedeem.showScreen('code')" aria-label="Retour" class="flex items-center gap-2 text-white/60 hover:text-white mb-8 transition">
                <span aria-hidden="true">‚Üê</span>
                <span>Retour</span>
            </button>
            
            <!-- Ic√¥ne -->
            <div class="flex justify-center mb-6">
                <div class="w-16 h-16 rounded-full bg-indigo-500/20 border-2 border-indigo-400/50 flex items-center justify-center" aria-hidden="true">
                    <span class="text-2xl">üîê</span>
                </div>
            </div>
            
            <!-- Titre -->
            <h2 id="email-title" class="text-2xl font-bold text-center mb-2">
                Cr√©e ton compte
            </h2>
            <p class="text-center text-white/80 mb-8">
                Une derni√®re √©tape pour activer ton acc√®s
            </p>
            
            <!-- Info code -->
            <div id="code-info" class="bg-white/5 backdrop-blur border border-white/10 rounded-xl p-4 mb-6">
                <div class="flex items-center justify-between">
                    <span class="text-white/70 text-sm">Code cadeau</span>
                    <span id="verified-code" class="font-mono text-indigo-400"></span>
                </div>
            </div>
            
            <!-- Formulaire email + password -->
            <form id="email-form" onsubmit="CinqRedeem.createAccount(event)" class="space-y-5">
                
                <!-- Input email -->
                <div>
                    <label for="user-email" class="block text-sm font-medium text-white/90 mb-2">
                        Ton adresse email
                    </label>
                    <input 
                        type="email" 
                        id="user-email"
                        name="email"
                        class="email-input w-full px-4 py-4 bg-white/10 border-2 border-white/20 rounded-xl text-lg placeholder-white/40 transition-all"
                        placeholder="ton@email.com"
                        autocomplete="email"
                        aria-describedby="email-error"
                        required
                    >
                    <p id="email-error" class="hidden mt-2 text-sm text-red-400" role="alert"></p>
                </div>
                
                <!-- Input password -->
                <div>
                    <label for="user-password" class="block text-sm font-medium text-white/90 mb-2">
                        Choisis un mot de passe
                    </label>
                    <input 
                        type="password" 
                        id="user-password"
                        name="password"
                        class="email-input w-full px-4 py-4 bg-white/10 border-2 border-white/20 rounded-xl text-lg placeholder-white/40 transition-all"
                        placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"
                        autocomplete="new-password"
                        minlength="8"
                        aria-describedby="password-hint password-error"
                        required
                    >
                    <p id="password-hint" class="mt-2 text-sm text-white/60">
                        Minimum 8 caract√®res, avec au moins une lettre et un chiffre
                    </p>
                    <p id="password-error" class="hidden mt-2 text-sm text-red-400" role="alert"></p>
                </div>
                
                <!-- Checkbox acceptation -->
                <div class="flex items-start gap-3">
                    <input 
                        type="checkbox" 
                        id="accept-terms"
                        name="terms"
                        class="mt-1 w-5 h-5 rounded border-white/20 bg-white/10 text-indigo-500 focus:ring-indigo-500 focus:ring-offset-0"
                        required
                    >
                    <label for="accept-terms" class="text-sm text-white/80">
                        J'accepte les <a href="/terms" class="text-indigo-400 hover:underline">conditions d'utilisation</a> 
                        et la <a href="/privacy" class="text-indigo-400 hover:underline">politique de confidentialit√©</a>
                    </label>
                </div>
                
                <!-- Bouton -->
                <button 
                    type="submit"
                    id="create-btn"
                    class="w-full py-4 px-6 bg-indigo-500 hover:bg-indigo-400 disabled:hover:bg-indigo-500 rounded-xl font-semibold text-lg transition transform hover:scale-[1.02] active:scale-[0.98] flex items-center justify-center gap-3"
                >
                    <span id="create-btn-icon" aria-hidden="true">üöÄ</span>
                    <span id="create-btn-text">Cr√©er mon compte</span>
                </button>
                
            </form>
            
            <!-- Note -->
            <p class="text-center mt-6 text-white/60 text-xs">
                Tu as d√©j√† un compte ? <a href="/login" class="text-indigo-400 hover:underline">Connecte-toi</a>
            </p>
            
        </section>

        <!-- ==========================================
             √âCRAN 3: Succ√®s
             ========================================== -->
        <section id="screen-success" class="screen w-full max-w-md hidden" aria-labelledby="success-title">
            
            <!-- Animation de succ√®s -->
            <div class="flex justify-center mb-6">
                <div class="celebrate w-24 h-24 rounded-full border-4 border-emerald-400/50 flex items-center justify-center glow-success bg-emerald-500/10 backdrop-blur" aria-hidden="true">
                    <svg class="text-5xl" width="50" height="50" viewBox="0 0 24 24" fill="none" stroke="var(--color-success)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/></svg>
                </div>
            </div>
            
            <!-- Titre -->
            <h2 id="success-title" class="text-2xl font-bold text-center mb-2 text-emerald-400">
                Bienvenue dans le cercle ! üíú
            </h2>
            <p class="text-center text-white/80 mb-8">
                Ton compte est pr√™t. Maintenant, choisis bien tes 5.<br>
                <span class="text-white/60 text-sm">(Pas de pression. Ou un peu.)</span>
            </p>
            
            <!-- R√©cap -->
            <div class="bg-white/5 backdrop-blur border border-emerald-400/30 rounded-2xl p-6 mb-8">
                <div class="space-y-3 text-sm">
                    <div class="flex items-center justify-between">
                        <span class="text-white/70">Email</span>
                        <span id="success-email" class="text-white font-medium"></span>
                    </div>
                    <div class="flex items-center justify-between">
                        <span class="text-white/70">Acc√®s</span>
                        <span class="text-emerald-400 font-medium">‚úì Activ√© √† vie</span>
                    </div>
                </div>
            </div>
            
            <!-- Message connexion -->
            <div class="bg-indigo-500/10 border border-indigo-400/30 rounded-xl p-4 mb-8">
                <div class="flex gap-3">
                    <span class="text-xl" aria-hidden="true">üîê</span>
                    <div>
                        <p class="text-white/90 font-medium">Ton compte est pr√™t</p>
                        <p class="text-white/70 text-sm mt-1">
                            Tu peux maintenant te connecter avec ton email et mot de passe.
                        </p>
                    </div>
                </div>
            </div>
            
            <!-- Timer redirect -->
            <p id="redirect-notice" class="text-center text-white/60 text-sm mb-6">
                Redirection automatique dans <span id="redirect-timer">5</span>s...
            </p>
            
            <!-- CTA -->
            <a 
                href="/login"
                id="go-app-btn"
                class="block w-full py-4 px-6 bg-indigo-500 hover:bg-indigo-400 rounded-xl font-semibold text-lg text-center transition transform hover:scale-[1.02] active:scale-[0.98]"
            >
                Se connecter ‚Üí
            </a>
            
            <!-- Lien secondaire -->
            <div class="mt-6 text-center">
                <a href="/" class="text-white/60 hover:text-white/80 text-sm transition">
                    ‚Üê Retour √† l'accueil
                </a>
            </div>
            
        </section>

        <!-- ==========================================
             √âCRAN 4: Erreur
             ========================================== -->
        <section id="screen-error" class="screen w-full max-w-md hidden" aria-labelledby="error-title">
            
            <!-- Ic√¥ne erreur -->
            <div class="flex justify-center mb-6">
                <div class="w-24 h-24 rounded-full border-4 border-red-400/50 flex items-center justify-center bg-red-500/10 backdrop-blur" aria-hidden="true">
                    <span class="text-5xl">üòï</span>
                </div>
            </div>
            
            <!-- Titre -->
            <h2 id="error-title" class="text-2xl font-bold text-center mb-2 text-red-400">
                Oups, un probl√®me
            </h2>
            <p id="error-message" class="text-center text-white/80 mb-8">
                Une erreur s'est produite
            </p>
            
            <!-- D√©tail erreur -->
            <div id="error-detail" class="bg-red-500/10 border border-red-400/30 rounded-xl p-4 mb-8 text-red-300 text-sm">
            </div>
            
            <!-- Bouton r√©essayer -->
            <button 
                onclick="CinqRedeem.showScreen('code')"
                class="w-full py-4 px-6 bg-white/10 hover:bg-white/15 border border-white/20 rounded-xl font-semibold text-lg transition flex items-center justify-center gap-3"
            >
                <span aria-hidden="true">‚Üª</span>
                <span>R√©essayer</span>
            </button>
            
            <!-- Contact support -->
            <div class="mt-8 text-center">
                <p class="text-white/60 text-sm">
                    Besoin d'aide ? <a href="mailto:support@cinq.app" class="text-indigo-400 hover:underline">Contacte le support</a>
                </p>
            </div>
            
        </section>

    </main>

    <!-- JavaScript -->
    <script>
        /**
         * CinqRedeem - Module d'activation de codes cadeaux
         */
        const CinqRedeem = (function() {
            'use strict';
            
            // ========================================
            // Configuration
            // ========================================
            const API_BASE = '/.netlify/functions';
            const CODE_PATTERN = /^CINQ-[A-Z0-9]{4}-[A-Z0-9]{4}-[A-Z0-9]{4}$/;
            const REDIRECT_DELAY = 5; // secondes
            
            // √âtat interne
            let _state = {
                verifiedCode: null,
                giftData: null,
                redirectTimer: null
            };
            
            // ========================================
            // Utilitaires
            // ========================================
            
            function escapeHtml(str) {
                if (typeof str !== 'string') return '';
                const div = document.createElement('div');
                div.textContent = str;
                return div.innerHTML;
            }
            
            function announce(message) {
                const el = document.getElementById('sr-announcements');
                if (el) el.textContent = message;
            }
            
            function showError(elementId, message) {
                const el = document.getElementById(elementId);
                if (el) {
                    el.textContent = escapeHtml(message);
                    el.classList.remove('hidden');
                }
            }
            
            function hideError(elementId) {
                const el = document.getElementById(elementId);
                if (el) el.classList.add('hidden');
            }
            
            function setButtonLoading(btnId, iconId, textId, loading, loadingText = 'Chargement...') {
                const btn = document.getElementById(btnId);
                const icon = document.getElementById(iconId);
                const text = document.getElementById(textId);
                
                if (loading) {
                    btn.disabled = true;
                    icon.innerHTML = '<div class="flex gap-1"><div class="loader-dot w-2 h-2 rounded-full bg-white"></div><div class="loader-dot w-2 h-2 rounded-full bg-white"></div><div class="loader-dot w-2 h-2 rounded-full bg-white"></div></div>';
                    text.dataset.originalText = text.textContent;
                    text.textContent = loadingText;
                } else {
                    btn.disabled = false;
                    icon.textContent = icon.dataset.originalIcon || 'üîì';
                    text.textContent = text.dataset.originalText || 'Activer mon acc√®s';
                }
            }
            
            // ========================================
            // Navigation
            // ========================================
            function showScreen(screenName) {
                // Cacher tous les √©crans
                document.querySelectorAll('.screen').forEach(screen => {
                    screen.classList.add('hidden');
                    screen.setAttribute('aria-hidden', 'true');
                });
                
                // Afficher l'√©cran demand√©
                const targetScreen = document.getElementById(`screen-${screenName}`);
                if (targetScreen) {
                    targetScreen.classList.remove('hidden');
                    targetScreen.setAttribute('aria-hidden', 'false');
                    
                    // Focus sur premier √©l√©ment interactif
                    setTimeout(() => {
                        const focusable = targetScreen.querySelector('input, button, a');
                        if (focusable) focusable.focus();
                    }, 100);
                }
                
                // Arr√™ter le timer de redirect si on change d'√©cran
                if (screenName !== 'success' && _state.redirectTimer) {
                    clearInterval(_state.redirectTimer);
                    _state.redirectTimer = null;
                }
            }
            
            // ========================================
            // Formatage du code
            // ========================================
            function formatCode(input) {
                let value = input.value.toUpperCase().replace(/[^A-Z0-9]/g, '');
                
                // Ajouter le pr√©fixe CINQ si pas pr√©sent
                if (value.length > 0 && !value.startsWith('CINQ')) {
                    // Si l'utilisateur tape autre chose, on laisse faire
                }
                
                // Formater avec les tirets
                let formatted = '';
                if (value.length > 0) {
                    // CINQ
                    formatted = value.slice(0, 4);
                    if (value.length > 4) {
                        formatted += '-' + value.slice(4, 8);
                    }
                    if (value.length > 8) {
                        formatted += '-' + value.slice(8, 12);
                    }
                    if (value.length > 12) {
                        formatted += '-' + value.slice(12, 16);
                    }
                }
                
                input.value = formatted;
                
                // Validation visuelle
                const isComplete = formatted.length === 19;
                const isValid = CODE_PATTERN.test(formatted);
                
                input.classList.remove('valid', 'invalid');
                if (isComplete) {
                    input.classList.add(isValid ? 'valid' : 'invalid');
                }
                
                hideError('code-error');
            }
            
            // ========================================
            // Validation du code (√âtape 1) - Format only
            // La v√©rification compl√®te se fait √† la cr√©ation du compte
            // ========================================
            async function verifyCode(event) {
                event.preventDefault();
                
                const codeInput = document.getElementById('gift-code');
                const code = codeInput.value.trim().toUpperCase();
                
                // Validation format uniquement
                if (!CODE_PATTERN.test(code)) {
                    codeInput.classList.add('invalid');
                    showError('code-error', 'Format invalide. Le code doit √™tre au format CINQ-XXXX-XXXX-XXXX');
                    announce('Format de code invalide');
                    return;
                }
                
                hideError('code-error');
                
                // Stocker le code pour l'√©tape suivante
                _state.verifiedCode = code;
                
                // Afficher le code dans l'√©cran suivant
                document.getElementById('verified-code').textContent = code;
                
                // Passer directement √† l'√©cran de cr√©ation de compte
                showScreen('email');
                announce('Entrez votre email et mot de passe pour cr√©er votre compte.');
            }
            
            // ========================================
            // Cr√©ation de compte (√âtape 2)
            // Appelle auth-register qui v√©rifie le code + cr√©e le compte
            // ========================================
            async function createAccount(event) {
                event.preventDefault();
                
                const emailInput = document.getElementById('user-email');
                const passwordInput = document.getElementById('user-password');
                const termsCheckbox = document.getElementById('accept-terms');
                const email = emailInput.value.trim().toLowerCase();
                const password = passwordInput.value;
                
                // Clear previous errors
                hideError('email-error');
                hideError('password-error');
                
                // Validation email basique
                const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
                if (!emailRegex.test(email)) {
                    showError('email-error', 'Adresse email invalide');
                    emailInput.focus();
                    return;
                }
                
                // Validation password
                if (password.length < 8) {
                    showError('password-error', 'Le mot de passe doit contenir au moins 8 caract√®res');
                    passwordInput.focus();
                    return;
                }
                if (!/\d/.test(password) || !/[a-zA-Z]/.test(password)) {
                    showError('password-error', 'Le mot de passe doit contenir au moins une lettre et un chiffre');
                    passwordInput.focus();
                    return;
                }
                
                // Validation terms
                if (!termsCheckbox.checked) {
                    showError('email-error', 'Tu dois accepter les conditions d\'utilisation');
                    return;
                }
                
                // UI loading
                const btn = document.getElementById('create-btn');
                const icon = document.getElementById('create-btn-icon');
                const text = document.getElementById('create-btn-text');
                
                btn.disabled = true;
                icon.innerHTML = '<div class="flex gap-1"><div class="loader-dot w-2 h-2 rounded-full bg-white"></div><div class="loader-dot w-2 h-2 rounded-full bg-white"></div><div class="loader-dot w-2 h-2 rounded-full bg-white"></div></div>';
                text.textContent = 'Cr√©ation en cours...';
                
                try {
                    // Appel API auth-register (v√©rifie code + cr√©e compte en un seul appel)
                    const response = await fetch(`${API_BASE}/auth-register`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            email: email,
                            password: password,
                            giftCode: _state.verifiedCode
                        })
                    });
                    
                    const data = await response.json();
                    
                    if (!response.ok) {
                        throw new Error(data.error || 'Erreur lors de la cr√©ation du compte');
                    }
                    
                    // Succ√®s !
                    document.getElementById('success-email').textContent = email;
                    
                    // Afficher √©cran succ√®s
                    showScreen('success');
                    announce('Compte cr√©√© avec succ√®s ! Tu peux maintenant te connecter.');
                    
                    // Track gift redeemed
                    if (window.CinqAnalytics) {
                        CinqAnalytics.trackGiftRedeemed({ source: 'web' });
                    }
                    
                    // üéâ Celebrate!
                    if (typeof launchConfetti === 'function') {
                        launchConfetti({ particleCount: 150, spread: 100 });
                    }
                    
                    // D√©marrer le countdown de redirection
                    startRedirectCountdown();
                    
                } catch (error) {
                    // Remettre le bouton en √©tat normal
                    btn.disabled = false;
                    icon.textContent = 'üöÄ';
                    text.textContent = 'Cr√©er mon compte';
                    
                    // Afficher l'erreur inline si c'est li√© au code ou √† l'email
                    const errorMsg = error.message.toLowerCase();
                    if (errorMsg.includes('code') || errorMsg.includes('gift')) {
                        // Retourner √† l'√©cran du code avec l'erreur
                        showScreen('code');
                        showError('code-error', error.message);
                    } else if (errorMsg.includes('email') || errorMsg.includes('account')) {
                        showError('email-error', error.message);
                    } else if (errorMsg.includes('password')) {
                        showError('password-error', error.message);
                    } else {
                        // Erreur g√©n√©rique ‚Üí √©cran d'erreur
                        document.getElementById('error-message').textContent = 'Impossible de cr√©er ton compte';
                        document.getElementById('error-detail').textContent = error.message;
                        showScreen('error');
                    }
                    announce('Erreur: ' + error.message);
                }
            }
            
            // ========================================
            // Redirection automatique
            // ========================================
            function startRedirectCountdown() {
                let seconds = REDIRECT_DELAY;
                const timerEl = document.getElementById('redirect-timer');
                
                _state.redirectTimer = setInterval(() => {
                    seconds--;
                    timerEl.textContent = seconds;
                    
                    if (seconds <= 0) {
                        clearInterval(_state.redirectTimer);
                        window.location.href = '/login';
                    }
                }, 1000);
            }
            
            // ========================================
            // Initialisation
            // ========================================
            function init() {
                // V√©rifier si un code est dans l'URL
                const urlParams = new URLSearchParams(window.location.search);
                const codeParam = urlParams.get('code');
                
                if (codeParam) {
                    const codeInput = document.getElementById('gift-code');
                    codeInput.value = codeParam.toUpperCase();
                    formatCode(codeInput);
                }
                
                // Focus sur l'input
                document.getElementById('gift-code').focus();
            }
            
            // Lancer l'init au chargement
            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', init);
            } else {
                init();
            }
            
            // ========================================
            // API publique
            // ========================================
            return {
                showScreen,
                formatCode,
                verifyCode,
                createAccount
            };
            
        })();
    </script>
    
    <!-- PWA Service Worker Registration -->
    <script>
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/service-worker.js')
                    .then(reg => console.log('[PWA] Service Worker registered:', reg.scope))
                    .catch(err => console.log('[PWA] Service Worker registration failed:', err));
            });
        }
    </script>
</body>
</html>
