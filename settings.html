<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Param√®tres ‚Äî Cinq</title>
    
    <!-- SEO -->
    <meta name="description" content="G√©rez votre profil et vos param√®tres sur Cinq.">
    <meta name="robots" content="noindex, nofollow">
    
    <!-- Favicon -->
    <link rel="icon" type="image/svg+xml" href="/favicon.svg">
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
    <meta name="theme-color" content="#1a1a2e">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;500;600;700&family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
    
    <!-- Mobile Responsive Fixes -->
    <link rel="stylesheet" href="/css/mobile-responsive.css">
    
    <style>
        body { font-family: 'Inter', sans-serif; }
        
        .gradient-bg {
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
        }
        
        .glow-soft {
            box-shadow: 0 0 20px rgba(99, 102, 241, 0.15);
        }
        
        /* Animations */
        .screen {
            animation: fadeIn 0.3s ease-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(8px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        /* Toggle switch */
        .toggle-switch {
            position: relative;
            width: 48px;
            height: 26px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 999px;
            cursor: pointer;
            transition: background 0.2s;
        }
        .toggle-switch.active {
            background: #6366f1;
        }
        .toggle-switch::after {
            content: '';
            position: absolute;
            top: 3px;
            left: 3px;
            width: 20px;
            height: 20px;
            background: white;
            border-radius: 50%;
            transition: transform 0.2s;
        }
        .toggle-switch.active::after {
            transform: translateX(22px);
        }
        
        /* Settings card */
        .settings-card {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            transition: all 0.2s;
        }
        .settings-card:hover {
            background: rgba(255, 255, 255, 0.08);
        }
        
        /* Input focus */
        input:focus {
            outline: none;
            border-color: rgba(99, 102, 241, 0.8);
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.2);
        }
        
        /* Loader */
        .loader-dot {
            animation: loaderPulse 1.4s ease-in-out infinite;
        }
        .loader-dot:nth-child(2) { animation-delay: 0.2s; }
        .loader-dot:nth-child(3) { animation-delay: 0.4s; }
        @keyframes loaderPulse {
            0%, 80%, 100% { transform: scale(0.6); opacity: 0.5; }
            40% { transform: scale(1); opacity: 1; }
        }
        
        /* Scrollbar zen */
        ::-webkit-scrollbar { width: 4px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: rgba(255, 255, 255, 0.1); border-radius: 2px; }
        ::-webkit-scrollbar-thumb:hover { background: rgba(255, 255, 255, 0.2); }
        
        /* Danger zone */
        .danger-zone {
            background: rgba(239, 68, 68, 0.1);
            border: 1px solid rgba(239, 68, 68, 0.3);
        }
        
        /* Hide elements */
        .hidden { display: none !important; }
    </style>
</head>
<body class="gradient-bg min-h-screen text-white">
    
    <!-- Cercles d√©coratifs -->
    <div class="fixed inset-0 overflow-hidden pointer-events-none" aria-hidden="true">
        <div class="absolute -top-20 -left-20 w-80 h-80 bg-indigo-500/10 rounded-full blur-3xl"></div>
        <div class="absolute bottom-0 right-0 w-96 h-96 bg-purple-500/10 rounded-full blur-3xl"></div>
    </div>

    <!-- ============================================ -->
    <!-- √âCRAN: Loading -->
    <!-- ============================================ -->
    <div id="screen-loading" class="screen relative z-10 min-h-screen flex items-center justify-center">
        <div class="text-center">
            <div class="flex gap-2 justify-center mb-4">
                <div class="loader-dot w-3 h-3 rounded-full bg-indigo-400"></div>
                <div class="loader-dot w-3 h-3 rounded-full bg-indigo-400"></div>
                <div class="loader-dot w-3 h-3 rounded-full bg-indigo-400"></div>
            </div>
            <p class="text-white/60 text-sm">Chargement...</p>
        </div>
    </div>

    <!-- ============================================ -->
    <!-- √âCRAN: Non connect√© -->
    <!-- ============================================ -->
    <div id="screen-auth" class="screen hidden relative z-10 min-h-screen flex flex-col items-center justify-center px-6 py-12">
        <div class="text-center">
            <div class="w-20 h-20 rounded-full border-2 border-white/20 flex items-center justify-center glow-soft bg-white/5 mx-auto mb-4">
                <span class="text-4xl font-bold">5</span>
            </div>
            <h1 class="text-xl font-semibold mb-2">Connexion requise</h1>
            <p class="text-white/70 text-sm mb-6">Connecte-toi pour acc√©der √† tes param√®tres</p>
            <a href="/login" class="inline-block px-6 py-3 bg-indigo-500 hover:bg-indigo-400 rounded-xl font-semibold transition">
                Se connecter
            </a>
        </div>
    </div>

    <!-- ============================================ -->
    <!-- √âCRAN: Param√®tres -->
    <!-- ============================================ -->
    <div id="screen-settings" class="screen hidden relative z-10 min-h-screen">
        
        <!-- Header -->
        <header class="sticky top-0 z-20 bg-gradient-to-b from-[#1a1a2e] to-transparent pt-4 pb-8 px-4">
            <div class="max-w-lg mx-auto flex items-center gap-4">
                <a href="/app" class="w-10 h-10 rounded-full bg-white/5 hover:bg-white/10 flex items-center justify-center transition" aria-label="Retour">
                    ‚Üê
                </a>
                <div>
                    <h1 class="text-lg font-semibold">Param√®tres</h1>
                    <p class="text-xs text-white/60" id="user-email-display">Chargement...</p>
                </div>
            </div>
        </header>
        
        <!-- Main Content -->
        <main class="px-4 pb-24">
            <div class="max-w-lg mx-auto space-y-6">
                
                <!-- ==========================================
                     Section: Profil
                     ========================================== -->
                <section>
                    <h2 class="text-sm font-medium text-white/60 uppercase tracking-wider mb-3 flex items-center gap-2">
                        <span>üë§</span> Mon Profil
                    </h2>
                    
                    <div class="settings-card rounded-2xl p-4 space-y-4">
                        <!-- Nom d'affichage -->
                        <div>
                            <label for="display-name" class="block text-sm text-white/70 mb-2">Nom d'affichage</label>
                            <div class="flex gap-2">
                                <input 
                                    type="text" 
                                    id="display-name"
                                    placeholder="Ton pseudo..."
                                    maxlength="30"
                                    class="flex-1 px-4 py-3 rounded-xl bg-white/10 border border-white/20 text-white placeholder-white/40 transition"
                                >
                                <button 
                                    id="btn-save-name"
                                    class="px-4 py-3 bg-indigo-500 hover:bg-indigo-400 rounded-xl font-medium transition disabled:opacity-50"
                                >
                                    ‚úì
                                </button>
                            </div>
                            <p id="name-message" class="text-xs mt-2 hidden"></p>
                        </div>
                        
                        <!-- Email -->
                        <div class="pt-2 border-t border-white/10">
                            <label for="user-email" class="block text-sm text-white/70 mb-2">Adresse email</label>
                            <div class="flex gap-2">
                                <input 
                                    type="email" 
                                    id="user-email"
                                    placeholder="ton@email.com"
                                    class="flex-1 px-4 py-3 rounded-xl bg-white/10 border border-white/20 text-white placeholder-white/40 transition"
                                >
                                <button 
                                    id="btn-change-email"
                                    class="px-4 py-3 bg-white/10 hover:bg-white/20 rounded-xl font-medium transition disabled:opacity-50"
                                >
                                    Modifier
                                </button>
                            </div>
                            <p id="email-message" class="text-xs mt-2 hidden"></p>
                        </div>
                    </div>
                </section>

                <!-- ==========================================
                     Section: Notifications
                     ========================================== -->
                <section>
                    <h2 class="text-sm font-medium text-white/60 uppercase tracking-wider mb-3 flex items-center gap-2">
                        <span>üîî</span> Notifications
                    </h2>
                    
                    <!-- Bouton Push Notifications -->
                    <div id="push-notification-card" class="settings-card rounded-2xl p-4 mb-3">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="font-medium flex items-center gap-2">
                                    <span id="push-status-icon">üîï</span>
                                    <span id="push-status-text">Notifications push</span>
                                </p>
                                <p id="push-status-desc" class="text-sm text-white/50">Re√ßois les notifications sur ton appareil</p>
                            </div>
                            <button 
                                id="btn-push-toggle"
                                class="px-4 py-2 bg-indigo-500 hover:bg-indigo-400 rounded-xl font-medium transition disabled:opacity-50"
                            >
                                Activer
                            </button>
                        </div>
                        <p id="push-error" class="text-xs text-red-400 mt-2 hidden"></p>
                    </div>
                    
                    <div class="settings-card rounded-2xl divide-y divide-white/10">
                        <!-- Nouveau message -->
                        <div class="flex items-center justify-between p-4">
                            <div>
                                <p class="font-medium">Nouveaux messages</p>
                                <p class="text-sm text-white/50">Quand quelqu'un t'√©crit</p>
                            </div>
                            <button 
                                class="toggle-switch active" 
                                data-pref="newMessage"
                                onclick="togglePref(this)"
                                aria-label="Activer les notifications de nouveaux messages"
                            ></button>
                        </div>
                        
                        <!-- Pings -->
                        <div class="flex items-center justify-between p-4">
                            <div>
                                <p class="font-medium">Pings üí´</p>
                                <p class="text-sm text-white/50">Quand quelqu'un pense √† toi</p>
                            </div>
                            <button 
                                class="toggle-switch active" 
                                data-pref="ping"
                                onclick="togglePref(this)"
                                aria-label="Activer les notifications de pings"
                            ></button>
                        </div>
                        
                        <!-- Nouveaux contacts -->
                        <div class="flex items-center justify-between p-4">
                            <div>
                                <p class="font-medium">Ajouts au cercle</p>
                                <p class="text-sm text-white/50">Quand quelqu'un t'ajoute</p>
                            </div>
                            <button 
                                class="toggle-switch active" 
                                data-pref="newContact"
                                onclick="togglePref(this)"
                                aria-label="Activer les notifications d'ajouts"
                            ></button>
                        </div>
                        
                        <!-- Emails -->
                        <div class="flex items-center justify-between p-4">
                            <div>
                                <p class="font-medium">R√©sum√© par email</p>
                                <p class="text-sm text-white/50">Une fois par semaine max</p>
                            </div>
                            <button 
                                class="toggle-switch" 
                                data-pref="email"
                                onclick="togglePref(this)"
                                aria-label="Activer le r√©sum√© par email"
                            ></button>
                        </div>
                    </div>
                </section>

                <!-- ==========================================
                     Section: S√©curit√©
                     ========================================== -->
                <section>
                    <h2 class="text-sm font-medium text-white/60 uppercase tracking-wider mb-3 flex items-center gap-2">
                        <span>üîê</span> S√©curit√©
                    </h2>
                    
                    <div class="settings-card rounded-2xl p-4">
                        <button 
                            id="btn-change-password"
                            class="w-full text-left flex items-center justify-between py-2 hover:text-indigo-400 transition"
                            onclick="showPasswordModal()"
                        >
                            <div>
                                <p class="font-medium">Changer le mot de passe</p>
                                <p class="text-sm text-white/50">Garde ton compte en s√©curit√©</p>
                            </div>
                            <span class="text-white/30">‚Üí</span>
                        </button>
                    </div>
                </section>

                <!-- ==========================================
                     Section: √Ä propos
                     ========================================== -->
                <section>
                    <h2 class="text-sm font-medium text-white/60 uppercase tracking-wider mb-3 flex items-center gap-2">
                        <span>‚ÑπÔ∏è</span> √Ä propos
                    </h2>
                    
                    <div class="settings-card rounded-2xl divide-y divide-white/10">
                        <a href="/terms" class="flex items-center justify-between p-4 hover:bg-white/5 transition">
                            <p>Conditions d'utilisation</p>
                            <span class="text-white/30">‚Üí</span>
                        </a>
                        <a href="/privacy" class="flex items-center justify-between p-4 hover:bg-white/5 transition">
                            <p>Politique de confidentialit√©</p>
                            <span class="text-white/30">‚Üí</span>
                        </a>
                        <div class="flex items-center justify-between p-4">
                            <p class="text-white/50">Version</p>
                            <p class="text-white/30 text-sm">1.0.0</p>
                        </div>
                    </div>
                </section>

                <!-- ==========================================
                     Section: Actions
                     ========================================== -->
                <section>
                    <h2 class="text-sm font-medium text-white/60 uppercase tracking-wider mb-3 flex items-center gap-2">
                        <span>‚ö°</span> Actions
                    </h2>
                    
                    <div class="space-y-3">
                        <!-- D√©connexion -->
                        <button 
                            id="btn-logout"
                            class="w-full settings-card rounded-xl p-4 flex items-center gap-3 hover:bg-white/10 transition"
                        >
                            <span class="text-xl">üö™</span>
                            <div class="text-left">
                                <p class="font-medium">Se d√©connecter</p>
                                <p class="text-sm text-white/50">Tu reviendras vite, hein ?</p>
                            </div>
                        </button>
                        
                        <!-- Supprimer compte -->
                        <button 
                            id="btn-delete-account"
                            class="w-full danger-zone rounded-xl p-4 flex items-center gap-3 hover:bg-red-500/20 transition"
                            onclick="showDeleteModal()"
                        >
                            <span class="text-xl">üíî</span>
                            <div class="text-left">
                                <p class="font-medium text-red-400">Supprimer mon compte</p>
                                <p class="text-sm text-white/50">Action irr√©versible</p>
                            </div>
                        </button>
                    </div>
                </section>
                
            </div>
        </main>
    </div>

    <!-- ============================================ -->
    <!-- Modal: Changer mot de passe -->
    <!-- ============================================ -->
    <div id="modal-password" class="hidden fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/50 backdrop-blur-sm">
        <div class="bg-[#1a1a2e] border border-white/10 rounded-2xl p-6 w-full max-w-sm glow-soft">
            <h3 class="text-lg font-semibold mb-4 flex items-center gap-2">
                <span>üîê</span> Changer le mot de passe
            </h3>
            
            <form id="password-form" class="space-y-4">
                <div>
                    <label for="current-password" class="block text-sm text-white/70 mb-2">Mot de passe actuel</label>
                    <input 
                        type="password" 
                        id="current-password"
                        required
                        autocomplete="current-password"
                        class="w-full px-4 py-3 rounded-xl bg-white/10 border border-white/20 text-white placeholder-white/40 transition"
                    >
                </div>
                <div>
                    <label for="new-password" class="block text-sm text-white/70 mb-2">Nouveau mot de passe</label>
                    <input 
                        type="password" 
                        id="new-password"
                        required
                        minlength="8"
                        autocomplete="new-password"
                        class="w-full px-4 py-3 rounded-xl bg-white/10 border border-white/20 text-white placeholder-white/40 transition"
                    >
                    <p class="text-xs text-white/50 mt-1">Minimum 8 caract√®res</p>
                </div>
                <div>
                    <label for="confirm-password" class="block text-sm text-white/70 mb-2">Confirmer</label>
                    <input 
                        type="password" 
                        id="confirm-password"
                        required
                        autocomplete="new-password"
                        class="w-full px-4 py-3 rounded-xl bg-white/10 border border-white/20 text-white placeholder-white/40 transition"
                    >
                </div>
                
                <p id="password-error" class="text-sm text-red-400 hidden"></p>
                
                <div class="flex gap-2 pt-2">
                    <button 
                        type="button"
                        onclick="hidePasswordModal()"
                        class="flex-1 px-4 py-3 bg-white/10 hover:bg-white/20 rounded-xl transition"
                    >
                        Annuler
                    </button>
                    <button 
                        type="submit"
                        class="flex-1 px-4 py-3 bg-indigo-500 hover:bg-indigo-400 rounded-xl font-semibold transition"
                    >
                        Confirmer
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- ============================================ -->
    <!-- Modal: Supprimer compte -->
    <!-- ============================================ -->
    <div id="modal-delete" class="hidden fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/50 backdrop-blur-sm">
        <div class="bg-[#1a1a2e] border border-red-500/30 rounded-2xl p-6 w-full max-w-sm">
            <div class="text-center mb-6">
                <span class="text-5xl">üíî</span>
                <h3 class="text-lg font-semibold mt-4 text-red-400">Supprimer ton compte ?</h3>
                <p class="text-white/70 text-sm mt-2">
                    Cette action est <strong>irr√©versible</strong>.<br>
                    Toutes tes donn√©es seront supprim√©es.
                </p>
            </div>
            
            <form id="delete-form" class="space-y-4">
                <div>
                    <label for="delete-confirm" class="block text-sm text-white/70 mb-2">
                        Tape <strong class="text-red-400">SUPPRIMER</strong> pour confirmer
                    </label>
                    <input 
                        type="text" 
                        id="delete-confirm"
                        placeholder="SUPPRIMER"
                        required
                        autocomplete="off"
                        class="w-full px-4 py-3 rounded-xl bg-white/10 border border-red-500/30 text-white placeholder-white/40 transition text-center uppercase tracking-wider"
                    >
                </div>
                
                <p id="delete-error" class="text-sm text-red-400 hidden"></p>
                
                <div class="flex gap-2 pt-2">
                    <button 
                        type="button"
                        onclick="hideDeleteModal()"
                        class="flex-1 px-4 py-3 bg-white/10 hover:bg-white/20 rounded-xl transition"
                    >
                        Annuler
                    </button>
                    <button 
                        type="submit"
                        class="flex-1 px-4 py-3 bg-red-500 hover:bg-red-400 rounded-xl font-semibold transition"
                    >
                        Supprimer
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- ============================================ -->
    <!-- Toast Container -->
    <!-- ============================================ -->
    <div id="toast-container" class="fixed bottom-20 left-1/2 transform -translate-x-1/2 z-50"></div>

    <!-- ============================================ -->
    <!-- SCRIPTS -->
    <!-- ============================================ -->
    <script src="/fun.js"></script>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <script src="/js/user-profile.js"></script>
    <script>
        // ============================================
        // DOM Elements
        // ============================================
        const $ = (id) => document.getElementById(id);
        
        const screens = {
            loading: $('screen-loading'),
            auth: $('screen-auth'),
            settings: $('screen-settings')
        };
        
        // ============================================
        // Helpers
        // ============================================
        function showScreen(name) {
            Object.values(screens).forEach(s => s.classList.add('hidden'));
            screens[name].classList.remove('hidden');
        }
        
        function showToast(message, type = 'success') {
            const container = $('toast-container');
            const toast = document.createElement('div');
            toast.className = `px-4 py-3 rounded-xl text-sm font-medium shadow-lg ${
                type === 'error' ? 'bg-red-500' : 
                type === 'warning' ? 'bg-yellow-500 text-black' : 
                'bg-indigo-500'
            }`;
            toast.textContent = message;
            toast.style.animation = 'fadeIn 0.3s ease-out';
            container.appendChild(toast);
            
            setTimeout(() => {
                toast.style.animation = 'fadeIn 0.3s ease-out reverse';
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }
        
        function showMessage(elementId, message, isError = false) {
            const el = $(elementId);
            if (el) {
                el.textContent = message;
                el.className = `text-xs mt-2 ${isError ? 'text-red-400' : 'text-emerald-400'}`;
                el.classList.remove('hidden');
            }
        }
        
        function hideMessage(elementId) {
            const el = $(elementId);
            if (el) el.classList.add('hidden');
        }
        
        // ============================================
        // Notifications Toggle
        // ============================================
        function togglePref(button) {
            const isActive = button.classList.toggle('active');
            const prefKey = button.dataset.pref;
            
            // Mettre √† jour les pr√©f√©rences
            const prefs = UserProfile.getPreferences();
            if (!prefs.notifications) prefs.notifications = {};
            prefs.notifications[prefKey] = isActive;
            
            UserProfile.updatePreferences({ notifications: prefs.notifications })
                .then(() => {
                    showToast(isActive ? 'Activ√© ‚úì' : 'D√©sactiv√©');
                })
                .catch(err => {
                    // Revert
                    button.classList.toggle('active');
                    showToast('Erreur', 'error');
                });
        }
        
        // ============================================
        // Password Modal
        // ============================================
        function showPasswordModal() {
            $('modal-password').classList.remove('hidden');
            $('current-password').focus();
        }
        
        function hidePasswordModal() {
            $('modal-password').classList.add('hidden');
            $('password-form').reset();
            hideMessage('password-error');
        }
        
        $('password-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            hideMessage('password-error');
            
            const current = $('current-password').value;
            const newPass = $('new-password').value;
            const confirm = $('confirm-password').value;
            
            if (newPass !== confirm) {
                showMessage('password-error', 'Les mots de passe ne correspondent pas', true);
                return;
            }
            
            if (newPass.length < 8) {
                showMessage('password-error', 'Minimum 8 caract√®res requis', true);
                return;
            }
            
            const btn = e.target.querySelector('button[type="submit"]');
            btn.disabled = true;
            btn.textContent = '...';
            
            try {
                await UserProfile.updatePassword(current, newPass);
                hidePasswordModal();
                showToast('Mot de passe modifi√© ‚úì');
            } catch (err) {
                showMessage('password-error', err.message, true);
            } finally {
                btn.disabled = false;
                btn.textContent = 'Confirmer';
            }
        });
        
        // ============================================
        // Delete Modal
        // ============================================
        function showDeleteModal() {
            $('modal-delete').classList.remove('hidden');
            $('delete-confirm').focus();
        }
        
        function hideDeleteModal() {
            $('modal-delete').classList.add('hidden');
            $('delete-form').reset();
            hideMessage('delete-error');
        }
        
        $('delete-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            hideMessage('delete-error');
            
            const confirmation = $('delete-confirm').value.trim().toUpperCase();
            
            if (confirmation !== 'SUPPRIMER') {
                showMessage('delete-error', 'Tape SUPPRIMER pour confirmer', true);
                return;
            }
            
            const btn = e.target.querySelector('button[type="submit"]');
            btn.disabled = true;
            btn.textContent = '...';
            
            try {
                await UserProfile.deleteAccount(confirmation);
                showToast('Compte supprim√©. √Ä bient√¥t peut-√™tre... üíú');
                setTimeout(() => {
                    window.location.href = '/';
                }, 2000);
            } catch (err) {
                showMessage('delete-error', err.message, true);
                btn.disabled = false;
                btn.textContent = 'Supprimer';
            }
        });
        
        // ============================================
        // Profile Updates
        // ============================================
        $('btn-save-name').addEventListener('click', async () => {
            const name = $('display-name').value.trim();
            
            if (!name) {
                showMessage('name-message', 'Le nom ne peut pas √™tre vide', true);
                return;
            }
            
            const btn = $('btn-save-name');
            btn.disabled = true;
            
            try {
                await UserProfile.updateProfile({ display_name: name });
                showMessage('name-message', 'Nom mis √† jour ‚úì', false);
                showToast('Profil mis √† jour ‚úì');
            } catch (err) {
                showMessage('name-message', err.message, true);
            } finally {
                btn.disabled = false;
            }
        });
        
        $('btn-change-email').addEventListener('click', async () => {
            const email = $('user-email').value.trim();
            
            if (!email || !email.includes('@')) {
                showMessage('email-message', 'Email invalide', true);
                return;
            }
            
            const btn = $('btn-change-email');
            btn.disabled = true;
            btn.textContent = '...';
            
            try {
                await UserProfile.updateEmail(email);
                showMessage('email-message', 'Email de confirmation envoy√© ‚úì', false);
            } catch (err) {
                showMessage('email-message', err.message, true);
            } finally {
                btn.disabled = false;
                btn.textContent = 'Modifier';
            }
        });
        
        // ============================================
        // Logout
        // ============================================
        $('btn-logout').addEventListener('click', async () => {
            try {
                await UserProfile.logout();
            } catch (err) {
                showToast('Erreur de d√©connexion', 'error');
            }
        });
        
        // ============================================
        // Push Notifications
        // ============================================
        const VAPID_PUBLIC_KEY = 'BFvUbvZkUNjbCf_lea-V2FGiVLhAdyAXaUC5CUWYlwmCkejWxefzR3rvqJI4DOj_M1Gh664VGVYRo0SEJ-94faM';
        
        function urlBase64ToUint8Array(base64String) {
            const padding = '='.repeat((4 - base64String.length % 4) % 4);
            const base64 = (base64String + padding)
                .replace(/-/g, '+')
                .replace(/_/g, '/');
            const rawData = window.atob(base64);
            const outputArray = new Uint8Array(rawData.length);
            for (let i = 0; i < rawData.length; ++i) {
                outputArray[i] = rawData.charCodeAt(i);
            }
            return outputArray;
        }
        
        function updatePushUI(isSubscribed, isSupported = true) {
            const btn = $('btn-push-toggle');
            const icon = $('push-status-icon');
            const text = $('push-status-text');
            const desc = $('push-status-desc');
            
            if (!isSupported) {
                icon.textContent = '‚ùå';
                text.textContent = 'Non support√©';
                desc.textContent = 'Ton navigateur ne supporte pas les notifications push';
                btn.style.display = 'none';
                return;
            }
            
            if (isSubscribed) {
                icon.textContent = 'üîî';
                text.textContent = 'Notifications actives';
                desc.textContent = 'Tu recevras les notifications sur cet appareil';
                btn.textContent = 'D√©sactiver';
                btn.classList.remove('bg-indigo-500', 'hover:bg-indigo-400');
                btn.classList.add('bg-white/10', 'hover:bg-white/20');
            } else {
                icon.textContent = 'üîï';
                text.textContent = 'Notifications push';
                desc.textContent = 'Re√ßois les notifications sur ton appareil';
                btn.textContent = 'Activer';
                btn.classList.add('bg-indigo-500', 'hover:bg-indigo-400');
                btn.classList.remove('bg-white/10', 'hover:bg-white/20');
            }
        }
        
        async function checkPushSubscription() {
            if (!('serviceWorker' in navigator) || !('PushManager' in window)) {
                updatePushUI(false, false);
                return false;
            }
            
            try {
                const registration = await navigator.serviceWorker.ready;
                const subscription = await registration.pushManager.getSubscription();
                updatePushUI(!!subscription);
                return !!subscription;
            } catch (err) {
                console.error('Error checking push subscription:', err);
                updatePushUI(false);
                return false;
            }
        }
        
        async function subscribeToPush() {
            const btn = $('btn-push-toggle');
            btn.disabled = true;
            btn.textContent = '...';
            hideMessage('push-error');
            
            try {
                // Demander la permission
                const permission = await Notification.requestPermission();
                if (permission !== 'granted') {
                    showMessage('push-error', 'Permission refus√©e. Autorise les notifications dans les param√®tres de ton navigateur.', true);
                    btn.disabled = false;
                    updatePushUI(false);
                    return;
                }
                
                // S'abonner au push
                const registration = await navigator.serviceWorker.ready;
                const subscription = await registration.pushManager.subscribe({
                    userVisibleOnly: true,
                    applicationServerKey: urlBase64ToUint8Array(VAPID_PUBLIC_KEY)
                });
                
                // Enregistrer sur le serveur
                const token = UserProfile.getSession()?.access_token;
                const response = await fetch('/.netlify/functions/push-subscribe', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({ subscription: subscription.toJSON() })
                });
                
                const result = await response.json();
                
                if (!result.success) {
                    throw new Error(result.error || 'Erreur serveur');
                }
                
                updatePushUI(true);
                showToast('Notifications activ√©es ! üîî');
                
            } catch (err) {
                console.error('Push subscription error:', err);
                showMessage('push-error', err.message, true);
                updatePushUI(false);
            } finally {
                btn.disabled = false;
            }
        }
        
        async function unsubscribeFromPush() {
            const btn = $('btn-push-toggle');
            btn.disabled = true;
            btn.textContent = '...';
            hideMessage('push-error');
            
            try {
                const registration = await navigator.serviceWorker.ready;
                const subscription = await registration.pushManager.getSubscription();
                
                if (subscription) {
                    // Supprimer du serveur
                    const token = UserProfile.getSession()?.access_token;
                    await fetch('/.netlify/functions/push-subscribe', {
                        method: 'DELETE',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${token}`
                        },
                        body: JSON.stringify({ endpoint: subscription.endpoint })
                    });
                    
                    // Se d√©sabonner localement
                    await subscription.unsubscribe();
                }
                
                updatePushUI(false);
                showToast('Notifications d√©sactiv√©es');
                
            } catch (err) {
                console.error('Push unsubscribe error:', err);
                showMessage('push-error', err.message, true);
            } finally {
                btn.disabled = false;
            }
        }
        
        async function togglePushNotifications() {
            const isSubscribed = await checkPushSubscription();
            if (isSubscribed) {
                await unsubscribeFromPush();
            } else {
                await subscribeToPush();
            }
        }
        
        // Attacher l'√©v√©nement au bouton
        $('btn-push-toggle').addEventListener('click', togglePushNotifications);
        
        // ============================================
        // Initialize
        // ============================================
        async function init() {
            try {
                UserProfile.init();
                const user = await UserProfile.checkAuth();
                
                if (!user) {
                    showScreen('auth');
                    return;
                }
                
                // Afficher l'email
                $('user-email-display').textContent = user.email;
                $('user-email').value = user.email;
                
                // Charger le profil
                try {
                    const profile = await UserProfile.loadProfile();
                    $('display-name').value = profile.display_name || UserProfile.getEmailPrefix(user.email);
                } catch (e) {
                    $('display-name').value = UserProfile.getEmailPrefix(user.email);
                }
                
                // Charger les pr√©f√©rences
                try {
                    const prefs = await UserProfile.loadPreferences();
                    if (prefs.notifications) {
                        document.querySelectorAll('.toggle-switch').forEach(toggle => {
                            const key = toggle.dataset.pref;
                            if (prefs.notifications[key] === false) {
                                toggle.classList.remove('active');
                            } else {
                                toggle.classList.add('active');
                            }
                        });
                    }
                } catch (e) {
                    // Utiliser les valeurs par d√©faut
                }
                
                // V√©rifier l'√©tat des push notifications
                await checkPushSubscription();
                
                showScreen('settings');
                
            } catch (err) {
                console.error('Init error:', err);
                showScreen('auth');
            }
        }
        
        init();
    </script>

</body>
</html>
