<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>Cinq — Feed</title>
    
    <!-- SEO -->
    <meta name="description" content="Cinq — Le feed de tes 5 proches. Aucun algorithme, juste les messages des personnes qui comptent.">
    <meta name="robots" content="noindex, nofollow">
    
    <!-- Canonical -->
    <link rel="canonical" href="https://cinq.app/feed">
    
    <!-- Open Graph -->
    <meta property="og:title" content="Feed — Cinq">
    <meta property="og:description" content="Le feed de tes 5 proches sur Cinq.">
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://cinq.app/feed">
    <meta property="og:image" content="https://cinq.app/og-image.svg">
    <meta property="og:site_name" content="Cinq">
    <meta property="og:locale" content="fr_FR">
    
    <!-- Favicon -->
    <link rel="icon" type="image/svg+xml" href="/favicon.svg">
    <link rel="apple-touch-icon" sizes="180x180" href="/assets/icons/icon-192x192.png">
    <meta name="theme-color" content="#121218">
    
    <!-- PWA -->
    <link rel="manifest" href="/manifest.json">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Cinq">
    
    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;500;600;700&family=Inter:wght@400;500;600&display=swap" media="print" onload="this.media='all'">
    <noscript><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;500;600;700&family=Inter:wght@400;500;600&display=swap"></noscript>
    
    <!-- Critical CSS (for fastest FCP) -->
    <link rel="stylesheet" href="/css/critical.min.css">
    
    <!-- Design System -->
    <link rel="preload" href="/design/styles.min.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
    <noscript><link rel="stylesheet" href="/design/styles.min.css"></noscript>
    <link rel="stylesheet" href="/css/a11y.min.css">
    <link rel="stylesheet" href="/css/mobile-responsive.min.css">
    <link rel="stylesheet" href="/css/iphone14-responsive-fixes.min.css">
    
    <!-- Quick Actions (Long Press Context Menu) -->
    <link rel="stylesheet" href="/css/quick-actions.min.css">
    
    <!-- Quick Profile Edit -->
    <link rel="stylesheet" href="/css/quick-profile-edit.css">
    
    <!-- Theme CSS for smooth transitions -->
    <link rel="stylesheet" href="/css/theme.css">
    
    <!-- GIPHY Integration -->
    <link rel="stylesheet" href="/css/giphy.css">
    
    <!-- Message Animations -->
    <link rel="stylesheet" href="/css/message-animations.css">
    
    <!-- Theme initialization (before body to prevent flash) -->
    <script src="/js/theme.js"></script>
    
    <!-- Compact mode initialization (prevent flash) -->
    <script>
        (function() {
            var isCompact = localStorage.getItem('cinq_compact_mode') === 'true';
            document.documentElement.setAttribute('data-compact-mode', isCompact ? 'true' : 'false');
        })();
    </script>
    
    <!-- Reading mode initialization (prevent flash) -->
    <script>
        (function() {
            var isReading = localStorage.getItem('cinq_reading_mode') === 'true';
            document.documentElement.setAttribute('data-reading-mode', isReading ? 'true' : 'false');
        })();
    </script>
    
    <!-- Message animation initialization (prevent flash) -->
    <script>
        (function() {
            var msgAnim = localStorage.getItem('cinq_msg_animation') || 'fade';
            document.documentElement.setAttribute('data-msg-animation', msgAnim);
        })();
    </script>
    
    <!-- Shared utilities -->
    <script src="/js/shared.js"></script>
    <script src="/js/markdown.js"></script>
    
    <style>
        /* ===== FEED LAYOUT ===== */
        .feed-container {
            min-height: 100vh;
            min-height: 100dvh;
            padding: 1rem;
            max-width: 600px;
            margin: 0 auto;
            padding-bottom: calc(80px + env(safe-area-inset-bottom, 1rem));
            /* Optimize for scroll performance */
            will-change: scroll-position;
            -webkit-overflow-scrolling: touch;
        }
        
        .feed-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem 0;
            border-bottom: 1px solid var(--color-border);
            margin-bottom: 1.5rem;
            position: sticky;
            top: 0;
            background: var(--color-bg-primary);
            z-index: 100;
        }
        
        .feed-logo {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--color-brand);
            text-decoration: none;
        }
        
        .feed-title {
            font-size: 1.25rem;
            font-weight: 600;
            background: linear-gradient(135deg, var(--color-brand) 0%, #a855f7 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        .header-actions {
            display: flex;
            gap: 0.75rem;
            align-items: center;
        }
        
        .back-btn {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 1rem;
            background: var(--color-bg-secondary);
            border: 1px solid var(--color-border);
            border-radius: var(--radius-lg);
            color: var(--color-text-muted);
            text-decoration: none;
            font-size: 0.875rem;
            transition: all 0.2s;
        }
        
        .back-btn:hover {
            background: var(--color-bg-hover);
            color: var(--color-text-primary);
        }
        
        /* Theme toggle */
        .theme-toggle {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 36px;
            height: 36px;
            background: var(--color-bg-secondary);
            border: 1px solid var(--color-border);
            border-radius: 50%;
            cursor: pointer;
            transition: all 0.2s ease;
            overflow: hidden;
            position: relative;
        }
        .theme-toggle:hover {
            background: var(--color-bg-hover);
            transform: scale(1.05);
        }
        .theme-toggle .icon-sun,
        .theme-toggle .icon-moon {
            position: absolute;
            transition: all 0.3s ease;
            color: var(--color-text-secondary);
        }
        .theme-toggle .icon-sun {
            opacity: 1;
            transform: rotate(0) scale(1);
        }
        .theme-toggle .icon-moon {
            opacity: 0;
            transform: rotate(-90deg) scale(0.5);
        }
        [data-theme="light"] .theme-toggle .icon-sun {
            opacity: 0;
            transform: rotate(90deg) scale(0.5);
        }
        [data-theme="light"] .theme-toggle .icon-moon {
            opacity: 1;
            transform: rotate(0) scale(1);
        }

        /* ===== PULL TO REFRESH ===== */
        .pull-to-refresh {
            position: fixed;
            top: 0;
            left: 50%;
            transform: translateX(-50%) translateY(-100%);
            z-index: 200;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            padding: 0.75rem 1.25rem;
            background: var(--color-bg-secondary);
            border: 1px solid var(--color-border);
            border-radius: 0 0 var(--radius-xl) var(--radius-xl);
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            font-size: 0.875rem;
            color: var(--color-text-secondary);
        }
        
        .pull-to-refresh.visible {
            transform: translateX(-50%) translateY(0);
        }
        
        .pull-to-refresh.refreshing .ptr-spinner {
            animation: spin 0.8s linear infinite;
        }
        
        .ptr-spinner {
            width: 18px;
            height: 18px;
            transition: transform 0.2s;
        }
        
        .ptr-arrow {
            transition: transform 0.2s;
        }
        
        .pull-to-refresh.ready .ptr-arrow {
            transform: rotate(180deg);
        }

        /* ===== COMPOSER ===== */
        .composer {
            background: var(--color-bg-secondary);
            border: 1px solid var(--color-border);
            border-radius: var(--radius-xl);
            padding: 1rem;
            margin-bottom: 1.5rem;
        }
        
        .composer-header {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            margin-bottom: 0.75rem;
        }
        
        .composer-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--color-brand) 0%, #a855f7 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1rem;
            color: white;
            font-weight: 600;
        }
        
        .composer-user {
            font-weight: 600;
            font-size: 0.9rem;
        }
        
        .composer-textarea {
            width: 100%;
            min-height: 80px;
            padding: 0.75rem;
            background: var(--color-bg-elevated);
            border: 1px solid var(--color-border);
            border-radius: var(--radius-lg);
            color: var(--color-text-primary);
            font-size: 1rem;
            font-family: inherit;
            resize: vertical;
            transition: border-color 0.2s, box-shadow 0.2s;
        }
        
        .composer-textarea:focus {
            outline: none;
            border-color: var(--color-brand);
            box-shadow: 0 0 0 3px var(--color-brand-muted);
        }
        
        .composer-textarea::placeholder {
            color: var(--color-text-muted);
        }
        
        .composer-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 0.75rem;
        }
        
        .composer-actions {
            display: flex;
            gap: 0.5rem;
        }
        
        .composer-btn {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 0.75rem;
            background: var(--color-bg-elevated);
            border: 1px solid var(--color-border);
            border-radius: var(--radius-md);
            color: var(--color-text-muted);
            cursor: pointer;
            font-size: 0.875rem;
            transition: all 0.2s;
        }
        
        .composer-btn:hover {
            background: var(--color-bg-hover);
            color: var(--color-text-primary);
            border-color: var(--color-border-active);
        }
        
        .composer-btn.active {
            background: var(--color-brand-muted);
            border-color: var(--color-brand);
            color: var(--color-brand);
        }
        
        .char-count {
            font-size: 0.75rem;
            color: var(--color-text-muted);
        }
        
        .char-count.warning {
            color: var(--color-warning);
        }
        
        .char-count.error {
            color: var(--color-error);
        }
        
        .post-btn {
            padding: 0.625rem 1.25rem;
            background: linear-gradient(135deg, var(--color-brand) 0%, #a855f7 100%);
            border: none;
            border-radius: var(--radius-lg);
            color: white;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .post-btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 4px 20px rgba(99, 102, 241, 0.4);
        }
        
        .post-btn:active:not(:disabled) {
            transform: translateY(0) scale(0.98);
        }
        
        .post-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        /* Image preview */
        .image-preview {
            position: relative;
            margin-top: 0.75rem;
            border-radius: var(--radius-lg);
            overflow: hidden;
        }
        
        .image-preview img {
            width: 100%;
            max-height: 300px;
            object-fit: cover;
            border-radius: var(--radius-lg);
        }
        
        .image-preview-remove {
            position: absolute;
            top: 0.5rem;
            right: 0.5rem;
            width: 28px;
            height: 28px;
            background: rgba(0, 0, 0, 0.7);
            border: none;
            border-radius: 50%;
            color: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1rem;
            transition: all 0.2s;
        }
        
        .image-preview-remove:hover {
            background: var(--color-error);
        }
        
        .image-url-input {
            width: 100%;
            padding: 0.5rem 0.75rem;
            background: var(--color-bg-elevated);
            border: 1px solid var(--color-border);
            border-radius: var(--radius-md);
            color: var(--color-text-primary);
            font-size: 0.875rem;
            margin-top: 0.5rem;
        }
        
        .image-url-input:focus {
            outline: none;
            border-color: var(--color-brand);
        }

        /* ===== POSTS LIST ===== */
        .posts-list {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }
        
        /* ===== POST CARD ANIMATIONS ===== */
        .post-card {
            background: var(--color-bg-secondary);
            border: 1px solid var(--color-border);
            border-radius: var(--radius-xl);
            padding: 1rem;
            transition: border-color 0.2s, box-shadow 0.2s;
            /* Animation on appear */
            opacity: 0;
            transform: translateY(20px) scale(0.98);
            animation: post-fade-in 0.5s cubic-bezier(0.22, 1, 0.36, 1) forwards;
            /* Optimize rendering */
            will-change: opacity, transform;
            contain: layout style paint;
        }
        
        @keyframes post-fade-in {
            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }
        
        /* New post animation (from top) */
        .post-card.new-post {
            animation: post-slide-in 0.6s cubic-bezier(0.34, 1.56, 0.64, 1) forwards;
        }
        
        @keyframes post-slide-in {
            0% {
                opacity: 0;
                transform: translateY(-40px) scale(0.9);
            }
            50% {
                opacity: 1;
            }
            100% {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }
        
        /* Subtle hover effect */
        .post-card:hover {
            border-color: var(--color-border-active);
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
        }
        
        .post-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 0.75rem;
            position: relative;
        }
        
        .post-author {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }
        
        .post-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--color-brand) 0%, #a855f7 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1rem;
            color: white;
            font-weight: 600;
        }
        
        .post-avatar.own {
            background: linear-gradient(135deg, #22c55e 0%, #16a34a 100%);
        }
        
        .post-author-info {
            display: flex;
            flex-direction: column;
        }
        
        .post-author-name {
            font-weight: 600;
            font-size: 0.9rem;
        }
        
        .post-author-name .you-badge {
            font-size: 0.7rem;
            font-weight: 500;
            color: var(--color-success);
            margin-left: 0.5rem;
        }
        
        .post-time {
            font-size: 0.75rem;
            color: var(--color-text-muted);
        }
        
        .post-menu-btn {
            background: none;
            border: none;
            color: var(--color-text-muted);
            cursor: pointer;
            padding: 0.25rem;
            font-size: 1.25rem;
            transition: color 0.2s;
        }
        
        .post-menu-btn:hover {
            color: var(--color-text-primary);
        }
        
        .post-content {
            font-size: 0.95rem;
            line-height: 1.6;
            white-space: pre-wrap;
            word-break: break-word;
        }
        
        .post-content .post-link {
            color: var(--color-brand);
            text-decoration: none;
            word-break: break-all;
        }
        
        .post-content .post-link:hover {
            text-decoration: underline;
        }
        
        .post-content .post-hashtag {
            color: var(--color-brand);
            text-decoration: none;
            font-weight: 500;
            transition: color 0.2s, background 0.2s;
            padding: 0 0.15rem;
            border-radius: var(--radius-sm);
        }
        
        .post-content .post-hashtag:hover {
            background: var(--color-brand-muted);
            text-decoration: none;
        }
        
        /* ===== TRENDING TAGS ===== */
        .trending-tags {
            background: var(--color-bg-secondary);
            border: 1px solid var(--color-border);
            border-radius: var(--radius-xl);
            padding: 1rem;
            margin-bottom: 1.5rem;
        }
        
        .trending-tags-header {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 0.75rem;
            font-weight: 600;
            font-size: 0.9rem;
            color: var(--color-text-secondary);
        }
        
        .trending-tags-header svg {
            width: 16px;
            height: 16px;
            color: var(--color-brand);
        }
        
        .trending-tags-list {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
        }
        
        .trending-tag {
            display: inline-flex;
            align-items: center;
            gap: 0.35rem;
            padding: 0.375rem 0.75rem;
            background: var(--color-bg-elevated);
            border: 1px solid var(--color-border);
            border-radius: var(--radius-full);
            color: var(--color-text-primary);
            font-size: 0.85rem;
            text-decoration: none;
            transition: all 0.2s;
        }
        
        .trending-tag:hover {
            background: var(--color-brand-muted);
            border-color: var(--color-brand);
            color: var(--color-brand);
            transform: translateY(-1px);
        }
        
        .trending-tag .tag-name {
            font-weight: 500;
        }
        
        .trending-tag .tag-count {
            font-size: 0.75rem;
            color: var(--color-text-muted);
            background: var(--color-bg-secondary);
            padding: 0.125rem 0.375rem;
            border-radius: var(--radius-full);
        }
        
        .trending-tag:hover .tag-count {
            background: var(--color-bg-primary);
        }
        
        .trending-tags-empty {
            font-size: 0.85rem;
            color: var(--color-text-muted);
            text-align: center;
            padding: 0.5rem;
        }
        
        .trending-tags.loading {
            opacity: 0.6;
        }
        
        .post-previews:empty {
            display: none;
        }
        
        /* ===== LAZY LOADING IMAGES ===== */
        .post-image {
            margin-top: 0.75rem;
            border-radius: var(--radius-lg);
            overflow: hidden;
            position: relative;
            min-height: 100px;
            background: var(--color-bg-elevated);
        }
        
        .post-image img {
            width: 100%;
            max-height: 400px;
            object-fit: cover;
            cursor: pointer;
            transition: opacity 0.3s ease, transform 0.3s ease;
            /* Lazy loading states */
            opacity: 0;
        }
        
        .post-image img.loaded {
            opacity: 1;
        }
        
        .post-image img:hover {
            transform: scale(1.02);
        }
        
        /* Image loading placeholder */
        .post-image::before {
            content: '';
            position: absolute;
            inset: 0;
            background: linear-gradient(
                90deg,
                var(--color-bg-elevated) 25%,
                var(--color-bg-tertiary) 50%,
                var(--color-bg-elevated) 75%
            );
            background-size: 200% 100%;
            animation: skeleton-loading 1.5s infinite;
            z-index: 0;
        }
        
        .post-image.loaded::before {
            display: none;
        }
        
        /* ===== EMPTY STATE ===== */
        .empty-state {
            text-align: center;
            padding: 3rem 1rem;
            color: var(--color-text-muted);
            animation: post-fade-in 0.5s ease forwards;
        }
        
        .empty-state-icon {
            font-size: 4rem;
            margin-bottom: 1rem;
            opacity: 0.5;
        }
        
        .empty-state-title {
            font-size: 1.25rem;
            font-weight: 600;
            color: var(--color-text-primary);
            margin-bottom: 0.5rem;
        }
        
        .empty-state-text {
            font-size: 0.9rem;
            max-width: 300px;
            margin: 0 auto;
        }

        /* ===== LOADING & SKELETON ===== */
        .loading {
            display: flex;
            justify-content: center;
            padding: 2rem;
        }
        
        .loading-spinner {
            width: 32px;
            height: 32px;
            border: 3px solid var(--color-border);
            border-top-color: var(--color-brand);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        /* Enhanced skeleton loading */
        .skeleton-post {
            background: var(--color-bg-secondary);
            border: 1px solid var(--color-border);
            border-radius: var(--radius-xl);
            padding: 1rem;
            opacity: 0;
            animation: skeleton-fade-in 0.3s ease forwards;
        }
        
        .skeleton-post:nth-child(1) { animation-delay: 0s; }
        .skeleton-post:nth-child(2) { animation-delay: 0.1s; }
        .skeleton-post:nth-child(3) { animation-delay: 0.2s; }
        
        @keyframes skeleton-fade-in {
            to { opacity: 1; }
        }
        
        .skeleton {
            background: linear-gradient(
                90deg,
                var(--color-bg-elevated) 25%,
                var(--color-bg-tertiary) 50%,
                var(--color-bg-elevated) 75%
            );
            background-size: 200% 100%;
            animation: skeleton-loading 1.5s infinite;
            border-radius: var(--radius-md);
        }
        
        @keyframes skeleton-loading {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }
        
        /* Skeleton variations */
        .skeleton.skeleton-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            flex-shrink: 0;
        }
        
        .skeleton.skeleton-title {
            height: 16px;
            width: 60%;
            margin-bottom: 0.5rem;
        }
        
        .skeleton.skeleton-text {
            height: 12px;
            width: 40%;
        }
        
        .skeleton.skeleton-body {
            height: 60px;
            width: 100%;
            margin-top: 0.75rem;
        }
        
        .skeleton.skeleton-image {
            height: 200px;
            width: 100%;
            margin-top: 0.75rem;
            border-radius: var(--radius-lg);
        }

        /* ===== INFINITE SCROLL LOADER ===== */
        .infinite-scroll-loader {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 0.5rem;
            padding: 1.5rem;
            color: var(--color-text-muted);
            font-size: 0.875rem;
        }
        
        .infinite-scroll-loader .loading-spinner {
            width: 20px;
            height: 20px;
        }
        
        .infinite-scroll-end {
            text-align: center;
            padding: 2rem 1rem;
            color: var(--color-text-muted);
            font-size: 0.9rem;
        }
        
        /* Skeleton loader group for infinite scroll */
        .skeleton-loader-group {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }
        
        .skeleton-loader-group .skeleton-post {
            opacity: 0;
            animation: skeleton-fade-in 0.3s ease forwards;
        }
        
        .loading-skeleton {
            position: relative;
            overflow: hidden;
        }
        
        .loading-skeleton::after {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(
                90deg,
                transparent 0%,
                rgba(255, 255, 255, 0.05) 50%,
                transparent 100%
            );
            animation: shimmer 1.5s infinite;
        }
        
        @keyframes shimmer {
            0% { left: -100%; }
            100% { left: 100%; }
        }
        
        /* Sentinel element for IntersectionObserver */
        .scroll-sentinel {
            height: 1px;
            width: 100%;
        }

        /* ===== TOAST ===== */
        .toast-container {
            position: fixed;
            top: 1rem;
            left: 50%;
            transform: translateX(-50%);
            z-index: 1000;
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
            pointer-events: none;
            width: 90%;
            max-width: 400px;
        }
        
        .toast {
            background: var(--color-bg-secondary);
            border: 1px solid var(--color-border);
            border-radius: var(--radius-lg);
            padding: 1rem;
            display: flex;
            align-items: center;
            gap: 0.75rem;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.5);
            animation: toast-in 0.3s ease-out;
            pointer-events: auto;
        }
        
        .toast.success { border-color: var(--color-success); }
        .toast.error { border-color: var(--color-error); }
        
        @keyframes toast-in {
            0% { opacity: 0; transform: translateY(-20px); }
            100% { opacity: 1; transform: translateY(0); }
        }
        
        .toast.toast-out {
            animation: toast-out 0.3s ease-out forwards;
        }
        
        @keyframes toast-out {
            0% { opacity: 1; transform: translateY(0); }
            100% { opacity: 0; transform: translateY(-20px); }
        }

        /* ===== DELETE MENU ===== */
        .post-menu {
            position: absolute;
            right: 0;
            top: 100%;
            background: var(--color-bg-elevated);
            border: 1px solid var(--color-border);
            border-radius: var(--radius-lg);
            padding: 0.25rem;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.5);
            z-index: 50;
            display: none;
        }
        
        .post-menu.open {
            display: block;
            animation: menu-in 0.2s ease;
        }
        
        @keyframes menu-in {
            from {
                opacity: 0;
                transform: translateY(-10px) scale(0.95);
            }
            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }
        
        .post-menu-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 0.75rem;
            background: none;
            border: none;
            color: var(--color-error);
            cursor: pointer;
            font-size: 0.875rem;
            border-radius: var(--radius-md);
            width: 100%;
            transition: background 0.2s;
        }
        
        .post-menu-item:hover {
            background: var(--color-bg-hover);
        }

        /* ===== IMAGE MODAL ===== */
        .image-modal {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.9);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s, visibility 0.3s;
            cursor: zoom-out;
        }
        
        .image-modal.open {
            opacity: 1;
            visibility: visible;
        }
        
        .image-modal img {
            max-width: 95%;
            max-height: 95%;
            object-fit: contain;
            border-radius: var(--radius-lg);
            transform: scale(0.9);
            transition: transform 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
        }
        
        .image-modal.open img {
            transform: scale(1);
        }
        
        .image-modal-close {
            position: absolute;
            top: 1rem;
            right: 1rem;
            width: 40px;
            height: 40px;
            background: rgba(255, 255, 255, 0.1);
            border: none;
            border-radius: 50%;
            color: white;
            cursor: pointer;
            font-size: 1.5rem;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background 0.2s;
        }
        
        .image-modal-close:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        /* ===== REACTIONS ===== */
        .post-reactions {
            display: flex;
            gap: 0.5rem;
            margin-top: 0.75rem;
            padding-top: 0.75rem;
            border-top: 1px solid var(--color-border);
            flex-wrap: wrap;
        }
        
        .reaction-btn {
            display: flex;
            align-items: center;
            gap: 0.35rem;
            padding: 0.4rem 0.65rem;
            background: var(--color-bg-elevated);
            border: 1px solid var(--color-border);
            border-radius: var(--radius-full, 9999px);
            color: var(--color-text-muted);
            font-size: 0.875rem;
            cursor: pointer;
            transition: all 0.2s;
            user-select: none;
        }
        
        .reaction-btn:hover {
            background: var(--color-bg-hover);
            transform: scale(1.05);
        }
        
        .reaction-btn:active {
            transform: scale(0.95);
        }
        
        .reaction-btn.active {
            background: var(--color-brand-muted);
            border-color: var(--color-brand);
            color: var(--color-brand);
        }
        
        .reaction-btn .emoji {
            font-size: 1rem;
            line-height: 1;
        }
        
        .reaction-btn .count {
            font-size: 0.75rem;
            font-weight: 600;
            min-width: 1ch;
        }
        
        .reaction-btn .count:empty {
            display: none;
        }
        
        /* Animation when adding reaction */
        .reaction-btn.animating {
            animation: reaction-pop 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
        }
        
        @keyframes reaction-pop {
            0% { transform: scale(1); }
            50% { transform: scale(1.3); }
            100% { transform: scale(1); }
        }

        /* ===== SHARE BUTTONS ===== */
        .post-actions {
            display: flex;
            justify-content: flex-end;
            gap: 0.5rem;
            margin-top: 0.75rem;
            padding-top: 0.75rem;
            border-top: 1px solid var(--color-border);
        }
        
        .share-btn {
            display: flex;
            align-items: center;
            gap: 0.35rem;
            padding: 0.4rem 0.65rem;
            background: var(--color-bg-elevated);
            border: 1px solid var(--color-border);
            border-radius: var(--radius-md);
            color: var(--color-text-muted);
            font-size: 0.75rem;
            cursor: pointer;
            transition: all 0.2s;
            text-decoration: none;
        }
        
        .share-btn:hover {
            background: var(--color-bg-hover);
            color: var(--color-text-primary);
            border-color: var(--color-border-active);
            transform: translateY(-1px);
        }
        
        .share-btn svg {
            width: 14px;
            height: 14px;
        }
        
        .share-btn.twitter:hover {
            border-color: #1da1f2;
            color: #1da1f2;
        }
        
        .share-btn.whatsapp:hover {
            border-color: #25d366;
            color: #25d366;
        }
        
        .share-btn.copy:hover {
            border-color: var(--color-brand);
            color: var(--color-brand);
        }
        
        .share-btn.copy.copied {
            background: var(--color-brand-muted);
            border-color: var(--color-brand);
            color: var(--color-brand);
        }
        
        .share-btn.link:hover {
            border-color: var(--color-brand);
            color: var(--color-brand);
        }
        
        .share-btn.bookmark {
            transition: all 0.2s;
        }
        
        .share-btn.bookmark:hover {
            border-color: #f59e0b;
            color: #f59e0b;
        }
        
        .share-btn.bookmark.active {
            background: rgba(245, 158, 11, 0.15);
            border-color: #f59e0b;
            color: #f59e0b;
        }
        
        .share-btn.bookmark.animating {
            animation: bookmark-pop 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
        }
        
        @keyframes bookmark-pop {
            0% { transform: scale(1); }
            50% { transform: scale(1.2); }
            100% { transform: scale(1); }
        }
        
        .share-btn.read-later {
            transition: all 0.2s;
        }
        
        .share-btn.read-later:hover {
            border-color: #3b82f6;
            color: #3b82f6;
        }
        
        .share-btn.read-later.active {
            background: rgba(59, 130, 246, 0.15);
            border-color: #3b82f6;
            color: #3b82f6;
        }
        
        .share-btn.read-later.animating {
            animation: read-later-pop 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
        }
        
        @keyframes read-later-pop {
            0% { transform: scale(1); }
            50% { transform: scale(1.2); }
            100% { transform: scale(1); }
        }

        /* ===== RICH MEDIA PREVIEWS ===== */
        .link-preview {
            margin-top: 0.75rem;
            border: 1px solid var(--color-border);
            border-radius: var(--radius-lg);
            overflow: hidden;
            background: var(--color-bg-elevated);
            transition: border-color 0.2s, box-shadow 0.2s;
        }
        
        .link-preview:hover {
            border-color: var(--color-border-active);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }
        
        .link-preview a {
            text-decoration: none;
            color: inherit;
            display: block;
        }
        
        .link-preview-content {
            display: flex;
            flex-direction: column;
        }
        
        .link-preview-image {
            width: 100%;
            aspect-ratio: 1.91 / 1;
            object-fit: cover;
            background: var(--color-bg-tertiary);
        }
        
        .link-preview-body {
            padding: 0.75rem;
        }
        
        .link-preview-site {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.75rem;
            color: var(--color-text-muted);
            margin-bottom: 0.35rem;
        }
        
        .link-preview-site img {
            width: 14px;
            height: 14px;
            border-radius: 2px;
        }
        
        .link-preview-title {
            font-weight: 600;
            font-size: 0.9rem;
            color: var(--color-text-primary);
            margin-bottom: 0.25rem;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }
        
        .link-preview-description {
            font-size: 0.8rem;
            color: var(--color-text-secondary);
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }
        
        /* Compact preview (no image) */
        .link-preview.compact .link-preview-content {
            flex-direction: row;
            align-items: center;
        }
        
        .link-preview.compact .link-preview-body {
            flex: 1;
        }
        
        .link-preview.compact .link-preview-icon {
            width: 60px;
            height: 60px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--color-bg-tertiary);
            color: var(--color-text-muted);
            font-size: 1.5rem;
            flex-shrink: 0;
        }
        
        /* YouTube Embed */
        .youtube-embed {
            margin-top: 0.75rem;
            border-radius: var(--radius-lg);
            overflow: hidden;
            background: #000;
        }
        
        .youtube-embed-container {
            position: relative;
            width: 100%;
            padding-bottom: 56.25%; /* 16:9 */
        }
        
        .youtube-embed iframe {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            border: none;
        }
        
        .youtube-thumbnail {
            position: relative;
            cursor: pointer;
        }
        
        .youtube-thumbnail img {
            width: 100%;
            aspect-ratio: 16 / 9;
            object-fit: cover;
        }
        
        .youtube-play-btn {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 68px;
            height: 48px;
            background: rgba(255, 0, 0, 0.9);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background 0.2s, transform 0.2s;
        }
        
        .youtube-thumbnail:hover .youtube-play-btn {
            background: #ff0000;
            transform: translate(-50%, -50%) scale(1.1);
        }
        
        .youtube-play-btn::after {
            content: '';
            border-style: solid;
            border-width: 10px 0 10px 18px;
            border-color: transparent transparent transparent white;
            margin-left: 4px;
        }
        
        .youtube-info {
            padding: 0.5rem 0.75rem;
            background: var(--color-bg-secondary);
            border: 1px solid var(--color-border);
            border-top: none;
            border-radius: 0 0 var(--radius-lg) var(--radius-lg);
        }
        
        .youtube-info-title {
            font-size: 0.85rem;
            font-weight: 500;
            color: var(--color-text-primary);
            display: -webkit-box;
            -webkit-line-clamp: 1;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }
        
        .youtube-info-provider {
            font-size: 0.7rem;
            color: var(--color-text-muted);
            display: flex;
            align-items: center;
            gap: 0.25rem;
        }
        
        /* Twitter/X Embed */
        .twitter-embed {
            margin-top: 0.75rem;
            border: 1px solid var(--color-border);
            border-radius: var(--radius-lg);
            overflow: hidden;
            background: var(--color-bg-elevated);
        }
        
        .twitter-embed-loading {
            padding: 1rem;
            text-align: center;
            color: var(--color-text-muted);
            font-size: 0.85rem;
        }
        
        .twitter-embed-loading .spinner {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 2px solid var(--color-border);
            border-top-color: var(--color-brand);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
            margin-right: 0.5rem;
            vertical-align: middle;
        }
        
        .twitter-embed-fallback {
            padding: 0.75rem;
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }
        
        .twitter-embed-fallback .x-logo {
            width: 32px;
            height: 32px;
            background: #000;
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            flex-shrink: 0;
        }
        
        .twitter-embed-fallback .tweet-link {
            flex: 1;
            font-size: 0.85rem;
            color: var(--color-text-secondary);
        }
        
        .twitter-embed-fallback .tweet-link a {
            color: var(--color-brand);
            text-decoration: none;
        }
        
        .twitter-embed-fallback .tweet-link a:hover {
            text-decoration: underline;
        }
        
        /* Spotify Embed */
        .spotify-embed {
            margin-top: 0.75rem;
            border-radius: var(--radius-lg);
            overflow: hidden;
        }
        
        .spotify-embed iframe {
            width: 100%;
            height: 152px;
            border: none;
        }
        
        .spotify-embed.large iframe {
            height: 352px;
        }
        
        /* GitHub Preview */
        .github-preview {
            margin-top: 0.75rem;
            border: 1px solid var(--color-border);
            border-radius: var(--radius-lg);
            overflow: hidden;
            background: var(--color-bg-elevated);
        }
        
        .github-preview a {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.75rem;
            text-decoration: none;
            color: inherit;
        }
        
        .github-preview:hover {
            border-color: var(--color-border-active);
        }
        
        .github-preview .gh-logo {
            width: 40px;
            height: 40px;
            background: #24292e;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            flex-shrink: 0;
        }
        
        [data-theme="light"] .github-preview .gh-logo {
            background: #24292e;
        }
        
        .github-preview .gh-info {
            flex: 1;
            min-width: 0;
        }
        
        .github-preview .gh-repo {
            font-weight: 600;
            font-size: 0.9rem;
            color: var(--color-brand);
        }
        
        .github-preview .gh-desc {
            font-size: 0.8rem;
            color: var(--color-text-secondary);
            display: -webkit-box;
            -webkit-line-clamp: 1;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }
        
        /* Multiple previews */
        .link-previews {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }
        
        /* Loading state for previews */
        .link-preview-loading {
            margin-top: 0.75rem;
            padding: 0.75rem;
            background: var(--color-bg-elevated);
            border: 1px solid var(--color-border);
            border-radius: var(--radius-lg);
            display: flex;
            align-items: center;
            gap: 0.5rem;
            color: var(--color-text-muted);
            font-size: 0.85rem;
        }
        
        .link-preview-loading .spinner {
            width: 14px;
            height: 14px;
            border: 2px solid var(--color-border);
            border-top-color: var(--color-brand);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }
        
        /* ===== THREADS / REPLIES ===== */
        .reply-toggle-btn {
            display: flex;
            align-items: center;
            gap: 0.35rem;
            padding: 0.4rem 0.65rem;
            background: var(--color-bg-elevated);
            border: 1px solid var(--color-border);
            border-radius: var(--radius-md);
            color: var(--color-text-muted);
            font-size: 0.75rem;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .reply-toggle-btn:hover {
            background: var(--color-bg-hover);
            color: var(--color-text-primary);
            border-color: var(--color-border-active);
        }
        
        .reply-toggle-btn.active {
            background: var(--color-brand-muted);
            border-color: var(--color-brand);
            color: var(--color-brand);
        }
        
        .reply-toggle-btn svg {
            width: 14px;
            height: 14px;
        }
        
        .replies-section {
            margin-top: 0.75rem;
            padding-top: 0.75rem;
            border-top: 1px solid var(--color-border);
            display: none;
        }
        
        .replies-section.open {
            display: block;
            animation: replies-slide-in 0.3s ease;
        }
        
        @keyframes replies-slide-in {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .replies-list {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
            margin-bottom: 0.75rem;
        }
        
        .reply-card {
            background: var(--color-bg-elevated);
            border: 1px solid var(--color-border);
            border-radius: var(--radius-lg);
            padding: 0.75rem;
            margin-left: 1.5rem;
            position: relative;
            animation: reply-fade-in 0.3s ease forwards;
        }
        
        .reply-card::before {
            content: '';
            position: absolute;
            left: -1rem;
            top: 1rem;
            width: 0.75rem;
            height: 1px;
            background: var(--color-border);
        }
        
        .reply-card::after {
            content: '';
            position: absolute;
            left: -1rem;
            top: 0;
            width: 1px;
            height: calc(100% + 0.75rem);
            background: var(--color-border);
        }
        
        .reply-card:last-of-type::after {
            height: 1rem;
        }
        
        @keyframes reply-fade-in {
            from {
                opacity: 0;
                transform: translateX(-10px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }
        
        .reply-header {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 0.5rem;
        }
        
        .reply-avatar {
            width: 28px;
            height: 28px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--color-brand) 0%, #a855f7 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.75rem;
            color: white;
            font-weight: 600;
            flex-shrink: 0;
        }
        
        .reply-avatar.own {
            background: linear-gradient(135deg, #22c55e 0%, #16a34a 100%);
        }
        
        .reply-author-name {
            font-weight: 600;
            font-size: 0.8rem;
        }
        
        .reply-author-name .you-badge {
            font-size: 0.65rem;
            font-weight: 500;
            color: var(--color-success);
            margin-left: 0.35rem;
        }
        
        .reply-time {
            font-size: 0.7rem;
            color: var(--color-text-muted);
            margin-left: auto;
        }
        
        .reply-content {
            font-size: 0.875rem;
            line-height: 1.5;
            white-space: pre-wrap;
            word-break: break-word;
        }
        
        .reply-content .post-link,
        .reply-content .post-hashtag,
        .reply-content .mention {
            font-size: 0.875rem;
        }
        
        .reply-image {
            margin-top: 0.5rem;
            border-radius: var(--radius-md);
            overflow: hidden;
        }
        
        .reply-image img {
            width: 100%;
            max-height: 200px;
            object-fit: cover;
            cursor: pointer;
        }
        
        .reply-delete-btn {
            position: absolute;
            top: 0.5rem;
            right: 0.5rem;
            width: 24px;
            height: 24px;
            background: var(--color-bg-secondary);
            border: 1px solid var(--color-border);
            border-radius: 50%;
            color: var(--color-text-muted);
            cursor: pointer;
            font-size: 0.75rem;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            transition: all 0.2s;
        }
        
        .reply-card:hover .reply-delete-btn {
            opacity: 1;
        }
        
        .reply-delete-btn:hover {
            background: var(--color-error);
            border-color: var(--color-error);
            color: white;
        }
        
        /* Reply composer */
        .reply-composer {
            display: flex;
            gap: 0.75rem;
            align-items: flex-start;
            margin-left: 1.5rem;
            padding: 0.75rem;
            background: var(--color-bg-elevated);
            border: 1px solid var(--color-border);
            border-radius: var(--radius-lg);
        }
        
        .reply-composer-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: linear-gradient(135deg, #22c55e 0%, #16a34a 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.875rem;
            color: white;
            font-weight: 600;
            flex-shrink: 0;
        }
        
        .reply-composer-form {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }
        
        .reply-composer-input {
            width: 100%;
            min-height: 60px;
            padding: 0.5rem 0.75rem;
            background: var(--color-bg-secondary);
            border: 1px solid var(--color-border);
            border-radius: var(--radius-md);
            color: var(--color-text-primary);
            font-size: 0.875rem;
            font-family: inherit;
            resize: vertical;
            transition: border-color 0.2s, box-shadow 0.2s;
        }
        
        .reply-composer-input:focus {
            outline: none;
            border-color: var(--color-brand);
            box-shadow: 0 0 0 2px var(--color-brand-muted);
        }
        
        .reply-composer-input::placeholder {
            color: var(--color-text-muted);
        }
        
        .reply-composer-actions {
            display: flex;
            justify-content: flex-end;
            align-items: center;
            gap: 0.5rem;
        }
        
        .reply-char-count {
            font-size: 0.7rem;
            margin-right: auto;
        }
        
        .reply-cancel-btn {
            padding: 0.4rem 0.75rem;
            background: var(--color-bg-secondary);
            border: 1px solid var(--color-border);
            border-radius: var(--radius-md);
            color: var(--color-text-muted);
            font-size: 0.8rem;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .reply-cancel-btn:hover {
            background: var(--color-bg-hover);
            color: var(--color-text-primary);
        }
        
        .reply-submit-btn {
            padding: 0.4rem 0.75rem;
            background: linear-gradient(135deg, var(--color-brand) 0%, #a855f7 100%);
            border: none;
            border-radius: var(--radius-md);
            color: white;
            font-size: 0.8rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .reply-submit-btn:hover:not(:disabled) {
            transform: translateY(-1px);
            box-shadow: 0 2px 10px rgba(99, 102, 241, 0.4);
        }
        
        .reply-submit-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        /* View more replies button */
        .view-more-replies {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            margin-left: 1.5rem;
            padding: 0.5rem;
            background: none;
            border: 1px dashed var(--color-border);
            border-radius: var(--radius-md);
            color: var(--color-text-muted);
            font-size: 0.8rem;
            cursor: pointer;
            transition: all 0.2s;
            width: calc(100% - 1.5rem);
        }
        
        .view-more-replies:hover {
            border-color: var(--color-brand);
            color: var(--color-brand);
            background: var(--color-brand-muted);
        }
        
        /* Replies loading */
        .replies-loading {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            padding: 1rem;
            color: var(--color-text-muted);
            font-size: 0.85rem;
        }
        
        .replies-loading .spinner {
            width: 16px;
            height: 16px;
            border: 2px solid var(--color-border);
            border-top-color: var(--color-brand);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        /* ===== SEEN BY (Post Views) ===== */
        .seen-by {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 0;
            margin-top: 0.5rem;
            border-top: 1px solid var(--color-border);
            font-size: 0.8rem;
            color: var(--color-text-muted);
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .seen-by:hover {
            color: var(--color-text-secondary);
        }
        
        .seen-by-icon {
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .seen-by-icon svg {
            width: 16px;
            height: 16px;
            opacity: 0.7;
        }
        
        .seen-by-avatars {
            display: flex;
            flex-direction: row-reverse;
        }
        
        .seen-by-avatar {
            width: 22px;
            height: 22px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--color-brand) 0%, #a855f7 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.65rem;
            color: white;
            font-weight: 600;
            border: 2px solid var(--color-bg-secondary);
            margin-left: -8px;
        }
        
        .seen-by-avatar:last-child {
            margin-left: 0;
        }
        
        .seen-by-avatar.more {
            background: var(--color-bg-elevated);
            color: var(--color-text-muted);
            font-size: 0.6rem;
        }
        
        .seen-by-text {
            flex: 1;
        }
        
        .seen-by-modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(4px);
            z-index: 1000;
            display: none;
            align-items: center;
            justify-content: center;
            padding: 1rem;
        }
        
        .seen-by-modal-overlay.open {
            display: flex;
            animation: fade-in 0.2s ease;
        }
        
        .seen-by-modal {
            background: var(--color-bg-secondary);
            border: 1px solid var(--color-border);
            border-radius: var(--radius-xl);
            padding: 1rem;
            max-width: 320px;
            width: 100%;
            max-height: 80vh;
            overflow-y: auto;
        }
        
        .seen-by-modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
            padding-bottom: 0.75rem;
            border-bottom: 1px solid var(--color-border);
        }
        
        .seen-by-modal-title {
            font-size: 1rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .seen-by-modal-close {
            background: none;
            border: none;
            font-size: 1.25rem;
            color: var(--color-text-muted);
            cursor: pointer;
            padding: 0.25rem;
            line-height: 1;
        }
        
        .seen-by-modal-close:hover {
            color: var(--color-text-primary);
        }
        
        .seen-by-list {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }
        
        .seen-by-item {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }
        
        .seen-by-item-avatar {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--color-brand) 0%, #a855f7 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.9rem;
            color: white;
            font-weight: 600;
            flex-shrink: 0;
        }
        
        .seen-by-item-info {
            flex: 1;
            min-width: 0;
        }
        
        .seen-by-item-name {
            font-weight: 500;
            font-size: 0.9rem;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .seen-by-item-time {
            font-size: 0.75rem;
            color: var(--color-text-muted);
        }
        
        .seen-by-empty {
            text-align: center;
            padding: 1.5rem 1rem;
            color: var(--color-text-muted);
            font-size: 0.875rem;
        }
        
        .seen-by-empty-icon {
            font-size: 2rem;
            margin-bottom: 0.5rem;
        }

        /* ===== MENTIONS ===== */
        .mention {
            color: var(--color-brand);
            text-decoration: none;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            background: var(--color-brand-muted);
            padding: 0.1em 0.3em;
            border-radius: var(--radius-sm);
        }
        
        .mention:hover {
            color: white;
            background: var(--color-brand);
            text-decoration: none;
        }
        
        .mention:focus-visible {
            outline: 2px solid var(--color-brand);
            outline-offset: 2px;
        }
        
        /* Mention autocomplete dropdown */
        .mention-autocomplete {
            position: absolute;
            background: var(--color-bg-elevated);
            border: 1px solid var(--color-border);
            border-radius: var(--radius-lg);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.4);
            max-height: 200px;
            overflow-y: auto;
            z-index: 1000;
            display: none;
            min-width: 200px;
        }
        
        .mention-autocomplete.visible {
            display: block;
            animation: menu-in 0.2s ease;
        }
        
        .mention-item {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.75rem 1rem;
            cursor: pointer;
            transition: background 0.15s;
        }
        
        .mention-item:hover,
        .mention-item.selected {
            background: var(--color-bg-hover);
        }
        
        .mention-item-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: var(--cinq-gradient, linear-gradient(135deg, var(--color-brand) 0%, #a855f7 100%));
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.875rem;
            color: white;
            font-weight: 600;
        }
        
        .mention-item-info {
            display: flex;
            flex-direction: column;
        }
        
        .mention-item-name {
            font-weight: 500;
            font-size: 0.9rem;
        }
        
        .mention-item-username {
            color: var(--color-text-muted);
            font-size: 0.75rem;
        }

        /* ===== POLLS ===== */
        .poll-composer {
            margin-top: 0.75rem;
            padding: 0.75rem;
            background: var(--color-bg-elevated);
            border: 1px solid var(--color-border);
            border-radius: var(--radius-lg);
            display: none;
        }
        
        .poll-composer.visible {
            display: block;
            animation: menu-in 0.2s ease;
        }
        
        .poll-composer-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.75rem;
        }
        
        .poll-composer-title {
            font-weight: 600;
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .poll-options-list {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }
        
        .poll-option-input {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .poll-option-input input {
            flex: 1;
            padding: 0.5rem 0.75rem;
            background: var(--color-bg-secondary);
            border: 1px solid var(--color-border);
            border-radius: var(--radius-md);
            color: var(--color-text-primary);
            font-size: 0.875rem;
        }
        
        .poll-option-input input:focus {
            outline: none;
            border-color: var(--color-brand);
        }
        
        .poll-option-input input::placeholder {
            color: var(--color-text-muted);
        }
        
        .poll-option-number {
            width: 24px;
            height: 24px;
            background: var(--color-brand-muted);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.75rem;
            font-weight: 600;
            color: var(--color-brand);
            flex-shrink: 0;
        }
        
        .poll-remove-option {
            width: 28px;
            height: 28px;
            background: none;
            border: 1px solid var(--color-border);
            border-radius: var(--radius-md);
            color: var(--color-text-muted);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }
        
        .poll-remove-option:hover {
            background: var(--color-error);
            border-color: var(--color-error);
            color: white;
        }
        
        .poll-add-option {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 0.75rem;
            background: none;
            border: 1px dashed var(--color-border);
            border-radius: var(--radius-md);
            color: var(--color-text-muted);
            cursor: pointer;
            font-size: 0.875rem;
            width: 100%;
            margin-top: 0.5rem;
            transition: all 0.2s;
        }
        
        .poll-add-option:hover {
            border-color: var(--color-brand);
            color: var(--color-brand);
            background: var(--color-brand-muted);
        }
        
        .poll-add-option:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        /* ===== SCHEDULE PICKER ===== */
        .schedule-picker {
            display: none;
            margin-top: 0.75rem;
            padding: 1rem;
            background: var(--color-bg-elevated);
            border: 1px solid var(--color-border);
            border-radius: var(--radius-lg);
            animation: slideDown 0.2s ease;
        }
        
        .schedule-picker.visible {
            display: block;
        }
        
        .schedule-picker-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.75rem;
        }
        
        .schedule-picker-title {
            font-size: 0.875rem;
            font-weight: 600;
            color: var(--color-text-primary);
        }
        
        .schedule-remove-btn {
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--color-bg-secondary);
            border: 1px solid var(--color-border);
            border-radius: 50%;
            color: var(--color-text-muted);
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .schedule-remove-btn:hover {
            background: var(--color-danger);
            border-color: var(--color-danger);
            color: white;
        }
        
        .schedule-picker-inputs {
            display: flex;
            gap: 0.75rem;
            margin-bottom: 0.75rem;
        }
        
        .schedule-input-group {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 0.25rem;
        }
        
        .schedule-input-group label {
            font-size: 0.75rem;
            color: var(--color-text-muted);
            font-weight: 500;
        }
        
        .schedule-input {
            padding: 0.5rem 0.75rem;
            background: var(--color-bg-primary);
            border: 1px solid var(--color-border);
            border-radius: var(--radius-md);
            color: var(--color-text-primary);
            font-size: 0.875rem;
            font-family: inherit;
            transition: all 0.2s;
        }
        
        .schedule-input:focus {
            outline: none;
            border-color: var(--color-brand);
            box-shadow: 0 0 0 3px var(--color-brand-muted);
        }
        
        .schedule-preview {
            font-size: 0.8rem;
            color: var(--color-text-muted);
            text-align: center;
            margin-bottom: 0.75rem;
            min-height: 1.2rem;
        }
        
        .schedule-preview.error {
            color: var(--color-danger);
        }
        
        .schedule-confirm-btn {
            width: 100%;
            padding: 0.625rem 1rem;
            background: linear-gradient(135deg, var(--color-brand) 0%, #a855f7 100%);
            border: none;
            border-radius: var(--radius-md);
            color: white;
            font-size: 0.875rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .schedule-confirm-btn:hover {
            opacity: 0.9;
            transform: translateY(-1px);
        }
        
        .schedule-confirm-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }
        
        /* Scheduled indicator */
        .scheduled-indicator {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-top: 0.75rem;
            padding: 0.625rem 0.875rem;
            background: linear-gradient(135deg, rgba(99, 102, 241, 0.1) 0%, rgba(168, 85, 247, 0.1) 100%);
            border: 1px solid var(--color-brand);
            border-radius: var(--radius-md);
            color: var(--color-brand);
            font-size: 0.8rem;
            font-weight: 500;
        }
        
        .scheduled-indicator svg {
            flex-shrink: 0;
        }
        
        .scheduled-indicator span {
            flex: 1;
        }
        
        .scheduled-indicator-remove {
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: transparent;
            border: 1px solid currentColor;
            border-radius: 50%;
            color: inherit;
            font-size: 0.875rem;
            cursor: pointer;
            transition: all 0.2s;
            opacity: 0.7;
        }
        
        .scheduled-indicator-remove:hover {
            opacity: 1;
            background: var(--color-brand);
            color: white;
        }
        
        /* Scheduled post badge in feed */
        .post-scheduled-badge {
            display: inline-flex;
            align-items: center;
            gap: 0.25rem;
            padding: 0.25rem 0.5rem;
            background: linear-gradient(135deg, rgba(99, 102, 241, 0.15) 0%, rgba(168, 85, 247, 0.15) 100%);
            border-radius: var(--radius-sm);
            color: var(--color-brand);
            font-size: 0.7rem;
            font-weight: 600;
            margin-left: 0.5rem;
        }
        
        .post-scheduled-badge svg {
            width: 10px;
            height: 10px;
        }
        
        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        /* Poll display in posts */
        .post-poll {
            margin-top: 0.75rem;
            padding: 0.75rem;
            background: var(--color-bg-elevated);
            border: 1px solid var(--color-border);
            border-radius: var(--radius-lg);
        }
        
        .poll-question {
            font-weight: 500;
            font-size: 0.9rem;
            margin-bottom: 0.75rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .poll-options {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }
        
        .poll-option {
            position: relative;
            padding: 0.625rem 0.75rem;
            background: var(--color-bg-secondary);
            border: 1px solid var(--color-border);
            border-radius: var(--radius-md);
            cursor: pointer;
            transition: all 0.2s;
            overflow: hidden;
        }
        
        .poll-option:hover:not(.voted):not(.disabled) {
            border-color: var(--color-brand);
            background: var(--color-brand-muted);
        }
        
        .poll-option.selected {
            border-color: var(--color-brand);
            background: var(--color-brand-muted);
        }
        
        .poll-option.disabled {
            cursor: default;
        }
        
        .poll-option-bar {
            position: absolute;
            top: 0;
            left: 0;
            height: 100%;
            background: var(--color-brand-muted);
            border-radius: var(--radius-md) 0 0 var(--radius-md);
            transition: width 0.5s cubic-bezier(0.4, 0, 0.2, 1);
            z-index: 0;
        }
        
        .poll-option.selected .poll-option-bar {
            background: rgba(99, 102, 241, 0.25);
        }
        
        .poll-option-content {
            position: relative;
            z-index: 1;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .poll-option-text {
            font-size: 0.875rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .poll-option-check {
            width: 18px;
            height: 18px;
            border-radius: 50%;
            border: 2px solid var(--color-border);
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }
        
        .poll-option.selected .poll-option-check {
            background: var(--color-brand);
            border-color: var(--color-brand);
            color: white;
        }
        
        .poll-option-percent {
            font-size: 0.8rem;
            font-weight: 600;
            color: var(--color-text-secondary);
        }
        
        .poll-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 0.75rem;
            padding-top: 0.5rem;
            border-top: 1px solid var(--color-border);
            font-size: 0.75rem;
            color: var(--color-text-muted);
        }
        
        .poll-vote-count {
            display: flex;
            align-items: center;
            gap: 0.35rem;
        }

        /* ===== FOCUS MODE ===== */
        .focus-mode-overlay {
            position: fixed;
            inset: 0;
            background: var(--color-bg-primary);
            z-index: 500;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 2rem;
            animation: focus-fade-in 0.3s ease;
        }
        
        .focus-mode-overlay.hidden {
            display: none;
        }
        
        @keyframes focus-fade-in {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        .focus-mode-content {
            text-align: center;
            max-width: 400px;
        }
        
        .focus-mode-icon {
            font-size: 4rem;
            margin-bottom: 1.5rem;
            animation: focus-pulse 2s ease-in-out infinite;
        }
        
        @keyframes focus-pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }
        
        .focus-mode-title {
            font-family: var(--font-display, 'Space Grotesk', sans-serif);
            font-size: 1.75rem;
            font-weight: 700;
            background: linear-gradient(135deg, var(--color-brand) 0%, #a855f7 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 0.75rem;
        }
        
        .focus-mode-text {
            color: var(--color-text-secondary);
            font-size: 1rem;
            line-height: 1.6;
            margin-bottom: 0.75rem;
        }
        
        .focus-mode-hours {
            color: var(--color-text-muted);
            font-size: 0.875rem;
            margin-bottom: 2rem;
        }
        
        .focus-mode-btn {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.75rem 1.5rem;
            background: var(--color-bg-secondary);
            border: 1px solid var(--color-border);
            border-radius: var(--radius-lg);
            color: var(--color-text-secondary);
            font-size: 0.875rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .focus-mode-btn:hover {
            background: var(--color-bg-hover);
            color: var(--color-text-primary);
            border-color: var(--color-border-active);
            transform: translateY(-2px);
        }
        
        /* ===== RESPONSIVE ===== */
        @media (max-width: 480px) {
            .feed-header {
                padding: 0.75rem 0;
            }
            
            .composer {
                padding: 0.75rem;
            }
            
            .post-card {
                padding: 0.75rem;
            }
            
            .post-actions {
                flex-wrap: wrap;
                justify-content: center;
            }
            
            .share-btn span {
                display: none;
            }
            
            .share-btn {
                padding: 0.5rem;
            }
        }
        
        /* ===== REDUCED MOTION ===== */
        @media (prefers-reduced-motion: reduce) {
            .post-card,
            .skeleton-post,
            .skeleton,
            .post-image img,
            .image-modal img {
                animation: none;
                transition: none;
                opacity: 1;
                transform: none;
            }
            
            .pull-to-refresh {
                transition: none;
            }
        }
        
        /* ===== COMPACT MODE ===== */
        [data-compact-mode="true"] .post-image {
            display: none !important;
        }
        
        [data-compact-mode="true"] .post-card {
            padding: 0.75rem;
            border-radius: var(--radius-md);
        }
        
        [data-compact-mode="true"] .post-content {
            font-size: 0.9rem;
            line-height: 1.4;
            -webkit-line-clamp: 2;
            display: -webkit-box;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }
        
        [data-compact-mode="true"] .post-header {
            margin-bottom: 0.25rem;
        }
        
        [data-compact-mode="true"] .post-avatar {
            width: 28px;
            height: 28px;
            font-size: 0.75rem;
        }
        
        [data-compact-mode="true"] .post-author-name {
            font-size: 0.85rem;
        }
        
        [data-compact-mode="true"] .post-time {
            font-size: 0.7rem;
        }
        
        [data-compact-mode="true"] .post-reactions {
            margin-top: 0.5rem;
            gap: 0.25rem;
        }
        
        [data-compact-mode="true"] .post-reactions .reaction-btn {
            padding: 0.25rem 0.5rem;
            font-size: 0.8rem;
        }
        
        [data-compact-mode="true"] .post-actions {
            margin-top: 0.5rem;
            gap: 0.25rem;
        }
        
        [data-compact-mode="true"] .post-actions .share-btn {
            padding: 0.25rem 0.5rem;
            font-size: 0.75rem;
        }
        
        [data-compact-mode="true"] .post-actions .share-btn span {
            display: none;
        }
        
        [data-compact-mode="true"] .post-previews {
            display: none;
        }
        
        [data-compact-mode="true"] .giphy-content-gif {
            display: none !important;
        }
        
        /* ===== MODE LECTURE ===== */
        /* Focus sur le contenu, masque les distractions */
        
        .reading-mode-toggle {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 36px;
            height: 36px;
            background: var(--color-bg-secondary);
            border: 1px solid var(--color-border);
            border-radius: 50%;
            cursor: pointer;
            transition: all 0.2s ease;
            position: relative;
        }
        
        .reading-mode-toggle:hover {
            background: var(--color-bg-hover);
            transform: scale(1.05);
        }
        
        .reading-mode-toggle svg {
            color: var(--color-text-secondary);
            transition: all 0.2s ease;
        }
        
        .reading-mode-toggle.active {
            background: var(--color-brand-muted);
            border-color: var(--color-brand);
        }
        
        .reading-mode-toggle.active svg {
            color: var(--color-brand);
        }
        
        /* Éléments masqués en mode lecture */
        [data-reading-mode="true"] .composer {
            display: none !important;
        }
        
        [data-reading-mode="true"] .post-reactions {
            display: none !important;
        }
        
        [data-reading-mode="true"] .post-actions {
            display: none !important;
        }
        
        [data-reading-mode="true"] .giphy-content-gif {
            display: none !important;
        }
        
        /* Indicateur mode lecture actif */
        [data-reading-mode="true"] .feed-title::after {
            content: " 📖";
            font-size: 0.9em;
        }
        
        /* Posts en mode lecture: plus aérés */
        [data-reading-mode="true"] .post-card {
            border: none;
            box-shadow: none;
            background: transparent;
            padding: 1.5rem 0;
            border-bottom: 1px solid var(--color-border);
            border-radius: 0;
        }
        
        [data-reading-mode="true"] .post-content {
            font-size: 1.1rem;
            line-height: 1.7;
        }
        
        /* Animation de transition */
        .composer,
        .post-reactions,
        .post-actions,
        .post-card {
            transition: opacity 0.3s ease, transform 0.3s ease;
        }

        /* ===== DRAFTS SYSTEM ===== */
        .drafts-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            width: 36px;
            height: 36px;
            background: var(--color-bg-secondary);
            border: 1px solid var(--color-border);
            border-radius: 50%;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .drafts-btn:hover {
            background: var(--color-bg-hover);
            transform: scale(1.05);
        }
        
        .drafts-btn svg {
            color: var(--color-text-secondary);
            transition: color 0.2s;
        }
        
        .drafts-btn:hover svg {
            color: var(--color-brand);
        }
        
        .drafts-count {
            position: absolute;
            top: -4px;
            right: -4px;
            width: 18px;
            height: 18px;
            background: var(--color-brand);
            color: white;
            font-size: 0.65rem;
            font-weight: 700;
            border-radius: 50%;
            display: none;
            align-items: center;
            justify-content: center;
            border: 2px solid var(--color-bg-primary);
        }
        
        /* Scheduled posts button */
        .scheduled-posts-btn {
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 36px;
            height: 36px;
            background: var(--color-bg-secondary);
            border: 1px solid var(--color-border);
            border-radius: 50%;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .scheduled-posts-btn:hover {
            background: var(--color-bg-hover);
            border-color: var(--color-brand);
        }
        
        .scheduled-posts-btn svg {
            color: var(--color-text-secondary);
            transition: color 0.2s;
        }
        
        .scheduled-posts-btn:hover svg {
            color: var(--color-brand);
        }
        
        .scheduled-count {
            position: absolute;
            top: -4px;
            right: -4px;
            min-width: 18px;
            height: 18px;
            padding: 0 4px;
            background: linear-gradient(135deg, var(--color-brand) 0%, #a855f7 100%);
            color: white;
            font-size: 0.65rem;
            font-weight: 700;
            border-radius: 9px;
            display: none;
            align-items: center;
            justify-content: center;
            border: 2px solid var(--color-bg-primary);
        }
        
        /* Scheduled posts modal */
        .scheduled-modal {
            display: none;
            position: fixed;
            inset: 0;
            z-index: 1000;
            background: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(4px);
            -webkit-backdrop-filter: blur(4px);
            animation: fadeIn 0.2s ease;
        }
        
        .scheduled-modal.open {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 1rem;
        }
        
        .scheduled-modal-content {
            width: 100%;
            max-width: 500px;
            max-height: 80vh;
            background: var(--color-bg-primary);
            border: 1px solid var(--color-border);
            border-radius: var(--radius-xl);
            overflow: hidden;
            display: flex;
            flex-direction: column;
            animation: slideUp 0.3s ease;
        }
        
        .scheduled-modal-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 1rem 1.25rem;
            border-bottom: 1px solid var(--color-border);
        }
        
        .scheduled-modal-title {
            font-size: 1.1rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .scheduled-modal-close {
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--color-bg-secondary);
            border: 1px solid var(--color-border);
            border-radius: 50%;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .scheduled-modal-close:hover {
            background: var(--color-danger);
            border-color: var(--color-danger);
            color: white;
        }
        
        .scheduled-modal-body {
            flex: 1;
            overflow-y: auto;
            padding: 1rem;
        }
        
        .scheduled-post-item {
            padding: 1rem;
            background: var(--color-bg-secondary);
            border: 1px solid var(--color-border);
            border-radius: var(--radius-lg);
            margin-bottom: 0.75rem;
        }
        
        .scheduled-post-item:last-child {
            margin-bottom: 0;
        }
        
        .scheduled-post-time {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.8rem;
            color: var(--color-brand);
            font-weight: 600;
            margin-bottom: 0.5rem;
        }
        
        .scheduled-post-content {
            font-size: 0.9rem;
            color: var(--color-text-primary);
            line-height: 1.5;
            margin-bottom: 0.75rem;
            white-space: pre-wrap;
            word-break: break-word;
        }
        
        .scheduled-post-actions {
            display: flex;
            gap: 0.5rem;
        }
        
        .scheduled-post-actions button {
            padding: 0.375rem 0.75rem;
            font-size: 0.75rem;
            font-weight: 500;
            border-radius: var(--radius-md);
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .scheduled-post-delete {
            background: transparent;
            border: 1px solid var(--color-danger);
            color: var(--color-danger);
        }
        
        .scheduled-post-delete:hover {
            background: var(--color-danger);
            color: white;
        }
        
        .scheduled-empty {
            text-align: center;
            padding: 2rem 1rem;
            color: var(--color-text-muted);
        }
        
        .scheduled-empty svg {
            width: 48px;
            height: 48px;
            margin-bottom: 1rem;
            opacity: 0.5;
        }
        
        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        /* Autosave indicator */
        .autosave-indicator {
            position: absolute;
            top: 0.5rem;
            right: 0.5rem;
            padding: 0.35rem 0.75rem;
            background: var(--color-bg-elevated);
            border: 1px solid var(--color-border);
            border-radius: var(--radius-lg);
            font-size: 0.75rem;
            color: var(--color-text-muted);
            opacity: 0;
            transform: translateY(-10px);
            transition: all 0.3s ease;
            pointer-events: none;
            z-index: 10;
        }
        
        .autosave-indicator.visible {
            opacity: 1;
            transform: translateY(0);
        }
        
        /* Drafts Modal */
        .drafts-modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(4px);
            z-index: 1000;
            display: none;
            align-items: center;
            justify-content: center;
            padding: 1rem;
        }
        
        .drafts-modal-overlay.open {
            display: flex;
            animation: fade-in 0.2s ease;
        }
        
        @keyframes fade-in {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        .drafts-modal {
            background: var(--color-bg-secondary);
            border: 1px solid var(--color-border);
            border-radius: var(--radius-xl);
            padding: 1.25rem;
            max-width: 420px;
            width: 100%;
            max-height: 80vh;
            display: flex;
            flex-direction: column;
            animation: modal-slide-in 0.3s ease;
        }
        
        @keyframes modal-slide-in {
            from { 
                opacity: 0; 
                transform: translateY(20px) scale(0.95);
            }
            to { 
                opacity: 1; 
                transform: translateY(0) scale(1);
            }
        }
        
        .drafts-modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
            padding-bottom: 0.75rem;
            border-bottom: 1px solid var(--color-border);
        }
        
        .drafts-modal-title {
            font-size: 1.1rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .drafts-modal-close {
            background: none;
            border: none;
            font-size: 1.5rem;
            color: var(--color-text-muted);
            cursor: pointer;
            padding: 0.25rem;
            line-height: 1;
            transition: color 0.2s;
        }
        
        .drafts-modal-close:hover {
            color: var(--color-text-primary);
        }
        
        .drafts-list {
            flex: 1;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }
        
        .drafts-empty {
            text-align: center;
            padding: 2.5rem 1rem;
            color: var(--color-text-muted);
        }
        
        .drafts-empty-icon {
            font-size: 3rem;
            margin-bottom: 1rem;
        }
        
        .drafts-empty-title {
            font-size: 1rem;
            font-weight: 600;
            color: var(--color-text-secondary);
            margin-bottom: 0.5rem;
        }
        
        .drafts-empty-text {
            font-size: 0.875rem;
            line-height: 1.5;
        }
        
        .draft-item {
            display: flex;
            align-items: flex-start;
            gap: 0.75rem;
            padding: 0.875rem;
            background: var(--color-bg-elevated);
            border: 1px solid var(--color-border);
            border-radius: var(--radius-lg);
            transition: all 0.2s;
            animation: draft-slide-in 0.3s ease forwards;
            opacity: 0;
        }
        
        @keyframes draft-slide-in {
            from { 
                opacity: 0; 
                transform: translateX(-10px);
            }
            to { 
                opacity: 1; 
                transform: translateX(0);
            }
        }
        
        .draft-item:hover {
            border-color: var(--color-brand);
            background: var(--color-brand-muted);
        }
        
        .draft-item.active {
            border-color: var(--color-brand);
            background: var(--color-brand-muted);
        }
        
        .draft-item-content {
            flex: 1;
            cursor: pointer;
            min-width: 0;
        }
        
        .draft-item-preview {
            font-size: 0.9rem;
            line-height: 1.4;
            color: var(--color-text-primary);
            margin-bottom: 0.5rem;
            word-break: break-word;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }
        
        .draft-item-meta {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            flex-wrap: wrap;
        }
        
        .draft-item-time {
            font-size: 0.75rem;
            color: var(--color-text-muted);
        }
        
        .draft-media-indicator {
            font-size: 0.7rem;
            padding: 0.15rem 0.4rem;
            background: var(--color-bg-secondary);
            border: 1px solid var(--color-border);
            border-radius: var(--radius-sm);
        }
        
        .draft-active-badge {
            font-size: 0.65rem;
            padding: 0.2rem 0.5rem;
            background: var(--color-brand);
            color: white;
            border-radius: var(--radius-sm);
            font-weight: 600;
        }
        
        .draft-item-delete {
            flex-shrink: 0;
            width: 32px;
            height: 32px;
            background: none;
            border: 1px solid transparent;
            border-radius: var(--radius-md);
            color: var(--color-text-muted);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }
        
        .draft-item-delete:hover {
            background: var(--color-error);
            border-color: var(--color-error);
            color: white;
        }
        
        .drafts-modal-footer {
            margin-top: 1rem;
            padding-top: 0.75rem;
            border-top: 1px solid var(--color-border);
            font-size: 0.75rem;
            color: var(--color-text-muted);
            text-align: center;
        }
        
        .drafts-modal-footer kbd {
            display: inline-block;
            padding: 0.15rem 0.4rem;
            background: var(--color-bg-primary);
            border: 1px solid var(--color-border);
            border-radius: var(--radius-sm);
            font-family: monospace;
            font-size: 0.7rem;
        }

        /* ===== DAILY PROMPT ===== */
        .daily-prompt {
            background: linear-gradient(135deg, rgba(99, 102, 241, 0.1) 0%, rgba(168, 85, 247, 0.1) 100%);
            border: 1px solid rgba(99, 102, 241, 0.3);
            border-radius: var(--radius-xl);
            padding: 1rem 1.25rem;
            margin-bottom: 1rem;
            position: relative;
            overflow: hidden;
            transition: all 0.3s ease;
            cursor: pointer;
        }
        
        .daily-prompt::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(90deg, var(--color-brand) 0%, #a855f7 50%, var(--color-brand) 100%);
            background-size: 200% 100%;
            animation: shimmer 3s ease-in-out infinite;
        }
        
        @keyframes shimmer {
            0%, 100% { background-position: 200% 0; }
            50% { background-position: 0 0; }
        }
        
        .daily-prompt:hover {
            border-color: var(--color-brand);
            transform: translateY(-2px);
            box-shadow: 0 8px 24px rgba(99, 102, 241, 0.2);
        }
        
        .daily-prompt-header {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 0.5rem;
        }
        
        .daily-prompt-badge {
            display: inline-flex;
            align-items: center;
            gap: 0.35rem;
            padding: 0.25rem 0.6rem;
            background: linear-gradient(135deg, var(--color-brand) 0%, #a855f7 100%);
            border-radius: var(--radius-full, 9999px);
            font-size: 0.7rem;
            font-weight: 600;
            color: white;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .daily-prompt-badge svg {
            width: 12px;
            height: 12px;
        }
        
        .daily-prompt-dismiss {
            position: absolute;
            top: 0.5rem;
            right: 0.5rem;
            width: 24px;
            height: 24px;
            background: transparent;
            border: none;
            border-radius: 50%;
            color: var(--color-text-muted);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
            opacity: 0;
        }
        
        .daily-prompt:hover .daily-prompt-dismiss {
            opacity: 1;
        }
        
        .daily-prompt-dismiss:hover {
            background: var(--color-bg-hover);
            color: var(--color-text-primary);
        }
        
        .daily-prompt-content {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }
        
        .daily-prompt-emoji {
            font-size: 2rem;
            line-height: 1;
            filter: drop-shadow(0 2px 4px rgba(0,0,0,0.2));
        }
        
        .daily-prompt-text {
            flex: 1;
            font-size: 1rem;
            font-weight: 500;
            color: var(--color-text-primary);
            line-height: 1.4;
        }
        
        .daily-prompt-arrow {
            color: var(--color-brand);
            opacity: 0;
            transform: translateX(-5px);
            transition: all 0.2s;
        }
        
        .daily-prompt:hover .daily-prompt-arrow {
            opacity: 1;
            transform: translateX(0);
        }
        
        .daily-prompt-footer {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-top: 0.75rem;
            font-size: 0.75rem;
            color: var(--color-text-muted);
        }
        
        .daily-prompt-hint {
            display: flex;
            align-items: center;
            gap: 0.35rem;
        }
        
        .daily-prompt-hint svg {
            width: 12px;
            height: 12px;
        }
        
        .daily-prompt.hidden {
            display: none;
        }
        
        .daily-prompt.collapsed {
            padding: 0.75rem 1rem;
        }
        
        .daily-prompt.collapsed .daily-prompt-content {
            gap: 0.5rem;
        }
        
        .daily-prompt.collapsed .daily-prompt-emoji {
            font-size: 1.25rem;
        }
        
        .daily-prompt.collapsed .daily-prompt-text {
            font-size: 0.875rem;
        }
        
        .daily-prompt.collapsed .daily-prompt-footer {
            display: none;
        }
        
        /* Animation d'entrée */
        .daily-prompt.animate-in {
            animation: prompt-slide-in 0.5s cubic-bezier(0.34, 1.56, 0.64, 1) forwards;
        }
        
        @keyframes prompt-slide-in {
            0% {
                opacity: 0;
                transform: translateY(-20px) scale(0.95);
            }
            100% {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }
        
        /* Mode lecture compact */
        [data-reading-mode="true"] .daily-prompt {
            padding: 0.75rem 1rem;
        }
        
        [data-reading-mode="true"] .daily-prompt .daily-prompt-emoji {
            font-size: 1.5rem;
        }
        
        /* Mode compact */
        [data-compact-mode="true"] .daily-prompt {
            padding: 0.75rem 1rem;
            margin-bottom: 0.75rem;
        }
        
        [data-compact-mode="true"] .daily-prompt .daily-prompt-emoji {
            font-size: 1.5rem;
        }
        
        [data-compact-mode="true"] .daily-prompt .daily-prompt-footer {
            margin-top: 0.5rem;
        }
    </style>
    
    <!-- Confetti celebrations -->
    <script src="/js/confetti.js"></script>
    <!-- View Transitions -->
    <link rel="stylesheet" href="/css/view-transitions.min.css">
</head>
<body>
    <!-- Skip Links - WCAG AAA Compliant -->
    <nav class="skip-links" aria-label="Liens d'évitement">
        <a href="#main-content" class="skip-link">Aller au contenu principal</a>
        <a href="#feed-posts" class="skip-link">Aller aux publications</a>
    </nav>
    
    <!-- Live region for dynamic announcements -->
    <div id="sr-announce" class="sr-announce" aria-live="polite" aria-atomic="true"></div>
    
    <div class="noise-overlay" aria-hidden="true"></div>
    
    <!-- Pull to Refresh Indicator -->
    <div class="pull-to-refresh" id="pull-to-refresh" aria-live="polite" aria-label="Tirer pour rafraîchir">
        <svg class="ptr-arrow" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
            <polyline points="6 9 12 15 18 9"/>
        </svg>
        <svg class="ptr-spinner" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true" style="display: none;">
            <path d="M21 12a9 9 0 1 1-6.219-8.56"/>
        </svg>
        <span class="ptr-text">Tirer pour rafraîchir</span>
    </div>
    
    <!-- Toast Container -->
    <div class="toast-container" id="toast-container" role="status" aria-live="polite"></div>
    
    <!-- Image Modal -->
    <div class="image-modal" id="image-modal" role="dialog" aria-modal="true" aria-label="Image agrandie" onclick="closeImageModal()">
        <button class="image-modal-close" onclick="closeImageModal()" aria-label="Fermer">×</button>
        <img id="modal-image" src="" alt="Image agrandie">
    </div>

    <!-- Seen By Modal -->
    <div class="seen-by-modal-overlay" id="seen-by-modal" role="dialog" aria-modal="true" aria-labelledby="seen-by-modal-title" onclick="closeSeenByModal(event)">
        <div class="seen-by-modal" onclick="event.stopPropagation()">
            <div class="seen-by-modal-header">
                <h3 class="seen-by-modal-title" id="seen-by-modal-title">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/>
                        <circle cx="12" cy="12" r="3"/>
                    </svg>
                    Vu par
                </h3>
                <button class="seen-by-modal-close" onclick="closeSeenByModal()" aria-label="Fermer">×</button>
            </div>
            <div class="seen-by-list" id="seen-by-list">
                <!-- Will be populated dynamically -->
            </div>
        </div>
    </div>

    <!-- Drafts Modal -->
    <div class="drafts-modal-overlay" id="drafts-modal" role="dialog" aria-modal="true" aria-labelledby="drafts-modal-title" onclick="CinqDrafts.closeModal()">
        <div class="drafts-modal" onclick="event.stopPropagation()">
            <div class="drafts-modal-header">
                <h3 class="drafts-modal-title" id="drafts-modal-title">
                    📝 Mes brouillons
                </h3>
                <button class="drafts-modal-close" onclick="CinqDrafts.closeModal()" aria-label="Fermer">×</button>
            </div>
            <div class="drafts-list" id="drafts-list">
                <!-- Will be populated dynamically -->
            </div>
            <div class="drafts-modal-footer">
                Raccourci: <kbd>Ctrl</kbd> + <kbd>Shift</kbd> + <kbd>D</kbd>
            </div>
        </div>
    </div>

    <main class="feed-container" id="main-content">
        <header class="feed-header">
            <a href="/app.html" class="feed-logo" aria-label="Retour à l'accueil">5</a>
            <span class="feed-title">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true" style="vertical-align: middle; margin-right: 4px;">
                    <path d="M4 11a9 9 0 0 1 9 9"/><path d="M4 4a16 16 0 0 1 16 16"/><circle cx="5" cy="19" r="1"/>
                </svg>
                Feed
            </span>
            <div class="header-actions">
                <!-- Quick Profile Edit Avatar -->
                <button class="header-profile-avatar" id="header-profile-avatar" aria-label="Modifier le profil" title="Modifier le profil">
                    <span id="header-avatar-emoji">?</span>
                    <span class="edit-hint">✏️</span>
                </button>
                <button class="drafts-btn" id="drafts-btn" onclick="CinqDrafts.openModal()" aria-label="Voir mes brouillons" title="Brouillons">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
                        <polyline points="14 2 14 8 20 8"/>
                        <line x1="16" y1="13" x2="8" y2="13"/>
                        <line x1="16" y1="17" x2="8" y2="17"/>
                        <polyline points="10 9 9 9 8 9"/>
                    </svg>
                    <span class="drafts-count" id="drafts-count">0</span>
                </button>
                <button class="scheduled-posts-btn" id="scheduled-posts-btn" onclick="openScheduledPostsModal()" aria-label="Voir mes posts programmés" title="Posts programmés">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <circle cx="12" cy="12" r="10"/>
                        <polyline points="12 6 12 12 16 14"/>
                    </svg>
                    <span class="scheduled-count" id="scheduled-count" style="display: none;">0</span>
                </button>
                <button class="reading-mode-toggle" id="reading-mode-toggle" onclick="toggleReadingMode()" aria-label="Activer/désactiver le mode lecture" title="Mode Lecture">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"/>
                        <path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"/>
                    </svg>
                </button>
                <a href="/read-later.html" class="back-btn" aria-label="À lire plus tard" title="À lire plus tard" style="padding: 0.5rem;">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>
                </a>
                <a href="/bookmarks.html" class="back-btn" aria-label="Voir mes favoris" title="Favoris" style="padding: 0.5rem;">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M19 21l-7-5-7 5V5a2 2 0 0 1 2-2h10a2 2 0 0 1 2 2z"/></svg>
                </a>
                <button class="theme-toggle" onclick="toggleTheme()" aria-label="Basculer mode clair/sombre">
                    <svg class="icon-sun" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg>
                    <svg class="icon-moon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/></svg>
                </button>
                <a href="/app.html" class="back-btn" aria-label="Retour à l'application">← Retour</a>
            </div>
        </header>

        <!-- Focus Mode Overlay -->
        <div id="focus-mode-overlay" class="focus-mode-overlay hidden" role="alert" aria-live="polite">
            <div class="focus-mode-content">
                <div class="focus-mode-icon">🎯</div>
                <h2 class="focus-mode-title">Mode Focus actif</h2>
                <p class="focus-mode-text">C'est l'heure de te concentrer ! Le feed est masqué pendant tes heures de travail.</p>
                <p class="focus-mode-hours" id="focus-mode-hours">Retour du feed à 18:00</p>
                <button class="focus-mode-btn" onclick="bypassFocusMode()">
                    <span>👀</span> Afficher quand même
                </button>
            </div>
        </div>

        <!-- Daily Prompt -->
        <div class="daily-prompt hidden" id="daily-prompt" role="region" aria-label="Suggestion du jour" onclick="useDailyPrompt()">
            <div class="daily-prompt-header">
                <span class="daily-prompt-badge">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <circle cx="12" cy="12" r="10"></circle>
                        <polyline points="12 6 12 12 16 14"></polyline>
                    </svg>
                    Idée du jour
                </span>
            </div>
            <button class="daily-prompt-dismiss" onclick="dismissDailyPrompt(event)" aria-label="Masquer la suggestion">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <line x1="18" y1="6" x2="6" y2="18"></line>
                    <line x1="6" y1="6" x2="18" y2="18"></line>
                </svg>
            </button>
            <div class="daily-prompt-content">
                <span class="daily-prompt-emoji" id="daily-prompt-emoji">💡</span>
                <span class="daily-prompt-text" id="daily-prompt-text">Chargement...</span>
                <svg class="daily-prompt-arrow" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <polyline points="9 18 15 12 9 6"></polyline>
                </svg>
            </div>
            <div class="daily-prompt-footer">
                <span class="daily-prompt-hint">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M15 15l-2 5L9 9l11 4-5 2zm0 0l5 5"></path>
                    </svg>
                    Clique pour utiliser cette idée
                </span>
            </div>
        </div>

        <!-- Composer -->
        <div class="composer" id="composer" role="form" aria-label="Créer un nouveau post" style="position: relative;">
            <div class="autosave-indicator" id="autosave-indicator" aria-live="polite">
                ✓ Brouillon sauvegardé
            </div>
            <div class="composer-header">
                <div class="composer-avatar" id="composer-avatar" aria-hidden="true">?</div>
                <span class="composer-user" id="composer-user">Chargement...</span>
            </div>
            <textarea 
                class="composer-textarea" 
                id="post-content" 
                placeholder="Quoi de neuf ? Partage quelque chose avec tes 5..."
                maxlength="280"
                aria-label="Contenu du post"
            ></textarea>
            <div class="image-preview" id="image-preview" style="display: none;" aria-label="Aperçu de l'image">
                <img id="preview-img" src="" alt="Aperçu de l'image à poster">
                <button class="image-preview-remove" onclick="removeImage()" aria-label="Supprimer l'image">×</button>
                <div id="upload-progress" style="display: none; position: absolute; bottom: 0; left: 0; right: 0; background: rgba(0,0,0,0.7); padding: 0.5rem; text-align: center; font-size: 0.75rem;" role="status" aria-live="polite">
                    ⏳ Upload en cours...
                </div>
            </div>
            <!-- GIF preview -->
            <div class="giphy-selected-preview" id="gif-preview" style="display: none;" aria-label="Aperçu du GIF">
                <img id="gif-preview-img" src="" alt="GIF sélectionné">
                <button type="button" class="giphy-preview-remove" onclick="removeGif()" aria-label="Retirer le GIF">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="18" y1="6" x2="6" y2="18"></line>
                        <line x1="6" y1="6" x2="18" y2="18"></line>
                    </svg>
                </button>
                <span class="giphy-badge">GIF</span>
            </div>
            <!-- Hidden file input -->
            <input type="file" id="file-input" accept="image/jpeg,image/png,image/gif,image/webp" style="display: none;" onchange="handleFileSelect(event)" aria-label="Sélectionner une image">
            <!-- AI Generation input -->
            <div id="ai-prompt-container" style="display: none; margin-top: 0.5rem;">
                <div style="display: flex; gap: 0.5rem;">
                    <input 
                        type="text" 
                        class="image-url-input" 
                        id="ai-prompt" 
                        placeholder="Décris l'image à générer... (ex: un chat sur la lune)"
                        maxlength="500"
                        style="flex: 1;"
                        aria-label="Description de l'image à générer"
                    >
                    <button class="composer-btn" onclick="generateAIImage()" id="generate-btn" style="background: linear-gradient(135deg, #a855f7, #6366f1); color: white; border: none;" aria-label="Générer l'image">
                        ✨ Générer
                    </button>
                </div>
                <div style="font-size: 0.7rem; color: var(--color-text-muted); margin-top: 0.25rem;">
                    🤖 Génération IA (5 par heure max)
                </div>
            </div>
            <!-- Poll composer -->
            <div class="poll-composer" id="poll-composer">
                <div class="poll-composer-header">
                    <span class="poll-composer-title">📊 Créer un sondage</span>
                    <button class="poll-remove-option" onclick="togglePollComposer()" aria-label="Fermer">×</button>
                </div>
                <div class="poll-options-list" id="poll-options-list">
                    <div class="poll-option-input" data-index="0">
                        <label for="poll-option-0" class="poll-option-number">1</label>
                        <input type="text" id="poll-option-0" placeholder="Option 1" maxlength="100" onkeydown="handlePollOptionKeydown(event, 0)" aria-label="Première option du sondage">
                    </div>
                    <div class="poll-option-input" data-index="1">
                        <label for="poll-option-1" class="poll-option-number">2</label>
                        <input type="text" id="poll-option-1" placeholder="Option 2" maxlength="100" onkeydown="handlePollOptionKeydown(event, 1)" aria-label="Deuxième option du sondage">
                    </div>
                </div>
                <button class="poll-add-option" id="poll-add-option" onclick="addPollOption()">
                    + Ajouter une option
                </button>
            </div>
            <div class="composer-footer">
                <div class="composer-actions">
                    <button class="composer-btn" id="upload-image-btn" onclick="triggerFileUpload()" aria-label="Ajouter une photo">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                            <rect x="3" y="3" width="18" height="18" rx="2"/><circle cx="8.5" cy="8.5" r="1.5"/><polyline points="21 15 16 10 5 21"/>
                        </svg>
                        Photo
                    </button>
                    <button class="composer-btn" id="ai-image-btn" onclick="toggleAIPrompt()" aria-label="Générer une image par IA">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                            <polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/>
                        </svg>
                        IA
                    </button>
                    <button class="composer-btn" id="poll-btn" onclick="togglePollComposer()" aria-label="Créer un sondage">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                            <rect x="3" y="3" width="18" height="18" rx="2"/><path d="M7 12h2v5H7z"/><path d="M11 8h2v9h-2z"/><path d="M15 10h2v7h-2z"/>
                        </svg>
                        Sondage
                    </button>
                    <button class="composer-btn giphy-trigger-btn" id="gif-btn" onclick="toggleGifPicker()" aria-label="Ajouter un GIF">
                        GIF
                    </button>
                    <button class="composer-btn" id="schedule-btn" onclick="toggleScheduler()" aria-label="Programmer le post">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                            <circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/>
                        </svg>
                        Programmer
                    </button>
                </div>
                <div style="display: flex; align-items: center; gap: 1rem;">
                    <span class="char-count" id="char-count" aria-live="polite">0/280</span>
                    <button class="post-btn" id="post-btn" onclick="submitPost()" disabled aria-label="Publier le post">
                        Poster
                    </button>
                </div>
            </div>
            <!-- Schedule picker -->
            <div class="schedule-picker" id="schedule-picker">
                <div class="schedule-picker-header">
                    <span class="schedule-picker-title">🕐 Programmer le post</span>
                    <button class="schedule-remove-btn" onclick="cancelSchedule()" aria-label="Annuler la programmation">×</button>
                </div>
                <div class="schedule-picker-inputs">
                    <div class="schedule-input-group">
                        <label for="schedule-date">Date</label>
                        <input type="date" id="schedule-date" class="schedule-input">
                    </div>
                    <div class="schedule-input-group">
                        <label for="schedule-time">Heure</label>
                        <input type="time" id="schedule-time" class="schedule-input" value="09:00">
                    </div>
                </div>
                <div class="schedule-preview" id="schedule-preview"></div>
                <button class="schedule-confirm-btn" id="schedule-confirm-btn" onclick="confirmSchedule()">
                    ✓ Confirmer la programmation
                </button>
            </div>
            <!-- Scheduled indicator (shown when post is scheduled) -->
            <div class="scheduled-indicator" id="scheduled-indicator" style="display: none;">
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/>
                </svg>
                <span id="scheduled-indicator-text">Programmé pour...</span>
                <button class="scheduled-indicator-remove" onclick="cancelSchedule()" aria-label="Annuler la programmation">×</button>
            </div>
        </div>

        <!-- Trending Tags -->
        <div class="trending-tags" id="trending-tags" style="display: none;">
            <div class="trending-tags-header">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <line x1="18" y1="20" x2="18" y2="10"></line>
                    <line x1="12" y1="20" x2="12" y2="4"></line>
                    <line x1="6" y1="20" x2="6" y2="14"></line>
                </svg>
                Tags tendance
            </div>
            <div class="trending-tags-list" id="trending-tags-list">
                <span class="trending-tags-empty">Chargement...</span>
            </div>
        </div>

        <!-- Posts List -->
        <div class="posts-list" id="posts-list" role="feed" aria-label="Liste des posts">
            <!-- Loading skeletons -->
            <div class="skeleton-post" id="skeleton-1" aria-hidden="true">
                <div style="display: flex; gap: 0.75rem; margin-bottom: 0.75rem;">
                    <div class="skeleton skeleton-avatar"></div>
                    <div style="flex: 1;">
                        <div class="skeleton skeleton-title"></div>
                        <div class="skeleton skeleton-text"></div>
                    </div>
                </div>
                <div class="skeleton skeleton-body"></div>
            </div>
            <div class="skeleton-post" id="skeleton-2" aria-hidden="true">
                <div style="display: flex; gap: 0.75rem; margin-bottom: 0.75rem;">
                    <div class="skeleton skeleton-avatar"></div>
                    <div style="flex: 1;">
                        <div class="skeleton skeleton-title" style="width: 45%;"></div>
                        <div class="skeleton skeleton-text" style="width: 30%;"></div>
                    </div>
                </div>
                <div class="skeleton skeleton-body" style="height: 40px;"></div>
                <div class="skeleton skeleton-image"></div>
            </div>
            <div class="skeleton-post" id="skeleton-3" aria-hidden="true">
                <div style="display: flex; gap: 0.75rem; margin-bottom: 0.75rem;">
                    <div class="skeleton skeleton-avatar"></div>
                    <div style="flex: 1;">
                        <div class="skeleton skeleton-title" style="width: 70%;"></div>
                        <div class="skeleton skeleton-text" style="width: 25%;"></div>
                    </div>
                </div>
                <div class="skeleton skeleton-body" style="height: 80px;"></div>
            </div>
        </div>
        
        <!-- Scroll sentinel for infinite scroll -->
        <div class="scroll-sentinel" id="scroll-sentinel" aria-hidden="true"></div>
    </main>
    
    <!-- Scheduled Posts Modal -->
    <div class="scheduled-modal" id="scheduled-modal" onclick="closeScheduledModal(event)">
        <div class="scheduled-modal-content" onclick="event.stopPropagation()">
            <div class="scheduled-modal-header">
                <span class="scheduled-modal-title">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/>
                    </svg>
                    Posts programmés
                </span>
                <button class="scheduled-modal-close" onclick="closeScheduledModal()">×</button>
            </div>
            <div class="scheduled-modal-body" id="scheduled-modal-body">
                <div class="scheduled-empty">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/>
                    </svg>
                    <p>Aucun post programmé</p>
                    <p style="font-size: 0.8rem; opacity: 0.7;">Utilise le bouton "Programmer" dans le composer pour planifier tes posts.</p>
                </div>
            </div>
        </div>
    </div>

    <!-- GIPHY Integration -->
    <script src="/js/giphy.js"></script>
    
    <!-- Drafts System -->
    <script src="/js/drafts.js"></script>

    <script>
        const API_URL = '/api';
        let session = null;
        let user = null;
        let posts = [];
        let openMenuPostId = null;
        
        // GIF state
        let selectedGif = null; // { id, url, ... }
        
        // Reactions state
        const REACTION_EMOJIS = ['❤️', '😂', '😮', '😢', '👏'];
        let reactionsCache = {}; // { postId: { counts: {}, userReactions: [] } }
        
        // Bookmarks state
        let bookmarksCache = {}; // { postId: true/false }
        
        // Read Later state (localStorage)
        let readLaterCache = {}; // { postId: true/false }
        
        // ===== READ LATER FUNCTIONS =====
        function loadReadLaterCache() {
            try {
                const stored = localStorage.getItem('cinq_read_later');
                const items = stored ? JSON.parse(stored) : [];
                readLaterCache = {};
                items.forEach(item => {
                    if (item.post && item.post.id) {
                        readLaterCache[item.post.id] = true;
                    }
                });
            } catch (e) {
                console.error('Failed to load read later cache:', e);
                readLaterCache = {};
            }
        }
        
        function isInReadLater(postId) {
            return readLaterCache[postId] || false;
        }
        
        function toggleReadLater(postId, btnElement) {
            const isCurrentlyInList = isInReadLater(postId);
            const btn = document.getElementById(`readlater-btn-${postId}`);
            const text = document.getElementById(`readlater-text-${postId}`);
            
            // Animate
            if (btn) {
                btn.classList.add('animating');
                setTimeout(() => btn.classList.remove('animating'), 300);
            }
            
            try {
                const stored = localStorage.getItem('cinq_read_later');
                let items = stored ? JSON.parse(stored) : [];
                
                if (isCurrentlyInList) {
                    // Remove from list
                    items = items.filter(item => item.post.id !== postId);
                    readLaterCache[postId] = false;
                    
                    if (btn) {
                        btn.classList.remove('active');
                        btn.setAttribute('aria-pressed', 'false');
                        btn.setAttribute('aria-label', 'Lire plus tard');
                    }
                    if (text) text.textContent = 'Plus tard';
                    
                    showToast({ type: 'success', message: '📖 Retiré de la liste de lecture' });
                } else {
                    // Add to list
                    const post = posts.find(p => p.id === postId);
                    if (post) {
                        items.unshift({
                            post: post,
                            addedAt: new Date().toISOString(),
                            isRead: false
                        });
                        readLaterCache[postId] = true;
                        
                        if (btn) {
                            btn.classList.add('active');
                            btn.setAttribute('aria-pressed', 'true');
                            btn.setAttribute('aria-label', 'Retirer de la liste de lecture');
                        }
                        if (text) text.textContent = 'Dans la liste';
                        
                        showToast({ type: 'success', message: '⏰ Ajouté à "Lire plus tard"' });
                    }
                }
                
                localStorage.setItem('cinq_read_later', JSON.stringify(items));
                
            } catch (e) {
                console.error('Toggle read later error:', e);
                showToast({ type: 'error', message: 'Erreur lors de la sauvegarde' });
            }
        }
        
        // ===== PAGINATION STATE (CURSOR-BASED) =====
        let nextCursor = null;  // ISO date string of last post
        let pageSize = 10;
        let hasMorePosts = true;
        let isLoadingMore = false;
        let infiniteScrollObserver = null;
        let isInitialLoad = true;
        
        // ===== PULL TO REFRESH STATE =====
        let ptrStartY = 0;
        let ptrCurrentY = 0;
        let isPulling = false;
        let isRefreshing = false;
        const PTR_THRESHOLD = 80;

        // ===== DAILY PROMPT STATE =====
        let currentDailyPrompt = null;
        const DAILY_PROMPT_DISMISSED_KEY = 'cinq_daily_prompt_dismissed';

        // ===== AUTH =====
        // getToken() and authHeaders() now provided by /js/shared.js

        // ===== FOCUS MODE =====
        let focusModeBypass = false;
        
        async function checkFocusMode() {
            try {
                const token = getToken();
                if (!token) return { active: false };
                
                const res = await fetch(`${API_URL}/user-profile`, {
                    headers: authHeaders()
                });
                
                if (!res.ok) return { active: false };
                
                const data = await res.json();
                const profile = data.profile || {};
                
                if (!profile.focus_mode) return { active: false };
                
                const focusStart = profile.focus_start || '09:00';
                const focusEnd = profile.focus_end || '18:00';
                
                // Check if current time is within focus hours
                const now = new Date();
                const currentTime = now.getHours().toString().padStart(2, '0') + ':' + 
                                   now.getMinutes().toString().padStart(2, '0');
                
                const isInFocusHours = currentTime >= focusStart && currentTime < focusEnd;
                
                return {
                    active: isInFocusHours,
                    focusEnd: focusEnd
                };
            } catch (e) {
                console.error('Focus mode check error:', e);
                return { active: false };
            }
        }
        
        function showFocusMode(focusEnd) {
            const overlay = document.getElementById('focus-mode-overlay');
            const hoursText = document.getElementById('focus-mode-hours');
            
            hoursText.textContent = `Retour du feed à ${focusEnd}`;
            overlay.classList.remove('hidden');
            
            // Hide the composer and posts
            document.getElementById('composer').style.display = 'none';
            document.getElementById('posts-list').style.display = 'none';
        }
        
        function hideFocusMode() {
            const overlay = document.getElementById('focus-mode-overlay');
            overlay.classList.add('hidden');
            
            // Show the composer and posts
            document.getElementById('composer').style.display = 'block';
            document.getElementById('posts-list').style.display = 'flex';
        }
        
        function bypassFocusMode() {
            focusModeBypass = true;
            hideFocusMode();
            // Store bypass in session storage (resets on new tab)
            sessionStorage.setItem('cinq_focus_bypass', 'true');
        }

        // ===== DAILY PROMPT =====
        async function loadDailyPrompt() {
            try {
                // Check if already dismissed today
                const dismissedDate = localStorage.getItem(DAILY_PROMPT_DISMISSED_KEY);
                const today = new Date().toISOString().split('T')[0];
                
                if (dismissedDate === today) {
                    return; // Already dismissed today
                }
                
                const res = await fetch(`${API_URL}/daily-prompt`);
                if (!res.ok) return;
                
                const data = await res.json();
                if (!data.success || !data.prompt) return;
                
                currentDailyPrompt = data.prompt;
                showDailyPrompt(data.prompt);
            } catch (e) {
                console.error('Failed to load daily prompt:', e);
            }
        }
        
        function showDailyPrompt(prompt) {
            const container = document.getElementById('daily-prompt');
            const emojiEl = document.getElementById('daily-prompt-emoji');
            const textEl = document.getElementById('daily-prompt-text');
            
            if (!container || !emojiEl || !textEl) return;
            
            emojiEl.textContent = prompt.emoji || '💡';
            textEl.textContent = prompt.text || 'Partage quelque chose avec tes 5 !';
            
            container.classList.remove('hidden');
            container.classList.add('animate-in');
        }
        
        function dismissDailyPrompt(event) {
            if (event) {
                event.stopPropagation();
            }
            
            const container = document.getElementById('daily-prompt');
            if (!container) return;
            
            // Store dismissal with today's date
            const today = new Date().toISOString().split('T')[0];
            localStorage.setItem(DAILY_PROMPT_DISMISSED_KEY, today);
            
            // Animate out
            container.style.transition = 'all 0.3s ease';
            container.style.opacity = '0';
            container.style.transform = 'translateY(-10px) scale(0.95)';
            
            setTimeout(() => {
                container.classList.add('hidden');
                container.style.opacity = '';
                container.style.transform = '';
            }, 300);
        }
        
        function useDailyPrompt() {
            if (!currentDailyPrompt) return;
            
            const textarea = document.getElementById('post-content');
            if (!textarea) return;
            
            // Focus and set a starter text
            textarea.focus();
            
            // If textarea is empty, add a conversation starter
            if (!textarea.value.trim()) {
                // Add the emoji and a space for the user to continue
                textarea.value = currentDailyPrompt.emoji + ' ';
                textarea.setSelectionRange(textarea.value.length, textarea.value.length);
            }
            
            // Trigger input event to update char count and enable button
            textarea.dispatchEvent(new Event('input', { bubbles: true }));
            
            // Scroll to composer
            const composer = document.getElementById('composer');
            if (composer) {
                composer.scrollIntoView({ behavior: 'smooth', block: 'start' });
            }
            
            // Dismiss the prompt after use
            dismissDailyPrompt();
            
            // Show a subtle toast
            if (typeof showToast === 'function') {
                showToast(`${currentDailyPrompt.emoji} ${currentDailyPrompt.text}`, 'info');
            }
        }

        // ===== INIT =====
        // ===== COMPACT MODE =====
        function initCompactMode() {
            const isCompact = localStorage.getItem('cinq_compact_mode') === 'true';
            document.documentElement.setAttribute('data-compact-mode', isCompact ? 'true' : 'false');
        }
        
        // ===== READING MODE =====
        function initReadingMode() {
            const isReading = localStorage.getItem('cinq_reading_mode') === 'true';
            document.documentElement.setAttribute('data-reading-mode', isReading ? 'true' : 'false');
            const toggle = document.getElementById('reading-mode-toggle');
            if (toggle && isReading) {
                toggle.classList.add('active');
            }
        }
        
        function toggleReadingMode() {
            const current = localStorage.getItem('cinq_reading_mode') === 'true';
            const newValue = !current;
            localStorage.setItem('cinq_reading_mode', newValue ? 'true' : 'false');
            document.documentElement.setAttribute('data-reading-mode', newValue ? 'true' : 'false');
            
            const toggle = document.getElementById('reading-mode-toggle');
            if (toggle) {
                toggle.classList.toggle('active', newValue);
            }
            
            // Announce change for screen readers
            const srAnnounce = document.getElementById('sr-announce');
            if (srAnnounce) {
                srAnnounce.textContent = newValue ? 'Mode lecture activé' : 'Mode lecture désactivé';
            }
            
            // Show toast
            showToast(newValue ? '📖 Mode Lecture activé' : '💬 Mode normal activé');
        }
        
        async function init() {
            // Initialize compact mode early for no flash
            initCompactMode();
            // Initialize reading mode
            initReadingMode();
            
            const sessionStr = localStorage.getItem('cinq_session');
            if (!sessionStr) {
                window.location.href = '/login.html';
                return;
            }

            try {
                session = JSON.parse(sessionStr);
                user = session.user;
                
                // Load Read Later cache from localStorage
                loadReadLaterCache();
                
                // Load user profile and update UI
                let userProfile = {};
                try {
                    if (typeof UserProfile !== 'undefined') {
                        UserProfile.init();
                        userProfile = await UserProfile.loadProfile() || {};
                    }
                } catch (e) {
                    console.warn('Could not load profile:', e);
                }
                
                // Update avatars with profile data
                const avatarEmoji = userProfile.avatar_emoji;
                const displayName = userProfile.display_name || user.email?.split('@')[0] || 'Toi';
                const initial = avatarEmoji || displayName[0].toUpperCase();
                
                document.getElementById('composer-avatar').textContent = initial;
                document.getElementById('composer-user').textContent = displayName;
                document.getElementById('header-avatar-emoji').textContent = initial;
                
                // Check Focus Mode (unless bypassed)
                const bypassStored = sessionStorage.getItem('cinq_focus_bypass') === 'true';
                if (!bypassStored && !focusModeBypass) {
                    const focusStatus = await checkFocusMode();
                    if (focusStatus.active) {
                        showFocusMode(focusStatus.focusEnd);
                        return; // Don't load posts when in focus mode
                    }
                }
                
                // Setup textarea listeners
                setupComposer();
                
                // Restore draft if any
                restoreDraft();
                
                // Setup Pull to Refresh
                setupPullToRefresh();
                
                // Setup Infinite Scroll
                setupInfiniteScroll();
                
                // Setup Lazy Loading
                setupLazyLoading();
                
                // Setup Post Views Tracking (Seen by feature)
                setupPostViewsTracking();
                
                // Load posts
                await loadPosts();
                
                // Load trending tags (non-blocking)
                loadTrendingTags();
                
                // Load daily prompt (non-blocking)
                loadDailyPrompt();
                
                // Load scheduled posts count (non-blocking)
                loadScheduledPostsCount();
                
            } catch (e) {
                console.error('Init error:', e);
                window.location.href = '/login.html';
            }
        }

        // ===== TRENDING TAGS =====
        async function loadTrendingTags() {
            const container = document.getElementById('trending-tags');
            const list = document.getElementById('trending-tags-list');
            
            try {
                const res = await fetch(`${API_URL}/tags?trending`, {
                    headers: authHeaders()
                });
                
                if (!res.ok) {
                    container.style.display = 'none';
                    return;
                }
                
                const data = await res.json();
                
                if (!data.trending || data.trending.length === 0) {
                    container.style.display = 'none';
                    return;
                }
                
                // Render trending tags
                list.innerHTML = data.trending.map(item => `
                    <a href="/tag.html?t=${encodeURIComponent(item.tag)}" class="trending-tag">
                        <span class="tag-name">#${escapeHtml(item.tag)}</span>
                        <span class="tag-count">${item.count}</span>
                    </a>
                `).join('');
                
                container.style.display = 'block';
                
            } catch (e) {
                console.error('Load trending tags error:', e);
                container.style.display = 'none';
            }
        }

        // ===== DRAFTS SYSTEM =====
        const DRAFT_KEY_FEED = 'cinq_draft_post_feed';
        const DRAFT_SAVE_DELAY = 500; // ms
        let draftSaveTimeout = null;
        
        function saveDraft() {
            const textarea = document.getElementById('post-content');
            if (!textarea) return;
            
            const content = textarea.value.trim();
            if (content) {
                // Save to simple draft (for current session recovery)
                localStorage.setItem(DRAFT_KEY_FEED, JSON.stringify({
                    content: textarea.value,
                    imageUrl: currentImageUrl || null,
                    pollOptions: pollEnabled ? getPollOptionsRaw() : null,
                    savedAt: Date.now()
                }));
                // Also save to multi-draft system for long-term storage
                if (typeof CinqDrafts !== 'undefined' && CinqDrafts.scheduleAutosave) {
                    CinqDrafts.scheduleAutosave();
                }
            } else {
                localStorage.removeItem(DRAFT_KEY_FEED);
            }
        }
        
        function getPollOptionsRaw() {
            const list = document.getElementById('poll-options-list');
            if (!list) return null;
            const inputs = list.querySelectorAll('input');
            const options = [];
            inputs.forEach(input => {
                options.push(input.value);
            });
            return options.length > 0 ? options : null;
        }
        
        function restoreDraft() {
            try {
                const saved = localStorage.getItem(DRAFT_KEY_FEED);
                if (!saved) return;
                
                const draft = JSON.parse(saved);
                const textarea = document.getElementById('post-content');
                const charCount = document.getElementById('char-count');
                const postBtn = document.getElementById('post-btn');
                
                if (draft.content && textarea) {
                    textarea.value = draft.content;
                    const len = draft.content.length;
                    charCount.textContent = `${len}/280`;
                    
                    charCount.classList.remove('warning', 'error');
                    if (len > 250) charCount.classList.add('error');
                    else if (len > 220) charCount.classList.add('warning');
                    
                    postBtn.disabled = len === 0 || len > 280;
                }
                
                if (draft.imageUrl) {
                    currentImageUrl = draft.imageUrl;
                    showImagePreview(draft.imageUrl);
                }
                
                if (draft.pollOptions && draft.pollOptions.length >= 2) {
                    pollEnabled = true;
                    document.getElementById('poll-composer').classList.add('visible');
                    document.getElementById('poll-btn').classList.add('active');
                    
                    const list = document.getElementById('poll-options-list');
                    list.innerHTML = '';
                    draft.pollOptions.forEach((opt, i) => {
                        const optEl = document.createElement('div');
                        optEl.className = 'poll-option-input';
                        optEl.dataset.index = i;
                        optEl.innerHTML = `
                            <label for="edit-poll-option-${i}" class="poll-option-number">${i + 1}</label>
                            <input type="text" id="edit-poll-option-${i}" placeholder="Option ${i + 1}" maxlength="100" value="${escapeHtml(opt)}" onkeydown="handlePollOptionKeydown(event, ${i})" aria-label="Option ${i + 1} du sondage">
                            ${i >= 2 ? `<button class="poll-remove-option" onclick="removePollOption(${i})" aria-label="Supprimer l'option ${i + 1}">×</button>` : ''}
                        `;
                        list.appendChild(optEl);
                    });
                    document.getElementById('poll-add-option').disabled = draft.pollOptions.length >= 4;
                }
                
                // Show toast that draft was restored
                if (draft.content) {
                    showToast({ type: 'success', message: '📝 Brouillon restauré' });
                }
            } catch (e) {
                console.error('Error restoring draft:', e);
                localStorage.removeItem(DRAFT_KEY_FEED);
            }
        }
        
        function clearDraft() {
            localStorage.removeItem(DRAFT_KEY_FEED);
            // Also clear from the new multi-draft system
            if (typeof CinqDrafts !== 'undefined' && CinqDrafts.clearCurrentDraft) {
                CinqDrafts.clearCurrentDraft();
            }
        }
        
        function scheduleDraftSave() {
            clearTimeout(draftSaveTimeout);
            draftSaveTimeout = setTimeout(saveDraft, DRAFT_SAVE_DELAY);
        }

        // ===== COMPOSER =====
        let mentionAutocomplete = null;
        let mentionSearchTimeout = null;
        let mentionSelectedIndex = 0;
        let mentionStartPos = -1;
        let contactsCache = null;
        
        function setupComposer() {
            const textarea = document.getElementById('post-content');
            const charCount = document.getElementById('char-count');
            const postBtn = document.getElementById('post-btn');
            const imageUrl = document.getElementById('image-url');
            
            // Create mention autocomplete dropdown
            mentionAutocomplete = document.createElement('div');
            mentionAutocomplete.className = 'mention-autocomplete';
            mentionAutocomplete.id = 'mention-autocomplete';
            textarea.parentElement.style.position = 'relative';
            textarea.parentElement.appendChild(mentionAutocomplete);
            
            textarea.addEventListener('input', (e) => {
                const len = textarea.value.length;
                charCount.textContent = `${len}/280`;
                
                charCount.classList.remove('warning', 'error');
                if (len > 250) charCount.classList.add('error');
                else if (len > 220) charCount.classList.add('warning');
                
                postBtn.disabled = len === 0 || len > 280;
                
                // Check for @mention trigger
                handleMentionInput(textarea);
                
                // Auto-save draft
                scheduleDraftSave();
            });
            
            // Submit on Ctrl+Enter
            textarea.addEventListener('keydown', (e) => {
                // Handle autocomplete navigation
                if (mentionAutocomplete.classList.contains('visible')) {
                    if (e.key === 'ArrowDown') {
                        e.preventDefault();
                        navigateMentionAutocomplete(1);
                        return;
                    }
                    if (e.key === 'ArrowUp') {
                        e.preventDefault();
                        navigateMentionAutocomplete(-1);
                        return;
                    }
                    if (e.key === 'Enter' || e.key === 'Tab') {
                        e.preventDefault();
                        selectMentionItem();
                        return;
                    }
                    if (e.key === 'Escape') {
                        e.preventDefault();
                        hideMentionAutocomplete();
                        return;
                    }
                }
                
                if ((e.ctrlKey || e.metaKey) && e.key === 'Enter') {
                    e.preventDefault();
                    if (!postBtn.disabled) submitPost();
                }
            });
            
            // Hide autocomplete on blur (with delay for click)
            textarea.addEventListener('blur', () => {
                setTimeout(() => hideMentionAutocomplete(), 200);
            });
        }
        
        // ===== MENTION AUTOCOMPLETE =====
        function handleMentionInput(textarea) {
            const cursorPos = textarea.selectionStart;
            const text = textarea.value.substring(0, cursorPos);
            
            // Find @ before cursor
            const atIndex = text.lastIndexOf('@');
            
            if (atIndex === -1) {
                hideMentionAutocomplete();
                return;
            }
            
            // Check if @ is start of word (preceded by space, newline, or start of text)
            if (atIndex > 0 && !/\s/.test(text[atIndex - 1])) {
                hideMentionAutocomplete();
                return;
            }
            
            // Get the partial username after @
            const partialUsername = text.substring(atIndex + 1);
            
            // Don't show if there's a space after @ (completed mention)
            if (partialUsername.includes(' ') || partialUsername.includes('\n')) {
                hideMentionAutocomplete();
                return;
            }
            
            mentionStartPos = atIndex;
            
            // Debounce search
            clearTimeout(mentionSearchTimeout);
            mentionSearchTimeout = setTimeout(() => {
                searchMentions(partialUsername);
            }, 150);
        }
        
        async function searchMentions(query) {
            // Load contacts if not cached
            if (!contactsCache) {
                try {
                    const res = await fetch(`${API_URL}/contacts`, {
                        headers: authHeaders()
                    });
                    if (res.ok) {
                        const data = await res.json();
                        contactsCache = data.contacts || [];
                    }
                } catch (e) {
                    console.error('Failed to load contacts for mentions:', e);
                    contactsCache = [];
                }
            }
            
            // Filter contacts by query
            const queryLower = query.toLowerCase();
            const matches = contactsCache.filter(contact => {
                const displayName = contact.display_name || '';
                const email = contact.email || '';
                const username = email.split('@')[0];
                
                return displayName.toLowerCase().includes(queryLower) ||
                       username.toLowerCase().includes(queryLower);
            }).slice(0, 5); // Max 5 suggestions
            
            if (matches.length === 0) {
                hideMentionAutocomplete();
                return;
            }
            
            // Render autocomplete
            mentionSelectedIndex = 0;
            renderMentionAutocomplete(matches);
        }
        
        function renderMentionAutocomplete(contacts) {
            mentionAutocomplete.innerHTML = contacts.map((contact, index) => {
                const displayName = contact.display_name || contact.email?.split('@')[0] || 'User';
                const username = contact.email?.split('@')[0] || '';
                const initial = displayName[0].toUpperCase();
                
                return `
                    <div class="mention-item ${index === mentionSelectedIndex ? 'selected' : ''}"
                         data-username="${escapeHtml(username)}"
                         onclick="selectMention('${escapeHtml(username)}')">
                        <div class="mention-item-avatar">${initial}</div>
                        <div class="mention-item-info">
                            <span class="mention-item-name">${escapeHtml(displayName)}</span>
                            <span class="mention-item-username">@${escapeHtml(username)}</span>
                        </div>
                    </div>
                `;
            }).join('');
            
            // Position autocomplete below cursor
            const textarea = document.getElementById('post-content');
            mentionAutocomplete.style.top = (textarea.offsetTop + textarea.offsetHeight + 4) + 'px';
            mentionAutocomplete.style.left = '0';
            mentionAutocomplete.classList.add('visible');
        }
        
        function navigateMentionAutocomplete(direction) {
            const items = mentionAutocomplete.querySelectorAll('.mention-item');
            if (items.length === 0) return;
            
            items[mentionSelectedIndex]?.classList.remove('selected');
            mentionSelectedIndex = (mentionSelectedIndex + direction + items.length) % items.length;
            items[mentionSelectedIndex]?.classList.add('selected');
            items[mentionSelectedIndex]?.scrollIntoView({ block: 'nearest' });
        }
        
        function selectMentionItem() {
            const items = mentionAutocomplete.querySelectorAll('.mention-item');
            const selectedItem = items[mentionSelectedIndex];
            if (selectedItem) {
                const username = selectedItem.dataset.username;
                selectMention(username);
            }
        }
        
        function selectMention(username) {
            const textarea = document.getElementById('post-content');
            const cursorPos = textarea.selectionStart;
            const textBefore = textarea.value.substring(0, mentionStartPos);
            const textAfter = textarea.value.substring(cursorPos);
            
            // Insert the mention
            textarea.value = textBefore + '@' + username + ' ' + textAfter;
            
            // Move cursor after mention
            const newPos = mentionStartPos + username.length + 2;
            textarea.setSelectionRange(newPos, newPos);
            textarea.focus();
            
            // Trigger input event to update char count
            textarea.dispatchEvent(new Event('input'));
            
            hideMentionAutocomplete();
        }
        
        function hideMentionAutocomplete() {
            mentionAutocomplete.classList.remove('visible');
            mentionStartPos = -1;
        }
        
        // Current uploaded image URL (stored after upload)
        let currentImageUrl = null;
        
        function isValidUrl(string) {
            try {
                const url = new URL(string);
                return url.protocol === 'http:' || url.protocol === 'https:';
            } catch {
                return false;
            }
        }
        
        // ===== FILE UPLOAD =====
        function triggerFileUpload() {
            document.getElementById('file-input').click();
        }
        
        async function handleFileSelect(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            // Validate file type
            const validTypes = ['image/jpeg', 'image/png', 'image/gif', 'image/webp'];
            if (!validTypes.includes(file.type)) {
                showToast({ type: 'error', message: 'Format non supporté (JPEG, PNG, GIF, WebP)' });
                return;
            }
            
            // Validate file size (5MB)
            if (file.size > 5 * 1024 * 1024) {
                showToast({ type: 'error', message: 'Image trop grande (max 5 Mo)' });
                return;
            }
            
            // Show local preview immediately
            const reader = new FileReader();
            reader.onload = async (e) => {
                showImagePreview(e.target.result);
                
                // Upload to server
                await uploadImage(e.target.result, file.type);
            };
            reader.readAsDataURL(file);
        }
        
        async function uploadImage(base64Data, contentType) {
            const progress = document.getElementById('upload-progress');
            progress.style.display = 'block';
            
            try {
                const res = await fetch(`${API_URL}/upload-image`, {
                    method: 'POST',
                    headers: authHeaders(),
                    body: JSON.stringify({ 
                        image: base64Data, 
                        contentType 
                    })
                });
                
                const data = await res.json();
                
                if (!res.ok) throw new Error(data.error || 'Erreur upload');
                
                currentImageUrl = data.url;
                showToast({ type: 'success', message: '📷 Image prête !' });
                
            } catch (e) {
                console.error('Upload error:', e);
                showToast({ type: 'error', message: e.message });
                removeImage();
            } finally {
                progress.style.display = 'none';
            }
        }
        
        // ===== POLL COMPOSER =====
        let pollEnabled = false;
        const MAX_POLL_OPTIONS = 4;
        const MIN_POLL_OPTIONS = 2;
        
        function togglePollComposer() {
            const composer = document.getElementById('poll-composer');
            const btn = document.getElementById('poll-btn');
            
            pollEnabled = !pollEnabled;
            composer.classList.toggle('visible', pollEnabled);
            btn.classList.toggle('active', pollEnabled);
            
            if (pollEnabled) {
                // Focus first option
                const firstInput = composer.querySelector('input');
                if (firstInput) firstInput.focus();
            } else {
                // Clear poll options
                resetPollComposer();
            }
        }
        
        function resetPollComposer() {
            const list = document.getElementById('poll-options-list');
            list.innerHTML = `
                <div class="poll-option-input" data-index="0">
                    <label for="reset-poll-option-0" class="poll-option-number">1</label>
                    <input type="text" id="reset-poll-option-0" placeholder="Option 1" maxlength="100" onkeydown="handlePollOptionKeydown(event, 0)" aria-label="Première option du sondage">
                </div>
                <div class="poll-option-input" data-index="1">
                    <label for="reset-poll-option-1" class="poll-option-number">2</label>
                    <input type="text" id="reset-poll-option-1" placeholder="Option 2" maxlength="100" onkeydown="handlePollOptionKeydown(event, 1)" aria-label="Deuxième option du sondage">
                </div>
            `;
            document.getElementById('poll-add-option').disabled = false;
        }
        
        function addPollOption() {
            const list = document.getElementById('poll-options-list');
            const options = list.querySelectorAll('.poll-option-input');
            
            if (options.length >= MAX_POLL_OPTIONS) return;
            
            const index = options.length;
            const newOption = document.createElement('div');
            newOption.className = 'poll-option-input';
            newOption.dataset.index = index;
            newOption.innerHTML = `
                <label for="add-poll-option-${index}" class="poll-option-number">${index + 1}</label>
                <input type="text" id="add-poll-option-${index}" placeholder="Option ${index + 1}" maxlength="100" onkeydown="handlePollOptionKeydown(event, ${index})" aria-label="Option ${index + 1} du sondage">
                <button class="poll-remove-option" onclick="removePollOption(${index})" aria-label="Supprimer l'option ${index + 1}">×</button>
            `;
            list.appendChild(newOption);
            
            // Focus new input
            newOption.querySelector('input').focus();
            
            // Disable add button if max reached
            if (index + 1 >= MAX_POLL_OPTIONS) {
                document.getElementById('poll-add-option').disabled = true;
            }
        }
        
        function removePollOption(index) {
            const list = document.getElementById('poll-options-list');
            const options = list.querySelectorAll('.poll-option-input');
            
            if (options.length <= MIN_POLL_OPTIONS) return;
            
            const optionToRemove = list.querySelector(`[data-index="${index}"]`);
            if (optionToRemove) {
                optionToRemove.remove();
                
                // Re-index remaining options
                const remaining = list.querySelectorAll('.poll-option-input');
                remaining.forEach((opt, i) => {
                    opt.dataset.index = i;
                    opt.querySelector('.poll-option-number').textContent = i + 1;
                    opt.querySelector('input').placeholder = `Option ${i + 1}`;
                    opt.querySelector('input').setAttribute('onkeydown', `handlePollOptionKeydown(event, ${i})`);
                    const removeBtn = opt.querySelector('.poll-remove-option');
                    if (removeBtn) {
                        removeBtn.setAttribute('onclick', `removePollOption(${i})`);
                    }
                });
                
                // Re-enable add button
                document.getElementById('poll-add-option').disabled = false;
            }
        }
        
        function handlePollOptionKeydown(event, index) {
            if (event.key === 'Enter') {
                event.preventDefault();
                const list = document.getElementById('poll-options-list');
                const options = list.querySelectorAll('.poll-option-input');
                
                if (index < options.length - 1) {
                    // Focus next option
                    options[index + 1].querySelector('input').focus();
                } else if (options.length < MAX_POLL_OPTIONS) {
                    // Add new option
                    addPollOption();
                }
            }
        }
        
        function getPollOptions() {
            if (!pollEnabled) return null;
            
            const list = document.getElementById('poll-options-list');
            const inputs = list.querySelectorAll('input');
            const options = [];
            
            inputs.forEach(input => {
                const value = input.value.trim();
                if (value) options.push(value);
            });
            
            // Need at least 2 options
            if (options.length < MIN_POLL_OPTIONS) {
                return null;
            }
            
            return options;
        }
        
        // ===== POST SCHEDULING =====
        let schedulerEnabled = false;
        let scheduledDateTime = null; // ISO string of scheduled time
        
        function toggleScheduler() {
            const picker = document.getElementById('schedule-picker');
            const btn = document.getElementById('schedule-btn');
            
            schedulerEnabled = !schedulerEnabled;
            
            if (schedulerEnabled) {
                picker.classList.add('visible');
                btn.classList.add('active');
                
                // Set default date to tomorrow
                const tomorrow = new Date();
                tomorrow.setDate(tomorrow.getDate() + 1);
                document.getElementById('schedule-date').value = tomorrow.toISOString().split('T')[0];
                document.getElementById('schedule-date').min = new Date().toISOString().split('T')[0];
                
                // Update preview
                updateSchedulePreview();
                
                // Add event listeners
                document.getElementById('schedule-date').addEventListener('change', updateSchedulePreview);
                document.getElementById('schedule-time').addEventListener('change', updateSchedulePreview);
            } else {
                picker.classList.remove('visible');
                btn.classList.remove('active');
                scheduledDateTime = null;
                document.getElementById('scheduled-indicator').style.display = 'none';
            }
        }
        
        function updateSchedulePreview() {
            const dateInput = document.getElementById('schedule-date');
            const timeInput = document.getElementById('schedule-time');
            const preview = document.getElementById('schedule-preview');
            const confirmBtn = document.getElementById('schedule-confirm-btn');
            
            if (!dateInput.value || !timeInput.value) {
                preview.textContent = 'Sélectionne une date et une heure';
                preview.classList.remove('error');
                confirmBtn.disabled = true;
                return;
            }
            
            const scheduledDate = new Date(`${dateInput.value}T${timeInput.value}`);
            const now = new Date();
            const minDate = new Date(now.getTime() + 5 * 60 * 1000); // 5 min in future
            const maxDate = new Date(now.getTime() + 30 * 24 * 60 * 60 * 1000); // 30 days
            
            if (scheduledDate < minDate) {
                preview.textContent = '⚠️ La date doit être au moins 5 minutes dans le futur';
                preview.classList.add('error');
                confirmBtn.disabled = true;
                return;
            }
            
            if (scheduledDate > maxDate) {
                preview.textContent = '⚠️ La date ne peut pas dépasser 30 jours';
                preview.classList.add('error');
                confirmBtn.disabled = true;
                return;
            }
            
            // Format the date nicely
            const formatter = new Intl.DateTimeFormat('fr-FR', {
                weekday: 'long',
                day: 'numeric',
                month: 'long',
                hour: '2-digit',
                minute: '2-digit'
            });
            
            preview.textContent = `📅 ${formatter.format(scheduledDate)}`;
            preview.classList.remove('error');
            confirmBtn.disabled = false;
        }
        
        function confirmSchedule() {
            const dateInput = document.getElementById('schedule-date');
            const timeInput = document.getElementById('schedule-time');
            
            if (!dateInput.value || !timeInput.value) {
                showToast({ type: 'error', message: 'Sélectionne une date et une heure' });
                return;
            }
            
            scheduledDateTime = new Date(`${dateInput.value}T${timeInput.value}`).toISOString();
            
            // Hide the picker
            document.getElementById('schedule-picker').classList.remove('visible');
            
            // Show the indicator
            const indicator = document.getElementById('scheduled-indicator');
            const indicatorText = document.getElementById('scheduled-indicator-text');
            
            const formatter = new Intl.DateTimeFormat('fr-FR', {
                weekday: 'short',
                day: 'numeric',
                month: 'short',
                hour: '2-digit',
                minute: '2-digit'
            });
            
            indicatorText.textContent = `Programmé pour ${formatter.format(new Date(scheduledDateTime))}`;
            indicator.style.display = 'flex';
            
            // Update post button text
            const postBtn = document.getElementById('post-btn');
            postBtn.textContent = 'Programmer';
            
            showToast({ type: 'success', message: '🕐 Post programmé !' });
        }
        
        function cancelSchedule() {
            schedulerEnabled = false;
            scheduledDateTime = null;
            
            document.getElementById('schedule-picker').classList.remove('visible');
            document.getElementById('schedule-btn').classList.remove('active');
            document.getElementById('scheduled-indicator').style.display = 'none';
            
            // Reset post button text
            const postBtn = document.getElementById('post-btn');
            postBtn.textContent = 'Poster';
        }
        
        // ===== SCHEDULED POSTS MODAL =====
        let scheduledPosts = [];
        
        async function loadScheduledPostsCount() {
            try {
                const res = await fetch(`${API_URL}/posts?scheduled=true&limit=50`, {
                    headers: authHeaders()
                });
                
                if (!res.ok) return;
                
                const data = await res.json();
                scheduledPosts = data.posts || [];
                
                // Update count badge
                const countEl = document.getElementById('scheduled-count');
                if (scheduledPosts.length > 0) {
                    countEl.textContent = scheduledPosts.length;
                    countEl.style.display = 'flex';
                } else {
                    countEl.style.display = 'none';
                }
            } catch (e) {
                console.error('Failed to load scheduled posts count:', e);
            }
        }
        
        async function openScheduledPostsModal() {
            const modal = document.getElementById('scheduled-modal');
            const body = document.getElementById('scheduled-modal-body');
            
            modal.classList.add('open');
            body.innerHTML = '<div style="text-align: center; padding: 2rem; color: var(--color-text-muted);">Chargement...</div>';
            
            try {
                const res = await fetch(`${API_URL}/posts?scheduled=true&limit=50`, {
                    headers: authHeaders()
                });
                
                if (!res.ok) throw new Error('Erreur de chargement');
                
                const data = await res.json();
                scheduledPosts = data.posts || [];
                
                // Update count badge
                const countEl = document.getElementById('scheduled-count');
                if (scheduledPosts.length > 0) {
                    countEl.textContent = scheduledPosts.length;
                    countEl.style.display = 'flex';
                } else {
                    countEl.style.display = 'none';
                }
                
                renderScheduledPosts();
                
            } catch (e) {
                console.error('Error loading scheduled posts:', e);
                body.innerHTML = `<div style="text-align: center; padding: 2rem; color: var(--color-danger);">Erreur de chargement</div>`;
            }
        }
        
        function renderScheduledPosts() {
            const body = document.getElementById('scheduled-modal-body');
            
            if (scheduledPosts.length === 0) {
                body.innerHTML = `
                    <div class="scheduled-empty">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/>
                        </svg>
                        <p>Aucun post programmé</p>
                        <p style="font-size: 0.8rem; opacity: 0.7;">Utilise le bouton "Programmer" dans le composer pour planifier tes posts.</p>
                    </div>
                `;
                return;
            }
            
            const formatter = new Intl.DateTimeFormat('fr-FR', {
                weekday: 'long',
                day: 'numeric',
                month: 'long',
                hour: '2-digit',
                minute: '2-digit'
            });
            
            body.innerHTML = scheduledPosts.map(post => `
                <div class="scheduled-post-item" data-post-id="${post.id}">
                    <div class="scheduled-post-time">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/>
                        </svg>
                        ${formatter.format(new Date(post.scheduled_at))}
                    </div>
                    <div class="scheduled-post-content">${escapeHtml(post.content)}</div>
                    ${post.image_url ? `<img src="${escapeHtml(post.image_url)}" style="max-width: 100%; border-radius: 8px; margin-bottom: 0.75rem;" alt="Image du post">` : ''}
                    <div class="scheduled-post-actions">
                        <button class="scheduled-post-delete" onclick="deleteScheduledPost('${post.id}')">
                            🗑️ Supprimer
                        </button>
                    </div>
                </div>
            `).join('');
        }
        
        function closeScheduledModal(event) {
            if (event && event.target !== event.currentTarget) return;
            document.getElementById('scheduled-modal').classList.remove('open');
        }
        
        async function deleteScheduledPost(postId) {
            if (!confirm('Supprimer ce post programmé ?')) return;
            
            try {
                const res = await fetch(`${API_URL}/posts?id=${postId}`, {
                    method: 'DELETE',
                    headers: authHeaders()
                });
                
                if (!res.ok) {
                    const data = await res.json();
                    throw new Error(data.error || 'Erreur');
                }
                
                // Remove from list and re-render
                scheduledPosts = scheduledPosts.filter(p => p.id !== postId);
                renderScheduledPosts();
                
                // Update count badge
                const countEl = document.getElementById('scheduled-count');
                if (scheduledPosts.length > 0) {
                    countEl.textContent = scheduledPosts.length;
                    countEl.style.display = 'flex';
                } else {
                    countEl.style.display = 'none';
                }
                
                showToast({ type: 'success', message: 'Post programmé supprimé' });
                
            } catch (e) {
                showToast({ type: 'error', message: e.message });
            }
        }
        
        // ===== POLL VOTING =====
        let pollVotesCache = {}; // { postId: { votes: { optionIndex: count }, userVote: optionIndex|null, totalVotes: n } }
        
        async function votePoll(postId, optionIndex) {
            // Check if already voted
            const cached = pollVotesCache[postId];
            if (cached && cached.userVote !== null) {
                showToast({ type: 'error', message: 'Tu as déjà voté !' });
                return;
            }
            
            // Optimistic update
            if (!pollVotesCache[postId]) {
                pollVotesCache[postId] = { votes: {}, userVote: null, totalVotes: 0 };
            }
            pollVotesCache[postId].userVote = optionIndex;
            pollVotesCache[postId].votes[optionIndex] = (pollVotesCache[postId].votes[optionIndex] || 0) + 1;
            pollVotesCache[postId].totalVotes++;
            
            updatePollUI(postId);
            
            try {
                const res = await fetch(`${API_URL}/posts?action=vote`, {
                    method: 'PATCH',
                    headers: authHeaders(),
                    body: JSON.stringify({ post_id: postId, option_index: optionIndex })
                });
                
                const data = await res.json();
                
                if (!res.ok) {
                    throw new Error(data.error || 'Erreur de vote');
                }
                
                // Update with server data
                if (data.poll) {
                    pollVotesCache[postId] = data.poll;
                    updatePollUI(postId);
                }
                
                showToast({ type: 'success', message: '✓ Vote enregistré !' });
                
            } catch (e) {
                console.error('Vote error:', e);
                // Revert optimistic update
                pollVotesCache[postId].userVote = null;
                pollVotesCache[postId].votes[optionIndex] = Math.max(0, (pollVotesCache[postId].votes[optionIndex] || 1) - 1);
                pollVotesCache[postId].totalVotes = Math.max(0, pollVotesCache[postId].totalVotes - 1);
                updatePollUI(postId);
                showToast({ type: 'error', message: e.message });
            }
        }
        
        function updatePollUI(postId) {
            const pollEl = document.querySelector(`.post-poll[data-post-id="${postId}"]`);
            if (!pollEl) return;
            
            const cached = pollVotesCache[postId];
            if (!cached) return;
            
            const options = pollEl.querySelectorAll('.poll-option');
            const totalVotes = cached.totalVotes || 0;
            const hasVoted = cached.userVote !== null;
            
            options.forEach((opt, i) => {
                const voteCount = cached.votes[i] || 0;
                const percent = totalVotes > 0 ? Math.round((voteCount / totalVotes) * 100) : 0;
                const isSelected = cached.userVote === i;
                
                // Update classes
                opt.classList.toggle('selected', isSelected);
                opt.classList.toggle('disabled', hasVoted);
                opt.classList.toggle('voted', hasVoted);
                
                // Update bar width
                const bar = opt.querySelector('.poll-option-bar');
                if (bar) {
                    bar.style.width = hasVoted ? `${percent}%` : '0%';
                }
                
                // Update percent display
                const percentEl = opt.querySelector('.poll-option-percent');
                if (percentEl) {
                    percentEl.textContent = hasVoted ? `${percent}%` : '';
                }
                
                // Update check
                const check = opt.querySelector('.poll-option-check');
                if (check) {
                    check.innerHTML = isSelected ? '✓' : '';
                }
            });
            
            // Update vote count
            const countEl = pollEl.querySelector('.poll-vote-count');
            if (countEl) {
                countEl.innerHTML = `<span>👥</span> ${totalVotes} vote${totalVotes !== 1 ? 's' : ''}`;
            }
        }
        
        function renderPollHtml(post) {
            if (!post.poll_options || !Array.isArray(post.poll_options) || post.poll_options.length < 2) {
                return '';
            }
            
            // Initialize cache from post data
            if (!pollVotesCache[post.id]) {
                pollVotesCache[post.id] = {
                    votes: post.poll_votes || {},
                    userVote: post.user_poll_vote !== undefined ? post.user_poll_vote : null,
                    totalVotes: post.poll_total_votes || 0
                };
            }
            
            const cached = pollVotesCache[post.id];
            const hasVoted = cached.userVote !== null;
            const totalVotes = cached.totalVotes || 0;
            
            const optionsHtml = post.poll_options.map((option, index) => {
                const voteCount = cached.votes[index] || 0;
                const percent = totalVotes > 0 ? Math.round((voteCount / totalVotes) * 100) : 0;
                const isSelected = cached.userVote === index;
                
                return `
                    <div class="poll-option ${isSelected ? 'selected' : ''} ${hasVoted ? 'disabled voted' : ''}" 
                         onclick="${hasVoted ? '' : `votePoll('${post.id}', ${index})`}"
                         role="button"
                         aria-pressed="${isSelected}"
                         tabindex="0">
                        <div class="poll-option-bar" style="width: ${hasVoted ? percent : 0}%"></div>
                        <div class="poll-option-content">
                            <span class="poll-option-text">
                                <span class="poll-option-check">${isSelected ? '✓' : ''}</span>
                                ${escapeHtml(option)}
                            </span>
                            <span class="poll-option-percent">${hasVoted ? `${percent}%` : ''}</span>
                        </div>
                    </div>
                `;
            }).join('');
            
            return `
                <div class="post-poll" data-post-id="${post.id}">
                    <div class="poll-question">📊 Sondage</div>
                    <div class="poll-options">
                        ${optionsHtml}
                    </div>
                    <div class="poll-footer">
                        <span class="poll-vote-count">👥 ${totalVotes} vote${totalVotes !== 1 ? 's' : ''}</span>
                    </div>
                </div>
            `;
        }

        // ===== AI IMAGE GENERATION =====
        function toggleAIPrompt() {
            const container = document.getElementById('ai-prompt-container');
            const btn = document.getElementById('ai-image-btn');
            
            if (container.style.display === 'none') {
                container.style.display = 'block';
                btn.classList.add('active');
                document.getElementById('ai-prompt').focus();
            } else {
                container.style.display = 'none';
                btn.classList.remove('active');
                document.getElementById('ai-prompt').value = '';
            }
        }
        
        async function generateAIImage() {
            const prompt = document.getElementById('ai-prompt').value.trim();
            if (!prompt) {
                showToast({ type: 'error', message: 'Entre une description pour l\'image' });
                return;
            }
            
            const generateBtn = document.getElementById('generate-btn');
            generateBtn.disabled = true;
            generateBtn.textContent = '⏳...';
            
            try {
                const res = await fetch(`${API_URL}/upload-image`, {
                    method: 'POST',
                    headers: authHeaders(),
                    body: JSON.stringify({ 
                        action: 'generate',
                        prompt 
                    })
                });
                
                const data = await res.json();
                
                if (!res.ok) throw new Error(data.error || 'Erreur génération');
                
                currentImageUrl = data.url;
                showImagePreview(data.url);
                showToast({ type: 'success', message: '✨ Image générée !' });
                
                // Hide AI prompt after success
                document.getElementById('ai-prompt-container').style.display = 'none';
                document.getElementById('ai-image-btn').classList.remove('active');
                
            } catch (e) {
                console.error('AI generation error:', e);
                showToast({ type: 'error', message: e.message });
            } finally {
                generateBtn.disabled = false;
                generateBtn.textContent = '✨ Générer';
            }
        }
        
        function showImagePreview(url) {
            const preview = document.getElementById('image-preview');
            const img = document.getElementById('preview-img');
            img.src = url;
            img.onload = () => { preview.style.display = 'block'; };
            img.onerror = () => { preview.style.display = 'none'; };
        }
        
        function hideImagePreview() {
            document.getElementById('image-preview').style.display = 'none';
            document.getElementById('preview-img').src = '';
            currentImageUrl = null;
        }
        
        function removeImage() {
            hideImagePreview();
            document.getElementById('file-input').value = '';
            document.getElementById('ai-prompt').value = '';
        }

        // ===== GIF FUNCTIONS =====
        function toggleGifPicker() {
            if (window.CinqGiphy?.isOpen()) {
                window.CinqGiphy.closePicker();
                document.getElementById('gif-btn').classList.remove('active');
            } else {
                window.CinqGiphy?.openPicker((gif) => {
                    selectGif(gif);
                }, document.getElementById('gif-btn'));
                document.getElementById('gif-btn').classList.add('active');
            }
        }
        
        function selectGif(gif) {
            // Clear any existing image
            hideImagePreview();
            document.getElementById('file-input').value = '';
            
            // Store selected GIF
            selectedGif = gif;
            
            // Show GIF preview
            const preview = document.getElementById('gif-preview');
            const previewImg = document.getElementById('gif-preview-img');
            previewImg.src = gif.images.standard.url;
            preview.style.display = 'block';
            
            // Hide GIF button active state
            document.getElementById('gif-btn').classList.remove('active');
            
            showToast({ type: 'success', message: 'GIF ajouté !' });
        }
        
        function removeGif() {
            selectedGif = null;
            const preview = document.getElementById('gif-preview');
            const previewImg = document.getElementById('gif-preview-img');
            preview.style.display = 'none';
            previewImg.src = '';
        }

        // ===== SUBMIT POST =====
        async function submitPost() {
            const content = document.getElementById('post-content').value.trim();
            
            if (!content) return;
            
            // Validate poll if enabled
            const pollOptions = getPollOptions();
            if (pollEnabled && !pollOptions) {
                showToast({ type: 'error', message: 'Entre au moins 2 options pour le sondage' });
                return;
            }
            
            const postBtn = document.getElementById('post-btn');
            const isScheduled = !!scheduledDateTime;
            postBtn.disabled = true;
            postBtn.textContent = '...';
            
            try {
                const body = { content };
                if (selectedGif) {
                    // Use GIF URL as image (GIFs are sent as animated images)
                    body.image_url = selectedGif.images.original.url || selectedGif.images.standard.url;
                    body.is_gif = true;
                } else if (currentImageUrl) {
                    body.image_url = currentImageUrl;
                }
                if (pollOptions) {
                    body.poll_options = pollOptions;
                }
                // Add scheduled_at if scheduled
                if (scheduledDateTime) {
                    body.scheduled_at = scheduledDateTime;
                }
                
                const res = await fetch(`${API_URL}/posts`, {
                    method: 'POST',
                    headers: authHeaders(),
                    body: JSON.stringify(body)
                });
                
                const data = await res.json();
                
                if (!res.ok) throw new Error(data.error || 'Erreur lors de la publication');
                
                // Only add to list if not scheduled (scheduled posts don't appear immediately)
                if (!isScheduled) {
                    posts.unshift(data.post);
                    renderPosts(true); // true = new post added
                }
                
                // Reset composer
                document.getElementById('post-content').value = '';
                document.getElementById('char-count').textContent = '0/280';
                document.getElementById('file-input').value = '';
                document.getElementById('ai-prompt').value = '';
                document.getElementById('ai-prompt-container').style.display = 'none';
                document.getElementById('ai-image-btn').classList.remove('active');
                document.getElementById('upload-image-btn').classList.remove('active');
                hideImagePreview();
                removeGif(); // Reset GIF
                
                // Reset poll
                if (pollEnabled) {
                    pollEnabled = false;
                    document.getElementById('poll-composer').classList.remove('visible');
                    document.getElementById('poll-btn').classList.remove('active');
                    resetPollComposer();
                }
                
                // Reset scheduler
                if (schedulerEnabled || scheduledDateTime) {
                    cancelSchedule();
                }
                
                // Clear saved draft after successful post
                clearDraft();
                
                // Show appropriate success message
                if (isScheduled) {
                    const scheduleDate = new Date(data.post.scheduled_at);
                    const formatter = new Intl.DateTimeFormat('fr-FR', {
                        weekday: 'short',
                        day: 'numeric',
                        month: 'short',
                        hour: '2-digit',
                        minute: '2-digit'
                    });
                    showToast({ type: 'success', message: `🕐 Programmé pour ${formatter.format(scheduleDate)}` });
                } else if (window.CinqConfetti) {
                    // 🎉 Celebrate first post with confetti!
                    const wasFirstPost = await CinqConfetti.triggerFirstPostIfNeeded();
                    if (wasFirstPost) {
                        showToast({ type: 'success', message: '🎉 Premier post ! Bienvenue sur Cinq !' });
                    } else {
                        showToast({ type: 'success', message: 'Posté !' });
                    }
                } else {
                    showToast({ type: 'success', message: 'Posté !' });
                }
                
            } catch (e) {
                console.error('Submit error:', e);
                showToast({ type: 'error', message: e.message });
            } finally {
                postBtn.disabled = false;
                postBtn.textContent = scheduledDateTime ? 'Programmer' : 'Poster';
            }
        }

        // ===== PULL TO REFRESH =====
        function setupPullToRefresh() {
            const container = document.querySelector('.feed-container');
            const ptr = document.getElementById('pull-to-refresh');
            const ptrText = ptr.querySelector('.ptr-text');
            const ptrArrow = ptr.querySelector('.ptr-arrow');
            const ptrSpinner = ptr.querySelector('.ptr-spinner');
            
            // Touch events
            container.addEventListener('touchstart', (e) => {
                // Only trigger at top of page
                if (window.scrollY > 10 || isRefreshing) return;
                ptrStartY = e.touches[0].clientY;
                isPulling = true;
            }, { passive: true });
            
            container.addEventListener('touchmove', (e) => {
                if (!isPulling || isRefreshing) return;
                
                ptrCurrentY = e.touches[0].clientY;
                const pullDistance = ptrCurrentY - ptrStartY;
                
                // Only show if pulling down and at top
                if (pullDistance > 0 && window.scrollY <= 0) {
                    const progress = Math.min(pullDistance / PTR_THRESHOLD, 1);
                    
                    // Show indicator
                    ptr.classList.add('visible');
                    ptr.style.transform = `translateX(-50%) translateY(${Math.min(pullDistance * 0.5, 60)}px)`;
                    
                    // Update state
                    if (pullDistance >= PTR_THRESHOLD) {
                        ptr.classList.add('ready');
                        ptrText.textContent = 'Relâche pour rafraîchir';
                    } else {
                        ptr.classList.remove('ready');
                        ptrText.textContent = 'Tirer pour rafraîchir';
                    }
                }
            }, { passive: true });
            
            container.addEventListener('touchend', async () => {
                if (!isPulling) return;
                isPulling = false;
                
                const pullDistance = ptrCurrentY - ptrStartY;
                
                if (pullDistance >= PTR_THRESHOLD && !isRefreshing) {
                    // Trigger refresh
                    isRefreshing = true;
                    ptr.classList.add('refreshing');
                    ptrArrow.style.display = 'none';
                    ptrSpinner.style.display = 'block';
                    ptrText.textContent = 'Rafraîchissement...';
                    
                    try {
                        await refreshPosts();
                        showToast({ type: 'success', message: '✓ Feed mis à jour' });
                    } catch (e) {
                        showToast({ type: 'error', message: 'Erreur de rafraîchissement' });
                    }
                    
                    // Reset
                    setTimeout(() => {
                        ptr.classList.remove('visible', 'ready', 'refreshing');
                        ptr.style.transform = '';
                        ptrArrow.style.display = 'block';
                        ptrSpinner.style.display = 'none';
                        ptrText.textContent = 'Tirer pour rafraîchir';
                        isRefreshing = false;
                    }, 300);
                } else {
                    // Cancel
                    ptr.classList.remove('visible', 'ready');
                    ptr.style.transform = '';
                }
                
                ptrStartY = 0;
                ptrCurrentY = 0;
            }, { passive: true });
        }
        
        async function refreshPosts() {
            nextCursor = null;
            hasMorePosts = true;
            posts = [];
            
            // Remove end message if exists
            document.querySelector('.infinite-scroll-end')?.remove();
            
            await loadPosts();
        }

        // ===== INFINITE SCROLL =====
        function setupInfiniteScroll() {
            const sentinel = document.getElementById('scroll-sentinel');
            
            infiniteScrollObserver = new IntersectionObserver(
                (entries) => {
                    const entry = entries[0];
                    if (entry.isIntersecting && hasMorePosts && !isLoadingMore) {
                        loadMorePosts();
                    }
                },
                {
                    root: null,
                    rootMargin: '100px',
                    threshold: 0
                }
            );
            
            infiniteScrollObserver.observe(sentinel);
        }
        
        async function loadMorePosts() {
            if (isLoadingMore || !hasMorePosts || !nextCursor) return;
            
            isLoadingMore = true;
            
            // Show skeleton loaders
            const container = document.getElementById('posts-list');
            const loaderId = 'infinite-loader';
            
            // Remove any existing loader/end message
            document.getElementById(loaderId)?.remove();
            document.querySelector('.infinite-scroll-end')?.remove();
            
            // Add skeleton loaders
            const skeletonHtml = `
                <div id="${loaderId}" class="skeleton-loader-group" aria-label="Chargement de plus de posts">
                    <div class="skeleton-post loading-skeleton">
                        <div style="display: flex; gap: 0.75rem; margin-bottom: 0.75rem;">
                            <div class="skeleton skeleton-avatar"></div>
                            <div style="flex: 1;">
                                <div class="skeleton skeleton-title"></div>
                                <div class="skeleton skeleton-text"></div>
                            </div>
                        </div>
                        <div class="skeleton skeleton-body"></div>
                    </div>
                    <div class="skeleton-post loading-skeleton" style="animation-delay: 0.1s;">
                        <div style="display: flex; gap: 0.75rem; margin-bottom: 0.75rem;">
                            <div class="skeleton skeleton-avatar"></div>
                            <div style="flex: 1;">
                                <div class="skeleton skeleton-title" style="width: 50%;"></div>
                                <div class="skeleton skeleton-text" style="width: 35%;"></div>
                            </div>
                        </div>
                        <div class="skeleton skeleton-body" style="height: 45px;"></div>
                    </div>
                </div>
            `;
            container.insertAdjacentHTML('beforeend', skeletonHtml);
            
            try {
                // Cursor-based pagination: get posts older than cursor
                const res = await fetch(`${API_URL}/posts?cursor=${encodeURIComponent(nextCursor)}&limit=${pageSize}`, {
                    headers: authHeaders()
                });
                
                const data = await res.json();
                
                if (!res.ok) throw new Error(data.error || 'Erreur de chargement');
                
                const newPosts = data.posts || [];
                
                // Update cursor for next load
                nextCursor = data.nextCursor || null;
                hasMorePosts = data.hasMore !== false && nextCursor !== null;
                
                if (newPosts.length > 0) {
                    // Append new posts
                    const startIndex = posts.length;
                    posts = [...posts, ...newPosts];
                    
                    // Render only new posts with staggered animation
                    renderNewPosts(newPosts, startIndex);
                }
                
            } catch (e) {
                console.error('Load more error:', e);
                showToast({ type: 'error', message: 'Erreur de chargement' });
            } finally {
                isLoadingMore = false;
                
                // Remove skeleton loader
                document.getElementById(loaderId)?.remove();
                
                // Show end message if no more posts
                if (!hasMorePosts && !document.querySelector('.infinite-scroll-end')) {
                    const endMsg = document.createElement('div');
                    endMsg.className = 'infinite-scroll-end';
                    endMsg.innerHTML = `
                        <div style="opacity: 0; animation: post-fade-in 0.4s ease forwards;">
                            ✨ Tu as tout vu !
                        </div>
                    `;
                    container.appendChild(endMsg);
                }
            }
        }
        
        /**
         * Render only new posts (for infinite scroll) with staggered animation
         */
        function renderNewPosts(newPosts, startIndex) {
            const container = document.getElementById('posts-list');
            
            newPosts.forEach((post, i) => {
                const postHtml = renderPost(post, false, startIndex + i);
                container.insertAdjacentHTML('beforeend', postHtml);
            });
            
            // Setup lazy loading for new images
            requestAnimationFrame(() => {
                observeLazyImages();
                // Track post views for new posts
                observePostCards();
            });
            
            // Load reactions and bookmarks for new posts
            const postIds = newPosts.map(p => p.id);
            if (postIds.length > 0) {
                loadReactions(postIds);
                loadBookmarks(postIds);
            }
            
            // Process link previews for new posts
            newPosts.forEach(post => {
                if (URL_REGEX.test(post.content)) {
                    URL_REGEX.lastIndex = 0;
                    queuePreviewProcessing(post.id, post.content);
                }
            });
        }

        // ===== LAZY LOADING IMAGES =====
        let lazyLoadObserver = null;
        
        function setupLazyLoading() {
            lazyLoadObserver = new IntersectionObserver(
                (entries) => {
                    entries.forEach(entry => {
                        if (entry.isIntersecting) {
                            const img = entry.target;
                            const src = img.dataset.src;
                            
                            if (src) {
                                img.src = src;
                                img.onload = () => {
                                    img.classList.add('loaded');
                                    img.closest('.post-image')?.classList.add('loaded');
                                };
                                img.onerror = () => {
                                    img.closest('.post-image')?.classList.add('loaded');
                                };
                                lazyLoadObserver.unobserve(img);
                            }
                        }
                    });
                },
                {
                    root: null,
                    rootMargin: '50px',
                    threshold: 0
                }
            );
        }
        
        function observeLazyImages() {
            document.querySelectorAll('.post-image img[data-src]').forEach(img => {
                lazyLoadObserver.observe(img);
            });
        }

        // ===== LOAD POSTS =====
        async function loadPosts() {
            isInitialLoad = true;
            
            try {
                const res = await fetch(`${API_URL}/posts?limit=${pageSize}`, {
                    headers: authHeaders()
                });
                
                const data = await res.json();
                
                if (!res.ok) throw new Error(data.error || 'Erreur de chargement');
                
                posts = data.posts || [];
                nextCursor = data.nextCursor || null;
                hasMorePosts = data.hasMore !== false && nextCursor !== null;
                
                renderPosts();
                
            } catch (e) {
                console.error('Load error:', e);
                document.getElementById('posts-list').innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">😢</div>
                        <div class="empty-state-title">Erreur de chargement</div>
                        <div class="empty-state-text">${e.message}</div>
                    </div>
                `;
            } finally {
                isInitialLoad = false;
            }
        }

        // ===== RENDER POSTS =====
        function renderPosts(isNewPost = false) {
            const container = document.getElementById('posts-list');
            
            // Remove skeletons and end message
            document.querySelectorAll('.skeleton-post').forEach(el => el.remove());
            document.querySelector('.infinite-scroll-end')?.remove();
            
            if (posts.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">📭</div>
                        <div class="empty-state-title">Rien ici pour l'instant</div>
                        <div class="empty-state-text">
                            Sois le premier à poster quelque chose, ou ajoute des contacts pour voir leur feed !
                        </div>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = posts.map((post, index) => 
                renderPost(post, isNewPost && index === 0, index)
            ).join('');
            
            // Show end message if no more posts after initial load
            if (!hasMorePosts && posts.length > 0) {
                const endMsg = document.createElement('div');
                endMsg.className = 'infinite-scroll-end';
                endMsg.innerHTML = `
                    <div style="opacity: 0; animation: post-fade-in 0.4s ease 0.3s forwards;">
                        ✨ Tu as tout vu !
                    </div>
                `;
                container.appendChild(endMsg);
            }
            
            // Setup lazy loading for new images
            requestAnimationFrame(() => {
                observeLazyImages();
                // Track post views (Seen by feature)
                observePostCards();
            });
            
            // Load reactions and bookmarks for all posts
            const postIds = posts.map(p => p.id);
            if (postIds.length > 0) {
                loadReactions(postIds);
                loadBookmarks(postIds);
            }
            
            // Process link previews for posts with URLs
            requestAnimationFrame(() => {
                posts.forEach(post => {
                    if (URL_REGEX.test(post.content)) {
                        URL_REGEX.lastIndex = 0;
                        queuePreviewProcessing(post.id, post.content);
                    }
                });
            });
        }
        
        function renderPost(post, isNew = false, index = 0) {
            const author = post.author || {};
            const isOwn = post.user_id === user.id;
            const initial = (author.display_name || author.email || '?')[0].toUpperCase();
            const displayName = author.display_name || author.email?.split('@')[0] || 'Anonyme';
            
            // Check if post is scheduled (for future publication)
            const isScheduled = post.scheduled_at && new Date(post.scheduled_at) > new Date();
            const time = isScheduled ? formatScheduledTime(post.scheduled_at) : formatTime(post.created_at);
            
            // Lazy load images - detect if GIF
            const isGif = post.is_gif || (post.image_url && (post.image_url.includes('giphy.com') || post.image_url.endsWith('.gif')));
            const imageHtml = post.image_url ? `
                <div class="post-image ${isGif ? 'giphy-content-gif' : ''}" role="img" aria-label="${isGif ? 'GIF du post' : 'Image du post'}">
                    <img 
                        data-src="${escapeHtml(post.image_url)}" 
                        alt="${isGif ? 'GIF' : 'Image'} partagé par ${escapeHtml(displayName)}" 
                        onclick="openImageModal('${escapeHtml(post.image_url)}')"
                        loading="lazy"
                    >
                    ${isGif ? '<span class="giphy-badge">GIF</span>' : ''}
                </div>
            ` : '';
            
            // Poll
            const pollHtml = renderPollHtml(post);
            
            const menuHtml = isOwn ? `
                <button class="post-menu-btn" onclick="toggleMenu('${post.id}')" aria-label="Menu du post" aria-expanded="false" aria-haspopup="true">⋮</button>
                <div class="post-menu" id="menu-${post.id}" role="menu">
                    <button class="post-menu-item" onclick="deletePost('${post.id}')" role="menuitem">
                        🗑️ Supprimer
                    </button>
                </div>
            ` : '';
            
            const newPostClass = isNew ? 'new-post' : '';
            
            // Staggered animation delay for infinite scroll posts
            // Cap at 0.5s max delay for posts loaded via infinite scroll
            const animDelay = isInitialLoad 
                ? Math.min(index * 0.05, 0.3) 
                : Math.min((index % pageSize) * 0.08, 0.5);
            
            // Generate share URLs (using short /p/:id format for cleaner shares)
            const postUrl = `${window.location.origin}/p/${post.id}`;
            const shareText = post.content.substring(0, 100) + (post.content.length > 100 ? '...' : '');
            
            // Generate reactions HTML
            const reactionData = reactionsCache[post.id] || { counts: {}, userReactions: [] };
            const reactionsHtml = `
                <div class="post-reactions" data-post-id="${post.id}">
                    ${REACTION_EMOJIS.map(emoji => {
                        const count = reactionData.counts[emoji] || 0;
                        const isActive = reactionData.userReactions.includes(emoji);
                        return `
                            <button class="reaction-btn ${isActive ? 'active' : ''}" 
                                    onclick="toggleReaction('${post.id}', '${emoji}')"
                                    aria-label="Réagir avec ${emoji}"
                                    aria-pressed="${isActive}">
                                <span class="emoji">${emoji}</span>
                                <span class="count" id="count-${post.id}-${encodeURIComponent(emoji)}">${count > 0 ? count : ''}</span>
                            </button>
                        `;
                    }).join('')}
                </div>
            `;
            
            // Reply count and button
            const replyCount = post.reply_count || 0;
            const replyBtnText = replyCount > 0 ? `${replyCount} réponse${replyCount > 1 ? 's' : ''}` : 'Répondre';
            
            const shareHtml = `
                <div class="post-actions">
                    <button onclick="toggleReplies('${post.id}')" class="reply-toggle-btn" id="reply-btn-${post.id}" aria-label="Répondre au post" aria-expanded="false">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg>
                        <span id="reply-count-${post.id}">${replyBtnText}</span>
                    </button>
                    <a href="https://twitter.com/intent/tweet?text=${encodeURIComponent(shareText)}&url=${encodeURIComponent(postUrl)}" 
                       target="_blank" rel="noopener noreferrer" 
                       class="share-btn twitter" 
                       aria-label="Partager sur Twitter">
                        <svg viewBox="0 0 24 24" fill="currentColor"><path d="M18.244 2.25h3.308l-7.227 8.26 8.502 11.24H16.17l-5.214-6.817L4.99 21.75H1.68l7.73-8.835L1.254 2.25H8.08l4.713 6.231zm-1.161 17.52h1.833L7.084 4.126H5.117z"/></svg>
                        <span>Twitter</span>
                    </a>
                    <a href="https://wa.me/?text=${encodeURIComponent(shareText + ' ' + postUrl)}" 
                       target="_blank" rel="noopener noreferrer"
                       class="share-btn whatsapp"
                       aria-label="Partager sur WhatsApp">
                        <svg viewBox="0 0 24 24" fill="currentColor"><path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893a11.821 11.821 0 00-3.48-8.413z"/></svg>
                        <span>WhatsApp</span>
                    </a>
                    <button onclick="copyPostLink('${post.id}')" class="share-btn copy" id="copy-btn-${post.id}" aria-label="Copier le lien">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"/><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"/></svg>
                        <span id="copy-text-${post.id}">Copier</span>
                    </button>
                    <button onclick="toggleBookmark('${post.id}')" class="share-btn bookmark ${bookmarksCache[post.id] ? 'active' : ''}" id="bookmark-btn-${post.id}" aria-label="${bookmarksCache[post.id] ? 'Retirer des favoris' : 'Ajouter aux favoris'}" aria-pressed="${bookmarksCache[post.id] ? 'true' : 'false'}">
                        <svg viewBox="0 0 24 24" fill="${bookmarksCache[post.id] ? 'currentColor' : 'none'}" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M19 21l-7-5-7 5V5a2 2 0 0 1 2-2h10a2 2 0 0 1 2 2z"/></svg>
                        <span id="bookmark-text-${post.id}">${bookmarksCache[post.id] ? 'Enregistré' : 'Enregistrer'}</span>
                    </button>
                    <button onclick="toggleReadLater('${post.id}', this)" class="share-btn read-later ${isInReadLater(post.id) ? 'active' : ''}" id="readlater-btn-${post.id}" aria-label="${isInReadLater(post.id) ? 'Retirer de la liste de lecture' : 'Lire plus tard'}" aria-pressed="${isInReadLater(post.id) ? 'true' : 'false'}">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>
                        <span id="readlater-text-${post.id}">${isInReadLater(post.id) ? 'Dans la liste' : 'Plus tard'}</span>
                    </button>
                    <a href="/p/${post.id}" class="share-btn link" aria-label="Voir le post">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"/><polyline points="15 3 21 3 21 9"/><line x1="10" y1="14" x2="21" y2="3"/></svg>
                        <span>Lien</span>
                    </a>
                </div>
            `;
            
            // Replies section (will be populated dynamically)
            const repliesSectionHtml = `
                <div class="replies-section" id="replies-section-${post.id}">
                    <div class="replies-list" id="replies-list-${post.id}"></div>
                    <div class="reply-composer" id="reply-composer-${post.id}">
                        <div class="reply-composer-avatar">${(user.display_name || user.email || '?')[0].toUpperCase()}</div>
                        <div class="reply-composer-form">
                            <textarea 
                                class="reply-composer-input" 
                                id="reply-input-${post.id}" 
                                placeholder="Écrire une réponse..."
                                maxlength="280"
                            ></textarea>
                            <div class="reply-composer-actions">
                                <span class="char-count reply-char-count" id="reply-char-count-${post.id}">0/280</span>
                                <button class="reply-cancel-btn" onclick="toggleReplies('${post.id}')">Annuler</button>
                                <button class="reply-submit-btn" id="reply-submit-${post.id}" onclick="submitReply('${post.id}')" disabled>Répondre</button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            // Seen by section (only for own posts < 24h)
            let seenByHtml = '';
            if (isOwn && post.seen_by && post.seen_by.count > 0) {
                const viewers = post.seen_by.viewers || [];
                const totalCount = post.seen_by.count;
                const displayViewers = viewers.slice(0, 3);
                const remainingCount = totalCount - displayViewers.length;
                
                const avatarsHtml = displayViewers.map(v => {
                    const vInitial = (v.display_name || v.email || '?')[0].toUpperCase();
                    return `<div class="seen-by-avatar" title="${escapeHtml(v.display_name || v.email?.split('@')[0] || 'Anonyme')}">${vInitial}</div>`;
                }).join('');
                
                const moreAvatarHtml = remainingCount > 0 
                    ? `<div class="seen-by-avatar more">+${remainingCount}</div>` 
                    : '';
                
                const viewersText = totalCount === 1 
                    ? `Vu par ${displayViewers[0]?.display_name || displayViewers[0]?.email?.split('@')[0] || '1 personne'}`
                    : `Vu par ${totalCount} personnes`;
                
                seenByHtml = `
                    <div class="seen-by" onclick="openSeenByModal('${post.id}')" role="button" tabindex="0" aria-label="${viewersText}">
                        <div class="seen-by-icon">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/>
                                <circle cx="12" cy="12" r="3"/>
                            </svg>
                        </div>
                        <div class="seen-by-avatars">
                            ${moreAvatarHtml}
                            ${avatarsHtml}
                        </div>
                        <span class="seen-by-text">${viewersText}</span>
                    </div>
                `;
            }
            
            return `
                <article class="post-card ${newPostClass}" style="animation-delay: ${animDelay}s;" aria-label="Post de ${escapeHtml(displayName)}" data-post-id="${post.id}" data-is-own="${isOwn}">
                    <div class="post-header">
                        <div class="post-author">
                            <div class="post-avatar ${isOwn ? 'own' : ''}" aria-hidden="true">${initial}</div>
                            <div class="post-author-info">
                                <span class="post-author-name">
                                    ${escapeHtml(displayName)}
                                    ${isOwn ? '<span class="you-badge">(toi)</span>' : ''}
                                    ${isScheduled && isOwn ? '<span class="post-scheduled-badge"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>Programmé</span>' : ''}
                                </span>
                                <time class="post-time" datetime="${isScheduled ? post.scheduled_at : post.created_at}">${time}</time>
                            </div>
                        </div>
                        ${menuHtml}
                    </div>
                    <div class="post-content">${linkifyContent(renderMentions(parseMarkdown(escapeHtml(post.content)), false))}</div>
                    ${imageHtml}
                    ${pollHtml}
                    <div class="post-previews" data-post-id-preview="${post.id}"></div>
                    ${reactionsHtml}
                    ${seenByHtml}
                    ${shareHtml}
                    ${repliesSectionHtml}
                </article>
            `;
        }

        // ===== DELETE POST =====
        async function deletePost(postId) {
            if (!confirm('Supprimer ce post ?')) return;
            
            try {
                const res = await fetch(`${API_URL}/posts?id=${postId}`, {
                    method: 'DELETE',
                    headers: authHeaders()
                });
                
                if (!res.ok) {
                    const data = await res.json();
                    throw new Error(data.error || 'Erreur');
                }
                
                posts = posts.filter(p => p.id !== postId);
                renderPosts();
                showToast({ type: 'success', message: 'Post supprimé' });
                
            } catch (e) {
                showToast({ type: 'error', message: e.message });
            }
        }
        
        function toggleMenu(postId) {
            // Close other menus
            document.querySelectorAll('.post-menu.open').forEach(m => {
                if (m.id !== `menu-${postId}`) {
                    m.classList.remove('open');
                    m.previousElementSibling?.setAttribute('aria-expanded', 'false');
                }
            });
            
            const menu = document.getElementById(`menu-${postId}`);
            const btn = menu.previousElementSibling;
            const isOpen = menu.classList.toggle('open');
            btn?.setAttribute('aria-expanded', isOpen);
            
            // Close on outside click
            if (isOpen) {
                setTimeout(() => {
                    document.addEventListener('click', function closeMenu(e) {
                        if (!e.target.closest('.post-menu') && !e.target.closest('.post-menu-btn')) {
                            menu.classList.remove('open');
                            btn?.setAttribute('aria-expanded', 'false');
                            document.removeEventListener('click', closeMenu);
                        }
                    });
                }, 0);
            }
        }

        // ===== IMAGE MODAL =====
        function openImageModal(url) {
            event.stopPropagation();
            document.getElementById('modal-image').src = url;
            document.getElementById('image-modal').classList.add('open');
            document.body.style.overflow = 'hidden';
        }
        
        function closeImageModal() {
            document.getElementById('image-modal').classList.remove('open');
            document.body.style.overflow = '';
        }

        // ===== SEEN BY =====
        let currentSeenByPostId = null;
        let postViewsObserver = null;
        let viewedPostIds = new Set();
        let pendingViews = [];
        let viewsDebounceTimeout = null;
        
        async function openSeenByModal(postId) {
            currentSeenByPostId = postId;
            const modal = document.getElementById('seen-by-modal');
            const list = document.getElementById('seen-by-list');
            
            // Show modal with loading state
            list.innerHTML = `
                <div class="seen-by-empty">
                    <div class="spinner" style="width: 24px; height: 24px; border: 2px solid var(--color-border); border-top-color: var(--color-brand); border-radius: 50%; animation: spin 0.8s linear infinite; margin: 0 auto;"></div>
                    <div style="margin-top: 0.5rem;">Chargement...</div>
                </div>
            `;
            modal.classList.add('open');
            document.body.style.overflow = 'hidden';
            
            try {
                const res = await fetch(`${API_URL}/post-views?post_id=${postId}`, {
                    headers: authHeaders()
                });
                
                const data = await res.json();
                
                if (!res.ok) throw new Error(data.error || 'Erreur');
                
                if (data.expired) {
                    list.innerHTML = `
                        <div class="seen-by-empty">
                            <div class="seen-by-empty-icon">⏰</div>
                            <div>Les vues ne sont visibles que pour les posts de moins de 24h</div>
                        </div>
                    `;
                    return;
                }
                
                if (!data.viewers || data.viewers.length === 0) {
                    list.innerHTML = `
                        <div class="seen-by-empty">
                            <div class="seen-by-empty-icon">👀</div>
                            <div>Personne n'a encore vu ce post</div>
                        </div>
                    `;
                    return;
                }
                
                // Render viewers
                list.innerHTML = data.viewers.map(view => {
                    const viewer = view.viewer || {};
                    const initial = (viewer.display_name || viewer.email || '?')[0].toUpperCase();
                    const name = viewer.display_name || viewer.email?.split('@')[0] || 'Anonyme';
                    const viewedTime = formatTime(view.viewed_at);
                    
                    return `
                        <div class="seen-by-item">
                            <div class="seen-by-item-avatar">${initial}</div>
                            <div class="seen-by-item-info">
                                <div class="seen-by-item-name">${escapeHtml(name)}</div>
                                <div class="seen-by-item-time">Vu ${viewedTime}</div>
                            </div>
                        </div>
                    `;
                }).join('');
                
            } catch (e) {
                console.error('Load seen by error:', e);
                list.innerHTML = `
                    <div class="seen-by-empty">
                        <div class="seen-by-empty-icon">😢</div>
                        <div>${e.message}</div>
                    </div>
                `;
            }
        }
        
        function closeSeenByModal(event) {
            if (event && event.target !== event.currentTarget) return;
            
            const modal = document.getElementById('seen-by-modal');
            modal.classList.remove('open');
            document.body.style.overflow = '';
            currentSeenByPostId = null;
        }
        
        // Track post views when they become visible
        function setupPostViewsTracking() {
            postViewsObserver = new IntersectionObserver(
                (entries) => {
                    entries.forEach(entry => {
                        if (entry.isIntersecting) {
                            const postCard = entry.target;
                            const postId = postCard.dataset.postId;
                            const isOwn = postCard.dataset.isOwn === 'true';
                            
                            // Don't track views for own posts
                            if (isOwn || !postId || viewedPostIds.has(postId)) return;
                            
                            // Check if post is recent (<24h) - we'll let the API handle this
                            viewedPostIds.add(postId);
                            pendingViews.push(postId);
                            
                            // Debounce API calls
                            clearTimeout(viewsDebounceTimeout);
                            viewsDebounceTimeout = setTimeout(sendPendingViews, 2000);
                        }
                    });
                },
                {
                    root: null,
                    rootMargin: '0px',
                    threshold: 0.5 // At least 50% visible
                }
            );
        }
        
        function observePostCards() {
            document.querySelectorAll('.post-card[data-post-id]').forEach(card => {
                postViewsObserver?.observe(card);
            });
        }
        
        async function sendPendingViews() {
            if (pendingViews.length === 0) return;
            
            const postIdsToSend = [...pendingViews];
            pendingViews = [];
            
            try {
                await fetch(`${API_URL}/post-views`, {
                    method: 'POST',
                    headers: authHeaders(),
                    body: JSON.stringify({ post_ids: postIdsToSend })
                });
            } catch (e) {
                console.error('Send post views error:', e);
                // Re-add to pending on error (they'll be retried)
            }
        }
        
        // Send any pending views when user leaves page
        window.addEventListener('beforeunload', () => {
            if (pendingViews.length > 0) {
                // Use sendBeacon for reliable delivery
                const data = JSON.stringify({ post_ids: pendingViews });
                navigator.sendBeacon?.(`${API_URL}/post-views`, new Blob([data], { type: 'application/json' }));
            }
        });

        // ===== UTILS =====
        // formatTime(), escapeHtml(), and showToast() now provided by /js/shared.js
        
        /**
         * Format scheduled time for display
         * @param {string} isoDate - ISO date string of scheduled time
         * @returns {string} - Formatted scheduled time
         */
        function formatScheduledTime(isoDate) {
            const date = new Date(isoDate);
            const now = new Date();
            const diffMs = date - now;
            const diffDays = Math.floor(diffMs / (1000 * 60 * 60 * 24));
            
            const timeFormatter = new Intl.DateTimeFormat('fr-FR', {
                hour: '2-digit',
                minute: '2-digit'
            });
            
            const dateFormatter = new Intl.DateTimeFormat('fr-FR', {
                weekday: 'short',
                day: 'numeric',
                month: 'short'
            });
            
            if (diffDays === 0) {
                return `🕐 Aujourd'hui à ${timeFormatter.format(date)}`;
            } else if (diffDays === 1) {
                return `🕐 Demain à ${timeFormatter.format(date)}`;
            } else {
                return `🕐 ${dateFormatter.format(date)} à ${timeFormatter.format(date)}`;
            }
        }

        // ===== REACTIONS =====
        async function loadReactions(postIds) {
            if (!postIds || postIds.length === 0) return;
            
            try {
                const res = await fetch(`${API_URL}/reactions?post_ids=${postIds.join(',')}`, {
                    headers: authHeaders()
                });
                
                if (!res.ok) return;
                
                const data = await res.json();
                
                // Update cache
                if (data.reactions) {
                    Object.assign(reactionsCache, data.reactions);
                }
                
                // Update UI
                postIds.forEach(postId => {
                    updateReactionUI(postId);
                });
                
            } catch (e) {
                console.error('Load reactions error:', e);
            }
        }
        
        function updateReactionUI(postId) {
            const reactionData = reactionsCache[postId];
            if (!reactionData) return;
            
            REACTION_EMOJIS.forEach(emoji => {
                const count = reactionData.counts[emoji] || 0;
                const isActive = reactionData.userReactions.includes(emoji);
                
                // Update count display
                const countEl = document.getElementById(`count-${postId}-${encodeURIComponent(emoji)}`);
                if (countEl) {
                    countEl.textContent = count > 0 ? count : '';
                }
                
                // Update active state
                const container = document.querySelector(`.post-reactions[data-post-id="${postId}"]`);
                if (container) {
                    const btns = container.querySelectorAll('.reaction-btn');
                    btns.forEach(btn => {
                        if (btn.querySelector('.emoji')?.textContent === emoji) {
                            btn.classList.toggle('active', isActive);
                            btn.setAttribute('aria-pressed', isActive);
                        }
                    });
                }
            });
        }
        
        async function toggleReaction(postId, emoji) {
            const reactionData = reactionsCache[postId] || { counts: {}, userReactions: [] };
            const isActive = reactionData.userReactions.includes(emoji);
            
            // Find the button for animation
            const container = document.querySelector(`.post-reactions[data-post-id="${postId}"]`);
            let btn = null;
            if (container) {
                container.querySelectorAll('.reaction-btn').forEach(b => {
                    if (b.querySelector('.emoji')?.textContent === emoji) {
                        btn = b;
                    }
                });
            }
            
            // Optimistic update
            if (isActive) {
                // Remove reaction
                reactionData.userReactions = reactionData.userReactions.filter(e => e !== emoji);
                reactionData.counts[emoji] = Math.max(0, (reactionData.counts[emoji] || 1) - 1);
            } else {
                // Add reaction
                reactionData.userReactions.push(emoji);
                reactionData.counts[emoji] = (reactionData.counts[emoji] || 0) + 1;
                
                // Add animation
                if (btn) {
                    btn.classList.add('animating');
                    setTimeout(() => btn.classList.remove('animating'), 300);
                }
            }
            
            reactionsCache[postId] = reactionData;
            updateReactionUI(postId);
            
            // API call
            try {
                let res;
                if (isActive) {
                    // DELETE
                    res = await fetch(`${API_URL}/reactions?post_id=${postId}&emoji=${encodeURIComponent(emoji)}`, {
                        method: 'DELETE',
                        headers: authHeaders()
                    });
                } else {
                    // POST
                    res = await fetch(`${API_URL}/reactions`, {
                        method: 'POST',
                        headers: authHeaders(),
                        body: JSON.stringify({ post_id: postId, emoji })
                    });
                }
                
                const data = await res.json();
                
                if (!res.ok) {
                    throw new Error(data.error || 'Erreur réaction');
                }
                
                // Update with server counts
                if (data.counts) {
                    reactionData.counts = data.counts;
                    updateReactionUI(postId);
                }
                
            } catch (e) {
                console.error('Toggle reaction error:', e);
                // Revert optimistic update
                if (isActive) {
                    reactionData.userReactions.push(emoji);
                    reactionData.counts[emoji] = (reactionData.counts[emoji] || 0) + 1;
                } else {
                    reactionData.userReactions = reactionData.userReactions.filter(e => e !== emoji);
                    reactionData.counts[emoji] = Math.max(0, (reactionData.counts[emoji] || 1) - 1);
                }
                updateReactionUI(postId);
                showToast({ type: 'error', message: e.message });
            }
        }

        // ===== BOOKMARKS =====
        async function loadBookmarks(postIds) {
            if (!postIds || postIds.length === 0) return;
            
            try {
                const res = await fetch(`${API_URL}/bookmarks?post_ids=${postIds.join(',')}`, {
                    headers: authHeaders()
                });
                
                if (!res.ok) return;
                
                const data = await res.json();
                
                // Update cache
                if (data.bookmarks) {
                    Object.assign(bookmarksCache, data.bookmarks);
                }
                
                // Update UI
                postIds.forEach(postId => {
                    updateBookmarkUI(postId);
                });
                
            } catch (e) {
                console.error('Load bookmarks error:', e);
            }
        }
        
        function updateBookmarkUI(postId) {
            const isBookmarked = bookmarksCache[postId] || false;
            const btn = document.getElementById(`bookmark-btn-${postId}`);
            const text = document.getElementById(`bookmark-text-${postId}`);
            
            if (btn) {
                btn.classList.toggle('active', isBookmarked);
                btn.setAttribute('aria-pressed', isBookmarked);
                btn.setAttribute('aria-label', isBookmarked ? 'Retirer des favoris' : 'Ajouter aux favoris');
                
                // Update SVG fill
                const svg = btn.querySelector('svg');
                if (svg) {
                    svg.setAttribute('fill', isBookmarked ? 'currentColor' : 'none');
                }
            }
            
            if (text) {
                text.textContent = isBookmarked ? 'Enregistré' : 'Enregistrer';
            }
        }
        
        async function toggleBookmark(postId) {
            const isBookmarked = bookmarksCache[postId] || false;
            const btn = document.getElementById(`bookmark-btn-${postId}`);
            
            // Optimistic update
            bookmarksCache[postId] = !isBookmarked;
            updateBookmarkUI(postId);
            
            // Add animation
            if (btn && !isBookmarked) {
                btn.classList.add('animating');
                setTimeout(() => btn.classList.remove('animating'), 300);
            }
            
            // API call
            try {
                let res;
                if (isBookmarked) {
                    // DELETE
                    res = await fetch(`${API_URL}/bookmarks?post_id=${postId}`, {
                        method: 'DELETE',
                        headers: authHeaders()
                    });
                } else {
                    // POST
                    res = await fetch(`${API_URL}/bookmarks`, {
                        method: 'POST',
                        headers: authHeaders(),
                        body: JSON.stringify({ post_id: postId })
                    });
                }
                
                const data = await res.json();
                
                if (!res.ok) {
                    throw new Error(data.error || 'Erreur bookmark');
                }
                
                showToast({ 
                    type: 'success', 
                    message: isBookmarked ? '🔖 Retiré des favoris' : '🔖 Ajouté aux favoris' 
                });
                
            } catch (e) {
                console.error('Toggle bookmark error:', e);
                // Revert optimistic update
                bookmarksCache[postId] = isBookmarked;
                updateBookmarkUI(postId);
                showToast({ type: 'error', message: e.message });
            }
        }

        // ===== SHARE FUNCTIONS =====
        async function copyPostLink(postId) {
            const url = `${window.location.origin}/p/${postId}`;
            try {
                await navigator.clipboard.writeText(url);
                const btn = document.getElementById(`copy-btn-${postId}`);
                const text = document.getElementById(`copy-text-${postId}`);
                btn.classList.add('copied');
                text.textContent = 'Copié !';
                
                showToast({ type: 'success', message: '🔗 Lien copié !' });
                
                setTimeout(() => {
                    btn.classList.remove('copied');
                    text.textContent = 'Copier';
                }, 2000);
            } catch (e) {
                showToast({ type: 'error', message: 'Impossible de copier' });
            }
        }

        // ===== THREADS / REPLIES =====
        const repliesCache = {}; // { postId: { replies: [], loaded: false, hasMore: false, cursor: null } }
        
        /**
         * Toggle replies section visibility
         */
        async function toggleReplies(postId) {
            const section = document.getElementById(`replies-section-${postId}`);
            const btn = document.getElementById(`reply-btn-${postId}`);
            const input = document.getElementById(`reply-input-${postId}`);
            
            if (!section) return;
            
            const isOpen = section.classList.contains('open');
            
            if (isOpen) {
                // Close
                section.classList.remove('open');
                btn?.classList.remove('active');
                btn?.setAttribute('aria-expanded', 'false');
            } else {
                // Open
                section.classList.add('open');
                btn?.classList.add('active');
                btn?.setAttribute('aria-expanded', 'true');
                
                // Load replies if not already loaded
                if (!repliesCache[postId]?.loaded) {
                    await loadReplies(postId);
                }
                
                // Focus input
                setTimeout(() => input?.focus(), 100);
                
                // Setup input event listener for submit button state
                if (input && !input.hasAttribute('data-listener')) {
                    input.setAttribute('data-listener', 'true');
                    input.addEventListener('input', () => {
                        const submitBtn = document.getElementById(`reply-submit-${postId}`);
                        const charCount = document.getElementById(`reply-char-count-${postId}`);
                        const len = input.value.length;
                        
                        if (submitBtn) {
                            submitBtn.disabled = !input.value.trim() || len > 280;
                        }
                        
                        if (charCount) {
                            charCount.textContent = `${len}/280`;
                            charCount.classList.remove('warning', 'error');
                            if (len > 250) charCount.classList.add('error');
                            else if (len > 220) charCount.classList.add('warning');
                        }
                    });
                    input.addEventListener('keydown', (e) => {
                        if (e.key === 'Enter' && (e.ctrlKey || e.metaKey) && input.value.trim()) {
                            submitReply(postId);
                        }
                    });
                }
            }
        }
        
        /**
         * Load replies for a post
         */
        async function loadReplies(postId, loadMore = false) {
            const list = document.getElementById(`replies-list-${postId}`);
            if (!list) return;
            
            const cache = repliesCache[postId] || { replies: [], loaded: false, hasMore: false, cursor: null };
            
            // Show loading state
            if (!loadMore) {
                list.innerHTML = `
                    <div class="replies-loading">
                        <span class="spinner"></span>
                        Chargement des réponses...
                    </div>
                `;
            }
            
            try {
                let url = `${API_URL}/posts?parent_id=${postId}&limit=10`;
                if (loadMore && cache.cursor) {
                    url += `&cursor=${encodeURIComponent(cache.cursor)}`;
                }
                
                const res = await fetch(url, { headers: authHeaders() });
                const data = await res.json();
                
                if (!res.ok) throw new Error(data.error || 'Erreur de chargement');
                
                const newReplies = data.replies || [];
                
                // Update cache
                repliesCache[postId] = {
                    replies: loadMore ? [...cache.replies, ...newReplies] : newReplies,
                    loaded: true,
                    hasMore: data.hasMore || false,
                    cursor: data.nextCursor || null
                };
                
                // Render replies
                renderReplies(postId);
                
            } catch (e) {
                console.error('Load replies error:', e);
                if (!loadMore) {
                    list.innerHTML = `
                        <div class="replies-loading" style="color: var(--color-error);">
                            Erreur de chargement des réponses
                        </div>
                    `;
                }
            }
        }
        
        /**
         * Render replies for a post
         */
        function renderReplies(postId) {
            const list = document.getElementById(`replies-list-${postId}`);
            if (!list) return;
            
            const cache = repliesCache[postId];
            if (!cache || !cache.replies) {
                list.innerHTML = '';
                return;
            }
            
            if (cache.replies.length === 0) {
                list.innerHTML = '';
                return;
            }
            
            const repliesHtml = cache.replies.map((reply, index) => renderReply(reply, index)).join('');
            
            let viewMoreHtml = '';
            if (cache.hasMore) {
                viewMoreHtml = `
                    <button class="view-more-replies" onclick="loadReplies('${postId}', true)">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 5v14M5 12h14"/></svg>
                        Voir plus de réponses
                    </button>
                `;
            }
            
            list.innerHTML = repliesHtml + viewMoreHtml;
        }
        
        /**
         * Render a single reply
         */
        function renderReply(reply, index = 0) {
            const author = reply.author || {};
            const isOwn = reply.user_id === user.id;
            const initial = (author.display_name || author.email || '?')[0].toUpperCase();
            const displayName = author.display_name || author.email?.split('@')[0] || 'Anonyme';
            const time = formatTime(reply.created_at);
            
            const deleteBtn = isOwn ? `
                <button class="reply-delete-btn" onclick="deleteReply('${reply.id}', '${reply.parent_id}')" aria-label="Supprimer la réponse">×</button>
            ` : '';
            
            const imageHtml = reply.image_url ? `
                <div class="reply-image">
                    <img src="${escapeHtml(reply.image_url)}" alt="Image de la réponse" onclick="openImageModal('${escapeHtml(reply.image_url)}')" loading="lazy">
                </div>
            ` : '';
            
            return `
                <div class="reply-card" style="animation-delay: ${index * 0.05}s;" data-reply-id="${reply.id}">
                    ${deleteBtn}
                    <div class="reply-header">
                        <div class="reply-avatar ${isOwn ? 'own' : ''}">${initial}</div>
                        <span class="reply-author-name">
                            ${escapeHtml(displayName)}
                            ${isOwn ? '<span class="you-badge">(toi)</span>' : ''}
                        </span>
                        <time class="reply-time" datetime="${reply.created_at}">${time}</time>
                    </div>
                    <div class="reply-content">${linkifyContent(renderMentions(parseMarkdown(escapeHtml(reply.content)), false))}</div>
                    ${imageHtml}
                </div>
            `;
        }
        
        /**
         * Submit a reply to a post
         */
        async function submitReply(postId) {
            const input = document.getElementById(`reply-input-${postId}`);
            const submitBtn = document.getElementById(`reply-submit-${postId}`);
            
            if (!input) return;
            
            const content = input.value.trim();
            if (!content) return;
            
            // Disable button and show loading
            if (submitBtn) {
                submitBtn.disabled = true;
                submitBtn.textContent = '...';
            }
            
            try {
                const res = await fetch(`${API_URL}/posts`, {
                    method: 'POST',
                    headers: authHeaders(),
                    body: JSON.stringify({
                        content,
                        parent_id: postId
                    })
                });
                
                const data = await res.json();
                
                if (!res.ok) throw new Error(data.error || 'Erreur lors de la publication');
                
                // Add new reply to cache
                if (!repliesCache[postId]) {
                    repliesCache[postId] = { replies: [], loaded: true, hasMore: false, cursor: null };
                }
                repliesCache[postId].replies.push(data.post);
                
                // Re-render replies
                renderReplies(postId);
                
                // Clear input
                input.value = '';
                
                // Update reply count in button
                const post = posts.find(p => p.id === postId);
                if (post) {
                    post.reply_count = (post.reply_count || 0) + 1;
                    updateReplyCountUI(postId, post.reply_count);
                }
                
                showToast({ type: 'success', message: '✓ Réponse publiée !' });
                
            } catch (e) {
                console.error('Submit reply error:', e);
                showToast({ type: 'error', message: e.message });
            } finally {
                if (submitBtn) {
                    submitBtn.textContent = 'Répondre';
                    submitBtn.disabled = !input.value.trim();
                }
            }
        }
        
        /**
         * Delete a reply
         */
        async function deleteReply(replyId, parentId) {
            if (!confirm('Supprimer cette réponse ?')) return;
            
            try {
                const res = await fetch(`${API_URL}/posts?id=${replyId}`, {
                    method: 'DELETE',
                    headers: authHeaders()
                });
                
                if (!res.ok) {
                    const data = await res.json();
                    throw new Error(data.error || 'Erreur');
                }
                
                // Remove from cache
                if (repliesCache[parentId]) {
                    repliesCache[parentId].replies = repliesCache[parentId].replies.filter(r => r.id !== replyId);
                    renderReplies(parentId);
                }
                
                // Update reply count
                const post = posts.find(p => p.id === parentId);
                if (post && post.reply_count > 0) {
                    post.reply_count--;
                    updateReplyCountUI(parentId, post.reply_count);
                }
                
                showToast({ type: 'success', message: 'Réponse supprimée' });
                
            } catch (e) {
                showToast({ type: 'error', message: e.message });
            }
        }
        
        /**
         * Update the reply count display in the UI
         */
        function updateReplyCountUI(postId, count) {
            const countEl = document.getElementById(`reply-count-${postId}`);
            if (countEl) {
                countEl.textContent = count > 0 ? `${count} réponse${count > 1 ? 's' : ''}` : 'Répondre';
            }
        }

        // ===== KEYBOARD SHORTCUTS =====
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                closeImageModal();
                document.querySelectorAll('.post-menu.open').forEach(m => {
                    m.classList.remove('open');
                    m.previousElementSibling?.setAttribute('aria-expanded', 'false');
                });
                // Close any open replies section
                document.querySelectorAll('.replies-section.open').forEach(s => {
                    s.classList.remove('open');
                    const postId = s.id.replace('replies-section-', '');
                    const btn = document.getElementById(`reply-btn-${postId}`);
                    btn?.classList.remove('active');
                    btn?.setAttribute('aria-expanded', 'false');
                });
            }
        });

        // ===== LINKIFY CONTENT =====
        /**
         * Convert URLs and hashtags in text to clickable links
         */
        function linkifyContent(text) {
            if (!text) return text;
            
            // First: convert hashtags to links
            text = text.replace(
                /#([\w\u00C0-\u017F]{1,50})/g,
                (match, tag) => {
                    const normalizedTag = tag.toLowerCase();
                    return `<a href="/tag.html?t=${encodeURIComponent(normalizedTag)}" class="post-hashtag">#${tag}</a>`;
                }
            );
            
            // Then: convert URLs to links (but not already-linked content)
            text = text.replace(
                /(https?:\/\/[^\s<>"{}|\\^`\[\]]+)/gi,
                (url) => {
                    // Skip if already inside an href (from hashtag linking)
                    if (text.indexOf(`href="${url}"`) !== -1) return url;
                    
                    // Clean up trailing punctuation that shouldn't be part of URL
                    let cleanUrl = url;
                    const trailingPunct = /[.,;:!?)]+$/;
                    const match = cleanUrl.match(trailingPunct);
                    let trailing = '';
                    if (match) {
                        trailing = match[0];
                        cleanUrl = cleanUrl.slice(0, -trailing.length);
                    }
                    return `<a href="${cleanUrl}" target="_blank" rel="noopener noreferrer" class="post-link">${cleanUrl}</a>${trailing}`;
                }
            );
            
            return text;
        }
        
        // ===== RICH MEDIA PREVIEWS =====
        const previewCache = new Map();
        const PREVIEW_CACHE_TTL = 30 * 60 * 1000; // 30 minutes
        
        // URL detection regex
        const URL_REGEX = /https?:\/\/[^\s<>"{}|\\^`\[\]]+/gi;
        
        // Special embed patterns
        const YOUTUBE_PATTERN = /(?:youtube\.com\/(?:watch\?v=|embed\/|shorts\/)|youtu\.be\/)([a-zA-Z0-9_-]{11})/;
        const TWITTER_PATTERN = /(?:twitter\.com|x\.com)\/(?:\w+)\/status\/(\d+)/;
        const SPOTIFY_PATTERN = /open\.spotify\.com\/(track|album|playlist|episode)\/([a-zA-Z0-9]+)/;
        const GITHUB_PATTERN = /github\.com\/([^\/\s]+\/[^\/\s]+)/;
        
        /**
         * Extract URLs from text
         */
        function extractUrls(text) {
            const matches = text.match(URL_REGEX) || [];
            // Dedupe and limit to 3 URLs
            return [...new Set(matches)].slice(0, 3);
        }
        
        /**
         * Detect embed type for a URL
         */
        function detectEmbedType(url) {
            const ytMatch = url.match(YOUTUBE_PATTERN);
            if (ytMatch) return { type: 'youtube', videoId: ytMatch[1] };
            
            const twMatch = url.match(TWITTER_PATTERN);
            if (twMatch) return { type: 'twitter', tweetId: twMatch[1], url };
            
            const spotifyMatch = url.match(SPOTIFY_PATTERN);
            if (spotifyMatch) return { type: 'spotify', contentType: spotifyMatch[1], contentId: spotifyMatch[2] };
            
            const ghMatch = url.match(GITHUB_PATTERN);
            if (ghMatch) return { type: 'github', repo: ghMatch[1], url };
            
            return { type: 'link', url };
        }
        
        /**
         * Fetch Open Graph metadata for a URL
         */
        async function fetchUrlPreview(url) {
            // Check cache
            const cached = previewCache.get(url);
            if (cached && Date.now() - cached.timestamp < PREVIEW_CACHE_TTL) {
                return cached.data;
            }
            
            try {
                const res = await fetch(`${API_URL}/unfurl?url=${encodeURIComponent(url)}`, {
                    headers: authHeaders()
                });
                
                if (!res.ok) throw new Error('Fetch failed');
                
                const data = await res.json();
                
                // Cache result
                previewCache.set(url, { data, timestamp: Date.now() });
                
                return data;
            } catch (e) {
                console.error('Preview fetch error:', e);
                return null;
            }
        }
        
        /**
         * Generate YouTube embed HTML
         */
        function renderYouTubeEmbed(videoId, postId) {
            const thumbnailUrl = `https://img.youtube.com/vi/${videoId}/maxresdefault.jpg`;
            const fallbackUrl = `https://img.youtube.com/vi/${videoId}/hqdefault.jpg`;
            
            return `
                <div class="youtube-embed" data-video-id="${videoId}">
                    <div class="youtube-thumbnail" onclick="loadYouTubePlayer(this, '${videoId}')">
                        <img src="${thumbnailUrl}" 
                             onerror="this.src='${fallbackUrl}'" 
                             alt="Vidéo YouTube"
                             loading="lazy">
                        <div class="youtube-play-btn" aria-label="Lire la vidéo"></div>
                    </div>
                    <div class="youtube-info">
                        <div class="youtube-info-provider">
                            <svg width="12" height="12" viewBox="0 0 24 24" fill="#ff0000"><path d="M23.498 6.186a3.016 3.016 0 0 0-2.122-2.136C19.505 3.545 12 3.545 12 3.545s-7.505 0-9.377.505A3.017 3.017 0 0 0 .502 6.186C0 8.07 0 12 0 12s0 3.93.502 5.814a3.016 3.016 0 0 0 2.122 2.136c1.871.505 9.376.505 9.376.505s7.505 0 9.377-.505a3.015 3.015 0 0 0 2.122-2.136C24 15.93 24 12 24 12s0-3.93-.502-5.814z"/><path fill="#fff" d="M9.545 15.568V8.432L15.818 12l-6.273 3.568z"/></svg>
                            YouTube
                        </div>
                    </div>
                </div>
            `;
        }
        
        /**
         * Load YouTube iframe player (lazy load on click)
         */
        function loadYouTubePlayer(element, videoId) {
            const container = element.parentElement;
            container.innerHTML = `
                <div class="youtube-embed-container">
                    <iframe 
                        src="https://www.youtube.com/embed/${videoId}?autoplay=1&rel=0" 
                        allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" 
                        allowfullscreen
                        title="Vidéo YouTube">
                    </iframe>
                </div>
            `;
        }
        
        /**
         * Generate Twitter/X embed HTML
         */
        function renderTwitterEmbed(tweetId, url) {
            return `
                <div class="twitter-embed" data-tweet-id="${tweetId}">
                    <div class="twitter-embed-fallback">
                        <div class="x-logo">
                            <svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor"><path d="M18.244 2.25h3.308l-7.227 8.26 8.502 11.24H16.17l-5.214-6.817L4.99 21.75H1.68l7.73-8.835L1.254 2.25H8.08l4.713 6.231zm-1.161 17.52h1.833L7.084 4.126H5.117z"/></svg>
                        </div>
                        <div class="tweet-link">
                            <a href="${escapeHtml(url)}" target="_blank" rel="noopener noreferrer">
                                Voir le post sur X (Twitter) →
                            </a>
                        </div>
                    </div>
                </div>
            `;
        }
        
        /**
         * Generate Spotify embed HTML
         */
        function renderSpotifyEmbed(contentType, contentId) {
            const isLarge = contentType === 'album' || contentType === 'playlist';
            return `
                <div class="spotify-embed ${isLarge ? 'large' : ''}">
                    <iframe 
                        src="https://open.spotify.com/embed/${contentType}/${contentId}?theme=0" 
                        allow="encrypted-media"
                        loading="lazy"
                        title="Spotify ${contentType}">
                    </iframe>
                </div>
            `;
        }
        
        /**
         * Generate GitHub preview HTML
         */
        function renderGitHubPreview(repo, url, ogData) {
            const description = ogData?.description || 'Voir ce repository sur GitHub';
            return `
                <div class="github-preview">
                    <a href="${escapeHtml(url)}" target="_blank" rel="noopener noreferrer">
                        <div class="gh-logo">
                            <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor"><path d="M12 0c-6.626 0-12 5.373-12 12 0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576 4.765-1.589 8.199-6.086 8.199-11.386 0-6.627-5.373-12-12-12z"/></svg>
                        </div>
                        <div class="gh-info">
                            <div class="gh-repo">${escapeHtml(repo)}</div>
                            <div class="gh-desc">${escapeHtml(description)}</div>
                        </div>
                    </a>
                </div>
            `;
        }
        
        /**
         * Generate Open Graph link preview HTML
         */
        function renderLinkPreview(data) {
            if (!data || data.error) return '';
            
            const hasImage = data.image && !data.image.includes('undefined');
            
            if (!hasImage && !data.title) return '';
            
            const faviconHtml = data.favicon 
                ? `<img src="${escapeHtml(data.favicon)}" alt="" onerror="this.style.display='none'">`
                : '';
            
            const imageHtml = hasImage 
                ? `<img class="link-preview-image" src="${escapeHtml(data.image)}" alt="" loading="lazy" onerror="this.style.display='none'">`
                : '';
            
            const descHtml = data.description 
                ? `<div class="link-preview-description">${escapeHtml(data.description)}</div>`
                : '';
            
            return `
                <div class="link-preview ${!hasImage ? 'compact' : ''}">
                    <a href="${escapeHtml(data.url)}" target="_blank" rel="noopener noreferrer">
                        <div class="link-preview-content">
                            ${!hasImage ? `<div class="link-preview-icon">🔗</div>` : ''}
                            ${imageHtml}
                            <div class="link-preview-body">
                                <div class="link-preview-site">
                                    ${faviconHtml}
                                    <span>${escapeHtml(data.siteName || new URL(data.url).hostname)}</span>
                                </div>
                                <div class="link-preview-title">${escapeHtml(data.title || data.url)}</div>
                                ${descHtml}
                            </div>
                        </div>
                    </a>
                </div>
            `;
        }
        
        /**
         * Generate preview HTML for a single URL
         */
        async function generatePreviewHtml(url) {
            const embed = detectEmbedType(url);
            
            switch (embed.type) {
                case 'youtube':
                    return renderYouTubeEmbed(embed.videoId);
                    
                case 'twitter':
                    return renderTwitterEmbed(embed.tweetId, embed.url);
                    
                case 'spotify':
                    return renderSpotifyEmbed(embed.contentType, embed.contentId);
                    
                case 'github':
                    const ghData = await fetchUrlPreview(url);
                    return renderGitHubPreview(embed.repo, embed.url, ghData);
                    
                case 'link':
                default:
                    const ogData = await fetchUrlPreview(url);
                    return renderLinkPreview(ogData);
            }
        }
        
        /**
         * Process post content and add rich previews
         * Called after post is rendered
         */
        async function processPostPreviews(postId, content) {
            const urls = extractUrls(content);
            if (urls.length === 0) return;
            
            // Find the post element
            const postEl = document.querySelector(`[data-post-id-preview="${postId}"]`);
            if (!postEl) return;
            
            // Create container for previews
            const previewContainer = document.createElement('div');
            previewContainer.className = 'link-previews';
            previewContainer.innerHTML = `
                <div class="link-preview-loading">
                    <span class="spinner"></span>
                    Chargement des aperçus...
                </div>
            `;
            postEl.appendChild(previewContainer);
            
            // Generate all previews
            const previews = await Promise.all(urls.map(url => generatePreviewHtml(url)));
            
            // Replace loading with actual previews
            const validPreviews = previews.filter(p => p && p.trim());
            if (validPreviews.length > 0) {
                previewContainer.innerHTML = validPreviews.join('');
            } else {
                previewContainer.remove();
            }
        }
        
        /**
         * Queue for processing post previews (avoid overwhelming the API)
         */
        const previewQueue = [];
        let isProcessingPreviews = false;
        
        function queuePreviewProcessing(postId, content) {
            previewQueue.push({ postId, content });
            processPreviewQueue();
        }
        
        async function processPreviewQueue() {
            if (isProcessingPreviews || previewQueue.length === 0) return;
            
            isProcessingPreviews = true;
            
            while (previewQueue.length > 0) {
                const { postId, content } = previewQueue.shift();
                await processPostPreviews(postId, content);
                // Small delay between processing
                await new Promise(r => setTimeout(r, 100));
            }
            
            isProcessingPreviews = false;
        }

        // Init
        init();
    </script>
    
    <!-- Quick Actions (Long Press Context Menu) -->
    <script src="/js/quick-actions.min.js" defer></script>
    
    <!-- User Profile Module -->
    <script src="/js/user-profile.js"></script>
    
    <!-- Quick Profile Edit -->
    <script src="/js/quick-profile-edit.js" defer></script>
    
    <!-- Easter Eggs 🥚 -->
    <script src="/js/easter-eggs.min.js" defer></script>
    <!-- View Transitions -->
    <script defer src="/js/view-transitions.min.js"></script>
    
    <!-- Quick Share: Paste images from clipboard -->
    <script src="/js/quick-share.js" defer></script>
</body>
</html>
