<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>Cinq ‚Äî Feed</title>
    
    <!-- SEO -->
    <meta name="description" content="Cinq ‚Äî Le feed de tes 5 proches. Aucun algorithme, juste les messages des personnes qui comptent.">
    <meta name="robots" content="noindex, nofollow">
    
    <!-- Canonical -->
    <link rel="canonical" href="https://cinq.app/feed">
    
    <!-- Open Graph -->
    <meta property="og:title" content="Feed ‚Äî Cinq">
    <meta property="og:description" content="Le feed de tes 5 proches sur Cinq.">
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://cinq.app/feed">
    <meta property="og:image" content="https://cinq.app/og-image.png">
    <meta property="og:site_name" content="Cinq">
    <meta property="og:locale" content="fr_FR">
    
    <!-- Favicon -->
    <link rel="icon" type="image/svg+xml" href="/favicon.svg">
    <link rel="apple-touch-icon" sizes="180x180" href="/assets/icons/icon-192x192.png">
    <meta name="theme-color" content="#121218">
    
    <!-- PWA -->
    <link rel="manifest" href="/manifest.json">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Cinq">
    
    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;500;600;700&family=Inter:wght@400;500;600&display=swap" media="print" onload="this.media='all'">
    <noscript><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;500;600;700&family=Inter:wght@400;500;600&display=swap"></noscript>
    
    <!-- Critical CSS (for fastest FCP) -->
    <link rel="stylesheet" href="/css/critical.min.css">
    
    <!-- Design System -->
    <link rel="preload" href="/design/styles.min.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
    <noscript><link rel="stylesheet" href="/design/styles.min.css"></noscript>
    <link rel="stylesheet" href="/css/a11y.min.css">
    <link rel="stylesheet" href="/css/mobile-responsive.min.css">
    
    <!-- Theme CSS for smooth transitions -->
    <link rel="stylesheet" href="/css/theme.css">
    
    <!-- Theme initialization (before body to prevent flash) -->
    <script src="/js/theme.js"></script>
    
    <!-- Shared utilities -->
    <script src="/js/shared.js"></script>
    
    <style>
        /* ===== FEED LAYOUT ===== */
        .feed-container {
            min-height: 100vh;
            min-height: 100dvh;
            padding: 1rem;
            max-width: 600px;
            margin: 0 auto;
            padding-bottom: calc(80px + env(safe-area-inset-bottom, 1rem));
            /* Optimize for scroll performance */
            will-change: scroll-position;
            -webkit-overflow-scrolling: touch;
        }
        
        .feed-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem 0;
            border-bottom: 1px solid var(--color-border);
            margin-bottom: 1.5rem;
            position: sticky;
            top: 0;
            background: var(--color-bg-primary);
            z-index: 100;
        }
        
        .feed-logo {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--color-brand);
            text-decoration: none;
        }
        
        .feed-title {
            font-size: 1.25rem;
            font-weight: 600;
            background: linear-gradient(135deg, var(--color-brand) 0%, #a855f7 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        .header-actions {
            display: flex;
            gap: 0.75rem;
            align-items: center;
        }
        
        .back-btn {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 1rem;
            background: var(--color-bg-secondary);
            border: 1px solid var(--color-border);
            border-radius: var(--radius-lg);
            color: var(--color-text-muted);
            text-decoration: none;
            font-size: 0.875rem;
            transition: all 0.2s;
        }
        
        .back-btn:hover {
            background: var(--color-bg-hover);
            color: var(--color-text-primary);
        }
        
        /* Theme toggle */
        .theme-toggle {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 36px;
            height: 36px;
            background: var(--color-bg-secondary);
            border: 1px solid var(--color-border);
            border-radius: 50%;
            cursor: pointer;
            transition: all 0.2s ease;
            overflow: hidden;
            position: relative;
        }
        .theme-toggle:hover {
            background: var(--color-bg-hover);
            transform: scale(1.05);
        }
        .theme-toggle .icon-sun,
        .theme-toggle .icon-moon {
            position: absolute;
            transition: all 0.3s ease;
            color: var(--color-text-secondary);
        }
        .theme-toggle .icon-sun {
            opacity: 1;
            transform: rotate(0) scale(1);
        }
        .theme-toggle .icon-moon {
            opacity: 0;
            transform: rotate(-90deg) scale(0.5);
        }
        [data-theme="light"] .theme-toggle .icon-sun {
            opacity: 0;
            transform: rotate(90deg) scale(0.5);
        }
        [data-theme="light"] .theme-toggle .icon-moon {
            opacity: 1;
            transform: rotate(0) scale(1);
        }

        /* ===== PULL TO REFRESH ===== */
        .pull-to-refresh {
            position: fixed;
            top: 0;
            left: 50%;
            transform: translateX(-50%) translateY(-100%);
            z-index: 200;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            padding: 0.75rem 1.25rem;
            background: var(--color-bg-secondary);
            border: 1px solid var(--color-border);
            border-radius: 0 0 var(--radius-xl) var(--radius-xl);
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            font-size: 0.875rem;
            color: var(--color-text-secondary);
        }
        
        .pull-to-refresh.visible {
            transform: translateX(-50%) translateY(0);
        }
        
        .pull-to-refresh.refreshing .ptr-spinner {
            animation: spin 0.8s linear infinite;
        }
        
        .ptr-spinner {
            width: 18px;
            height: 18px;
            transition: transform 0.2s;
        }
        
        .ptr-arrow {
            transition: transform 0.2s;
        }
        
        .pull-to-refresh.ready .ptr-arrow {
            transform: rotate(180deg);
        }

        /* ===== COMPOSER ===== */
        .composer {
            background: var(--color-bg-secondary);
            border: 1px solid var(--color-border);
            border-radius: var(--radius-xl);
            padding: 1rem;
            margin-bottom: 1.5rem;
        }
        
        .composer-header {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            margin-bottom: 0.75rem;
        }
        
        .composer-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--color-brand) 0%, #a855f7 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1rem;
            color: white;
            font-weight: 600;
        }
        
        .composer-user {
            font-weight: 600;
            font-size: 0.9rem;
        }
        
        .composer-textarea {
            width: 100%;
            min-height: 80px;
            padding: 0.75rem;
            background: var(--color-bg-elevated);
            border: 1px solid var(--color-border);
            border-radius: var(--radius-lg);
            color: var(--color-text-primary);
            font-size: 1rem;
            font-family: inherit;
            resize: vertical;
            transition: border-color 0.2s, box-shadow 0.2s;
        }
        
        .composer-textarea:focus {
            outline: none;
            border-color: var(--color-brand);
            box-shadow: 0 0 0 3px var(--color-brand-muted);
        }
        
        .composer-textarea::placeholder {
            color: var(--color-text-muted);
        }
        
        .composer-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 0.75rem;
        }
        
        .composer-actions {
            display: flex;
            gap: 0.5rem;
        }
        
        .composer-btn {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 0.75rem;
            background: var(--color-bg-elevated);
            border: 1px solid var(--color-border);
            border-radius: var(--radius-md);
            color: var(--color-text-muted);
            cursor: pointer;
            font-size: 0.875rem;
            transition: all 0.2s;
        }
        
        .composer-btn:hover {
            background: var(--color-bg-hover);
            color: var(--color-text-primary);
            border-color: var(--color-border-active);
        }
        
        .composer-btn.active {
            background: var(--color-brand-muted);
            border-color: var(--color-brand);
            color: var(--color-brand);
        }
        
        .char-count {
            font-size: 0.75rem;
            color: var(--color-text-muted);
        }
        
        .char-count.warning {
            color: var(--color-warning);
        }
        
        .char-count.error {
            color: var(--color-error);
        }
        
        .post-btn {
            padding: 0.625rem 1.25rem;
            background: linear-gradient(135deg, var(--color-brand) 0%, #a855f7 100%);
            border: none;
            border-radius: var(--radius-lg);
            color: white;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .post-btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 4px 20px rgba(99, 102, 241, 0.4);
        }
        
        .post-btn:active:not(:disabled) {
            transform: translateY(0) scale(0.98);
        }
        
        .post-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        /* Image preview */
        .image-preview {
            position: relative;
            margin-top: 0.75rem;
            border-radius: var(--radius-lg);
            overflow: hidden;
        }
        
        .image-preview img {
            width: 100%;
            max-height: 300px;
            object-fit: cover;
            border-radius: var(--radius-lg);
        }
        
        .image-preview-remove {
            position: absolute;
            top: 0.5rem;
            right: 0.5rem;
            width: 28px;
            height: 28px;
            background: rgba(0, 0, 0, 0.7);
            border: none;
            border-radius: 50%;
            color: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1rem;
            transition: all 0.2s;
        }
        
        .image-preview-remove:hover {
            background: var(--color-error);
        }
        
        .image-url-input {
            width: 100%;
            padding: 0.5rem 0.75rem;
            background: var(--color-bg-elevated);
            border: 1px solid var(--color-border);
            border-radius: var(--radius-md);
            color: var(--color-text-primary);
            font-size: 0.875rem;
            margin-top: 0.5rem;
        }
        
        .image-url-input:focus {
            outline: none;
            border-color: var(--color-brand);
        }

        /* ===== POSTS LIST ===== */
        .posts-list {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }
        
        /* ===== POST CARD ANIMATIONS ===== */
        .post-card {
            background: var(--color-bg-secondary);
            border: 1px solid var(--color-border);
            border-radius: var(--radius-xl);
            padding: 1rem;
            transition: border-color 0.2s, box-shadow 0.2s;
            /* Animation on appear */
            opacity: 0;
            transform: translateY(20px) scale(0.98);
            animation: post-fade-in 0.5s cubic-bezier(0.22, 1, 0.36, 1) forwards;
            /* Optimize rendering */
            will-change: opacity, transform;
            contain: layout style paint;
        }
        
        @keyframes post-fade-in {
            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }
        
        /* New post animation (from top) */
        .post-card.new-post {
            animation: post-slide-in 0.6s cubic-bezier(0.34, 1.56, 0.64, 1) forwards;
        }
        
        @keyframes post-slide-in {
            0% {
                opacity: 0;
                transform: translateY(-40px) scale(0.9);
            }
            50% {
                opacity: 1;
            }
            100% {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }
        
        /* Subtle hover effect */
        .post-card:hover {
            border-color: var(--color-border-active);
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
        }
        
        .post-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 0.75rem;
            position: relative;
        }
        
        .post-author {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }
        
        .post-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--color-brand) 0%, #a855f7 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1rem;
            color: white;
            font-weight: 600;
        }
        
        .post-avatar.own {
            background: linear-gradient(135deg, #22c55e 0%, #16a34a 100%);
        }
        
        .post-author-info {
            display: flex;
            flex-direction: column;
        }
        
        .post-author-name {
            font-weight: 600;
            font-size: 0.9rem;
        }
        
        .post-author-name .you-badge {
            font-size: 0.7rem;
            font-weight: 500;
            color: var(--color-success);
            margin-left: 0.5rem;
        }
        
        .post-time {
            font-size: 0.75rem;
            color: var(--color-text-muted);
        }
        
        .post-menu-btn {
            background: none;
            border: none;
            color: var(--color-text-muted);
            cursor: pointer;
            padding: 0.25rem;
            font-size: 1.25rem;
            transition: color 0.2s;
        }
        
        .post-menu-btn:hover {
            color: var(--color-text-primary);
        }
        
        .post-content {
            font-size: 0.95rem;
            line-height: 1.6;
            white-space: pre-wrap;
            word-break: break-word;
        }
        
        /* ===== LAZY LOADING IMAGES ===== */
        .post-image {
            margin-top: 0.75rem;
            border-radius: var(--radius-lg);
            overflow: hidden;
            position: relative;
            min-height: 100px;
            background: var(--color-bg-elevated);
        }
        
        .post-image img {
            width: 100%;
            max-height: 400px;
            object-fit: cover;
            cursor: pointer;
            transition: opacity 0.3s ease, transform 0.3s ease;
            /* Lazy loading states */
            opacity: 0;
        }
        
        .post-image img.loaded {
            opacity: 1;
        }
        
        .post-image img:hover {
            transform: scale(1.02);
        }
        
        /* Image loading placeholder */
        .post-image::before {
            content: '';
            position: absolute;
            inset: 0;
            background: linear-gradient(
                90deg,
                var(--color-bg-elevated) 25%,
                var(--color-bg-tertiary) 50%,
                var(--color-bg-elevated) 75%
            );
            background-size: 200% 100%;
            animation: skeleton-loading 1.5s infinite;
            z-index: 0;
        }
        
        .post-image.loaded::before {
            display: none;
        }
        
        /* ===== EMPTY STATE ===== */
        .empty-state {
            text-align: center;
            padding: 3rem 1rem;
            color: var(--color-text-muted);
            animation: post-fade-in 0.5s ease forwards;
        }
        
        .empty-state-icon {
            font-size: 4rem;
            margin-bottom: 1rem;
            opacity: 0.5;
        }
        
        .empty-state-title {
            font-size: 1.25rem;
            font-weight: 600;
            color: var(--color-text-primary);
            margin-bottom: 0.5rem;
        }
        
        .empty-state-text {
            font-size: 0.9rem;
            max-width: 300px;
            margin: 0 auto;
        }

        /* ===== LOADING & SKELETON ===== */
        .loading {
            display: flex;
            justify-content: center;
            padding: 2rem;
        }
        
        .loading-spinner {
            width: 32px;
            height: 32px;
            border: 3px solid var(--color-border);
            border-top-color: var(--color-brand);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        /* Enhanced skeleton loading */
        .skeleton-post {
            background: var(--color-bg-secondary);
            border: 1px solid var(--color-border);
            border-radius: var(--radius-xl);
            padding: 1rem;
            opacity: 0;
            animation: skeleton-fade-in 0.3s ease forwards;
        }
        
        .skeleton-post:nth-child(1) { animation-delay: 0s; }
        .skeleton-post:nth-child(2) { animation-delay: 0.1s; }
        .skeleton-post:nth-child(3) { animation-delay: 0.2s; }
        
        @keyframes skeleton-fade-in {
            to { opacity: 1; }
        }
        
        .skeleton {
            background: linear-gradient(
                90deg,
                var(--color-bg-elevated) 25%,
                var(--color-bg-tertiary) 50%,
                var(--color-bg-elevated) 75%
            );
            background-size: 200% 100%;
            animation: skeleton-loading 1.5s infinite;
            border-radius: var(--radius-md);
        }
        
        @keyframes skeleton-loading {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }
        
        /* Skeleton variations */
        .skeleton.skeleton-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            flex-shrink: 0;
        }
        
        .skeleton.skeleton-title {
            height: 16px;
            width: 60%;
            margin-bottom: 0.5rem;
        }
        
        .skeleton.skeleton-text {
            height: 12px;
            width: 40%;
        }
        
        .skeleton.skeleton-body {
            height: 60px;
            width: 100%;
            margin-top: 0.75rem;
        }
        
        .skeleton.skeleton-image {
            height: 200px;
            width: 100%;
            margin-top: 0.75rem;
            border-radius: var(--radius-lg);
        }

        /* ===== INFINITE SCROLL LOADER ===== */
        .infinite-scroll-loader {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 0.5rem;
            padding: 1.5rem;
            color: var(--color-text-muted);
            font-size: 0.875rem;
        }
        
        .infinite-scroll-loader .loading-spinner {
            width: 20px;
            height: 20px;
        }
        
        .infinite-scroll-end {
            text-align: center;
            padding: 2rem 1rem;
            color: var(--color-text-muted);
            font-size: 0.9rem;
        }
        
        /* Skeleton loader group for infinite scroll */
        .skeleton-loader-group {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }
        
        .skeleton-loader-group .skeleton-post {
            opacity: 0;
            animation: skeleton-fade-in 0.3s ease forwards;
        }
        
        .loading-skeleton {
            position: relative;
            overflow: hidden;
        }
        
        .loading-skeleton::after {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(
                90deg,
                transparent 0%,
                rgba(255, 255, 255, 0.05) 50%,
                transparent 100%
            );
            animation: shimmer 1.5s infinite;
        }
        
        @keyframes shimmer {
            0% { left: -100%; }
            100% { left: 100%; }
        }
        
        /* Sentinel element for IntersectionObserver */
        .scroll-sentinel {
            height: 1px;
            width: 100%;
        }

        /* ===== TOAST ===== */
        .toast-container {
            position: fixed;
            top: 1rem;
            left: 50%;
            transform: translateX(-50%);
            z-index: 1000;
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
            pointer-events: none;
            width: 90%;
            max-width: 400px;
        }
        
        .toast {
            background: var(--color-bg-secondary);
            border: 1px solid var(--color-border);
            border-radius: var(--radius-lg);
            padding: 1rem;
            display: flex;
            align-items: center;
            gap: 0.75rem;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.5);
            animation: toast-in 0.3s ease-out;
            pointer-events: auto;
        }
        
        .toast.success { border-color: var(--color-success); }
        .toast.error { border-color: var(--color-error); }
        
        @keyframes toast-in {
            0% { opacity: 0; transform: translateY(-20px); }
            100% { opacity: 1; transform: translateY(0); }
        }
        
        .toast.toast-out {
            animation: toast-out 0.3s ease-out forwards;
        }
        
        @keyframes toast-out {
            0% { opacity: 1; transform: translateY(0); }
            100% { opacity: 0; transform: translateY(-20px); }
        }

        /* ===== DELETE MENU ===== */
        .post-menu {
            position: absolute;
            right: 0;
            top: 100%;
            background: var(--color-bg-elevated);
            border: 1px solid var(--color-border);
            border-radius: var(--radius-lg);
            padding: 0.25rem;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.5);
            z-index: 50;
            display: none;
        }
        
        .post-menu.open {
            display: block;
            animation: menu-in 0.2s ease;
        }
        
        @keyframes menu-in {
            from {
                opacity: 0;
                transform: translateY(-10px) scale(0.95);
            }
            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }
        
        .post-menu-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 0.75rem;
            background: none;
            border: none;
            color: var(--color-error);
            cursor: pointer;
            font-size: 0.875rem;
            border-radius: var(--radius-md);
            width: 100%;
            transition: background 0.2s;
        }
        
        .post-menu-item:hover {
            background: var(--color-bg-hover);
        }

        /* ===== IMAGE MODAL ===== */
        .image-modal {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.9);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s, visibility 0.3s;
            cursor: zoom-out;
        }
        
        .image-modal.open {
            opacity: 1;
            visibility: visible;
        }
        
        .image-modal img {
            max-width: 95%;
            max-height: 95%;
            object-fit: contain;
            border-radius: var(--radius-lg);
            transform: scale(0.9);
            transition: transform 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
        }
        
        .image-modal.open img {
            transform: scale(1);
        }
        
        .image-modal-close {
            position: absolute;
            top: 1rem;
            right: 1rem;
            width: 40px;
            height: 40px;
            background: rgba(255, 255, 255, 0.1);
            border: none;
            border-radius: 50%;
            color: white;
            cursor: pointer;
            font-size: 1.5rem;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background 0.2s;
        }
        
        .image-modal-close:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        /* ===== REACTIONS ===== */
        .post-reactions {
            display: flex;
            gap: 0.5rem;
            margin-top: 0.75rem;
            padding-top: 0.75rem;
            border-top: 1px solid var(--color-border);
            flex-wrap: wrap;
        }
        
        .reaction-btn {
            display: flex;
            align-items: center;
            gap: 0.35rem;
            padding: 0.4rem 0.65rem;
            background: var(--color-bg-elevated);
            border: 1px solid var(--color-border);
            border-radius: var(--radius-full, 9999px);
            color: var(--color-text-muted);
            font-size: 0.875rem;
            cursor: pointer;
            transition: all 0.2s;
            user-select: none;
        }
        
        .reaction-btn:hover {
            background: var(--color-bg-hover);
            transform: scale(1.05);
        }
        
        .reaction-btn:active {
            transform: scale(0.95);
        }
        
        .reaction-btn.active {
            background: var(--color-brand-muted);
            border-color: var(--color-brand);
            color: var(--color-brand);
        }
        
        .reaction-btn .emoji {
            font-size: 1rem;
            line-height: 1;
        }
        
        .reaction-btn .count {
            font-size: 0.75rem;
            font-weight: 600;
            min-width: 1ch;
        }
        
        .reaction-btn .count:empty {
            display: none;
        }
        
        /* Animation when adding reaction */
        .reaction-btn.animating {
            animation: reaction-pop 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
        }
        
        @keyframes reaction-pop {
            0% { transform: scale(1); }
            50% { transform: scale(1.3); }
            100% { transform: scale(1); }
        }

        /* ===== SHARE BUTTONS ===== */
        .post-actions {
            display: flex;
            justify-content: flex-end;
            gap: 0.5rem;
            margin-top: 0.75rem;
            padding-top: 0.75rem;
            border-top: 1px solid var(--color-border);
        }
        
        .share-btn {
            display: flex;
            align-items: center;
            gap: 0.35rem;
            padding: 0.4rem 0.65rem;
            background: var(--color-bg-elevated);
            border: 1px solid var(--color-border);
            border-radius: var(--radius-md);
            color: var(--color-text-muted);
            font-size: 0.75rem;
            cursor: pointer;
            transition: all 0.2s;
            text-decoration: none;
        }
        
        .share-btn:hover {
            background: var(--color-bg-hover);
            color: var(--color-text-primary);
            border-color: var(--color-border-active);
            transform: translateY(-1px);
        }
        
        .share-btn svg {
            width: 14px;
            height: 14px;
        }
        
        .share-btn.twitter:hover {
            border-color: #1da1f2;
            color: #1da1f2;
        }
        
        .share-btn.whatsapp:hover {
            border-color: #25d366;
            color: #25d366;
        }
        
        .share-btn.copy:hover {
            border-color: var(--color-brand);
            color: var(--color-brand);
        }
        
        .share-btn.copy.copied {
            background: var(--color-brand-muted);
            border-color: var(--color-brand);
            color: var(--color-brand);
        }
        
        .share-btn.link:hover {
            border-color: var(--color-brand);
            color: var(--color-brand);
        }

        /* ===== RESPONSIVE ===== */
        @media (max-width: 480px) {
            .feed-header {
                padding: 0.75rem 0;
            }
            
            .composer {
                padding: 0.75rem;
            }
            
            .post-card {
                padding: 0.75rem;
            }
            
            .post-actions {
                flex-wrap: wrap;
                justify-content: center;
            }
            
            .share-btn span {
                display: none;
            }
            
            .share-btn {
                padding: 0.5rem;
            }
        }
        
        /* ===== REDUCED MOTION ===== */
        @media (prefers-reduced-motion: reduce) {
            .post-card,
            .skeleton-post,
            .skeleton,
            .post-image img,
            .image-modal img {
                animation: none;
                transition: none;
                opacity: 1;
                transform: none;
            }
            
            .pull-to-refresh {
                transition: none;
            }
        }
    </style>
</head>
<body>
    <!-- Skip Links - WCAG AAA Compliant -->
    <nav class="skip-links" aria-label="Liens d'√©vitement">
        <a href="#main-content" class="skip-link">Aller au contenu principal</a>
        <a href="#feed-posts" class="skip-link">Aller aux publications</a>
    </nav>
    
    <!-- Live region for dynamic announcements -->
    <div id="sr-announce" class="sr-announce" aria-live="polite" aria-atomic="true"></div>
    
    <div class="noise-overlay" aria-hidden="true"></div>
    
    <!-- Pull to Refresh Indicator -->
    <div class="pull-to-refresh" id="pull-to-refresh" aria-live="polite" aria-label="Tirer pour rafra√Æchir">
        <svg class="ptr-arrow" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
            <polyline points="6 9 12 15 18 9"/>
        </svg>
        <svg class="ptr-spinner" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true" style="display: none;">
            <path d="M21 12a9 9 0 1 1-6.219-8.56"/>
        </svg>
        <span class="ptr-text">Tirer pour rafra√Æchir</span>
    </div>
    
    <!-- Toast Container -->
    <div class="toast-container" id="toast-container" role="status" aria-live="polite"></div>
    
    <!-- Image Modal -->
    <div class="image-modal" id="image-modal" role="dialog" aria-modal="true" aria-label="Image agrandie" onclick="closeImageModal()">
        <button class="image-modal-close" onclick="closeImageModal()" aria-label="Fermer">√ó</button>
        <img id="modal-image" src="" alt="Image agrandie">
    </div>

    <main class="feed-container" id="main-content">
        <header class="feed-header">
            <a href="/app.html" class="feed-logo" aria-label="Retour √† l'accueil">5</a>
            <span class="feed-title">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true" style="vertical-align: middle; margin-right: 4px;">
                    <path d="M4 11a9 9 0 0 1 9 9"/><path d="M4 4a16 16 0 0 1 16 16"/><circle cx="5" cy="19" r="1"/>
                </svg>
                Feed
            </span>
            <div class="header-actions">
                <button class="theme-toggle" onclick="toggleTheme()" aria-label="Basculer mode clair/sombre">
                    <svg class="icon-sun" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg>
                    <svg class="icon-moon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/></svg>
                </button>
                <a href="/app.html" class="back-btn" aria-label="Retour √† l'application">‚Üê Retour</a>
            </div>
        </header>

        <!-- Composer -->
        <div class="composer" id="composer" role="form" aria-label="Cr√©er un nouveau post">
            <div class="composer-header">
                <div class="composer-avatar" id="composer-avatar" aria-hidden="true">?</div>
                <span class="composer-user" id="composer-user">Chargement...</span>
            </div>
            <textarea 
                class="composer-textarea" 
                id="post-content" 
                placeholder="Quoi de neuf ? Partage quelque chose avec tes 5..."
                maxlength="1000"
                aria-label="Contenu du post"
            ></textarea>
            <div class="image-preview" id="image-preview" style="display: none;" aria-label="Aper√ßu de l'image">
                <img id="preview-img" src="" alt="Aper√ßu de l'image √† poster">
                <button class="image-preview-remove" onclick="removeImage()" aria-label="Supprimer l'image">√ó</button>
                <div id="upload-progress" style="display: none; position: absolute; bottom: 0; left: 0; right: 0; background: rgba(0,0,0,0.7); padding: 0.5rem; text-align: center; font-size: 0.75rem;" role="status" aria-live="polite">
                    ‚è≥ Upload en cours...
                </div>
            </div>
            <!-- Hidden file input -->
            <input type="file" id="file-input" accept="image/jpeg,image/png,image/gif,image/webp" style="display: none;" onchange="handleFileSelect(event)" aria-label="S√©lectionner une image">
            <!-- AI Generation input -->
            <div id="ai-prompt-container" style="display: none; margin-top: 0.5rem;">
                <div style="display: flex; gap: 0.5rem;">
                    <input 
                        type="text" 
                        class="image-url-input" 
                        id="ai-prompt" 
                        placeholder="D√©cris l'image √† g√©n√©rer... (ex: un chat sur la lune)"
                        maxlength="500"
                        style="flex: 1;"
                        aria-label="Description de l'image √† g√©n√©rer"
                    >
                    <button class="composer-btn" onclick="generateAIImage()" id="generate-btn" style="background: linear-gradient(135deg, #a855f7, #6366f1); color: white; border: none;" aria-label="G√©n√©rer l'image">
                        ‚ú® G√©n√©rer
                    </button>
                </div>
                <div style="font-size: 0.7rem; color: var(--color-text-muted); margin-top: 0.25rem;">
                    ü§ñ G√©n√©ration IA (5 par heure max)
                </div>
            </div>
            <div class="composer-footer">
                <div class="composer-actions">
                    <button class="composer-btn" id="upload-image-btn" onclick="triggerFileUpload()" aria-label="Ajouter une photo">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                            <rect x="3" y="3" width="18" height="18" rx="2"/><circle cx="8.5" cy="8.5" r="1.5"/><polyline points="21 15 16 10 5 21"/>
                        </svg>
                        Photo
                    </button>
                    <button class="composer-btn" id="ai-image-btn" onclick="toggleAIPrompt()" aria-label="G√©n√©rer une image par IA">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                            <polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/>
                        </svg>
                        IA
                    </button>
                </div>
                <div style="display: flex; align-items: center; gap: 1rem;">
                    <span class="char-count" id="char-count" aria-live="polite">0/1000</span>
                    <button class="post-btn" id="post-btn" onclick="submitPost()" disabled aria-label="Publier le post">
                        Poster
                    </button>
                </div>
            </div>
        </div>

        <!-- Posts List -->
        <div class="posts-list" id="posts-list" role="feed" aria-label="Liste des posts">
            <!-- Loading skeletons -->
            <div class="skeleton-post" id="skeleton-1" aria-hidden="true">
                <div style="display: flex; gap: 0.75rem; margin-bottom: 0.75rem;">
                    <div class="skeleton skeleton-avatar"></div>
                    <div style="flex: 1;">
                        <div class="skeleton skeleton-title"></div>
                        <div class="skeleton skeleton-text"></div>
                    </div>
                </div>
                <div class="skeleton skeleton-body"></div>
            </div>
            <div class="skeleton-post" id="skeleton-2" aria-hidden="true">
                <div style="display: flex; gap: 0.75rem; margin-bottom: 0.75rem;">
                    <div class="skeleton skeleton-avatar"></div>
                    <div style="flex: 1;">
                        <div class="skeleton skeleton-title" style="width: 45%;"></div>
                        <div class="skeleton skeleton-text" style="width: 30%;"></div>
                    </div>
                </div>
                <div class="skeleton skeleton-body" style="height: 40px;"></div>
                <div class="skeleton skeleton-image"></div>
            </div>
            <div class="skeleton-post" id="skeleton-3" aria-hidden="true">
                <div style="display: flex; gap: 0.75rem; margin-bottom: 0.75rem;">
                    <div class="skeleton skeleton-avatar"></div>
                    <div style="flex: 1;">
                        <div class="skeleton skeleton-title" style="width: 70%;"></div>
                        <div class="skeleton skeleton-text" style="width: 25%;"></div>
                    </div>
                </div>
                <div class="skeleton skeleton-body" style="height: 80px;"></div>
            </div>
        </div>
        
        <!-- Scroll sentinel for infinite scroll -->
        <div class="scroll-sentinel" id="scroll-sentinel" aria-hidden="true"></div>
    </main>

    <script>
        const API_URL = '/api';
        let session = null;
        let user = null;
        let posts = [];
        let openMenuPostId = null;
        
        // Reactions state
        const REACTION_EMOJIS = ['‚ù§Ô∏è', 'üòÇ', 'üòÆ', 'üò¢', 'üëè'];
        let reactionsCache = {}; // { postId: { counts: {}, userReactions: [] } }
        
        // ===== PAGINATION STATE (CURSOR-BASED) =====
        let nextCursor = null;  // ISO date string of last post
        let pageSize = 10;
        let hasMorePosts = true;
        let isLoadingMore = false;
        let infiniteScrollObserver = null;
        let isInitialLoad = true;
        
        // ===== PULL TO REFRESH STATE =====
        let ptrStartY = 0;
        let ptrCurrentY = 0;
        let isPulling = false;
        let isRefreshing = false;
        const PTR_THRESHOLD = 80;

        // ===== AUTH =====
        // getToken() and authHeaders() now provided by /js/shared.js

        // ===== INIT =====
        async function init() {
            const sessionStr = localStorage.getItem('cinq_session');
            if (!sessionStr) {
                window.location.href = '/login.html';
                return;
            }

            try {
                session = JSON.parse(sessionStr);
                user = session.user;
                
                // Update composer
                const initial = (user.email || '?')[0].toUpperCase();
                document.getElementById('composer-avatar').textContent = initial;
                document.getElementById('composer-user').textContent = user.email?.split('@')[0] || 'Toi';
                
                // Setup textarea listeners
                setupComposer();
                
                // Setup Pull to Refresh
                setupPullToRefresh();
                
                // Setup Infinite Scroll
                setupInfiniteScroll();
                
                // Setup Lazy Loading
                setupLazyLoading();
                
                // Load posts
                await loadPosts();
                
            } catch (e) {
                console.error('Init error:', e);
                window.location.href = '/login.html';
            }
        }

        // ===== COMPOSER =====
        function setupComposer() {
            const textarea = document.getElementById('post-content');
            const charCount = document.getElementById('char-count');
            const postBtn = document.getElementById('post-btn');
            const imageUrl = document.getElementById('image-url');
            
            textarea.addEventListener('input', () => {
                const len = textarea.value.length;
                charCount.textContent = `${len}/1000`;
                
                charCount.classList.remove('warning', 'error');
                if (len > 900) charCount.classList.add('error');
                else if (len > 700) charCount.classList.add('warning');
                
                postBtn.disabled = len === 0 || len > 1000;
            });
            
            // Submit on Ctrl+Enter
            textarea.addEventListener('keydown', (e) => {
                if ((e.ctrlKey || e.metaKey) && e.key === 'Enter') {
                    e.preventDefault();
                    if (!postBtn.disabled) submitPost();
                }
            });
        }
        
        // Current uploaded image URL (stored after upload)
        let currentImageUrl = null;
        
        function isValidUrl(string) {
            try {
                const url = new URL(string);
                return url.protocol === 'http:' || url.protocol === 'https:';
            } catch {
                return false;
            }
        }
        
        // ===== FILE UPLOAD =====
        function triggerFileUpload() {
            document.getElementById('file-input').click();
        }
        
        async function handleFileSelect(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            // Validate file type
            const validTypes = ['image/jpeg', 'image/png', 'image/gif', 'image/webp'];
            if (!validTypes.includes(file.type)) {
                showToast({ type: 'error', message: 'Format non support√© (JPEG, PNG, GIF, WebP)' });
                return;
            }
            
            // Validate file size (5MB)
            if (file.size > 5 * 1024 * 1024) {
                showToast({ type: 'error', message: 'Image trop grande (max 5 Mo)' });
                return;
            }
            
            // Show local preview immediately
            const reader = new FileReader();
            reader.onload = async (e) => {
                showImagePreview(e.target.result);
                
                // Upload to server
                await uploadImage(e.target.result, file.type);
            };
            reader.readAsDataURL(file);
        }
        
        async function uploadImage(base64Data, contentType) {
            const progress = document.getElementById('upload-progress');
            progress.style.display = 'block';
            
            try {
                const res = await fetch(`${API_URL}/upload-image`, {
                    method: 'POST',
                    headers: authHeaders(),
                    body: JSON.stringify({ 
                        image: base64Data, 
                        contentType 
                    })
                });
                
                const data = await res.json();
                
                if (!res.ok) throw new Error(data.error || 'Erreur upload');
                
                currentImageUrl = data.url;
                showToast({ type: 'success', message: 'üì∑ Image pr√™te !' });
                
            } catch (e) {
                console.error('Upload error:', e);
                showToast({ type: 'error', message: e.message });
                removeImage();
            } finally {
                progress.style.display = 'none';
            }
        }
        
        // ===== AI IMAGE GENERATION =====
        function toggleAIPrompt() {
            const container = document.getElementById('ai-prompt-container');
            const btn = document.getElementById('ai-image-btn');
            
            if (container.style.display === 'none') {
                container.style.display = 'block';
                btn.classList.add('active');
                document.getElementById('ai-prompt').focus();
            } else {
                container.style.display = 'none';
                btn.classList.remove('active');
                document.getElementById('ai-prompt').value = '';
            }
        }
        
        async function generateAIImage() {
            const prompt = document.getElementById('ai-prompt').value.trim();
            if (!prompt) {
                showToast({ type: 'error', message: 'Entre une description pour l\'image' });
                return;
            }
            
            const generateBtn = document.getElementById('generate-btn');
            generateBtn.disabled = true;
            generateBtn.textContent = '‚è≥...';
            
            try {
                const res = await fetch(`${API_URL}/upload-image`, {
                    method: 'POST',
                    headers: authHeaders(),
                    body: JSON.stringify({ 
                        action: 'generate',
                        prompt 
                    })
                });
                
                const data = await res.json();
                
                if (!res.ok) throw new Error(data.error || 'Erreur g√©n√©ration');
                
                currentImageUrl = data.url;
                showImagePreview(data.url);
                showToast({ type: 'success', message: '‚ú® Image g√©n√©r√©e !' });
                
                // Hide AI prompt after success
                document.getElementById('ai-prompt-container').style.display = 'none';
                document.getElementById('ai-image-btn').classList.remove('active');
                
            } catch (e) {
                console.error('AI generation error:', e);
                showToast({ type: 'error', message: e.message });
            } finally {
                generateBtn.disabled = false;
                generateBtn.textContent = '‚ú® G√©n√©rer';
            }
        }
        
        function showImagePreview(url) {
            const preview = document.getElementById('image-preview');
            const img = document.getElementById('preview-img');
            img.src = url;
            img.onload = () => { preview.style.display = 'block'; };
            img.onerror = () => { preview.style.display = 'none'; };
        }
        
        function hideImagePreview() {
            document.getElementById('image-preview').style.display = 'none';
            document.getElementById('preview-img').src = '';
            currentImageUrl = null;
        }
        
        function removeImage() {
            hideImagePreview();
            document.getElementById('file-input').value = '';
            document.getElementById('ai-prompt').value = '';
        }

        // ===== SUBMIT POST =====
        async function submitPost() {
            const content = document.getElementById('post-content').value.trim();
            
            if (!content) return;
            
            const postBtn = document.getElementById('post-btn');
            postBtn.disabled = true;
            postBtn.textContent = '...';
            
            try {
                const body = { content };
                if (currentImageUrl) {
                    body.image_url = currentImageUrl;
                }
                
                const res = await fetch(`${API_URL}/posts`, {
                    method: 'POST',
                    headers: authHeaders(),
                    body: JSON.stringify(body)
                });
                
                const data = await res.json();
                
                if (!res.ok) throw new Error(data.error || 'Erreur lors de la publication');
                
                // Add to list with special animation class
                posts.unshift(data.post);
                renderPosts(true); // true = new post added
                
                // Reset composer
                document.getElementById('post-content').value = '';
                document.getElementById('char-count').textContent = '0/1000';
                document.getElementById('file-input').value = '';
                document.getElementById('ai-prompt').value = '';
                document.getElementById('ai-prompt-container').style.display = 'none';
                document.getElementById('ai-image-btn').classList.remove('active');
                document.getElementById('upload-image-btn').classList.remove('active');
                hideImagePreview();
                
                showToast({ type: 'success', message: 'Post√© !' });
                
            } catch (e) {
                console.error('Submit error:', e);
                showToast({ type: 'error', message: e.message });
            } finally {
                postBtn.disabled = false;
                postBtn.textContent = 'Poster';
            }
        }

        // ===== PULL TO REFRESH =====
        function setupPullToRefresh() {
            const container = document.querySelector('.feed-container');
            const ptr = document.getElementById('pull-to-refresh');
            const ptrText = ptr.querySelector('.ptr-text');
            const ptrArrow = ptr.querySelector('.ptr-arrow');
            const ptrSpinner = ptr.querySelector('.ptr-spinner');
            
            // Touch events
            container.addEventListener('touchstart', (e) => {
                // Only trigger at top of page
                if (window.scrollY > 10 || isRefreshing) return;
                ptrStartY = e.touches[0].clientY;
                isPulling = true;
            }, { passive: true });
            
            container.addEventListener('touchmove', (e) => {
                if (!isPulling || isRefreshing) return;
                
                ptrCurrentY = e.touches[0].clientY;
                const pullDistance = ptrCurrentY - ptrStartY;
                
                // Only show if pulling down and at top
                if (pullDistance > 0 && window.scrollY <= 0) {
                    const progress = Math.min(pullDistance / PTR_THRESHOLD, 1);
                    
                    // Show indicator
                    ptr.classList.add('visible');
                    ptr.style.transform = `translateX(-50%) translateY(${Math.min(pullDistance * 0.5, 60)}px)`;
                    
                    // Update state
                    if (pullDistance >= PTR_THRESHOLD) {
                        ptr.classList.add('ready');
                        ptrText.textContent = 'Rel√¢che pour rafra√Æchir';
                    } else {
                        ptr.classList.remove('ready');
                        ptrText.textContent = 'Tirer pour rafra√Æchir';
                    }
                }
            }, { passive: true });
            
            container.addEventListener('touchend', async () => {
                if (!isPulling) return;
                isPulling = false;
                
                const pullDistance = ptrCurrentY - ptrStartY;
                
                if (pullDistance >= PTR_THRESHOLD && !isRefreshing) {
                    // Trigger refresh
                    isRefreshing = true;
                    ptr.classList.add('refreshing');
                    ptrArrow.style.display = 'none';
                    ptrSpinner.style.display = 'block';
                    ptrText.textContent = 'Rafra√Æchissement...';
                    
                    try {
                        await refreshPosts();
                        showToast({ type: 'success', message: '‚úì Feed mis √† jour' });
                    } catch (e) {
                        showToast({ type: 'error', message: 'Erreur de rafra√Æchissement' });
                    }
                    
                    // Reset
                    setTimeout(() => {
                        ptr.classList.remove('visible', 'ready', 'refreshing');
                        ptr.style.transform = '';
                        ptrArrow.style.display = 'block';
                        ptrSpinner.style.display = 'none';
                        ptrText.textContent = 'Tirer pour rafra√Æchir';
                        isRefreshing = false;
                    }, 300);
                } else {
                    // Cancel
                    ptr.classList.remove('visible', 'ready');
                    ptr.style.transform = '';
                }
                
                ptrStartY = 0;
                ptrCurrentY = 0;
            }, { passive: true });
        }
        
        async function refreshPosts() {
            nextCursor = null;
            hasMorePosts = true;
            posts = [];
            
            // Remove end message if exists
            document.querySelector('.infinite-scroll-end')?.remove();
            
            await loadPosts();
        }

        // ===== INFINITE SCROLL =====
        function setupInfiniteScroll() {
            const sentinel = document.getElementById('scroll-sentinel');
            
            infiniteScrollObserver = new IntersectionObserver(
                (entries) => {
                    const entry = entries[0];
                    if (entry.isIntersecting && hasMorePosts && !isLoadingMore) {
                        loadMorePosts();
                    }
                },
                {
                    root: null,
                    rootMargin: '100px',
                    threshold: 0
                }
            );
            
            infiniteScrollObserver.observe(sentinel);
        }
        
        async function loadMorePosts() {
            if (isLoadingMore || !hasMorePosts || !nextCursor) return;
            
            isLoadingMore = true;
            
            // Show skeleton loaders
            const container = document.getElementById('posts-list');
            const loaderId = 'infinite-loader';
            
            // Remove any existing loader/end message
            document.getElementById(loaderId)?.remove();
            document.querySelector('.infinite-scroll-end')?.remove();
            
            // Add skeleton loaders
            const skeletonHtml = `
                <div id="${loaderId}" class="skeleton-loader-group" aria-label="Chargement de plus de posts">
                    <div class="skeleton-post loading-skeleton">
                        <div style="display: flex; gap: 0.75rem; margin-bottom: 0.75rem;">
                            <div class="skeleton skeleton-avatar"></div>
                            <div style="flex: 1;">
                                <div class="skeleton skeleton-title"></div>
                                <div class="skeleton skeleton-text"></div>
                            </div>
                        </div>
                        <div class="skeleton skeleton-body"></div>
                    </div>
                    <div class="skeleton-post loading-skeleton" style="animation-delay: 0.1s;">
                        <div style="display: flex; gap: 0.75rem; margin-bottom: 0.75rem;">
                            <div class="skeleton skeleton-avatar"></div>
                            <div style="flex: 1;">
                                <div class="skeleton skeleton-title" style="width: 50%;"></div>
                                <div class="skeleton skeleton-text" style="width: 35%;"></div>
                            </div>
                        </div>
                        <div class="skeleton skeleton-body" style="height: 45px;"></div>
                    </div>
                </div>
            `;
            container.insertAdjacentHTML('beforeend', skeletonHtml);
            
            try {
                // Cursor-based pagination: get posts older than cursor
                const res = await fetch(`${API_URL}/posts?cursor=${encodeURIComponent(nextCursor)}&limit=${pageSize}`, {
                    headers: authHeaders()
                });
                
                const data = await res.json();
                
                if (!res.ok) throw new Error(data.error || 'Erreur de chargement');
                
                const newPosts = data.posts || [];
                
                // Update cursor for next load
                nextCursor = data.nextCursor || null;
                hasMorePosts = data.hasMore !== false && nextCursor !== null;
                
                if (newPosts.length > 0) {
                    // Append new posts
                    const startIndex = posts.length;
                    posts = [...posts, ...newPosts];
                    
                    // Render only new posts with staggered animation
                    renderNewPosts(newPosts, startIndex);
                }
                
            } catch (e) {
                console.error('Load more error:', e);
                showToast({ type: 'error', message: 'Erreur de chargement' });
            } finally {
                isLoadingMore = false;
                
                // Remove skeleton loader
                document.getElementById(loaderId)?.remove();
                
                // Show end message if no more posts
                if (!hasMorePosts && !document.querySelector('.infinite-scroll-end')) {
                    const endMsg = document.createElement('div');
                    endMsg.className = 'infinite-scroll-end';
                    endMsg.innerHTML = `
                        <div style="opacity: 0; animation: post-fade-in 0.4s ease forwards;">
                            ‚ú® Tu as tout vu !
                        </div>
                    `;
                    container.appendChild(endMsg);
                }
            }
        }
        
        /**
         * Render only new posts (for infinite scroll) with staggered animation
         */
        function renderNewPosts(newPosts, startIndex) {
            const container = document.getElementById('posts-list');
            
            newPosts.forEach((post, i) => {
                const postHtml = renderPost(post, false, startIndex + i);
                container.insertAdjacentHTML('beforeend', postHtml);
            });
            
            // Setup lazy loading for new images
            requestAnimationFrame(() => {
                observeLazyImages();
            });
            
            // Load reactions for new posts
            const postIds = newPosts.map(p => p.id);
            if (postIds.length > 0) {
                loadReactions(postIds);
            }
        }

        // ===== LAZY LOADING IMAGES =====
        let lazyLoadObserver = null;
        
        function setupLazyLoading() {
            lazyLoadObserver = new IntersectionObserver(
                (entries) => {
                    entries.forEach(entry => {
                        if (entry.isIntersecting) {
                            const img = entry.target;
                            const src = img.dataset.src;
                            
                            if (src) {
                                img.src = src;
                                img.onload = () => {
                                    img.classList.add('loaded');
                                    img.closest('.post-image')?.classList.add('loaded');
                                };
                                img.onerror = () => {
                                    img.closest('.post-image')?.classList.add('loaded');
                                };
                                lazyLoadObserver.unobserve(img);
                            }
                        }
                    });
                },
                {
                    root: null,
                    rootMargin: '50px',
                    threshold: 0
                }
            );
        }
        
        function observeLazyImages() {
            document.querySelectorAll('.post-image img[data-src]').forEach(img => {
                lazyLoadObserver.observe(img);
            });
        }

        // ===== LOAD POSTS =====
        async function loadPosts() {
            isInitialLoad = true;
            
            try {
                const res = await fetch(`${API_URL}/posts?limit=${pageSize}`, {
                    headers: authHeaders()
                });
                
                const data = await res.json();
                
                if (!res.ok) throw new Error(data.error || 'Erreur de chargement');
                
                posts = data.posts || [];
                nextCursor = data.nextCursor || null;
                hasMorePosts = data.hasMore !== false && nextCursor !== null;
                
                renderPosts();
                
            } catch (e) {
                console.error('Load error:', e);
                document.getElementById('posts-list').innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">üò¢</div>
                        <div class="empty-state-title">Erreur de chargement</div>
                        <div class="empty-state-text">${e.message}</div>
                    </div>
                `;
            } finally {
                isInitialLoad = false;
            }
        }

        // ===== RENDER POSTS =====
        function renderPosts(isNewPost = false) {
            const container = document.getElementById('posts-list');
            
            // Remove skeletons and end message
            document.querySelectorAll('.skeleton-post').forEach(el => el.remove());
            document.querySelector('.infinite-scroll-end')?.remove();
            
            if (posts.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">üì≠</div>
                        <div class="empty-state-title">Rien ici pour l'instant</div>
                        <div class="empty-state-text">
                            Sois le premier √† poster quelque chose, ou ajoute des contacts pour voir leur feed !
                        </div>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = posts.map((post, index) => 
                renderPost(post, isNewPost && index === 0, index)
            ).join('');
            
            // Show end message if no more posts after initial load
            if (!hasMorePosts && posts.length > 0) {
                const endMsg = document.createElement('div');
                endMsg.className = 'infinite-scroll-end';
                endMsg.innerHTML = `
                    <div style="opacity: 0; animation: post-fade-in 0.4s ease 0.3s forwards;">
                        ‚ú® Tu as tout vu !
                    </div>
                `;
                container.appendChild(endMsg);
            }
            
            // Setup lazy loading for new images
            requestAnimationFrame(() => {
                observeLazyImages();
            });
            
            // Load reactions for all posts
            const postIds = posts.map(p => p.id);
            if (postIds.length > 0) {
                loadReactions(postIds);
            }
        }
        
        function renderPost(post, isNew = false, index = 0) {
            const author = post.author || {};
            const isOwn = post.user_id === user.id;
            const initial = (author.display_name || author.email || '?')[0].toUpperCase();
            const displayName = author.display_name || author.email?.split('@')[0] || 'Anonyme';
            const time = formatTime(post.created_at);
            
            // Lazy load images
            const imageHtml = post.image_url ? `
                <div class="post-image" role="img" aria-label="Image du post">
                    <img 
                        data-src="${escapeHtml(post.image_url)}" 
                        alt="Image partag√©e par ${escapeHtml(displayName)}" 
                        onclick="openImageModal('${escapeHtml(post.image_url)}')"
                        loading="lazy"
                    >
                </div>
            ` : '';
            
            const menuHtml = isOwn ? `
                <button class="post-menu-btn" onclick="toggleMenu('${post.id}')" aria-label="Menu du post" aria-expanded="false" aria-haspopup="true">‚ãÆ</button>
                <div class="post-menu" id="menu-${post.id}" role="menu">
                    <button class="post-menu-item" onclick="deletePost('${post.id}')" role="menuitem">
                        üóëÔ∏è Supprimer
                    </button>
                </div>
            ` : '';
            
            const newPostClass = isNew ? 'new-post' : '';
            
            // Staggered animation delay for infinite scroll posts
            // Cap at 0.5s max delay for posts loaded via infinite scroll
            const animDelay = isInitialLoad 
                ? Math.min(index * 0.05, 0.3) 
                : Math.min((index % pageSize) * 0.08, 0.5);
            
            // Generate share URLs (using short /p/:id format for cleaner shares)
            const postUrl = `${window.location.origin}/p/${post.id}`;
            const shareText = post.content.substring(0, 100) + (post.content.length > 100 ? '...' : '');
            
            // Generate reactions HTML
            const reactionData = reactionsCache[post.id] || { counts: {}, userReactions: [] };
            const reactionsHtml = `
                <div class="post-reactions" data-post-id="${post.id}">
                    ${REACTION_EMOJIS.map(emoji => {
                        const count = reactionData.counts[emoji] || 0;
                        const isActive = reactionData.userReactions.includes(emoji);
                        return `
                            <button class="reaction-btn ${isActive ? 'active' : ''}" 
                                    onclick="toggleReaction('${post.id}', '${emoji}')"
                                    aria-label="R√©agir avec ${emoji}"
                                    aria-pressed="${isActive}">
                                <span class="emoji">${emoji}</span>
                                <span class="count" id="count-${post.id}-${encodeURIComponent(emoji)}">${count > 0 ? count : ''}</span>
                            </button>
                        `;
                    }).join('')}
                </div>
            `;
            
            const shareHtml = `
                <div class="post-actions">
                    <a href="https://twitter.com/intent/tweet?text=${encodeURIComponent(shareText)}&url=${encodeURIComponent(postUrl)}" 
                       target="_blank" rel="noopener noreferrer" 
                       class="share-btn twitter" 
                       aria-label="Partager sur Twitter">
                        <svg viewBox="0 0 24 24" fill="currentColor"><path d="M18.244 2.25h3.308l-7.227 8.26 8.502 11.24H16.17l-5.214-6.817L4.99 21.75H1.68l7.73-8.835L1.254 2.25H8.08l4.713 6.231zm-1.161 17.52h1.833L7.084 4.126H5.117z"/></svg>
                        <span>Twitter</span>
                    </a>
                    <a href="https://wa.me/?text=${encodeURIComponent(shareText + ' ' + postUrl)}" 
                       target="_blank" rel="noopener noreferrer"
                       class="share-btn whatsapp"
                       aria-label="Partager sur WhatsApp">
                        <svg viewBox="0 0 24 24" fill="currentColor"><path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893a11.821 11.821 0 00-3.48-8.413z"/></svg>
                        <span>WhatsApp</span>
                    </a>
                    <button onclick="copyPostLink('${post.id}')" class="share-btn copy" id="copy-btn-${post.id}" aria-label="Copier le lien">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"/><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"/></svg>
                        <span id="copy-text-${post.id}">Copier</span>
                    </button>
                    <a href="/p/${post.id}" class="share-btn link" aria-label="Voir le post">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"/><polyline points="15 3 21 3 21 9"/><line x1="10" y1="14" x2="21" y2="3"/></svg>
                        <span>Lien</span>
                    </a>
                </div>
            `;
            
            return `
                <article class="post-card ${newPostClass}" style="animation-delay: ${animDelay}s;" aria-label="Post de ${escapeHtml(displayName)}">
                    <div class="post-header">
                        <div class="post-author">
                            <div class="post-avatar ${isOwn ? 'own' : ''}" aria-hidden="true">${initial}</div>
                            <div class="post-author-info">
                                <span class="post-author-name">
                                    ${escapeHtml(displayName)}
                                    ${isOwn ? '<span class="you-badge">(toi)</span>' : ''}
                                </span>
                                <time class="post-time" datetime="${post.created_at}">${time}</time>
                            </div>
                        </div>
                        ${menuHtml}
                    </div>
                    <div class="post-content">${escapeHtml(post.content)}</div>
                    ${imageHtml}
                    ${reactionsHtml}
                    ${shareHtml}
                </article>
            `;
        }

        // ===== DELETE POST =====
        async function deletePost(postId) {
            if (!confirm('Supprimer ce post ?')) return;
            
            try {
                const res = await fetch(`${API_URL}/posts?id=${postId}`, {
                    method: 'DELETE',
                    headers: authHeaders()
                });
                
                if (!res.ok) {
                    const data = await res.json();
                    throw new Error(data.error || 'Erreur');
                }
                
                posts = posts.filter(p => p.id !== postId);
                renderPosts();
                showToast({ type: 'success', message: 'Post supprim√©' });
                
            } catch (e) {
                showToast({ type: 'error', message: e.message });
            }
        }
        
        function toggleMenu(postId) {
            // Close other menus
            document.querySelectorAll('.post-menu.open').forEach(m => {
                if (m.id !== `menu-${postId}`) {
                    m.classList.remove('open');
                    m.previousElementSibling?.setAttribute('aria-expanded', 'false');
                }
            });
            
            const menu = document.getElementById(`menu-${postId}`);
            const btn = menu.previousElementSibling;
            const isOpen = menu.classList.toggle('open');
            btn?.setAttribute('aria-expanded', isOpen);
            
            // Close on outside click
            if (isOpen) {
                setTimeout(() => {
                    document.addEventListener('click', function closeMenu(e) {
                        if (!e.target.closest('.post-menu') && !e.target.closest('.post-menu-btn')) {
                            menu.classList.remove('open');
                            btn?.setAttribute('aria-expanded', 'false');
                            document.removeEventListener('click', closeMenu);
                        }
                    });
                }, 0);
            }
        }

        // ===== IMAGE MODAL =====
        function openImageModal(url) {
            event.stopPropagation();
            document.getElementById('modal-image').src = url;
            document.getElementById('image-modal').classList.add('open');
            document.body.style.overflow = 'hidden';
        }
        
        function closeImageModal() {
            document.getElementById('image-modal').classList.remove('open');
            document.body.style.overflow = '';
        }

        // ===== UTILS =====
        // formatTime(), escapeHtml(), and showToast() now provided by /js/shared.js

        // ===== REACTIONS =====
        async function loadReactions(postIds) {
            if (!postIds || postIds.length === 0) return;
            
            try {
                const res = await fetch(`${API_URL}/reactions?post_ids=${postIds.join(',')}`, {
                    headers: authHeaders()
                });
                
                if (!res.ok) return;
                
                const data = await res.json();
                
                // Update cache
                if (data.reactions) {
                    Object.assign(reactionsCache, data.reactions);
                }
                
                // Update UI
                postIds.forEach(postId => {
                    updateReactionUI(postId);
                });
                
            } catch (e) {
                console.error('Load reactions error:', e);
            }
        }
        
        function updateReactionUI(postId) {
            const reactionData = reactionsCache[postId];
            if (!reactionData) return;
            
            REACTION_EMOJIS.forEach(emoji => {
                const count = reactionData.counts[emoji] || 0;
                const isActive = reactionData.userReactions.includes(emoji);
                
                // Update count display
                const countEl = document.getElementById(`count-${postId}-${encodeURIComponent(emoji)}`);
                if (countEl) {
                    countEl.textContent = count > 0 ? count : '';
                }
                
                // Update active state
                const container = document.querySelector(`.post-reactions[data-post-id="${postId}"]`);
                if (container) {
                    const btns = container.querySelectorAll('.reaction-btn');
                    btns.forEach(btn => {
                        if (btn.querySelector('.emoji')?.textContent === emoji) {
                            btn.classList.toggle('active', isActive);
                            btn.setAttribute('aria-pressed', isActive);
                        }
                    });
                }
            });
        }
        
        async function toggleReaction(postId, emoji) {
            const reactionData = reactionsCache[postId] || { counts: {}, userReactions: [] };
            const isActive = reactionData.userReactions.includes(emoji);
            
            // Find the button for animation
            const container = document.querySelector(`.post-reactions[data-post-id="${postId}"]`);
            let btn = null;
            if (container) {
                container.querySelectorAll('.reaction-btn').forEach(b => {
                    if (b.querySelector('.emoji')?.textContent === emoji) {
                        btn = b;
                    }
                });
            }
            
            // Optimistic update
            if (isActive) {
                // Remove reaction
                reactionData.userReactions = reactionData.userReactions.filter(e => e !== emoji);
                reactionData.counts[emoji] = Math.max(0, (reactionData.counts[emoji] || 1) - 1);
            } else {
                // Add reaction
                reactionData.userReactions.push(emoji);
                reactionData.counts[emoji] = (reactionData.counts[emoji] || 0) + 1;
                
                // Add animation
                if (btn) {
                    btn.classList.add('animating');
                    setTimeout(() => btn.classList.remove('animating'), 300);
                }
            }
            
            reactionsCache[postId] = reactionData;
            updateReactionUI(postId);
            
            // API call
            try {
                let res;
                if (isActive) {
                    // DELETE
                    res = await fetch(`${API_URL}/reactions?post_id=${postId}&emoji=${encodeURIComponent(emoji)}`, {
                        method: 'DELETE',
                        headers: authHeaders()
                    });
                } else {
                    // POST
                    res = await fetch(`${API_URL}/reactions`, {
                        method: 'POST',
                        headers: authHeaders(),
                        body: JSON.stringify({ post_id: postId, emoji })
                    });
                }
                
                const data = await res.json();
                
                if (!res.ok) {
                    throw new Error(data.error || 'Erreur r√©action');
                }
                
                // Update with server counts
                if (data.counts) {
                    reactionData.counts = data.counts;
                    updateReactionUI(postId);
                }
                
            } catch (e) {
                console.error('Toggle reaction error:', e);
                // Revert optimistic update
                if (isActive) {
                    reactionData.userReactions.push(emoji);
                    reactionData.counts[emoji] = (reactionData.counts[emoji] || 0) + 1;
                } else {
                    reactionData.userReactions = reactionData.userReactions.filter(e => e !== emoji);
                    reactionData.counts[emoji] = Math.max(0, (reactionData.counts[emoji] || 1) - 1);
                }
                updateReactionUI(postId);
                showToast({ type: 'error', message: e.message });
            }
        }

        // ===== SHARE FUNCTIONS =====
        async function copyPostLink(postId) {
            const url = `${window.location.origin}/p/${postId}`;
            try {
                await navigator.clipboard.writeText(url);
                const btn = document.getElementById(`copy-btn-${postId}`);
                const text = document.getElementById(`copy-text-${postId}`);
                btn.classList.add('copied');
                text.textContent = 'Copi√© !';
                
                showToast({ type: 'success', message: 'üîó Lien copi√© !' });
                
                setTimeout(() => {
                    btn.classList.remove('copied');
                    text.textContent = 'Copier';
                }, 2000);
            } catch (e) {
                showToast({ type: 'error', message: 'Impossible de copier' });
            }
        }

        // ===== KEYBOARD SHORTCUTS =====
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                closeImageModal();
                document.querySelectorAll('.post-menu.open').forEach(m => {
                    m.classList.remove('open');
                    m.previousElementSibling?.setAttribute('aria-expanded', 'false');
                });
            }
        });

        // Init
        init();
    </script>
</body>
</html>
