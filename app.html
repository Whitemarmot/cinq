<!DOCTYPE html>
<html lang="fr">
<head>
    <!-- Accessibility: Viewport should allow user scaling for a11y -->
    <!-- Note: user-scalable=no kept for app-like experience, but consider removing for better a11y -->
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title data-i18n-title="app.yourSpace">Cinq — Ton espace intime</title>
    
    <!-- SEO -->
    <meta name="description" content="Cinq — Ton espace intime avec tes 5 proches. L'anti-réseau social sans algorithme, sans likes.">
    <meta name="robots" content="noindex, nofollow">
    
    <!-- Canonical -->
    <link rel="canonical" href="https://cinq.app/app">
    
    <!-- Open Graph -->
    <meta property="og:title" content="Cinq — Ton espace intime">
    <meta property="og:description" content="L'anti-réseau social. 5 proches, pas de likes.">
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://cinq.app/app">
    <meta property="og:image" content="https://cinq.app/og-image.png">
    <meta property="og:site_name" content="Cinq">
    <meta property="og:locale" content="fr_FR">
    
    <!-- Favicon & PWA -->
    <link rel="icon" type="image/svg+xml" href="/favicon.svg">
    <link rel="apple-touch-icon" sizes="180x180" href="/assets/icons/icon-192x192.png">
    <meta name="theme-color" content="#0e0e12" id="theme-color-meta">
    <link rel="manifest" href="/manifest.json">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Cinq">
    
    <!-- Google Fonts — Distinctive Typography -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;500;600;700&family=Inter:wght@400;500;600&display=swap" media="print" onload="this.media='all'">
    <noscript><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;500;600;700&family=Inter:wght@400;500;600&display=swap"></noscript>
    
    <!-- Critical CSS (inline for fastest FCP) -->
    <link rel="stylesheet" href="/css/critical.min.css">
    
    <!-- Design System (async load for non-critical CSS) -->
    <link rel="preload" href="/design/styles.min.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
    <noscript><link rel="stylesheet" href="/design/styles.min.css"></noscript>
    <link rel="stylesheet" href="/animations.min.css">
    <link rel="stylesheet" href="/css/mobile-responsive.min.css">
    <link rel="stylesheet" href="/css/a11y.min.css">
    
    <!-- Theme CSS for smooth transitions -->
    <link rel="stylesheet" href="/css/theme.css">
    
    <!-- Theme initialization (before body to prevent flash) -->
    <script src="/js/theme.js"></script>
    
    <!-- Shared utilities (escapeHtml, authHeaders, showToast, etc.) -->
    <script src="/js/shared.js"></script>
    
    <!-- Supabase Client for Realtime -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>
    
    <style>
        /* ===== ACCESSIBILITY: SKIP LINK ===== */
        .skip-link {
            position: absolute;
            top: -100%;
            left: 50%;
            transform: translateX(-50%);
            background: var(--cinq-gradient);
            color: white;
            padding: var(--space-3) var(--space-5);
            border-radius: var(--radius-lg);
            font-weight: 600;
            text-decoration: none;
            z-index: calc(var(--z-toast) + 1);
            transition: top 0.2s;
        }
        
        .skip-link:focus {
            top: var(--space-4);
            outline: 2px solid white;
            outline-offset: 2px;
        }
        
        /* ===== ACCESSIBILITY: FOCUS STYLES ===== */
        :focus-visible {
            outline: 2px solid var(--color-brand);
            outline-offset: 2px;
        }
        
        /* Remove default focus for mouse users, keep for keyboard */
        :focus:not(:focus-visible) {
            outline: none;
        }
        
        /* ===== ACCESSIBILITY: REDUCED MOTION ===== */
        @media (prefers-reduced-motion: reduce) {
            *, *::before, *::after {
                animation-duration: 0.01ms !important;
                animation-iteration-count: 1 !important;
                transition-duration: 0.01ms !important;
            }
            
            .tab-panel {
                animation: none !important;
            }
            
            .btn-ripple::after {
                display: none !important;
            }
        }
        
        /* ===== MICRO-ANIMATIONS: BUTTON RIPPLE ===== */
        .btn-ripple {
            position: relative;
            overflow: hidden;
            isolation: isolate;
        }
        
        .btn-ripple::after {
            content: '';
            position: absolute;
            inset: 0;
            background: radial-gradient(circle at var(--ripple-x, 50%) var(--ripple-y, 50%), rgba(255,255,255,0.3) 0%, transparent 60%);
            opacity: 0;
            transform: scale(0);
            pointer-events: none;
        }
        
        .btn-ripple.rippling::after {
            animation: ripple-effect 0.6s ease-out forwards;
        }
        
        @keyframes ripple-effect {
            0% { opacity: 1; transform: scale(0); }
            100% { opacity: 0; transform: scale(2.5); }
        }
        
        /* ===== MICRO-ANIMATIONS: BUTTON PRESS ===== */
        .btn-press {
            transition: transform 0.1s ease-out, box-shadow 0.15s ease;
        }
        
        .btn-press:active {
            transform: scale(0.96) !important;
        }
        
        /* ===== MICRO-ANIMATIONS: GLOW PULSE ON HOVER ===== */
        .glow-hover {
            position: relative;
        }
        
        .glow-hover::before {
            content: '';
            position: absolute;
            inset: -2px;
            border-radius: inherit;
            background: var(--cinq-gradient);
            opacity: 0;
            z-index: -1;
            filter: blur(8px);
            transition: opacity 0.3s ease;
        }
        
        .glow-hover:hover::before {
            opacity: 0.4;
            animation: glow-pulse 2s ease-in-out infinite;
        }
        
        @keyframes glow-pulse {
            0%, 100% { opacity: 0.3; filter: blur(8px); }
            50% { opacity: 0.5; filter: blur(12px); }
        }
        
        /* ===== HAPTIC FEEDBACK: VIBRATION PATTERNS ===== */
        @keyframes haptic-success {
            0%, 100% { transform: translateX(0); }
            10%, 30%, 50% { transform: translateX(-1px); }
            20%, 40% { transform: translateX(1px); }
        }
        
        @keyframes haptic-error {
            0%, 100% { transform: translateX(0); }
            10%, 30%, 50%, 70%, 90% { transform: translateX(-2px); }
            20%, 40%, 60%, 80% { transform: translateX(2px); }
        }
        
        @keyframes haptic-tap {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(0.98); }
        }
        
        .haptic-success { animation: haptic-success 0.4s ease-out; }
        .haptic-error { animation: haptic-error 0.5s ease-out; }
        .haptic-tap { animation: haptic-tap 0.15s ease-out; }
        
        /* ===== ACTION FEEDBACK: LIKE/HEART BURST ===== */
        @keyframes heart-burst {
            0% { transform: scale(1); }
            15% { transform: scale(1.3); }
            30% { transform: scale(0.95); }
            45% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }
        
        .heart-burst {
            animation: heart-burst 0.5s ease-out;
        }
        
        /* ===== ACTION FEEDBACK: SEND FLY ===== */
        @keyframes send-fly {
            0% { transform: translateX(0) scale(1); opacity: 1; }
            100% { transform: translateX(30px) translateY(-10px) scale(0.5); opacity: 0; }
        }
        
        .send-fly {
            animation: send-fly 0.4s ease-out forwards;
        }
        
        /* ===== ACTION FEEDBACK: SUCCESS CHECK ===== */
        @keyframes success-check {
            0% { stroke-dashoffset: 24; }
            100% { stroke-dashoffset: 0; }
        }
        
        .success-check {
            stroke-dasharray: 24;
            animation: success-check 0.4s ease-out forwards;
        }
        
        /* ===== STAGGERED REVEAL ANIMATIONS ===== */
        @keyframes stagger-fade-up {
            0% { opacity: 0; transform: translateY(20px); }
            100% { opacity: 1; transform: translateY(0); }
        }
        
        .stagger-reveal > * {
            opacity: 0;
            animation: stagger-fade-up 0.4s ease-out forwards;
        }
        
        .stagger-reveal > *:nth-child(1) { animation-delay: 0ms; }
        .stagger-reveal > *:nth-child(2) { animation-delay: 50ms; }
        .stagger-reveal > *:nth-child(3) { animation-delay: 100ms; }
        .stagger-reveal > *:nth-child(4) { animation-delay: 150ms; }
        .stagger-reveal > *:nth-child(5) { animation-delay: 200ms; }
        .stagger-reveal > *:nth-child(n+6) { animation-delay: 250ms; }
        
        /* ===== ELEMENT ENTRANCE ANIMATIONS ===== */
        @keyframes slide-up-fade {
            0% { opacity: 0; transform: translateY(16px); }
            100% { opacity: 1; transform: translateY(0); }
        }
        
        @keyframes slide-in-right {
            0% { opacity: 0; transform: translateX(20px); }
            100% { opacity: 1; transform: translateX(0); }
        }
        
        @keyframes scale-in {
            0% { opacity: 0; transform: scale(0.9); }
            100% { opacity: 1; transform: scale(1); }
        }
        
        @keyframes pop-in {
            0% { opacity: 0; transform: scale(0.8); }
            60% { transform: scale(1.05); }
            100% { opacity: 1; transform: scale(1); }
        }
        
        .animate-slide-up { animation: slide-up-fade 0.35s ease-out forwards; }
        .animate-slide-right { animation: slide-in-right 0.35s ease-out forwards; }
        .animate-scale-in { animation: scale-in 0.3s ease-out forwards; }
        .animate-pop-in { animation: pop-in 0.4s var(--ease-spring) forwards; }
        
        /* ===== ACCESSIBILITY: SCREEN READER ONLY ===== */
        .sr-only {
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0, 0, 0, 0);
            white-space: nowrap;
            border: 0;
        }
        
        /* ===== APP SHELL ===== */
        .app-shell {
            min-height: 100vh;
            min-height: 100dvh;
            display: flex;
            flex-direction: column;
        }
        
        /* ===== PROFESSIONAL HEADER ===== */
        .app-header {
            position: sticky;
            top: 0;
            z-index: var(--z-sticky);
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: var(--space-3) var(--space-5);
            background: var(--glass-bg);
            backdrop-filter: blur(24px) saturate(180%);
            -webkit-backdrop-filter: blur(24px) saturate(180%);
            border-bottom: 1px solid var(--color-border-subtle);
            transition: all 0.3s var(--ease-out-expo);
        }
        
        /* Subtle gradient line at bottom */
        .app-header::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 1px;
            background: linear-gradient(90deg, 
                transparent 0%, 
                var(--color-brand) 20%, 
                var(--cinq-coral-light) 50%, 
                var(--color-brand) 80%, 
                transparent 100%);
            opacity: 0.3;
        }
        
        /* Scrolled state */
        .app-header.scrolled {
            padding: var(--space-2) var(--space-5);
            box-shadow: 0 4px 24px -4px rgba(0, 0, 0, 0.12);
        }
        
        .app-header.scrolled::after {
            opacity: 0.5;
        }
        
        /* ===== HEADER LOGO AREA ===== */
        .header-brand {
            display: flex;
            align-items: center;
            gap: var(--space-3);
            text-decoration: none;
            position: relative;
        }
        
        .header-brand:hover .header-logo-icon {
            transform: scale(1.05) rotate(5deg);
        }
        
        .header-brand:hover .header-logo-text {
            letter-spacing: 0.02em;
        }
        
        /* Logo icon container */
        .header-logo-icon {
            position: relative;
            width: 38px;
            height: 38px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: transform 0.3s var(--ease-spring);
        }
        
        /* Pentagon background glow */
        .header-logo-icon::before {
            content: '';
            position: absolute;
            inset: -4px;
            background: var(--cinq-gradient);
            clip-path: polygon(50% 0%, 100% 38%, 82% 100%, 18% 100%, 0% 38%);
            opacity: 0.15;
            filter: blur(8px);
            animation: logo-pulse 4s ease-in-out infinite;
        }
        
        @keyframes logo-pulse {
            0%, 100% { opacity: 0.15; transform: scale(1); }
            50% { opacity: 0.25; transform: scale(1.08); }
        }
        
        /* The "5" number */
        .header-logo-number {
            font-family: var(--font-display, 'Space Grotesk', sans-serif);
            font-size: 1.5rem;
            font-weight: 700;
            background: var(--cinq-gradient);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            position: relative;
            z-index: 1;
            line-height: 1;
        }
        
        /* Logo text */
        .header-logo-text {
            font-family: var(--font-display, 'Space Grotesk', sans-serif);
            font-size: 1.125rem;
            font-weight: 600;
            color: var(--color-text-primary);
            letter-spacing: -0.01em;
            transition: letter-spacing 0.3s var(--ease-out-expo);
            position: relative;
        }
        
        /* Subtle dot separator */
        .header-logo-text::before {
            content: '';
            position: absolute;
            left: -10px;
            top: 50%;
            transform: translateY(-50%);
            width: 3px;
            height: 3px;
            background: var(--color-brand);
            border-radius: 50%;
            opacity: 0.6;
        }
        
        /* ===== CENTER NAV (optional, future-ready) ===== */
        .header-nav {
            display: none; /* Hidden for now, ready for future expansion */
            align-items: center;
            gap: var(--space-1);
        }
        
        @media (min-width: 768px) {
            .header-nav {
                display: flex;
            }
        }
        
        .header-nav-item {
            padding: var(--space-2) var(--space-4);
            font-family: var(--font-display, 'Space Grotesk', sans-serif);
            font-size: var(--text-sm);
            font-weight: 500;
            color: var(--color-text-muted);
            border-radius: var(--radius-lg);
            cursor: pointer;
            transition: all 0.2s var(--ease-out-expo);
            border: none;
            background: none;
            position: relative;
        }
        
        .header-nav-item:hover {
            color: var(--color-text-primary);
            background: var(--color-bg-hover);
        }
        
        .header-nav-item.active {
            color: var(--color-brand);
            background: var(--color-brand-muted);
        }
        
        /* ===== HEADER ACTIONS ===== */
        .header-actions {
            display: flex;
            align-items: center;
            gap: var(--space-2);
        }
        
        /* Action button base style */
        .header-action-btn {
            position: relative;
            width: 38px;
            height: 38px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--color-bg-tertiary);
            border: 1px solid var(--color-border);
            border-radius: var(--radius-lg);
            cursor: pointer;
            color: var(--color-text-muted);
            transition: all 0.2s var(--ease-out-expo);
        }
        
        .header-action-btn:hover {
            background: var(--color-bg-elevated);
            border-color: var(--color-border-active);
            color: var(--color-text-primary);
            transform: translateY(-1px);
        }
        
        .header-action-btn:active {
            transform: translateY(0) scale(0.95);
        }
        
        .header-action-btn svg {
            transition: transform 0.2s var(--ease-spring);
        }
        
        .header-action-btn:hover svg {
            transform: scale(1.1);
        }
        
        /* Theme toggle button */
        .theme-toggle {
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 38px;
            height: 38px;
            background: var(--color-bg-tertiary);
            border: 1px solid var(--color-border);
            border-radius: var(--radius-lg);
            cursor: pointer;
            transition: all 0.2s var(--ease-out-expo);
            overflow: hidden;
        }
        
        .theme-toggle:hover {
            background: var(--color-bg-elevated);
            border-color: var(--color-border-active);
            transform: translateY(-1px);
        }
        
        .theme-toggle:active {
            transform: translateY(0) scale(0.95);
        }
        
        .theme-toggle-icon {
            position: absolute;
            transition: transform 0.5s var(--ease-spring), opacity 0.3s;
            color: var(--color-text-muted);
        }
        
        .theme-toggle:hover .theme-toggle-icon {
            color: var(--color-text-primary);
        }
        
        .theme-toggle .icon-sun {
            transform: rotate(0) scale(1);
            opacity: 1;
        }
        
        .theme-toggle .icon-moon {
            transform: rotate(-90deg) scale(0);
            opacity: 0;
        }
        
        [data-theme="light"] .theme-toggle .icon-sun {
            transform: rotate(90deg) scale(0);
            opacity: 0;
        }
        
        [data-theme="light"] .theme-toggle .icon-moon {
            transform: rotate(0) scale(1);
            opacity: 1;
        }
        
        /* Notification button */
        .notification-btn {
            position: relative;
            width: 38px;
            height: 38px;
            border-radius: var(--radius-lg);
            background: var(--color-bg-tertiary);
            border: 1px solid var(--color-border);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s var(--ease-out-expo);
            color: var(--color-text-muted);
        }
        
        .notification-btn:hover {
            background: var(--color-bg-elevated);
            border-color: var(--color-border-active);
            color: var(--color-text-primary);
            transform: translateY(-1px);
        }
        
        .notification-btn:hover svg {
            animation: bell-ring 0.5s ease-in-out;
        }
        
        @keyframes bell-ring {
            0%, 100% { transform: rotate(0); }
            20% { transform: rotate(12deg); }
            40% { transform: rotate(-10deg); }
            60% { transform: rotate(6deg); }
            80% { transform: rotate(-4deg); }
        }
        
        .notification-btn:active {
            transform: translateY(0) scale(0.95);
        }
        
        .notification-badge {
            position: absolute;
            top: -3px;
            right: -3px;
            min-width: 18px;
            height: 18px;
            padding: 0 5px;
            border-radius: 9px;
            background: var(--color-error);
            color: white;
            font-size: 10px;
            font-weight: 700;
            display: flex;
            align-items: center;
            justify-content: center;
            animation: badge-pop 0.35s var(--ease-spring);
            box-shadow: 0 2px 8px var(--color-error-muted);
            border: 2px solid var(--color-bg-primary);
        }
        
        .notification-badge.hidden {
            display: none;
        }
        
        @keyframes badge-pop {
            0% { transform: scale(0); }
            60% { transform: scale(1.3); }
            100% { transform: scale(1); }
        }
        
        /* Header avatar */
        .header-avatar {
            width: 38px;
            height: 38px;
            min-width: 38px;
            min-height: 38px;
            max-width: 38px;
            max-height: 38px;
            border-radius: var(--radius-lg);
            background: var(--cinq-gradient);
            display: flex;
            align-items: center;
            justify-content: center;
            font-family: var(--font-display, 'Space Grotesk', sans-serif);
            font-size: 0.875rem;
            color: white;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s var(--ease-out-expo);
            overflow: hidden;
            flex-shrink: 0;
            position: relative;
            border: 2px solid transparent;
        }
        
        .header-avatar:hover {
            transform: translateY(-1px) scale(1.05);
            box-shadow: 0 4px 16px var(--color-brand-glow);
            border-color: rgba(255, 255, 255, 0.2);
        }
        
        .header-avatar:active {
            transform: translateY(0) scale(0.95);
        }
        
        .header-avatar:focus-visible {
            outline: 2px solid var(--color-brand);
            outline-offset: 2px;
        }
        
        .header-avatar img {
            width: 100%;
            height: 100%;
            max-width: 100%;
            max-height: 100%;
            object-fit: cover;
            position: absolute;
            inset: 0;
        }
        
        /* Status indicator on avatar */
        .header-avatar::after {
            content: '';
            position: absolute;
            bottom: -1px;
            right: -1px;
            width: 10px;
            height: 10px;
            background: var(--color-success);
            border-radius: 50%;
            border: 2px solid var(--color-bg-primary);
            opacity: 0;
            transition: opacity 0.2s;
        }
        
        .header-avatar.online::after {
            opacity: 1;
        }
        
        /* Divider between action groups */
        .header-divider {
            width: 1px;
            height: 20px;
            background: var(--color-border);
            margin: 0 var(--space-1);
        }
        
        /* ===== RESPONSIVE HEADER ===== */
        @media (max-width: 480px) {
            .app-header {
                padding: var(--space-2) var(--space-3);
            }
            
            .header-logo-text {
                display: none;
            }
            
            .header-logo-text::before {
                display: none;
            }
            
            .header-actions {
                gap: var(--space-1);
            }
            
            .header-action-btn,
            .theme-toggle,
            .notification-btn,
            .header-avatar {
                width: 36px;
                height: 36px;
                min-width: 36px;
                min-height: 36px;
            }
            
            .header-divider {
                display: none;
            }
        }
        
        /* ===== MAIN CONTENT ===== */
        .app-content {
            flex: 1;
            padding: var(--space-5);
            padding-bottom: calc(80px + env(safe-area-inset-bottom, var(--space-5)));
            max-width: 600px;
            margin: 0 auto;
            width: 100%;
        }
        
        /* ===== TAB PANELS ===== */
        .tab-panel {
            display: none;
            opacity: 0;
            transform: translateY(12px);
            transition: opacity 0.35s ease-out, transform 0.35s ease-out;
        }
        
        .tab-panel.active {
            display: block;
            opacity: 1;
            transform: translateY(0);
            animation: tab-enter 0.4s var(--ease-out-expo) forwards;
        }
        
        .tab-panel.exiting {
            animation: tab-exit 0.25s ease-in forwards;
        }
        
        @keyframes tab-enter {
            0% { 
                opacity: 0; 
                transform: translateY(16px) scale(0.98); 
            }
            100% { 
                opacity: 1; 
                transform: translateY(0) scale(1); 
            }
        }
        
        @keyframes tab-exit {
            0% { 
                opacity: 1; 
                transform: translateY(0) scale(1); 
            }
            100% { 
                opacity: 0; 
                transform: translateY(-8px) scale(0.98); 
            }
        }
        
        /* Tab slide direction variants */
        .tab-panel.slide-left {
            animation: tab-slide-left 0.4s var(--ease-out-expo) forwards;
        }
        
        .tab-panel.slide-right {
            animation: tab-slide-right 0.4s var(--ease-out-expo) forwards;
        }
        
        @keyframes tab-slide-left {
            0% { opacity: 0; transform: translateX(30px); }
            100% { opacity: 1; transform: translateX(0); }
        }
        
        @keyframes tab-slide-right {
            0% { opacity: 0; transform: translateX(-30px); }
            100% { opacity: 1; transform: translateX(0); }
        }
        
        /* ===== BOTTOM NAV ===== */
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            display: flex;
            justify-content: space-around;
            align-items: center;
            padding: var(--space-3) var(--space-4);
            padding-bottom: max(var(--space-3), env(safe-area-inset-bottom));
            background: var(--glass-bg);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border-top: 1px solid var(--color-border);
            z-index: var(--z-sticky);
        }
        
        .nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: var(--space-1);
            padding: var(--space-2) var(--space-4);
            border-radius: var(--radius-xl);
            cursor: pointer;
            transition: 
                color 0.2s ease,
                background 0.25s ease,
                transform 0.2s var(--ease-spring);
            color: var(--color-text-muted);
            background: transparent;
            border: none;
            font-family: var(--font-display, 'Space Grotesk', sans-serif);
            position: relative;
        }
        
        /* Active indicator pill */
        .nav-item::before {
            content: '';
            position: absolute;
            bottom: -2px;
            left: 50%;
            width: 4px;
            height: 4px;
            background: var(--color-brand);
            border-radius: 50%;
            transform: translateX(-50%) scale(0);
            transition: transform 0.3s var(--ease-spring);
        }
        
        .nav-item.active::before {
            transform: translateX(-50%) scale(1);
        }
        
        .nav-item:hover {
            color: var(--color-text-secondary);
            background: var(--color-bg-hover);
            transform: translateY(-3px);
        }
        
        .nav-item:active {
            transform: translateY(0) scale(0.92);
            transition-duration: 0.1s;
        }
        
        .nav-item.active {
            color: var(--color-brand);
            background: var(--color-brand-muted);
        }
        
        .nav-item.active:hover {
            transform: none;
        }
        
        /* Nav item tap feedback */
        .nav-item.tapped .nav-icon {
            animation: nav-icon-tap 0.3s ease-out;
        }
        
        @keyframes nav-icon-tap {
            0% { transform: scale(1); }
            30% { transform: scale(0.85); }
            60% { transform: scale(1.15); }
            100% { transform: scale(1); }
        }
        
        .nav-icon {
            width: 22px;
            height: 22px;
            transition: stroke 0.2s ease, transform 0.25s var(--ease-spring);
        }
        
        .nav-item:hover .nav-icon {
            transform: scale(1.12) translateY(-1px);
        }
        
        .nav-item.active .nav-icon {
            stroke: var(--color-brand);
            animation: nav-icon-active 0.4s var(--ease-spring);
        }
        
        @keyframes nav-icon-active {
            0% { transform: scale(1); }
            40% { transform: scale(1.2); }
            100% { transform: scale(1); }
        }
        
        .nav-label {
            font-size: var(--text-xs);
            font-weight: 500;
            transition: transform 0.2s ease, opacity 0.2s ease;
        }
        
        .nav-item.active .nav-label {
            font-weight: 600;
        }
        
        /* ===== FEED TAB ===== */
        .composer {
            background: var(--color-bg-secondary);
            border: 1px solid var(--color-border);
            border-radius: var(--radius-xl);
            padding: var(--space-4);
            margin-bottom: var(--space-5);
        }
        
        .composer-header {
            display: flex;
            align-items: center;
            gap: var(--space-3);
            margin-bottom: var(--space-3);
        }
        
        .composer-avatar {
            width: 40px;
            height: 40px;
            min-width: 40px;
            min-height: 40px;
            max-width: 40px;
            max-height: 40px;
            border-radius: 50%;
            background: var(--cinq-gradient);
            display: flex;
            align-items: center;
            justify-content: center;
            font-family: var(--font-display, 'Space Grotesk', sans-serif);
            font-size: 1rem;
            color: white;
            font-weight: 600;
            flex-shrink: 0;
            position: relative;
            overflow: hidden;
        }
        
        /* AVATAR IMG FIX: Constrain image inside composer avatar */
        .composer-avatar img {
            width: 100%;
            height: 100%;
            max-width: 100%;
            max-height: 100%;
            object-fit: cover;
            position: absolute;
            inset: 0;
        }
        
        .composer-user {
            font-weight: 600;
            font-size: var(--text-sm);
        }
        
        .composer-textarea {
            width: 100%;
            min-height: 80px;
            padding: var(--space-3);
            background: var(--color-bg-tertiary);
            border: 1px solid var(--color-border);
            border-radius: var(--radius-lg);
            color: var(--color-text-primary);
            font-size: var(--text-base);
            font-family: inherit;
            resize: vertical;
            transition: border-color 0.2s, box-shadow 0.2s;
        }
        
        .composer-textarea:focus {
            outline: none;
            border-color: var(--color-brand);
            box-shadow: 0 0 0 3px var(--color-brand-muted);
        }
        
        .composer-textarea::placeholder {
            color: var(--color-text-muted);
        }
        
        .composer-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: var(--space-3);
        }
        
        .composer-actions {
            display: flex;
            gap: var(--space-2);
        }
        
        .composer-btn {
            display: flex;
            align-items: center;
            gap: var(--space-2);
            padding: var(--space-2) var(--space-3);
            background: var(--color-bg-tertiary);
            border: 1px solid var(--color-border);
            border-radius: var(--radius-md);
            color: var(--color-text-muted);
            cursor: pointer;
            font-size: var(--text-sm);
            transition: 
                all 0.2s var(--ease-spring),
                background 0.2s,
                box-shadow 0.2s;
            position: relative;
            overflow: hidden;
        }
        
        .composer-btn:hover {
            background: var(--color-bg-hover);
            color: var(--color-text-primary);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        
        .composer-btn:hover svg {
            animation: icon-wiggle 0.4s ease-in-out;
        }
        
        @keyframes icon-wiggle {
            0%, 100% { transform: rotate(0); }
            25% { transform: rotate(-8deg); }
            75% { transform: rotate(8deg); }
        }
        
        .composer-btn:active {
            transform: translateY(0) scale(0.95);
            transition-duration: 0.1s;
        }
        
        .composer-btn.active {
            background: var(--color-brand-muted);
            border-color: var(--color-brand);
            color: var(--color-brand);
            animation: btn-activate 0.3s ease-out;
        }
        
        @keyframes btn-activate {
            0% { transform: scale(1); }
            50% { transform: scale(1.08); }
            100% { transform: scale(1); }
        }
        
        .char-count {
            font-size: var(--text-xs);
            color: var(--color-text-muted);
        }
        
        .char-count.warning { color: var(--color-warning); }
        .char-count.error { color: var(--color-error); }
        
        .post-btn {
            padding: var(--space-2) var(--space-5);
            background: var(--cinq-gradient);
            border: none;
            border-radius: var(--radius-lg);
            color: white;
            font-family: var(--font-display, 'Space Grotesk', sans-serif);
            font-weight: 600;
            cursor: pointer;
            transition: 
                transform 0.15s var(--ease-spring),
                box-shadow 0.2s,
                opacity 0.15s;
            box-shadow: 0 2px 8px var(--color-brand-glow);
            position: relative;
            overflow: hidden;
        }
        
        /* Shimmer effect */
        .post-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
            transition: left 0.5s;
        }
        
        .post-btn:hover:not(:disabled)::before {
            left: 100%;
        }
        
        .post-btn:hover:not(:disabled) {
            transform: translateY(-2px) scale(1.02);
            box-shadow: var(--shadow-glow);
        }
        
        .post-btn:active:not(:disabled) {
            transform: translateY(0) scale(0.98);
            box-shadow: 0 1px 4px var(--color-brand-glow);
        }
        
        .post-btn:disabled {
            opacity: 0.4;
            cursor: not-allowed;
            transform: none !important;
        }
        
        /* Image Preview */
        .image-preview {
            position: relative;
            margin-top: var(--space-3);
            border-radius: var(--radius-lg);
            overflow: hidden;
            display: none;
            opacity: 0;
            transform: scale(0.95) translateY(10px);
        }
        
        .image-preview.visible {
            display: block;
            animation: image-preview-in 0.4s var(--ease-spring) forwards;
        }
        
        @keyframes image-preview-in {
            0% { 
                opacity: 0; 
                transform: scale(0.9) translateY(15px); 
            }
            100% { 
                opacity: 1; 
                transform: scale(1) translateY(0); 
            }
        }
        
        .image-preview img {
            width: 100%;
            max-height: 300px;
            object-fit: cover;
        }
        
        .image-preview-remove {
            position: absolute;
            top: var(--space-2);
            right: var(--space-2);
            width: 28px;
            height: 28px;
            background: rgba(0, 0, 0, 0.7);
            border: none;
            border-radius: 50%;
            color: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .image-preview-remove:hover {
            background: var(--color-error);
        }
        
        /* Posts */
        .posts-list {
            display: flex;
            flex-direction: column;
            gap: var(--space-4);
        }
        
        .post-card {
            position: relative;
            background: var(--color-bg-secondary);
            border: 1px solid var(--color-border);
            border-radius: var(--radius-xl);
            padding: var(--space-4);
            transition: 
                border-color 0.25s ease,
                transform 0.3s var(--ease-out-expo),
                box-shadow 0.3s ease;
            animation: post-slide-in 0.5s var(--ease-out-expo) backwards;
        }
        
        .posts-list .post-card:nth-child(1) { animation-delay: 0ms; }
        .posts-list .post-card:nth-child(2) { animation-delay: 80ms; }
        .posts-list .post-card:nth-child(3) { animation-delay: 160ms; }
        .posts-list .post-card:nth-child(4) { animation-delay: 240ms; }
        .posts-list .post-card:nth-child(n+5) { animation-delay: 300ms; }
        
        @keyframes post-slide-in {
            0% { 
                opacity: 0; 
                transform: translateY(20px) scale(0.97); 
            }
            100% { 
                opacity: 1; 
                transform: translateY(0) scale(1); 
            }
        }
        
        .post-card:hover {
            border-color: var(--color-border-active);
            transform: translateY(-4px) scale(1.01);
            box-shadow: var(--shadow-lg);
        }
        
        .post-card:active {
            transform: translateY(-1px) scale(0.995);
            transition-duration: 0.1s;
        }
        
        /* New post highlight animation */
        .post-card.new-post {
            animation: new-post-glow 0.8s ease-out;
        }
        
        @keyframes new-post-glow {
            0% { 
                box-shadow: 0 0 0 0 var(--color-brand-glow); 
                transform: scale(0.95);
            }
            50% { 
                box-shadow: 0 0 20px 4px var(--color-brand-glow); 
            }
            100% { 
                box-shadow: var(--shadow-md); 
                transform: scale(1);
            }
        }
        
        /* Highlight gradient at top of card */
        .post-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: var(--space-4);
            right: var(--space-4);
            height: 1px;
            background: linear-gradient(90deg, transparent, var(--glass-highlight), transparent);
            opacity: 0.5;
        }
        
        .post-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: var(--space-3);
            position: relative;
        }
        
        .post-author {
            display: flex;
            align-items: center;
            gap: var(--space-3);
        }
        
        .post-avatar {
            width: 40px;
            height: 40px;
            min-width: 40px;
            min-height: 40px;
            max-width: 40px;
            max-height: 40px;
            border-radius: 50%;
            background: var(--cinq-gradient);
            display: flex;
            align-items: center;
            justify-content: center;
            font-family: var(--font-display, 'Space Grotesk', sans-serif);
            font-size: 1rem;
            color: white;
            font-weight: 600;
            overflow: hidden;
            flex-shrink: 0;
            position: relative;
        }
        
        .post-avatar.own {
            background: linear-gradient(135deg, #22c55e 0%, #16a34a 100%);
        }
        
        .post-avatar img {
            width: 100%;
            height: 100%;
            max-width: 100%;
            max-height: 100%;
            object-fit: cover;
            position: absolute;
            inset: 0;
        }
        
        .post-author-name {
            font-weight: 600;
            font-size: var(--text-sm);
        }
        
        .post-author-name .you-badge {
            font-size: var(--text-xs);
            font-weight: 500;
            color: var(--color-success);
            margin-left: var(--space-2);
        }
        
        .post-time {
            font-size: var(--text-xs);
            color: var(--color-text-muted);
        }
        
        .post-content {
            font-size: var(--text-base);
            line-height: 1.6;
            white-space: pre-wrap;
            word-break: break-word;
        }
        
        .post-image {
            margin-top: var(--space-3);
            border-radius: var(--radius-lg);
            overflow: hidden;
        }
        
        .post-image img {
            width: 100%;
            max-height: 400px;
            object-fit: cover;
            cursor: pointer;
            transition: opacity 0.3s ease;
        }
        
        /* Lazy loading states */
        .post-image img.lazy-image {
            opacity: 0;
        }
        
        .post-image img.lazy-image.loaded {
            opacity: 1;
        }
        
        .post-image img:hover {
            opacity: 0.9;
        }
        
        /* Lazy image container placeholder */
        .lazy-image-container {
            position: relative;
            min-height: 100px;
            background: var(--color-bg-tertiary);
        }
        
        .lazy-image-container::before {
            content: '';
            position: absolute;
            inset: 0;
            background: linear-gradient(
                90deg,
                var(--color-bg-tertiary) 25%,
                var(--color-bg-elevated) 50%,
                var(--color-bg-tertiary) 75%
            );
            background-size: 200% 100%;
            animation: lazy-shimmer 1.5s infinite;
            border-radius: var(--radius-lg);
        }
        
        .lazy-image-container.loaded::before {
            display: none;
        }
        
        @keyframes lazy-shimmer {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }
        
        /* Lazy loading for avatars */
        img.lazy-image {
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        
        img.lazy-image.loaded {
            opacity: 1;
        }
        
        .post-menu-btn {
            background: none;
            border: none;
            color: var(--color-text-muted);
            cursor: pointer;
            padding: var(--space-1);
            font-size: 1.25rem;
        }
        
        .post-menu-btn:hover {
            color: var(--color-text-primary);
        }
        
        .post-menu {
            position: absolute;
            right: 0;
            top: 100%;
            background: var(--color-bg-elevated);
            border: 1px solid var(--color-border);
            border-radius: var(--radius-lg);
            padding: var(--space-1);
            box-shadow: var(--shadow-lg);
            z-index: 50;
            display: none;
        }
        
        .post-menu.open {
            display: block;
        }
        
        .post-menu-item {
            display: flex;
            align-items: center;
            gap: var(--space-2);
            padding: var(--space-2) var(--space-3);
            background: none;
            border: none;
            color: var(--color-error);
            cursor: pointer;
            font-size: var(--text-sm);
            border-radius: var(--radius-md);
            width: 100%;
        }
        
        .post-menu-item:hover {
            background: var(--color-bg-hover);
        }
        
        .empty-state {
            text-align: center;
            padding: var(--space-12) var(--space-4);
            color: var(--color-text-muted);
            animation: empty-fade-in 0.6s ease-out;
        }
        
        @keyframes empty-fade-in {
            0% { opacity: 0; transform: translateY(20px); }
            100% { opacity: 1; transform: translateY(0); }
        }
        
        .empty-state-icon {
            font-size: 4rem;
            margin-bottom: var(--space-4);
            opacity: 0.5;
            animation: empty-icon-float 3s ease-in-out infinite;
        }
        
        @keyframes empty-icon-float {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-8px); }
        }
        
        .empty-state-title {
            font-size: var(--text-xl);
            font-weight: 600;
            color: var(--color-text-primary);
            margin-bottom: var(--space-2);
        }
        
        /* ===== TES 5 TAB ===== */
        .section-title {
            font-family: var(--font-display, 'Space Grotesk', sans-serif);
            font-size: var(--text-xl);
            font-weight: 600;
            letter-spacing: -0.02em;
            margin-bottom: var(--space-5);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .contact-count {
            font-size: var(--text-sm);
            color: var(--color-text-muted);
            font-weight: 500;
            background: var(--color-bg-secondary);
            padding: var(--space-1) var(--space-3);
            border-radius: var(--radius-full);
            border: 1px solid var(--color-border);
        }
        
        .contacts-grid {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: var(--space-3);
            margin-bottom: var(--space-6);
        }
        
        @media (max-width: 400px) {
            .contacts-grid {
                gap: var(--space-2);
            }
        }
        
        .contact-slot {
            aspect-ratio: 1;
            border-radius: var(--radius-2xl);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: 
                transform 0.25s var(--ease-spring), 
                box-shadow 0.3s ease, 
                border-color 0.2s ease,
                background 0.2s ease;
            position: relative;
            animation: contact-appear 0.4s var(--ease-spring) backwards;
        }
        
        .contacts-grid .contact-slot:nth-child(1) { animation-delay: 0ms; }
        .contacts-grid .contact-slot:nth-child(2) { animation-delay: 60ms; }
        .contacts-grid .contact-slot:nth-child(3) { animation-delay: 120ms; }
        .contacts-grid .contact-slot:nth-child(4) { animation-delay: 180ms; }
        .contacts-grid .contact-slot:nth-child(5) { animation-delay: 240ms; }
        
        @keyframes contact-appear {
            0% { opacity: 0; transform: scale(0.8) translateY(10px); }
            100% { opacity: 1; transform: scale(1) translateY(0); }
        }
        
        .contact-slot:hover {
            transform: translateY(-8px) scale(1.05);
            box-shadow: 0 12px 24px rgba(0,0,0,0.15);
        }
        
        .contact-slot:active {
            transform: translateY(-2px) scale(0.96);
            transition-duration: 0.1s;
        }
        
        .contact-slot.filled {
            background: var(--color-bg-secondary);
            border: 1px solid var(--color-border);
            box-shadow: var(--shadow-sm);
        }
        
        .contact-slot.filled:hover {
            border-color: var(--color-border-active);
            box-shadow: var(--shadow-lg);
        }
        
        /* Subtle gradient glow on hover */
        .contact-slot.filled::after {
            content: '';
            position: absolute;
            inset: -1px;
            border-radius: inherit;
            background: var(--cinq-gradient);
            opacity: 0;
            z-index: -1;
            transition: opacity 0.3s;
            mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0);
            mask-composite: exclude;
            padding: 1px;
        }
        
        .contact-slot.filled:hover::after {
            opacity: 0.4;
        }
        
        .contact-slot.empty {
            background: var(--color-bg-tertiary);
            border: 2px dashed var(--color-border);
        }
        
        .contact-slot.empty:hover {
            border-color: var(--color-brand);
            background: var(--color-brand-muted);
        }
        
        .contact-avatar-slot {
            width: 44px;
            height: 44px;
            min-width: 44px;
            min-height: 44px;
            max-width: 44px;
            max-height: 44px;
            border-radius: 50%;
            background: var(--cinq-gradient);
            display: flex;
            align-items: center;
            justify-content: center;
            font-family: var(--font-display, 'Space Grotesk', sans-serif);
            font-size: 1.25rem;
            color: white;
            font-weight: 600;
            transition: transform 0.2s var(--ease-spring);
            box-shadow: 0 2px 8px var(--color-brand-glow);
            overflow: hidden;
            flex-shrink: 0;
            position: relative;
        }
        
        .contact-avatar-slot img {
            width: 100%;
            height: 100%;
            max-width: 100%;
            max-height: 100%;
            object-fit: cover;
            position: absolute;
            inset: 0;
        }
        
        @media (max-width: 400px) {
            .contact-avatar-slot {
                width: 36px;
                height: 36px;
                min-width: 36px;
                min-height: 36px;
                max-width: 36px;
                max-height: 36px;
                font-size: 1rem;
            }
        }
        
        .contact-slot:hover .contact-avatar-slot {
            transform: scale(1.08);
        }
        
        .contact-name {
            font-size: var(--text-xs);
            margin-top: var(--space-1);
            color: var(--color-text-muted);
            text-align: center;
            max-width: 100%;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            padding: 0 4px;
            font-weight: 500;
        }
        
        .empty-plus {
            font-size: 1.75rem;
            color: var(--color-text-muted);
            font-weight: 300;
            transition: all 0.2s var(--ease-out-expo);
        }
        
        .contact-slot.empty:hover .empty-plus {
            color: var(--color-brand);
            transform: rotate(90deg) scale(1.1);
        }
        
        .unread-badge {
            position: absolute;
            top: -4px;
            right: -4px;
            min-width: 20px;
            height: 20px;
            background: var(--cinq-gradient);
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: var(--text-xs);
            font-weight: 700;
            color: white;
            padding: 0 5px;
            animation: badge-pop 0.35s var(--ease-spring);
            box-shadow: 0 2px 8px var(--color-brand-glow);
        }
        
        @keyframes badge-pop {
            0% { transform: scale(0); }
            100% { transform: scale(1); }
        }
        
        /* ===== SUGGESTIONS SECTION ===== */
        .suggestions-section {
            margin-top: var(--space-6);
            padding-top: var(--space-6);
            border-top: 1px solid var(--color-border);
        }
        
        .suggestions-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: var(--space-4);
        }
        
        .suggestions-title {
            font-size: var(--text-base);
            font-weight: 600;
            color: var(--color-text);
            display: flex;
            align-items: center;
            gap: var(--space-2);
        }
        
        .suggestions-title svg {
            color: var(--color-brand);
        }
        
        .suggestions-empty {
            text-align: center;
            padding: var(--space-6);
            color: var(--color-text-muted);
            font-size: var(--text-sm);
        }
        
        .suggestion-card {
            display: flex;
            align-items: center;
            gap: var(--space-3);
            padding: var(--space-4);
            background: var(--color-bg-secondary);
            border: 1px solid var(--color-border);
            border-radius: var(--radius-xl);
            margin-bottom: var(--space-3);
            transition: all 0.3s ease, transform 0.3s ease, opacity 0.3s ease;
            animation: slide-up-fade 0.4s ease-out backwards;
        }
        
        .suggestion-card:hover {
            border-color: var(--color-border-active);
            box-shadow: var(--shadow-md);
        }
        
        .suggestion-card:nth-child(1) { animation-delay: 0ms; }
        .suggestion-card:nth-child(2) { animation-delay: 60ms; }
        .suggestion-card:nth-child(3) { animation-delay: 120ms; }
        
        .suggestion-avatar {
            width: 48px;
            height: 48px;
            min-width: 48px;
            border-radius: var(--radius-full);
            background: var(--color-bg-tertiary);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            color: var(--color-text);
            font-size: 1.1rem;
            overflow: hidden;
        }
        
        .suggestion-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .suggestion-info {
            flex: 1;
            min-width: 0;
        }
        
        .suggestion-name {
            font-weight: 600;
            color: var(--color-text);
            font-size: var(--text-sm);
            margin-bottom: 2px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        
        .suggestion-mutual {
            font-size: var(--text-xs);
            color: var(--color-text-muted);
            display: flex;
            align-items: center;
            gap: var(--space-1);
        }
        
        .suggestion-mutual-avatars {
            display: flex;
            margin-right: var(--space-1);
        }
        
        .suggestion-mutual-avatars .mini-avatar {
            width: 18px;
            height: 18px;
            border-radius: var(--radius-full);
            background: var(--color-bg-tertiary);
            border: 2px solid var(--color-bg-secondary);
            margin-left: -6px;
            font-size: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            overflow: hidden;
        }
        
        .suggestion-mutual-avatars .mini-avatar:first-child {
            margin-left: 0;
        }
        
        .suggestion-mutual-avatars .mini-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .suggestion-actions {
            display: flex;
            gap: var(--space-2);
        }
        
        .suggestion-btn {
            width: 36px;
            height: 36px;
            border-radius: var(--radius-full);
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
        }
        
        .suggestion-btn.add {
            background: var(--cinq-gradient);
            color: white;
        }
        
        .suggestion-btn.add:hover {
            transform: scale(1.1);
            box-shadow: 0 4px 12px var(--color-brand-glow);
        }
        
        .suggestion-btn.ignore {
            background: var(--color-bg-tertiary);
            color: var(--color-text-muted);
        }
        
        .suggestion-btn.ignore:hover {
            background: var(--color-danger);
            color: white;
        }
        
        .suggestion-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        @media (max-width: 400px) {
            .suggestion-avatar {
                width: 40px;
                height: 40px;
                min-width: 40px;
            }
            
            .suggestion-btn {
                width: 32px;
                height: 32px;
            }
        }
        
        .action-btn {
            display: flex;
            align-items: center;
            gap: var(--space-4);
            padding: var(--space-4) var(--space-5);
            background: var(--color-bg-secondary);
            border: 1px solid var(--color-border);
            border-radius: var(--radius-xl);
            cursor: pointer;
            transition: 
                all 0.2s var(--ease-spring),
                background 0.2s;
            width: 100%;
            text-align: left;
            color: inherit;
            text-decoration: none;
            font-family: var(--font-display, 'Space Grotesk', sans-serif);
            position: relative;
            overflow: hidden;
        }
        
        /* Subtle gradient border on hover */
        .action-btn::after {
            content: '';
            position: absolute;
            inset: -1px;
            border-radius: inherit;
            background: var(--cinq-gradient);
            opacity: 0;
            z-index: -1;
            transition: opacity 0.3s;
            mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0);
            mask-composite: exclude;
            padding: 1px;
        }
        
        .action-btn:hover {
            background: var(--color-bg-tertiary);
            border-color: var(--color-border-active);
            transform: translateX(6px);
        }
        
        .action-btn:hover::after {
            opacity: 0.5;
        }
        
        .action-btn:active {
            transform: translateX(3px) scale(0.99);
        }
        
        .action-icon {
            font-size: 1.5rem;
        }
        
        .action-title {
            font-weight: 600;
            margin-bottom: 2px;
        }
        
        .action-subtitle {
            font-size: var(--text-xs);
            color: var(--color-text-muted);
        }
        
        /* ===== PROFIL TAB ===== */
        .profile-header {
            text-align: center;
            margin-bottom: var(--space-8);
        }
        
        /* AVATAR BUG FIX: Strict size constraints to prevent giant avatar on desktop */
        .profile-avatar {
            width: 100px;
            height: 100px;
            min-width: 100px;
            min-height: 100px;
            max-width: 100px;
            max-height: 100px;
            border-radius: 50%;
            background: var(--cinq-gradient);
            display: flex;
            align-items: center;
            justify-content: center;
            font-family: var(--font-display, 'Space Grotesk', sans-serif);
            font-size: 2.5rem;
            color: white;
            font-weight: 600;
            margin: 0 auto var(--space-4);
            cursor: pointer;
            position: relative;
            overflow: hidden;
            transition: transform 0.2s var(--ease-spring), box-shadow 0.2s;
            box-shadow: var(--shadow-glow-sm);
            flex-shrink: 0;
        }
        
        .profile-avatar:hover {
            transform: scale(1.05);
            box-shadow: var(--shadow-glow);
        }
        
        .profile-avatar:active {
            transform: scale(0.98);
        }
        
        /* CRITICAL: Image must stay contained within avatar bounds */
        .profile-avatar img {
            width: 100%;
            height: 100%;
            max-width: 100%;
            max-height: 100%;
            object-fit: cover;
            position: absolute;
            inset: 0;
        }
        
        .profile-avatar-overlay {
            position: absolute;
            inset: 0;
            background: rgba(0,0,0,0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            transition: opacity 0.2s;
            font-size: 1.5rem;
        }
        
        .profile-avatar:hover .profile-avatar-overlay {
            opacity: 1;
        }
        
        .profile-name {
            font-family: var(--font-display, 'Space Grotesk', sans-serif);
            font-size: var(--text-2xl);
            font-weight: 700;
            letter-spacing: -0.02em;
            margin-bottom: var(--space-1);
        }
        
        .profile-bio {
            color: var(--color-text-muted);
            font-size: var(--text-sm);
        }
        
        .settings-card {
            background: var(--color-bg-secondary);
            border: 1px solid var(--color-border);
            border-radius: var(--radius-xl);
            padding: var(--space-5);
            margin-bottom: var(--space-4);
        }
        
        .settings-card-header {
            display: flex;
            align-items: center;
            gap: var(--space-3);
            margin-bottom: var(--space-4);
            font-weight: 600;
        }
        
        .settings-card-header span:first-child {
            font-size: 1.25rem;
        }
        
        .settings-field {
            margin-bottom: var(--space-4);
        }
        
        .settings-field:last-child {
            margin-bottom: 0;
        }
        
        .settings-label {
            display: block;
            font-size: var(--text-xs);
            color: var(--color-text-muted);
            margin-bottom: var(--space-2);
            font-weight: 500;
        }
        
        .settings-input {
            width: 100%;
            padding: var(--space-3) var(--space-4);
            background: var(--color-bg-tertiary);
            border: 1px solid var(--color-border);
            border-radius: var(--radius-lg);
            color: var(--color-text-primary);
            font-size: var(--text-base);
            transition: all 0.15s;
        }
        
        .settings-input:focus {
            outline: none;
            border-color: var(--color-brand);
            box-shadow: 0 0 0 3px var(--color-brand-muted);
        }
        
        .settings-input::placeholder {
            color: var(--color-text-muted);
        }
        
        .save-btn {
            width: 100%;
            padding: var(--space-3) var(--space-5);
            background: var(--cinq-gradient);
            color: white;
            border: none;
            border-radius: var(--radius-lg);
            cursor: pointer;
            font-family: var(--font-display, 'Space Grotesk', sans-serif);
            font-weight: 600;
            transition: 
                transform 0.15s var(--ease-spring),
                box-shadow 0.2s;
            box-shadow: 0 2px 8px var(--color-brand-glow);
            position: relative;
            overflow: hidden;
        }
        
        .save-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
            transition: left 0.5s;
        }
        
        .save-btn:hover:not(:disabled)::before {
            left: 100%;
        }
        
        .save-btn:hover:not(:disabled) {
            transform: translateY(-2px) scale(1.01);
            box-shadow: var(--shadow-glow);
        }
        
        .save-btn:active:not(:disabled) {
            transform: translateY(0) scale(0.98);
        }
        
        .save-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .settings-btn {
            display: flex;
            align-items: center;
            gap: var(--space-3);
            padding: var(--space-3) var(--space-4);
            background: var(--color-bg-tertiary);
            border: 1px solid var(--color-border);
            border-radius: var(--radius-lg);
            cursor: pointer;
            color: var(--color-text-primary);
            font-size: var(--text-sm);
            transition: 
                all 0.15s var(--ease-spring),
                background 0.2s;
            width: 100%;
            text-align: left;
            margin-bottom: var(--space-3);
        }
        
        .settings-btn:last-child {
            margin-bottom: 0;
        }
        
        .settings-btn:hover {
            background: var(--color-bg-elevated);
            border-color: var(--color-border-active);
            transform: translateX(4px);
        }
        
        .settings-btn:active {
            transform: translateX(2px) scale(0.99);
        }
        
        .settings-btn-danger {
            background: var(--color-error-muted);
            border-color: var(--color-error);
            color: var(--color-error);
        }
        
        .settings-btn-danger:hover {
            background: rgba(248, 113, 113, 0.18);
        }
        
        .settings-btn-info {
            flex: 1;
        }
        
        .settings-btn-title {
            font-weight: 600;
            display: block;
        }
        
        .settings-btn-subtitle {
            font-size: var(--text-xs);
            color: var(--color-text-muted);
            margin-top: 2px;
        }
        
        .settings-btn-danger .settings-btn-subtitle {
            color: inherit;
            opacity: 0.8;
        }
        
        /* ===== CHAT PANEL ===== */
        .chat-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(4px);
            -webkit-backdrop-filter: blur(4px);
            opacity: 0;
            visibility: hidden;
            transition: all 0.25s;
            z-index: calc(var(--z-modal) - 1);
        }
        
        .chat-overlay.open {
            opacity: 1;
            visibility: visible;
        }
        
        .chat-panel {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: var(--color-bg-primary);
            border-top: 1px solid var(--color-border);
            transform: translateY(100%);
            transition: transform 0.4s var(--ease-out-expo);
            max-height: 85vh;
            max-height: 85dvh;
            display: flex;
            flex-direction: column;
            border-radius: var(--radius-2xl) var(--radius-2xl) 0 0;
            z-index: var(--z-modal);
            box-shadow: 0 -10px 40px rgba(0, 0, 0, 0.5);
        }
        
        .chat-panel.open {
            transform: translateY(0);
            animation: chat-slide-up 0.45s var(--ease-out-expo);
        }
        
        @keyframes chat-slide-up {
            0% { 
                transform: translateY(100%); 
            }
            60% { 
                transform: translateY(-3%); 
            }
            100% { 
                transform: translateY(0); 
            }
        }
        
        .chat-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: var(--space-5);
            border-bottom: 1px solid var(--color-border);
            background: var(--color-bg-secondary);
            border-radius: var(--radius-2xl) var(--radius-2xl) 0 0;
        }
        
        .chat-contact-info {
            display: flex;
            align-items: center;
            gap: var(--space-3);
        }
        
        .chat-contact-avatar {
            width: 36px;
            height: 36px;
            min-width: 36px;
            min-height: 36px;
            max-width: 36px;
            max-height: 36px;
            border-radius: 50%;
            background: var(--cinq-gradient);
            display: flex;
            align-items: center;
            justify-content: center;
            font-family: var(--font-display, 'Space Grotesk', sans-serif);
            font-size: var(--text-base);
            color: white;
            font-weight: 600;
            box-shadow: 0 2px 8px var(--color-brand-glow);
            overflow: hidden;
            flex-shrink: 0;
            position: relative;
        }
        
        .chat-contact-avatar img {
            width: 100%;
            height: 100%;
            max-width: 100%;
            max-height: 100%;
            object-fit: cover;
            position: absolute;
            inset: 0;
        }
        
        .chat-contact-name {
            font-weight: 600;
        }
        
        .chat-close {
            background: var(--color-bg-tertiary);
            border: 1px solid var(--color-border);
            font-size: 1.25rem;
            cursor: pointer;
            color: var(--color-text-muted);
            transition: all 0.2s;
            padding: var(--space-2);
            border-radius: var(--radius-lg);
            width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .chat-close:hover {
            color: var(--color-text-primary);
            background: var(--color-bg-elevated);
            transform: rotate(90deg);
        }
        
        .chat-messages {
            flex: 1;
            overflow-y: auto;
            overflow-x: hidden;
            padding: var(--space-5);
            padding-bottom: var(--space-3);
            min-height: 280px;
            display: flex;
            flex-direction: column;
            gap: var(--space-2);
            scroll-behavior: smooth;
            overscroll-behavior: contain;
            -webkit-overflow-scrolling: touch;
        }
        
        /* Custom scrollbar for chat */
        .chat-messages::-webkit-scrollbar {
            width: 6px;
        }
        
        .chat-messages::-webkit-scrollbar-track {
            background: transparent;
        }
        
        .chat-messages::-webkit-scrollbar-thumb {
            background: var(--color-border);
            border-radius: 3px;
        }
        
        .chat-messages::-webkit-scrollbar-thumb:hover {
            background: var(--color-text-muted);
        }
        
        /* Empty state */
        .chat-messages:not(:has(.chat-message)):not(:has(.chat-date-separator))::before {
            content: 'Premier message ? À toi de jouer 👋';
            text-align: center;
            color: var(--color-text-muted);
            margin: auto;
            padding: var(--space-8);
        }
        
        /* Fallback for browsers without :has() */
        .chat-messages-empty {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 100%;
            color: var(--color-text-muted);
            text-align: center;
            padding: var(--space-8);
        }
        
        .chat-message {
            max-width: 75%;
            padding: var(--space-3) var(--space-4);
            padding-bottom: var(--space-2);
            border-radius: var(--radius-xl);
            animation: message-in 0.35s cubic-bezier(0.34, 1.56, 0.64, 1) backwards;
            word-wrap: break-word;
            font-size: var(--text-base);
            line-height: 1.5;
            transition: transform 0.15s ease-out, box-shadow 0.2s ease;
            position: relative;
        }
        
        .chat-message-content {
            margin-bottom: var(--space-1);
        }
        
        .chat-message-meta {
            display: flex;
            align-items: center;
            justify-content: flex-end;
            gap: var(--space-2);
            font-size: 10px;
            opacity: 0.7;
            margin-top: var(--space-1);
        }
        
        .chat-message.received .chat-message-meta {
            justify-content: flex-start;
        }
        
        .chat-message-time {
            font-weight: 500;
        }
        
        /* Read receipts - WhatsApp style checkmarks */
        .chat-read-receipt {
            display: inline-flex;
            align-items: center;
            gap: 1px;
        }
        
        .chat-read-receipt svg {
            width: 14px;
            height: 14px;
        }
        
        .chat-read-receipt.sent svg {
            opacity: 0.7;
        }
        
        .chat-read-receipt.delivered svg {
            opacity: 0.7;
        }
        
        .chat-read-receipt.read svg {
            color: #53bdeb;
        }
        
        @keyframes message-in {
            0% { 
                opacity: 0; 
                transform: translateY(12px) scale(0.95); 
            }
            100% { 
                opacity: 1; 
                transform: translateY(0) scale(1); 
            }
        }
        
        .chat-message:hover {
            transform: scale(1.01);
        }
        
        .chat-message:active {
            transform: scale(0.99);
        }
        
        .chat-message.sent {
            background: var(--cinq-gradient);
            color: white;
            margin-left: auto;
            border-bottom-right-radius: 4px;
            box-shadow: 0 2px 12px var(--color-brand-glow);
            animation-name: message-in-sent;
        }
        
        /* Bubble tail for sent messages */
        .chat-message.sent::after {
            content: '';
            position: absolute;
            right: -6px;
            bottom: 0;
            width: 12px;
            height: 12px;
            background: linear-gradient(135deg, transparent 50%, #ff6b4a 50%);
            border-bottom-left-radius: 4px;
        }
        
        @keyframes message-in-sent {
            0% { 
                opacity: 0; 
                transform: translateX(16px) scale(0.95); 
            }
            100% { 
                opacity: 1; 
                transform: translateX(0) scale(1); 
            }
        }
        
        .chat-message.sent:hover {
            box-shadow: 0 4px 20px var(--color-brand-glow);
        }
        
        .chat-message.sent .chat-message-meta {
            color: rgba(255, 255, 255, 0.85);
        }
        
        .chat-message.received {
            background: var(--color-bg-elevated);
            border: 1px solid var(--color-border);
            border-bottom-left-radius: 4px;
            animation-name: message-in-received;
        }
        
        /* Bubble tail for received messages */
        .chat-message.received::after {
            content: '';
            position: absolute;
            left: -6px;
            bottom: 0;
            width: 12px;
            height: 12px;
            background: linear-gradient(-135deg, transparent 50%, var(--color-bg-elevated) 50%);
            border-bottom-right-radius: 4px;
        }
        
        @keyframes message-in-received {
            0% { 
                opacity: 0; 
                transform: translateX(-16px) scale(0.95); 
            }
            100% { 
                opacity: 1; 
                transform: translateX(0) scale(1); 
            }
        }
        
        .chat-message.ping {
            text-align: center;
            max-width: 100%;
            background: none;
            font-size: 2.75rem;
            animation: ping-bounce 0.6s var(--ease-spring);
            padding: var(--space-2);
        }
        
        .chat-message.ping::after {
            display: none;
        }
        
        @keyframes ping-bounce {
            0% { transform: scale(0.5) rotate(-10deg); opacity: 0; }
            40% { transform: scale(1.3) rotate(5deg); opacity: 1; }
            60% { transform: scale(0.95) rotate(-3deg); }
            80% { transform: scale(1.1) rotate(2deg); }
            100% { transform: scale(1) rotate(0); }
        }
        
        /* ===== TYPING INDICATOR ===== */
        .typing-indicator {
            display: none;
            align-items: center;
            justify-content: center;
            gap: 4px;
            padding: var(--space-3) var(--space-4);
            background: var(--color-bg-elevated);
            border: 1px solid var(--color-border);
            border-radius: var(--radius-xl);
            border-bottom-left-radius: 4px;
            width: fit-content;
            min-width: 60px;
            animation: typing-appear 0.3s ease-out;
            position: relative;
            margin-top: var(--space-1);
        }
        
        .typing-indicator.visible {
            display: flex;
        }
        
        @keyframes typing-appear {
            0% {
                opacity: 0;
                transform: translateX(-10px) scale(0.9);
            }
            100% {
                opacity: 1;
                transform: translateX(0) scale(1);
            }
        }
        
        .typing-indicator::after {
            content: '';
            position: absolute;
            left: -6px;
            bottom: 0;
            width: 12px;
            height: 12px;
            background: linear-gradient(-135deg, transparent 50%, var(--color-bg-elevated) 50%);
            border-bottom-right-radius: 4px;
        }
        
        .typing-dot {
            width: 7px;
            height: 7px;
            background: var(--color-text-muted);
            border-radius: 50%;
            animation: typing-bounce 1.4s infinite ease-in-out both;
        }
        
        .typing-dot:nth-child(1) { animation-delay: 0s; }
        .typing-dot:nth-child(2) { animation-delay: 0.16s; }
        .typing-dot:nth-child(3) { animation-delay: 0.32s; }
        
        @keyframes typing-bounce {
            0%, 60%, 100% { 
                transform: translateY(0);
                opacity: 0.4;
            }
            30% { 
                transform: translateY(-5px);
                opacity: 1;
            }
        }
        
        /* ===== DATE SEPARATOR ===== */
        .chat-date-separator {
            text-align: center;
            padding: var(--space-3) 0;
            position: relative;
        }
        
        .chat-date-separator::before {
            content: '';
            position: absolute;
            left: 0;
            right: 0;
            top: 50%;
            height: 1px;
            background: var(--color-border);
        }
        
        .chat-date-separator span {
            position: relative;
            background: var(--color-bg-primary);
            padding: var(--space-1) var(--space-3);
            font-size: 11px;
            color: var(--color-text-muted);
            font-weight: 500;
            border-radius: var(--radius-full);
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }
        
        .chat-input-area {
            display: flex;
            gap: var(--space-2);
            padding: var(--space-5);
            border-top: 1px solid var(--color-border);
            padding-bottom: max(var(--space-5), env(safe-area-inset-bottom));
            background: var(--color-bg-secondary);
        }
        
        .chat-input {
            flex: 1;
            padding: var(--space-3) var(--space-4);
            background: var(--color-bg-tertiary);
            border: 1px solid var(--color-border);
            border-radius: var(--radius-full);
            color: var(--color-text-primary);
            font-size: var(--text-base);
            transition: all 0.15s;
        }
        
        .chat-input:focus {
            outline: none;
            border-color: var(--color-brand);
            box-shadow: 0 0 0 3px var(--color-brand-muted);
        }
        
        .chat-send {
            padding: var(--space-3) var(--space-4);
            background: var(--cinq-gradient);
            border: none;
            border-radius: var(--radius-full);
            color: white;
            cursor: pointer;
            font-size: 1.125rem;
            transition: 
                transform 0.2s var(--ease-spring),
                box-shadow 0.25s ease;
            box-shadow: 0 2px 8px var(--color-brand-glow);
            position: relative;
            overflow: hidden;
        }
        
        .chat-send::after {
            content: '';
            position: absolute;
            inset: 0;
            background: rgba(255,255,255,0.3);
            transform: translateX(-100%);
            transition: transform 0.3s ease;
        }
        
        .chat-send:hover:not(:disabled)::after {
            transform: translateX(100%);
        }
        
        .chat-send:hover:not(:disabled) {
            transform: scale(1.1) rotate(8deg);
            box-shadow: var(--shadow-glow-sm), 0 0 20px var(--color-brand-glow);
        }
        
        .chat-send:active:not(:disabled) {
            transform: scale(0.9) rotate(-5deg);
            transition-duration: 0.1s;
        }
        
        .chat-send.sending {
            animation: send-pulse 0.5s ease-out;
        }
        
        @keyframes send-pulse {
            0% { transform: scale(1); }
            30% { transform: scale(0.85) rotate(-10deg); }
            60% { transform: scale(1.15) rotate(5deg); }
            100% { transform: scale(1) rotate(0); }
        }
        
        .chat-send:disabled {
            opacity: 0.4;
            cursor: not-allowed;
        }
        
        .ping-btn {
            padding: var(--space-3);
            background: var(--color-bg-tertiary);
            border: 1px solid var(--color-border);
            border-radius: var(--radius-full);
            cursor: pointer;
            font-size: 1.25rem;
            transition: 
                all 0.2s var(--ease-spring),
                background 0.2s;
            position: relative;
        }
        
        .ping-btn::before {
            content: '';
            position: absolute;
            inset: -4px;
            border-radius: 50%;
            background: var(--cinq-gradient);
            opacity: 0;
            z-index: -1;
            transition: opacity 0.3s ease, transform 0.3s ease;
            transform: scale(0.8);
        }
        
        .ping-btn:hover {
            background: var(--color-brand-muted);
            border-color: var(--color-brand);
            transform: scale(1.15) rotate(-8deg);
        }
        
        .ping-btn:hover::before {
            opacity: 0.3;
            transform: scale(1);
            animation: ping-glow 1s ease-in-out infinite;
        }
        
        @keyframes ping-glow {
            0%, 100% { opacity: 0.2; transform: scale(1); }
            50% { opacity: 0.4; transform: scale(1.1); }
        }
        
        .ping-btn:active {
            transform: scale(0.85);
            transition-duration: 0.1s;
        }
        
        .ping-btn.pinged {
            animation: ping-burst 0.6s var(--ease-spring);
        }
        
        @keyframes ping-burst {
            0% { transform: scale(1); }
            20% { transform: scale(0.8); }
            50% { transform: scale(1.3) rotate(15deg); }
            70% { transform: scale(0.95) rotate(-5deg); }
            100% { transform: scale(1) rotate(0); }
        }
        
        /* ===== MODALS ===== */
        .modal-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.75);
            backdrop-filter: blur(8px);
            -webkit-backdrop-filter: blur(8px);
            display: flex;
            align-items: center;
            justify-content: center;
            padding: var(--space-4);
            z-index: var(--z-modal);
            opacity: 0;
            visibility: hidden;
            transition: all 0.25s;
        }
        
        .modal-overlay.open {
            opacity: 1;
            visibility: visible;
        }
        
        .modal {
            background: var(--color-bg-secondary);
            border: 1px solid var(--color-border);
            border-radius: var(--radius-2xl);
            padding: var(--space-8);
            width: 100%;
            max-width: 420px;
            transform: scale(0.9) translateY(30px);
            opacity: 0;
            transition: 
                transform 0.4s var(--ease-spring),
                opacity 0.3s ease;
            position: relative;
            box-shadow: var(--shadow-2xl);
        }
        
        .modal-overlay.open .modal {
            transform: scale(1) translateY(0);
            opacity: 1;
            animation: modal-pop-in 0.45s var(--ease-spring);
        }
        
        @keyframes modal-pop-in {
            0% { 
                transform: scale(0.85) translateY(40px); 
                opacity: 0; 
            }
            60% { 
                transform: scale(1.02) translateY(-5px); 
            }
            100% { 
                transform: scale(1) translateY(0); 
                opacity: 1; 
            }
        }
        
        .modal-title {
            font-size: var(--text-xl);
            font-weight: 600;
            margin-bottom: var(--space-4);
            display: flex;
            align-items: center;
            gap: var(--space-2);
        }
        
        .gift-code-display {
            background: linear-gradient(135deg, var(--color-bg-tertiary) 0%, var(--color-bg-elevated) 100%);
            border: 2px dashed var(--color-brand);
            border-radius: var(--radius-xl);
            padding: var(--space-6);
            text-align: center;
            margin: var(--space-5) 0;
            position: relative;
        }
        
        .gift-code {
            position: relative;
            font-size: var(--text-2xl);
            font-weight: 700;
            font-family: var(--font-mono);
            background: var(--cinq-gradient);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            letter-spacing: 0.08em;
        }
        
        /* ===== TOASTS ===== */
        .toast-container {
            position: fixed;
            top: var(--space-4);
            left: 50%;
            transform: translateX(-50%);
            z-index: var(--z-toast);
            display: flex;
            flex-direction: column;
            gap: var(--space-2);
            pointer-events: none;
            width: 90%;
            max-width: 400px;
        }
        
        .toast {
            background: var(--color-bg-secondary);
            border: 1px solid var(--color-border);
            border-radius: var(--radius-xl);
            padding: var(--space-4);
            display: flex;
            align-items: center;
            gap: var(--space-3);
            box-shadow: var(--shadow-xl);
            animation: toast-in 0.5s var(--ease-spring);
            pointer-events: auto;
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            transition: transform 0.2s var(--ease-spring), box-shadow 0.2s ease;
            position: relative;
            overflow: hidden;
        }
        
        /* Progress bar for toast duration */
        .toast::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            height: 3px;
            background: var(--color-brand);
            animation: toast-progress 4s linear forwards;
            border-radius: 0 0 var(--radius-xl) var(--radius-xl);
        }
        
        @keyframes toast-progress {
            0% { width: 100%; }
            100% { width: 0%; }
        }
        
        .toast:hover {
            transform: scale(1.03) translateY(-2px);
            box-shadow: var(--shadow-2xl);
        }
        
        .toast:hover::after {
            animation-play-state: paused;
        }
        
        .toast.toast-out {
            animation: toast-out 0.35s var(--ease-out-expo) forwards;
        }
        
        @keyframes toast-in {
            0% { 
                opacity: 0; 
                transform: translateY(-30px) scale(0.85) rotateX(-15deg); 
            }
            60% { 
                transform: translateY(6px) scale(1.03) rotateX(0); 
            }
            100% { 
                opacity: 1; 
                transform: translateY(0) scale(1) rotateX(0); 
            }
        }
        
        @keyframes toast-out {
            0% { 
                opacity: 1; 
                transform: translateY(0) scale(1); 
            }
            100% { 
                opacity: 0; 
                transform: translateY(-20px) scale(0.9); 
            }
        }
        
        .toast-icon { 
            font-size: 1.25rem; 
            animation: toast-icon-pop 0.4s var(--ease-spring) 0.2s backwards;
        }
        
        @keyframes toast-icon-pop {
            0% { transform: scale(0) rotate(-20deg); }
            60% { transform: scale(1.2) rotate(5deg); }
            100% { transform: scale(1) rotate(0); }
        }
        
        .toast-content { flex: 1; }
        .toast-title { font-weight: 600; font-size: var(--text-base); }
        .toast-message { font-size: var(--text-sm); color: var(--color-text-muted); margin-top: 2px; }
        
        .toast.success { 
            border-color: var(--color-success); 
            background: var(--color-success-muted); 
        }
        .toast.success::after { background: var(--color-success); }
        
        .toast.error { 
            border-color: var(--color-error); 
            background: var(--color-error-muted); 
            animation: toast-in 0.5s var(--ease-spring), haptic-error 0.5s ease-out 0.1s;
        }
        .toast.error::after { background: var(--color-error); }
        
        .toast.notification { 
            border-color: var(--color-brand); 
            background: var(--color-brand-muted); 
            cursor: pointer; 
        }
        
        /* ===== IMAGE MODAL ===== */
        .image-modal {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.9);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: calc(var(--z-modal) + 1);
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s;
            cursor: zoom-out;
        }
        
        .image-modal.open {
            opacity: 1;
            visibility: visible;
        }
        
        .image-modal img {
            max-width: 95%;
            max-height: 95%;
            object-fit: contain;
            border-radius: var(--radius-lg);
            transform: scale(0.9);
            opacity: 0;
            transition: transform 0.4s var(--ease-spring), opacity 0.3s ease;
        }
        
        .image-modal.open img {
            transform: scale(1);
            opacity: 1;
        }
        
        .image-modal-close {
            position: absolute;
            top: var(--space-4);
            right: var(--space-4);
            width: 40px;
            height: 40px;
            background: rgba(255, 255, 255, 0.1);
            border: none;
            border-radius: 50%;
            color: white;
            cursor: pointer;
            font-size: 1.5rem;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .image-modal-close:hover {
            background: rgba(255, 255, 255, 0.2);
        }
        
        /* ===== LOADING ===== */
        .loading-spinner {
            width: 24px;
            height: 24px;
            border: 2px solid var(--color-border);
            border-top-color: var(--color-brand);
            border-radius: 50%;
            animation: spin 0.8s linear infinite, pulse-glow 1.5s ease-in-out infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        @keyframes pulse-glow {
            0%, 100% { box-shadow: 0 0 0 0 var(--color-brand-glow); }
            50% { box-shadow: 0 0 12px 2px var(--color-brand-glow); }
        }
        
        /* ===== ONBOARDING SYSTEM ===== */
        .onboarding-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.85);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            display: flex;
            align-items: center;
            justify-content: center;
            padding: var(--space-4);
            z-index: calc(var(--z-modal) + 10);
            opacity: 0;
            visibility: hidden;
            transition: all 0.4s ease;
        }
        
        .onboarding-overlay.open {
            opacity: 1;
            visibility: visible;
        }
        
        .onboarding-card {
            background: var(--color-bg-secondary);
            border: 1px solid var(--color-border);
            border-radius: var(--radius-2xl);
            padding: var(--space-8);
            width: 100%;
            max-width: 440px;
            text-align: center;
            transform: scale(0.9) translateY(30px);
            opacity: 0;
            transition: transform 0.5s var(--ease-spring), opacity 0.4s ease;
            position: relative;
            overflow: hidden;
        }
        
        .onboarding-overlay.open .onboarding-card {
            transform: scale(1) translateY(0);
            opacity: 1;
        }
        
        .onboarding-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: var(--cinq-gradient);
        }
        
        .onboarding-confetti {
            position: absolute;
            top: -50px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 4rem;
            animation: confetti-fall 1s ease-out forwards;
            pointer-events: none;
        }
        
        @keyframes confetti-fall {
            0% { transform: translateX(-50%) translateY(-100%) rotate(0deg); opacity: 0; }
            20% { opacity: 1; }
            100% { transform: translateX(-50%) translateY(0) rotate(15deg); opacity: 1; }
        }
        
        .onboarding-emoji {
            font-size: 4rem;
            margin-bottom: var(--space-4);
            animation: emoji-bounce 0.6s var(--ease-spring) 0.3s backwards;
        }
        
        @keyframes emoji-bounce {
            0% { transform: scale(0) rotate(-20deg); }
            60% { transform: scale(1.2) rotate(5deg); }
            100% { transform: scale(1) rotate(0); }
        }
        
        .onboarding-title {
            font-family: var(--font-display);
            font-size: var(--text-2xl);
            font-weight: 700;
            letter-spacing: -0.02em;
            margin-bottom: var(--space-2);
            background: var(--cinq-gradient);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        .onboarding-subtitle {
            color: var(--color-text-muted);
            margin-bottom: var(--space-6);
            line-height: 1.6;
        }
        
        .onboarding-steps {
            display: flex;
            flex-direction: column;
            gap: var(--space-3);
            margin-bottom: var(--space-6);
            text-align: left;
        }
        
        .onboarding-step {
            display: flex;
            align-items: center;
            gap: var(--space-3);
            padding: var(--space-3) var(--space-4);
            background: var(--color-bg-tertiary);
            border: 1px solid var(--color-border);
            border-radius: var(--radius-lg);
            transition: all 0.3s var(--ease-spring);
            opacity: 0;
            transform: translateX(-20px);
            animation: step-appear 0.4s ease-out forwards;
        }
        
        .onboarding-step:nth-child(1) { animation-delay: 0.4s; }
        .onboarding-step:nth-child(2) { animation-delay: 0.5s; }
        .onboarding-step:nth-child(3) { animation-delay: 0.6s; }
        
        @keyframes step-appear {
            to { opacity: 1; transform: translateX(0); }
        }
        
        .onboarding-step.completed {
            background: var(--color-success-muted);
            border-color: var(--color-success);
        }
        
        .onboarding-step-icon {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background: var(--color-bg-elevated);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.1rem;
            flex-shrink: 0;
            transition: all 0.3s;
        }
        
        .onboarding-step.completed .onboarding-step-icon {
            background: var(--color-success);
            color: white;
        }
        
        .onboarding-step-text {
            flex: 1;
        }
        
        .onboarding-step-title {
            font-weight: 600;
            font-size: var(--text-sm);
        }
        
        .onboarding-step-subtitle {
            font-size: var(--text-xs);
            color: var(--color-text-muted);
        }
        
        .onboarding-btn {
            width: 100%;
            padding: var(--space-4);
            background: var(--cinq-gradient);
            color: white;
            border: none;
            border-radius: var(--radius-lg);
            font-family: var(--font-display);
            font-size: var(--text-base);
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.15s var(--ease-spring), box-shadow 0.2s;
            box-shadow: var(--shadow-glow-sm);
        }
        
        .onboarding-btn:hover {
            transform: translateY(-2px) scale(1.02);
            box-shadow: var(--shadow-glow);
        }
        
        .onboarding-skip {
            background: none;
            border: none;
            color: var(--color-text-muted);
            cursor: pointer;
            font-size: var(--text-sm);
            margin-top: var(--space-4);
            padding: var(--space-2);
            transition: color 0.2s;
        }
        
        .onboarding-skip:hover {
            color: var(--color-text-primary);
        }
        
        /* ===== TOOLTIPS/HINTS ===== */
        .tooltip-hint {
            position: absolute;
            background: var(--cinq-gradient);
            color: white;
            padding: var(--space-3) var(--space-4);
            border-radius: var(--radius-lg);
            font-size: var(--text-sm);
            font-weight: 500;
            box-shadow: var(--shadow-glow);
            z-index: var(--z-tooltip);
            max-width: 250px;
            opacity: 0;
            visibility: hidden;
            transform: translateY(10px);
            transition: all 0.3s var(--ease-spring);
            pointer-events: none;
        }
        
        .tooltip-hint.visible {
            opacity: 1;
            visibility: visible;
            transform: translateY(0);
            pointer-events: auto;
        }
        
        .tooltip-hint::before {
            content: '';
            position: absolute;
            width: 12px;
            height: 12px;
            background: var(--color-brand);
            transform: rotate(45deg);
        }
        
        .tooltip-hint.top::before {
            bottom: -6px;
            left: 50%;
            margin-left: -6px;
        }
        
        .tooltip-hint.bottom::before {
            top: -6px;
            left: 50%;
            margin-left: -6px;
        }
        
        .tooltip-hint.left::before {
            right: -6px;
            top: 50%;
            margin-top: -6px;
        }
        
        .tooltip-hint-close {
            position: absolute;
            top: var(--space-1);
            right: var(--space-2);
            background: none;
            border: none;
            color: rgba(255,255,255,0.7);
            cursor: pointer;
            font-size: 1rem;
            line-height: 1;
            padding: var(--space-1);
        }
        
        .tooltip-hint-close:hover {
            color: white;
        }
        
        /* ===== PULSING INDICATOR ===== */
        .pulse-indicator {
            position: relative;
        }
        
        .pulse-indicator::after {
            content: '';
            position: absolute;
            top: -4px;
            right: -4px;
            width: 12px;
            height: 12px;
            background: var(--color-brand);
            border-radius: 50%;
            animation: pulse-ring 1.5s ease-out infinite;
            z-index: 10;
        }
        
        @keyframes pulse-ring {
            0% { transform: scale(1); opacity: 1; box-shadow: 0 0 0 0 var(--color-brand-glow); }
            70% { transform: scale(1.3); opacity: 0.7; box-shadow: 0 0 0 10px transparent; }
            100% { transform: scale(1); opacity: 1; box-shadow: 0 0 0 0 transparent; }
        }
        
        /* ===== ONBOARDING CHECKLIST (FLOATING) ===== */
        .onboarding-checklist {
            position: fixed;
            bottom: 100px;
            right: var(--space-4);
            background: var(--color-bg-secondary);
            border: 1px solid var(--color-border);
            border-radius: var(--radius-xl);
            padding: var(--space-4);
            box-shadow: var(--shadow-xl);
            z-index: var(--z-sticky);
            max-width: 280px;
            opacity: 0;
            visibility: hidden;
            transform: translateY(20px) scale(0.95);
            transition: all 0.3s var(--ease-spring);
        }
        
        .onboarding-checklist.visible {
            opacity: 1;
            visibility: visible;
            transform: translateY(0) scale(1);
        }
        
        .onboarding-checklist-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: var(--space-3);
        }
        
        .onboarding-checklist-title {
            font-weight: 600;
            font-size: var(--text-sm);
            display: flex;
            align-items: center;
            gap: var(--space-2);
        }
        
        .onboarding-checklist-close {
            background: none;
            border: none;
            color: var(--color-text-muted);
            cursor: pointer;
            padding: var(--space-1);
            line-height: 1;
        }
        
        .onboarding-checklist-items {
            display: flex;
            flex-direction: column;
            gap: var(--space-2);
        }
        
        .checklist-item {
            display: flex;
            align-items: center;
            gap: var(--space-2);
            font-size: var(--text-sm);
            padding: var(--space-2);
            border-radius: var(--radius-md);
            transition: background 0.2s;
            cursor: pointer;
        }
        
        .checklist-item:hover {
            background: var(--color-bg-tertiary);
        }
        
        .checklist-item.completed {
            color: var(--color-text-muted);
            text-decoration: line-through;
        }
        
        .checklist-icon {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            border: 2px solid var(--color-border);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.7rem;
            flex-shrink: 0;
            transition: all 0.3s;
        }
        
        .checklist-item.completed .checklist-icon {
            background: var(--color-success);
            border-color: var(--color-success);
            color: white;
        }
        
        .onboarding-checklist-progress {
            margin-top: var(--space-3);
            padding-top: var(--space-3);
            border-top: 1px solid var(--color-border);
        }
        
        .progress-bar-mini {
            height: 4px;
            background: var(--color-bg-tertiary);
            border-radius: var(--radius-full);
            overflow: hidden;
            margin-bottom: var(--space-1);
        }
        
        .progress-bar-fill {
            height: 100%;
            background: var(--cinq-gradient);
            border-radius: inherit;
            transition: width 0.5s var(--ease-out-expo);
        }
        
        .progress-text {
            font-size: var(--text-xs);
            color: var(--color-text-muted);
            text-align: center;
        }
        
        /* ===== SEARCH ===== */
        .search-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.85);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            z-index: calc(var(--z-modal) + 1);
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s var(--ease-out-expo);
            padding: var(--space-4);
            padding-top: env(safe-area-inset-top, var(--space-4));
        }
        
        .search-overlay.open {
            opacity: 1;
            visibility: visible;
        }
        
        .search-container {
            max-width: 600px;
            margin: 0 auto;
            transform: translateY(-20px);
            opacity: 0;
            transition: all 0.35s var(--ease-spring);
        }
        
        .search-overlay.open .search-container {
            transform: translateY(0);
            opacity: 1;
        }
        
        .search-header {
            display: flex;
            align-items: center;
            gap: var(--space-3);
            margin-bottom: var(--space-4);
        }
        
        .search-input-wrapper {
            flex: 1;
            position: relative;
        }
        
        .search-input {
            width: 100%;
            padding: var(--space-4) var(--space-5);
            padding-left: 48px;
            background: var(--color-bg-secondary);
            border: 2px solid var(--color-border);
            border-radius: var(--radius-xl);
            color: var(--color-text-primary);
            font-size: var(--text-lg);
            font-family: inherit;
            transition: all 0.2s var(--ease-out-expo);
        }
        
        .search-input:focus {
            outline: none;
            border-color: var(--color-brand);
            box-shadow: 0 0 0 4px var(--color-brand-muted);
        }
        
        .search-input::placeholder {
            color: var(--color-text-muted);
        }
        
        .search-icon {
            position: absolute;
            left: var(--space-4);
            top: 50%;
            transform: translateY(-50%);
            color: var(--color-text-muted);
            pointer-events: none;
        }
        
        .search-close-btn {
            width: 44px;
            height: 44px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--color-bg-tertiary);
            border: 1px solid var(--color-border);
            border-radius: var(--radius-lg);
            color: var(--color-text-muted);
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .search-close-btn:hover {
            background: var(--color-bg-hover);
            color: var(--color-text-primary);
        }
        
        .search-tabs {
            display: flex;
            gap: var(--space-2);
            margin-bottom: var(--space-4);
        }
        
        .search-tab {
            padding: var(--space-2) var(--space-4);
            background: var(--color-bg-tertiary);
            border: 1px solid var(--color-border);
            border-radius: var(--radius-full);
            color: var(--color-text-muted);
            font-size: var(--text-sm);
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .search-tab:hover {
            background: var(--color-bg-hover);
            color: var(--color-text-primary);
        }
        
        .search-tab.active {
            background: var(--color-brand-muted);
            border-color: var(--color-brand);
            color: var(--color-brand);
        }
        
        .search-results {
            max-height: calc(100vh - 200px);
            max-height: calc(100dvh - 200px);
            overflow-y: auto;
            padding-right: var(--space-2);
        }
        
        .search-section {
            margin-bottom: var(--space-5);
        }
        
        .search-section-title {
            font-size: var(--text-xs);
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: var(--color-text-muted);
            margin-bottom: var(--space-3);
            display: flex;
            align-items: center;
            gap: var(--space-2);
        }
        
        .search-section-count {
            background: var(--color-bg-tertiary);
            padding: 2px 8px;
            border-radius: var(--radius-full);
            font-size: var(--text-xs);
        }
        
        .search-result-item {
            display: flex;
            align-items: flex-start;
            gap: var(--space-3);
            padding: var(--space-3);
            background: var(--color-bg-secondary);
            border: 1px solid var(--color-border);
            border-radius: var(--radius-lg);
            cursor: pointer;
            transition: all 0.2s;
            margin-bottom: var(--space-2);
        }
        
        .search-result-item:hover {
            background: var(--color-bg-hover);
            border-color: var(--color-border-active);
            transform: translateX(4px);
        }
        
        .search-result-avatar {
            width: 40px;
            height: 40px;
            min-width: 40px;
            border-radius: 50%;
            background: var(--cinq-gradient);
            display: flex;
            align-items: center;
            justify-content: center;
            font-family: var(--font-display);
            font-size: 1rem;
            color: white;
            font-weight: 600;
            overflow: hidden;
            flex-shrink: 0;
            position: relative;
        }
        
        .search-result-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            position: absolute;
            inset: 0;
        }
        
        .search-result-info {
            flex: 1;
            min-width: 0;
        }
        
        .search-result-name {
            font-weight: 600;
            font-size: var(--text-sm);
            color: var(--color-text-primary);
            margin-bottom: 2px;
        }
        
        .search-result-name mark {
            background: var(--color-brand-muted);
            color: var(--color-brand);
            padding: 0 2px;
            border-radius: 2px;
        }
        
        .search-result-meta {
            font-size: var(--text-xs);
            color: var(--color-text-muted);
        }
        
        .search-result-preview {
            font-size: var(--text-sm);
            color: var(--color-text-secondary);
            line-height: 1.5;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }
        
        .search-result-preview mark {
            background: var(--color-brand-muted);
            color: var(--color-brand);
            padding: 0 2px;
            border-radius: 2px;
        }
        
        .search-empty {
            text-align: center;
            padding: var(--space-8) var(--space-4);
            color: var(--color-text-muted);
        }
        
        .search-empty-icon {
            font-size: 3rem;
            margin-bottom: var(--space-3);
            opacity: 0.5;
        }
        
        .search-loading {
            display: flex;
            justify-content: center;
            padding: var(--space-6);
        }
        
        .search-hint {
            text-align: center;
            padding: var(--space-8) var(--space-4);
            color: var(--color-text-muted);
            font-size: var(--text-sm);
        }
        
        .search-hint kbd {
            background: var(--color-bg-tertiary);
            border: 1px solid var(--color-border);
            border-radius: var(--radius-sm);
            padding: 2px 6px;
            font-family: var(--font-mono);
            font-size: var(--text-xs);
        }
        
        /* ===== RESPONSIVE ===== */
        @media (max-width: 480px) {
            .app-content {
                padding: var(--space-4);
                padding-bottom: calc(80px + env(safe-area-inset-bottom, var(--space-4)));
            }
            
            .modal {
                padding: var(--space-6);
            }
            
            .search-input {
                font-size: var(--text-base);
                padding: var(--space-3) var(--space-4);
                padding-left: 44px;
            }
        }
    </style>
</head>
<body>
    <!-- Skip Links - WCAG AAA Compliant -->
    <nav class="skip-links" aria-label="Liens d'évitement">
        <a href="#main-content" class="skip-link">Aller au contenu principal</a>
        <a href="#bottom-nav" class="skip-link">Aller à la navigation</a>
        <a href="#tab-contacts" class="skip-link">Aller à Tes 5 proches</a>
    </nav>
    
    <!-- Live region for dynamic announcements -->
    <div id="sr-announce" class="sr-announce" aria-live="polite" aria-atomic="true"></div>
    
    <div class="noise-overlay" aria-hidden="true"></div>
    <div class="gradient-orb gradient-orb-1" aria-hidden="true"></div>
    <div class="gradient-orb gradient-orb-2" aria-hidden="true"></div>
    
    <!-- Toast Container -->
    <div class="toast-container" id="toast-container" role="status" aria-live="polite" aria-atomic="false"></div>
    
    <!-- Onboarding Welcome Overlay -->
    <div class="onboarding-overlay" id="onboarding-overlay" role="dialog" aria-modal="true" aria-labelledby="onboarding-title">
        <div class="onboarding-card">
            <div class="onboarding-confetti" aria-hidden="true">🎉</div>
            <div class="onboarding-emoji" aria-hidden="true">👋</div>
            <h2 class="onboarding-title" id="onboarding-title">Bienvenue sur Cinq !</h2>
            <p class="onboarding-subtitle">Ton espace intime avec tes 5 proches est prêt.<br>Voici comment bien démarrer :</p>
            
            <div class="onboarding-steps" role="list">
                <div class="onboarding-step" role="listitem">
                    <div class="onboarding-step-icon">📸</div>
                    <div class="onboarding-step-text">
                        <div class="onboarding-step-title">Ajoute ta photo</div>
                        <div class="onboarding-step-subtitle">Pour que tes proches te reconnaissent</div>
                    </div>
                </div>
                <div class="onboarding-step" role="listitem">
                    <div class="onboarding-step-icon">👥</div>
                    <div class="onboarding-step-text">
                        <div class="onboarding-step-title">Invite tes 5 proches</div>
                        <div class="onboarding-step-subtitle">Les personnes qui comptent vraiment</div>
                    </div>
                </div>
                <div class="onboarding-step" role="listitem">
                    <div class="onboarding-step-icon">✍️</div>
                    <div class="onboarding-step-text">
                        <div class="onboarding-step-title">Partage ton premier moment</div>
                        <div class="onboarding-step-subtitle">Un message, une photo, un ressenti</div>
                    </div>
                </div>
            </div>
            
            <button class="onboarding-btn" onclick="startOnboarding()" type="button">C'est parti ! 🚀</button>
            <button class="onboarding-skip" onclick="skipOnboarding()" type="button">Je connais déjà, passer</button>
        </div>
    </div>
    
    <!-- Floating Onboarding Checklist -->
    <div class="onboarding-checklist" id="onboarding-checklist" role="complementary" aria-label="Progression d'onboarding">
        <div class="onboarding-checklist-header">
            <div class="onboarding-checklist-title">
                <span>🎯</span> Premiers pas
            </div>
            <button class="onboarding-checklist-close" onclick="hideOnboardingChecklist()" aria-label="Fermer" type="button">×</button>
        </div>
        <div class="onboarding-checklist-items">
            <div class="checklist-item" id="checklist-photo" onclick="goToProfileForPhoto()">
                <div class="checklist-icon">✓</div>
                <span>Ajouter une photo de profil</span>
            </div>
            <div class="checklist-item" id="checklist-contact" onclick="goToContactsForAdd()">
                <div class="checklist-icon">✓</div>
                <span>Ajouter un premier contact</span>
            </div>
            <div class="checklist-item" id="checklist-post" onclick="goToFeedForPost()">
                <div class="checklist-icon">✓</div>
                <span>Créer ton premier post</span>
            </div>
        </div>
        <div class="onboarding-checklist-progress">
            <div class="progress-bar-mini">
                <div class="progress-bar-fill" id="onboarding-progress-fill" style="width: 0%"></div>
            </div>
            <div class="progress-text" id="onboarding-progress-text">0/3 complétés</div>
        </div>
    </div>
    
    <!-- Image Modal -->
    <div class="image-modal" id="image-modal" role="dialog" aria-modal="true" aria-label="Image en plein écran" onclick="closeImageModal()">
        <button class="image-modal-close" onclick="closeImageModal()" aria-label="Fermer l'image">
            <span aria-hidden="true">×</span>
        </button>
        <img id="modal-image" src="" alt="Image agrandie">
    </div>
    
    <!-- Search Overlay -->
    <div class="search-overlay" id="search-overlay" role="dialog" aria-modal="true" aria-label="Recherche">
        <div class="search-container">
            <div class="search-header">
                <div class="search-input-wrapper">
                    <svg class="search-icon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                        <circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/>
                    </svg>
                    <input 
                        type="text" 
                        class="search-input" 
                        id="search-input" 
                        placeholder="Rechercher dans tes contacts et posts..."
                        autocomplete="off"
                        aria-label="Rechercher"
                    >
                </div>
                <button class="search-close-btn" onclick="closeSearch()" aria-label="Fermer la recherche" type="button">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                        <line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/>
                    </svg>
                </button>
            </div>
            
            <div class="search-tabs">
                <button class="search-tab active" data-type="all" onclick="setSearchType('all')" type="button">Tout</button>
                <button class="search-tab" data-type="contacts" onclick="setSearchType('contacts')" type="button">Contacts</button>
                <button class="search-tab" data-type="posts" onclick="setSearchType('posts')" type="button">Posts</button>
            </div>
            
            <div class="search-results" id="search-results">
                <div class="search-hint">
                    <p>Tape au moins 2 caractères pour rechercher</p>
                    <p style="margin-top: var(--space-2);">Raccourci : <kbd>Ctrl</kbd> + <kbd>K</kbd></p>
                </div>
            </div>
        </div>
    </div>
    
    <div class="app-shell">
        <!-- HEADER — Professional Top Bar -->
        <header class="app-header" id="app-header">
            <!-- Brand / Logo -->
            <a href="/" class="header-brand" aria-label="Cinq — Retour à l'accueil">
                <div class="header-logo-icon">
                    <span class="header-logo-number" aria-hidden="true">5</span>
                </div>
                <span class="header-logo-text">cinq</span>
            </a>
            
            <h1 class="sr-only">Cinq — Ton espace intime</h1>
            
            <!-- Actions -->
            <div class="header-actions">
                <!-- Search Button -->
                <button class="header-action-btn" id="search-btn" onclick="openSearch()" aria-label="Rechercher" type="button">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                        <circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/>
                    </svg>
                </button>
                
                <!-- Theme Toggle -->
                <button class="theme-toggle" id="theme-toggle" onclick="toggleTheme()" aria-label="Basculer entre mode clair/sombre" type="button">
                    <svg class="theme-toggle-icon icon-sun" aria-hidden="true" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <circle cx="12" cy="12" r="5"/>
                        <line x1="12" y1="1" x2="12" y2="3"/>
                        <line x1="12" y1="21" x2="12" y2="23"/>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/>
                        <line x1="1" y1="12" x2="3" y2="12"/>
                        <line x1="21" y1="12" x2="23" y2="12"/>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/>
                    </svg>
                    <svg class="theme-toggle-icon icon-moon" aria-hidden="true" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/>
                    </svg>
                </button>
                
                <!-- Notifications -->
                <button class="notification-btn" id="notification-btn" onclick="window.CinqNotifications?.toggleNotificationCenter()" aria-label="Voir les notifications" type="button">
                    <svg aria-hidden="true" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"/>
                        <path d="M13.73 21a2 2 0 0 1-3.46 0"/>
                    </svg>
                    <span id="notification-badge" class="notification-badge hidden" aria-live="polite">0</span>
                </button>
                
                <div class="header-divider" aria-hidden="true"></div>
                
                <!-- User Avatar -->
                <button class="header-avatar online" id="header-avatar" onclick="switchTab('profil')" aria-label="Accéder à mon profil" type="button">
                    <span id="header-avatar-initial" aria-hidden="true">?</span>
                </button>
            </div>
        </header>
        
        <!-- MAIN CONTENT -->
        <main class="app-content" id="main-content">
            <!-- TAB: FEED (DEFAULT) -->
            <section class="tab-panel active" id="tab-feed" role="tabpanel" aria-labelledby="nav-feed" tabindex="0">
                <!-- Composer -->
                <div class="composer" role="region" aria-label="Créer un nouveau post">
                    <div class="composer-header">
                        <div class="composer-avatar" id="composer-avatar" aria-hidden="true">?</div>
                        <span class="composer-user" id="composer-user">Chargement...</span>
                    </div>
                    <label for="post-content" class="sr-only">Contenu de votre post</label>
                    <textarea 
                        class="composer-textarea" 
                        id="post-content" 
                        placeholder="Un truc marrant ? Une pensée ? Un coup de gueule ? C'est entre vous..."
                        maxlength="1000"
                        aria-describedby="char-count"
                    ></textarea>
                    <div class="image-preview" id="image-preview" role="region" aria-label="Aperçu de l'image">
                        <img id="preview-img" src="" alt="Aperçu de l'image à poster">
                        <button class="image-preview-remove" onclick="removeImage()" aria-label="Supprimer l'image" type="button">
                            <span aria-hidden="true">×</span>
                        </button>
                        <div id="upload-progress" role="status" aria-live="polite" style="display:none;position:absolute;bottom:0;left:0;right:0;background:rgba(0,0,0,0.7);padding:var(--space-2);text-align:center;font-size:var(--text-xs);">
                            <span aria-hidden="true">⏳</span> Upload en cours...
                        </div>
                    </div>
                    <label for="file-input" class="sr-only">Ajouter une image au post</label>
                    <input type="file" id="file-input" accept="image/jpeg,image/png,image/gif,image/webp" style="display:none;" onchange="handleFileSelect(event)" aria-describedby="file-input-desc">
                    <span id="file-input-desc" class="sr-only">Formats acceptés: JPEG, PNG, GIF, WebP. Taille max: 5 Mo</span>
                    <div class="composer-footer">
                        <div class="composer-actions">
                            <button class="composer-btn" onclick="triggerFileUpload()" type="button" aria-label="Ajouter une photo">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                                    <rect x="3" y="3" width="18" height="18" rx="2"/><circle cx="8.5" cy="8.5" r="1.5"/><polyline points="21 15 16 10 5 21"/>
                                </svg>
                                <span>Photo</span>
                            </button>
                        </div>
                        <div style="display:flex;align-items:center;gap:var(--space-4);">
                            <span class="char-count" id="char-count" aria-live="polite" aria-atomic="true">0/1000</span>
                            <button class="post-btn btn-ripple glow-hover" id="post-btn" onclick="submitPost()" disabled aria-label="Publier le post" type="button">Envoyer</button>
                        </div>
                    </div>
                </div>
                
                <!-- Posts List -->
                <div class="posts-list" id="posts-list" role="feed" aria-label="Fil d'actualités" aria-busy="true">
                    <div class="loading-spinner" style="margin:var(--space-8) auto;" role="status" aria-label="Chargement des posts"></div>
                </div>
            </section>
            
            <!-- TAB: TES 5 -->
            <section class="tab-panel" id="tab-contacts" role="tabpanel" aria-labelledby="nav-contacts" tabindex="0" hidden>
                <h2 class="section-title">
                    Tes 5
                    <span class="contact-count" id="contact-count" aria-live="polite">0/5</span>
                </h2>
                <div class="contacts-grid" id="contacts-grid" role="list" aria-label="Liste de tes 5 contacts"></div>
                
                <button class="action-btn btn-ripple reveal" onclick="openGiftModal()" type="button">
                    <svg class="action-icon" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="var(--color-brand)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                        <rect x="3" y="8" width="18" height="13" rx="2"/><path d="M12 8v13"/><path d="M3 12h18"/><path d="M12 8c-2.5-3-6-2-6 0s3.5 2 6 0"/><path d="M12 8c2.5-3 6-2 6 0s-3.5 2-6 0"/>
                    </svg>
                    <div>
                        <div class="action-title">Offrir Cinq</div>
                        <div class="action-subtitle">Invite quelqu'un qui compte vraiment</div>
                    </div>
                </button>
                
                <!-- Suggestions Section -->
                <section class="suggestions-section" id="suggestions-section" aria-labelledby="suggestions-title">
                    <div class="suggestions-header">
                        <h3 class="suggestions-title" id="suggestions-title">
                            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                                <path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M22 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/>
                            </svg>
                            Suggestions
                        </h3>
                    </div>
                    <div id="suggestions-list" role="list" aria-label="Suggestions d'amis d'amis">
                        <div class="suggestions-empty" id="suggestions-loading">
                            <span class="loading-spinner"></span>
                            Chargement des suggestions...
                        </div>
                    </div>
                </section>
            </section>
            
            <!-- TAB: PROFIL -->
            <section class="tab-panel" id="tab-profil" role="tabpanel" aria-labelledby="nav-profil" tabindex="0" hidden>
                <div class="profile-header">
                    <button class="profile-avatar" id="profile-avatar" onclick="document.getElementById('avatar-input').click()" type="button" aria-label="Changer ma photo de profil">
                        <span id="profile-avatar-initial" aria-hidden="true">?</span>
                        <div class="profile-avatar-overlay" aria-hidden="true">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <rect x="3" y="3" width="18" height="18" rx="2"/><circle cx="8.5" cy="8.5" r="1.5"/><polyline points="21 15 16 10 5 21"/>
                            </svg>
                        </div>
                    </button>
                    <label for="avatar-input" class="sr-only">Choisir une nouvelle photo de profil</label>
                    <input type="file" id="avatar-input" accept="image/jpeg,image/png,image/gif,image/webp" style="display:none;" onchange="uploadAvatar(this)" aria-describedby="avatar-input-desc">
                    <span id="avatar-input-desc" class="sr-only">Formats acceptés: JPEG, PNG, GIF, WebP. Taille max: 2 Mo</span>
                    <h2 class="profile-name" id="profile-name">Chargement...</h2>
                    <p class="profile-bio" id="profile-bio-display"></p>
                </div>
                
                <!-- Edit Profile -->
                <div class="settings-card" role="region" aria-labelledby="settings-profile-title">
                    <div class="settings-card-header" id="settings-profile-title">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="var(--color-brand)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                            <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/>
                        </svg>
                        <span>Modifier mon profil</span>
                    </div>
                    <div class="settings-field">
                        <label class="settings-label" for="profile-display-name">Pseudo</label>
                        <input type="text" id="profile-display-name" class="settings-input" placeholder="Ton pseudo..." maxlength="50" autocomplete="nickname">
                    </div>
                    <div class="settings-field">
                        <label class="settings-label" for="profile-bio">Bio</label>
                        <textarea id="profile-bio" class="settings-input" placeholder="Ce que tes proches savent déjà sur toi..." maxlength="500" rows="2" style="resize:vertical;min-height:60px;"></textarea>
                    </div>
                    <button onclick="saveProfile()" id="save-profile-btn" class="save-btn btn-ripple glow-hover" type="button">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true" style="vertical-align: middle; margin-right: 6px;">
                            <path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/>
                        </svg>
                        Enregistrer
                    </button>
                </div>
                
                <!-- Data & Actions -->
                <div class="settings-card" role="region" aria-labelledby="settings-data-title">
                    <div class="settings-card-header" id="settings-data-title">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="var(--color-brand)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                            <path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"/><polyline points="3.27 6.96 12 12.01 20.73 6.96"/><line x1="12" y1="22.08" x2="12" y2="12"/>
                        </svg>
                        <span>Mes données</span>
                    </div>
                    <button onclick="exportData()" id="export-data-btn" class="settings-btn" type="button">
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                            <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/>
                        </svg>
                        <div class="settings-btn-info">
                            <span class="settings-btn-title">Récupérer mes données</span>
                            <span class="settings-btn-subtitle">Tout ce qu'on a sur toi, dans un fichier</span>
                        </div>
                    </button>
                    <button onclick="logout()" class="settings-btn" type="button">
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                            <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" y1="12" x2="9" y2="12"/>
                        </svg>
                        <div class="settings-btn-info">
                            <span class="settings-btn-title">Déconnexion</span>
                            <span class="settings-btn-subtitle">À plus tard !</span>
                        </div>
                    </button>
                    <button onclick="openDeleteAccountModal()" class="settings-btn settings-btn-danger" type="button">
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                            <polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/><line x1="10" y1="11" x2="10" y2="17"/><line x1="14" y1="11" x2="14" y2="17"/>
                        </svg>
                        <div class="settings-btn-info">
                            <span class="settings-btn-title">Supprimer mon compte</span>
                            <span class="settings-btn-subtitle">On espère que tu reviendras</span>
                        </div>
                    </button>
                </div>
            </section>
        </main>
        
        <!-- BOTTOM NAV -->
        <nav id="bottom-nav" class="bottom-nav" role="tablist" aria-label="Navigation principale">
            <button class="nav-item active" id="nav-feed" data-tab="feed" onclick="switchTab('feed')" role="tab" aria-selected="true" aria-controls="tab-feed" type="button">
                <svg class="nav-icon" width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                    <path d="M4 11a9 9 0 0 1 9 9"/><path d="M4 4a16 16 0 0 1 16 16"/><circle cx="5" cy="19" r="1"/>
                </svg>
                <span class="nav-label">Feed</span>
            </button>
            <button class="nav-item" id="nav-contacts" data-tab="contacts" onclick="switchTab('contacts')" role="tab" aria-selected="false" aria-controls="tab-contacts" type="button">
                <svg class="nav-icon" width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                    <path d="M12 2L22 9L18 21H6L2 9L12 2Z"/>
                </svg>
                <span class="nav-label">Tes 5</span>
            </button>
            <button class="nav-item" id="nav-profil" data-tab="profil" onclick="switchTab('profil')" role="tab" aria-selected="false" aria-controls="tab-profil" type="button">
                <svg class="nav-icon" width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                    <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/>
                </svg>
                <span class="nav-label">Profil</span>
            </button>
        </nav>
    </div>
    
    <!-- Chat Overlay -->
    <div class="chat-overlay" id="chat-overlay" onclick="closeChat()" aria-hidden="true"></div>
    
    <!-- Chat Panel -->
    <div class="chat-panel" id="chat-panel" role="dialog" aria-modal="true" aria-labelledby="chat-contact-name" aria-hidden="true">
        <div class="chat-header">
            <div class="chat-contact-info">
                <div class="chat-contact-avatar" id="chat-contact-avatar" aria-hidden="true">?</div>
                <h2 class="chat-contact-name" id="chat-contact-name"></h2>
            </div>
            <button class="chat-close" onclick="closeChat()" type="button" aria-label="Fermer la conversation">
                <span aria-hidden="true">×</span>
            </button>
        </div>
        <div class="chat-messages" id="chat-messages" role="log" aria-live="polite" aria-label="Messages de la conversation"></div>
        <div class="chat-input-area">
            <button class="ping-btn" onclick="sendPing()" type="button" aria-label="Envoyer un coucou">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                    <path d="M12 2L22 9L18 21H6L2 9L12 2Z"/>
                </svg>
            </button>
            <label for="chat-input" class="sr-only">Écrire un message</label>
            <input type="text" class="chat-input" id="chat-input" placeholder="Écris quelque chose..." maxlength="500" autocomplete="off">
            <button class="chat-send" onclick="sendMessage()" id="send-btn" disabled type="button" aria-label="Envoyer le message">
                <span aria-hidden="true">→</span>
            </button>
        </div>
    </div>
    
    <!-- Gift Modal -->
    <div class="modal-overlay" id="gift-modal" role="dialog" aria-modal="true" aria-labelledby="gift-modal-title" aria-hidden="true">
        <div class="modal">
            <h2 class="modal-title" id="gift-modal-title">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="var(--color-brand)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true" style="vertical-align: middle; margin-right: 8px;">
                    <rect x="3" y="8" width="18" height="13" rx="2"/><path d="M12 8v13"/><path d="M3 12h18"/><path d="M12 8c-2.5-3-6-2-6 0s3.5 2 6 0"/><path d="M12 8c2.5-3 6-2 6 0s-3.5 2-6 0"/>
                </svg>
                Offrir Cinq
            </h2>
            <p style="color:var(--color-text-muted);margin-bottom:var(--space-4);">Choisis bien. Cinq n'est pas pour tout le monde.</p>
            <div id="gift-content">
                <button class="save-btn btn-ripple glow-hover" style="width:100%;" onclick="createGift()" type="button">Générer un code</button>
            </div>
            <button style="margin-top:var(--space-4);background:none;border:none;color:var(--color-text-muted);cursor:pointer;width:100%;padding:var(--space-2);" onclick="closeGiftModal()" type="button">Fermer</button>
        </div>
    </div>
    
    <!-- Add Contact Modal -->
    <div class="modal-overlay" id="add-contact-modal" role="dialog" aria-modal="true" aria-labelledby="add-contact-modal-title" aria-hidden="true">
        <div class="modal">
            <h2 class="modal-title" id="add-contact-modal-title"><span aria-hidden="true">➕</span> Ajouter un·e proche</h2>
            <p style="color:var(--color-text-muted);margin-bottom:var(--space-4);">Demande-lui son ID (il l'a dans son profil)</p>
            <label for="contact-id-input" class="sr-only">ID du contact à ajouter</label>
            <input type="text" id="contact-id-input" class="settings-input" placeholder="Colle l'ID ici" style="margin-bottom:var(--space-4);" autocomplete="off" aria-describedby="add-contact-error">
            <div id="add-contact-error" role="alert" style="color:var(--color-error);font-size:var(--text-sm);margin-bottom:var(--space-4);display:none;"></div>
            <button class="save-btn" style="width:100%;" onclick="addContact()" id="add-contact-btn" type="button">Ajouter</button>
            <div style="margin-top:var(--space-5);padding-top:var(--space-5);border-top:1px solid var(--color-border);">
                <p id="my-id-label" style="font-size:var(--text-xs);color:var(--color-text-muted);margin-bottom:var(--space-2);">Ton ID (à partager) :</p>
                <code id="my-id" aria-labelledby="my-id-label" style="font-size:var(--text-xs);word-break:break-all;display:block;background:var(--color-bg-tertiary);padding:var(--space-3);border-radius:var(--radius-lg);border:1px solid var(--color-border);"></code>
                <button onclick="copyMyId()" type="button" aria-label="Copier mon ID dans le presse-papier" style="margin-top:var(--space-2);padding:var(--space-2) var(--space-4);background:var(--color-bg-tertiary);border:1px solid var(--color-border);border-radius:var(--radius-lg);color:var(--color-text-primary);cursor:pointer;font-size:var(--text-sm);display:flex;align-items:center;gap:var(--space-2);">
                    <span aria-hidden="true">📋</span> <span id="copy-id-text">Copier mon ID</span>
                </button>
            </div>
            <button style="margin-top:var(--space-4);background:none;border:none;color:var(--color-text-muted);cursor:pointer;width:100%;padding:var(--space-2);" onclick="closeAddContactModal()" type="button">Fermer</button>
        </div>
    </div>
    
    <!-- Delete Account Modal -->
    <div class="modal-overlay" id="delete-account-modal" role="alertdialog" aria-modal="true" aria-labelledby="delete-modal-title" aria-describedby="delete-modal-desc" aria-hidden="true">
        <div class="modal">
            <h2 class="modal-title" id="delete-modal-title" style="color:var(--color-error);">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true" style="vertical-align: middle; margin-right: 8px;">
                    <polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/><line x1="10" y1="11" x2="10" y2="17"/><line x1="14" y1="11" x2="14" y2="17"/>
                </svg>
                Supprimer mon compte
            </h2>
            <p id="delete-modal-desc" style="color:var(--color-text-muted);margin-bottom:var(--space-4);">Cette action est <strong style="color:var(--color-error);">définitive et irréversible</strong>.</p>
            <div style="background:var(--color-error-muted);border:1px solid var(--color-error);border-radius:var(--radius-lg);padding:var(--space-4);margin-bottom:var(--space-4);" role="alert">
                <p style="font-size:var(--text-sm);color:var(--color-text-primary);margin-bottom:var(--space-2);"><strong>Seront supprimés :</strong></p>
                <ul style="font-size:var(--text-xs);color:var(--color-text-secondary);margin:0;padding-left:var(--space-5);">
                    <li>Ton profil et toutes tes infos</li>
                    <li>Tes 5 contacts</li>
                    <li>Tous tes messages envoyés et reçus</li>
                    <li>Tous tes posts</li>
                </ul>
            </div>
            <label for="delete-confirmation-input" style="font-size:var(--text-sm);margin-bottom:var(--space-3);display:block;">Pour confirmer, tape <strong style="color:var(--color-error);">SUPPRIMER</strong> :</label>
            <input type="text" id="delete-confirmation-input" class="settings-input" placeholder="SUPPRIMER" autocomplete="off" style="text-align:center;letter-spacing:0.1em;margin-bottom:var(--space-4);" aria-describedby="delete-account-error">
            <div id="delete-account-error" role="alert" aria-live="assertive" style="color:var(--color-error);font-size:var(--text-sm);margin-bottom:var(--space-4);display:none;"></div>
            <button onclick="deleteAccount()" id="delete-account-btn" class="save-btn" type="button" style="width:100%;background:var(--color-error);box-shadow:0 2px 8px rgba(248,113,113,0.3);">Supprimer définitivement</button>
            <button style="margin-top:var(--space-4);background:none;border:none;color:var(--color-text-muted);cursor:pointer;width:100%;padding:var(--space-2);" onclick="closeDeleteAccountModal()" type="button">Annuler</button>
        </div>
    </div>

    <script>
        const API_URL = '/api';
        let session = null;
        let user = null;
        let contacts = [];
        let posts = [];
        let currentChatContact = null;
        let messagePollingInterval = null;
        let contactPollingInterval = null;
        let lastMessageIds = {};
        let unreadCounts = {};
        let currentImageUrl = null;
        
        // Search state
        let searchTimeout = null;
        let currentSearchType = 'all';
        let isSearching = false;

        // ===== TAB SWITCHING =====
        const tabOrder = ['feed', 'contacts', 'profil'];
        let currentTab = 'feed';
        
        function switchTab(tabName) {
            const currentIndex = tabOrder.indexOf(currentTab);
            const newIndex = tabOrder.indexOf(tabName);
            const direction = newIndex > currentIndex ? 'left' : 'right';
            
            // Add tap animation to nav item
            const navItem = document.querySelector(`.nav-item[data-tab="${tabName}"]`);
            if (navItem) {
                navItem.classList.add('tapped');
                setTimeout(() => navItem.classList.remove('tapped'), 300);
            }
            
            // Update nav with ARIA
            document.querySelectorAll('.nav-item').forEach(item => {
                const isActive = item.dataset.tab === tabName;
                item.classList.toggle('active', isActive);
                item.setAttribute('aria-selected', isActive ? 'true' : 'false');
            });
            
            // Update panels with slide animation
            document.querySelectorAll('.tab-panel').forEach(panel => {
                const isActive = panel.id === `tab-${tabName}`;
                
                if (isActive) {
                    panel.classList.remove('slide-left', 'slide-right');
                    panel.classList.add('active');
                    // Add directional slide class
                    panel.classList.add(direction === 'left' ? 'slide-left' : 'slide-right');
                    panel.hidden = false;
                    panel.removeAttribute('aria-hidden');
                } else {
                    panel.classList.remove('active', 'slide-left', 'slide-right');
                    panel.hidden = true;
                    panel.setAttribute('aria-hidden', 'true');
                }
            });
            
            currentTab = tabName;
            
            // Load data if needed
            if (tabName === 'contacts') loadContacts();
            if (tabName === 'feed') loadPosts();
        }
        
        // ===== KEYBOARD NAVIGATION FOR TABS =====
        document.addEventListener('DOMContentLoaded', () => {
            const tablist = document.querySelector('[role="tablist"]');
            if (tablist) {
                tablist.addEventListener('keydown', (e) => {
                    const tabs = Array.from(tablist.querySelectorAll('[role="tab"]'));
                    const currentIndex = tabs.findIndex(tab => tab === document.activeElement);
                    
                    let newIndex = currentIndex;
                    if (e.key === 'ArrowRight' || e.key === 'ArrowDown') {
                        newIndex = (currentIndex + 1) % tabs.length;
                        e.preventDefault();
                    } else if (e.key === 'ArrowLeft' || e.key === 'ArrowUp') {
                        newIndex = (currentIndex - 1 + tabs.length) % tabs.length;
                        e.preventDefault();
                    } else if (e.key === 'Home') {
                        newIndex = 0;
                        e.preventDefault();
                    } else if (e.key === 'End') {
                        newIndex = tabs.length - 1;
                        e.preventDefault();
                    }
                    
                    if (newIndex !== currentIndex) {
                        tabs[newIndex].focus();
                        tabs[newIndex].click();
                    }
                });
            }
        });

        // ===== HEADER SCROLL EFFECT =====
        (function() {
            const header = document.getElementById('app-header');
            if (!header) return;
            
            let lastScrollY = 0;
            let ticking = false;
            
            function updateHeader() {
                const scrollY = window.scrollY || window.pageYOffset;
                
                if (scrollY > 20) {
                    header.classList.add('scrolled');
                } else {
                    header.classList.remove('scrolled');
                }
                
                lastScrollY = scrollY;
                ticking = false;
            }
            
            window.addEventListener('scroll', function() {
                if (!ticking) {
                    requestAnimationFrame(updateHeader);
                    ticking = true;
                }
            }, { passive: true });
            
            // Initial check
            updateHeader();
        })();

        // ===== TOAST & AUTH =====
        // showToast(), getToken(), and authHeaders() now provided by /js/shared.js

        // ===== INIT =====
        async function init() {
            try {
                const sessionStr = localStorage.getItem('cinq_session');
                const userStr = localStorage.getItem('cinq_user');
                
                if (!sessionStr || !userStr) {
                    window.location.href = '/login.html';
                    return;
                }

                session = JSON.parse(sessionStr);
                user = JSON.parse(userStr);

                // Setup UI
                const initial = (user.email || '?')[0].toUpperCase();
                document.getElementById('header-avatar-initial').textContent = initial;
                document.getElementById('composer-avatar').textContent = initial;
                document.getElementById('composer-user').textContent = user.email?.split('@')[0] || 'Toi';
                document.getElementById('profile-avatar-initial').textContent = initial;
                document.getElementById('profile-name').textContent = user.email?.split('@')[0] || 'Utilisateur';

                setupComposer();
                setupChatInput();
                
                // Setup lazy loading
                setupLazyLoading();
                
                // Setup search
                initSearch();
                
                // Load data
                await Promise.all([loadProfile(), loadContacts(), loadPosts()]);
                startPolling();
                initPushNotifications();
                
                // Check if new user and show onboarding
                initOnboarding();
                
            } catch (e) {
                console.error('Init error:', e);
                showToast({ type: 'error', title: 'Aïe', message: 'L\'app n\'a pas voulu démarrer. Réessaie ?' });
            }
        }

        // ===== LAZY LOADING (Performance Optimization) =====
        let lazyImageObserver = null;
        
        function setupLazyLoading() {
            if ('IntersectionObserver' in window) {
                lazyImageObserver = new IntersectionObserver(
                    (entries) => {
                        entries.forEach(entry => {
                            if (entry.isIntersecting) {
                                const img = entry.target;
                                const src = img.dataset.src;
                                if (src) {
                                    img.src = src;
                                    img.onload = () => {
                                        img.classList.add('loaded');
                                        img.closest('.lazy-image-container')?.classList.add('loaded');
                                    };
                                    img.onerror = () => {
                                        img.classList.add('error');
                                    };
                                    lazyImageObserver.unobserve(img);
                                }
                            }
                        });
                    },
                    {
                        root: null,
                        rootMargin: '50px',
                        threshold: 0.01
                    }
                );
            }
        }
        
        function observeLazyImages() {
            if (!lazyImageObserver) return;
            document.querySelectorAll('img.lazy-image[data-src]').forEach(img => {
                if (!img.src || img.src === '') {
                    lazyImageObserver.observe(img);
                }
            });
        }

        // ===== PROFILE =====
        async function loadProfile() {
            try {
                const res = await fetch(`${API_URL}/user-profile`, { headers: authHeaders() });
                const data = await res.json();
                
                if (data.profile) {
                    const name = data.profile.display_name || user?.email?.split('@')[0] || 'Utilisateur';
                    const initial = name.charAt(0).toUpperCase();
                    
                    document.getElementById('profile-display-name').value = data.profile.display_name || '';
                    document.getElementById('profile-bio').value = data.profile.bio || '';
                    document.getElementById('profile-name').textContent = name;
                    document.getElementById('profile-bio-display').textContent = data.profile.bio || '';
                    
                    // Update all avatars
                    updateAllAvatars(data.profile.avatar_url, initial);
                }
            } catch (e) {
                console.error('Load profile error:', e);
            }
        }
        
        function updateAllAvatars(avatarUrl, initial) {
            const avatarEls = [
                { el: document.getElementById('header-avatar'), initEl: document.getElementById('header-avatar-initial') },
                { el: document.getElementById('profile-avatar'), initEl: document.getElementById('profile-avatar-initial') },
                { el: document.getElementById('composer-avatar'), initEl: null }
            ];
            
            avatarEls.forEach(({ el, initEl }) => {
                if (!el) return;
                if (avatarUrl) {
                    if (initEl) initEl.style.display = 'none';
                    let img = el.querySelector('img');
                    if (!img) {
                        img = document.createElement('img');
                        el.appendChild(img);
                    }
                    img.src = avatarUrl;
                    img.alt = 'Avatar';
                } else {
                    const img = el.querySelector('img');
                    if (img) img.remove();
                    if (initEl) {
                        initEl.style.display = '';
                        initEl.textContent = initial;
                    } else {
                        el.textContent = initial;
                    }
                }
            });
        }
        
        async function uploadAvatar(input) {
            const file = input.files[0];
            if (!file) return;
            
            if (file.size > 2 * 1024 * 1024) {
                showToast({ type: 'error', title: 'Trop lourd !', message: 'Choisis une image de moins de 2 Mo' });
                return;
            }
            
            showToast({ type: 'info', title: 'On télécharge ta photo...' });
            
            try {
                const base64 = await new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.onload = () => resolve(reader.result);
                    reader.onerror = reject;
                    reader.readAsDataURL(file);
                });
                
                const res = await fetch(`${API_URL}/upload-avatar`, {
                    method: 'POST',
                    headers: authHeaders(),
                    body: JSON.stringify({ image: base64, contentType: file.type })
                });
                
                const data = await res.json();
                if (!res.ok) throw new Error(data.error || 'Erreur upload');
                
                const name = document.getElementById('profile-display-name').value || user?.email?.split('@')[0] || 'U';
                updateAllAvatars(data.avatarUrl, name.charAt(0).toUpperCase());
                showToast({ type: 'success', title: 'Nouvelle tête ! 📸' });
            } catch (e) {
                showToast({ type: 'error', title: 'Erreur', message: e.message });
            }
            
            input.value = '';
        }

        async function saveProfile() {
            const btn = document.getElementById('save-profile-btn');
            const displayName = document.getElementById('profile-display-name').value.trim();
            const bio = document.getElementById('profile-bio').value.trim();
            
            btn.disabled = true;
            btn.textContent = 'Enregistrement...';
            
            try {
                const res = await fetch(`${API_URL}/user-profile`, {
                    method: 'PUT',
                    headers: authHeaders(),
                    body: JSON.stringify({ display_name: displayName || null, bio: bio || null })
                });
                
                if (!res.ok) throw new Error((await res.json()).error || 'Erreur');
                
                document.getElementById('profile-name').textContent = displayName || user?.email?.split('@')[0] || 'Utilisateur';
                document.getElementById('profile-bio-display').textContent = bio || '';
                showToast({ type: 'success', title: 'C\'est enregistré !' });
            } catch (e) {
                showToast({ type: 'error', title: 'Erreur', message: e.message });
            } finally {
                btn.disabled = false;
                btn.textContent = '💾 Enregistrer';
            }
        }

        // ===== POSTS (FEED) =====
        function setupComposer() {
            const textarea = document.getElementById('post-content');
            const charCount = document.getElementById('char-count');
            const postBtn = document.getElementById('post-btn');
            
            textarea.addEventListener('input', () => {
                const len = textarea.value.length;
                charCount.textContent = `${len}/1000`;
                charCount.classList.remove('warning', 'error');
                if (len > 900) charCount.classList.add('error');
                else if (len > 700) charCount.classList.add('warning');
                postBtn.disabled = len === 0 || len > 1000;
            });
            
            textarea.addEventListener('keydown', (e) => {
                if ((e.ctrlKey || e.metaKey) && e.key === 'Enter') {
                    e.preventDefault();
                    if (!postBtn.disabled) submitPost();
                }
            });
        }
        
        function triggerFileUpload() {
            document.getElementById('file-input').click();
        }
        
        async function handleFileSelect(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const validTypes = ['image/jpeg', 'image/png', 'image/gif', 'image/webp'];
            if (!validTypes.includes(file.type)) {
                showToast({ type: 'error', message: 'Ce format ne passe pas (essaie JPG, PNG ou GIF)' });
                return;
            }
            
            if (file.size > 5 * 1024 * 1024) {
                showToast({ type: 'error', message: 'Image trop lourde ! Max 5 Mo' });
                return;
            }
            
            const reader = new FileReader();
            reader.onload = async (e) => {
                showImagePreview(e.target.result);
                await uploadImage(e.target.result, file.type);
            };
            reader.readAsDataURL(file);
        }
        
        async function uploadImage(base64Data, contentType) {
            const progress = document.getElementById('upload-progress');
            progress.style.display = 'block';
            
            try {
                const res = await fetch(`${API_URL}/upload-image`, {
                    method: 'POST',
                    headers: authHeaders(),
                    body: JSON.stringify({ image: base64Data, contentType })
                });
                
                const data = await res.json();
                if (!res.ok) throw new Error(data.error || 'Erreur upload');
                
                currentImageUrl = data.url;
                showToast({ type: 'success', message: '📷 Image prête !' });
            } catch (e) {
                showToast({ type: 'error', message: e.message });
                removeImage();
            } finally {
                progress.style.display = 'none';
            }
        }
        
        function showImagePreview(url) {
            const preview = document.getElementById('image-preview');
            const img = document.getElementById('preview-img');
            img.src = url;
            img.onload = () => preview.classList.add('visible');
            img.onerror = () => preview.classList.remove('visible');
        }
        
        function removeImage() {
            document.getElementById('image-preview').classList.remove('visible');
            document.getElementById('preview-img').src = '';
            document.getElementById('file-input').value = '';
            currentImageUrl = null;
        }

        async function submitPost() {
            const content = document.getElementById('post-content').value.trim();
            if (!content) return;
            
            const postBtn = document.getElementById('post-btn');
            postBtn.disabled = true;
            postBtn.textContent = '...';
            
            try {
                const body = { content };
                if (currentImageUrl) body.image_url = currentImageUrl;
                
                const res = await fetch(`${API_URL}/posts`, {
                    method: 'POST',
                    headers: authHeaders(),
                    body: JSON.stringify(body)
                });
                
                const data = await res.json();
                if (!res.ok) throw new Error(data.error || 'Erreur');
                
                posts.unshift(data.post);
                renderPosts();
                
                document.getElementById('post-content').value = '';
                document.getElementById('char-count').textContent = '0/1000';
                removeImage();
                
                showToast({ type: 'success', message: 'Envoyé à tes 5 !' });
                
                // Onboarding: check progress after posting
                setTimeout(checkOnboardingProgress, 500);
            } catch (e) {
                showToast({ type: 'error', message: e.message });
            } finally {
                postBtn.disabled = false;
                postBtn.textContent = 'Poster';
            }
        }

        async function loadPosts() {
            const container = document.getElementById('posts-list');
            container.setAttribute('aria-busy', 'true');
            
            try {
                const res = await fetch(`${API_URL}/posts`, { headers: authHeaders() });
                const data = await res.json();
                if (!res.ok) throw new Error(data.error || 'Erreur');
                posts = data.posts || [];
                renderPosts();
            } catch (e) {
                container.innerHTML = `
                    <div class="empty-state" role="status">
                        <div class="empty-state-icon" aria-hidden="true">😵</div>
                        <div class="empty-state-title">Oups, ça a planté</div>
                        <div style="color:var(--color-text-muted)">Rafraîchis la page, ça devrait passer</div>
                    </div>
                `;
            } finally {
                container.setAttribute('aria-busy', 'false');
            }
        }

        function renderPosts() {
            const container = document.getElementById('posts-list');
            container.setAttribute('aria-busy', 'false');
            
            if (posts.length === 0) {
                container.innerHTML = `
                    <div class="empty-state" role="status">
                        <div class="empty-state-icon" aria-hidden="true">🌱</div>
                        <div class="empty-state-title">C'est calme ici</div>
                        <div style="color:var(--color-text-muted);max-width:300px;margin:0 auto;">
                            Brise la glace ! Poste un truc, ou ajoute tes proches pour voir ce qu'ils racontent.
                        </div>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = posts.map((post, index) => {
                const author = post.author || {};
                const isOwn = post.user_id === user.id;
                const avatarUrl = author.avatar_url;
                const initial = (author.display_name || author.email || '?')[0].toUpperCase();
                const displayName = author.display_name || author.email?.split('@')[0] || 'Anonyme';
                const time = formatTime(post.created_at);
                
                const avatarHtml = avatarUrl 
                    ? `<img data-src="${escapeHtml(avatarUrl)}" alt="" loading="lazy" class="lazy-image">`
                    : `<span aria-hidden="true">${initial}</span>`;
                
                const imageHtml = post.image_url ? `
                    <div class="post-image lazy-image-container">
                        <img data-src="${escapeHtml(post.image_url)}" alt="Image partagée par ${escapeHtml(displayName)}" onclick="openImageModal('${escapeHtml(post.image_url)}')" role="button" tabindex="0" onkeydown="if(event.key==='Enter')openImageModal('${escapeHtml(post.image_url)}')" loading="lazy" class="lazy-image">
                    </div>
                ` : '';
                
                const menuHtml = isOwn ? `
                    <button class="post-menu-btn" onclick="togglePostMenu('${post.id}')" type="button" aria-label="Options du post" aria-haspopup="menu" aria-expanded="false"><span aria-hidden="true">⋮</span></button>
                    <div class="post-menu" id="menu-${post.id}" role="menu">
                        <button class="post-menu-item" onclick="deletePost('${post.id}')" type="button" role="menuitem"><span aria-hidden="true">🗑️</span> Supprimer</button>
                    </div>
                ` : '';
                
                return `
                    <article class="post-card" data-post-id="${post.id}" aria-posinset="${index + 1}" aria-setsize="${posts.length}">
                        <div class="post-header">
                            <div class="post-author">
                                <div class="post-avatar ${isOwn ? 'own' : ''}" aria-hidden="true">${avatarHtml}</div>
                                <div>
                                    <span class="post-author-name">
                                        ${escapeHtml(displayName)}
                                        ${isOwn ? '<span class="you-badge">(toi)</span>' : ''}
                                    </span>
                                    <div class="post-time"><time datetime="${post.created_at}">${time}</time></div>
                                </div>
                            </div>
                            ${menuHtml}
                        </div>
                        <div class="post-content">${escapeHtml(post.content)}</div>
                        ${imageHtml}
                    </article>
                `;
            }).join('');
            
            // Observe lazy images after render
            requestAnimationFrame(() => observeLazyImages());
        }
        
        function togglePostMenu(postId) {
            // Close other menus and update their aria-expanded
            document.querySelectorAll('.post-menu.open').forEach(m => {
                if (m.id !== `menu-${postId}`) {
                    m.classList.remove('open');
                    const btn = m.previousElementSibling;
                    if (btn) btn.setAttribute('aria-expanded', 'false');
                }
            });
            
            const menu = document.getElementById(`menu-${postId}`);
            const isOpen = menu.classList.toggle('open');
            const btn = menu.previousElementSibling;
            if (btn) btn.setAttribute('aria-expanded', isOpen ? 'true' : 'false');
        }
        
        async function deletePost(postId) {
            if (!confirm('Supprimer ce post ?')) return;
            
            try {
                const res = await fetch(`${API_URL}/posts?id=${postId}`, {
                    method: 'DELETE',
                    headers: authHeaders()
                });
                if (!res.ok) throw new Error((await res.json()).error || 'Erreur');
                posts = posts.filter(p => p.id !== postId);
                renderPosts();
                showToast({ type: 'success', message: 'Post supprimé' });
            } catch (e) {
                showToast({ type: 'error', message: e.message });
            }
        }
        
        function openImageModal(url) {
            event.stopPropagation();
            document.getElementById('modal-image').src = url;
            document.getElementById('image-modal').classList.add('open');
        }
        
        function closeImageModal() {
            document.getElementById('image-modal').classList.remove('open');
        }

        // ===== CONTACTS =====
        async function loadContacts() {
            try {
                const res = await fetch(`${API_URL}/contacts`, { headers: authHeaders() });
                const data = await res.json();
                
                if (res.status === 401) { logout(); return; }
                
                contacts = data.contacts || [];
                
                for (const contact of contacts) {
                    if (!lastMessageIds[contact.contact_user_id]) {
                        try {
                            const msgRes = await fetch(`${API_URL}/messages?contact_id=${contact.contact_user_id}&limit=1`, { headers: authHeaders() });
                            const msgData = await msgRes.json();
                            if (msgData.messages?.length > 0) {
                                lastMessageIds[contact.contact_user_id] = msgData.messages[msgData.messages.length - 1].id;
                            }
                        } catch (e) {}
                    }
                }
                
                renderContacts();
                loadSuggestions();
            } catch (e) {
                showToast({ type: 'error', title: 'Oups', message: 'Impossible de charger tes contacts. Réseau ?' });
            }
        }

        function renderContacts() {
            const grid = document.getElementById('contacts-grid');
            grid.innerHTML = '';

            for (let i = 0; i < 5; i++) {
                const contact = contacts[i];
                const slot = document.createElement('div');
                slot.className = `contact-slot ${contact ? 'filled' : 'empty'}`;
                slot.tabIndex = 0;
                slot.setAttribute('role', 'listitem');
                
                if (contact) {
                    const name = contact.contact?.display_name || contact.contact?.email?.split('@')[0] || '?';
                    const initial = name.charAt(0).toUpperCase();
                    const avatarUrl = contact.contact?.avatar_url;
                    const unread = unreadCounts[contact.contact_user_id] || 0;
                    
                    const unreadText = unread > 0 ? `, ${unread} message${unread > 1 ? 's' : ''} non lu${unread > 1 ? 's' : ''}` : '';
                    slot.setAttribute('aria-label', `${escapeHtml(name)}${unreadText}. Appuie pour ouvrir la conversation`);
                    
                    // SECURITY: Use DOM methods instead of innerHTML to prevent XSS
                    const avatarSlot = document.createElement('div');
                    avatarSlot.className = 'contact-avatar-slot';
                    avatarSlot.setAttribute('aria-hidden', 'true');
                    if (avatarUrl) {
                        const img = document.createElement('img');
                        img.dataset.src = avatarUrl;
                        img.alt = '';
                        img.loading = 'lazy';
                        img.className = 'lazy-image';
                        avatarSlot.appendChild(img);
                    } else {
                        const span = document.createElement('span');
                        span.setAttribute('aria-hidden', 'true');
                        span.textContent = initial;
                        avatarSlot.appendChild(span);
                    }
                    
                    const nameDiv = document.createElement('div');
                    nameDiv.className = 'contact-name';
                    nameDiv.setAttribute('aria-hidden', 'true');
                    nameDiv.textContent = name;
                    
                    slot.appendChild(avatarSlot);
                    slot.appendChild(nameDiv);
                    
                    if (unread > 0) {
                        const badge = document.createElement('div');
                        badge.className = 'unread-badge';
                        badge.setAttribute('aria-hidden', 'true');
                        badge.textContent = unread > 9 ? '9+' : unread;
                        slot.appendChild(badge);
                    }
                    
                    slot.onclick = () => openChat(contact);
                    slot.onkeydown = (e) => { if (e.key === 'Enter' || e.key === ' ') { e.preventDefault(); openChat(contact); } };
                } else {
                    slot.setAttribute('aria-label', `Emplacement ${i + 1} vide. Appuie pour ajouter un contact`);
                    const plusSpan = document.createElement('span');
                    plusSpan.className = 'empty-plus';
                    plusSpan.setAttribute('aria-hidden', 'true');
                    plusSpan.textContent = '+';
                    slot.appendChild(plusSpan);
                    slot.onclick = () => openAddContactModal();
                    slot.onkeydown = (e) => { if (e.key === 'Enter' || e.key === ' ') { e.preventDefault(); openAddContactModal(); } };
                }
                
                grid.appendChild(slot);
            }

            document.getElementById('contact-count').textContent = `${contacts.length}/5`;
            
            // Observe lazy images after render
            requestAnimationFrame(() => observeLazyImages());
        }

        // ===== SUGGESTIONS =====
        let suggestions = [];
        
        async function loadSuggestions() {
            const list = document.getElementById('suggestions-list');
            const section = document.getElementById('suggestions-section');
            
            // Only show suggestions if user has fewer than 5 contacts
            if (contacts.length >= 5) {
                section.style.display = 'none';
                return;
            }
            
            section.style.display = 'block';
            list.innerHTML = '<div class="suggestions-empty" id="suggestions-loading"><span class="loading-spinner"></span> Chargement des suggestions...</div>';
            
            try {
                const res = await fetch(`${API_URL}/suggestions`, { headers: authHeaders() });
                const data = await res.json();
                
                if (res.status === 401) { logout(); return; }
                
                suggestions = data.suggestions || [];
                renderSuggestions(data.message);
            } catch (e) {
                list.innerHTML = '<div class="suggestions-empty">Impossible de charger les suggestions</div>';
            }
        }
        
        function renderSuggestions(emptyMessage) {
            const list = document.getElementById('suggestions-list');
            
            if (!suggestions || suggestions.length === 0) {
                list.innerHTML = `<div class="suggestions-empty">${escapeHtml(emptyMessage || 'Pas de suggestions pour le moment')}</div>`;
                return;
            }
            
            list.innerHTML = '';
            
            suggestions.forEach(s => {
                const card = document.createElement('div');
                card.className = 'suggestion-card';
                card.setAttribute('role', 'listitem');
                card.dataset.userId = s.user.id;
                
                const name = s.user.display_name || s.user.email?.split('@')[0] || 'Utilisateur';
                const initial = name.charAt(0).toUpperCase();
                
                // Avatar
                const avatarDiv = document.createElement('div');
                avatarDiv.className = 'suggestion-avatar';
                if (s.user.avatar_url) {
                    const img = document.createElement('img');
                    img.src = s.user.avatar_url;
                    img.alt = '';
                    img.loading = 'lazy';
                    avatarDiv.appendChild(img);
                } else {
                    avatarDiv.textContent = initial;
                }
                
                // Info section
                const infoDiv = document.createElement('div');
                infoDiv.className = 'suggestion-info';
                
                const nameDiv = document.createElement('div');
                nameDiv.className = 'suggestion-name';
                nameDiv.textContent = name;
                
                const mutualDiv = document.createElement('div');
                mutualDiv.className = 'suggestion-mutual';
                
                // Mutual contact avatars
                if (s.mutualContacts && s.mutualContacts.length > 0) {
                    const avatarsDiv = document.createElement('div');
                    avatarsDiv.className = 'suggestion-mutual-avatars';
                    
                    s.mutualContacts.slice(0, 3).forEach(mc => {
                        const miniAvatar = document.createElement('div');
                        miniAvatar.className = 'mini-avatar';
                        if (mc.avatar_url) {
                            const img = document.createElement('img');
                            img.src = mc.avatar_url;
                            img.alt = '';
                            miniAvatar.appendChild(img);
                        } else {
                            miniAvatar.textContent = (mc.display_name || '?').charAt(0).toUpperCase();
                        }
                        avatarsDiv.appendChild(miniAvatar);
                    });
                    
                    mutualDiv.appendChild(avatarsDiv);
                }
                
                const mutualText = document.createElement('span');
                mutualText.textContent = s.mutualCount === 1 
                    ? '1 ami en commun' 
                    : `${s.mutualCount} amis en commun`;
                mutualDiv.appendChild(mutualText);
                
                infoDiv.appendChild(nameDiv);
                infoDiv.appendChild(mutualDiv);
                
                // Actions
                const actionsDiv = document.createElement('div');
                actionsDiv.className = 'suggestion-actions';
                
                const ignoreBtn = document.createElement('button');
                ignoreBtn.className = 'suggestion-btn ignore';
                ignoreBtn.type = 'button';
                ignoreBtn.setAttribute('aria-label', 'Ignorer cette suggestion');
                ignoreBtn.innerHTML = '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>';
                ignoreBtn.onclick = () => ignoreSuggestion(s.user.id, card);
                
                const addBtn = document.createElement('button');
                addBtn.className = 'suggestion-btn add';
                addBtn.type = 'button';
                addBtn.setAttribute('aria-label', 'Ajouter ce contact');
                addBtn.innerHTML = '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>';
                addBtn.onclick = () => addSuggestionAsContact(s.user.id, s.user.email, card);
                
                actionsDiv.appendChild(ignoreBtn);
                actionsDiv.appendChild(addBtn);
                
                card.appendChild(avatarDiv);
                card.appendChild(infoDiv);
                card.appendChild(actionsDiv);
                
                list.appendChild(card);
            });
        }
        
        async function addSuggestionAsContact(userId, email, cardElement) {
            const addBtn = cardElement.querySelector('.suggestion-btn.add');
            addBtn.disabled = true;
            
            try {
                const res = await fetch(`${API_URL}/contacts`, {
                    method: 'POST',
                    headers: authHeaders(),
                    body: JSON.stringify({ contactId: userId })
                });
                
                const data = await res.json();
                
                if (!res.ok) {
                    throw new Error(data.error || 'Erreur lors de l\'ajout');
                }
                
                // Remove card with animation
                cardElement.style.transform = 'translateX(100%)';
                cardElement.style.opacity = '0';
                setTimeout(() => {
                    cardElement.remove();
                    suggestions = suggestions.filter(s => s.user.id !== userId);
                    if (suggestions.length === 0) {
                        renderSuggestions('Bravo ! Tu as ajouté toutes les suggestions');
                    }
                }, 300);
                
                showToast({ type: 'success', message: 'Contact ajouté !' });
                
                // Refresh contacts
                loadContacts();
                
            } catch (e) {
                showToast({ type: 'error', message: e.message });
                addBtn.disabled = false;
            }
        }
        
        async function ignoreSuggestion(userId, cardElement) {
            const ignoreBtn = cardElement.querySelector('.suggestion-btn.ignore');
            ignoreBtn.disabled = true;
            
            try {
                const res = await fetch(`${API_URL}/suggestions`, {
                    method: 'POST',
                    headers: authHeaders(),
                    body: JSON.stringify({ userId })
                });
                
                if (!res.ok) {
                    const data = await res.json();
                    throw new Error(data.error || 'Erreur');
                }
                
                // Remove card with animation
                cardElement.style.transform = 'translateX(-100%)';
                cardElement.style.opacity = '0';
                setTimeout(() => {
                    cardElement.remove();
                    suggestions = suggestions.filter(s => s.user.id !== userId);
                    if (suggestions.length === 0) {
                        renderSuggestions('Plus de suggestions pour le moment');
                    }
                }, 300);
                
            } catch (e) {
                showToast({ type: 'error', message: e.message });
                ignoreBtn.disabled = false;
            }
        }

        // ===== CHAT =====
        let typingTimeout = null;
        let isTyping = false;
        
        function setupChatInput() {
            const input = document.getElementById('chat-input');
            const btn = document.getElementById('send-btn');
            
            input.addEventListener('input', () => {
                btn.disabled = !input.value.trim();
                
                // Typing indicator logic - broadcast typing state
                if (input.value.trim() && !isTyping) {
                    isTyping = true;
                    broadcastTypingState(true);
                }
                
                // Clear existing timeout
                if (typingTimeout) clearTimeout(typingTimeout);
                
                // Set timeout to stop typing indicator after 2 seconds of inactivity
                typingTimeout = setTimeout(() => {
                    if (isTyping) {
                        isTyping = false;
                        broadcastTypingState(false);
                    }
                }, 2000);
            });
            
            input.addEventListener('keypress', (e) => {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    sendMessage();
                }
            });
            
            // Stop typing when input loses focus
            input.addEventListener('blur', () => {
                if (isTyping) {
                    isTyping = false;
                    if (typingTimeout) clearTimeout(typingTimeout);
                    broadcastTypingState(false);
                }
            });
        }
        
        // Broadcast typing state (can be connected to real-time later)
        function broadcastTypingState(typing) {
            // For now, this is a placeholder for future WebSocket implementation
            // When implemented, it would send typing state to the server
            console.debug('Typing state:', typing);
        }
        
        // Show/hide typing indicator from contact
        function showTypingIndicator(show = true) {
            const indicator = document.getElementById('typing-indicator');
            const container = document.getElementById('chat-messages');
            
            if (show) {
                indicator.classList.add('visible');
                // Scroll to show typing indicator
                container.scrollTo({
                    top: container.scrollHeight,
                    behavior: 'smooth'
                });
            } else {
                indicator.classList.remove('visible');
            }
        }
        
        let lastFocusedElement = null;
        
        function openChat(contact) {
            lastFocusedElement = document.activeElement;
            currentChatContact = contact;
            unreadCounts[contact.contact_user_id] = 0;
            renderContacts();
            
            const name = contact.contact?.display_name || contact.contact?.email?.split('@')[0] || 'Contact';
            const avatarUrl = contact.contact?.avatar_url;
            const initial = name.charAt(0).toUpperCase();
            
            document.getElementById('chat-contact-name').textContent = name;
            
            const chatAvatar = document.getElementById('chat-contact-avatar');
            chatAvatar.innerHTML = avatarUrl 
                ? `<img src="${avatarUrl}" alt="">`
                : `<span aria-hidden="true">${initial}</span>`;
            
            const chatPanel = document.getElementById('chat-panel');
            const chatOverlay = document.getElementById('chat-overlay');
            
            chatPanel.classList.add('open');
            chatPanel.setAttribute('aria-hidden', 'false');
            chatOverlay.classList.add('open');
            
            // Focus on chat input
            setTimeout(() => document.getElementById('chat-input').focus(), 100);
            
            // Setup focus trap
            setupFocusTrap(chatPanel);
            
            loadMessages();
            messagePollingInterval = setInterval(loadMessages, 3000);
        }

        function closeChat() {
            const chatPanel = document.getElementById('chat-panel');
            const chatOverlay = document.getElementById('chat-overlay');
            
            chatPanel.classList.remove('open');
            chatPanel.setAttribute('aria-hidden', 'true');
            chatOverlay.classList.remove('open');
            
            currentChatContact = null;
            if (messagePollingInterval) {
                clearInterval(messagePollingInterval);
                messagePollingInterval = null;
            }
            
            // Restore focus
            if (lastFocusedElement) {
                lastFocusedElement.focus();
                lastFocusedElement = null;
            }
        }
        
        // ===== FOCUS TRAP FOR MODALS =====
        function setupFocusTrap(container) {
            const focusableSelectors = 'button:not([disabled]), [href], input:not([disabled]), select:not([disabled]), textarea:not([disabled]), [tabindex]:not([tabindex="-1"])';
            
            container.addEventListener('keydown', function trapFocus(e) {
                if (e.key !== 'Tab') return;
                
                const focusableElements = container.querySelectorAll(focusableSelectors);
                const firstFocusable = focusableElements[0];
                const lastFocusable = focusableElements[focusableElements.length - 1];
                
                if (e.shiftKey && document.activeElement === firstFocusable) {
                    e.preventDefault();
                    lastFocusable.focus();
                } else if (!e.shiftKey && document.activeElement === lastFocusable) {
                    e.preventDefault();
                    firstFocusable.focus();
                }
            });
        }

        async function loadMessages() {
            if (!currentChatContact) return;
            
            try {
                const res = await fetch(`${API_URL}/messages?contact_id=${currentChatContact.contact_user_id}`, { headers: authHeaders() });
                const data = await res.json();
                
                const messages = data.messages || [];
                if (messages.length > 0) {
                    lastMessageIds[currentChatContact.contact_user_id] = messages[messages.length - 1].id;
                }
                
                renderMessages(messages);
            } catch (e) {}
        }

        function renderMessages(messages) {
            const container = document.getElementById('chat-messages');
            const wasAtBottom = container.scrollHeight - container.scrollTop <= container.clientHeight + 50;
            const contactName = currentChatContact?.contact?.display_name || 'Contact';
            
            // Preserve typing indicator state
            const typingIndicator = document.getElementById('typing-indicator');
            const wasTypingVisible = typingIndicator?.classList.contains('visible');
            
            let lastDate = null;
            let html = '';
            
            messages.forEach((msg, index) => {
                const isSent = msg.sender_id === user.id;
                const sender = isSent ? 'Toi' : contactName;
                const msgDate = new Date(msg.created_at);
                const msgDateStr = msgDate.toDateString();
                
                // Add date separator if new day
                if (msgDateStr !== lastDate) {
                    lastDate = msgDateStr;
                    html += `<div class="chat-date-separator" aria-label="Messages du ${formatDateSeparator(msg.created_at)}"><span>${formatDateSeparator(msg.created_at)}</span></div>`;
                }
                
                if (msg.is_ping) {
                    html += `<div class="chat-message ping" role="article" aria-label="${sender} a envoyé un coucou"><span aria-hidden="true">👋</span></div>`;
                } else {
                    // Build read receipt for sent messages
                    let receiptHtml = '';
                    if (isSent) {
                        const readStatus = msg.read_at ? 'read' : 'delivered';
                        const checkIcon = `<svg viewBox="0 0 16 11" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M1 5.5L5 9.5L14.5 1"/></svg>`;
                        const doubleCheckIcon = `<svg viewBox="0 0 20 11" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M1 5.5L5 9.5L14.5 1"/><path d="M5 5.5L9 9.5L18.5 1"/></svg>`;
                        receiptHtml = `<span class="chat-read-receipt ${readStatus}" aria-label="${msg.read_at ? 'Lu' : 'Envoyé'}">${msg.read_at ? doubleCheckIcon : checkIcon}</span>`;
                    }
                    
                    html += `
                        <div class="chat-message ${isSent ? 'sent' : 'received'}" role="article" aria-label="${sender} dit">
                            <div class="chat-message-content">${escapeHtml(msg.content)}</div>
                            <div class="chat-message-meta">
                                <span class="chat-message-time">${formatMessageTime(msg.created_at)}</span>
                                ${receiptHtml}
                            </div>
                        </div>
                    `;
                }
            });
            
            // Add typing indicator at the end
            html += `
                <div class="typing-indicator${wasTypingVisible ? ' visible' : ''}" id="typing-indicator" aria-live="polite" aria-label="En train d'écrire">
                    <div class="typing-dot"></div>
                    <div class="typing-dot"></div>
                    <div class="typing-dot"></div>
                </div>
            `;
            
            container.innerHTML = html;

            // Smooth scroll to bottom
            if (wasAtBottom) {
                container.scrollTo({
                    top: container.scrollHeight,
                    behavior: 'smooth'
                });
            }
        }

        async function sendMessage() {
            const input = document.getElementById('chat-input');
            const content = input.value.trim();
            if (!content || !currentChatContact) return;

            const btn = document.getElementById('send-btn');
            btn.disabled = true;
            
            // Stop typing indicator
            if (isTyping) {
                isTyping = false;
                if (typingTimeout) clearTimeout(typingTimeout);
                broadcastTypingState(false);
            }
            
            // Add sending animation
            btn.classList.add('sending');
            triggerHaptic('tap');
            
            // Optimistic update - show message immediately
            const optimisticMsg = {
                id: 'temp-' + Date.now(),
                sender_id: user.id,
                content: content,
                created_at: new Date().toISOString(),
                is_ping: false,
                read_at: null,
                _sending: true
            };
            
            addOptimisticMessage(optimisticMsg);
            input.value = '';

            try {
                const res = await fetch(`${API_URL}/messages`, {
                    method: 'POST',
                    headers: authHeaders(),
                    body: JSON.stringify({ contact_id: currentChatContact.contact_user_id, content })
                });
                
                if (!res.ok) throw new Error('Échec envoi');
                
                triggerHaptic('success');
                // Refresh to get the real message with proper ID
                loadMessages();
            } catch (e) {
                triggerHaptic('error');
                showToast({ type: 'error', message: 'Message pas parti. Réessaie ?' });
                // Remove optimistic message on error
                removeOptimisticMessage(optimisticMsg.id);
            } finally {
                setTimeout(() => btn.classList.remove('sending'), 500);
                btn.disabled = !input.value.trim();
            }
        }
        
        // Add a message optimistically before server confirms
        function addOptimisticMessage(msg) {
            const container = document.getElementById('chat-messages');
            
            const msgEl = document.createElement('div');
            msgEl.className = 'chat-message sent';
            msgEl.id = `msg-${msg.id}`;
            msgEl.setAttribute('role', 'article');
            msgEl.setAttribute('aria-label', 'Toi dit');
            
            const checkIcon = `<svg viewBox="0 0 16 11" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M1 5.5L5 9.5L14.5 1"/></svg>`;
            
            msgEl.innerHTML = `
                <div class="chat-message-content">${escapeHtml(msg.content)}</div>
                <div class="chat-message-meta">
                    <span class="chat-message-time">${formatMessageTime(msg.created_at)}</span>
                    <span class="chat-read-receipt sent" aria-label="Envoi en cours">${checkIcon}</span>
                </div>
            `;
            
            container.appendChild(msgEl);
            
            // Smooth scroll to the new message
            container.scrollTo({
                top: container.scrollHeight,
                behavior: 'smooth'
            });
        }
        
        // Remove an optimistic message (on error)
        function removeOptimisticMessage(msgId) {
            const msgEl = document.getElementById(`msg-${msgId}`);
            if (msgEl) {
                msgEl.style.opacity = '0';
                msgEl.style.transform = 'translateX(20px)';
                setTimeout(() => msgEl.remove(), 300);
            }
        }

        async function sendPing() {
            if (!currentChatContact) return;
            
            const btn = document.querySelector('.ping-btn');
            btn.classList.add('pinged');
            triggerHaptic('ping');
            
            // Optimistic ping
            const optimisticPing = {
                id: 'temp-ping-' + Date.now(),
                sender_id: user.id,
                content: '👋',
                created_at: new Date().toISOString(),
                is_ping: true
            };
            
            const container = document.getElementById('chat-messages');
            const pingEl = document.createElement('div');
            pingEl.className = 'chat-message ping';
            pingEl.id = `msg-${optimisticPing.id}`;
            pingEl.setAttribute('role', 'article');
            pingEl.setAttribute('aria-label', 'Tu as envoyé un coucou');
            pingEl.innerHTML = '<span aria-hidden="true">👋</span>';
            container.appendChild(pingEl);
            container.scrollTo({ top: container.scrollHeight, behavior: 'smooth' });
            
            try {
                await fetch(`${API_URL}/messages`, {
                    method: 'POST',
                    headers: authHeaders(),
                    body: JSON.stringify({ contact_id: currentChatContact.contact_user_id, is_ping: true })
                });
                // Refresh to sync with server
                loadMessages();
            } catch (e) {
                triggerHaptic('error');
                showToast({ type: 'error', message: 'Le ping n\'est pas passé 😕' });
                removeOptimisticMessage(optimisticPing.id);
            } finally {
                setTimeout(() => btn.classList.remove('pinged'), 600);
            }
        }

        // ===== POLLING =====
        function startPolling() {
            contactPollingInterval = setInterval(checkForNewMessages, 10000);
        }
        
        function stopPolling() {
            if (contactPollingInterval) clearInterval(contactPollingInterval);
            if (messagePollingInterval) clearInterval(messagePollingInterval);
        }

        async function checkForNewMessages() {
            for (const contact of contacts) {
                try {
                    const res = await fetch(`${API_URL}/messages?contact_id=${contact.contact_user_id}&limit=1`, { headers: authHeaders() });
                    const data = await res.json();
                    
                    if (data.messages?.length > 0) {
                        const latestMsg = data.messages[data.messages.length - 1];
                        const lastKnown = lastMessageIds[contact.contact_user_id];
                        
                        if (latestMsg.id !== lastKnown && latestMsg.sender_id !== user.id) {
                            lastMessageIds[contact.contact_user_id] = latestMsg.id;
                            
                            if (!currentChatContact || currentChatContact.contact_user_id !== contact.contact_user_id) {
                                unreadCounts[contact.contact_user_id] = (unreadCounts[contact.contact_user_id] || 0) + 1;
                                renderContacts();
                                
                                const senderName = contact.contact?.email?.split('@')[0] || 'Contact';
                                showToast({
                                    type: 'notification',
                                    title: `Nouveau message de ${senderName}`,
                                    message: latestMsg.is_ping ? '👋' : latestMsg.content.substring(0, 50),
                                    onClick: () => openChat(contact)
                                });
                            }
                        }
                    }
                } catch (e) {
                    // Silently fail polling - not critical, just log for debugging
                    console.debug('Polling failed for contact:', contact.contact_user_id, e.message);
                }
            }
        }

        // ===== SEARCH =====
        function openSearch() {
            const overlay = document.getElementById('search-overlay');
            const input = document.getElementById('search-input');
            overlay.classList.add('open');
            setTimeout(() => input.focus(), 100);
            document.body.style.overflow = 'hidden';
        }
        
        function closeSearch() {
            const overlay = document.getElementById('search-overlay');
            overlay.classList.remove('open');
            document.getElementById('search-input').value = '';
            document.getElementById('search-results').innerHTML = `
                <div class="search-hint">
                    <p>Tape au moins 2 caractères pour rechercher</p>
                    <p style="margin-top: var(--space-2);">Raccourci : <kbd>Ctrl</kbd> + <kbd>K</kbd></p>
                </div>
            `;
            document.body.style.overflow = '';
        }
        
        function setSearchType(type) {
            currentSearchType = type;
            document.querySelectorAll('.search-tab').forEach(tab => {
                tab.classList.toggle('active', tab.dataset.type === type);
            });
            
            // Re-run search with new type
            const query = document.getElementById('search-input').value.trim();
            if (query.length >= 2) {
                performSearch(query);
            }
        }
        
        function initSearch() {
            const input = document.getElementById('search-input');
            
            input.addEventListener('input', (e) => {
                const query = e.target.value.trim();
                
                // Clear previous timeout
                if (searchTimeout) clearTimeout(searchTimeout);
                
                if (query.length < 2) {
                    document.getElementById('search-results').innerHTML = `
                        <div class="search-hint">
                            <p>Tape au moins 2 caractères pour rechercher</p>
                            <p style="margin-top: var(--space-2);">Raccourci : <kbd>Ctrl</kbd> + <kbd>K</kbd></p>
                        </div>
                    `;
                    return;
                }
                
                // Debounce search
                searchTimeout = setTimeout(() => performSearch(query), 300);
            });
            
            // Keyboard shortcut Ctrl+K or Cmd+K
            document.addEventListener('keydown', (e) => {
                if ((e.ctrlKey || e.metaKey) && e.key === 'k') {
                    e.preventDefault();
                    const overlay = document.getElementById('search-overlay');
                    if (overlay.classList.contains('open')) {
                        closeSearch();
                    } else {
                        openSearch();
                    }
                }
            });
        }
        
        async function performSearch(query) {
            const resultsEl = document.getElementById('search-results');
            
            if (isSearching) return;
            isSearching = true;
            
            resultsEl.innerHTML = '<div class="search-loading"><div class="loading-spinner"></div></div>';
            
            try {
                const typeParam = currentSearchType !== 'all' ? `&type=${currentSearchType}` : '';
                const res = await fetch(`${API_URL}/search?q=${encodeURIComponent(query)}${typeParam}`, { 
                    headers: authHeaders() 
                });
                
                if (!res.ok) {
                    const data = await res.json();
                    throw new Error(data.error || 'Erreur de recherche');
                }
                
                const data = await res.json();
                renderSearchResults(data, query);
            } catch (e) {
                resultsEl.innerHTML = `
                    <div class="search-empty">
                        <div class="search-empty-icon">😵</div>
                        <p>${escapeHtml(e.message)}</p>
                    </div>
                `;
            } finally {
                isSearching = false;
            }
        }
        
        function renderSearchResults(data, query) {
            const resultsEl = document.getElementById('search-results');
            const hasContacts = data.contacts && data.contacts.length > 0;
            const hasPosts = data.posts && data.posts.length > 0;
            
            if (!hasContacts && !hasPosts) {
                resultsEl.innerHTML = `
                    <div class="search-empty">
                        <div class="search-empty-icon">🔍</div>
                        <p>Aucun résultat pour "${escapeHtml(query)}"</p>
                    </div>
                `;
                return;
            }
            
            let html = '';
            
            // Contacts section
            if (hasContacts && (currentSearchType === 'all' || currentSearchType === 'contacts')) {
                html += `
                    <div class="search-section">
                        <div class="search-section-title">
                            <span>👥 Contacts</span>
                            <span class="search-section-count">${data.contacts.length}</span>
                        </div>
                `;
                
                data.contacts.forEach(contact => {
                    const name = contact.display_name || contact.email?.split('@')[0] || 'Contact';
                    const initial = name.charAt(0).toUpperCase();
                    const highlightedName = highlightQuery(name, query);
                    const highlightedEmail = contact.email ? highlightQuery(contact.email, query) : '';
                    
                    html += `
                        <div class="search-result-item" onclick="goToContactFromSearch('${contact.id}')">
                            <div class="search-result-avatar">
                                ${contact.avatar_url 
                                    ? `<img src="${escapeHtml(contact.avatar_url)}" alt="">` 
                                    : initial}
                            </div>
                            <div class="search-result-info">
                                <div class="search-result-name">${highlightedName}</div>
                                <div class="search-result-meta">${highlightedEmail}${contact.mutual ? ' • 🤝 Mutuel' : ''}</div>
                            </div>
                        </div>
                    `;
                });
                
                html += '</div>';
            }
            
            // Posts section
            if (hasPosts && (currentSearchType === 'all' || currentSearchType === 'posts')) {
                html += `
                    <div class="search-section">
                        <div class="search-section-title">
                            <span>📝 Posts</span>
                            <span class="search-section-count">${data.posts.length}</span>
                        </div>
                `;
                
                data.posts.forEach(post => {
                    const author = post.author || {};
                    const authorName = author.display_name || author.email?.split('@')[0] || 'Utilisateur';
                    const initial = authorName.charAt(0).toUpperCase();
                    const highlightedContent = highlightQuery(post.content.substring(0, 150), query);
                    const timeAgo = formatTime(post.created_at);
                    
                    html += `
                        <div class="search-result-item" onclick="goToPostFromSearch('${post.id}')">
                            <div class="search-result-avatar">
                                ${author.avatar_url 
                                    ? `<img src="${escapeHtml(author.avatar_url)}" alt="">` 
                                    : initial}
                            </div>
                            <div class="search-result-info">
                                <div class="search-result-name">
                                    ${escapeHtml(authorName)}
                                    ${post.isOwn ? '<span style="color:var(--color-success);font-size:var(--text-xs);margin-left:var(--space-1);">(toi)</span>' : ''}
                                </div>
                                <div class="search-result-meta">${timeAgo}</div>
                                <div class="search-result-preview">${highlightedContent}${post.content.length > 150 ? '...' : ''}</div>
                            </div>
                        </div>
                    `;
                });
                
                html += '</div>';
            }
            
            resultsEl.innerHTML = html;
        }
        
        function highlightQuery(text, query) {
            if (!text || !query) return escapeHtml(text || '');
            
            const escaped = escapeHtml(text);
            const regex = new RegExp(`(${escapeHtml(query)})`, 'gi');
            return escaped.replace(regex, '<mark>$1</mark>');
        }
        
        function goToContactFromSearch(contactId) {
            closeSearch();
            switchTab('contacts');
            
            // Find the contact and open chat
            const contact = contacts.find(c => c.contact_user_id === contactId);
            if (contact) {
                setTimeout(() => openChat(contact), 300);
            }
        }
        
        function goToPostFromSearch(postId) {
            closeSearch();
            switchTab('feed');
            
            // Scroll to post
            setTimeout(() => {
                const postEl = document.querySelector(`[data-post-id="${postId}"]`);
                if (postEl) {
                    postEl.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    postEl.classList.add('new-post');
                    setTimeout(() => postEl.classList.remove('new-post'), 1000);
                }
            }, 300);
        }

        // ===== MODALS =====
        function openModal(modalId, focusSelector) {
            const modal = document.getElementById(modalId);
            lastFocusedElement = document.activeElement;
            modal.classList.add('open');
            modal.setAttribute('aria-hidden', 'false');
            setupFocusTrap(modal);
            
            // Focus first focusable element or specified selector
            setTimeout(() => {
                const focusTarget = focusSelector ? modal.querySelector(focusSelector) : modal.querySelector('button, input, [tabindex="0"]');
                if (focusTarget) focusTarget.focus();
            }, 100);
        }
        
        function closeModal(modalId) {
            const modal = document.getElementById(modalId);
            modal.classList.remove('open');
            modal.setAttribute('aria-hidden', 'true');
            
            if (lastFocusedElement) {
                lastFocusedElement.focus();
                lastFocusedElement = null;
            }
        }
        
        function openGiftModal() {
            document.getElementById('gift-content').innerHTML = `<button class="save-btn" style="width:100%;" onclick="createGift()" type="button">Générer un code</button>`;
            openModal('gift-modal', '.save-btn');
        }
        
        function closeGiftModal() {
            closeModal('gift-modal');
        }

        // Store last gift URL for copy function (avoids inline onclick with URL)
        let lastGiftUrl = null;
        
        async function createGift() {
            const contentEl = document.getElementById('gift-content');
            contentEl.innerHTML = '<div class="loading-spinner" style="margin:var(--space-8) auto;"></div>';
            
            try {
                const res = await fetch(`${API_URL}/gift?action=create`, { method: 'POST', headers: authHeaders() });
                const data = await res.json();
                if (!res.ok) throw new Error(data.error || 'Erreur');

                // SECURITY: Store URL in variable, use DOM methods to prevent XSS
                lastGiftUrl = data.gift.shareUrl;
                
                contentEl.innerHTML = '';
                
                const codeDisplay = document.createElement('div');
                codeDisplay.className = 'gift-code-display';
                const codeDiv = document.createElement('div');
                codeDiv.className = 'gift-code';
                codeDiv.textContent = data.gift.code; // Safe: textContent escapes
                codeDisplay.appendChild(codeDiv);
                
                const copyBtn = document.createElement('button');
                copyBtn.className = 'save-btn';
                copyBtn.style.width = '100%';
                copyBtn.type = 'button';
                copyBtn.setAttribute('aria-label', 'Copier le lien d\'invitation');
                copyBtn.innerHTML = '<span aria-hidden="true">📋</span> Copier le lien';
                copyBtn.onclick = () => copyGift(lastGiftUrl);
                
                const expiryP = document.createElement('p');
                expiryP.style.cssText = 'font-size:var(--text-xs);color:var(--color-text-muted);margin-top:var(--space-4);text-align:center;';
                expiryP.textContent = 'Valable 30 jours';
                
                contentEl.appendChild(codeDisplay);
                contentEl.appendChild(copyBtn);
                contentEl.appendChild(expiryP);
            } catch (e) {
                // SECURITY: Use DOM methods to prevent XSS from error messages
                contentEl.innerHTML = '';
                
                const errorP = document.createElement('p');
                errorP.style.cssText = 'color:var(--color-error);text-align:center;';
                errorP.textContent = e.message; // Safe: textContent escapes
                
                const retryBtn = document.createElement('button');
                retryBtn.className = 'save-btn';
                retryBtn.style.cssText = 'width:100%;margin-top:var(--space-4);';
                retryBtn.textContent = 'Réessayer';
                retryBtn.onclick = createGift;
                
                contentEl.appendChild(errorP);
                contentEl.appendChild(retryBtn);
            }
        }

        async function copyGift(url) {
            try {
                await navigator.clipboard.writeText(url);
                showToast({ type: 'success', title: 'Copié !', message: 'Lien copié' });
            } catch (e) {
                showToast({ type: 'error', message: 'Impossible de copier' });
            }
        }

        function openAddContactModal() {
            document.getElementById('contact-id-input').value = '';
            document.getElementById('add-contact-error').style.display = 'none';
            document.getElementById('my-id').textContent = user?.id || 'Non disponible';
            openModal('add-contact-modal', '#contact-id-input');
        }
        
        function closeAddContactModal() {
            closeModal('add-contact-modal');
        }

        async function addContact() {
            const contactId = document.getElementById('contact-id-input').value.trim();
            const errorEl = document.getElementById('add-contact-error');
            const btn = document.getElementById('add-contact-btn');
            
            errorEl.style.display = 'none';
            
            if (!contactId) {
                errorEl.textContent = 'Entre un ID';
                errorEl.style.display = 'block';
                return;
            }

            if (contactId === user.id) {
                errorEl.textContent = 'Tu ne peux pas t\'ajouter toi-même !';
                errorEl.style.display = 'block';
                return;
            }

            btn.disabled = true;
            btn.textContent = 'Ajout...';

            try {
                const res = await fetch(`${API_URL}/contacts`, {
                    method: 'POST',
                    headers: authHeaders(),
                    body: JSON.stringify({ contactId })
                });
                const data = await res.json();
                if (!res.ok) throw new Error(data.error || 'Erreur');

                closeAddContactModal();
                showToast({ type: 'success', title: 'Contact ajouté !', message: 'Dis-lui bonjour 👋' });
                loadContacts();
                
                // Onboarding: check progress after adding contact
                setTimeout(() => {
                    checkOnboardingProgress();
                    if (!onboardingState.hasPost && localStorage.getItem('cinq_onboarding_completed') !== 'true') {
                        showToast({ type: 'info', title: '🎯 Bien joué !', message: 'Plus qu\'à poster ton premier message !' });
                    }
                }, 500);
            } catch (e) {
                errorEl.textContent = e.message;
                errorEl.style.display = 'block';
            } finally {
                btn.disabled = false;
                btn.textContent = 'Ajouter';
            }
        }

        async function copyMyId() {
            const textEl = document.getElementById('copy-id-text');
            try {
                await navigator.clipboard.writeText(user.id);
                textEl.textContent = 'Copié !';
                setTimeout(() => textEl.textContent = 'Copier mon ID', 2000);
            } catch (e) {
                showToast({ type: 'error', message: 'Impossible de copier' });
            }
        }

        function openDeleteAccountModal() {
            document.getElementById('delete-confirmation-input').value = '';
            document.getElementById('delete-account-error').style.display = 'none';
            openModal('delete-account-modal', '#delete-confirmation-input');
        }
        
        function closeDeleteAccountModal() {
            closeModal('delete-account-modal');
        }

        async function deleteAccount() {
            const confirmation = document.getElementById('delete-confirmation-input').value.trim();
            const errorEl = document.getElementById('delete-account-error');
            const btn = document.getElementById('delete-account-btn');
            
            if (confirmation !== 'SUPPRIMER') {
                errorEl.textContent = 'Tape exactement SUPPRIMER pour confirmer';
                errorEl.style.display = 'block';
                return;
            }
            
            errorEl.style.display = 'none';
            btn.disabled = true;
            btn.textContent = 'Suppression...';
            
            try {
                const res = await fetch(`${API_URL}/user-profile`, {
                    method: 'DELETE',
                    headers: authHeaders(),
                    body: JSON.stringify({ confirmation: 'SUPPRIMER' })
                });
                
                if (!res.ok) throw new Error((await res.json()).error || 'Erreur');
                
                stopPolling();
                localStorage.removeItem('cinq_session');
                localStorage.removeItem('cinq_user');
                
                showToast({ type: 'success', title: 'Compte supprimé', message: 'Adieu ! 👋', duration: 3000 });
                setTimeout(() => { window.location.href = '/'; }, 2000);
            } catch (e) {
                errorEl.textContent = e.message;
                errorEl.style.display = 'block';
                btn.disabled = false;
                btn.textContent = 'Supprimer définitivement';
            }
        }

        async function exportData() {
            const btn = document.getElementById('export-data-btn');
            const titleEl = btn.querySelector('.settings-btn-title');
            btn.disabled = true;
            titleEl.textContent = 'Export en cours...';
            
            try {
                const res = await fetch(`${API_URL}/user-profile?action=export`, { headers: authHeaders() });
                if (!res.ok) throw new Error('Erreur lors de l\'export');
                
                const data = await res.json();
                const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `cinq-data-export-${new Date().toISOString().split('T')[0]}.json`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                
                showToast({ type: 'success', title: 'C\'est téléchargé ! 📦' });
            } catch (e) {
                showToast({ type: 'error', message: e.message });
            } finally {
                btn.disabled = false;
                titleEl.textContent = 'Exporter mes données';
            }
        }

        function logout() {
            stopPolling();
            localStorage.removeItem('cinq_session');
            localStorage.removeItem('cinq_user');
            window.location.href = '/login.html';
        }

        // ===== UTILS =====
        // formatTime() now provided by /js/shared.js
        
        // Smart time formatting for chat messages
        function formatMessageTime(dateStr) {
            const date = new Date(dateStr);
            const now = new Date();
            const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
            const yesterday = new Date(today);
            yesterday.setDate(yesterday.getDate() - 1);
            const messageDate = new Date(date.getFullYear(), date.getMonth(), date.getDate());
            
            const timeStr = date.toLocaleTimeString('fr-FR', { hour: '2-digit', minute: '2-digit' });
            
            if (messageDate.getTime() === today.getTime()) {
                return timeStr;
            }
            if (messageDate.getTime() === yesterday.getTime()) {
                return `Hier ${timeStr}`;
            }
            
            const diffDays = Math.floor((today - messageDate) / (1000 * 60 * 60 * 24));
            if (diffDays < 7) {
                const dayName = date.toLocaleDateString('fr-FR', { weekday: 'short' });
                return `${dayName} ${timeStr}`;
            }
            
            return date.toLocaleDateString('fr-FR', { day: 'numeric', month: 'short' }) + ' ' + timeStr;
        }
        
        // Format date for date separators
        function formatDateSeparator(dateStr) {
            const date = new Date(dateStr);
            const now = new Date();
            const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
            const yesterday = new Date(today);
            yesterday.setDate(yesterday.getDate() - 1);
            const messageDate = new Date(date.getFullYear(), date.getMonth(), date.getDate());
            
            if (messageDate.getTime() === today.getTime()) return "Aujourd'hui";
            if (messageDate.getTime() === yesterday.getTime()) return "Hier";
            
            const diffDays = Math.floor((today - messageDate) / (1000 * 60 * 60 * 24));
            if (diffDays < 7) {
                return date.toLocaleDateString('fr-FR', { weekday: 'long' });
            }
            
            return date.toLocaleDateString('fr-FR', { day: 'numeric', month: 'long', year: now.getFullYear() !== date.getFullYear() ? 'numeric' : undefined });
        }
        
        // escapeHtml() now provided by /js/shared.js

        // ===== KEYBOARD SHORTCUTS =====
        // See KEYBOARD-SHORTCUTS.md for full documentation
        document.addEventListener('keydown', (e) => {
            const isInputFocused = ['INPUT', 'TEXTAREA', 'SELECT'].includes(document.activeElement?.tagName);
            const isMod = e.ctrlKey || e.metaKey;
            
            // Escape: Close modals/overlays (works even in inputs)
            if (e.key === 'Escape') {
                closeImageModal();
                if (document.getElementById('search-overlay').classList.contains('open')) closeSearch();
                else if (currentChatContact) closeChat();
                else if (document.getElementById('gift-modal').classList.contains('open')) closeGiftModal();
                else if (document.getElementById('add-contact-modal').classList.contains('open')) closeAddContactModal();
                else if (document.getElementById('delete-account-modal').classList.contains('open')) closeDeleteAccountModal();
                document.querySelectorAll('.post-menu.open').forEach(m => m.classList.remove('open'));
                return;
            }
            
            // Skip shortcuts if typing in an input
            if (isInputFocused) return;
            
            // Ctrl+1-5: Quick switch to contact chat
            if (isMod && e.key >= '1' && e.key <= '5') {
                e.preventDefault();
                const contactIndex = parseInt(e.key) - 1;
                if (contacts[contactIndex]) {
                    openChat(contacts[contactIndex]);
                    showToast({ type: 'info', message: `Chat avec ${contacts[contactIndex].contact?.display_name || 'Contact ' + (contactIndex + 1)}`, duration: 1500 });
                } else {
                    showToast({ type: 'warning', message: `Pas de contact en position ${e.key}`, duration: 1500 });
                }
                return;
            }
            
            // Ctrl+N: New message (switch to contacts tab)
            if (isMod && e.key.toLowerCase() === 'n') {
                e.preventDefault();
                switchTab('contacts');
                showToast({ type: 'info', message: 'Choisis un contact pour écrire', duration: 2000 });
                return;
            }
            
            // Ctrl+F: Open search
            if (isMod && e.key.toLowerCase() === 'f') {
                e.preventDefault();
                openSearch();
                return;
            }
        });
        
        // ===== MICRO-ANIMATIONS: RIPPLE EFFECT =====
        document.addEventListener('click', (e) => {
            const btn = e.target.closest('.btn-ripple');
            if (!btn) return;
            
            // Check for reduced motion preference
            if (window.matchMedia('(prefers-reduced-motion: reduce)').matches) return;
            
            const rect = btn.getBoundingClientRect();
            const x = ((e.clientX - rect.left) / rect.width) * 100;
            const y = ((e.clientY - rect.top) / rect.height) * 100;
            
            btn.style.setProperty('--ripple-x', `${x}%`);
            btn.style.setProperty('--ripple-y', `${y}%`);
            
            btn.classList.remove('rippling');
            void btn.offsetWidth; // Trigger reflow
            btn.classList.add('rippling');
            
            setTimeout(() => btn.classList.remove('rippling'), 600);
        });
        
        // ===== HAPTIC FEEDBACK =====
        // triggerHaptic() now provided by /js/shared.js
        
        // Close menus on outside click
        document.addEventListener('click', (e) => {
            if (!e.target.closest('.post-menu') && !e.target.closest('.post-menu-btn')) {
                document.querySelectorAll('.post-menu.open').forEach(m => m.classList.remove('open'));
            }
        });

        // ===== PUSH NOTIFICATIONS =====
        const VAPID_PUBLIC_KEY = 'BFvUbvZkUNjbCf_lea-V2FGiVLhAdyAXaUC5CUWYlwmCkejWxefzR3rvqJI4DOj_M1Gh664VGVYRo0SEJ-94faM';

        async function initPushNotifications() {
            if (!('serviceWorker' in navigator) || !('PushManager' in window)) return;

            try {
                const registration = await navigator.serviceWorker.register('/service-worker.js');
                const existingSubscription = await registration.pushManager.getSubscription();
                if (existingSubscription) return;
                setTimeout(() => askForNotificationPermission(registration), 3000);
            } catch (err) {}
        }

        async function askForNotificationPermission(registration) {
            if (Notification.permission === 'denied') return;
            if (Notification.permission === 'granted') {
                await subscribeToPush(registration);
                return;
            }

            showToast({
                type: 'info',
                title: '🔔 Notifications',
                message: 'Active-les pour savoir quand tes 5 t\'écrivent',
                duration: 6000,
                onClick: async () => {
                    const permission = await Notification.requestPermission();
                    if (permission === 'granted') {
                        await subscribeToPush(registration);
                        showToast({ type: 'success', title: 'Notifs activées !', message: 'Tu sauras quand tes proches t\'écrivent' });
                    }
                }
            });
        }

        async function subscribeToPush(registration) {
            try {
                const subscription = await registration.pushManager.subscribe({
                    userVisibleOnly: true,
                    applicationServerKey: urlBase64ToUint8Array(VAPID_PUBLIC_KEY)
                });
                await fetch(`${API_URL}/push-subscribe`, {
                    method: 'POST',
                    headers: authHeaders(),
                    body: JSON.stringify({ subscription: subscription.toJSON() })
                });
            } catch (err) {}
        }

        function urlBase64ToUint8Array(base64String) {
            const padding = '='.repeat((4 - base64String.length % 4) % 4);
            const base64 = (base64String + padding).replace(/-/g, '+').replace(/_/g, '/');
            const rawData = window.atob(base64);
            const outputArray = new Uint8Array(rawData.length);
            for (let i = 0; i < rawData.length; ++i) {
                outputArray[i] = rawData.charCodeAt(i);
            }
            return outputArray;
        }

        // ===== ONBOARDING SYSTEM =====
        let onboardingState = {
            hasPhoto: false,
            hasContact: false,
            hasPost: false,
            completed: false
        };
        
        function initOnboarding() {
            const isNewUser = localStorage.getItem('cinq_new_user') === 'true';
            const onboardingCompleted = localStorage.getItem('cinq_onboarding_completed') === 'true';
            
            if (isNewUser && !onboardingCompleted) {
                // Show welcome overlay
                setTimeout(() => {
                    showOnboardingOverlay();
                }, 500);
            } else if (!onboardingCompleted) {
                // Check progress and show checklist if not complete
                checkOnboardingProgress();
            }
        }
        
        function showOnboardingOverlay() {
            const overlay = document.getElementById('onboarding-overlay');
            overlay.classList.add('open');
            
            // Trap focus in overlay
            const firstBtn = overlay.querySelector('.onboarding-btn');
            if (firstBtn) firstBtn.focus();
        }
        
        function hideOnboardingOverlay() {
            document.getElementById('onboarding-overlay').classList.remove('open');
        }
        
        function startOnboarding() {
            hideOnboardingOverlay();
            localStorage.removeItem('cinq_new_user');
            
            // Show the floating checklist
            setTimeout(() => {
                showOnboardingChecklist();
                checkOnboardingProgress();
            }, 300);
            
            // Guide user to add photo first
            setTimeout(() => {
                showTooltipHint('profile-avatar', 'Commence par ajouter ta photo ! 📸', 'bottom');
                switchTab('profil');
            }, 800);
        }
        
        function skipOnboarding() {
            hideOnboardingOverlay();
            localStorage.removeItem('cinq_new_user');
            localStorage.setItem('cinq_onboarding_completed', 'true');
            showToast({ type: 'info', title: '👍 Pas de souci !', message: 'Tu peux explorer librement.' });
        }
        
        function showOnboardingChecklist() {
            const checklist = document.getElementById('onboarding-checklist');
            if (localStorage.getItem('cinq_onboarding_completed') !== 'true') {
                checklist.classList.add('visible');
            }
        }
        
        function hideOnboardingChecklist() {
            document.getElementById('onboarding-checklist').classList.remove('visible');
        }
        
        function checkOnboardingProgress() {
            // Check if user has avatar
            const avatarImg = document.querySelector('#profile-avatar img');
            onboardingState.hasPhoto = avatarImg && avatarImg.src && !avatarImg.src.includes('undefined');
            
            // Check if user has contacts
            onboardingState.hasContact = contacts.length > 0;
            
            // Check if user has posts (own posts)
            onboardingState.hasPost = posts.some(p => p.user_id === user?.id);
            
            // Update UI
            updateOnboardingUI();
            
            // Check completion
            if (onboardingState.hasPhoto && onboardingState.hasContact && onboardingState.hasPost) {
                completeOnboarding();
            }
        }
        
        function updateOnboardingUI() {
            const photoEl = document.getElementById('checklist-photo');
            const contactEl = document.getElementById('checklist-contact');
            const postEl = document.getElementById('checklist-post');
            
            if (onboardingState.hasPhoto) photoEl.classList.add('completed');
            else photoEl.classList.remove('completed');
            
            if (onboardingState.hasContact) contactEl.classList.add('completed');
            else contactEl.classList.remove('completed');
            
            if (onboardingState.hasPost) postEl.classList.add('completed');
            else postEl.classList.remove('completed');
            
            // Update progress
            const completed = [onboardingState.hasPhoto, onboardingState.hasContact, onboardingState.hasPost].filter(Boolean).length;
            const progressFill = document.getElementById('onboarding-progress-fill');
            const progressText = document.getElementById('onboarding-progress-text');
            
            progressFill.style.width = `${(completed / 3) * 100}%`;
            progressText.textContent = `${completed}/3 complétés`;
        }
        
        function completeOnboarding() {
            if (onboardingState.completed) return;
            onboardingState.completed = true;
            localStorage.setItem('cinq_onboarding_completed', 'true');
            
            // Hide checklist with celebration
            setTimeout(() => {
                hideOnboardingChecklist();
                showToast({ 
                    type: 'success', 
                    title: '🎉 Bravo !', 
                    message: 'Tu as terminé ton setup. Profite de ton espace !',
                    duration: 5000
                });
            }, 500);
        }
        
        // Navigation helpers for onboarding
        function goToProfileForPhoto() {
            switchTab('profil');
            setTimeout(() => {
                const profileAvatar = document.getElementById('profile-avatar');
                if (profileAvatar) {
                    profileAvatar.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    profileAvatar.classList.add('pulse-indicator');
                    setTimeout(() => profileAvatar.classList.remove('pulse-indicator'), 3000);
                }
            }, 300);
        }
        
        function goToContactsForAdd() {
            switchTab('contacts');
            setTimeout(() => {
                const emptySlot = document.querySelector('.contact-slot.empty');
                if (emptySlot) {
                    emptySlot.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    emptySlot.classList.add('pulse-indicator');
                    setTimeout(() => emptySlot.classList.remove('pulse-indicator'), 3000);
                }
            }, 300);
        }
        
        function goToFeedForPost() {
            switchTab('feed');
            setTimeout(() => {
                const composer = document.querySelector('.composer-textarea');
                if (composer) {
                    composer.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    composer.focus();
                    composer.parentElement.classList.add('pulse-indicator');
                    setTimeout(() => composer.parentElement.classList.remove('pulse-indicator'), 3000);
                }
            }, 300);
        }
        
        // Tooltip hints system
        let activeTooltip = null;
        
        function showTooltipHint(elementId, message, position = 'bottom') {
            hideTooltipHint();
            
            const targetEl = document.getElementById(elementId);
            if (!targetEl) return;
            
            const tooltip = document.createElement('div');
            tooltip.className = `tooltip-hint ${position}`;
            tooltip.innerHTML = `
                ${message}
                <button class="tooltip-hint-close" onclick="hideTooltipHint()" aria-label="Fermer">&times;</button>
            `;
            
            document.body.appendChild(tooltip);
            
            // Position the tooltip
            const rect = targetEl.getBoundingClientRect();
            const tooltipRect = tooltip.getBoundingClientRect();
            
            if (position === 'bottom') {
                tooltip.style.top = `${rect.bottom + 12}px`;
                tooltip.style.left = `${rect.left + (rect.width / 2) - (tooltipRect.width / 2)}px`;
            } else if (position === 'top') {
                tooltip.style.top = `${rect.top - tooltipRect.height - 12}px`;
                tooltip.style.left = `${rect.left + (rect.width / 2) - (tooltipRect.width / 2)}px`;
            }
            
            // Show with animation
            requestAnimationFrame(() => {
                tooltip.classList.add('visible');
            });
            
            activeTooltip = tooltip;
            
            // Auto-hide after 8 seconds
            setTimeout(() => hideTooltipHint(), 8000);
        }
        
        function hideTooltipHint() {
            if (activeTooltip) {
                activeTooltip.classList.remove('visible');
                setTimeout(() => {
                    if (activeTooltip && activeTooltip.parentNode) {
                        activeTooltip.parentNode.removeChild(activeTooltip);
                    }
                    activeTooltip = null;
                }, 300);
            }
        }
        
        // Hook into existing functions to track progress
        const originalUploadAvatar = uploadAvatar;
        uploadAvatar = async function(input) {
            await originalUploadAvatar.call(this, input);
            // Check progress after avatar upload
            setTimeout(() => {
                checkOnboardingProgress();
                if (!onboardingState.hasContact && localStorage.getItem('cinq_onboarding_completed') !== 'true') {
                    showToast({ type: 'info', title: '👍 Photo ajoutée !', message: 'Maintenant, invite tes proches !' });
                }
            }, 1000);
        };

        // ===== THEME TOGGLE =====
        function initTheme() {
            // Check localStorage first
            const savedTheme = localStorage.getItem('cinq_theme');
            if (savedTheme) {
                document.documentElement.setAttribute('data-theme', savedTheme);
                updateThemeColor(savedTheme);
                return;
            }
            
            // Check system preference
            if (window.matchMedia && window.matchMedia('(prefers-color-scheme: light)').matches) {
                document.documentElement.setAttribute('data-theme', 'light');
                updateThemeColor('light');
            }
        }
        
        const THEMES = ['dark', 'light', 'auto'];
        
        function getSystemPreference() {
            return window.matchMedia && window.matchMedia('(prefers-color-scheme: light)').matches ? 'light' : 'dark';
        }
        
        function getEffectiveTheme(pref) {
            return pref === 'auto' ? getSystemPreference() : (pref || 'dark');
        }
        
        function toggleTheme() {
            const html = document.documentElement;
            const currentPref = localStorage.getItem('cinq_theme') || 'dark';
            const currentIndex = THEMES.indexOf(currentPref);
            const nextPref = THEMES[(currentIndex + 1) % THEMES.length];
            const effective = getEffectiveTheme(nextPref);
            
            // Add transition class for smooth animation
            html.classList.add('theme-transitioning');
            
            html.setAttribute('data-theme', effective);
            html.setAttribute('data-theme-preference', nextPref);
            localStorage.setItem('cinq_theme', nextPref);
            updateThemeColor(effective);
            
            // Remove transition class after animation
            setTimeout(() => html.classList.remove('theme-transitioning'), 400);
            
            // Haptic feedback on mobile (if supported)
            if ('vibrate' in navigator) {
                navigator.vibrate(10);
            }
        }
        
        function setTheme(theme) {
            if (!THEMES.includes(theme)) return;
            const html = document.documentElement;
            const effective = getEffectiveTheme(theme);
            
            html.classList.add('theme-transitioning');
            html.setAttribute('data-theme', effective);
            html.setAttribute('data-theme-preference', theme);
            localStorage.setItem('cinq_theme', theme);
            updateThemeColor(effective);
            setTimeout(() => html.classList.remove('theme-transitioning'), 400);
        }
        
        function updateThemeColor(theme) {
            const meta = document.getElementById('theme-color-meta');
            if (meta) {
                meta.setAttribute('content', theme === 'light' ? '#faf9f7' : '#0e0e12');
            }
        }
        
        // Listen for system theme changes (affects auto mode)
        if (window.matchMedia) {
            window.matchMedia('(prefers-color-scheme: light)').addEventListener('change', (e) => {
                const pref = localStorage.getItem('cinq_theme');
                if (pref === 'auto' || !pref) {
                    const html = document.documentElement;
                    const effective = e.matches ? 'light' : 'dark';
                    html.classList.add('theme-transitioning');
                    html.setAttribute('data-theme', effective);
                    updateThemeColor(effective);
                    setTimeout(() => html.classList.remove('theme-transitioning'), 400);
                }
            });
        }
        
        // Remove theme-loading class after initial render
        requestAnimationFrame(() => {
            requestAnimationFrame(() => {
                document.documentElement.classList.remove('theme-loading');
            });
        });
        
        // ===== MOBILE KEYBOARD HANDLING =====
        function initMobileKeyboard() {
            // Use Visual Viewport API for better keyboard handling
            if ('visualViewport' in window) {
                const viewport = window.visualViewport;
                let keyboardOpen = false;
                
                viewport.addEventListener('resize', () => {
                    // Keyboard is considered open if viewport height shrinks significantly
                    const heightDiff = window.innerHeight - viewport.height;
                    const isKeyboardNowOpen = heightDiff > 150;
                    
                    if (isKeyboardNowOpen !== keyboardOpen) {
                        keyboardOpen = isKeyboardNowOpen;
                        document.body.classList.toggle('keyboard-open', keyboardOpen);
                        
                        // Scroll active input into view
                        if (keyboardOpen && document.activeElement) {
                            setTimeout(() => {
                                document.activeElement.scrollIntoView({ 
                                    behavior: 'smooth', 
                                    block: 'center' 
                                });
                            }, 100);
                        }
                    }
                });
            }
            
            // Ensure chat input stays visible when keyboard opens
            const chatInput = document.getElementById('chat-input');
            if (chatInput) {
                chatInput.addEventListener('focus', () => {
                    setTimeout(() => {
                        chatInput.scrollIntoView({ behavior: 'smooth', block: 'end' });
                    }, 300);
                });
            }
        }
        
        initMobileKeyboard();
        
        // ===== INIT =====
        init();
    </script>
    
    <script src="/pwa-install.min.js" defer></script>
    <script src="/animations.min.js" defer></script>
    <script src="/js/offline-db.min.js" defer></script>
    <script src="/js/notifications.js" defer></script>
    <script src="/js/analytics.js" defer></script>
    <script>
        // VAPID Public Key for push notifications
        window.CINQ_VAPID_PUBLIC_KEY = 'BFvUbvZkUNjbCf_lea-V2FGiVLhAdyAXaUC5CUWYlwmCkejWxefzR3rvqJI4DOj_M1Gh664VGVYRo0SEJ-94faM';
        
        // Initialize notifications when user is authenticated
        document.addEventListener('DOMContentLoaded', function() {
            if (window.CinqNotifications) {
                // Check if user is logged in (has session)
                const hasSession = localStorage.getItem('cinq_session');
                if (hasSession) {
                    window.CinqNotifications.init({
                        vapidPublicKey: window.CINQ_VAPID_PUBLIC_KEY
                    });
                }
            }
        });
    </script>
    
    <!-- i18n -->
    <script src="/js/i18n.js"></script>
    <script>
        // Update texts on language change
        window.addEventListener('i18n:loaded', updateAppTexts);
        window.addEventListener('i18n:changed', updateAppTexts);
        
        function updateAppTexts() {
            document.title = 'Cinq — ' + i18n.t('app.yourSpace');
            
            // Update nav items
            const navLabels = {
                'tab-feed': 'nav.feed',
                'tab-settings': 'nav.settings'
            };
            
            for (const [id, key] of Object.entries(navLabels)) {
                const el = document.getElementById(id);
                if (el) {
                    const label = el.querySelector('.nav-label');
                    if (label) label.textContent = i18n.t(key);
                }
            }
            
            // Update theme texts
            const themeLabel = document.querySelector('.settings-theme .setting-label');
            if (themeLabel) themeLabel.textContent = i18n.t('theme.dark');
            
            // Update logout button
            const logoutBtn = document.querySelector('.logout-btn .btn-text');
            if (logoutBtn) logoutBtn.textContent = i18n.t('nav.logout');
        }
        
        // Language switcher in header
        const langSwitcher = document.createElement('div');
        langSwitcher.id = 'app-lang-switcher';
        langSwitcher.innerHTML = `
            <style>
                #app-lang-switcher {
                    position: fixed;
                    top: var(--space-4);
                    right: calc(var(--space-4) + 50px);
                    z-index: 100;
                    display: flex;
                    gap: 4px;
                }
                #app-lang-switcher .lang-btn {
                    padding: 4px 8px;
                    background: var(--color-bg-tertiary);
                    border: 1px solid var(--color-border);
                    border-radius: var(--radius-md);
                    cursor: pointer;
                    font-size: 11px;
                    font-weight: 500;
                    color: var(--color-text-secondary);
                    transition: all 0.2s;
                }
                #app-lang-switcher .lang-btn.active {
                    background: var(--color-brand-muted);
                    border-color: var(--color-brand);
                    color: var(--color-brand);
                }
                #app-lang-switcher .lang-btn:hover {
                    background: var(--color-bg-elevated);
                    border-color: var(--color-border-active);
                }
            </style>
            <button class="lang-btn" data-lang="fr" aria-label="Français">FR</button>
            <button class="lang-btn" data-lang="en" aria-label="English">EN</button>
        `;
        document.body.appendChild(langSwitcher);
        
        langSwitcher.querySelectorAll('.lang-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                if (window.i18n) {
                    i18n.setLanguage(btn.dataset.lang);
                    langSwitcher.querySelectorAll('.lang-btn').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                }
            });
        });
        
        window.addEventListener('i18n:loaded', () => {
            const lang = i18n.getLang();
            langSwitcher.querySelectorAll('.lang-btn').forEach(b => {
                b.classList.toggle('active', b.dataset.lang === lang);
            });
        });
    </script>
</body>
</html>
