<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Offrir Cinq ‚Äî L'anti-r√©seau social</title>
    
    <!-- SEO -->
    <meta name="description" content="Offre Cinq √† quelqu'un qui compte vraiment. 5 personnes. Pas 500. Pas de bullshit.">
    <meta name="keywords" content="cinq, cadeau, r√©seau social, anti social, crypto">
    <meta name="author" content="Cinq">
    
    <!-- Canonical -->
    <link rel="canonical" href="https://cinq.app/gift">
    
    <!-- Open Graph -->
    <meta property="og:title" content="üéÅ Offrir Cinq ‚Äî L'anti-r√©seau social">
    <meta property="og:description" content="Tu ne t√©l√©charges pas Cinq. Tu l'offres. Parce que si quelqu'un doit choisir 5 personnes dans sa vie, c'est toi qui fais le premier pas.">
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://cinq.app/gift">
    <meta property="og:image" content="https://cinq.app/og-gift.png">
    <meta property="og:site_name" content="Cinq">
    <meta property="og:locale" content="fr_FR">
    
    <!-- Twitter -->
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:title" content="üéÅ Offrir Cinq">
    <meta name="twitter:description" content="5 personnes. Pas 500. C'est toi qui fais le premier pas.">
    <meta name="twitter:image" content="https://cinq.app/og-gift.png">
    <meta name="twitter:site" content="@cinqapp">
    
    <!-- Favicon -->
    <link rel="icon" type="image/svg+xml" href="/favicon.svg">
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
    <meta name="theme-color" content="#1a1a2e">
    
    <!-- Content Security Policy -->
    <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' 'unsafe-inline' https://cdn.tailwindcss.com; style-src 'self' 'unsafe-inline' https://fonts.googleapis.com; font-src https://fonts.gstatic.com; connect-src 'self' https://api.cinq.app https://*.netlify.app; img-src 'self' data: https:;">
    
    <!-- API Key pour gift-create (inject√©e c√¥t√© serveur ou via env) -->
    <!-- <meta name="gift-api-key" content="YOUR_API_KEY_HERE"> -->
    
    <!-- 
        ‚ö†Ô∏è WARNING S√âCURIT√â: Tailwind CDN ne supporte pas SRI (integrity hash)
        TODO PROD: Remplacer par build local avec purge CSS
        npm install -D tailwindcss && npx tailwindcss build -o styles.css
    -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        body { font-family: 'Inter', sans-serif; }
        
        /* Background gradient - coh√©rent avec index.html */
        .gradient-bg {
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
        }
        
        /* Effet glow pour les √©l√©ments importants */
        .glow {
            box-shadow: 0 0 60px rgba(99, 102, 241, 0.3);
        }
        .glow-success {
            box-shadow: 0 0 60px rgba(34, 197, 94, 0.4);
        }
        
        /* Animation des cercles d√©coratifs */
        .circle {
            animation: pulse 4s ease-in-out infinite;
        }
        @keyframes pulse {
            0%, 100% { transform: scale(1); opacity: 0.5; }
            50% { transform: scale(1.05); opacity: 0.8; }
        }
        
        /* Animation de fade pour les transitions d'√©cran */
        .screen {
            animation: fadeIn 0.3s ease-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        /* Animation loader pour l'attente de paiement */
        .loader-dot {
            animation: loaderPulse 1.4s ease-in-out infinite;
        }
        .loader-dot:nth-child(2) { animation-delay: 0.2s; }
        .loader-dot:nth-child(3) { animation-delay: 0.4s; }
        @keyframes loaderPulse {
            0%, 80%, 100% { transform: scale(0.6); opacity: 0.5; }
            40% { transform: scale(1); opacity: 1; }
        }
        
        /* Cartes de paiement avec hover effect */
        .payment-card {
            transition: all 0.2s ease;
        }
        .payment-card:hover {
            transform: translateY(-2px);
            border-color: rgba(99, 102, 241, 0.5);
            background: rgba(255, 255, 255, 0.1);
        }
        
        /* QR Code placeholder */
        .qr-placeholder {
            background: repeating-conic-gradient(
                rgba(255,255,255,0.1) 0deg 90deg,
                rgba(255,255,255,0.2) 90deg 180deg
            );
            background-size: 20px 20px;
        }
        
        /* Bouton copier feedback */
        .copy-btn.copied {
            background: rgba(34, 197, 94, 0.2) !important;
            border-color: rgba(34, 197, 94, 0.5) !important;
        }
        
        /* Animation celebration */
        @keyframes celebrate {
            0% { transform: scale(0.5); opacity: 0; }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); opacity: 1; }
        }
        .celebrate {
            animation: celebrate 0.5s ease-out;
        }
        
        /* ========================================
           Accessibilit√©: Focus visible
           ======================================== */
        button:focus-visible,
        a:focus-visible {
            outline: 2px solid rgba(99, 102, 241, 0.8);
            outline-offset: 2px;
            border-radius: 0.5rem;
        }
        
        /* ========================================
           Accessibilit√©: Reduced motion
           ======================================== */
        @media (prefers-reduced-motion: reduce) {
            .circle,
            .loader-dot,
            .celebrate,
            .screen {
                animation: none !important;
            }
            .payment-card {
                transition: none !important;
            }
        }
        
        /* ========================================
           √âtats d'erreur et loading
           ======================================== */
        .error-state {
            background: rgba(239, 68, 68, 0.1);
            border-color: rgba(239, 68, 68, 0.5);
        }
        .loading-overlay {
            background: rgba(0, 0, 0, 0.7);
        }
    </style>
</head>
<body class="gradient-bg min-h-screen text-white">
    
    <!-- ============================================
         Cercles d√©coratifs (coh√©rent avec index.html)
         ============================================ -->
    <div class="fixed inset-0 overflow-hidden pointer-events-none" aria-hidden="true">
        <div class="circle absolute -top-20 -left-20 w-96 h-96 bg-indigo-500/20 rounded-full blur-3xl"></div>
        <div class="circle absolute top-1/2 -right-32 w-80 h-80 bg-purple-500/20 rounded-full blur-3xl" style="animation-delay: -2s;"></div>
        <div class="circle absolute -bottom-20 left-1/3 w-72 h-72 bg-blue-500/20 rounded-full blur-3xl" style="animation-delay: -1s;"></div>
    </div>

    <!-- ============================================
         Container principal
         ============================================ -->
    <main class="relative z-10 min-h-screen flex flex-col items-center justify-center px-4 py-8" role="main">
        
        <!-- Zone d'annonces pour lecteurs d'√©cran -->
        <div id="sr-announcements" class="sr-only" aria-live="assertive" aria-atomic="true"></div>
        
        <!-- ==========================================
             √âCRAN 1: Accueil
             ========================================== -->
        <section id="screen-welcome" class="screen w-full max-w-md" aria-labelledby="welcome-title">
            
            <!-- Logo avec ic√¥ne cadeau -->
            <div class="flex justify-center mb-8">
                <div class="w-24 h-24 rounded-full border-4 border-white/20 flex items-center justify-center glow bg-white/5 backdrop-blur" aria-hidden="true">
                    <span class="text-4xl">üéÅ</span>
                </div>
            </div>
            
            <!-- Headline provocatrice (copy Marco - Option A) -->
            <h1 id="welcome-title" class="text-2xl md:text-3xl font-bold mb-4 text-center leading-tight">
                Tu as 847 amis Facebook.<br>
                <span class="text-white/60">Combien t'appelleraient √† 3h du mat' ?</span>
            </h1>
            
            <!-- S√©parateur -->
            <div class="flex justify-center my-6" aria-hidden="true">
                <div class="w-16 h-0.5 bg-gradient-to-r from-transparent via-white/30 to-transparent"></div>
            </div>
            
            <!-- Sous-headline -->
            <p class="text-lg text-center text-white/70 mb-8">
                5 personnes. Pas 500. Pas 5000.<br>
                <span class="font-semibold text-white">Cinq.</span>
            </p>
            
            <!-- Proposition de valeur -->
            <div class="bg-white/5 backdrop-blur border border-white/10 rounded-2xl p-6 mb-8">
                <p class="text-center text-white/80 text-sm leading-relaxed">
                    <strong>Tu ne t√©l√©charges pas Cinq. Tu l'offres.</strong><br><br>
                    Parce que si quelqu'un doit choisir 5 personnes dans sa vie, 
                    et que tu veux en faire partie‚Ä¶<br>
                    <span class="text-indigo-400">c'est toi qui fais le premier pas.</span>
                </p>
            </div>
            
            <!-- CTA Principal -->
            <button 
                onclick="CinqGift.showScreen('payment')" 
                class="w-full py-4 px-6 bg-indigo-500 hover:bg-indigo-400 rounded-xl font-semibold text-lg transition transform hover:scale-[1.02] active:scale-[0.98] flex items-center justify-center gap-3"
                aria-describedby="gift-price"
            >
                <span aria-hidden="true">üéÅ</span>
                <span>Offrir Cinq √† quelqu'un</span>
            </button>
            <p id="gift-price" class="sr-only">Prix : 50 euros, acc√®s √† vie</p>
            
            <!-- Lien secondaire -->
            <div class="mt-6 text-center">
                <a href="/redeem" class="text-white/50 hover:text-white/70 text-sm transition">
                    D√©j√† un code cadeau ? <span class="underline">Activez-le ici ‚Üí</span>
                </a>
            </div>
            
            <!-- Note anti-spam -->
            <p class="text-center mt-8 text-white/60 text-xs">
                Pas de compte √† cr√©er. Pas de spam. Juste un geste.
            </p>
            
        </section>

        <!-- ==========================================
             √âCRAN 2: Choix du paiement
             ========================================== -->
        <section id="screen-payment" class="screen w-full max-w-md hidden" aria-labelledby="payment-title">
            
            <!-- Header avec retour -->
            <button onclick="CinqGift.showScreen('welcome')" aria-label="Retour √† l'accueil" class="flex items-center gap-2 text-white/60 hover:text-white mb-8 transition">
                <span aria-hidden="true">‚Üê</span>
                <span>Retour</span>
            </button>
            
            <!-- Titre -->
            <h2 id="payment-title" class="text-2xl font-bold text-center mb-2">
                Comment souhaitez-vous payer ?
            </h2>
            
            <!-- Prix -->
            <p class="text-center text-white/60 mb-8">
                50 ‚Ç¨ ¬∑ Acc√®s √† vie
            </p>
            
            <!-- Loading state -->
            <div id="payment-loading" class="hidden text-center py-8">
                <div class="flex justify-center gap-2 mb-4" aria-hidden="true">
                    <div class="loader-dot w-3 h-3 rounded-full bg-indigo-400"></div>
                    <div class="loader-dot w-3 h-3 rounded-full bg-indigo-400"></div>
                    <div class="loader-dot w-3 h-3 rounded-full bg-indigo-400"></div>
                </div>
                <p class="text-white/60">Chargement des options de paiement...</p>
            </div>
            
            <!-- Options de paiement -->
            <div id="payment-options" class="space-y-4" role="radiogroup" aria-label="M√©thode de paiement">
                
                <!-- USDC -->
                <button onclick="CinqGift.selectPayment('usdc')" class="payment-card w-full bg-white/5 backdrop-blur border border-white/10 rounded-2xl p-5 text-left" role="radio" aria-checked="false">
                    <div class="flex items-center justify-between">
                        <div class="flex items-center gap-4">
                            <div class="w-12 h-12 rounded-full bg-emerald-500/20 flex items-center justify-center text-2xl" aria-hidden="true">
                                üíµ
                            </div>
                            <div>
                                <div class="font-semibold">USDC (Stablecoin)</div>
                                <div class="text-sm text-white/60">Valeur stable ‚Ä¢ Frais r√©duits</div>
                            </div>
                        </div>
                        <span class="text-white/40" aria-hidden="true">‚ñ∂</span>
                    </div>
                </button>
                
                <!-- Bitcoin -->
                <button onclick="CinqGift.selectPayment('btc')" class="payment-card w-full bg-white/5 backdrop-blur border border-white/10 rounded-2xl p-5 text-left" role="radio" aria-checked="false">
                    <div class="flex items-center justify-between">
                        <div class="flex items-center gap-4">
                            <div class="w-12 h-12 rounded-full bg-orange-500/20 flex items-center justify-center text-2xl" aria-hidden="true">
                                <span aria-label="Bitcoin">‚Çø</span>
                            </div>
                            <div>
                                <div class="font-semibold">Bitcoin (BTC)</div>
                                <div class="text-sm text-white/60">Le standard ‚Ä¢ Lightning ‚ö°</div>
                            </div>
                        </div>
                        <span class="text-white/40" aria-hidden="true">‚ñ∂</span>
                    </div>
                </button>
                
                <!-- Ethereum -->
                <button onclick="CinqGift.selectPayment('eth')" class="payment-card w-full bg-white/5 backdrop-blur border border-white/10 rounded-2xl p-5 text-left" role="radio" aria-checked="false">
                    <div class="flex items-center justify-between">
                        <div class="flex items-center gap-4">
                            <div class="w-12 h-12 rounded-full bg-indigo-500/20 flex items-center justify-center text-2xl" aria-hidden="true">
                                <span aria-label="Ethereum">‚óä</span>
                            </div>
                            <div>
                                <div class="font-semibold">Ethereum (ETH)</div>
                                <div class="text-sm text-white/60">R√©seau ERC-20</div>
                            </div>
                        </div>
                        <span class="text-white/40" aria-hidden="true">‚ñ∂</span>
                    </div>
                </button>
                
            </div>
            
            <!-- Erreur -->
            <div id="payment-error" class="hidden mt-4 p-4 bg-red-500/10 border border-red-500/30 rounded-xl text-red-400 text-sm" role="alert">
                <span id="payment-error-message"></span>
            </div>
            
            <!-- Note de s√©curit√© -->
            <div class="mt-8 text-center">
                <p class="text-white/60 text-sm">
                    <span aria-hidden="true">üí°</span> Tous les paiements sont s√©curis√©s et non-custodial
                </p>
            </div>
            
        </section>

        <!-- ==========================================
             √âCRAN 3: QR Code de paiement
             ========================================== -->
        <section id="screen-qr" class="screen w-full max-w-md hidden" aria-labelledby="qr-title">
            
            <!-- Header avec retour et timer -->
            <div class="flex items-center justify-between mb-6">
                <button onclick="CinqGift.showScreen('payment')" aria-label="Retour au choix de paiement" class="flex items-center gap-2 text-white/60 hover:text-white transition">
                    <span aria-hidden="true">‚Üê</span>
                    <span>Retour</span>
                </button>
                <div class="flex items-center gap-2 text-amber-400 bg-amber-500/10 px-3 py-1 rounded-full text-sm" role="timer" aria-live="polite" aria-atomic="true">
                    <span aria-hidden="true">‚è±</span>
                    <span id="timer" aria-label="Temps restant">14:59</span>
                </div>
            </div>
            
            <!-- Titre -->
            <h2 id="qr-title" class="text-2xl font-bold text-center mb-6">
                Scannez pour payer
            </h2>
            
            <!-- QR Code Container -->
            <div class="flex justify-center mb-6">
                <div id="qr-container" class="w-56 h-56 rounded-2xl border-2 border-white/20 flex items-center justify-center bg-white" aria-label="QR Code de paiement">
                    <!-- QR code sera inject√© ici par l'API -->
                    <div id="qr-loading" class="text-center">
                        <div class="flex justify-center gap-2 mb-2" aria-hidden="true">
                            <div class="loader-dot w-2 h-2 rounded-full bg-gray-400"></div>
                            <div class="loader-dot w-2 h-2 rounded-full bg-gray-400"></div>
                            <div class="loader-dot w-2 h-2 rounded-full bg-gray-400"></div>
                        </div>
                        <div class="text-gray-500 text-sm">Chargement...</div>
                    </div>
                </div>
            </div>
            
            <!-- Montant -->
            <div class="bg-white/5 backdrop-blur border border-white/10 rounded-xl p-4 text-center mb-6">
                <div class="text-2xl font-bold" id="amount-crypto">--</div>
                <div class="text-white/60">‚âà 50.00 ‚Ç¨</div>
            </div>
            
            <!-- Copier l'adresse -->
            <button 
                onclick="CinqGift.copyAddress()" 
                id="copy-btn"
                class="copy-btn w-full bg-white/5 backdrop-blur border border-white/10 rounded-xl p-4 flex items-center justify-between hover:bg-white/10 transition"
                aria-describedby="copy-status-sr"
            >
                <div class="flex items-center gap-3">
                    <span aria-hidden="true">üìã</span>
                    <div class="text-left">
                        <div class="text-sm text-white/60">Copier l'adresse</div>
                        <div class="font-mono text-sm" id="wallet-address">Chargement...</div>
                    </div>
                </div>
                <span id="copy-status" class="text-white/40 text-sm" aria-hidden="true">Copier</span>
            </button>
            <span id="copy-status-sr" class="sr-only" aria-live="polite"></span>
            
            <!-- Instructions -->
            <ol class="mt-6 space-y-3" aria-label="Instructions de paiement">
                <li class="flex items-center gap-3 text-white/70">
                    <span class="w-6 h-6 rounded-full bg-indigo-500/30 flex items-center justify-center text-sm" aria-hidden="true">1</span>
                    <span>Ouvrez votre wallet</span>
                </li>
                <li class="flex items-center gap-3 text-white/70">
                    <span class="w-6 h-6 rounded-full bg-indigo-500/30 flex items-center justify-center text-sm" aria-hidden="true">2</span>
                    <span>Scannez ce QR code</span>
                </li>
                <li class="flex items-center gap-3 text-white/70">
                    <span class="w-6 h-6 rounded-full bg-indigo-500/30 flex items-center justify-center text-sm" aria-hidden="true">3</span>
                    <span>Confirmez le montant</span>
                </li>
            </ol>
            
            <!-- √âtat d'attente -->
            <div class="mt-8 text-center" role="status" aria-live="polite">
                <div id="payment-status" class="flex items-center justify-center gap-2 text-white/60">
                    <span aria-hidden="true">‚è≥</span>
                    <span>En attente du paiement...</span>
                </div>
                <div class="flex justify-center gap-2 mt-3" aria-hidden="true">
                    <div class="loader-dot w-2 h-2 rounded-full bg-indigo-400"></div>
                    <div class="loader-dot w-2 h-2 rounded-full bg-indigo-400"></div>
                    <div class="loader-dot w-2 h-2 rounded-full bg-indigo-400"></div>
                </div>
            </div>
            
            <!-- Badge mode simulation (dev only) -->
            <div id="simulation-badge" class="hidden mt-4 text-center">
                <span class="inline-flex items-center gap-1 px-3 py-1 bg-amber-500/20 text-amber-400 text-xs rounded-full">
                    <span>‚ö†Ô∏è</span>
                    <span>Mode simulation ‚Äî Confirmation auto dans 5s</span>
                </span>
            </div>
            
            <!-- Erreur -->
            <div id="qr-error" class="hidden mt-4 p-4 bg-red-500/10 border border-red-500/30 rounded-xl text-red-400 text-sm" role="alert">
                <span id="qr-error-message"></span>
            </div>
            
        </section>

        <!-- ==========================================
             √âCRAN 4: Confirmation & Code cadeau
             ========================================== -->
        <section id="screen-success" class="screen w-full max-w-md hidden" aria-labelledby="success-title">
            
            <!-- Animation de succ√®s -->
            <div class="flex justify-center mb-6">
                <div class="celebrate w-24 h-24 rounded-full border-4 border-emerald-400/50 flex items-center justify-center glow-success bg-emerald-500/10 backdrop-blur" aria-hidden="true">
                    <span class="text-5xl">üéâ</span>
                </div>
            </div>
            
            <!-- Titre -->
            <h2 id="success-title" class="text-2xl font-bold text-center mb-2 text-emerald-400">
                Paiement confirm√© !
            </h2>
            <p class="text-center text-white/70 mb-8">
                Voici le code cadeau Cinq
            </p>
            
            <!-- Code cadeau -->
            <div class="bg-white/10 backdrop-blur border-2 border-dashed border-indigo-400/50 rounded-2xl p-6 text-center mb-6" role="region" aria-label="Code cadeau">
                <div class="font-mono text-2xl font-bold tracking-wider select-all" id="gift-code" aria-live="polite">
                    <!-- Code g√©n√©r√© par le serveur -->
                </div>
            </div>
            
            <!-- Actions -->
            <div class="space-y-3">
                <button 
                    onclick="CinqGift.copyGiftCode()" 
                    id="copy-code-btn"
                    class="w-full py-4 bg-indigo-500 hover:bg-indigo-400 rounded-xl font-semibold transition flex items-center justify-center gap-2"
                    aria-describedby="copy-code-status-sr"
                >
                    <span aria-hidden="true">üìã</span>
                    <span id="copy-code-text">Copier le code</span>
                </button>
                <span id="copy-code-status-sr" class="sr-only" aria-live="polite"></span>
                
                <button 
                    onclick="CinqGift.shareGift()"
                    class="w-full py-4 bg-white/10 hover:bg-white/15 border border-white/20 rounded-xl font-semibold transition flex items-center justify-center gap-2"
                >
                    <span aria-hidden="true">üì§</span>
                    <span>Partager</span>
                </button>
            </div>
            
            <!-- Infos validit√© -->
            <div class="mt-6 text-center text-white/60 text-sm space-y-2">
                <p>Le code est valable <strong class="text-white/70">12 mois</strong>.</p>
                <p>Le destinataire pourra l'activer sur<br>
                    <a href="/redeem" class="text-indigo-400 hover:underline">cinq.app/redeem</a>
                </p>
            </div>
            
            <!-- Retour -->
            <div class="mt-8 text-center">
                <a href="index.html" class="text-white/60 hover:text-white/70 text-sm transition">
                    ‚Üê Retour √† l'accueil
                </a>
            </div>
            
        </section>

    </main>

    <!-- ============================================
         JavaScript - Logique s√©curis√©e (IIFE)
         ============================================ -->
    <script>
        /**
         * CinqGift - Module de gestion des cartes cadeaux
         * 
         * S√âCURIT√â:
         * - G√©n√©ration de code c√¥t√© serveur uniquement
         * - Adresses wallet r√©cup√©r√©es via API sign√©e
         * - Polling s√©curis√© pour v√©rification paiement
         * - Aucune donn√©e sensible en dur
         */
        const CinqGift = (function() {
            'use strict';
            
            // ========================================
            // Configuration
            // ========================================
            const API_BASE = '/.netlify/functions';
            const PAYMENT_TIMEOUT = 15 * 60; // 15 minutes en secondes
            
            // Mode simulation pour le d√©veloppement (pas d'API de paiement encore)
            // En production, mettre √† false et impl√©menter les endpoints de paiement
            const SIMULATION_MODE = true;
            const SIMULATION_DELAY_MS = 5000; // 5 secondes avant "paiement confirm√©"
            
            // √âtat interne (encapsul√©)
            let _state = {
                selectedPayment: null,
                paymentSession: null,
                timerInterval: null,
                timeRemaining: PAYMENT_TIMEOUT,
                pollingInterval: null,
                sessionStartTime: null,
                simulationTimeout: null
            };
            
            // ========================================
            // Utilitaires
            // ========================================
            
            /**
             * Escape HTML pour pr√©venir XSS
             */
            function escapeHtml(str) {
                if (typeof str !== 'string') return '';
                const div = document.createElement('div');
                div.textContent = str;
                return div.innerHTML;
            }
            
            /**
             * Annonce pour lecteurs d'√©cran
             */
            function announce(message) {
                const el = document.getElementById('sr-announcements');
                if (el) {
                    el.textContent = message;
                }
            }
            
            /**
             * Gestion focus pour navigation clavier
             */
            function focusFirstElement(screenId) {
                const screen = document.getElementById(screenId);
                if (!screen) return;
                
                // Trouver le premier √©l√©ment focusable
                const focusable = screen.querySelector(
                    'button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])'
                );
                if (focusable) {
                    // Petit d√©lai pour laisser l'animation se terminer
                    setTimeout(() => focusable.focus(), 100);
                }
            }
            
            /**
             * Affiche une erreur dans un conteneur
             */
            function showError(containerId, message) {
                const container = document.getElementById(containerId);
                const messageEl = document.getElementById(containerId + '-message');
                if (container && messageEl) {
                    messageEl.textContent = escapeHtml(message);
                    container.classList.remove('hidden');
                    container.setAttribute('role', 'alert');
                }
            }
            
            /**
             * Cache une erreur
             */
            function hideError(containerId) {
                const container = document.getElementById(containerId);
                if (container) {
                    container.classList.add('hidden');
                }
            }
            
            /**
             * Copie dans le presse-papier avec fallback
             */
            async function copyToClipboard(text) {
                // M√©thode moderne
                if (navigator.clipboard && navigator.clipboard.writeText) {
                    try {
                        await navigator.clipboard.writeText(text);
                        return true;
                    } catch (err) {
                        // Fallback si permission refus√©e
                    }
                }
                
                // Fallback : document.execCommand (deprecated mais fonctionnel)
                try {
                    const textArea = document.createElement('textarea');
                    textArea.value = text;
                    textArea.style.position = 'fixed';
                    textArea.style.left = '-9999px';
                    textArea.style.top = '-9999px';
                    document.body.appendChild(textArea);
                    textArea.focus();
                    textArea.select();
                    
                    const success = document.execCommand('copy');
                    document.body.removeChild(textArea);
                    return success;
                } catch (err) {
                    return false;
                }
            }
            
            // ========================================
            // API Calls
            // ========================================
            
            /**
             * G√©n√®re des donn√©es de simulation pour le d√©veloppement
             */
            function generateSimulationData(paymentType) {
                const sessionId = 'sim_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
                
                const wallets = {
                    usdc: { address: '0x742d35Cc6634C0532925a3b844Bc9e7595f8dE71', amount: '50.00 USDC' },
                    btc: { address: 'bc1qar0srrr7xfkvy5l643lydnw9re59gtzzwf5mdq', amount: '0.00052 BTC' },
                    eth: { address: '0x742d35Cc6634C0532925a3b844Bc9e7595f8dE71', amount: '0.014 ETH' }
                };
                
                const wallet = wallets[paymentType] || wallets.usdc;
                
                return {
                    session_id: sessionId,
                    address: wallet.address,
                    amount_display: wallet.amount,
                    amount_eur: 50,
                    payment_type: paymentType,
                    qr_code_url: `https://api.qrserver.com/v1/create-qr-code/?size=200x200&data=${encodeURIComponent(wallet.address)}`,
                    status: 'pending',
                    expires_at: new Date(Date.now() + PAYMENT_TIMEOUT * 1000).toISOString()
                };
            }
            
            /**
             * Cr√©e une session de paiement c√¥t√© serveur
             * Retourne l'adresse wallet et les d√©tails de paiement
             */
            async function createPaymentSession(paymentType) {
                // Mode simulation pour le d√©veloppement
                if (SIMULATION_MODE) {
                    console.log('[SIMULATION] Cr√©ation session paiement:', paymentType);
                    return generateSimulationData(paymentType);
                }
                
                // Mode production - appel √† l'API de paiement crypto
                const response = await fetch(`${API_BASE}/payment-create`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        type: paymentType,
                        product: 'gift',
                        amount_eur: 50
                    })
                });
                
                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({}));
                    throw new Error(errorData.error || 'Erreur lors de la cr√©ation du paiement');
                }
                
                return response.json();
            }
            
            /**
             * V√©rifie le statut du paiement
             */
            async function checkPaymentStatus(sessionId) {
                // Mode simulation - retourne toujours "pending" (la confirmation vient du timeout)
                if (SIMULATION_MODE) {
                    return { status: 'pending' };
                }
                
                // Mode production
                const response = await fetch(`${API_BASE}/payment-status?session_id=${encodeURIComponent(sessionId)}`);
                
                if (!response.ok) {
                    throw new Error('Erreur lors de la v√©rification du paiement');
                }
                
                return response.json();
            }
            
            /**
             * G√©n√®re le code cadeau APR√àS confirmation du paiement
             * Appelle la fonction Netlify gift-create
             */
            async function createGiftCode(paymentSession) {
                const headers = {
                    'Content-Type': 'application/json'
                };
                
                // Ajouter l'API key si configur√©e (via meta tag ou env)
                const apiKeyMeta = document.querySelector('meta[name="gift-api-key"]');
                if (apiKeyMeta && apiKeyMeta.content) {
                    headers['X-Api-Key'] = apiKeyMeta.content;
                }
                
                const response = await fetch('/.netlify/functions/gift-create', {
                    method: 'POST',
                    headers,
                    body: JSON.stringify({
                        amount_cents: 5000, // 50‚Ç¨
                        currency: 'EUR',
                        purchaser_email: paymentSession?.email || null,
                        purchase_order_id: paymentSession?.session_id || null,
                        expires_days: 365
                    })
                });
                
                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({}));
                    throw new Error(errorData.error || 'Erreur lors de la g√©n√©ration du code');
                }
                
                const data = await response.json();
                
                // L'API retourne { code, gift_code: {...}, message }
                if (!data.code) {
                    throw new Error('Code cadeau non re√ßu du serveur');
                }
                
                return data;
            }
            
            // ========================================
            // Navigation entre √©crans
            // ========================================
            function showScreen(screenName) {
                // Cacher tous les √©crans
                document.querySelectorAll('.screen').forEach(screen => {
                    screen.classList.add('hidden');
                    screen.setAttribute('aria-hidden', 'true');
                });
                
                // Afficher l'√©cran demand√©
                const targetScreen = document.getElementById(`screen-${screenName}`);
                if (targetScreen) {
                    targetScreen.classList.remove('hidden');
                    targetScreen.setAttribute('aria-hidden', 'false');
                    
                    // Focus management pour accessibilit√©
                    focusFirstElement(`screen-${screenName}`);
                    
                    // Annonce pour lecteurs d'√©cran
                    const title = targetScreen.querySelector('h1, h2');
                    if (title) {
                        announce(title.textContent);
                    }
                }
                
                // G√©rer le timer et polling pour l'√©cran QR
                if (screenName === 'qr') {
                    startTimer();
                    startPaymentPolling();
                } else {
                    stopTimer();
                    stopPaymentPolling();
                }
            }
            
            // ========================================
            // S√©lection du moyen de paiement
            // ========================================
            async function selectPayment(paymentType) {
                _state.selectedPayment = paymentType;
                
                // Afficher loading
                hideError('payment-error');
                
                try {
                    // Appel API pour cr√©er la session et obtenir l'adresse
                    const session = await createPaymentSession(paymentType);
                    
                    _state.paymentSession = session;
                    _state.timeRemaining = PAYMENT_TIMEOUT;
                    _state.sessionStartTime = Date.now();
                    
                    // Mettre √† jour l'affichage (donn√©es √©chapp√©es)
                    document.getElementById('amount-crypto').textContent = 
                        escapeHtml(session.amount_display);
                    
                    // Adresse tronqu√©e pour affichage
                    const addr = session.address;
                    document.getElementById('wallet-address').textContent = 
                        escapeHtml(addr.slice(0, 6) + '...' + addr.slice(-4));
                    
                    // Afficher le QR code (URL fournie par le serveur)
                    const qrContainer = document.getElementById('qr-container');
                    const qrLoading = document.getElementById('qr-loading');
                    
                    if (session.qr_code_url) {
                        const qrImg = document.createElement('img');
                        qrImg.src = session.qr_code_url;
                        qrImg.alt = `QR Code pour payer ${escapeHtml(session.amount_display)}`;
                        qrImg.className = 'w-full h-full object-contain';
                        qrImg.onload = () => {
                            qrLoading.classList.add('hidden');
                        };
                        qrImg.onerror = () => {
                            qrLoading.innerHTML = '<div class="text-red-500 text-sm">Erreur QR</div>';
                        };
                        qrContainer.appendChild(qrImg);
                    }
                    
                    // Afficher l'√©cran QR
                    showScreen('qr');
                    
                } catch (error) {
                    showError('payment-error', error.message);
                }
            }
            
            // ========================================
            // Timer de paiement (15 minutes)
            // ========================================
            function startTimer() {
                stopTimer();
                
                updateTimerDisplay();
                _state.timerInterval = setInterval(() => {
                    // Calcul bas√© sur timestamp r√©el (gestion onglet arri√®re-plan)
                    if (_state.sessionStartTime) {
                        const elapsed = Math.floor((Date.now() - _state.sessionStartTime) / 1000);
                        _state.timeRemaining = Math.max(0, PAYMENT_TIMEOUT - elapsed);
                    } else {
                        _state.timeRemaining--;
                    }
                    
                    updateTimerDisplay();
                    
                    if (_state.timeRemaining <= 0) {
                        stopTimer();
                        stopPaymentPolling();
                        announce('Session expir√©e. Le d√©lai de paiement a √©t√© d√©pass√©.');
                        showError('qr-error', 'Session expir√©e. Le d√©lai de paiement (15 min) a √©t√© d√©pass√©.');
                        setTimeout(() => showScreen('payment'), 3000);
                    }
                }, 1000);
            }
            
            function stopTimer() {
                if (_state.timerInterval) {
                    clearInterval(_state.timerInterval);
                    _state.timerInterval = null;
                }
            }
            
            function updateTimerDisplay() {
                const minutes = Math.floor(_state.timeRemaining / 60);
                const seconds = _state.timeRemaining % 60;
                const timerEl = document.getElementById('timer');
                
                timerEl.textContent = `${minutes}:${seconds.toString().padStart(2, '0')}`;
                
                // Changer la couleur si moins de 2 minutes
                const timerContainer = timerEl.parentElement;
                if (_state.timeRemaining < 120) {
                    timerContainer.classList.remove('text-amber-400', 'bg-amber-500/10');
                    timerContainer.classList.add('text-red-400', 'bg-red-500/10');
                } else {
                    timerContainer.classList.remove('text-red-400', 'bg-red-500/10');
                    timerContainer.classList.add('text-amber-400', 'bg-amber-500/10');
                }
            }
            
            // ========================================
            // Polling de statut de paiement
            // ========================================
            function startPaymentPolling() {
                stopPaymentPolling();
                
                // Mode simulation: confirmation automatique apr√®s d√©lai
                if (SIMULATION_MODE) {
                    console.log(`[SIMULATION] Paiement sera confirm√© dans ${SIMULATION_DELAY_MS/1000}s`);
                    _state.simulationTimeout = setTimeout(async () => {
                        console.log('[SIMULATION] Paiement confirm√©!');
                        stopTimer();
                        await handlePaymentConfirmed();
                    }, SIMULATION_DELAY_MS);
                    return;
                }
                
                // Mode production: polling r√©el
                _state.pollingInterval = setInterval(async () => {
                    if (!_state.paymentSession) return;
                    
                    try {
                        const status = await checkPaymentStatus(_state.paymentSession.session_id);
                        
                        if (status.status === 'confirmed') {
                            stopTimer();
                            stopPaymentPolling();
                            
                            // Paiement confirm√© ! G√©n√©rer le code cadeau
                            await handlePaymentConfirmed();
                        } else if (status.status === 'failed') {
                            showError('qr-error', 'Le paiement a √©chou√©. Veuillez r√©essayer.');
                        }
                    } catch (err) {
                        // Erreur silencieuse pour le polling (on r√©essaie)
                        console.warn('Payment polling error:', err);
                    }
                }, 5000); // V√©rifier toutes les 5 secondes
            }
            
            function stopPaymentPolling() {
                if (_state.pollingInterval) {
                    clearInterval(_state.pollingInterval);
                    _state.pollingInterval = null;
                }
                if (_state.simulationTimeout) {
                    clearTimeout(_state.simulationTimeout);
                    _state.simulationTimeout = null;
                }
            }
            
            // ========================================
            // Gestion paiement confirm√©
            // ========================================
            async function handlePaymentConfirmed() {
                // Mettre √† jour le statut visuel
                const statusEl = document.getElementById('payment-status');
                if (statusEl) {
                    statusEl.innerHTML = '<span aria-hidden="true">‚è≥</span><span>G√©n√©ration du code cadeau...</span>';
                }
                
                try {
                    // G√©n√©rer le code cadeau c√¥t√© serveur
                    const giftData = await createGiftCode(_state.paymentSession);
                    
                    // Afficher le code (√©chapp√© pour s√©curit√©)
                    // L'API retourne { code: "CINQ-XXXX-XXXX-XXXX", gift_code: {...}, message }
                    const code = giftData.code;
                    document.getElementById('gift-code').textContent = escapeHtml(code);
                    
                    // Stocker pour copie/partage
                    _state.generatedCode = code;
                    _state.giftCodeData = giftData.gift_code;
                    
                    // Afficher l'√©cran de succ√®s
                    showScreen('success');
                    announce('Paiement confirm√© ! Votre code cadeau est pr√™t.');
                    
                } catch (err) {
                    console.error('Gift code creation error:', err);
                    const errorMessage = err.message || 'Erreur inconnue';
                    showError('qr-error', `Erreur: ${errorMessage}. Contactez le support avec votre ID de paiement.`);
                    
                    // Mettre √† jour le statut
                    if (statusEl) {
                        statusEl.innerHTML = '<span aria-hidden="true">‚ùå</span><span class="text-red-400">Erreur de g√©n√©ration</span>';
                    }
                }
            }
            
            // ========================================
            // Copier l'adresse
            // ========================================
            async function copyAddress() {
                if (!_state.paymentSession) return;
                
                const success = await copyToClipboard(_state.paymentSession.address);
                
                const btn = document.getElementById('copy-btn');
                const status = document.getElementById('copy-status');
                const statusSr = document.getElementById('copy-status-sr');
                
                if (success) {
                    btn.classList.add('copied');
                    status.textContent = '‚úì Copi√© !';
                    statusSr.textContent = 'Adresse copi√©e dans le presse-papier';
                } else {
                    status.textContent = '‚úó Erreur';
                    statusSr.textContent = 'Impossible de copier l\'adresse';
                }
                
                setTimeout(() => {
                    btn.classList.remove('copied');
                    status.textContent = 'Copier';
                }, 2000);
            }
            
            // ========================================
            // Copier le code cadeau
            // ========================================
            async function copyGiftCode() {
                const code = _state.generatedCode || document.getElementById('gift-code').textContent;
                if (!code) return;
                
                const success = await copyToClipboard(code);
                
                const textEl = document.getElementById('copy-code-text');
                const statusSr = document.getElementById('copy-code-status-sr');
                
                if (success) {
                    textEl.textContent = '‚úì Code copi√© !';
                    statusSr.textContent = 'Code cadeau copi√© dans le presse-papier';
                } else {
                    textEl.textContent = '‚úó Erreur de copie';
                    statusSr.textContent = 'Impossible de copier le code';
                }
                
                setTimeout(() => {
                    textEl.textContent = 'Copier le code';
                }, 2000);
            }
            
            // ========================================
            // Partager le cadeau
            // ========================================
            async function shareGift() {
                const code = _state.generatedCode || document.getElementById('gift-code').textContent;
                if (!code) return;
                
                const shareText = `üéÅ Je t'offre un acc√®s √† Cinq !

Utilise ce code : ${code}
üëâ Active-le sur cinq.app/redeem

√Ä bient√¥t sur Cinq ! ‚ú®`;
                
                if (navigator.share) {
                    try {
                        await navigator.share({
                            title: 'Cadeau Cinq',
                            text: shareText,
                            url: 'https://cinq.app/redeem'
                        });
                    } catch (err) {
                        // User cancelled ou erreur - fallback silencieux
                        if (err.name !== 'AbortError') {
                            await fallbackShare(shareText);
                        }
                    }
                } else {
                    await fallbackShare(shareText);
                }
            }
            
            async function fallbackShare(text) {
                const success = await copyToClipboard(text);
                if (success) {
                    announce('Message copi√© ! Vous pouvez le coller dans votre app de messagerie.');
                    // Feedback visuel simple
                    const btn = document.querySelector('[onclick="CinqGift.shareGift()"]');
                    if (btn) {
                        const original = btn.innerHTML;
                        btn.innerHTML = '<span>‚úì</span><span>Message copi√© !</span>';
                        setTimeout(() => {
                            btn.innerHTML = original;
                        }, 2000);
                    }
                }
            }
            
            // ========================================
            // Nettoyage au d√©chargement
            // ========================================
            function cleanup() {
                stopTimer();
                stopPaymentPolling();
                if (_state.simulationTimeout) {
                    clearTimeout(_state.simulationTimeout);
                    _state.simulationTimeout = null;
                }
            }
            
            // ========================================
            // Initialisation
            // ========================================
            function init() {
                // Nettoyage au d√©chargement de la page
                window.addEventListener('beforeunload', cleanup);
                
                // Gestion de la visibilit√© (pause/resume quand onglet en arri√®re-plan)
                document.addEventListener('visibilitychange', () => {
                    if (document.visibilityState === 'visible' && _state.paymentSession) {
                        // Recalculer le temps restant bas√© sur le timestamp
                        if (_state.sessionStartTime) {
                            const elapsed = Math.floor((Date.now() - _state.sessionStartTime) / 1000);
                            _state.timeRemaining = Math.max(0, PAYMENT_TIMEOUT - elapsed);
                            updateTimerDisplay();
                        }
                    }
                });
            }
            
            // Initialiser au chargement
            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', init);
            } else {
                init();
            }
            
            // ========================================
            // API publique
            // ========================================
            return {
                showScreen,
                selectPayment,
                copyAddress,
                copyGiftCode,
                shareGift
            };
            
        })();
    </script>

</body>
</html>
