<!DOCTYPE html>
<html lang="fr">
<head>
    <!-- Accessibility: Viewport should allow user scaling for a11y -->
    <!-- Note: user-scalable=no kept for app-like experience, but consider removing for better a11y -->
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title data-i18n-title="app.yourSpace">Cinq — Ton espace intime</title>
    
    <!-- SEO -->
    <meta name="description" content="Cinq — Ton espace intime avec tes 5 proches. L'anti-réseau social sans algorithme, sans likes.">
    <meta name="robots" content="noindex, nofollow">
    
    <!-- Canonical -->
    <link rel="canonical" href="https://cinq.app/app">
    
    <!-- Open Graph -->
    <meta property="og:title" content="Cinq — Ton espace intime">
    <meta property="og:description" content="L'anti-réseau social. 5 proches, pas de likes.">
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://cinq.app/app">
    <meta property="og:image" content="https://cinq.app/og-image.png">
    <meta property="og:site_name" content="Cinq">
    <meta property="og:locale" content="fr_FR">
    
    <!-- Favicon & PWA -->
    <link rel="icon" type="image/svg+xml" href="/favicon.svg">
    <link rel="apple-touch-icon" sizes="180x180" href="/assets/icons/icon-192x192.png">
    <meta name="theme-color" content="#0e0e12" id="theme-color-meta">
    <link rel="manifest" href="/manifest.json">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Cinq">
    
    <!-- Google Fonts — Distinctive Typography -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;500;600;700&family=Inter:wght@400;500;600&display=swap" media="print" onload="this.media='all'">
    <noscript><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;500;600;700&family=Inter:wght@400;500;600&display=swap"></noscript>
    
    <!-- Critical CSS (inline for fastest FCP) -->
    <link rel="stylesheet" href="/css/critical.min.css">
    
    <!-- Design System (async load for non-critical CSS) -->
    <link rel="preload" href="/design/styles.min.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
    <noscript><link rel="stylesheet" href="/design/styles.min.css"></noscript>
    <link rel="stylesheet" href="/animations.min.css">
    <link rel="stylesheet" href="/css/mobile-responsive.min.css">
    <link rel="stylesheet" href="/css/a11y.min.css">
    
    <!-- Theme CSS for smooth transitions -->
    <link rel="stylesheet" href="/css/theme.css">
    
    <!-- GIPHY Integration -->
    <link rel="stylesheet" href="/css/giphy.css">
    
    <!-- Theme initialization (before body to prevent flash) -->
    <script src="/js/theme.js"></script>
    
    <!-- Shared utilities (escapeHtml, authHeaders, showToast, etc.) -->
    <script src="/js/shared.js"></script>
    
    <!-- Markdown parser for posts and messages -->
    <script src="/js/markdown.js"></script>
    
    <!-- Supabase Client for Realtime -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>
    
    <style>
        /* ===== ACCESSIBILITY: SKIP LINK ===== */
        .skip-link {
            position: absolute;
            top: -100%;
            left: 50%;
            transform: translateX(-50%);
            background: var(--cinq-gradient);
            color: white;
            padding: var(--space-3) var(--space-5);
            border-radius: var(--radius-lg);
            font-weight: 600;
            text-decoration: none;
            z-index: calc(var(--z-toast) + 1);
            transition: top 0.2s;
        }
        
        .skip-link:focus {
            top: var(--space-4);
            outline: 2px solid white;
            outline-offset: 2px;
        }
        
        /* ===== ACCESSIBILITY: FOCUS STYLES ===== */
        :focus-visible {
            outline: 2px solid var(--color-brand);
            outline-offset: 2px;
        }
        
        /* Remove default focus for mouse users, keep for keyboard */
        :focus:not(:focus-visible) {
            outline: none;
        }
        
        /* ===== ACCESSIBILITY: REDUCED MOTION ===== */
        @media (prefers-reduced-motion: reduce) {
            *, *::before, *::after {
                animation-duration: 0.01ms !important;
                animation-iteration-count: 1 !important;
                transition-duration: 0.01ms !important;
            }
            
            .tab-panel {
                animation: none !important;
            }
            
            .btn-ripple::after {
                display: none !important;
            }
        }
        
        /* ===== MICRO-ANIMATIONS: BUTTON RIPPLE ===== */
        .btn-ripple {
            position: relative;
            overflow: hidden;
            isolation: isolate;
        }
        
        .btn-ripple::after {
            content: '';
            position: absolute;
            inset: 0;
            background: radial-gradient(circle at var(--ripple-x, 50%) var(--ripple-y, 50%), rgba(255,255,255,0.3) 0%, transparent 60%);
            opacity: 0;
            transform: scale(0);
            pointer-events: none;
        }
        
        .btn-ripple.rippling::after {
            animation: ripple-effect 0.6s ease-out forwards;
        }
        
        @keyframes ripple-effect {
            0% { opacity: 1; transform: scale(0); }
            100% { opacity: 0; transform: scale(2.5); }
        }
        
        /* ===== MICRO-ANIMATIONS: BUTTON PRESS ===== */
        .btn-press {
            transition: transform 0.1s ease-out, box-shadow 0.15s ease;
        }
        
        .btn-press:active {
            transform: scale(0.96) !important;
        }
        
        /* ===== MICRO-ANIMATIONS: GLOW PULSE ON HOVER ===== */
        .glow-hover {
            position: relative;
        }
        
        .glow-hover::before {
            content: '';
            position: absolute;
            inset: -2px;
            border-radius: inherit;
            background: var(--cinq-gradient);
            opacity: 0;
            z-index: -1;
            filter: blur(8px);
            transition: opacity 0.3s ease;
        }
        
        .glow-hover:hover::before {
            opacity: 0.4;
            animation: glow-pulse 2s ease-in-out infinite;
        }
        
        @keyframes glow-pulse {
            0%, 100% { opacity: 0.3; filter: blur(8px); }
            50% { opacity: 0.5; filter: blur(12px); }
        }
        
        /* ===== HAPTIC FEEDBACK: VIBRATION PATTERNS ===== */
        @keyframes haptic-success {
            0%, 100% { transform: translateX(0); }
            10%, 30%, 50% { transform: translateX(-1px); }
            20%, 40% { transform: translateX(1px); }
        }
        
        @keyframes haptic-error {
            0%, 100% { transform: translateX(0); }
            10%, 30%, 50%, 70%, 90% { transform: translateX(-2px); }
            20%, 40%, 60%, 80% { transform: translateX(2px); }
        }
        
        @keyframes haptic-tap {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(0.98); }
        }
        
        .haptic-success { animation: haptic-success 0.4s ease-out; }
        .haptic-error { animation: haptic-error 0.5s ease-out; }
        .haptic-tap { animation: haptic-tap 0.15s ease-out; }
        
        /* ===== ACTION FEEDBACK: LIKE/HEART BURST ===== */
        @keyframes heart-burst {
            0% { transform: scale(1); }
            15% { transform: scale(1.3); }
            30% { transform: scale(0.95); }
            45% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }
        
        .heart-burst {
            animation: heart-burst 0.5s ease-out;
        }
        
        /* ===== ACTION FEEDBACK: SEND FLY ===== */
        @keyframes send-fly {
            0% { transform: translateX(0) scale(1); opacity: 1; }
            100% { transform: translateX(30px) translateY(-10px) scale(0.5); opacity: 0; }
        }
        
        .send-fly {
            animation: send-fly 0.4s ease-out forwards;
        }
        
        /* ===== ACTION FEEDBACK: SUCCESS CHECK ===== */
        @keyframes success-check {
            0% { stroke-dashoffset: 24; }
            100% { stroke-dashoffset: 0; }
        }
        
        .success-check {
            stroke-dasharray: 24;
            animation: success-check 0.4s ease-out forwards;
        }
        
        /* ===== STAGGERED REVEAL ANIMATIONS ===== */
        @keyframes stagger-fade-up {
            0% { opacity: 0; transform: translateY(20px); }
            100% { opacity: 1; transform: translateY(0); }
        }
        
        .stagger-reveal > * {
            opacity: 0;
            animation: stagger-fade-up 0.4s ease-out forwards;
        }
        
        .stagger-reveal > *:nth-child(1) { animation-delay: 0ms; }
        .stagger-reveal > *:nth-child(2) { animation-delay: 50ms; }
        .stagger-reveal > *:nth-child(3) { animation-delay: 100ms; }
        .stagger-reveal > *:nth-child(4) { animation-delay: 150ms; }
        .stagger-reveal > *:nth-child(5) { animation-delay: 200ms; }
        .stagger-reveal > *:nth-child(n+6) { animation-delay: 250ms; }
        
        /* ===== ELEMENT ENTRANCE ANIMATIONS ===== */
        @keyframes slide-up-fade {
            0% { opacity: 0; transform: translateY(16px); }
            100% { opacity: 1; transform: translateY(0); }
        }
        
        @keyframes slide-in-right {
            0% { opacity: 0; transform: translateX(20px); }
            100% { opacity: 1; transform: translateX(0); }
        }
        
        @keyframes scale-in {
            0% { opacity: 0; transform: scale(0.9); }
            100% { opacity: 1; transform: scale(1); }
        }
        
        @keyframes pop-in {
            0% { opacity: 0; transform: scale(0.8); }
            60% { transform: scale(1.05); }
            100% { opacity: 1; transform: scale(1); }
        }
        
        .animate-slide-up { animation: slide-up-fade 0.35s ease-out forwards; }
        .animate-slide-right { animation: slide-in-right 0.35s ease-out forwards; }
        .animate-scale-in { animation: scale-in 0.3s ease-out forwards; }
        .animate-pop-in { animation: pop-in 0.4s var(--ease-spring) forwards; }
        
        /* ===== ACCESSIBILITY: SCREEN READER ONLY ===== */
        .sr-only {
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0, 0, 0, 0);
            white-space: nowrap;
            border: 0;
        }
        
        /* ===== APP SHELL ===== */
        .app-shell {
            min-height: 100vh;
            min-height: 100dvh;
            display: flex;
            flex-direction: column;
        }
        
        /* ===== PROFESSIONAL HEADER ===== */
        .app-header {
            position: sticky;
            top: 0;
            z-index: var(--z-sticky);
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: var(--space-3) var(--space-5);
            background: var(--glass-bg);
            backdrop-filter: blur(24px) saturate(180%);
            -webkit-backdrop-filter: blur(24px) saturate(180%);
            border-bottom: 1px solid var(--color-border-subtle);
            transition: all 0.3s var(--ease-out-expo);
        }
        
        /* Subtle gradient line at bottom */
        .app-header::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 1px;
            background: linear-gradient(90deg, 
                transparent 0%, 
                var(--color-brand) 20%, 
                var(--cinq-coral-light) 50%, 
                var(--color-brand) 80%, 
                transparent 100%);
            opacity: 0.3;
        }
        
        /* Scrolled state */
        .app-header.scrolled {
            padding: var(--space-2) var(--space-5);
            box-shadow: 0 4px 24px -4px rgba(0, 0, 0, 0.12);
        }
        
        .app-header.scrolled::after {
            opacity: 0.5;
        }
        
        /* ===== HEADER LOGO AREA ===== */
        .header-brand {
            display: flex;
            align-items: center;
            gap: var(--space-3);
            text-decoration: none;
            position: relative;
        }
        
        .header-brand:hover .header-logo-icon {
            transform: scale(1.05) rotate(5deg);
        }
        
        .header-brand:hover .header-logo-text {
            letter-spacing: 0.02em;
        }
        
        /* Logo icon container */
        .header-logo-icon {
            position: relative;
            width: 38px;
            height: 38px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: transform 0.3s var(--ease-spring);
        }
        
        /* Pentagon background glow */
        .header-logo-icon::before {
            content: '';
            position: absolute;
            inset: -4px;
            background: var(--cinq-gradient);
            clip-path: polygon(50% 0%, 100% 38%, 82% 100%, 18% 100%, 0% 38%);
            opacity: 0.15;
            filter: blur(8px);
            animation: logo-pulse 4s ease-in-out infinite;
        }
        
        @keyframes logo-pulse {
            0%, 100% { opacity: 0.15; transform: scale(1); }
            50% { opacity: 0.25; transform: scale(1.08); }
        }
        
        /* The "5" number */
        .header-logo-number {
            font-family: var(--font-display, 'Space Grotesk', sans-serif);
            font-size: 1.5rem;
            font-weight: 700;
            background: var(--cinq-gradient);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            position: relative;
            z-index: 1;
            line-height: 1;
        }
        
        /* Logo text */
        .header-logo-text {
            font-family: var(--font-display, 'Space Grotesk', sans-serif);
            font-size: 1.125rem;
            font-weight: 600;
            color: var(--color-text-primary);
            letter-spacing: -0.01em;
            transition: letter-spacing 0.3s var(--ease-out-expo);
            position: relative;
        }
        
        /* Subtle dot separator */
        .header-logo-text::before {
            content: '';
            position: absolute;
            left: -10px;
            top: 50%;
            transform: translateY(-50%);
            width: 3px;
            height: 3px;
            background: var(--color-brand);
            border-radius: 50%;
            opacity: 0.6;
        }
        
        /* ===== CENTER NAV (optional, future-ready) ===== */
        .header-nav {
            display: none; /* Hidden for now, ready for future expansion */
            align-items: center;
            gap: var(--space-1);
        }
        
        @media (min-width: 768px) {
            .header-nav {
                display: flex;
            }
        }
        
        .header-nav-item {
            padding: var(--space-2) var(--space-4);
            font-family: var(--font-display, 'Space Grotesk', sans-serif);
            font-size: var(--text-sm);
            font-weight: 500;
            color: var(--color-text-muted);
            border-radius: var(--radius-lg);
            cursor: pointer;
            transition: all 0.2s var(--ease-out-expo);
            border: none;
            background: none;
            position: relative;
        }
        
        .header-nav-item:hover {
            color: var(--color-text-primary);
            background: var(--color-bg-hover);
        }
        
        .header-nav-item.active {
            color: var(--color-brand);
            background: var(--color-brand-muted);
        }
        
        /* ===== HEADER ACTIONS ===== */
        .header-actions {
            display: flex;
            align-items: center;
            gap: var(--space-2);
        }
        
        /* Action button base style */
        .header-action-btn {
            position: relative;
            width: 38px;
            height: 38px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--color-bg-tertiary);
            border: 1px solid var(--color-border);
            border-radius: var(--radius-lg);
            cursor: pointer;
            color: var(--color-text-muted);
            transition: all 0.2s var(--ease-out-expo);
        }
        
        .header-action-btn:hover {
            background: var(--color-bg-elevated);
            border-color: var(--color-border-active);
            color: var(--color-text-primary);
            transform: translateY(-1px);
        }
        
        .header-action-btn:active {
            transform: translateY(0) scale(0.95);
        }
        
        .header-action-btn svg {
            transition: transform 0.2s var(--ease-spring);
        }
        
        .header-action-btn:hover svg {
            transform: scale(1.1);
        }
        
        /* Theme toggle button */
        .theme-toggle {
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 38px;
            height: 38px;
            background: var(--color-bg-tertiary);
            border: 1px solid var(--color-border);
            border-radius: var(--radius-lg);
            cursor: pointer;
            transition: all 0.2s var(--ease-out-expo);
            overflow: hidden;
        }
        
        .theme-toggle:hover {
            background: var(--color-bg-elevated);
            border-color: var(--color-border-active);
            transform: translateY(-1px);
        }
        
        .theme-toggle:active {
            transform: translateY(0) scale(0.95);
        }
        
        .theme-toggle-icon {
            position: absolute;
            transition: transform 0.5s var(--ease-spring), opacity 0.3s;
            color: var(--color-text-muted);
        }
        
        .theme-toggle:hover .theme-toggle-icon {
            color: var(--color-text-primary);
        }
        
        .theme-toggle .icon-sun {
            transform: rotate(0) scale(1);
            opacity: 1;
        }
        
        .theme-toggle .icon-moon {
            transform: rotate(-90deg) scale(0);
            opacity: 0;
        }
        
        [data-theme="light"] .theme-toggle .icon-sun {
            transform: rotate(90deg) scale(0);
            opacity: 0;
        }
        
        [data-theme="light"] .theme-toggle .icon-moon {
            transform: rotate(0) scale(1);
            opacity: 1;
        }
        
        /* Notification button */
        .notification-btn {
            position: relative;
            width: 38px;
            height: 38px;
            border-radius: var(--radius-lg);
            background: var(--color-bg-tertiary);
            border: 1px solid var(--color-border);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s var(--ease-out-expo);
            color: var(--color-text-muted);
        }
        
        .notification-btn:hover {
            background: var(--color-bg-elevated);
            border-color: var(--color-border-active);
            color: var(--color-text-primary);
            transform: translateY(-1px);
        }
        
        .notification-btn:hover svg {
            animation: bell-ring 0.5s ease-in-out;
        }
        
        @keyframes bell-ring {
            0%, 100% { transform: rotate(0); }
            20% { transform: rotate(12deg); }
            40% { transform: rotate(-10deg); }
            60% { transform: rotate(6deg); }
            80% { transform: rotate(-4deg); }
        }
        
        .notification-btn:active {
            transform: translateY(0) scale(0.95);
        }
        
        .notification-badge {
            position: absolute;
            top: -3px;
            right: -3px;
            min-width: 18px;
            height: 18px;
            padding: 0 5px;
            border-radius: 9px;
            background: var(--color-error);
            color: white;
            font-size: 10px;
            font-weight: 700;
            display: flex;
            align-items: center;
            justify-content: center;
            animation: badge-pop 0.35s var(--ease-spring);
            box-shadow: 0 2px 8px var(--color-error-muted);
            border: 2px solid var(--color-bg-primary);
        }
        
        .notification-badge.hidden {
            display: none;
        }
        
        @keyframes badge-pop {
            0% { transform: scale(0); }
            60% { transform: scale(1.3); }
            100% { transform: scale(1); }
        }
        
        /* Header avatar */
        .header-avatar {
            width: 38px;
            height: 38px;
            min-width: 38px;
            min-height: 38px;
            max-width: 38px;
            max-height: 38px;
            border-radius: var(--radius-lg);
            background: var(--cinq-gradient);
            display: flex;
            align-items: center;
            justify-content: center;
            font-family: var(--font-display, 'Space Grotesk', sans-serif);
            font-size: 0.875rem;
            color: white;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s var(--ease-out-expo);
            overflow: hidden;
            flex-shrink: 0;
            position: relative;
            border: 2px solid transparent;
        }
        
        .header-avatar:hover {
            transform: translateY(-1px) scale(1.05);
            box-shadow: 0 4px 16px var(--color-brand-glow);
            border-color: rgba(255, 255, 255, 0.2);
        }
        
        .header-avatar:active {
            transform: translateY(0) scale(0.95);
        }
        
        .header-avatar:focus-visible {
            outline: 2px solid var(--color-brand);
            outline-offset: 2px;
        }
        
        .header-avatar img {
            width: 100%;
            height: 100%;
            max-width: 100%;
            max-height: 100%;
            object-fit: cover;
            position: absolute;
            inset: 0;
        }
        
        /* Status indicator on avatar */
        .header-avatar::after {
            content: '';
            position: absolute;
            bottom: -1px;
            right: -1px;
            width: 10px;
            height: 10px;
            background: var(--color-success);
            border-radius: 50%;
            border: 2px solid var(--color-bg-primary);
            opacity: 0;
            transition: opacity 0.2s;
        }
        
        .header-avatar.online::after {
            opacity: 1;
        }
        
        /* Divider between action groups */
        .header-divider {
            width: 1px;
            height: 20px;
            background: var(--color-border);
            margin: 0 var(--space-1);
        }
        
        /* ===== RESPONSIVE HEADER ===== */
        @media (max-width: 480px) {
            .app-header {
                padding: var(--space-2) var(--space-3);
            }
            
            .header-logo-text {
                display: none;
            }
            
            .header-logo-text::before {
                display: none;
            }
            
            .header-actions {
                gap: var(--space-1);
            }
            
            .header-action-btn,
            .theme-toggle,
            .notification-btn,
            .header-avatar {
                width: 36px;
                height: 36px;
                min-width: 36px;
                min-height: 36px;
            }
            
            .header-divider {
                display: none;
            }
        }
        
        /* ===== MAIN CONTENT ===== */
        .app-content {
            flex: 1;
            padding: var(--space-5);
            padding-bottom: calc(80px + env(safe-area-inset-bottom, var(--space-5)));
            max-width: 600px;
            margin: 0 auto;
            width: 100%;
        }
        
        /* ===== TAB PANELS ===== */
        .tab-panel {
            display: none;
            opacity: 0;
            transform: translateY(12px);
            transition: opacity 0.35s ease-out, transform 0.35s ease-out;
        }
        
        .tab-panel.active {
            display: block;
            opacity: 1;
            transform: translateY(0);
            animation: tab-enter 0.4s var(--ease-out-expo) forwards;
        }
        
        .tab-panel.exiting {
            animation: tab-exit 0.25s ease-in forwards;
        }
        
        @keyframes tab-enter {
            0% { 
                opacity: 0; 
                transform: translateY(16px) scale(0.98); 
            }
            100% { 
                opacity: 1; 
                transform: translateY(0) scale(1); 
            }
        }
        
        @keyframes tab-exit {
            0% { 
                opacity: 1; 
                transform: translateY(0) scale(1); 
            }
            100% { 
                opacity: 0; 
                transform: translateY(-8px) scale(0.98); 
            }
        }
        
        /* Tab slide direction variants */
        .tab-panel.slide-left {
            animation: tab-slide-left 0.4s var(--ease-out-expo) forwards;
        }
        
        .tab-panel.slide-right {
            animation: tab-slide-right 0.4s var(--ease-out-expo) forwards;
        }
        
        @keyframes tab-slide-left {
            0% { opacity: 0; transform: translateX(30px); }
            100% { opacity: 1; transform: translateX(0); }
        }
        
        @keyframes tab-slide-right {
            0% { opacity: 0; transform: translateX(-30px); }
            100% { opacity: 1; transform: translateX(0); }
        }
        
        /* ===== BOTTOM NAV ===== */
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            display: flex;
            justify-content: space-around;
            align-items: center;
            padding: var(--space-3) var(--space-4);
            padding-bottom: max(var(--space-3), env(safe-area-inset-bottom));
            background: var(--glass-bg);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border-top: 1px solid var(--color-border);
            z-index: var(--z-sticky);
        }
        
        .nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: var(--space-1);
            padding: var(--space-2) var(--space-4);
            border-radius: var(--radius-xl);
            cursor: pointer;
            transition: 
                color 0.2s ease,
                background 0.25s ease,
                transform 0.2s var(--ease-spring);
            color: var(--color-text-muted);
            background: transparent;
            border: none;
            font-family: var(--font-display, 'Space Grotesk', sans-serif);
            position: relative;
        }
        
        /* Active indicator pill */
        .nav-item::before {
            content: '';
            position: absolute;
            bottom: -2px;
            left: 50%;
            width: 4px;
            height: 4px;
            background: var(--color-brand);
            border-radius: 50%;
            transform: translateX(-50%) scale(0);
            transition: transform 0.3s var(--ease-spring);
        }
        
        .nav-item.active::before {
            transform: translateX(-50%) scale(1);
        }
        
        .nav-item:hover {
            color: var(--color-text-secondary);
            background: var(--color-bg-hover);
            transform: translateY(-3px);
        }
        
        .nav-item:active {
            transform: translateY(0) scale(0.92);
            transition-duration: 0.1s;
        }
        
        .nav-item.active {
            color: var(--color-brand);
            background: var(--color-brand-muted);
        }
        
        .nav-item.active:hover {
            transform: none;
        }
        
        /* Nav item tap feedback */
        .nav-item.tapped .nav-icon {
            animation: nav-icon-tap 0.3s ease-out;
        }
        
        @keyframes nav-icon-tap {
            0% { transform: scale(1); }
            30% { transform: scale(0.85); }
            60% { transform: scale(1.15); }
            100% { transform: scale(1); }
        }
        
        .nav-icon {
            width: 22px;
            height: 22px;
            transition: stroke 0.2s ease, transform 0.25s var(--ease-spring);
        }
        
        .nav-item:hover .nav-icon {
            transform: scale(1.12) translateY(-1px);
        }
        
        .nav-item.active .nav-icon {
            stroke: var(--color-brand);
            animation: nav-icon-active 0.4s var(--ease-spring);
        }
        
        @keyframes nav-icon-active {
            0% { transform: scale(1); }
            40% { transform: scale(1.2); }
            100% { transform: scale(1); }
        }
        
        .nav-label {
            font-size: var(--text-xs);
            font-weight: 500;
            transition: transform 0.2s ease, opacity 0.2s ease;
        }
        
        .nav-item.active .nav-label {
            font-weight: 600;
        }
        
        /* ===== FEED TAB ===== */
        .composer {
            background: var(--color-bg-secondary);
            border: 1px solid var(--color-border);
            border-radius: var(--radius-xl);
            padding: var(--space-4);
            margin-bottom: var(--space-5);
        }
        
        .composer-header {
            display: flex;
            align-items: center;
            gap: var(--space-3);
            margin-bottom: var(--space-3);
        }
        
        .composer-avatar {
            width: 40px;
            height: 40px;
            min-width: 40px;
            min-height: 40px;
            max-width: 40px;
            max-height: 40px;
            border-radius: 50%;
            background: var(--cinq-gradient);
            display: flex;
            align-items: center;
            justify-content: center;
            font-family: var(--font-display, 'Space Grotesk', sans-serif);
            font-size: 1rem;
            color: white;
            font-weight: 600;
            flex-shrink: 0;
            position: relative;
            overflow: hidden;
        }
        
        /* AVATAR IMG FIX: Constrain image inside composer avatar */
        .composer-avatar img {
            width: 100%;
            height: 100%;
            max-width: 100%;
            max-height: 100%;
            object-fit: cover;
            position: absolute;
            inset: 0;
        }
        
        .composer-user {
            font-weight: 600;
            font-size: var(--text-sm);
        }
        
        .composer-textarea {
            width: 100%;
            min-height: 80px;
            padding: var(--space-3);
            background: var(--color-bg-tertiary);
            border: 1px solid var(--color-border);
            border-radius: var(--radius-lg);
            color: var(--color-text-primary);
            font-size: var(--text-base);
            font-family: inherit;
            resize: vertical;
            transition: border-color 0.2s, box-shadow 0.2s;
        }
        
        .composer-textarea:focus {
            outline: none;
            border-color: var(--color-brand);
            box-shadow: 0 0 0 3px var(--color-brand-muted);
        }
        
        .composer-textarea::placeholder {
            color: var(--color-text-muted);
        }
        
        .composer-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: var(--space-3);
        }
        
        .composer-actions {
            display: flex;
            gap: var(--space-2);
        }
        
        .composer-btn {
            display: flex;
            align-items: center;
            gap: var(--space-2);
            padding: var(--space-2) var(--space-3);
            background: var(--color-bg-tertiary);
            border: 1px solid var(--color-border);
            border-radius: var(--radius-md);
            color: var(--color-text-muted);
            cursor: pointer;
            font-size: var(--text-sm);
            transition: 
                all 0.2s var(--ease-spring),
                background 0.2s,
                box-shadow 0.2s;
            position: relative;
            overflow: hidden;
        }
        
        .composer-btn:hover {
            background: var(--color-bg-hover);
            color: var(--color-text-primary);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        
        .composer-btn:hover svg {
            animation: icon-wiggle 0.4s ease-in-out;
        }
        
        @keyframes icon-wiggle {
            0%, 100% { transform: rotate(0); }
            25% { transform: rotate(-8deg); }
            75% { transform: rotate(8deg); }
        }
        
        .composer-btn:active {
            transform: translateY(0) scale(0.95);
            transition-duration: 0.1s;
        }
        
        .composer-btn.active {
            background: var(--color-brand-muted);
            border-color: var(--color-brand);
            color: var(--color-brand);
            animation: btn-activate 0.3s ease-out;
        }
        
        @keyframes btn-activate {
            0% { transform: scale(1); }
            50% { transform: scale(1.08); }
            100% { transform: scale(1); }
        }
        
        .char-count {
            font-size: var(--text-xs);
            color: var(--color-text-muted);
        }
        
        .char-count.warning { color: var(--color-warning); }
        .char-count.error { color: var(--color-error); }
        
        .post-btn {
            padding: var(--space-2) var(--space-5);
            background: var(--cinq-gradient);
            border: none;
            border-radius: var(--radius-lg);
            color: white;
            font-family: var(--font-display, 'Space Grotesk', sans-serif);
            font-weight: 600;
            cursor: pointer;
            transition: 
                transform 0.15s var(--ease-spring),
                box-shadow 0.2s,
                opacity 0.15s;
            box-shadow: 0 2px 8px var(--color-brand-glow);
            position: relative;
            overflow: hidden;
        }
        
        /* Shimmer effect */
        .post-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
            transition: left 0.5s;
        }
        
        .post-btn:hover:not(:disabled)::before {
            left: 100%;
        }
        
        .post-btn:hover:not(:disabled) {
            transform: translateY(-2px) scale(1.02);
            box-shadow: var(--shadow-glow);
        }
        
        .post-btn:active:not(:disabled) {
            transform: translateY(0) scale(0.98);
            box-shadow: 0 1px 4px var(--color-brand-glow);
        }
        
        .post-btn:disabled {
            opacity: 0.4;
            cursor: not-allowed;
            transform: none !important;
        }
        
        /* Image Preview */
        .image-preview {
            position: relative;
            margin-top: var(--space-3);
            border-radius: var(--radius-lg);
            overflow: hidden;
            display: none;
            opacity: 0;
            transform: scale(0.95) translateY(10px);
        }
        
        .image-preview.visible {
            display: block;
            animation: image-preview-in 0.4s var(--ease-spring) forwards;
        }
        
        @keyframes image-preview-in {
            0% { 
                opacity: 0; 
                transform: scale(0.9) translateY(15px); 
            }
            100% { 
                opacity: 1; 
                transform: scale(1) translateY(0); 
            }
        }
        
        .image-preview img {
            width: 100%;
            max-height: 300px;
            object-fit: cover;
        }
        
        .image-preview-remove {
            position: absolute;
            top: var(--space-2);
            right: var(--space-2);
            width: 28px;
            height: 28px;
            background: rgba(0, 0, 0, 0.7);
            border: none;
            border-radius: 50%;
            color: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .image-preview-remove:hover {
            background: var(--color-error);
        }
        
        /* ===== STORIES INDICATOR ===== */
        .stories-bar {
            display: flex;
            gap: var(--space-3);
            padding: var(--space-3) 0;
            margin-bottom: var(--space-4);
            overflow-x: auto;
            scrollbar-width: none;
            -ms-overflow-style: none;
        }
        
        .stories-bar::-webkit-scrollbar {
            display: none;
        }
        
        .story-ring-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: var(--space-1);
            min-width: 72px;
            cursor: pointer;
            text-decoration: none;
            transition: transform 0.2s var(--ease-spring);
        }
        
        .story-ring-item:hover {
            transform: translateY(-2px) scale(1.05);
        }
        
        .story-ring-item:active {
            transform: scale(0.95);
        }
        
        .story-ring-wrapper {
            position: relative;
            width: 64px;
            height: 64px;
            border-radius: 50%;
            padding: 3px;
            background: var(--cinq-gradient);
        }
        
        .story-ring-wrapper.no-story {
            background: var(--color-border);
        }
        
        .story-ring-wrapper.add-story {
            background: transparent;
            border: 2px dashed var(--color-border);
        }
        
        .story-ring-wrapper.add-story:hover {
            border-color: var(--color-brand);
        }
        
        .story-ring-avatar {
            width: 100%;
            height: 100%;
            border-radius: 50%;
            background: var(--color-bg-secondary);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 1.25rem;
            color: var(--color-text-primary);
            overflow: hidden;
            border: 3px solid var(--color-bg-primary);
        }
        
        .story-ring-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .story-ring-add-icon {
            position: absolute;
            bottom: -2px;
            right: -2px;
            width: 22px;
            height: 22px;
            border-radius: 50%;
            background: var(--cinq-gradient);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 2px solid var(--color-bg-primary);
            font-size: 14px;
            font-weight: 700;
        }
        
        .story-ring-label {
            font-size: var(--text-xs);
            color: var(--color-text-secondary);
            max-width: 64px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            text-align: center;
        }
        
        .story-ring-item.own .story-ring-label {
            color: var(--color-text-primary);
            font-weight: 500;
        }
        
        .stories-bar-empty {
            display: flex;
            align-items: center;
            gap: var(--space-2);
            padding: var(--space-3) var(--space-4);
            background: var(--color-bg-secondary);
            border: 1px solid var(--color-border);
            border-radius: var(--radius-xl);
            color: var(--color-text-muted);
            font-size: var(--text-sm);
            cursor: pointer;
            transition: all 0.2s;
            width: 100%;
        }
        
        .stories-bar-empty:hover {
            background: var(--color-brand-muted);
            border-color: var(--color-brand);
            color: var(--color-brand);
        }
        
        .stories-bar-empty svg {
            flex-shrink: 0;
        }
        
        /* Posts */
        .posts-list {
            display: flex;
            flex-direction: column;
            gap: var(--space-4);
        }
        
        .post-card {
            position: relative;
            background: var(--color-bg-secondary);
            border: 1px solid var(--color-border);
            border-radius: var(--radius-xl);
            padding: var(--space-4);
            transition: 
                border-color 0.25s ease,
                transform 0.3s var(--ease-out-expo),
                box-shadow 0.3s ease;
            animation: post-slide-in 0.5s var(--ease-out-expo) backwards;
        }
        
        .posts-list .post-card:nth-child(1) { animation-delay: 0ms; }
        .posts-list .post-card:nth-child(2) { animation-delay: 80ms; }
        .posts-list .post-card:nth-child(3) { animation-delay: 160ms; }
        .posts-list .post-card:nth-child(4) { animation-delay: 240ms; }
        .posts-list .post-card:nth-child(n+5) { animation-delay: 300ms; }
        
        @keyframes post-slide-in {
            0% { 
                opacity: 0; 
                transform: translateY(20px) scale(0.97); 
            }
            100% { 
                opacity: 1; 
                transform: translateY(0) scale(1); 
            }
        }
        
        .post-card:hover {
            border-color: var(--color-border-active);
            transform: translateY(-4px) scale(1.01);
            box-shadow: var(--shadow-lg);
        }
        
        .post-card:active {
            transform: translateY(-1px) scale(0.995);
            transition-duration: 0.1s;
        }
        
        /* New post highlight animation */
        .post-card.new-post {
            animation: new-post-glow 0.8s ease-out;
        }
        
        @keyframes new-post-glow {
            0% { 
                box-shadow: 0 0 0 0 var(--color-brand-glow); 
                transform: scale(0.95);
            }
            50% { 
                box-shadow: 0 0 20px 4px var(--color-brand-glow); 
            }
            100% { 
                box-shadow: var(--shadow-md); 
                transform: scale(1);
            }
        }
        
        /* Highlight gradient at top of card */
        .post-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: var(--space-4);
            right: var(--space-4);
            height: 1px;
            background: linear-gradient(90deg, transparent, var(--glass-highlight), transparent);
            opacity: 0.5;
        }
        
        .post-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: var(--space-3);
            position: relative;
        }
        
        .post-author {
            display: flex;
            align-items: center;
            gap: var(--space-3);
        }
        
        .post-avatar {
            width: 40px;
            height: 40px;
            min-width: 40px;
            min-height: 40px;
            max-width: 40px;
            max-height: 40px;
            border-radius: 50%;
            background: var(--cinq-gradient);
            display: flex;
            align-items: center;
            justify-content: center;
            font-family: var(--font-display, 'Space Grotesk', sans-serif);
            font-size: 1rem;
            color: white;
            font-weight: 600;
            overflow: hidden;
            flex-shrink: 0;
            position: relative;
        }
        
        .post-avatar.own {
            background: linear-gradient(135deg, #22c55e 0%, #16a34a 100%);
        }
        
        .post-avatar img {
            width: 100%;
            height: 100%;
            max-width: 100%;
            max-height: 100%;
            object-fit: cover;
            position: absolute;
            inset: 0;
        }
        
        .post-author-name {
            font-weight: 600;
            font-size: var(--text-sm);
        }
        
        .post-author-name .you-badge {
            font-size: var(--text-xs);
            font-weight: 500;
            color: var(--color-success);
            margin-left: var(--space-2);
        }
        
        .post-time {
            font-size: var(--text-xs);
            color: var(--color-text-muted);
        }
        
        .post-content {
            font-size: var(--text-base);
            line-height: 1.6;
            white-space: pre-wrap;
            word-break: break-word;
        }
        
        .post-image {
            margin-top: var(--space-3);
            border-radius: var(--radius-lg);
            overflow: hidden;
        }
        
        .post-image img {
            width: 100%;
            max-height: 400px;
            object-fit: cover;
            cursor: pointer;
            transition: opacity 0.3s ease;
        }
        
        /* Lazy loading states */
        .post-image img.lazy-image {
            opacity: 0;
        }
        
        .post-image img.lazy-image.loaded {
            opacity: 1;
        }
        
        .post-image img:hover {
            opacity: 0.9;
        }
        
        /* Lazy image container placeholder */
        .lazy-image-container {
            position: relative;
            min-height: 100px;
            background: var(--color-bg-tertiary);
        }
        
        .lazy-image-container::before {
            content: '';
            position: absolute;
            inset: 0;
            background: linear-gradient(
                90deg,
                var(--color-bg-tertiary) 25%,
                var(--color-bg-elevated) 50%,
                var(--color-bg-tertiary) 75%
            );
            background-size: 200% 100%;
            animation: lazy-shimmer 1.5s infinite;
            border-radius: var(--radius-lg);
        }
        
        .lazy-image-container.loaded::before {
            display: none;
        }
        
        @keyframes lazy-shimmer {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }
        
        /* Lazy loading for avatars */
        img.lazy-image {
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        
        img.lazy-image.loaded {
            opacity: 1;
        }
        
        .post-menu-btn {
            background: none;
            border: none;
            color: var(--color-text-muted);
            cursor: pointer;
            padding: var(--space-1);
            font-size: 1.25rem;
        }
        
        .post-menu-btn:hover {
            color: var(--color-text-primary);
        }
        
        .post-menu {
            position: absolute;
            right: 0;
            top: 100%;
            background: var(--color-bg-elevated);
            border: 1px solid var(--color-border);
            border-radius: var(--radius-lg);
            padding: var(--space-1);
            box-shadow: var(--shadow-lg);
            z-index: 50;
            display: none;
        }
        
        .post-menu.open {
            display: block;
        }
        
        .post-menu-item {
            display: flex;
            align-items: center;
            gap: var(--space-2);
            padding: var(--space-2) var(--space-3);
            background: none;
            border: none;
            color: var(--color-error);
            cursor: pointer;
            font-size: var(--text-sm);
            border-radius: var(--radius-md);
            width: 100%;
        }
        
        .post-menu-item:hover {
            background: var(--color-bg-hover);
        }
        
        .empty-state {
            text-align: center;
            padding: var(--space-12) var(--space-4);
            color: var(--color-text-muted);
            animation: empty-fade-in 0.6s ease-out;
        }
        
        @keyframes empty-fade-in {
            0% { opacity: 0; transform: translateY(20px); }
            100% { opacity: 1; transform: translateY(0); }
        }
        
        .empty-state-icon {
            font-size: 4rem;
            margin-bottom: var(--space-4);
            opacity: 0.5;
            animation: empty-icon-float 3s ease-in-out infinite;
        }
        
        @keyframes empty-icon-float {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-8px); }
        }
        
        .empty-state-title {
            font-size: var(--text-xl);
            font-weight: 600;
            color: var(--color-text-primary);
            margin-bottom: var(--space-2);
        }
        
        /* ===== TES 5 TAB ===== */
        .section-title {
            font-family: var(--font-display, 'Space Grotesk', sans-serif);
            font-size: var(--text-xl);
            font-weight: 600;
            letter-spacing: -0.02em;
            margin-bottom: var(--space-5);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .contact-count {
            font-size: var(--text-sm);
            color: var(--color-text-muted);
            font-weight: 500;
            background: var(--color-bg-secondary);
            padding: var(--space-1) var(--space-3);
            border-radius: var(--radius-full);
            border: 1px solid var(--color-border);
        }
        
        .contacts-grid {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: var(--space-3);
            margin-bottom: var(--space-6);
        }
        
        @media (max-width: 400px) {
            .contacts-grid {
                gap: var(--space-2);
            }
        }
        
        .contact-slot {
            aspect-ratio: 1;
            border-radius: var(--radius-2xl);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: 
                transform 0.25s var(--ease-spring), 
                box-shadow 0.3s ease, 
                border-color 0.2s ease,
                background 0.2s ease;
            position: relative;
            animation: contact-appear 0.4s var(--ease-spring) backwards;
        }
        
        .contacts-grid .contact-slot:nth-child(1) { animation-delay: 0ms; }
        .contacts-grid .contact-slot:nth-child(2) { animation-delay: 60ms; }
        .contacts-grid .contact-slot:nth-child(3) { animation-delay: 120ms; }
        .contacts-grid .contact-slot:nth-child(4) { animation-delay: 180ms; }
        .contacts-grid .contact-slot:nth-child(5) { animation-delay: 240ms; }
        
        @keyframes contact-appear {
            0% { opacity: 0; transform: scale(0.8) translateY(10px); }
            100% { opacity: 1; transform: scale(1) translateY(0); }
        }
        
        .contact-slot:hover {
            transform: translateY(-8px) scale(1.05);
            box-shadow: 0 12px 24px rgba(0,0,0,0.15);
        }
        
        .contact-slot:active {
            transform: translateY(-2px) scale(0.96);
            transition-duration: 0.1s;
        }
        
        .contact-slot.filled {
            background: var(--color-bg-secondary);
            border: 1px solid var(--color-border);
            box-shadow: var(--shadow-sm);
        }
        
        .contact-slot.filled:hover {
            border-color: var(--color-border-active);
            box-shadow: var(--shadow-lg);
        }
        
        /* Subtle gradient glow on hover */
        .contact-slot.filled::after {
            content: '';
            position: absolute;
            inset: -1px;
            border-radius: inherit;
            background: var(--cinq-gradient);
            opacity: 0;
            z-index: -1;
            transition: opacity 0.3s;
            mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0);
            mask-composite: exclude;
            padding: 1px;
        }
        
        .contact-slot.filled:hover::after {
            opacity: 0.4;
        }
        
        .contact-slot.empty {
            background: var(--color-bg-tertiary);
            border: 2px dashed var(--color-border);
        }
        
        .contact-slot.empty:hover {
            border-color: var(--color-brand);
            background: var(--color-brand-muted);
        }
        
        .contact-avatar-slot {
            width: 44px;
            height: 44px;
            min-width: 44px;
            min-height: 44px;
            max-width: 44px;
            max-height: 44px;
            border-radius: 50%;
            background: var(--cinq-gradient);
            display: flex;
            align-items: center;
            justify-content: center;
            font-family: var(--font-display, 'Space Grotesk', sans-serif);
            font-size: 1.25rem;
            color: white;
            font-weight: 600;
            transition: transform 0.2s var(--ease-spring);
            box-shadow: 0 2px 8px var(--color-brand-glow);
            overflow: hidden;
            flex-shrink: 0;
            position: relative;
        }
        
        .contact-avatar-slot img {
            width: 100%;
            height: 100%;
            max-width: 100%;
            max-height: 100%;
            object-fit: cover;
            position: absolute;
            inset: 0;
        }
        
        @media (max-width: 400px) {
            .contact-avatar-slot {
                width: 36px;
                height: 36px;
                min-width: 36px;
                min-height: 36px;
                max-width: 36px;
                max-height: 36px;
                font-size: 1rem;
            }
        }
        
        .contact-slot:hover .contact-avatar-slot {
            transform: scale(1.08);
        }
        
        .contact-name {
            font-size: var(--text-xs);
            margin-top: var(--space-1);
            color: var(--color-text-muted);
            text-align: center;
            max-width: 100%;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            padding: 0 4px;
            font-weight: 500;
        }
        
        /* User Status Display */
        .user-status {
            display: inline-flex;
            align-items: center;
            gap: var(--space-1);
            font-size: var(--text-xs);
            color: var(--color-text-muted);
            max-width: 100%;
            overflow: hidden;
        }
        
        .user-status-emoji {
            flex-shrink: 0;
        }
        
        .user-status-text {
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        
        .contact-status {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 2px;
            font-size: 10px;
            color: var(--color-text-muted);
            margin-top: 2px;
            max-width: 100%;
            overflow: hidden;
        }
        
        .contact-status-emoji {
            flex-shrink: 0;
            font-size: 10px;
        }
        
        .contact-status-text {
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            max-width: 60px;
        }
        
        /* Last seen status */
        .contact-last-seen {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 3px;
            font-size: 9px;
            color: var(--color-text-muted);
            margin-top: 2px;
            max-width: 100%;
            overflow: hidden;
        }
        
        .contact-last-seen.online {
            color: #22c55e;
        }
        
        .contact-last-seen-dot {
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background: var(--color-text-muted);
            flex-shrink: 0;
        }
        
        .contact-last-seen.online .contact-last-seen-dot {
            background: #22c55e;
            box-shadow: 0 0 4px rgba(34, 197, 94, 0.5);
            animation: online-pulse 2s ease-in-out infinite;
        }
        
        @keyframes online-pulse {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.7; transform: scale(1.2); }
        }
        
        .contact-last-seen-text {
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        
        /* Chat header last seen */
        .chat-last-seen {
            font-size: var(--text-xs);
            color: var(--color-text-muted);
            display: flex;
            align-items: center;
            gap: 4px;
        }
        
        .chat-last-seen.online {
            color: #22c55e;
        }
        
        .chat-last-seen-dot {
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background: currentColor;
        }
        
        .chat-last-seen.online .chat-last-seen-dot {
            animation: online-pulse 2s ease-in-out infinite;
        }
        
        /* Post author status */
        .post-author-status {
            display: flex;
            align-items: center;
            gap: var(--space-1);
            font-size: var(--text-xs);
            color: var(--color-text-muted);
            margin-top: 2px;
        }
        
        .post-author-status-emoji {
            flex-shrink: 0;
        }
        
        .post-author-status-text {
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            max-width: 150px;
        }
        
        /* Chat header status */
        .chat-contact-status {
            display: flex;
            align-items: center;
            gap: var(--space-1);
            font-size: var(--text-xs);
            color: var(--color-text-muted);
        }
        
        .empty-plus {
            font-size: 1.75rem;
            color: var(--color-text-muted);
            font-weight: 300;
            transition: all 0.2s var(--ease-out-expo);
        }
        
        .contact-slot.empty:hover .empty-plus {
            color: var(--color-brand);
            transform: rotate(90deg) scale(1.1);
        }
        
        .unread-badge {
            position: absolute;
            top: -4px;
            right: -4px;
            min-width: 20px;
            height: 20px;
            background: var(--cinq-gradient);
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: var(--text-xs);
            font-weight: 700;
            color: white;
            padding: 0 5px;
            animation: badge-pop 0.35s var(--ease-spring);
            box-shadow: 0 2px 8px var(--color-brand-glow);
        }
        
        @keyframes badge-pop {
            0% { transform: scale(0); }
            100% { transform: scale(1); }
        }
        
        /* ===== FAVORITE STAR ===== */
        .favorite-btn {
            position: absolute;
            top: 4px;
            left: 4px;
            width: 24px;
            height: 24px;
            border: none;
            background: rgba(0, 0, 0, 0.4);
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            transition: all 0.2s ease;
            z-index: 10;
            padding: 0;
        }
        
        .contact-slot:hover .favorite-btn,
        .contact-slot:focus .favorite-btn {
            opacity: 1;
        }
        
        .favorite-btn.is-favorite {
            opacity: 1;
            background: rgba(255, 193, 7, 0.2);
        }
        
        .favorite-btn:hover {
            transform: scale(1.15);
            background: rgba(255, 193, 7, 0.3);
        }
        
        .favorite-btn:active {
            transform: scale(0.9);
        }
        
        .favorite-star {
            font-size: 14px;
            line-height: 1;
            transition: all 0.2s ease;
        }
        
        .favorite-btn:not(.is-favorite) .favorite-star {
            color: rgba(255, 255, 255, 0.7);
        }
        
        .favorite-btn.is-favorite .favorite-star {
            color: #ffc107;
            text-shadow: 0 0 8px rgba(255, 193, 7, 0.5);
            animation: star-pop 0.4s var(--ease-spring);
        }
        
        @keyframes star-pop {
            0% { transform: scale(0.5) rotate(-45deg); }
            50% { transform: scale(1.3) rotate(10deg); }
            100% { transform: scale(1) rotate(0); }
        }
        
        @media (max-width: 400px) {
            .favorite-btn {
                width: 20px;
                height: 20px;
                top: 2px;
                left: 2px;
            }
            
            .favorite-star {
                font-size: 11px;
            }
        }
        
        /* ===== ARCHIVED SECTION ===== */
        .archived-section {
            margin-top: var(--space-6);
            padding-top: var(--space-6);
            border-top: 1px solid var(--color-border);
        }
        
        .archived-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: var(--space-4);
            cursor: pointer;
            padding: var(--space-2);
            border-radius: var(--radius-lg);
            transition: background 0.2s;
        }
        
        .archived-header:hover {
            background: var(--color-bg-hover);
        }
        
        .archived-title {
            font-size: var(--text-base);
            font-weight: 600;
            color: var(--color-text-muted);
            display: flex;
            align-items: center;
            gap: var(--space-2);
        }
        
        .archived-title svg {
            color: var(--color-text-muted);
        }
        
        .archived-count {
            font-size: var(--text-xs);
            color: var(--color-text-muted);
            background: var(--color-bg-tertiary);
            padding: 2px 8px;
            border-radius: var(--radius-full);
        }
        
        .archived-toggle-icon {
            color: var(--color-text-muted);
            transition: transform 0.3s ease;
        }
        
        .archived-header.expanded .archived-toggle-icon {
            transform: rotate(180deg);
        }
        
        .archived-list {
            display: none;
        }
        
        .archived-list.visible {
            display: block;
            animation: slide-up-fade 0.3s ease-out;
        }
        
        .archived-empty {
            text-align: center;
            padding: var(--space-4);
            color: var(--color-text-muted);
            font-size: var(--text-sm);
        }
        
        .archived-contact-card {
            display: flex;
            align-items: center;
            gap: var(--space-3);
            padding: var(--space-3);
            background: var(--color-bg-secondary);
            border: 1px solid var(--color-border);
            border-radius: var(--radius-lg);
            margin-bottom: var(--space-2);
            transition: all 0.2s ease;
        }
        
        .archived-contact-card:hover {
            border-color: var(--color-border-active);
            background: var(--color-bg-elevated);
        }
        
        .archived-contact-avatar {
            width: 40px;
            height: 40px;
            min-width: 40px;
            border-radius: 50%;
            background: var(--color-bg-tertiary);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            color: var(--color-text-muted);
            overflow: hidden;
            opacity: 0.7;
        }
        
        .archived-contact-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            filter: grayscale(50%);
        }
        
        .archived-contact-info {
            flex: 1;
            min-width: 0;
        }
        
        .archived-contact-name {
            font-weight: 500;
            color: var(--color-text-secondary);
            font-size: var(--text-sm);
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        
        .archived-contact-hint {
            font-size: var(--text-xs);
            color: var(--color-text-muted);
        }
        
        .unarchive-btn {
            padding: var(--space-2) var(--space-3);
            background: var(--color-bg-tertiary);
            border: 1px solid var(--color-border);
            border-radius: var(--radius-md);
            color: var(--color-text-muted);
            font-size: var(--text-xs);
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: var(--space-1);
        }
        
        .unarchive-btn:hover {
            background: var(--color-brand-muted);
            border-color: var(--color-brand);
            color: var(--color-brand);
        }
        
        /* Chat archive button */
        .chat-archive-btn {
            width: 32px;
            height: 32px;
            border-radius: var(--radius-md);
            background: var(--color-bg-tertiary);
            border: 1px solid var(--color-border);
            color: var(--color-text-muted);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }
        
        .chat-archive-btn:hover {
            background: var(--color-warning-muted, rgba(251, 191, 36, 0.1));
            border-color: var(--color-warning, #fbbf24);
            color: var(--color-warning, #fbbf24);
        }
        
        .chat-archive-btn.archived {
            background: var(--color-warning-muted, rgba(251, 191, 36, 0.1));
            border-color: var(--color-warning, #fbbf24);
            color: var(--color-warning, #fbbf24);
        }
        
        /* Chat mute button */
        .chat-mute-btn {
            width: 32px;
            height: 32px;
            border-radius: var(--radius-md);
            background: var(--color-bg-tertiary);
            border: 1px solid var(--color-border);
            color: var(--color-text-muted);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
            position: relative;
        }
        
        .chat-mute-btn:hover {
            background: var(--color-error-muted, rgba(248, 113, 113, 0.1));
            border-color: var(--color-error);
            color: var(--color-error);
        }
        
        .chat-mute-btn.muted {
            background: var(--color-error-muted, rgba(248, 113, 113, 0.1));
            border-color: var(--color-error);
            color: var(--color-error);
        }
        
        .chat-mute-btn .mute-indicator {
            position: absolute;
            top: -4px;
            right: -4px;
            font-size: 10px;
            background: var(--color-error);
            color: white;
            border-radius: 50%;
            width: 14px;
            height: 14px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
        }
        
        /* Contact slot mute indicator */
        .contact-muted-badge {
            position: absolute;
            bottom: 4px;
            right: 4px;
            font-size: 12px;
            background: var(--color-error-muted, rgba(248, 113, 113, 0.15));
            border-radius: 50%;
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 5;
        }
        
        /* Mute Modal */
        .mute-modal {
            max-width: 340px;
        }
        
        .mute-options {
            display: flex;
            flex-direction: column;
            gap: var(--space-2);
            margin: var(--space-4) 0;
        }
        
        .mute-option-btn {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: var(--space-3) var(--space-4);
            background: var(--color-bg-tertiary);
            border: 1px solid var(--color-border);
            border-radius: var(--radius-lg);
            cursor: pointer;
            color: var(--color-text-primary);
            font-size: var(--text-base);
            transition: all 0.2s;
        }
        
        .mute-option-btn:hover {
            background: var(--color-bg-hover);
            border-color: var(--color-border-active);
            transform: translateX(4px);
        }
        
        .mute-option-btn:active {
            transform: translateX(2px) scale(0.98);
        }
        
        .mute-option-btn.selected {
            background: var(--color-brand-muted);
            border-color: var(--color-brand);
            color: var(--color-brand);
        }
        
        .mute-option-btn svg {
            color: var(--color-text-muted);
            transition: color 0.2s;
        }
        
        .mute-option-btn:hover svg,
        .mute-option-btn.selected svg {
            color: var(--color-brand);
        }
        
        .mute-current-status {
            display: flex;
            align-items: center;
            gap: var(--space-2);
            padding: var(--space-3);
            background: var(--color-error-muted, rgba(248, 113, 113, 0.1));
            border: 1px solid var(--color-error);
            border-radius: var(--radius-lg);
            margin-bottom: var(--space-4);
            font-size: var(--text-sm);
            color: var(--color-error);
        }
        
        .mute-current-status.hidden {
            display: none;
        }
        
        /* Chat private note button */
        .chat-note-btn {
            width: 32px;
            height: 32px;
            border-radius: var(--radius-md);
            background: var(--color-bg-tertiary);
            border: 1px solid var(--color-border);
            color: var(--color-text-muted);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
            position: relative;
        }
        
        .chat-note-btn:hover {
            background: var(--color-primary-muted, rgba(139, 92, 246, 0.1));
            border-color: var(--color-primary);
            color: var(--color-primary);
        }
        
        .chat-note-btn.has-note {
            background: var(--color-primary-muted, rgba(139, 92, 246, 0.1));
            border-color: var(--color-primary);
            color: var(--color-primary);
        }
        
        .chat-note-btn .note-indicator {
            position: absolute;
            top: -2px;
            right: -2px;
            width: 8px;
            height: 8px;
            background: var(--color-primary);
            border-radius: 50%;
            display: none;
        }
        
        .chat-note-btn.has-note .note-indicator {
            display: block;
        }
        
        /* Chat export button */
        .chat-export-btn {
            width: 32px;
            height: 32px;
            border-radius: var(--radius-md);
            background: var(--color-bg-tertiary);
            border: 1px solid var(--color-border);
            color: var(--color-text-muted);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }
        
        .chat-export-btn:hover {
            background: var(--color-success-muted, rgba(34, 197, 94, 0.1));
            border-color: var(--color-success, #22c55e);
            color: var(--color-success, #22c55e);
        }
        
        /* Export modal options */
        .export-options {
            display: flex;
            flex-direction: column;
            gap: var(--space-3);
            margin-top: var(--space-4);
        }
        
        .export-option-btn {
            display: flex;
            align-items: center;
            gap: var(--space-3);
            padding: var(--space-4);
            border-radius: var(--radius-lg);
            background: var(--color-bg-tertiary);
            border: 1px solid var(--color-border);
            color: var(--color-text);
            cursor: pointer;
            transition: all 0.2s;
            text-align: left;
        }
        
        .export-option-btn:hover {
            background: var(--color-bg-hover);
            border-color: var(--color-brand);
            transform: translateY(-2px);
        }
        
        .export-option-btn svg {
            width: 24px;
            height: 24px;
            color: var(--color-brand);
            flex-shrink: 0;
        }
        
        .export-option-info {
            flex: 1;
        }
        
        .export-option-title {
            font-weight: 600;
            font-size: var(--text-base);
            margin-bottom: var(--space-1);
        }
        
        .export-option-desc {
            font-size: var(--text-sm);
            color: var(--color-text-muted);
        }
        
        /* Private note modal content */
        .private-note-textarea {
            width: 100%;
            min-height: 120px;
            padding: var(--space-3);
            border-radius: var(--radius-md);
            border: 1px solid var(--color-border);
            background: var(--color-bg-tertiary);
            color: var(--color-text);
            font-family: inherit;
            font-size: var(--text-base);
            resize: vertical;
            transition: border-color 0.2s, box-shadow 0.2s;
        }
        
        .private-note-textarea:focus {
            outline: none;
            border-color: var(--color-primary);
            box-shadow: 0 0 0 3px var(--color-primary-muted, rgba(139, 92, 246, 0.2));
        }
        
        .private-note-textarea::placeholder {
            color: var(--color-text-muted);
        }
        
        .private-note-hint {
            font-size: var(--text-sm);
            color: var(--color-text-muted);
            margin-top: var(--space-2);
            display: flex;
            align-items: center;
            gap: var(--space-2);
        }
        
        .private-note-hint svg {
            width: 14px;
            height: 14px;
            flex-shrink: 0;
        }
        
        /* ===== SUGGESTIONS SECTION ===== */
        .suggestions-section {
            margin-top: var(--space-6);
            padding-top: var(--space-6);
            border-top: 1px solid var(--color-border);
        }
        
        .suggestions-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: var(--space-4);
        }
        
        .suggestions-title {
            font-size: var(--text-base);
            font-weight: 600;
            color: var(--color-text);
            display: flex;
            align-items: center;
            gap: var(--space-2);
        }
        
        .suggestions-title svg {
            color: var(--color-brand);
        }
        
        .suggestions-empty {
            text-align: center;
            padding: var(--space-6);
            color: var(--color-text-muted);
            font-size: var(--text-sm);
        }
        
        .suggestion-card {
            display: flex;
            align-items: center;
            gap: var(--space-3);
            padding: var(--space-4);
            background: var(--color-bg-secondary);
            border: 1px solid var(--color-border);
            border-radius: var(--radius-xl);
            margin-bottom: var(--space-3);
            transition: all 0.3s ease, transform 0.3s ease, opacity 0.3s ease;
            animation: slide-up-fade 0.4s ease-out backwards;
        }
        
        .suggestion-card:hover {
            border-color: var(--color-border-active);
            box-shadow: var(--shadow-md);
        }
        
        .suggestion-card:nth-child(1) { animation-delay: 0ms; }
        .suggestion-card:nth-child(2) { animation-delay: 60ms; }
        .suggestion-card:nth-child(3) { animation-delay: 120ms; }
        
        .suggestion-avatar {
            width: 48px;
            height: 48px;
            min-width: 48px;
            border-radius: var(--radius-full);
            background: var(--color-bg-tertiary);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            color: var(--color-text);
            font-size: 1.1rem;
            overflow: hidden;
        }
        
        .suggestion-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .suggestion-info {
            flex: 1;
            min-width: 0;
        }
        
        .suggestion-name {
            font-weight: 600;
            color: var(--color-text);
            font-size: var(--text-sm);
            margin-bottom: 2px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        
        .suggestion-mutual {
            font-size: var(--text-xs);
            color: var(--color-text-muted);
            display: flex;
            align-items: center;
            gap: var(--space-1);
        }
        
        .suggestion-mutual-avatars {
            display: flex;
            margin-right: var(--space-1);
        }
        
        .suggestion-mutual-avatars .mini-avatar {
            width: 18px;
            height: 18px;
            border-radius: var(--radius-full);
            background: var(--color-bg-tertiary);
            border: 2px solid var(--color-bg-secondary);
            margin-left: -6px;
            font-size: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            overflow: hidden;
        }
        
        .suggestion-mutual-avatars .mini-avatar:first-child {
            margin-left: 0;
        }
        
        .suggestion-mutual-avatars .mini-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .suggestion-actions {
            display: flex;
            gap: var(--space-2);
        }
        
        .suggestion-btn {
            width: 36px;
            height: 36px;
            border-radius: var(--radius-full);
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
        }
        
        .suggestion-btn.add {
            background: var(--cinq-gradient);
            color: white;
        }
        
        .suggestion-btn.add:hover {
            transform: scale(1.1);
            box-shadow: 0 4px 12px var(--color-brand-glow);
        }
        
        .suggestion-btn.ignore {
            background: var(--color-bg-tertiary);
            color: var(--color-text-muted);
        }
        
        .suggestion-btn.ignore:hover {
            background: var(--color-danger);
            color: white;
        }
        
        .suggestion-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        @media (max-width: 400px) {
            .suggestion-avatar {
                width: 40px;
                height: 40px;
                min-width: 40px;
            }
            
            .suggestion-btn {
                width: 32px;
                height: 32px;
            }
        }
        
        .action-btn {
            display: flex;
            align-items: center;
            gap: var(--space-4);
            padding: var(--space-4) var(--space-5);
            background: var(--color-bg-secondary);
            border: 1px solid var(--color-border);
            border-radius: var(--radius-xl);
            cursor: pointer;
            transition: 
                all 0.2s var(--ease-spring),
                background 0.2s;
            width: 100%;
            text-align: left;
            color: inherit;
            text-decoration: none;
            font-family: var(--font-display, 'Space Grotesk', sans-serif);
            position: relative;
            overflow: hidden;
        }
        
        /* Subtle gradient border on hover */
        .action-btn::after {
            content: '';
            position: absolute;
            inset: -1px;
            border-radius: inherit;
            background: var(--cinq-gradient);
            opacity: 0;
            z-index: -1;
            transition: opacity 0.3s;
            mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0);
            mask-composite: exclude;
            padding: 1px;
        }
        
        .action-btn:hover {
            background: var(--color-bg-tertiary);
            border-color: var(--color-border-active);
            transform: translateX(6px);
        }
        
        .action-btn:hover::after {
            opacity: 0.5;
        }
        
        .action-btn:active {
            transform: translateX(3px) scale(0.99);
        }
        
        .action-icon {
            font-size: 1.5rem;
        }
        
        .action-title {
            font-weight: 600;
            margin-bottom: 2px;
        }
        
        .action-subtitle {
            font-size: var(--text-xs);
            color: var(--color-text-muted);
        }
        
        /* ===== PROFIL TAB ===== */
        .profile-header {
            text-align: center;
            margin-bottom: var(--space-8);
        }
        
        /* AVATAR BUG FIX: Strict size constraints to prevent giant avatar on desktop */
        .profile-avatar {
            width: 100px;
            height: 100px;
            min-width: 100px;
            min-height: 100px;
            max-width: 100px;
            max-height: 100px;
            border-radius: 50%;
            background: var(--cinq-gradient);
            display: flex;
            align-items: center;
            justify-content: center;
            font-family: var(--font-display, 'Space Grotesk', sans-serif);
            font-size: 2.5rem;
            color: white;
            font-weight: 600;
            margin: 0 auto var(--space-4);
            cursor: pointer;
            position: relative;
            overflow: hidden;
            transition: transform 0.2s var(--ease-spring), box-shadow 0.2s;
            box-shadow: var(--shadow-glow-sm);
            flex-shrink: 0;
        }
        
        .profile-avatar:hover {
            transform: scale(1.05);
            box-shadow: var(--shadow-glow);
        }
        
        .profile-avatar:active {
            transform: scale(0.98);
        }
        
        /* CRITICAL: Image must stay contained within avatar bounds */
        .profile-avatar img {
            width: 100%;
            height: 100%;
            max-width: 100%;
            max-height: 100%;
            object-fit: cover;
            position: absolute;
            inset: 0;
        }
        
        .profile-avatar-overlay {
            position: absolute;
            inset: 0;
            background: rgba(0,0,0,0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            transition: opacity 0.2s;
            font-size: 1.5rem;
        }
        
        .profile-avatar:hover .profile-avatar-overlay {
            opacity: 1;
        }
        
        .profile-name {
            font-family: var(--font-display, 'Space Grotesk', sans-serif);
            font-size: var(--text-2xl);
            font-weight: 700;
            letter-spacing: -0.02em;
            margin-bottom: var(--space-1);
        }
        
        .profile-bio {
            color: var(--color-text-muted);
            font-size: var(--text-sm);
        }
        
        .settings-card {
            background: var(--color-bg-secondary);
            border: 1px solid var(--color-border);
            border-radius: var(--radius-xl);
            padding: var(--space-5);
            margin-bottom: var(--space-4);
        }
        
        .settings-card-header {
            display: flex;
            align-items: center;
            gap: var(--space-3);
            margin-bottom: var(--space-4);
            font-weight: 600;
        }
        
        .settings-card-header span:first-child {
            font-size: 1.25rem;
        }
        
        .settings-field {
            margin-bottom: var(--space-4);
        }
        
        .settings-field:last-child {
            margin-bottom: 0;
        }
        
        .settings-label {
            display: block;
            font-size: var(--text-xs);
            color: var(--color-text-muted);
            margin-bottom: var(--space-2);
            font-weight: 500;
        }
        
        .settings-input {
            width: 100%;
            padding: var(--space-3) var(--space-4);
            background: var(--color-bg-tertiary);
            border: 1px solid var(--color-border);
            border-radius: var(--radius-lg);
            color: var(--color-text-primary);
            font-size: var(--text-base);
            transition: all 0.15s;
        }
        
        .settings-input:focus {
            outline: none;
            border-color: var(--color-brand);
            box-shadow: 0 0 0 3px var(--color-brand-muted);
        }
        
        .settings-input::placeholder {
            color: var(--color-text-muted);
        }
        
        .save-btn {
            width: 100%;
            padding: var(--space-3) var(--space-5);
            background: var(--cinq-gradient);
            color: white;
            border: none;
            border-radius: var(--radius-lg);
            cursor: pointer;
            font-family: var(--font-display, 'Space Grotesk', sans-serif);
            font-weight: 600;
            transition: 
                transform 0.15s var(--ease-spring),
                box-shadow 0.2s;
            box-shadow: 0 2px 8px var(--color-brand-glow);
            position: relative;
            overflow: hidden;
        }
        
        .save-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
            transition: left 0.5s;
        }
        
        .save-btn:hover:not(:disabled)::before {
            left: 100%;
        }
        
        .save-btn:hover:not(:disabled) {
            transform: translateY(-2px) scale(1.01);
            box-shadow: var(--shadow-glow);
        }
        
        .save-btn:active:not(:disabled) {
            transform: translateY(0) scale(0.98);
        }
        
        .save-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .settings-btn {
            display: flex;
            align-items: center;
            gap: var(--space-3);
            padding: var(--space-3) var(--space-4);
            background: var(--color-bg-tertiary);
            border: 1px solid var(--color-border);
            border-radius: var(--radius-lg);
            cursor: pointer;
            color: var(--color-text-primary);
            font-size: var(--text-sm);
            transition: 
                all 0.15s var(--ease-spring),
                background 0.2s;
            width: 100%;
            text-align: left;
            margin-bottom: var(--space-3);
        }
        
        .settings-btn:last-child {
            margin-bottom: 0;
        }
        
        .settings-btn:hover {
            background: var(--color-bg-elevated);
            border-color: var(--color-border-active);
            transform: translateX(4px);
        }
        
        .settings-btn:active {
            transform: translateX(2px) scale(0.99);
        }
        
        .settings-btn-danger {
            background: var(--color-error-muted);
            border-color: var(--color-error);
            color: var(--color-error);
        }
        
        .settings-btn-danger:hover {
            background: rgba(248, 113, 113, 0.18);
        }
        
        .settings-btn-info {
            flex: 1;
        }
        
        .settings-btn-title {
            font-weight: 600;
            display: block;
        }
        
        .settings-btn-subtitle {
            font-size: var(--text-xs);
            color: var(--color-text-muted);
            margin-top: 2px;
        }
        
        .settings-btn-danger .settings-btn-subtitle {
            color: inherit;
            opacity: 0.8;
        }
        
        /* ===== CHAT PANEL ===== */
        .chat-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(4px);
            -webkit-backdrop-filter: blur(4px);
            opacity: 0;
            visibility: hidden;
            transition: all 0.25s;
            z-index: calc(var(--z-modal) - 1);
        }
        
        .chat-overlay.open {
            opacity: 1;
            visibility: visible;
        }
        
        .chat-panel {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: var(--color-bg-primary);
            border-top: 1px solid var(--color-border);
            transform: translateY(100%);
            transition: transform 0.4s var(--ease-out-expo);
            max-height: 85vh;
            max-height: 85dvh;
            display: flex;
            flex-direction: column;
            border-radius: var(--radius-2xl) var(--radius-2xl) 0 0;
            z-index: var(--z-modal);
            box-shadow: 0 -10px 40px rgba(0, 0, 0, 0.5);
        }
        
        .chat-panel.open {
            transform: translateY(0);
            animation: chat-slide-up 0.45s var(--ease-out-expo);
        }
        
        @keyframes chat-slide-up {
            0% { 
                transform: translateY(100%); 
            }
            60% { 
                transform: translateY(-3%); 
            }
            100% { 
                transform: translateY(0); 
            }
        }
        
        .chat-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: var(--space-5);
            border-bottom: 1px solid var(--color-border);
            background: var(--color-bg-secondary);
            border-radius: var(--radius-2xl) var(--radius-2xl) 0 0;
        }
        
        .chat-contact-info {
            display: flex;
            align-items: center;
            gap: var(--space-3);
        }
        
        .chat-contact-avatar {
            width: 36px;
            height: 36px;
            min-width: 36px;
            min-height: 36px;
            max-width: 36px;
            max-height: 36px;
            border-radius: 50%;
            background: var(--cinq-gradient);
            display: flex;
            align-items: center;
            justify-content: center;
            font-family: var(--font-display, 'Space Grotesk', sans-serif);
            font-size: var(--text-base);
            color: white;
            font-weight: 600;
            box-shadow: 0 2px 8px var(--color-brand-glow);
            overflow: hidden;
            flex-shrink: 0;
            position: relative;
        }
        
        .chat-contact-avatar img {
            width: 100%;
            height: 100%;
            max-width: 100%;
            max-height: 100%;
            object-fit: cover;
            position: absolute;
            inset: 0;
        }
        
        .chat-contact-name {
            font-weight: 600;
        }
        
        .chat-close {
            background: var(--color-bg-tertiary);
            border: 1px solid var(--color-border);
            font-size: 1.25rem;
            cursor: pointer;
            color: var(--color-text-muted);
            transition: all 0.2s;
            padding: var(--space-2);
            border-radius: var(--radius-lg);
            width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .chat-close:hover {
            color: var(--color-text-primary);
            background: var(--color-bg-elevated);
            transform: rotate(90deg);
        }
        
        .chat-messages {
            flex: 1;
            overflow-y: auto;
            overflow-x: hidden;
            padding: var(--space-5);
            padding-bottom: var(--space-3);
            min-height: 280px;
            display: flex;
            flex-direction: column;
            gap: var(--space-2);
            scroll-behavior: smooth;
            overscroll-behavior: contain;
            -webkit-overflow-scrolling: touch;
        }
        
        /* Custom scrollbar for chat */
        .chat-messages::-webkit-scrollbar {
            width: 6px;
        }
        
        .chat-messages::-webkit-scrollbar-track {
            background: transparent;
        }
        
        .chat-messages::-webkit-scrollbar-thumb {
            background: var(--color-border);
            border-radius: 3px;
        }
        
        .chat-messages::-webkit-scrollbar-thumb:hover {
            background: var(--color-text-muted);
        }
        
        /* Empty state */
        .chat-messages:not(:has(.chat-message)):not(:has(.chat-date-separator))::before {
            content: 'Premier message ? À toi de jouer 👋';
            text-align: center;
            color: var(--color-text-muted);
            margin: auto;
            padding: var(--space-8);
        }
        
        /* Fallback for browsers without :has() */
        .chat-messages-empty {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 100%;
            color: var(--color-text-muted);
            text-align: center;
            padding: var(--space-8);
        }
        
        .chat-message {
            max-width: 75%;
            padding: var(--space-3) var(--space-4);
            padding-bottom: var(--space-2);
            border-radius: var(--radius-xl);
            animation: message-in 0.35s cubic-bezier(0.34, 1.56, 0.64, 1) backwards;
            word-wrap: break-word;
            font-size: var(--text-base);
            line-height: 1.5;
            transition: transform 0.15s ease-out, box-shadow 0.2s ease;
            position: relative;
        }
        
        .chat-message-content {
            margin-bottom: var(--space-1);
        }
        
        .chat-message-meta {
            display: flex;
            align-items: center;
            justify-content: flex-end;
            gap: var(--space-2);
            font-size: 10px;
            opacity: 0.7;
            margin-top: var(--space-1);
        }
        
        .chat-message.received .chat-message-meta {
            justify-content: flex-start;
        }
        
        .chat-message-time {
            font-weight: 500;
        }
        
        /* Read receipts - WhatsApp style checkmarks */
        .chat-read-receipt {
            display: inline-flex;
            align-items: center;
            gap: 1px;
        }
        
        .chat-read-receipt svg {
            width: 14px;
            height: 14px;
        }
        
        .chat-read-receipt.sent svg {
            opacity: 0.7;
        }
        
        .chat-read-receipt.delivered svg {
            opacity: 0.7;
        }
        
        .chat-read-receipt.read svg {
            color: #53bdeb;
        }
        
        @keyframes message-in {
            0% { 
                opacity: 0; 
                transform: translateY(12px) scale(0.95); 
            }
            100% { 
                opacity: 1; 
                transform: translateY(0) scale(1); 
            }
        }
        
        .chat-message:hover {
            transform: scale(1.01);
        }
        
        .chat-message:active {
            transform: scale(0.99);
        }
        
        .chat-message.sent {
            background: var(--cinq-gradient);
            color: white;
            margin-left: auto;
            border-bottom-right-radius: 4px;
            box-shadow: 0 2px 12px var(--color-brand-glow);
            animation-name: message-in-sent;
        }
        
        /* Bubble tail for sent messages */
        .chat-message.sent::after {
            content: '';
            position: absolute;
            right: -6px;
            bottom: 0;
            width: 12px;
            height: 12px;
            background: linear-gradient(135deg, transparent 50%, #ff6b4a 50%);
            border-bottom-left-radius: 4px;
        }
        
        @keyframes message-in-sent {
            0% { 
                opacity: 0; 
                transform: translateX(16px) scale(0.95); 
            }
            100% { 
                opacity: 1; 
                transform: translateX(0) scale(1); 
            }
        }
        
        .chat-message.sent:hover {
            box-shadow: 0 4px 20px var(--color-brand-glow);
        }
        
        .chat-message.sent .chat-message-meta {
            color: rgba(255, 255, 255, 0.85);
        }
        
        .chat-message.received {
            background: var(--color-bg-elevated);
            border: 1px solid var(--color-border);
            border-bottom-left-radius: 4px;
            animation-name: message-in-received;
        }
        
        /* Bubble tail for received messages */
        .chat-message.received::after {
            content: '';
            position: absolute;
            left: -6px;
            bottom: 0;
            width: 12px;
            height: 12px;
            background: linear-gradient(-135deg, transparent 50%, var(--color-bg-elevated) 50%);
            border-bottom-right-radius: 4px;
        }
        
        @keyframes message-in-received {
            0% { 
                opacity: 0; 
                transform: translateX(-16px) scale(0.95); 
            }
            100% { 
                opacity: 1; 
                transform: translateX(0) scale(1); 
            }
        }
        
        .chat-message.ping {
            text-align: center;
            max-width: 100%;
            background: none;
            font-size: 2.75rem;
            animation: ping-bounce 0.6s var(--ease-spring);
            padding: var(--space-2);
        }
        
        .chat-message.ping::after {
            display: none;
        }
        
        @keyframes ping-bounce {
            0% { transform: scale(0.5) rotate(-10deg); opacity: 0; }
            40% { transform: scale(1.3) rotate(5deg); opacity: 1; }
            60% { transform: scale(0.95) rotate(-3deg); }
            80% { transform: scale(1.1) rotate(2deg); }
            100% { transform: scale(1) rotate(0); }
        }
        
        /* ===== TYPING INDICATOR ===== */
        .typing-indicator {
            display: none;
            align-items: center;
            gap: 6px;
            padding: var(--space-2) var(--space-3);
            background: var(--color-bg-elevated);
            border: 1px solid var(--color-border);
            border-radius: var(--radius-xl);
            border-bottom-left-radius: 4px;
            width: fit-content;
            max-width: 200px;
            animation: typing-appear 0.3s ease-out;
            position: relative;
            margin-top: var(--space-1);
        }
        
        .typing-indicator.visible {
            display: flex;
        }
        
        @keyframes typing-appear {
            0% {
                opacity: 0;
                transform: translateX(-10px) scale(0.9);
            }
            100% {
                opacity: 1;
                transform: translateX(0) scale(1);
            }
        }
        
        .typing-indicator::after {
            content: '';
            position: absolute;
            left: -6px;
            bottom: 0;
            width: 12px;
            height: 12px;
            background: linear-gradient(-135deg, transparent 50%, var(--color-bg-elevated) 50%);
            border-bottom-right-radius: 4px;
        }
        
        .typing-indicator-label {
            font-size: var(--text-xs);
            color: var(--color-text-muted);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 120px;
        }
        
        .typing-dots {
            display: flex;
            align-items: center;
            gap: 3px;
        }
        
        .typing-dot {
            width: 6px;
            height: 6px;
            background: var(--color-text-muted);
            border-radius: 50%;
            animation: typing-bounce 1.4s infinite ease-in-out both;
        }
        
        .typing-dot:nth-child(1) { animation-delay: 0s; }
        .typing-dot:nth-child(2) { animation-delay: 0.16s; }
        .typing-dot:nth-child(3) { animation-delay: 0.32s; }
        
        @keyframes typing-bounce {
            0%, 60%, 100% { 
                transform: translateY(0);
                opacity: 0.4;
            }
            30% { 
                transform: translateY(-4px);
                opacity: 1;
            }
        }
        
        /* ===== DATE SEPARATOR ===== */
        .chat-date-separator {
            text-align: center;
            padding: var(--space-3) 0;
            position: relative;
        }
        
        .chat-date-separator::before {
            content: '';
            position: absolute;
            left: 0;
            right: 0;
            top: 50%;
            height: 1px;
            background: var(--color-border);
        }
        
        .chat-date-separator span {
            position: relative;
            background: var(--color-bg-primary);
            padding: var(--space-1) var(--space-3);
            font-size: 11px;
            color: var(--color-text-muted);
            font-weight: 500;
            border-radius: var(--radius-full);
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }
        
        /* ===== REPLY PREVIEW (above input) ===== */
        .reply-preview {
            padding: var(--space-2) var(--space-4);
            background: var(--color-bg-tertiary);
            border-top: 1px solid var(--color-border);
            animation: slideDown 0.2s ease-out;
        }
        
        .reply-preview.hidden {
            display: none;
        }
        
        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-8px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .reply-preview-content {
            display: flex;
            align-items: center;
            gap: var(--space-3);
            padding: var(--space-2) var(--space-3);
            background: var(--color-bg-secondary);
            border-radius: var(--radius-lg);
        }
        
        .reply-preview-bar {
            width: 3px;
            height: 32px;
            background: var(--color-brand);
            border-radius: var(--radius-full);
            flex-shrink: 0;
        }
        
        .reply-preview-text {
            flex: 1;
            min-width: 0;
            display: flex;
            flex-direction: column;
            gap: 2px;
        }
        
        .reply-preview-author {
            font-size: var(--text-xs);
            font-weight: 600;
            color: var(--color-brand);
        }
        
        .reply-preview-message {
            font-size: var(--text-xs);
            color: var(--color-text-muted);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .reply-preview-close {
            width: 28px;
            height: 28px;
            border: none;
            background: transparent;
            color: var(--color-text-muted);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: var(--radius-md);
            transition: all 0.2s;
            flex-shrink: 0;
        }
        
        .reply-preview-close:hover {
            background: var(--color-bg-elevated);
            color: var(--color-text);
        }
        
        .reply-preview-close svg {
            width: 16px;
            height: 16px;
        }
        
        /* ===== REPLY QUOTE (in message) ===== */
        .reply-quote {
            display: flex;
            flex-direction: column;
            gap: 2px;
            padding: var(--space-2) var(--space-3);
            margin-bottom: var(--space-2);
            background: rgba(0, 0, 0, 0.15);
            border-left: 3px solid var(--color-brand);
            border-radius: 0 var(--radius-md) var(--radius-md) 0;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .reply-quote:hover {
            background: rgba(0, 0, 0, 0.25);
        }
        
        .reply-quote-author {
            font-size: var(--text-xs);
            font-weight: 600;
            color: var(--color-brand-light, #a78bfa);
        }
        
        .reply-quote-text {
            font-size: var(--text-xs);
            color: var(--color-text-muted);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 200px;
        }
        
        .chat-message.sent .reply-quote {
            border-left: none;
            border-right: 3px solid var(--color-brand);
            border-radius: var(--radius-md) 0 0 var(--radius-md);
        }
        
        /* Message highlight flash when scrolling to quoted message */
        .chat-message.highlight-flash {
            animation: highlightPulse 1.5s ease-out;
        }
        
        @keyframes highlightPulse {
            0%, 100% {
                background: transparent;
            }
            20%, 50% {
                background: rgba(99, 102, 241, 0.2);
            }
        }
        
        .chat-input-area {
            display: flex;
            gap: var(--space-2);
            padding: var(--space-5);
            border-top: 1px solid var(--color-border);
            padding-bottom: max(var(--space-5), env(safe-area-inset-bottom));
            background: var(--color-bg-secondary);
        }
        
        .chat-input {
            flex: 1;
            padding: var(--space-3) var(--space-4);
            background: var(--color-bg-tertiary);
            border: 1px solid var(--color-border);
            border-radius: var(--radius-full);
            color: var(--color-text-primary);
            font-size: var(--text-base);
            transition: all 0.15s;
        }
        
        .chat-input:focus {
            outline: none;
            border-color: var(--color-brand);
            box-shadow: 0 0 0 3px var(--color-brand-muted);
        }
        
        .chat-char-count {
            font-size: var(--text-xs);
            color: var(--color-text-muted);
            align-self: center;
            min-width: 45px;
            text-align: center;
        }
        
        .chat-send {
            padding: var(--space-3) var(--space-4);
            background: var(--cinq-gradient);
            border: none;
            border-radius: var(--radius-full);
            color: white;
            cursor: pointer;
            font-size: 1.125rem;
            transition: 
                transform 0.2s var(--ease-spring),
                box-shadow 0.25s ease;
            box-shadow: 0 2px 8px var(--color-brand-glow);
            position: relative;
            overflow: hidden;
        }
        
        .chat-send::after {
            content: '';
            position: absolute;
            inset: 0;
            background: rgba(255,255,255,0.3);
            transform: translateX(-100%);
            transition: transform 0.3s ease;
        }
        
        .chat-send:hover:not(:disabled)::after {
            transform: translateX(100%);
        }
        
        .chat-send:hover:not(:disabled) {
            transform: scale(1.1) rotate(8deg);
            box-shadow: var(--shadow-glow-sm), 0 0 20px var(--color-brand-glow);
        }
        
        .chat-send:active:not(:disabled) {
            transform: scale(0.9) rotate(-5deg);
            transition-duration: 0.1s;
        }
        
        .chat-send.sending {
            animation: send-pulse 0.5s ease-out;
        }
        
        @keyframes send-pulse {
            0% { transform: scale(1); }
            30% { transform: scale(0.85) rotate(-10deg); }
            60% { transform: scale(1.15) rotate(5deg); }
            100% { transform: scale(1) rotate(0); }
        }
        
        .chat-send:disabled {
            opacity: 0.4;
            cursor: not-allowed;
        }
        
        /* ===== QUICK REPLIES ===== */
        .quick-replies {
            display: none;
            gap: var(--space-2);
            padding: var(--space-3) var(--space-4);
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
            scrollbar-width: none;
            background: var(--color-bg-secondary);
            border-top: 1px solid var(--color-border);
        }
        
        .quick-replies::-webkit-scrollbar {
            display: none;
        }
        
        .quick-replies.visible {
            display: flex;
            animation: quick-replies-in 0.3s ease-out;
        }
        
        @keyframes quick-replies-in {
            0% {
                opacity: 0;
                transform: translateY(10px);
            }
            100% {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .quick-reply-btn {
            flex-shrink: 0;
            padding: var(--space-2) var(--space-4);
            background: var(--color-bg-tertiary);
            border: 1px solid var(--color-border);
            border-radius: var(--radius-full);
            color: var(--color-text-primary);
            font-size: var(--text-sm);
            font-weight: 500;
            cursor: pointer;
            white-space: nowrap;
            transition: all 0.2s ease;
        }
        
        .quick-reply-btn:hover {
            background: var(--color-brand-muted);
            border-color: var(--color-brand);
            transform: translateY(-2px);
        }
        
        .quick-reply-btn:active {
            transform: scale(0.95);
        }
        
        .quick-reply-btn.emoji-only {
            padding: var(--space-2) var(--space-3);
            font-size: 1.2rem;
        }
        
        .quick-replies-toggle {
            flex-shrink: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 28px;
            height: 28px;
            background: var(--color-bg-tertiary);
            border: 1px solid var(--color-border);
            border-radius: var(--radius-full);
            color: var(--color-text-muted);
            cursor: pointer;
            font-size: var(--text-xs);
            transition: all 0.2s ease;
        }
        
        .quick-replies-toggle:hover {
            background: var(--color-brand-muted);
            border-color: var(--color-brand);
            color: var(--color-brand);
        }
        
        .quick-replies-toggle svg {
            transition: transform 0.2s ease;
        }
        
        .quick-replies-toggle.expanded svg {
            transform: rotate(180deg);
        }
        
        .ping-btn {
            padding: var(--space-3);
            background: var(--color-bg-tertiary);
            border: 1px solid var(--color-border);
            border-radius: var(--radius-full);
            cursor: pointer;
            font-size: 1.25rem;
            transition: 
                all 0.2s var(--ease-spring),
                background 0.2s;
            position: relative;
        }
        
        .ping-btn::before {
            content: '';
            position: absolute;
            inset: -4px;
            border-radius: 50%;
            background: var(--cinq-gradient);
            opacity: 0;
            z-index: -1;
            transition: opacity 0.3s ease, transform 0.3s ease;
            transform: scale(0.8);
        }
        
        .ping-btn:hover {
            background: var(--color-brand-muted);
            border-color: var(--color-brand);
            transform: scale(1.15) rotate(-8deg);
        }
        
        .ping-btn:hover::before {
            opacity: 0.3;
            transform: scale(1);
            animation: ping-glow 1s ease-in-out infinite;
        }
        
        @keyframes ping-glow {
            0%, 100% { opacity: 0.2; transform: scale(1); }
            50% { opacity: 0.4; transform: scale(1.1); }
        }
        
        .ping-btn:active {
            transform: scale(0.85);
            transition-duration: 0.1s;
        }
        
        .ping-btn.pinged {
            animation: ping-burst 0.6s var(--ease-spring);
        }
        
        @keyframes ping-burst {
            0% { transform: scale(1); }
            20% { transform: scale(0.8); }
            50% { transform: scale(1.3) rotate(15deg); }
            70% { transform: scale(0.95) rotate(-5deg); }
            100% { transform: scale(1) rotate(0); }
        }
        
        /* ===== VOICE MESSAGE BUTTON ===== */
        .voice-btn {
            padding: var(--space-3);
            background: var(--color-bg-tertiary);
            border: 1px solid var(--color-border);
            border-radius: var(--radius-full);
            cursor: pointer;
            font-size: 1.25rem;
            transition: all 0.2s var(--ease-spring);
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--color-text-muted);
        }
        
        .voice-btn:hover {
            background: var(--color-bg-hover);
            border-color: var(--color-border-active);
            color: var(--color-text-primary);
            transform: scale(1.1);
        }
        
        .voice-btn:active {
            transform: scale(0.95);
        }
        
        .voice-btn.recording {
            background: var(--color-error);
            border-color: var(--color-error);
            color: white;
            animation: voice-pulse 1s ease-in-out infinite;
        }
        
        @keyframes voice-pulse {
            0%, 100% { 
                transform: scale(1);
                box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.4);
            }
            50% { 
                transform: scale(1.1);
                box-shadow: 0 0 0 10px rgba(239, 68, 68, 0);
            }
        }
        
        .voice-btn.recording svg {
            animation: voice-icon-pulse 0.5s ease-in-out infinite alternate;
        }
        
        @keyframes voice-icon-pulse {
            0% { transform: scale(1); }
            100% { transform: scale(1.2); }
        }
        
        /* Recording timer */
        .voice-timer {
            position: absolute;
            bottom: -20px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 10px;
            font-weight: 600;
            color: var(--color-error);
            white-space: nowrap;
            opacity: 0;
            transition: opacity 0.2s;
        }
        
        .voice-btn.recording .voice-timer {
            opacity: 1;
        }
        
        /* Voice cancel hint */
        .voice-cancel-hint {
            position: fixed;
            bottom: 120px;
            left: 50%;
            transform: translateX(-50%);
            background: var(--color-bg-elevated);
            border: 1px solid var(--color-border);
            padding: var(--space-2) var(--space-4);
            border-radius: var(--radius-full);
            font-size: var(--text-xs);
            color: var(--color-text-muted);
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s var(--ease-spring);
            z-index: calc(var(--z-modal) + 1);
        }
        
        .voice-cancel-hint.visible {
            opacity: 1;
            visibility: visible;
        }
        
        /* ===== VOICE MESSAGE PLAYER ===== */
        .voice-message {
            display: flex;
            align-items: center;
            gap: var(--space-2);
            min-width: 200px;
            max-width: 280px;
        }
        
        .voice-play-btn {
            width: 36px;
            height: 36px;
            min-width: 36px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.2);
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s var(--ease-spring);
            color: inherit;
        }
        
        .chat-message.received .voice-play-btn {
            background: var(--color-brand-muted);
            color: var(--color-brand);
        }
        
        .voice-play-btn:hover {
            transform: scale(1.1);
            background: rgba(255, 255, 255, 0.3);
        }
        
        .chat-message.received .voice-play-btn:hover {
            background: var(--color-brand);
            color: white;
        }
        
        .voice-play-btn.playing {
            background: rgba(255, 255, 255, 0.4);
        }
        
        /* Waveform visualization */
        .voice-waveform {
            flex: 1;
            height: 32px;
            display: flex;
            align-items: center;
            gap: 2px;
            overflow: hidden;
        }
        
        .voice-waveform-bar {
            flex: 1;
            min-width: 3px;
            max-width: 4px;
            background: currentColor;
            border-radius: 2px;
            opacity: 0.4;
            transition: opacity 0.15s, height 0.15s;
        }
        
        .voice-waveform-bar.active {
            opacity: 1;
        }
        
        .voice-waveform-bar.played {
            opacity: 0.8;
        }
        
        .chat-message.received .voice-waveform-bar {
            background: var(--color-text-primary);
        }
        
        .voice-duration {
            font-size: 11px;
            font-weight: 500;
            opacity: 0.8;
            min-width: 36px;
            text-align: right;
        }
        
        /* Voice recording preview (before sending) */
        .voice-preview {
            display: none;
            align-items: center;
            gap: var(--space-2);
            flex: 1;
            padding: var(--space-2) var(--space-3);
            background: var(--color-bg-tertiary);
            border: 1px solid var(--color-border);
            border-radius: var(--radius-full);
        }
        
        .voice-preview.visible {
            display: flex;
        }
        
        .voice-preview-waveform {
            flex: 1;
            height: 24px;
            display: flex;
            align-items: center;
            gap: 2px;
        }
        
        .voice-preview-bar {
            flex: 1;
            min-width: 2px;
            max-width: 3px;
            background: var(--color-brand);
            border-radius: 1px;
            opacity: 0.6;
        }
        
        .voice-preview-duration {
            font-size: var(--text-xs);
            color: var(--color-text-muted);
            font-weight: 500;
        }
        
        .voice-preview-delete {
            width: 28px;
            height: 28px;
            border-radius: 50%;
            background: var(--color-error-muted);
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--color-error);
            transition: all 0.2s;
        }
        
        .voice-preview-delete:hover {
            background: var(--color-error);
            color: white;
        }
        
        /* Hide text input when showing voice preview */
        .chat-input-area.voice-mode .chat-input {
            display: none;
        }
        
        .chat-input-area.voice-mode .voice-preview {
            display: flex;
        }
        
        /* ===== FILE ATTACHMENT BUTTON ===== */
        .attach-btn {
            padding: var(--space-3);
            background: var(--color-bg-tertiary);
            border: 1px solid var(--color-border);
            border-radius: var(--radius-full);
            cursor: pointer;
            font-size: 1.25rem;
            transition: all 0.2s var(--ease-spring);
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--color-text-muted);
        }
        
        .attach-btn:hover {
            background: var(--color-bg-hover);
            border-color: var(--color-border-active);
            color: var(--color-text-primary);
            transform: scale(1.1) rotate(-10deg);
        }
        
        .attach-btn:active {
            transform: scale(0.95);
        }
        
        .attach-btn.uploading {
            pointer-events: none;
            opacity: 0.6;
        }
        
        .attach-btn.uploading svg {
            animation: spin 1s linear infinite;
        }
        
        /* Hidden file input */
        .attach-input {
            display: none;
        }
        
        /* ===== FILE ATTACHMENT PREVIEW ===== */
        .file-preview {
            display: none;
            align-items: center;
            gap: var(--space-2);
            flex: 1;
            padding: var(--space-2) var(--space-3);
            background: var(--color-bg-tertiary);
            border: 1px solid var(--color-border);
            border-radius: var(--radius-full);
            min-width: 0;
        }
        
        .file-preview.visible {
            display: flex;
        }
        
        .file-preview-icon {
            width: 32px;
            height: 32px;
            min-width: 32px;
            border-radius: var(--radius-md);
            background: var(--color-brand-muted);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.875rem;
        }
        
        .file-preview-icon.pdf { background: #fee2e2; color: #dc2626; }
        .file-preview-icon.doc, .file-preview-icon.docx { background: #dbeafe; color: #2563eb; }
        .file-preview-icon.xls, .file-preview-icon.xlsx { background: #dcfce7; color: #16a34a; }
        .file-preview-icon.ppt, .file-preview-icon.pptx { background: #fef3c7; color: #d97706; }
        .file-preview-icon.zip, .file-preview-icon.rar, .file-preview-icon.7z { background: #f3e8ff; color: #9333ea; }
        .file-preview-icon.txt, .file-preview-icon.csv { background: #f1f5f9; color: #475569; }
        
        .file-preview-info {
            flex: 1;
            min-width: 0;
            overflow: hidden;
        }
        
        .file-preview-name {
            font-size: var(--text-sm);
            font-weight: 500;
            color: var(--color-text-primary);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .file-preview-meta {
            font-size: 10px;
            color: var(--color-text-muted);
        }
        
        .file-preview-delete {
            width: 28px;
            height: 28px;
            border-radius: 50%;
            background: var(--color-error-muted);
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--color-error);
            transition: all 0.2s;
            flex-shrink: 0;
        }
        
        .file-preview-delete:hover {
            background: var(--color-error);
            color: white;
        }
        
        /* Hide text input when showing file preview */
        .chat-input-area.file-mode .chat-input {
            display: none;
        }
        
        .chat-input-area.file-mode .file-preview {
            display: flex;
        }
        
        /* ===== FILE ATTACHMENT IN CHAT MESSAGE ===== */
        .file-attachment {
            display: flex;
            align-items: center;
            gap: var(--space-3);
            padding: var(--space-3);
            background: rgba(255, 255, 255, 0.1);
            border-radius: var(--radius-lg);
            margin-top: var(--space-2);
            cursor: pointer;
            transition: all 0.2s var(--ease-spring);
            text-decoration: none;
            color: inherit;
            min-width: 200px;
            max-width: 280px;
        }
        
        .chat-message.received .file-attachment {
            background: var(--color-bg-tertiary);
        }
        
        .file-attachment:hover {
            transform: translateY(-2px);
            background: rgba(255, 255, 255, 0.15);
        }
        
        .chat-message.received .file-attachment:hover {
            background: var(--color-bg-hover);
        }
        
        .file-attachment-icon {
            width: 40px;
            height: 40px;
            min-width: 40px;
            border-radius: var(--radius-md);
            background: rgba(255, 255, 255, 0.2);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.125rem;
        }
        
        .chat-message.received .file-attachment-icon {
            background: var(--color-bg-elevated);
        }
        
        .file-attachment-icon.pdf { background: #fee2e2; color: #dc2626; }
        .file-attachment-icon.doc, .file-attachment-icon.docx { background: #dbeafe; color: #2563eb; }
        .file-attachment-icon.xls, .file-attachment-icon.xlsx { background: #dcfce7; color: #16a34a; }
        .file-attachment-icon.ppt, .file-attachment-icon.pptx { background: #fef3c7; color: #d97706; }
        .file-attachment-icon.zip, .file-attachment-icon.rar, .file-attachment-icon.7z { background: #f3e8ff; color: #9333ea; }
        .file-attachment-icon.txt, .file-attachment-icon.csv { background: #f1f5f9; color: #475569; }
        
        .file-attachment-info {
            flex: 1;
            min-width: 0;
            overflow: hidden;
        }
        
        .file-attachment-name {
            font-size: var(--text-sm);
            font-weight: 500;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .file-attachment-meta {
            font-size: 11px;
            opacity: 0.8;
            display: flex;
            align-items: center;
            gap: var(--space-1);
        }
        
        .file-attachment-download {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.2);
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
            flex-shrink: 0;
        }
        
        .chat-message.received .file-attachment-download {
            background: var(--color-brand-muted);
            color: var(--color-brand);
        }
        
        .file-attachment:hover .file-attachment-download {
            background: rgba(255, 255, 255, 0.3);
            transform: scale(1.1);
        }
        
        .chat-message.received .file-attachment:hover .file-attachment-download {
            background: var(--color-brand);
            color: white;
        }
        
        /* ===== STICKERS ===== */
        .sticker-btn {
            padding: var(--space-3);
            background: var(--color-bg-tertiary);
            border: 1px solid var(--color-border);
            border-radius: var(--radius-full);
            cursor: pointer;
            font-size: 1.25rem;
            transition: all 0.2s var(--ease-spring);
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--color-text-muted);
        }
        
        .sticker-btn:hover {
            background: var(--color-bg-hover);
            border-color: var(--color-border-active);
            color: var(--color-text-primary);
            transform: scale(1.1);
        }
        
        .sticker-btn:active {
            transform: scale(0.95);
        }
        
        .sticker-btn.active {
            background: var(--color-brand-muted);
            border-color: var(--color-brand);
            color: var(--color-brand);
        }
        
        /* GIF Button in chat */
        .gif-btn {
            padding: var(--space-2) var(--space-3);
            font-size: 0.7rem !important;
            border-radius: var(--radius-md) !important;
            height: 32px;
            min-width: 40px;
        }
        
        .gif-btn:hover {
            transform: scale(1.05) !important;
        }
        
        .gif-btn.active {
            box-shadow: 0 0 0 2px var(--color-brand);
        }
        
        /* GIF content in chat */
        .chat-message.gif .gif-content {
            max-width: 250px;
            margin-bottom: var(--space-2);
        }
        
        .chat-message.gif .gif-content img {
            width: 100%;
            height: auto;
            border-radius: var(--radius-lg);
            display: block;
        }
        
        /* Sticker Picker */
        .sticker-picker {
            position: absolute;
            bottom: calc(100% + var(--space-2));
            left: 0;
            right: 0;
            background: var(--color-bg-secondary);
            border: 1px solid var(--color-border);
            border-radius: var(--radius-xl);
            box-shadow: var(--shadow-xl);
            padding: var(--space-4);
            z-index: var(--z-dropdown);
            opacity: 0;
            visibility: hidden;
            transform: translateY(10px) scale(0.95);
            transition: all 0.25s var(--ease-spring);
            max-height: 280px;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }
        
        .sticker-picker.open {
            opacity: 1;
            visibility: visible;
            transform: translateY(0) scale(1);
        }
        
        .sticker-picker-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: var(--space-3);
            padding-bottom: var(--space-3);
            border-bottom: 1px solid var(--color-border);
        }
        
        .sticker-picker-title {
            font-family: var(--font-display);
            font-size: var(--text-sm);
            font-weight: 600;
            color: var(--color-text-primary);
            display: flex;
            align-items: center;
            gap: var(--space-2);
        }
        
        .sticker-picker-close {
            width: 28px;
            height: 28px;
            border-radius: 50%;
            background: var(--color-bg-tertiary);
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--color-text-muted);
            transition: all 0.2s;
        }
        
        .sticker-picker-close:hover {
            background: var(--color-bg-hover);
            color: var(--color-text-primary);
        }
        
        .sticker-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: var(--space-2);
            overflow-y: auto;
            padding-right: var(--space-2);
        }
        
        .sticker-grid::-webkit-scrollbar {
            width: 4px;
        }
        
        .sticker-grid::-webkit-scrollbar-track {
            background: transparent;
        }
        
        .sticker-grid::-webkit-scrollbar-thumb {
            background: var(--color-border);
            border-radius: var(--radius-full);
        }
        
        .sticker-item {
            aspect-ratio: 1;
            border-radius: var(--radius-lg);
            background: var(--color-bg-tertiary);
            border: 1px solid transparent;
            cursor: pointer;
            padding: var(--space-2);
            transition: all 0.2s var(--ease-spring);
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .sticker-item:hover {
            background: var(--color-brand-muted);
            border-color: var(--color-brand);
            transform: scale(1.1);
        }
        
        .sticker-item:active {
            transform: scale(0.95);
        }
        
        .sticker-item img {
            width: 100%;
            height: 100%;
            object-fit: contain;
        }
        
        /* Sticker in chat message */
        .chat-message.sticker {
            background: transparent !important;
            padding: var(--space-2) !important;
            max-width: 120px;
        }
        
        .chat-message.sticker::after {
            display: none;
        }
        
        .chat-message.sticker .sticker-content {
            width: 100px;
            height: 100px;
        }
        
        .chat-message.sticker .sticker-content img {
            width: 100%;
            height: 100%;
            object-fit: contain;
            animation: sticker-pop 0.4s var(--ease-spring);
        }
        
        @keyframes sticker-pop {
            0% { transform: scale(0) rotate(-15deg); opacity: 0; }
            50% { transform: scale(1.2) rotate(5deg); }
            100% { transform: scale(1) rotate(0); opacity: 1; }
        }
        
        .chat-message.sticker .chat-message-meta {
            justify-content: center;
            margin-top: var(--space-1);
        }
        
        .chat-message.sticker.sent {
            margin-left: auto;
        }
        
        .chat-message.sticker.received {
            margin-right: auto;
        }
        
        /* ===== LOCATION SHARING ===== */
        .location-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 36px;
            height: 36px;
            background: var(--color-bg-tertiary);
            border: 1px solid var(--color-border);
            border-radius: var(--radius-lg);
            color: var(--color-text-muted);
            cursor: pointer;
            transition: all 0.2s var(--ease-spring);
            font-size: 1rem;
        }
        
        .location-btn:hover {
            background: var(--color-bg-hover);
            color: var(--color-text-primary);
            transform: scale(1.05);
            border-color: var(--color-brand);
        }
        
        .location-btn:active {
            transform: scale(0.95);
        }
        
        .location-btn.loading {
            pointer-events: none;
            opacity: 0.7;
        }
        
        .location-btn.loading::after {
            content: '';
            position: absolute;
            width: 14px;
            height: 14px;
            border: 2px solid var(--color-brand);
            border-top-color: transparent;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        /* Location message in chat */
        .chat-message.location {
            max-width: 280px;
        }
        
        .location-content {
            display: flex;
            flex-direction: column;
            gap: var(--space-2);
            margin-bottom: var(--space-2);
        }
        
        .location-map {
            width: 100%;
            height: 150px;
            border-radius: var(--radius-lg);
            overflow: hidden;
            position: relative;
            background: var(--color-bg-tertiary);
        }
        
        .location-map img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            display: block;
        }
        
        .location-map-overlay {
            position: absolute;
            inset: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(0,0,0,0.1);
            opacity: 0;
            transition: opacity 0.2s;
        }
        
        .location-map:hover .location-map-overlay {
            opacity: 1;
        }
        
        .location-map-link {
            padding: var(--space-2) var(--space-3);
            background: var(--color-bg-primary);
            border-radius: var(--radius-md);
            font-size: var(--text-xs);
            font-weight: 500;
            color: var(--color-text-primary);
            text-decoration: none;
            display: flex;
            align-items: center;
            gap: var(--space-1);
            box-shadow: var(--shadow-md);
        }
        
        .location-map-link:hover {
            background: var(--color-brand);
            color: white;
        }
        
        .location-info {
            display: flex;
            align-items: center;
            gap: var(--space-2);
            font-size: var(--text-sm);
            color: var(--color-text-secondary);
        }
        
        .location-info svg {
            flex-shrink: 0;
            color: var(--color-brand);
        }
        
        .chat-message.location.sent .location-info {
            color: rgba(255,255,255,0.9);
        }
        
        .chat-message.location.sent .location-info svg {
            color: rgba(255,255,255,0.9);
        }
        
        .chat-message.location.sent .location-map-link {
            background: rgba(255,255,255,0.95);
            color: var(--color-brand);
        }
        
        /* ===== PINNED MESSAGES ===== */
        .pinned-messages-section {
            background: var(--color-bg-tertiary);
            border-bottom: 1px solid var(--color-border);
            padding: 0;
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s var(--ease-out-expo), padding 0.3s;
        }
        
        .pinned-messages-section.open {
            max-height: 200px;
            padding: var(--space-3) var(--space-4);
        }
        
        .pinned-messages-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: var(--space-2);
        }
        
        .pinned-messages-title {
            display: flex;
            align-items: center;
            gap: var(--space-2);
            font-size: var(--text-xs);
            font-weight: 600;
            color: var(--color-brand);
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }
        
        .pinned-messages-title svg {
            width: 14px;
            height: 14px;
        }
        
        .pinned-messages-toggle {
            background: none;
            border: none;
            color: var(--color-text-muted);
            cursor: pointer;
            padding: var(--space-1);
            display: flex;
            align-items: center;
            justify-content: center;
            transition: color 0.2s;
        }
        
        .pinned-messages-toggle:hover {
            color: var(--color-text-primary);
        }
        
        .pinned-messages-list {
            display: flex;
            flex-direction: column;
            gap: var(--space-2);
            max-height: 140px;
            overflow-y: auto;
        }
        
        .pinned-messages-list::-webkit-scrollbar {
            width: 4px;
        }
        
        .pinned-messages-list::-webkit-scrollbar-track {
            background: transparent;
        }
        
        .pinned-messages-list::-webkit-scrollbar-thumb {
            background: var(--color-border);
            border-radius: 2px;
        }
        
        .pinned-message-item {
            display: flex;
            align-items: center;
            gap: var(--space-3);
            padding: var(--space-2) var(--space-3);
            background: var(--color-bg-secondary);
            border: 1px solid var(--color-border);
            border-radius: var(--radius-lg);
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .pinned-message-item:hover {
            background: var(--color-bg-hover);
            border-color: var(--color-brand);
        }
        
        .pinned-message-content {
            flex: 1;
            min-width: 0;
            display: flex;
            flex-direction: column;
            gap: 2px;
        }
        
        .pinned-message-text {
            font-size: var(--text-sm);
            color: var(--color-text-primary);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .pinned-message-meta {
            font-size: 10px;
            color: var(--color-text-muted);
        }
        
        .pinned-message-unpin {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: var(--color-bg-tertiary);
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--color-text-muted);
            transition: all 0.2s;
            flex-shrink: 0;
        }
        
        .pinned-message-unpin:hover {
            background: var(--color-error-muted);
            color: var(--color-error);
        }
        
        .pinned-message-unpin svg {
            width: 12px;
            height: 12px;
        }
        
        /* Pin indicator in chat header */
        .chat-header-pin-btn {
            width: 36px;
            height: 36px;
            border-radius: var(--radius-lg);
            background: var(--color-bg-tertiary);
            border: 1px solid var(--color-border);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--color-text-muted);
            transition: all 0.2s;
            position: relative;
        }
        
        .chat-header-pin-btn:hover {
            background: var(--color-bg-hover);
            color: var(--color-brand);
            border-color: var(--color-brand);
        }
        
        .chat-header-pin-btn.has-pins {
            color: var(--color-brand);
        }
        
        .chat-header-pin-btn .pin-count {
            position: absolute;
            top: -4px;
            right: -4px;
            min-width: 16px;
            height: 16px;
            padding: 0 4px;
            background: var(--color-brand);
            border-radius: 8px;
            font-size: 10px;
            font-weight: 700;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        /* Pin button on messages */
        .chat-message-actions {
            position: absolute;
            top: -8px;
            right: 8px;
            display: flex;
            gap: var(--space-1);
            opacity: 0;
            visibility: hidden;
            transition: all 0.2s;
            z-index: 5;
        }
        
        .chat-message:hover .chat-message-actions {
            opacity: 1;
            visibility: visible;
        }
        
        .chat-message.sent .chat-message-actions {
            right: auto;
            left: 8px;
        }
        
        .message-action-btn {
            width: 28px;
            height: 28px;
            border-radius: 50%;
            background: var(--color-bg-elevated);
            border: 1px solid var(--color-border);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--color-text-muted);
            transition: all 0.2s var(--ease-spring);
            box-shadow: var(--shadow-sm);
        }
        
        .message-action-btn:hover {
            background: var(--color-brand-muted);
            color: var(--color-brand);
            border-color: var(--color-brand);
            transform: scale(1.1);
        }
        
        .message-action-btn.pinned {
            background: var(--color-brand);
            color: white;
            border-color: var(--color-brand);
        }
        
        .message-action-btn.has-reminder {
            background: var(--color-warning);
            color: white;
            border-color: var(--color-warning);
        }
        
        .message-action-btn.starred {
            background: #fbbf24;
            color: white;
            border-color: #fbbf24;
        }
        
        .message-action-btn.starred:hover {
            background: #f59e0b;
            border-color: #f59e0b;
        }
        
        .message-action-btn svg {
            width: 14px;
            height: 14px;
        }
        
        /* ===== REMINDER MODAL ===== */
        .reminder-modal {
            max-width: 360px;
        }
        
        .reminder-modal .modal-title {
            display: flex;
            align-items: center;
            gap: var(--space-2);
        }
        
        .reminder-message-preview {
            background: var(--color-bg-tertiary);
            border: 1px solid var(--color-border);
            border-radius: var(--radius-lg);
            padding: var(--space-3);
            margin-bottom: var(--space-4);
            font-size: var(--text-sm);
            color: var(--color-text-secondary);
            max-height: 80px;
            overflow: hidden;
            position: relative;
        }
        
        .reminder-message-preview::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 20px;
            background: linear-gradient(transparent, var(--color-bg-tertiary));
        }
        
        .reminder-quick-options {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: var(--space-2);
            margin-bottom: var(--space-4);
        }
        
        .reminder-quick-btn {
            padding: var(--space-3);
            background: var(--color-bg-tertiary);
            border: 1px solid var(--color-border);
            border-radius: var(--radius-lg);
            cursor: pointer;
            font-size: var(--text-sm);
            font-weight: 500;
            color: var(--color-text-secondary);
            transition: all 0.2s;
            text-align: center;
        }
        
        .reminder-quick-btn:hover {
            background: var(--color-brand-muted);
            border-color: var(--color-brand);
            color: var(--color-brand);
        }
        
        .reminder-quick-btn.selected {
            background: var(--color-brand);
            color: white;
            border-color: var(--color-brand);
        }
        
        .reminder-custom-time {
            margin-bottom: var(--space-4);
        }
        
        .reminder-custom-time label {
            display: block;
            font-size: var(--text-sm);
            font-weight: 500;
            color: var(--color-text-muted);
            margin-bottom: var(--space-2);
        }
        
        .reminder-datetime-input {
            width: 100%;
            padding: var(--space-3);
            background: var(--color-bg-tertiary);
            border: 1px solid var(--color-border);
            border-radius: var(--radius-lg);
            color: var(--color-text-primary);
            font-size: var(--text-sm);
            font-family: inherit;
            color-scheme: dark;
        }
        
        .reminder-datetime-input:focus {
            outline: none;
            border-color: var(--color-brand);
            box-shadow: 0 0 0 3px var(--color-brand-muted);
        }
        
        .reminder-note-input {
            width: 100%;
            padding: var(--space-3);
            background: var(--color-bg-tertiary);
            border: 1px solid var(--color-border);
            border-radius: var(--radius-lg);
            color: var(--color-text-primary);
            font-size: var(--text-sm);
            font-family: inherit;
            resize: none;
            min-height: 60px;
            margin-bottom: var(--space-4);
        }
        
        .reminder-note-input:focus {
            outline: none;
            border-color: var(--color-brand);
            box-shadow: 0 0 0 3px var(--color-brand-muted);
        }
        
        .reminder-actions {
            display: flex;
            gap: var(--space-2);
        }
        
        .reminder-actions button {
            flex: 1;
            padding: var(--space-3);
            border-radius: var(--radius-lg);
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .reminder-cancel-btn {
            background: var(--color-bg-tertiary);
            border: 1px solid var(--color-border);
            color: var(--color-text-muted);
        }
        
        .reminder-cancel-btn:hover {
            background: var(--color-bg-hover);
            color: var(--color-text-primary);
        }
        
        .reminder-save-btn {
            background: var(--cinq-gradient);
            border: none;
            color: white;
        }
        
        .reminder-save-btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: var(--shadow-glow-sm);
        }
        
        .reminder-save-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        /* Reminder badge on messages */
        .reminder-badge {
            position: absolute;
            top: -6px;
            left: -6px;
            width: 18px;
            height: 18px;
            background: var(--color-warning);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 10px;
            color: white;
            z-index: 4;
            animation: reminder-pulse 2s ease-in-out infinite;
        }
        
        @keyframes reminder-pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }
        
        .chat-message.sent .reminder-badge {
            left: auto;
            right: -6px;
        }
        
        /* Empty state for pinned messages */
        .pinned-messages-empty {
            text-align: center;
            padding: var(--space-4);
            color: var(--color-text-muted);
            font-size: var(--text-sm);
        }
        
        /* ===== MODALS ===== */
        .modal-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.75);
            backdrop-filter: blur(8px);
            -webkit-backdrop-filter: blur(8px);
            display: flex;
            align-items: center;
            justify-content: center;
            padding: var(--space-4);
            z-index: var(--z-modal);
            opacity: 0;
            visibility: hidden;
            transition: all 0.25s;
        }
        
        .modal-overlay.open {
            opacity: 1;
            visibility: visible;
        }
        
        .modal {
            background: var(--color-bg-secondary);
            border: 1px solid var(--color-border);
            border-radius: var(--radius-2xl);
            padding: var(--space-8);
            width: 100%;
            max-width: 420px;
            transform: scale(0.9) translateY(30px);
            opacity: 0;
            transition: 
                transform 0.4s var(--ease-spring),
                opacity 0.3s ease;
            position: relative;
            box-shadow: var(--shadow-2xl);
        }
        
        .modal-overlay.open .modal {
            transform: scale(1) translateY(0);
            opacity: 1;
            animation: modal-pop-in 0.45s var(--ease-spring);
        }
        
        @keyframes modal-pop-in {
            0% { 
                transform: scale(0.85) translateY(40px); 
                opacity: 0; 
            }
            60% { 
                transform: scale(1.02) translateY(-5px); 
            }
            100% { 
                transform: scale(1) translateY(0); 
                opacity: 1; 
            }
        }
        
        .modal-title {
            font-size: var(--text-xl);
            font-weight: 600;
            margin-bottom: var(--space-4);
            display: flex;
            align-items: center;
            gap: var(--space-2);
        }
        
        .gift-code-display {
            background: linear-gradient(135deg, var(--color-bg-tertiary) 0%, var(--color-bg-elevated) 100%);
            border: 2px dashed var(--color-brand);
            border-radius: var(--radius-xl);
            padding: var(--space-6);
            text-align: center;
            margin: var(--space-5) 0;
            position: relative;
        }
        
        .gift-code {
            position: relative;
            font-size: var(--text-2xl);
            font-weight: 700;
            font-family: var(--font-mono);
            background: var(--cinq-gradient);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            letter-spacing: 0.08em;
        }
        
        /* ===== TOASTS ===== */
        .toast-container {
            position: fixed;
            top: var(--space-4);
            left: 50%;
            transform: translateX(-50%);
            z-index: var(--z-toast);
            display: flex;
            flex-direction: column;
            gap: var(--space-2);
            pointer-events: none;
            width: 90%;
            max-width: 400px;
        }
        
        .toast {
            background: var(--color-bg-secondary);
            border: 1px solid var(--color-border);
            border-radius: var(--radius-xl);
            padding: var(--space-4);
            display: flex;
            align-items: center;
            gap: var(--space-3);
            box-shadow: var(--shadow-xl);
            animation: toast-in 0.5s var(--ease-spring);
            pointer-events: auto;
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            transition: transform 0.2s var(--ease-spring), box-shadow 0.2s ease;
            position: relative;
            overflow: hidden;
        }
        
        /* Progress bar for toast duration */
        .toast::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            height: 3px;
            background: var(--color-brand);
            animation: toast-progress 4s linear forwards;
            border-radius: 0 0 var(--radius-xl) var(--radius-xl);
        }
        
        @keyframes toast-progress {
            0% { width: 100%; }
            100% { width: 0%; }
        }
        
        .toast:hover {
            transform: scale(1.03) translateY(-2px);
            box-shadow: var(--shadow-2xl);
        }
        
        .toast:hover::after {
            animation-play-state: paused;
        }
        
        .toast.toast-out {
            animation: toast-out 0.35s var(--ease-out-expo) forwards;
        }
        
        @keyframes toast-in {
            0% { 
                opacity: 0; 
                transform: translateY(-30px) scale(0.85) rotateX(-15deg); 
            }
            60% { 
                transform: translateY(6px) scale(1.03) rotateX(0); 
            }
            100% { 
                opacity: 1; 
                transform: translateY(0) scale(1) rotateX(0); 
            }
        }
        
        @keyframes toast-out {
            0% { 
                opacity: 1; 
                transform: translateY(0) scale(1); 
            }
            100% { 
                opacity: 0; 
                transform: translateY(-20px) scale(0.9); 
            }
        }
        
        .toast-icon { 
            font-size: 1.25rem; 
            animation: toast-icon-pop 0.4s var(--ease-spring) 0.2s backwards;
        }
        
        @keyframes toast-icon-pop {
            0% { transform: scale(0) rotate(-20deg); }
            60% { transform: scale(1.2) rotate(5deg); }
            100% { transform: scale(1) rotate(0); }
        }
        
        .toast-content { flex: 1; }
        .toast-title { font-weight: 600; font-size: var(--text-base); }
        .toast-message { font-size: var(--text-sm); color: var(--color-text-muted); margin-top: 2px; }
        
        .toast.success { 
            border-color: var(--color-success); 
            background: var(--color-success-muted); 
        }
        .toast.success::after { background: var(--color-success); }
        
        .toast.error { 
            border-color: var(--color-error); 
            background: var(--color-error-muted); 
            animation: toast-in 0.5s var(--ease-spring), haptic-error 0.5s ease-out 0.1s;
        }
        .toast.error::after { background: var(--color-error); }
        
        .toast.notification { 
            border-color: var(--color-brand); 
            background: var(--color-brand-muted); 
            cursor: pointer; 
        }
        
        /* ===== IMAGE MODAL ===== */
        .image-modal {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.9);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: calc(var(--z-modal) + 1);
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s;
            cursor: zoom-out;
        }
        
        .image-modal.open {
            opacity: 1;
            visibility: visible;
        }
        
        .image-modal img {
            max-width: 95%;
            max-height: 95%;
            object-fit: contain;
            border-radius: var(--radius-lg);
            transform: scale(0.9);
            opacity: 0;
            transition: transform 0.4s var(--ease-spring), opacity 0.3s ease;
        }
        
        .image-modal.open img {
            transform: scale(1);
            opacity: 1;
        }
        
        .image-modal-close {
            position: absolute;
            top: var(--space-4);
            right: var(--space-4);
            width: 40px;
            height: 40px;
            background: rgba(255, 255, 255, 0.1);
            border: none;
            border-radius: 50%;
            color: white;
            cursor: pointer;
            font-size: 1.5rem;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .image-modal-close:hover {
            background: rgba(255, 255, 255, 0.2);
        }
        
        /* ===== LOADING ===== */
        .loading-spinner {
            width: 24px;
            height: 24px;
            border: 2px solid var(--color-border);
            border-top-color: var(--color-brand);
            border-radius: 50%;
            animation: spin 0.8s linear infinite, pulse-glow 1.5s ease-in-out infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        @keyframes pulse-glow {
            0%, 100% { box-shadow: 0 0 0 0 var(--color-brand-glow); }
            50% { box-shadow: 0 0 12px 2px var(--color-brand-glow); }
        }
        
        /* ===== ONBOARDING SYSTEM ===== */
        .onboarding-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.85);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            display: flex;
            align-items: center;
            justify-content: center;
            padding: var(--space-4);
            z-index: calc(var(--z-modal) + 10);
            opacity: 0;
            visibility: hidden;
            transition: all 0.4s ease;
        }
        
        .onboarding-overlay.open {
            opacity: 1;
            visibility: visible;
        }
        
        .onboarding-card {
            background: var(--color-bg-secondary);
            border: 1px solid var(--color-border);
            border-radius: var(--radius-2xl);
            padding: var(--space-8);
            width: 100%;
            max-width: 440px;
            text-align: center;
            transform: scale(0.9) translateY(30px);
            opacity: 0;
            transition: transform 0.5s var(--ease-spring), opacity 0.4s ease;
            position: relative;
            overflow: hidden;
        }
        
        .onboarding-overlay.open .onboarding-card {
            transform: scale(1) translateY(0);
            opacity: 1;
        }
        
        .onboarding-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: var(--cinq-gradient);
        }
        
        .onboarding-confetti {
            position: absolute;
            top: -50px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 4rem;
            animation: confetti-fall 1s ease-out forwards;
            pointer-events: none;
        }
        
        @keyframes confetti-fall {
            0% { transform: translateX(-50%) translateY(-100%) rotate(0deg); opacity: 0; }
            20% { opacity: 1; }
            100% { transform: translateX(-50%) translateY(0) rotate(15deg); opacity: 1; }
        }
        
        .onboarding-emoji {
            font-size: 4rem;
            margin-bottom: var(--space-4);
            animation: emoji-bounce 0.6s var(--ease-spring) 0.3s backwards;
        }
        
        @keyframes emoji-bounce {
            0% { transform: scale(0) rotate(-20deg); }
            60% { transform: scale(1.2) rotate(5deg); }
            100% { transform: scale(1) rotate(0); }
        }
        
        .onboarding-title {
            font-family: var(--font-display);
            font-size: var(--text-2xl);
            font-weight: 700;
            letter-spacing: -0.02em;
            margin-bottom: var(--space-2);
            background: var(--cinq-gradient);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        .onboarding-subtitle {
            color: var(--color-text-muted);
            margin-bottom: var(--space-6);
            line-height: 1.6;
        }
        
        .onboarding-steps {
            display: flex;
            flex-direction: column;
            gap: var(--space-3);
            margin-bottom: var(--space-6);
            text-align: left;
        }
        
        .onboarding-step {
            display: flex;
            align-items: center;
            gap: var(--space-3);
            padding: var(--space-3) var(--space-4);
            background: var(--color-bg-tertiary);
            border: 1px solid var(--color-border);
            border-radius: var(--radius-lg);
            transition: all 0.3s var(--ease-spring);
            opacity: 0;
            transform: translateX(-20px);
            animation: step-appear 0.4s ease-out forwards;
        }
        
        .onboarding-step:nth-child(1) { animation-delay: 0.4s; }
        .onboarding-step:nth-child(2) { animation-delay: 0.5s; }
        .onboarding-step:nth-child(3) { animation-delay: 0.6s; }
        
        @keyframes step-appear {
            to { opacity: 1; transform: translateX(0); }
        }
        
        .onboarding-step.completed {
            background: var(--color-success-muted);
            border-color: var(--color-success);
        }
        
        .onboarding-step-icon {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background: var(--color-bg-elevated);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.1rem;
            flex-shrink: 0;
            transition: all 0.3s;
        }
        
        .onboarding-step.completed .onboarding-step-icon {
            background: var(--color-success);
            color: white;
        }
        
        .onboarding-step-text {
            flex: 1;
        }
        
        .onboarding-step-title {
            font-weight: 600;
            font-size: var(--text-sm);
        }
        
        .onboarding-step-subtitle {
            font-size: var(--text-xs);
            color: var(--color-text-muted);
        }
        
        .onboarding-btn {
            width: 100%;
            padding: var(--space-4);
            background: var(--cinq-gradient);
            color: white;
            border: none;
            border-radius: var(--radius-lg);
            font-family: var(--font-display);
            font-size: var(--text-base);
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.15s var(--ease-spring), box-shadow 0.2s;
            box-shadow: var(--shadow-glow-sm);
        }
        
        .onboarding-btn:hover {
            transform: translateY(-2px) scale(1.02);
            box-shadow: var(--shadow-glow);
        }
        
        .onboarding-skip {
            background: none;
            border: none;
            color: var(--color-text-muted);
            cursor: pointer;
            font-size: var(--text-sm);
            margin-top: var(--space-4);
            padding: var(--space-2);
            transition: color 0.2s;
        }
        
        .onboarding-skip:hover {
            color: var(--color-text-primary);
        }
        
        /* ===== TOOLTIPS/HINTS ===== */
        .tooltip-hint {
            position: absolute;
            background: var(--cinq-gradient);
            color: white;
            padding: var(--space-3) var(--space-4);
            border-radius: var(--radius-lg);
            font-size: var(--text-sm);
            font-weight: 500;
            box-shadow: var(--shadow-glow);
            z-index: var(--z-tooltip);
            max-width: 250px;
            opacity: 0;
            visibility: hidden;
            transform: translateY(10px);
            transition: all 0.3s var(--ease-spring);
            pointer-events: none;
        }
        
        .tooltip-hint.visible {
            opacity: 1;
            visibility: visible;
            transform: translateY(0);
            pointer-events: auto;
        }
        
        .tooltip-hint::before {
            content: '';
            position: absolute;
            width: 12px;
            height: 12px;
            background: var(--color-brand);
            transform: rotate(45deg);
        }
        
        .tooltip-hint.top::before {
            bottom: -6px;
            left: 50%;
            margin-left: -6px;
        }
        
        .tooltip-hint.bottom::before {
            top: -6px;
            left: 50%;
            margin-left: -6px;
        }
        
        .tooltip-hint.left::before {
            right: -6px;
            top: 50%;
            margin-top: -6px;
        }
        
        .tooltip-hint-close {
            position: absolute;
            top: var(--space-1);
            right: var(--space-2);
            background: none;
            border: none;
            color: rgba(255,255,255,0.7);
            cursor: pointer;
            font-size: 1rem;
            line-height: 1;
            padding: var(--space-1);
        }
        
        .tooltip-hint-close:hover {
            color: white;
        }
        
        /* ===== PULSING INDICATOR ===== */
        .pulse-indicator {
            position: relative;
        }
        
        .pulse-indicator::after {
            content: '';
            position: absolute;
            top: -4px;
            right: -4px;
            width: 12px;
            height: 12px;
            background: var(--color-brand);
            border-radius: 50%;
            animation: pulse-ring 1.5s ease-out infinite;
            z-index: 10;
        }
        
        @keyframes pulse-ring {
            0% { transform: scale(1); opacity: 1; box-shadow: 0 0 0 0 var(--color-brand-glow); }
            70% { transform: scale(1.3); opacity: 0.7; box-shadow: 0 0 0 10px transparent; }
            100% { transform: scale(1); opacity: 1; box-shadow: 0 0 0 0 transparent; }
        }
        
        /* ===== ONBOARDING CHECKLIST (FLOATING) ===== */
        .onboarding-checklist {
            position: fixed;
            bottom: 100px;
            right: var(--space-4);
            background: var(--color-bg-secondary);
            border: 1px solid var(--color-border);
            border-radius: var(--radius-xl);
            padding: var(--space-4);
            box-shadow: var(--shadow-xl);
            z-index: var(--z-sticky);
            max-width: 280px;
            opacity: 0;
            visibility: hidden;
            transform: translateY(20px) scale(0.95);
            transition: all 0.3s var(--ease-spring);
        }
        
        .onboarding-checklist.visible {
            opacity: 1;
            visibility: visible;
            transform: translateY(0) scale(1);
        }
        
        .onboarding-checklist-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: var(--space-3);
        }
        
        .onboarding-checklist-title {
            font-weight: 600;
            font-size: var(--text-sm);
            display: flex;
            align-items: center;
            gap: var(--space-2);
        }
        
        .onboarding-checklist-close {
            background: none;
            border: none;
            color: var(--color-text-muted);
            cursor: pointer;
            padding: var(--space-1);
            line-height: 1;
        }
        
        .onboarding-checklist-items {
            display: flex;
            flex-direction: column;
            gap: var(--space-2);
        }
        
        .checklist-item {
            display: flex;
            align-items: center;
            gap: var(--space-2);
            font-size: var(--text-sm);
            padding: var(--space-2);
            border-radius: var(--radius-md);
            transition: background 0.2s;
            cursor: pointer;
        }
        
        .checklist-item:hover {
            background: var(--color-bg-tertiary);
        }
        
        .checklist-item.completed {
            color: var(--color-text-muted);
            text-decoration: line-through;
        }
        
        .checklist-icon {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            border: 2px solid var(--color-border);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.7rem;
            flex-shrink: 0;
            transition: all 0.3s;
        }
        
        .checklist-item.completed .checklist-icon {
            background: var(--color-success);
            border-color: var(--color-success);
            color: white;
        }
        
        .onboarding-checklist-progress {
            margin-top: var(--space-3);
            padding-top: var(--space-3);
            border-top: 1px solid var(--color-border);
        }
        
        .progress-bar-mini {
            height: 4px;
            background: var(--color-bg-tertiary);
            border-radius: var(--radius-full);
            overflow: hidden;
            margin-bottom: var(--space-1);
        }
        
        .progress-bar-fill {
            height: 100%;
            background: var(--cinq-gradient);
            border-radius: inherit;
            transition: width 0.5s var(--ease-out-expo);
        }
        
        .progress-text {
            font-size: var(--text-xs);
            color: var(--color-text-muted);
            text-align: center;
        }
        
        /* ===== SEARCH ===== */
        .search-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.85);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            z-index: calc(var(--z-modal) + 1);
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s var(--ease-out-expo);
            padding: var(--space-4);
            padding-top: env(safe-area-inset-top, var(--space-4));
        }
        
        .search-overlay.open {
            opacity: 1;
            visibility: visible;
        }
        
        .search-container {
            max-width: 600px;
            margin: 0 auto;
            transform: translateY(-20px);
            opacity: 0;
            transition: all 0.35s var(--ease-spring);
        }
        
        .search-overlay.open .search-container {
            transform: translateY(0);
            opacity: 1;
        }
        
        .search-header {
            display: flex;
            align-items: center;
            gap: var(--space-3);
            margin-bottom: var(--space-4);
        }
        
        .search-input-wrapper {
            flex: 1;
            position: relative;
        }
        
        .search-input {
            width: 100%;
            padding: var(--space-4) var(--space-5);
            padding-left: 48px;
            background: var(--color-bg-secondary);
            border: 2px solid var(--color-border);
            border-radius: var(--radius-xl);
            color: var(--color-text-primary);
            font-size: var(--text-lg);
            font-family: inherit;
            transition: all 0.2s var(--ease-out-expo);
        }
        
        .search-input:focus {
            outline: none;
            border-color: var(--color-brand);
            box-shadow: 0 0 0 4px var(--color-brand-muted);
        }
        
        .search-input::placeholder {
            color: var(--color-text-muted);
        }
        
        .search-icon {
            position: absolute;
            left: var(--space-4);
            top: 50%;
            transform: translateY(-50%);
            color: var(--color-text-muted);
            pointer-events: none;
        }
        
        .search-close-btn {
            width: 44px;
            height: 44px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--color-bg-tertiary);
            border: 1px solid var(--color-border);
            border-radius: var(--radius-lg);
            color: var(--color-text-muted);
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .search-close-btn:hover {
            background: var(--color-bg-hover);
            color: var(--color-text-primary);
        }
        
        .search-tabs {
            display: flex;
            gap: var(--space-2);
            margin-bottom: var(--space-4);
        }
        
        .search-tab {
            padding: var(--space-2) var(--space-4);
            background: var(--color-bg-tertiary);
            border: 1px solid var(--color-border);
            border-radius: var(--radius-full);
            color: var(--color-text-muted);
            font-size: var(--text-sm);
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .search-tab:hover {
            background: var(--color-bg-hover);
            color: var(--color-text-primary);
        }
        
        .search-tab.active {
            background: var(--color-brand-muted);
            border-color: var(--color-brand);
            color: var(--color-brand);
        }
        
        .search-results {
            max-height: calc(100vh - 200px);
            max-height: calc(100dvh - 200px);
            overflow-y: auto;
            padding-right: var(--space-2);
        }
        
        .search-section {
            margin-bottom: var(--space-5);
        }
        
        .search-section-title {
            font-size: var(--text-xs);
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: var(--color-text-muted);
            margin-bottom: var(--space-3);
            display: flex;
            align-items: center;
            gap: var(--space-2);
        }
        
        .search-section-count {
            background: var(--color-bg-tertiary);
            padding: 2px 8px;
            border-radius: var(--radius-full);
            font-size: var(--text-xs);
        }
        
        .search-result-item {
            display: flex;
            align-items: flex-start;
            gap: var(--space-3);
            padding: var(--space-3);
            background: var(--color-bg-secondary);
            border: 1px solid var(--color-border);
            border-radius: var(--radius-lg);
            cursor: pointer;
            transition: all 0.2s;
            margin-bottom: var(--space-2);
        }
        
        .search-result-item:hover {
            background: var(--color-bg-hover);
            border-color: var(--color-border-active);
            transform: translateX(4px);
        }
        
        .search-result-avatar {
            width: 40px;
            height: 40px;
            min-width: 40px;
            border-radius: 50%;
            background: var(--cinq-gradient);
            display: flex;
            align-items: center;
            justify-content: center;
            font-family: var(--font-display);
            font-size: 1rem;
            color: white;
            font-weight: 600;
            overflow: hidden;
            flex-shrink: 0;
            position: relative;
        }
        
        .search-result-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            position: absolute;
            inset: 0;
        }
        
        .search-result-info {
            flex: 1;
            min-width: 0;
        }
        
        .search-result-name {
            font-weight: 600;
            font-size: var(--text-sm);
            color: var(--color-text-primary);
            margin-bottom: 2px;
        }
        
        .search-result-name mark {
            background: var(--color-brand-muted);
            color: var(--color-brand);
            padding: 0 2px;
            border-radius: 2px;
        }
        
        .search-result-meta {
            font-size: var(--text-xs);
            color: var(--color-text-muted);
        }
        
        .search-result-preview {
            font-size: var(--text-sm);
            color: var(--color-text-secondary);
            line-height: 1.5;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }
        
        .search-result-preview mark {
            background: var(--color-brand-muted);
            color: var(--color-brand);
            padding: 0 2px;
            border-radius: 2px;
        }
        
        .search-empty {
            text-align: center;
            padding: var(--space-8) var(--space-4);
            color: var(--color-text-muted);
        }
        
        .search-empty-icon {
            font-size: 3rem;
            margin-bottom: var(--space-3);
            opacity: 0.5;
        }
        
        .search-loading {
            display: flex;
            justify-content: center;
            padding: var(--space-6);
        }
        
        .search-hint {
            text-align: center;
            padding: var(--space-8) var(--space-4);
            color: var(--color-text-muted);
            font-size: var(--text-sm);
        }
        
        .search-hint kbd {
            background: var(--color-bg-tertiary);
            border: 1px solid var(--color-border);
            border-radius: var(--radius-sm);
            padding: 2px 6px;
            font-family: var(--font-mono);
            font-size: var(--text-xs);
        }
        
        /* ===== MENTIONS ===== */
        .mention {
            color: var(--color-brand);
            text-decoration: none;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            background: var(--color-brand-muted);
            padding: 0.1em 0.3em;
            border-radius: var(--radius-sm);
        }
        
        .mention:hover {
            color: white;
            background: var(--color-brand);
            text-decoration: none;
        }
        
        .mention:focus-visible {
            outline: 2px solid var(--color-brand);
            outline-offset: 2px;
        }
        
        /* Mention autocomplete dropdown */
        .mention-autocomplete {
            position: absolute;
            background: var(--color-bg-elevated);
            border: 1px solid var(--color-border);
            border-radius: var(--radius-lg);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.4);
            max-height: 200px;
            overflow-y: auto;
            z-index: 1000;
            display: none;
            min-width: 200px;
        }
        
        .mention-autocomplete.visible {
            display: block;
            animation: modal-enter 0.2s ease;
        }
        
        .mention-item {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.75rem 1rem;
            cursor: pointer;
            transition: background 0.15s;
        }
        
        .mention-item:hover,
        .mention-item.selected {
            background: var(--color-bg-hover);
        }
        
        .mention-item-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: var(--cinq-gradient);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.875rem;
            color: white;
            font-weight: 600;
        }
        
        .mention-item-info {
            display: flex;
            flex-direction: column;
        }
        
        .mention-item-name {
            font-weight: 500;
            font-size: 0.9rem;
        }
        
        .mention-item-username {
            color: var(--color-text-muted);
            font-size: 0.75rem;
        }
        
        /* ===== RESPONSIVE ===== */
        @media (max-width: 480px) {
            .app-content {
                padding: var(--space-4);
                padding-bottom: calc(80px + env(safe-area-inset-bottom, var(--space-4)));
            }
            
            .modal {
                padding: var(--space-6);
            }
            
            .search-input {
                font-size: var(--text-base);
                padding: var(--space-3) var(--space-4);
                padding-left: 44px;
            }
        }
        
        /* ===== SCHEDULED MESSAGES ===== */
        .schedule-btn {
            width: 36px;
            height: 36px;
            border-radius: var(--radius-md);
            background: var(--color-bg-tertiary);
            border: 1px solid var(--color-border);
            color: var(--color-text-muted);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
            position: relative;
        }
        
        .schedule-btn:hover {
            background: var(--color-brand-muted);
            border-color: var(--color-brand);
            color: var(--color-brand);
        }
        
        .schedule-btn.has-scheduled::after {
            content: '';
            position: absolute;
            top: -2px;
            right: -2px;
            width: 8px;
            height: 8px;
            background: var(--color-brand);
            border-radius: 50%;
            animation: pulse 2s ease-in-out infinite;
        }
        
        .scheduled-count {
            position: absolute;
            top: -4px;
            right: -4px;
            min-width: 16px;
            height: 16px;
            background: var(--color-brand);
            border-radius: var(--radius-full);
            color: white;
            font-size: 10px;
            font-weight: 600;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0 4px;
        }
        
        .schedule-modal {
            max-width: 400px;
        }
        
        .schedule-form {
            display: flex;
            flex-direction: column;
            gap: var(--space-4);
        }
        
        .schedule-input-group {
            display: flex;
            flex-direction: column;
            gap: var(--space-2);
        }
        
        .schedule-input-group label {
            font-size: var(--text-sm);
            font-weight: 500;
            color: var(--color-text-secondary);
        }
        
        .schedule-input {
            width: 100%;
            padding: var(--space-3);
            background: var(--color-bg-tertiary);
            border: 1px solid var(--color-border);
            border-radius: var(--radius-md);
            color: var(--color-text);
            font-size: var(--text-base);
            transition: all 0.2s;
        }
        
        .schedule-input:focus {
            outline: none;
            border-color: var(--color-brand);
            background: var(--color-bg-secondary);
        }
        
        .schedule-textarea {
            min-height: 80px;
            resize: vertical;
            font-family: inherit;
        }
        
        .schedule-char-count {
            display: block;
            text-align: right;
            margin-top: var(--space-1);
        }
        
        .schedule-datetime {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: var(--space-3);
        }
        
        .schedule-quick-btns {
            display: flex;
            flex-wrap: wrap;
            gap: var(--space-2);
            margin-top: var(--space-2);
        }
        
        .schedule-quick-btn {
            padding: var(--space-2) var(--space-3);
            background: var(--color-bg-tertiary);
            border: 1px solid var(--color-border);
            border-radius: var(--radius-full);
            color: var(--color-text-muted);
            font-size: var(--text-xs);
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .schedule-quick-btn:hover {
            background: var(--color-brand-muted);
            border-color: var(--color-brand);
            color: var(--color-brand);
        }
        
        .scheduled-list-section {
            margin-top: var(--space-4);
            padding-top: var(--space-4);
            border-top: 1px solid var(--color-border);
        }
        
        .scheduled-list-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: var(--space-3);
        }
        
        .scheduled-list-title {
            font-size: var(--text-sm);
            font-weight: 600;
            color: var(--color-text-secondary);
            display: flex;
            align-items: center;
            gap: var(--space-2);
        }
        
        .scheduled-list-title svg {
            color: var(--color-brand);
        }
        
        .scheduled-list {
            display: flex;
            flex-direction: column;
            gap: var(--space-2);
            max-height: 200px;
            overflow-y: auto;
        }
        
        .scheduled-list:empty::before {
            content: 'Aucun message programmé';
            display: block;
            text-align: center;
            color: var(--color-text-muted);
            font-size: var(--text-sm);
            padding: var(--space-4);
        }
        
        .scheduled-item {
            display: flex;
            align-items: flex-start;
            gap: var(--space-3);
            padding: var(--space-3);
            background: var(--color-bg-secondary);
            border: 1px solid var(--color-border);
            border-radius: var(--radius-lg);
            transition: all 0.2s;
        }
        
        .scheduled-item:hover {
            border-color: var(--color-border-active);
        }
        
        .scheduled-item-icon {
            width: 32px;
            height: 32px;
            min-width: 32px;
            background: var(--color-brand-muted);
            border-radius: var(--radius-md);
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--color-brand);
        }
        
        .scheduled-item-content {
            flex: 1;
            min-width: 0;
        }
        
        .scheduled-item-message {
            font-size: var(--text-sm);
            color: var(--color-text);
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            margin-bottom: 2px;
        }
        
        .scheduled-item-meta {
            display: flex;
            align-items: center;
            gap: var(--space-2);
            font-size: var(--text-xs);
            color: var(--color-text-muted);
        }
        
        .scheduled-item-contact {
            font-weight: 500;
            color: var(--color-brand);
        }
        
        .scheduled-item-time {
            display: flex;
            align-items: center;
            gap: 4px;
        }
        
        .scheduled-item-delete {
            width: 28px;
            height: 28px;
            border-radius: var(--radius-md);
            background: transparent;
            border: 1px solid transparent;
            color: var(--color-text-muted);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }
        
        .scheduled-item-delete:hover {
            background: var(--color-error-muted, rgba(239, 68, 68, 0.1));
            border-color: var(--color-error);
            color: var(--color-error);
        }
        
        /* Floating scheduled messages indicator in chat */
        .chat-scheduled-indicator {
            display: none;
            align-items: center;
            gap: var(--space-2);
            padding: var(--space-2) var(--space-3);
            background: var(--color-brand-muted);
            border: 1px solid var(--color-brand);
            border-radius: var(--radius-lg);
            margin: var(--space-2) var(--space-4);
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .chat-scheduled-indicator.visible {
            display: flex;
        }
        
        .chat-scheduled-indicator:hover {
            background: var(--color-brand);
            color: white;
        }
        
        .chat-scheduled-indicator svg {
            color: var(--color-brand);
        }
        
        .chat-scheduled-indicator:hover svg {
            color: white;
        }
        
        .chat-scheduled-text {
            font-size: var(--text-xs);
            font-weight: 500;
            color: var(--color-brand);
        }
        
        .chat-scheduled-indicator:hover .chat-scheduled-text {
            color: white;
        }
        
        /* ===== FORWARD MESSAGE MODAL ===== */
        .forward-modal {
            max-width: 400px;
        }
        
        .forward-modal .modal-title {
            display: flex;
            align-items: center;
            gap: var(--space-2);
        }
        
        .forward-message-preview {
            background: var(--color-bg-tertiary);
            border: 1px solid var(--color-border);
            border-radius: var(--radius-lg);
            padding: var(--space-3);
            margin-bottom: var(--space-4);
            max-height: 100px;
            overflow: hidden;
            position: relative;
        }
        
        .forward-message-preview::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 30px;
            background: linear-gradient(transparent, var(--color-bg-tertiary));
            pointer-events: none;
        }
        
        .forward-message-preview p {
            font-size: var(--text-sm);
            color: var(--color-text-secondary);
            margin: 0;
            word-break: break-word;
        }
        
        .forward-message-preview .forward-preview-label {
            font-size: var(--text-xs);
            color: var(--color-text-muted);
            margin-bottom: var(--space-2);
            display: flex;
            align-items: center;
            gap: var(--space-1);
        }
        
        .forward-contacts-list {
            display: flex;
            flex-direction: column;
            gap: var(--space-2);
            max-height: 250px;
            overflow-y: auto;
            margin-bottom: var(--space-4);
        }
        
        .forward-contacts-list::-webkit-scrollbar {
            width: 4px;
        }
        
        .forward-contacts-list::-webkit-scrollbar-track {
            background: transparent;
        }
        
        .forward-contacts-list::-webkit-scrollbar-thumb {
            background: var(--color-border);
            border-radius: 4px;
        }
        
        .forward-contact-item {
            display: flex;
            align-items: center;
            gap: var(--space-3);
            padding: var(--space-3);
            background: var(--color-bg-secondary);
            border: 1px solid var(--color-border);
            border-radius: var(--radius-lg);
            cursor: pointer;
            transition: all 0.2s var(--ease-out-expo);
        }
        
        .forward-contact-item:hover {
            background: var(--color-bg-hover);
            border-color: var(--color-border-active);
            transform: translateX(4px);
        }
        
        .forward-contact-item.selected {
            background: var(--color-brand-muted);
            border-color: var(--color-brand);
        }
        
        .forward-contact-item.selected .forward-contact-check {
            opacity: 1;
            transform: scale(1);
        }
        
        .forward-contact-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: var(--cinq-gradient);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: var(--text-base);
            font-weight: 600;
            color: white;
            flex-shrink: 0;
        }
        
        .forward-contact-info {
            flex: 1;
            min-width: 0;
        }
        
        .forward-contact-name {
            font-size: var(--text-sm);
            font-weight: 600;
            color: var(--color-text-primary);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .forward-contact-email {
            font-size: var(--text-xs);
            color: var(--color-text-muted);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .forward-contact-check {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: var(--color-brand);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            opacity: 0;
            transform: scale(0.5);
            transition: all 0.2s var(--ease-spring);
        }
        
        .forward-contact-check svg {
            width: 14px;
            height: 14px;
        }
        
        .forward-empty-contacts {
            text-align: center;
            padding: var(--space-6);
            color: var(--color-text-muted);
        }
        
        .forward-empty-contacts svg {
            width: 48px;
            height: 48px;
            margin-bottom: var(--space-3);
            opacity: 0.5;
        }
        
        .forward-btn {
            width: 100%;
            padding: var(--space-3) var(--space-4);
            background: var(--cinq-gradient);
            border: none;
            border-radius: var(--radius-lg);
            color: white;
            font-weight: 600;
            font-size: var(--text-sm);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: var(--space-2);
            transition: all 0.2s var(--ease-out-expo);
        }
        
        .forward-btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 4px 16px var(--color-brand-glow);
        }
        
        .forward-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .forward-btn svg {
            width: 16px;
            height: 16px;
        }
    </style>
    
    <!-- Confetti celebrations -->
    <script src="/js/confetti.js"></script>
    <!-- View Transitions -->
    <link rel="stylesheet" href="/css/view-transitions.min.css">
</head>
<body>
    <!-- Skip Links - WCAG AAA Compliant -->
    <nav class="skip-links" aria-label="Liens d'évitement">
        <a href="#main-content" class="skip-link">Aller au contenu principal</a>
        <a href="#bottom-nav" class="skip-link">Aller à la navigation</a>
        <a href="#tab-contacts" class="skip-link">Aller à Tes 5 proches</a>
    </nav>
    
    <!-- Live region for dynamic announcements -->
    <div id="sr-announce" class="sr-announce" aria-live="polite" aria-atomic="true"></div>
    
    <div class="noise-overlay" aria-hidden="true"></div>
    <div class="gradient-orb gradient-orb-1" aria-hidden="true"></div>
    <div class="gradient-orb gradient-orb-2" aria-hidden="true"></div>
    
    <!-- Toast Container -->
    <div class="toast-container" id="toast-container" role="status" aria-live="polite" aria-atomic="false"></div>
    
    <!-- Onboarding Welcome Overlay -->
    <div class="onboarding-overlay" id="onboarding-overlay" role="dialog" aria-modal="true" aria-labelledby="onboarding-title">
        <div class="onboarding-card">
            <div class="onboarding-confetti" aria-hidden="true">🎉</div>
            <div class="onboarding-emoji" aria-hidden="true">👋</div>
            <h2 class="onboarding-title" id="onboarding-title">Bienvenue sur Cinq !</h2>
            <p class="onboarding-subtitle">Ton espace intime avec tes 5 proches est prêt.<br>Voici comment bien démarrer :</p>
            
            <div class="onboarding-steps" role="list">
                <div class="onboarding-step" role="listitem">
                    <div class="onboarding-step-icon">📸</div>
                    <div class="onboarding-step-text">
                        <div class="onboarding-step-title">Ajoute ta photo</div>
                        <div class="onboarding-step-subtitle">Pour que tes proches te reconnaissent</div>
                    </div>
                </div>
                <div class="onboarding-step" role="listitem">
                    <div class="onboarding-step-icon">👥</div>
                    <div class="onboarding-step-text">
                        <div class="onboarding-step-title">Invite tes 5 proches</div>
                        <div class="onboarding-step-subtitle">Les personnes qui comptent vraiment</div>
                    </div>
                </div>
                <div class="onboarding-step" role="listitem">
                    <div class="onboarding-step-icon">✍️</div>
                    <div class="onboarding-step-text">
                        <div class="onboarding-step-title">Partage ton premier moment</div>
                        <div class="onboarding-step-subtitle">Un message, une photo, un ressenti</div>
                    </div>
                </div>
            </div>
            
            <button class="onboarding-btn" onclick="startOnboarding()" type="button">C'est parti ! 🚀</button>
            <button class="onboarding-skip" onclick="skipOnboarding()" type="button">Je connais déjà, passer</button>
        </div>
    </div>
    
    <!-- Floating Onboarding Checklist -->
    <div class="onboarding-checklist" id="onboarding-checklist" role="complementary" aria-label="Progression d'onboarding">
        <div class="onboarding-checklist-header">
            <div class="onboarding-checklist-title">
                <span>🎯</span> Premiers pas
            </div>
            <button class="onboarding-checklist-close" onclick="hideOnboardingChecklist()" aria-label="Fermer" type="button">×</button>
        </div>
        <div class="onboarding-checklist-items">
            <div class="checklist-item" id="checklist-photo" onclick="goToProfileForPhoto()">
                <div class="checklist-icon">✓</div>
                <span>Ajouter une photo de profil</span>
            </div>
            <div class="checklist-item" id="checklist-contact" onclick="goToContactsForAdd()">
                <div class="checklist-icon">✓</div>
                <span>Ajouter un premier contact</span>
            </div>
            <div class="checklist-item" id="checklist-post" onclick="goToFeedForPost()">
                <div class="checklist-icon">✓</div>
                <span>Créer ton premier post</span>
            </div>
        </div>
        <div class="onboarding-checklist-progress">
            <div class="progress-bar-mini">
                <div class="progress-bar-fill" id="onboarding-progress-fill" style="width: 0%"></div>
            </div>
            <div class="progress-text" id="onboarding-progress-text">0/3 complétés</div>
        </div>
    </div>
    
    <!-- Image Modal -->
    <div class="image-modal" id="image-modal" role="dialog" aria-modal="true" aria-label="Image en plein écran" onclick="closeImageModal()">
        <button class="image-modal-close" onclick="closeImageModal()" aria-label="Fermer l'image">
            <span aria-hidden="true">×</span>
        </button>
        <img id="modal-image" src="" alt="Image agrandie">
    </div>
    
    <!-- Search Overlay -->
    <div class="search-overlay" id="search-overlay" role="dialog" aria-modal="true" aria-label="Recherche">
        <div class="search-container">
            <div class="search-header">
                <div class="search-input-wrapper">
                    <svg class="search-icon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                        <circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/>
                    </svg>
                    <input 
                        type="text" 
                        class="search-input" 
                        id="search-input" 
                        placeholder="Rechercher dans tes contacts et posts..."
                        autocomplete="off"
                        aria-label="Rechercher"
                    >
                </div>
                <button class="search-close-btn" onclick="closeSearch()" aria-label="Fermer la recherche" type="button">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                        <line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/>
                    </svg>
                </button>
            </div>
            
            <div class="search-tabs">
                <button class="search-tab active" data-type="all" onclick="setSearchType('all')" type="button">Tout</button>
                <button class="search-tab" data-type="contacts" onclick="setSearchType('contacts')" type="button">Contacts</button>
                <button class="search-tab" data-type="posts" onclick="setSearchType('posts')" type="button">Posts</button>
            </div>
            
            <div class="search-results" id="search-results">
                <div class="search-hint">
                    <p>Tape au moins 2 caractères pour rechercher</p>
                    <p style="margin-top: var(--space-2);">Raccourci : <kbd>Ctrl</kbd> + <kbd>K</kbd></p>
                </div>
            </div>
        </div>
    </div>
    
    <div class="app-shell">
        <!-- HEADER — Professional Top Bar -->
        <header class="app-header" id="app-header">
            <!-- Brand / Logo -->
            <a href="/" class="header-brand" aria-label="Cinq — Retour à l'accueil">
                <div class="header-logo-icon">
                    <span class="header-logo-number" aria-hidden="true">5</span>
                </div>
                <span class="header-logo-text">cinq</span>
            </a>
            
            <h1 class="sr-only">Cinq — Ton espace intime</h1>
            
            <!-- Actions -->
            <div class="header-actions">
                <!-- Starred Messages Button -->
                <a href="/starred.html" class="header-action-btn" aria-label="Messages favoris" title="Messages favoris">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                        <polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/>
                    </svg>
                </a>
                
                <!-- Search Button -->
                <button class="header-action-btn" id="search-btn" onclick="openSearch()" aria-label="Rechercher" type="button">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                        <circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/>
                    </svg>
                </button>
                
                <!-- Theme Toggle -->
                <button class="theme-toggle" id="theme-toggle" onclick="toggleTheme()" aria-label="Basculer entre mode clair/sombre" type="button">
                    <svg class="theme-toggle-icon icon-sun" aria-hidden="true" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <circle cx="12" cy="12" r="5"/>
                        <line x1="12" y1="1" x2="12" y2="3"/>
                        <line x1="12" y1="21" x2="12" y2="23"/>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/>
                        <line x1="1" y1="12" x2="3" y2="12"/>
                        <line x1="21" y1="12" x2="23" y2="12"/>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/>
                    </svg>
                    <svg class="theme-toggle-icon icon-moon" aria-hidden="true" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/>
                    </svg>
                </button>
                
                <!-- Notifications -->
                <button class="notification-btn" id="notification-btn" onclick="window.CinqNotifications?.toggleNotificationCenter()" aria-label="Voir les notifications" type="button">
                    <svg aria-hidden="true" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"/>
                        <path d="M13.73 21a2 2 0 0 1-3.46 0"/>
                    </svg>
                    <span id="notification-badge" class="notification-badge hidden" aria-live="polite">0</span>
                </button>
                
                <div class="header-divider" aria-hidden="true"></div>
                
                <!-- User Avatar -->
                <button class="header-avatar online" id="header-avatar" onclick="switchTab('profil')" aria-label="Accéder à mon profil" type="button">
                    <span id="header-avatar-initial" aria-hidden="true">?</span>
                </button>
            </div>
        </header>
        
        <!-- MAIN CONTENT -->
        <main class="app-content" id="main-content">
            <!-- TAB: FEED (DEFAULT) -->
            <section class="tab-panel active" id="tab-feed" role="tabpanel" aria-labelledby="nav-feed" tabindex="0">
                <!-- Stories Bar -->
                <div class="stories-bar" id="stories-bar" role="region" aria-label="Stories de tes proches">
                    <!-- Add story button -->
                    <a href="/stories.html" class="story-ring-item own" aria-label="Ajouter une story">
                        <div class="story-ring-wrapper add-story">
                            <div class="story-ring-avatar" id="story-own-avatar">?</div>
                            <span class="story-ring-add-icon" aria-hidden="true">+</span>
                        </div>
                        <span class="story-ring-label">Ta story</span>
                    </a>
                    <!-- Stories will be loaded here -->
                    <div id="stories-list-inline"></div>
                </div>
                
                <!-- Composer -->
                <div class="composer" role="region" aria-label="Créer un nouveau post">
                    <div class="composer-header">
                        <div class="composer-avatar" id="composer-avatar" aria-hidden="true">?</div>
                        <span class="composer-user" id="composer-user">Chargement...</span>
                    </div>
                    <label for="post-content" class="sr-only">Contenu de votre post</label>
                    <textarea 
                        class="composer-textarea" 
                        id="post-content" 
                        placeholder="Un truc marrant ? Une pensée ? Un coup de gueule ? C'est entre vous..."
                        maxlength="280"
                        aria-describedby="char-count"
                    ></textarea>
                    <div class="image-preview" id="image-preview" role="region" aria-label="Aperçu de l'image">
                        <img id="preview-img" src="" alt="Aperçu de l'image à poster">
                        <button class="image-preview-remove" onclick="removeImage()" aria-label="Supprimer l'image" type="button">
                            <span aria-hidden="true">×</span>
                        </button>
                        <div id="upload-progress" role="status" aria-live="polite" style="display:none;position:absolute;bottom:0;left:0;right:0;background:rgba(0,0,0,0.7);padding:var(--space-2);text-align:center;font-size:var(--text-xs);">
                            <span aria-hidden="true">⏳</span> Upload en cours...
                        </div>
                    </div>
                    <label for="file-input" class="sr-only">Ajouter une image au post</label>
                    <input type="file" id="file-input" accept="image/jpeg,image/png,image/gif,image/webp" style="display:none;" onchange="handleFileSelect(event)" aria-describedby="file-input-desc">
                    <span id="file-input-desc" class="sr-only">Formats acceptés: JPEG, PNG, GIF, WebP. Taille max: 5 Mo</span>
                    <div class="composer-footer">
                        <div class="composer-actions">
                            <button class="composer-btn" onclick="triggerFileUpload()" type="button" aria-label="Ajouter une photo">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                                    <rect x="3" y="3" width="18" height="18" rx="2"/><circle cx="8.5" cy="8.5" r="1.5"/><polyline points="21 15 16 10 5 21"/>
                                </svg>
                                <span>Photo</span>
                            </button>
                        </div>
                        <div style="display:flex;align-items:center;gap:var(--space-4);">
                            <span class="char-count" id="char-count" aria-live="polite" aria-atomic="true">0/280</span>
                            <button class="post-btn btn-ripple glow-hover" id="post-btn" onclick="submitPost()" disabled aria-label="Publier le post" type="button">Envoyer</button>
                        </div>
                    </div>
                </div>
                
                <!-- Posts List -->
                <div class="posts-list" id="posts-list" role="feed" aria-label="Fil d'actualités" aria-busy="true">
                    <div class="loading-spinner" style="margin:var(--space-8) auto;" role="status" aria-label="Chargement des posts"></div>
                </div>
            </section>
            
            <!-- TAB: TES 5 -->
            <section class="tab-panel" id="tab-contacts" role="tabpanel" aria-labelledby="nav-contacts" tabindex="0" hidden>
                <h2 class="section-title">
                    Tes 5
                    <span class="contact-count" id="contact-count" aria-live="polite">0/5</span>
                </h2>
                <div class="contacts-grid" id="contacts-grid" role="list" aria-label="Liste de tes 5 contacts"></div>
                
                <button class="action-btn btn-ripple reveal" onclick="openGiftModal()" type="button">
                    <svg class="action-icon" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="var(--color-brand)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                        <rect x="3" y="8" width="18" height="13" rx="2"/><path d="M12 8v13"/><path d="M3 12h18"/><path d="M12 8c-2.5-3-6-2-6 0s3.5 2 6 0"/><path d="M12 8c2.5-3 6-2 6 0s-3.5 2-6 0"/>
                    </svg>
                    <div>
                        <div class="action-title">Offrir Cinq</div>
                        <div class="action-subtitle">Invite quelqu'un qui compte vraiment</div>
                    </div>
                </button>
                
                <!-- Archived Contacts Section -->
                <section class="archived-section" id="archived-section" style="display: none;" aria-labelledby="archived-title">
                    <div class="archived-header" id="archived-header" onclick="toggleArchivedSection()" role="button" aria-expanded="false" tabindex="0">
                        <h3 class="archived-title" id="archived-title">
                            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                                <rect x="3" y="3" width="18" height="18" rx="2"/><path d="M3 9h18"/><path d="M9 21V9"/>
                            </svg>
                            Archivés
                            <span class="archived-count" id="archived-count">0</span>
                        </h3>
                        <svg class="archived-toggle-icon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                            <polyline points="6 9 12 15 18 9"/>
                        </svg>
                    </div>
                    <div class="archived-list" id="archived-list" role="list" aria-label="Contacts archivés">
                        <!-- Archived contacts will be rendered here -->
                    </div>
                </section>
                
                <!-- Suggestions Section -->
                <section class="suggestions-section" id="suggestions-section" aria-labelledby="suggestions-title">
                    <div class="suggestions-header">
                        <h3 class="suggestions-title" id="suggestions-title">
                            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                                <path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M22 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/>
                            </svg>
                            Suggestions
                        </h3>
                    </div>
                    <div id="suggestions-list" role="list" aria-label="Suggestions d'amis d'amis">
                        <div class="suggestions-empty" id="suggestions-loading">
                            <span class="loading-spinner"></span>
                            Chargement des suggestions...
                        </div>
                    </div>
                </section>
            </section>
            
            <!-- TAB: PROFIL -->
            <section class="tab-panel" id="tab-profil" role="tabpanel" aria-labelledby="nav-profil" tabindex="0" hidden>
                <div class="profile-header">
                    <button class="profile-avatar" id="profile-avatar" onclick="document.getElementById('avatar-input').click()" type="button" aria-label="Changer ma photo de profil">
                        <span id="profile-avatar-initial" aria-hidden="true">?</span>
                        <div class="profile-avatar-overlay" aria-hidden="true">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <rect x="3" y="3" width="18" height="18" rx="2"/><circle cx="8.5" cy="8.5" r="1.5"/><polyline points="21 15 16 10 5 21"/>
                            </svg>
                        </div>
                    </button>
                    <label for="avatar-input" class="sr-only">Choisir une nouvelle photo de profil</label>
                    <input type="file" id="avatar-input" accept="image/jpeg,image/png,image/gif,image/webp" style="display:none;" onchange="uploadAvatar(this)" aria-describedby="avatar-input-desc">
                    <span id="avatar-input-desc" class="sr-only">Formats acceptés: JPEG, PNG, GIF, WebP. Taille max: 2 Mo</span>
                    <h2 class="profile-name" id="profile-name">Chargement...</h2>
                    <p class="profile-bio" id="profile-bio-display"></p>
                </div>
                
                <!-- Edit Profile -->
                <div class="settings-card" role="region" aria-labelledby="settings-profile-title">
                    <div class="settings-card-header" id="settings-profile-title">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="var(--color-brand)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                            <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/>
                        </svg>
                        <span>Modifier mon profil</span>
                    </div>
                    <div class="settings-field">
                        <label class="settings-label" for="profile-display-name">Pseudo</label>
                        <input type="text" id="profile-display-name" class="settings-input" placeholder="Ton pseudo..." maxlength="50" autocomplete="nickname">
                    </div>
                    <div class="settings-field">
                        <label class="settings-label" for="profile-bio">Bio</label>
                        <textarea id="profile-bio" class="settings-input" placeholder="Ce que tes proches savent déjà sur toi..." maxlength="500" rows="2" style="resize:vertical;min-height:60px;"></textarea>
                    </div>
                    <div class="settings-field">
                        <label class="settings-label" for="profile-birthday">🎂 Date de naissance</label>
                        <input type="date" id="profile-birthday" class="settings-input" style="color-scheme: dark;">
                        <p style="font-size: 0.75rem; color: var(--color-text-muted); margin-top: 0.25rem;">Tes proches verront ton anniversaire (pas l'année)</p>
                    </div>
                    <button onclick="saveProfile()" id="save-profile-btn" class="save-btn btn-ripple glow-hover" type="button">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true" style="vertical-align: middle; margin-right: 6px;">
                            <path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/>
                        </svg>
                        Enregistrer
                    </button>
                </div>
                
                <!-- Birthdays Calendar -->
                <div class="settings-card" role="region" aria-labelledby="settings-birthdays-title">
                    <div class="settings-card-header" id="settings-birthdays-title">
                        <span style="font-size: 1rem;">🎂</span>
                        <span>Anniversaires</span>
                    </div>
                    <a href="/birthdays.html" class="settings-btn" style="text-decoration: none;">
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                            <rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/>
                        </svg>
                        <div class="settings-btn-info">
                            <span class="settings-btn-title">Calendrier des anniversaires</span>
                            <span class="settings-btn-subtitle" id="upcoming-birthdays-hint">Ne rate plus aucun anniversaire</span>
                        </div>
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="var(--color-text-muted)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="margin-left: auto;">
                            <polyline points="9 18 15 12 9 6"/>
                        </svg>
                    </a>
                </div>
                
                <!-- Data & Actions -->
                <div class="settings-card" role="region" aria-labelledby="settings-data-title">
                    <div class="settings-card-header" id="settings-data-title">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="var(--color-brand)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                            <path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"/><polyline points="3.27 6.96 12 12.01 20.73 6.96"/><line x1="12" y1="22.08" x2="12" y2="12"/>
                        </svg>
                        <span>Mes données</span>
                    </div>
                    <button onclick="exportData()" id="export-data-btn" class="settings-btn" type="button">
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                            <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/>
                        </svg>
                        <div class="settings-btn-info">
                            <span class="settings-btn-title">Récupérer mes données</span>
                            <span class="settings-btn-subtitle">Tout ce qu'on a sur toi, dans un fichier</span>
                        </div>
                    </button>
                    <button onclick="logout()" class="settings-btn" type="button">
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                            <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" y1="12" x2="9" y2="12"/>
                        </svg>
                        <div class="settings-btn-info">
                            <span class="settings-btn-title">Déconnexion</span>
                            <span class="settings-btn-subtitle">À plus tard !</span>
                        </div>
                    </button>
                    <button onclick="openDeleteAccountModal()" class="settings-btn settings-btn-danger" type="button">
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                            <polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/><line x1="10" y1="11" x2="10" y2="17"/><line x1="14" y1="11" x2="14" y2="17"/>
                        </svg>
                        <div class="settings-btn-info">
                            <span class="settings-btn-title">Supprimer mon compte</span>
                            <span class="settings-btn-subtitle">On espère que tu reviendras</span>
                        </div>
                    </button>
                </div>
            </section>
        </main>
        
        <!-- BOTTOM NAV -->
        <nav id="bottom-nav" class="bottom-nav" role="tablist" aria-label="Navigation principale">
            <button class="nav-item active" id="nav-feed" data-tab="feed" onclick="switchTab('feed')" role="tab" aria-selected="true" aria-controls="tab-feed" type="button">
                <svg class="nav-icon" width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                    <path d="M4 11a9 9 0 0 1 9 9"/><path d="M4 4a16 16 0 0 1 16 16"/><circle cx="5" cy="19" r="1"/>
                </svg>
                <span class="nav-label">Feed</span>
            </button>
            <button class="nav-item" id="nav-contacts" data-tab="contacts" onclick="switchTab('contacts')" role="tab" aria-selected="false" aria-controls="tab-contacts" type="button">
                <svg class="nav-icon" width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                    <path d="M12 2L22 9L18 21H6L2 9L12 2Z"/>
                </svg>
                <span class="nav-label">Tes 5</span>
            </button>
            <button class="nav-item" id="nav-profil" data-tab="profil" onclick="switchTab('profil')" role="tab" aria-selected="false" aria-controls="tab-profil" type="button">
                <svg class="nav-icon" width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                    <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/>
                </svg>
                <span class="nav-label">Profil</span>
            </button>
        </nav>
    </div>
    
    <!-- Chat Overlay -->
    <div class="chat-overlay" id="chat-overlay" onclick="closeChat()" aria-hidden="true"></div>
    
    <!-- Chat Panel -->
    <div class="chat-panel" id="chat-panel" role="dialog" aria-modal="true" aria-labelledby="chat-contact-name" aria-hidden="true">
        <div class="chat-header">
            <div class="chat-contact-info">
                <div class="chat-contact-avatar" id="chat-contact-avatar" aria-hidden="true">?</div>
                <div>
                    <h2 class="chat-contact-name" id="chat-contact-name"></h2>
                    <div class="chat-contact-status" id="chat-contact-status"></div>
                </div>
            </div>
            <div style="display: flex; align-items: center; gap: var(--space-2);">
                <button class="chat-mute-btn" id="chat-mute-btn" onclick="openMuteModal()" type="button" aria-label="Mettre en sourdine" title="Sourdine">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true" id="mute-icon">
                        <path d="M11 5L6 9H2v6h4l5 4V5z"/>
                        <line x1="23" y1="9" x2="17" y2="15"/>
                        <line x1="17" y1="9" x2="23" y2="15"/>
                    </svg>
                </button>
                <button class="chat-archive-btn" id="chat-archive-btn" onclick="toggleArchiveContact()" type="button" aria-label="Archiver cette conversation" title="Archiver">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                        <rect x="3" y="3" width="18" height="18" rx="2"/><path d="M3 9h18"/><path d="M9 21V9"/>
                    </svg>
                </button>
                <button class="chat-note-btn" id="chat-note-btn" onclick="openPrivateNoteModal()" type="button" aria-label="Note privée" title="Note privée">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                        <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/><polyline points="10 9 9 9 8 9"/>
                    </svg>
                    <span class="note-indicator"></span>
                </button>
                <button class="chat-header-pin-btn" id="chat-pin-btn" onclick="togglePinnedMessagesSection()" type="button" aria-label="Messages épinglés" aria-expanded="false">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                        <line x1="12" y1="17" x2="12" y2="22"/><path d="M5 17h14v-1.76a2 2 0 0 0-1.11-1.79l-1.78-.9A2 2 0 0 1 15 10.76V6h1a2 2 0 0 0 0-4H8a2 2 0 0 0 0 4h1v4.76a2 2 0 0 1-1.11 1.79l-1.78.9A2 2 0 0 0 5 15.24Z"/>
                    </svg>
                    <span class="pin-count" id="pin-count" style="display: none;">0</span>
                </button>
                <button class="chat-export-btn" id="chat-export-btn" onclick="openExportModal()" type="button" aria-label="Exporter la conversation" title="Exporter">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                        <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/>
                    </svg>
                </button>
                <button class="chat-close" onclick="closeChat()" type="button" aria-label="Fermer la conversation">
                    <span aria-hidden="true">×</span>
                </button>
            </div>
        </div>
        <!-- Pinned Messages Section -->
        <div class="pinned-messages-section" id="pinned-messages-section" aria-label="Messages épinglés">
            <div class="pinned-messages-header">
                <div class="pinned-messages-title">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                        <line x1="12" y1="17" x2="12" y2="22"/><path d="M5 17h14v-1.76a2 2 0 0 0-1.11-1.79l-1.78-.9A2 2 0 0 1 15 10.76V6h1a2 2 0 0 0 0-4H8a2 2 0 0 0 0 4h1v4.76a2 2 0 0 1-1.11 1.79l-1.78.9A2 2 0 0 0 5 15.24Z"/>
                    </svg>
                    Messages épinglés
                </div>
                <button class="pinned-messages-toggle" onclick="togglePinnedMessagesSection()" type="button" aria-label="Fermer">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                        <polyline points="18 15 12 9 6 15"/>
                    </svg>
                </button>
            </div>
            <div class="pinned-messages-list" id="pinned-messages-list">
                <!-- Pinned messages will be rendered here -->
            </div>
        </div>
        <div class="chat-messages" id="chat-messages" role="log" aria-live="polite" aria-label="Messages de la conversation"></div>
        <!-- Quick Replies -->
        <div class="quick-replies" id="quick-replies" role="group" aria-label="Réponses rapides">
            <button class="quick-reply-btn" onclick="sendQuickReply('Oui 👍')" type="button">Oui 👍</button>
            <button class="quick-reply-btn" onclick="sendQuickReply('Non 👎')" type="button">Non 👎</button>
            <button class="quick-reply-btn" onclick="sendQuickReply('OK ✓')" type="button">OK ✓</button>
            <button class="quick-reply-btn" onclick="sendQuickReply('Merci ❤️')" type="button">Merci ❤️</button>
            <button class="quick-reply-btn" onclick="sendQuickReply('À plus !')" type="button">À plus !</button>
            <button class="quick-reply-btn emoji-only" onclick="sendQuickReply('😂')" type="button" aria-label="Rire">😂</button>
            <button class="quick-reply-btn emoji-only" onclick="sendQuickReply('❤️')" type="button" aria-label="Cœur">❤️</button>
            <button class="quick-reply-btn emoji-only" onclick="sendQuickReply('👀')" type="button" aria-label="Yeux">👀</button>
            <button class="quick-replies-toggle" id="quick-replies-toggle" onclick="toggleQuickReplies()" type="button" aria-label="Masquer les réponses rapides" aria-expanded="true">
                <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                    <polyline points="18 15 12 9 6 15"/>
                </svg>
            </button>
        </div>
        <div class="chat-input-area" id="chat-input-area">
            <button class="ping-btn" onclick="sendPing()" type="button" aria-label="Envoyer un coucou">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                    <path d="M12 2L22 9L18 21H6L2 9L12 2Z"/>
                </svg>
            </button>
            <button class="voice-btn" id="voice-btn" onclick="toggleVoiceRecording()" type="button" aria-label="Enregistrer un message vocal">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true" id="voice-icon">
                    <path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"/>
                    <path d="M19 10v2a7 7 0 0 1-14 0v-2"/>
                    <line x1="12" y1="19" x2="12" y2="23"/>
                    <line x1="8" y1="23" x2="16" y2="23"/>
                </svg>
                <span class="voice-timer" id="voice-timer">0:00</span>
            </button>
            <button class="attach-btn" id="attach-btn" onclick="document.getElementById('attach-input').click()" type="button" aria-label="Joindre un fichier">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                    <path d="M21.44 11.05l-9.19 9.19a6 6 0 0 1-8.49-8.49l9.19-9.19a4 4 0 0 1 5.66 5.66l-9.2 9.19a2 2 0 0 1-2.83-2.83l8.49-8.48"/>
                </svg>
            </button>
            <input type="file" class="attach-input" id="attach-input" accept=".pdf,.doc,.docx,.xls,.xlsx,.ppt,.pptx,.txt,.csv,.rtf,.zip,.rar,.7z,.gz,.tar,.json,.xml" onchange="handleFileSelect(event)">
            <button class="sticker-btn" id="sticker-btn" onclick="toggleStickerPicker()" type="button" aria-label="Envoyer un sticker" aria-expanded="false" aria-controls="sticker-picker">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                    <circle cx="12" cy="12" r="10"/>
                    <path d="M8 14s1.5 2 4 2 4-2 4-2"/>
                    <line x1="9" y1="9" x2="9.01" y2="9"/>
                    <line x1="15" y1="9" x2="15.01" y2="9"/>
                </svg>
            </button>
            <button class="gif-btn giphy-trigger-btn" id="gif-btn" onclick="toggleGifPicker()" type="button" aria-label="Envoyer un GIF">
                GIF
            </button>
            <button class="location-btn" id="location-btn" onclick="sendLocation()" type="button" aria-label="Partager ma position">
                📍
            </button>
            <!-- Sticker Picker -->
            <div class="sticker-picker" id="sticker-picker" role="dialog" aria-modal="false" aria-labelledby="sticker-picker-title">
                <div class="sticker-picker-header">
                    <span class="sticker-picker-title" id="sticker-picker-title">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                            <path d="M12 2L22 9L18 21H6L2 9L12 2Z"/>
                        </svg>
                        Stickers Cinq
                    </span>
                    <button class="sticker-picker-close" onclick="closeStickerPicker()" type="button" aria-label="Fermer le sélecteur de stickers">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                            <line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/>
                        </svg>
                    </button>
                </div>
                <div class="sticker-grid" id="sticker-grid" role="listbox" aria-label="Liste des stickers">
                    <button class="sticker-item" onclick="sendSticker('cinq')" type="button" role="option" aria-label="Sticker Cinq">
                        <img src="/assets/stickers/cinq.svg" alt="Cinq" loading="lazy">
                    </button>
                    <button class="sticker-item" onclick="sendSticker('love')" type="button" role="option" aria-label="Sticker Cœur">
                        <img src="/assets/stickers/love.svg" alt="Cœur" loading="lazy">
                    </button>
                    <button class="sticker-item" onclick="sendSticker('hug')" type="button" role="option" aria-label="Sticker Câlin">
                        <img src="/assets/stickers/hug.svg" alt="Câlin" loading="lazy">
                    </button>
                    <button class="sticker-item" onclick="sendSticker('laugh')" type="button" role="option" aria-label="Sticker Rire">
                        <img src="/assets/stickers/laugh.svg" alt="Rire" loading="lazy">
                    </button>
                    <button class="sticker-item" onclick="sendSticker('thinking')" type="button" role="option" aria-label="Sticker Pensif">
                        <img src="/assets/stickers/thinking.svg" alt="Pensif" loading="lazy">
                    </button>
                    <button class="sticker-item" onclick="sendSticker('fire')" type="button" role="option" aria-label="Sticker Feu">
                        <img src="/assets/stickers/fire.svg" alt="Feu" loading="lazy">
                    </button>
                    <button class="sticker-item" onclick="sendSticker('star')" type="button" role="option" aria-label="Sticker Étoile">
                        <img src="/assets/stickers/star.svg" alt="Étoile" loading="lazy">
                    </button>
                    <button class="sticker-item" onclick="sendSticker('party')" type="button" role="option" aria-label="Sticker Fête">
                        <img src="/assets/stickers/party.svg" alt="Fête" loading="lazy">
                    </button>
                    <button class="sticker-item" onclick="sendSticker('cool')" type="button" role="option" aria-label="Sticker Cool">
                        <img src="/assets/stickers/cool.svg" alt="Cool" loading="lazy">
                    </button>
                    <button class="sticker-item" onclick="sendSticker('sleepy')" type="button" role="option" aria-label="Sticker Fatigué">
                        <img src="/assets/stickers/sleepy.svg" alt="Fatigué" loading="lazy">
                    </button>
                    <button class="sticker-item" onclick="sendSticker('coffee')" type="button" role="option" aria-label="Sticker Café">
                        <img src="/assets/stickers/coffee.svg" alt="Café" loading="lazy">
                    </button>
                    <button class="sticker-item" onclick="sendSticker('sad')" type="button" role="option" aria-label="Sticker Triste">
                        <img src="/assets/stickers/sad.svg" alt="Triste" loading="lazy">
                    </button>
                </div>
            </div>
            <label for="chat-input" class="sr-only">Écrire un message</label>
            <input type="text" class="chat-input" id="chat-input" placeholder="Écris quelque chose..." maxlength="280" autocomplete="off">
            <span class="char-count chat-char-count" id="chat-char-count" aria-live="polite">0/280</span>
            <div class="file-preview" id="file-preview">
                <div class="file-preview-icon" id="file-preview-icon">📄</div>
                <div class="file-preview-info">
                    <div class="file-preview-name" id="file-preview-name">fichier.pdf</div>
                    <div class="file-preview-meta" id="file-preview-meta">PDF • 1.2 Mo</div>
                </div>
                <button class="file-preview-delete" onclick="cancelFileAttachment()" type="button" aria-label="Supprimer le fichier">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                        <line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/>
                    </svg>
                </button>
            </div>
            <div class="voice-preview" id="voice-preview">
                <div class="voice-preview-waveform" id="voice-preview-waveform"></div>
                <span class="voice-preview-duration" id="voice-preview-duration">0:00</span>
                <button class="voice-preview-delete" onclick="cancelVoiceMessage()" type="button" aria-label="Supprimer l'enregistrement">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                        <line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/>
                    </svg>
                </button>
            </div>
            <button class="schedule-btn" id="schedule-btn" onclick="openScheduleModal()" type="button" aria-label="Programmer un message" title="Programmer un message">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                    <circle cx="12" cy="12" r="10"/>
                    <polyline points="12 6 12 12 16 14"/>
                </svg>
                <span class="scheduled-count" id="scheduled-count" style="display: none;">0</span>
            </button>
            <button class="chat-send" onclick="sendMessage()" id="send-btn" disabled type="button" aria-label="Envoyer le message">
                <span aria-hidden="true">→</span>
            </button>
        </div>
        <div class="voice-cancel-hint" id="voice-cancel-hint">Relâche pour annuler</div>
        <!-- Scheduled Messages Indicator -->
        <div class="chat-scheduled-indicator" id="chat-scheduled-indicator" onclick="openScheduleModal()">
            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                <circle cx="12" cy="12" r="10"/>
                <polyline points="12 6 12 12 16 14"/>
            </svg>
            <span class="chat-scheduled-text" id="chat-scheduled-text">1 message programmé</span>
        </div>
    </div>
    
    <!-- Schedule Message Modal -->
    <div class="modal-overlay" id="schedule-modal" role="dialog" aria-modal="true" aria-labelledby="schedule-modal-title" aria-hidden="true">
        <div class="modal schedule-modal">
            <h2 class="modal-title" id="schedule-modal-title">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="var(--color-brand)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true" style="vertical-align: middle; margin-right: 8px;">
                    <circle cx="12" cy="12" r="10"/>
                    <polyline points="12 6 12 12 16 14"/>
                </svg>
                Programmer un message
            </h2>
            
            <div class="schedule-form">
                <div class="schedule-input-group">
                    <label for="schedule-message">Message</label>
                    <textarea class="schedule-input schedule-textarea" id="schedule-message" placeholder="Écris ton message ici..." maxlength="280"></textarea>
                    <span class="char-count schedule-char-count" id="schedule-char-count">0/280</span>
                </div>
                
                <div class="schedule-input-group">
                    <label>Envoyer le</label>
                    <div class="schedule-datetime">
                        <input type="date" class="schedule-input" id="schedule-date">
                        <input type="time" class="schedule-input" id="schedule-time">
                    </div>
                    <div class="schedule-quick-btns">
                        <button class="schedule-quick-btn" onclick="setQuickSchedule('1h')" type="button">Dans 1h</button>
                        <button class="schedule-quick-btn" onclick="setQuickSchedule('3h')" type="button">Dans 3h</button>
                        <button class="schedule-quick-btn" onclick="setQuickSchedule('tomorrow-9')" type="button">Demain 9h</button>
                        <button class="schedule-quick-btn" onclick="setQuickSchedule('tomorrow-20')" type="button">Demain 20h</button>
                    </div>
                </div>
                
                <button class="save-btn btn-ripple glow-hover" style="width:100%;" onclick="scheduleMessage()" id="schedule-submit-btn" type="button">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true" style="vertical-align: middle; margin-right: 6px;">
                        <circle cx="12" cy="12" r="10"/>
                        <polyline points="12 6 12 12 16 14"/>
                    </svg>
                    Programmer
                </button>
            </div>
            
            <!-- Scheduled Messages List -->
            <div class="scheduled-list-section" id="scheduled-list-section">
                <div class="scheduled-list-header">
                    <div class="scheduled-list-title">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                            <rect x="3" y="4" width="18" height="18" rx="2" ry="2"/>
                            <line x1="16" y1="2" x2="16" y2="6"/>
                            <line x1="8" y1="2" x2="8" y2="6"/>
                            <line x1="3" y1="10" x2="21" y2="10"/>
                        </svg>
                        Messages programmés
                    </div>
                </div>
                <div class="scheduled-list" id="scheduled-list" role="list">
                    <!-- Scheduled messages will be rendered here -->
                </div>
            </div>
            
            <button style="margin-top:var(--space-4);background:none;border:none;color:var(--color-text-muted);cursor:pointer;width:100%;padding:var(--space-2);" onclick="closeScheduleModal()" type="button">Fermer</button>
        </div>
    </div>
    
    <!-- Gift Modal -->
    <div class="modal-overlay" id="gift-modal" role="dialog" aria-modal="true" aria-labelledby="gift-modal-title" aria-hidden="true">
        <div class="modal">
            <h2 class="modal-title" id="gift-modal-title">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="var(--color-brand)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true" style="vertical-align: middle; margin-right: 8px;">
                    <rect x="3" y="8" width="18" height="13" rx="2"/><path d="M12 8v13"/><path d="M3 12h18"/><path d="M12 8c-2.5-3-6-2-6 0s3.5 2 6 0"/><path d="M12 8c2.5-3 6-2 6 0s-3.5 2-6 0"/>
                </svg>
                Offrir Cinq
            </h2>
            <p style="color:var(--color-text-muted);margin-bottom:var(--space-4);">Choisis bien. Cinq n'est pas pour tout le monde.</p>
            <div id="gift-content">
                <button class="save-btn btn-ripple glow-hover" style="width:100%;" onclick="createGift()" type="button">Générer un code</button>
            </div>
            <button style="margin-top:var(--space-4);background:none;border:none;color:var(--color-text-muted);cursor:pointer;width:100%;padding:var(--space-2);" onclick="closeGiftModal()" type="button">Fermer</button>
        </div>
    </div>
    
    <!-- Mute Contact Modal -->
    <div class="modal-overlay" id="mute-modal" role="dialog" aria-modal="true" aria-labelledby="mute-modal-title" aria-hidden="true">
        <div class="modal mute-modal">
            <h2 class="modal-title" id="mute-modal-title">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                    <path d="M11 5L6 9H2v6h4l5 4V5z"/>
                    <line x1="23" y1="9" x2="17" y2="15"/>
                    <line x1="17" y1="9" x2="23" y2="15"/>
                </svg>
                Notifications en sourdine
            </h2>
            <p style="color:var(--color-text-muted);margin-bottom:var(--space-3);font-size:var(--text-sm);">
                Tu ne recevras plus de notifications pour <strong id="mute-contact-name"></strong>
            </p>
            <div class="mute-current-status hidden" id="mute-current-status">
                <span>🔇</span>
                <span id="mute-current-text">En sourdine jusqu'à...</span>
            </div>
            <div class="mute-options" id="mute-options">
                <button class="mute-option-btn" onclick="setMuteDuration('1h')" type="button" data-duration="1h">
                    <span>1 heure</span>
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><path d="M12 6v6l4 2"/></svg>
                </button>
                <button class="mute-option-btn" onclick="setMuteDuration('8h')" type="button" data-duration="8h">
                    <span>8 heures</span>
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><path d="M12 6v6l4 2"/></svg>
                </button>
                <button class="mute-option-btn" onclick="setMuteDuration('24h')" type="button" data-duration="24h">
                    <span>24 heures</span>
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><path d="M12 6v6l4 2"/></svg>
                </button>
                <button class="mute-option-btn" onclick="setMuteDuration('forever')" type="button" data-duration="forever">
                    <span>Indéfiniment</span>
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><line x1="8" y1="12" x2="16" y2="12"/></svg>
                </button>
            </div>
            <button id="unmute-btn" class="save-btn" style="width:100%;background:var(--color-success);display:none;" onclick="setMuteDuration('off')" type="button">
                <span style="display:flex;align-items:center;justify-content:center;gap:var(--space-2);">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"/><path d="M19.07 4.93a10 10 0 0 1 0 14.14"/><path d="M15.54 8.46a5 5 0 0 1 0 7.07"/></svg>
                    Réactiver les notifications
                </span>
            </button>
            <button style="margin-top:var(--space-3);background:none;border:none;color:var(--color-text-muted);cursor:pointer;width:100%;padding:var(--space-2);" onclick="closeMuteModal()" type="button">Annuler</button>
        </div>
    </div>
    
    <!-- Add Contact Modal -->
    <div class="modal-overlay" id="add-contact-modal" role="dialog" aria-modal="true" aria-labelledby="add-contact-modal-title" aria-hidden="true">
        <div class="modal">
            <h2 class="modal-title" id="add-contact-modal-title"><span aria-hidden="true">➕</span> Ajouter un·e proche</h2>
            <p style="color:var(--color-text-muted);margin-bottom:var(--space-4);">Demande-lui son ID (il l'a dans son profil)</p>
            <label for="contact-id-input" class="sr-only">ID du contact à ajouter</label>
            <input type="text" id="contact-id-input" class="settings-input" placeholder="Colle l'ID ici" style="margin-bottom:var(--space-4);" autocomplete="off" aria-describedby="add-contact-error">
            <div id="add-contact-error" role="alert" style="color:var(--color-error);font-size:var(--text-sm);margin-bottom:var(--space-4);display:none;"></div>
            <button class="save-btn" style="width:100%;" onclick="addContact()" id="add-contact-btn" type="button">Ajouter</button>
            <div style="margin-top:var(--space-5);padding-top:var(--space-5);border-top:1px solid var(--color-border);">
                <p id="my-id-label" style="font-size:var(--text-xs);color:var(--color-text-muted);margin-bottom:var(--space-2);">Ton ID (à partager) :</p>
                <code id="my-id" aria-labelledby="my-id-label" style="font-size:var(--text-xs);word-break:break-all;display:block;background:var(--color-bg-tertiary);padding:var(--space-3);border-radius:var(--radius-lg);border:1px solid var(--color-border);"></code>
                <button onclick="copyMyId()" type="button" aria-label="Copier mon ID dans le presse-papier" style="margin-top:var(--space-2);padding:var(--space-2) var(--space-4);background:var(--color-bg-tertiary);border:1px solid var(--color-border);border-radius:var(--radius-lg);color:var(--color-text-primary);cursor:pointer;font-size:var(--text-sm);display:flex;align-items:center;gap:var(--space-2);">
                    <span aria-hidden="true">📋</span> <span id="copy-id-text">Copier mon ID</span>
                </button>
            </div>
            <button style="margin-top:var(--space-4);background:none;border:none;color:var(--color-text-muted);cursor:pointer;width:100%;padding:var(--space-2);" onclick="closeAddContactModal()" type="button">Fermer</button>
        </div>
    </div>
    
    <!-- Delete Account Modal -->
    <div class="modal-overlay" id="delete-account-modal" role="alertdialog" aria-modal="true" aria-labelledby="delete-modal-title" aria-describedby="delete-modal-desc" aria-hidden="true">
        <div class="modal">
            <h2 class="modal-title" id="delete-modal-title" style="color:var(--color-error);">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true" style="vertical-align: middle; margin-right: 8px;">
                    <polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/><line x1="10" y1="11" x2="10" y2="17"/><line x1="14" y1="11" x2="14" y2="17"/>
                </svg>
                Supprimer mon compte
            </h2>
            <p id="delete-modal-desc" style="color:var(--color-text-muted);margin-bottom:var(--space-4);">Cette action est <strong style="color:var(--color-error);">définitive et irréversible</strong>.</p>
            <div style="background:var(--color-error-muted);border:1px solid var(--color-error);border-radius:var(--radius-lg);padding:var(--space-4);margin-bottom:var(--space-4);" role="alert">
                <p style="font-size:var(--text-sm);color:var(--color-text-primary);margin-bottom:var(--space-2);"><strong>Seront supprimés :</strong></p>
                <ul style="font-size:var(--text-xs);color:var(--color-text-secondary);margin:0;padding-left:var(--space-5);">
                    <li>Ton profil et toutes tes infos</li>
                    <li>Tes 5 contacts</li>
                    <li>Tous tes messages envoyés et reçus</li>
                    <li>Tous tes posts</li>
                </ul>
            </div>
            <label for="delete-confirmation-input" style="font-size:var(--text-sm);margin-bottom:var(--space-3);display:block;">Pour confirmer, tape <strong style="color:var(--color-error);">SUPPRIMER</strong> :</label>
            <input type="text" id="delete-confirmation-input" class="settings-input" placeholder="SUPPRIMER" autocomplete="off" style="text-align:center;letter-spacing:0.1em;margin-bottom:var(--space-4);" aria-describedby="delete-account-error">
            <div id="delete-account-error" role="alert" aria-live="assertive" style="color:var(--color-error);font-size:var(--text-sm);margin-bottom:var(--space-4);display:none;"></div>
            <button onclick="deleteAccount()" id="delete-account-btn" class="save-btn" type="button" style="width:100%;background:var(--color-error);box-shadow:0 2px 8px rgba(248,113,113,0.3);">Supprimer définitivement</button>
            <button style="margin-top:var(--space-4);background:none;border:none;color:var(--color-text-muted);cursor:pointer;width:100%;padding:var(--space-2);" onclick="closeDeleteAccountModal()" type="button">Annuler</button>
        </div>
    </div>

    <!-- Reminder Modal -->
    <div class="modal-overlay" id="reminder-modal" role="dialog" aria-modal="true" aria-labelledby="reminder-modal-title" aria-hidden="true">
        <div class="modal reminder-modal">
            <h2 class="modal-title" id="reminder-modal-title">
                <span aria-hidden="true">⏰</span>
                Programmer un rappel
            </h2>
            <div class="reminder-message-preview" id="reminder-message-preview">
                <!-- Message preview will be inserted here -->
            </div>
            <div class="reminder-quick-options">
                <button class="reminder-quick-btn" data-minutes="30" onclick="selectReminderQuick(30)" type="button">30 min</button>
                <button class="reminder-quick-btn" data-minutes="60" onclick="selectReminderQuick(60)" type="button">1 heure</button>
                <button class="reminder-quick-btn" data-minutes="180" onclick="selectReminderQuick(180)" type="button">3 heures</button>
                <button class="reminder-quick-btn" data-minutes="1440" onclick="selectReminderQuick(1440)" type="button">Demain</button>
                <button class="reminder-quick-btn" data-minutes="10080" onclick="selectReminderQuick(10080)" type="button">1 semaine</button>
                <button class="reminder-quick-btn" data-value="custom" onclick="toggleCustomReminder()" type="button">Autre...</button>
            </div>
            <div class="reminder-custom-time" id="reminder-custom-time" style="display:none;">
                <label for="reminder-datetime">Date et heure</label>
                <input type="datetime-local" id="reminder-datetime" class="reminder-datetime-input">
            </div>
            <label for="reminder-note" style="display:block;font-size:var(--text-sm);font-weight:500;color:var(--color-text-muted);margin-bottom:var(--space-2);">Note (optionnel)</label>
            <textarea id="reminder-note" class="reminder-note-input" placeholder="Ajouter une note..." maxlength="200"></textarea>
            <div class="reminder-actions">
                <button class="reminder-cancel-btn" onclick="closeReminderModal()" type="button">Annuler</button>
                <button class="reminder-save-btn" id="reminder-save-btn" onclick="saveReminder()" type="button" disabled>
                    <span aria-hidden="true">⏰</span> Créer le rappel
                </button>
            </div>
            <input type="hidden" id="reminder-message-id">
            <input type="hidden" id="reminder-selected-time">
        </div>
    </div>

    <!-- Private Note Modal -->
    <div class="modal-overlay" id="private-note-modal" role="dialog" aria-modal="true" aria-labelledby="private-note-modal-title" aria-hidden="true">
        <div class="modal">
            <h2 class="modal-title" id="private-note-modal-title">
                <span aria-hidden="true">📝</span>
                Note privée
            </h2>
            <p id="private-note-contact-name" style="font-size: var(--text-sm); color: var(--color-text-muted); margin-bottom: var(--space-4);"></p>
            <textarea 
                id="private-note-textarea" 
                class="private-note-textarea" 
                placeholder="Ajoute une note personnelle sur ce contact... (anniversaire, préférences, ce que tu veux retenir...)"
                maxlength="1000"
            ></textarea>
            <div class="private-note-hint">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                    <circle cx="12" cy="12" r="10"/><line x1="12" y1="16" x2="12" y2="12"/><line x1="12" y1="8" x2="12.01" y2="8"/>
                </svg>
                <span>Cette note est privée et visible uniquement par toi.</span>
            </div>
            <div style="display: flex; gap: var(--space-3); justify-content: flex-end; margin-top: var(--space-4);">
                <button class="modal-btn secondary" onclick="closePrivateNoteModal()" type="button">Annuler</button>
                <button class="modal-btn primary" id="save-private-note-btn" onclick="savePrivateNote()" type="button">
                    <span aria-hidden="true">💾</span> Enregistrer
                </button>
            </div>
        </div>
    </div>

    <!-- Export Conversation Modal -->
    <div class="modal-overlay" id="export-modal" role="dialog" aria-modal="true" aria-labelledby="export-modal-title" aria-hidden="true">
        <div class="modal">
            <h2 class="modal-title" id="export-modal-title">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="var(--color-brand)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                    <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/>
                </svg>
                Exporter la conversation
            </h2>
            <p id="export-contact-name" style="font-size: var(--text-sm); color: var(--color-text-muted); margin-bottom: var(--space-2);">Exporter l'historique complet avec <span id="export-contact-display"></span></p>
            
            <div class="export-options">
                <button class="export-option-btn" onclick="exportConversation('txt')" type="button">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/><polyline points="10 9 9 9 8 9"/>
                    </svg>
                    <div class="export-option-info">
                        <div class="export-option-title">Fichier texte (.txt)</div>
                        <div class="export-option-desc">Format simple, compatible partout</div>
                    </div>
                </button>
                
                <button class="export-option-btn" onclick="exportConversation('pdf')" type="button">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><path d="M10 12h4"/><path d="M10 16h4"/><path d="M10 20h4"/>
                    </svg>
                    <div class="export-option-info">
                        <div class="export-option-title">Document PDF</div>
                        <div class="export-option-desc">Format professionnel, imprimable</div>
                    </div>
                </button>
            </div>
            
            <div style="display: flex; justify-content: flex-end; margin-top: var(--space-4);">
                <button class="modal-btn secondary" onclick="closeExportModal()" type="button">Annuler</button>
            </div>
        </div>
    </div>

    <!-- Forward Message Modal -->
    <div class="modal-overlay" id="forward-modal" role="dialog" aria-modal="true" aria-labelledby="forward-modal-title" aria-hidden="true">
        <div class="modal forward-modal">
            <h2 class="modal-title" id="forward-modal-title">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="var(--color-brand)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                    <polyline points="15 17 20 12 15 7"/>
                    <path d="M4 18v-2a4 4 0 0 1 4-4h12"/>
                </svg>
                Transférer le message
            </h2>
            
            <div class="forward-message-preview" id="forward-message-preview">
                <div class="forward-preview-label">
                    <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/>
                    </svg>
                    Message à transférer
                </div>
                <p id="forward-message-content"></p>
            </div>
            
            <div class="forward-contacts-list" id="forward-contacts-list" role="listbox" aria-label="Sélectionner un destinataire">
                <!-- Contacts will be rendered here -->
            </div>
            
            <button class="forward-btn" id="forward-send-btn" onclick="confirmForwardMessage()" type="button" disabled>
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <polyline points="15 17 20 12 15 7"/>
                    <path d="M4 18v-2a4 4 0 0 1 4-4h12"/>
                </svg>
                Transférer
            </button>
            
            <button style="margin-top:var(--space-3);background:none;border:none;color:var(--color-text-muted);cursor:pointer;width:100%;padding:var(--space-2);" onclick="closeForwardModal()" type="button">Annuler</button>
            
            <input type="hidden" id="forward-message-id">
        </div>
    </div>

    <!-- GIPHY Integration -->
    <script src="/js/giphy.js"></script>

    <script>
        const API_URL = '/api';
        let session = null;
        let user = null;
        let contacts = [];
        let archivedContacts = [];
        let posts = [];
        let currentChatContact = null;
        let replyingTo = null; // Message being replied to
        let messagePollingInterval = null;
        let contactPollingInterval = null;
        let lastMessageIds = {};
        let unreadCounts = {};
        let currentImageUrl = null;
        
        // Search state
        let searchTimeout = null;
        let currentSearchType = 'all';
        let isSearching = false;
        
        // ===== SUPABASE REALTIME FOR TYPING INDICATORS =====
        const SUPABASE_URL = 'https://guioxfulihyehrwytxce.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imd1aW94ZnVsaWh5ZWhyd3l0eGNlIiwicm9sZSI6ImFub24iLCJpYXQiOjE3MzgyMzI4MTUsImV4cCI6MjA1MzgwODgxNX0.hvHZP-qmz4IZKhJLZqGYaTmaZGFMDShGjW9MYKSbklE';
        let supabaseClient = null;
        let typingChannel = null;

        // ===== TAB SWITCHING =====
        const tabOrder = ['feed', 'contacts', 'profil'];
        let currentTab = 'feed';
        
        function switchTab(tabName) {
            const currentIndex = tabOrder.indexOf(currentTab);
            const newIndex = tabOrder.indexOf(tabName);
            const direction = newIndex > currentIndex ? 'left' : 'right';
            
            // Add tap animation to nav item
            const navItem = document.querySelector(`.nav-item[data-tab="${tabName}"]`);
            if (navItem) {
                navItem.classList.add('tapped');
                setTimeout(() => navItem.classList.remove('tapped'), 300);
            }
            
            // Update nav with ARIA
            document.querySelectorAll('.nav-item').forEach(item => {
                const isActive = item.dataset.tab === tabName;
                item.classList.toggle('active', isActive);
                item.setAttribute('aria-selected', isActive ? 'true' : 'false');
            });
            
            // Update panels with slide animation
            document.querySelectorAll('.tab-panel').forEach(panel => {
                const isActive = panel.id === `tab-${tabName}`;
                
                if (isActive) {
                    panel.classList.remove('slide-left', 'slide-right');
                    panel.classList.add('active');
                    // Add directional slide class
                    panel.classList.add(direction === 'left' ? 'slide-left' : 'slide-right');
                    panel.hidden = false;
                    panel.removeAttribute('aria-hidden');
                } else {
                    panel.classList.remove('active', 'slide-left', 'slide-right');
                    panel.hidden = true;
                    panel.setAttribute('aria-hidden', 'true');
                }
            });
            
            currentTab = tabName;
            
            // Load data if needed
            if (tabName === 'contacts') loadContacts();
            if (tabName === 'feed') loadPosts();
        }
        
        // ===== KEYBOARD NAVIGATION FOR TABS =====
        document.addEventListener('DOMContentLoaded', () => {
            const tablist = document.querySelector('[role="tablist"]');
            if (tablist) {
                tablist.addEventListener('keydown', (e) => {
                    const tabs = Array.from(tablist.querySelectorAll('[role="tab"]'));
                    const currentIndex = tabs.findIndex(tab => tab === document.activeElement);
                    
                    let newIndex = currentIndex;
                    if (e.key === 'ArrowRight' || e.key === 'ArrowDown') {
                        newIndex = (currentIndex + 1) % tabs.length;
                        e.preventDefault();
                    } else if (e.key === 'ArrowLeft' || e.key === 'ArrowUp') {
                        newIndex = (currentIndex - 1 + tabs.length) % tabs.length;
                        e.preventDefault();
                    } else if (e.key === 'Home') {
                        newIndex = 0;
                        e.preventDefault();
                    } else if (e.key === 'End') {
                        newIndex = tabs.length - 1;
                        e.preventDefault();
                    }
                    
                    if (newIndex !== currentIndex) {
                        tabs[newIndex].focus();
                        tabs[newIndex].click();
                    }
                });
            }
        });

        // ===== HEADER SCROLL EFFECT =====
        (function() {
            const header = document.getElementById('app-header');
            if (!header) return;
            
            let lastScrollY = 0;
            let ticking = false;
            
            function updateHeader() {
                const scrollY = window.scrollY || window.pageYOffset;
                
                if (scrollY > 20) {
                    header.classList.add('scrolled');
                } else {
                    header.classList.remove('scrolled');
                }
                
                lastScrollY = scrollY;
                ticking = false;
            }
            
            window.addEventListener('scroll', function() {
                if (!ticking) {
                    requestAnimationFrame(updateHeader);
                    ticking = true;
                }
            }, { passive: true });
            
            // Initial check
            updateHeader();
        })();

        // ===== TOAST & AUTH =====
        // showToast(), getToken(), and authHeaders() now provided by /js/shared.js

        // ===== INIT =====
        async function init() {
            try {
                const sessionStr = localStorage.getItem('cinq_session');
                const userStr = localStorage.getItem('cinq_user');
                
                if (!sessionStr || !userStr) {
                    window.location.href = '/login.html';
                    return;
                }

                session = JSON.parse(sessionStr);
                user = JSON.parse(userStr);

                // Setup UI
                const initial = (user.email || '?')[0].toUpperCase();
                document.getElementById('header-avatar-initial').textContent = initial;
                document.getElementById('composer-avatar').textContent = initial;
                document.getElementById('composer-user').textContent = user.email?.split('@')[0] || 'Toi';
                document.getElementById('profile-avatar-initial').textContent = initial;
                document.getElementById('profile-name').textContent = user.email?.split('@')[0] || 'Utilisateur';

                setupComposer();
                setupChatInput();
                
                // Restore drafts if any
                restoreDraftPost();
                
                // Setup lazy loading
                setupLazyLoading();
                
                // Setup search
                initSearch();
                
                // Initialize Supabase client for realtime
                initSupabaseRealtime();
                
                // Load data
                await Promise.all([loadProfile(), loadContacts(), loadPosts(), loadStoriesBar()]);
                startPolling();
                initPushNotifications();
                
                // Check if new user and show onboarding
                initOnboarding();
                
            } catch (e) {
                console.error('Init error:', e);
                showToast({ type: 'error', title: 'Aïe', message: 'L\'app n\'a pas voulu démarrer. Réessaie ?' });
            }
        }

        // ===== LAZY LOADING (Performance Optimization) =====
        let lazyImageObserver = null;
        
        function setupLazyLoading() {
            if ('IntersectionObserver' in window) {
                lazyImageObserver = new IntersectionObserver(
                    (entries) => {
                        entries.forEach(entry => {
                            if (entry.isIntersecting) {
                                const img = entry.target;
                                const src = img.dataset.src;
                                if (src) {
                                    img.src = src;
                                    img.onload = () => {
                                        img.classList.add('loaded');
                                        img.closest('.lazy-image-container')?.classList.add('loaded');
                                    };
                                    img.onerror = () => {
                                        img.classList.add('error');
                                    };
                                    lazyImageObserver.unobserve(img);
                                }
                            }
                        });
                    },
                    {
                        root: null,
                        rootMargin: '50px',
                        threshold: 0.01
                    }
                );
            }
        }
        
        function observeLazyImages() {
            if (!lazyImageObserver) return;
            document.querySelectorAll('img.lazy-image[data-src]').forEach(img => {
                if (!img.src || img.src === '') {
                    lazyImageObserver.observe(img);
                }
            });
        }

        // ===== PROFILE =====
        async function loadProfile() {
            try {
                const res = await fetch(`${API_URL}/user-profile`, { headers: authHeaders() });
                const data = await res.json();
                
                if (data.profile) {
                    const name = data.profile.display_name || user?.email?.split('@')[0] || 'Utilisateur';
                    const initial = name.charAt(0).toUpperCase();
                    
                    document.getElementById('profile-display-name').value = data.profile.display_name || '';
                    document.getElementById('profile-bio').value = data.profile.bio || '';
                    document.getElementById('profile-birthday').value = data.profile.birthday || '';
                    document.getElementById('profile-name').textContent = name;
                    document.getElementById('profile-bio-display').textContent = data.profile.bio || '';
                    
                    // Update all avatars
                    updateAllAvatars(data.profile.avatar_url, initial);
                    
                    // Load upcoming birthdays hint
                    loadUpcomingBirthdaysHint();
                }
            } catch (e) {
                console.error('Load profile error:', e);
            }
        }
        
        function updateAllAvatars(avatarUrl, initial) {
            const avatarEls = [
                { el: document.getElementById('header-avatar'), initEl: document.getElementById('header-avatar-initial') },
                { el: document.getElementById('profile-avatar'), initEl: document.getElementById('profile-avatar-initial') },
                { el: document.getElementById('composer-avatar'), initEl: null }
            ];
            
            avatarEls.forEach(({ el, initEl }) => {
                if (!el) return;
                if (avatarUrl) {
                    if (initEl) initEl.style.display = 'none';
                    let img = el.querySelector('img');
                    if (!img) {
                        img = document.createElement('img');
                        el.appendChild(img);
                    }
                    img.src = avatarUrl;
                    img.alt = 'Avatar';
                } else {
                    const img = el.querySelector('img');
                    if (img) img.remove();
                    if (initEl) {
                        initEl.style.display = '';
                        initEl.textContent = initial;
                    } else {
                        el.textContent = initial;
                    }
                }
            });
        }
        
        async function uploadAvatar(input) {
            const file = input.files[0];
            if (!file) return;
            
            if (file.size > 2 * 1024 * 1024) {
                showToast({ type: 'error', title: 'Trop lourd !', message: 'Choisis une image de moins de 2 Mo' });
                return;
            }
            
            showToast({ type: 'info', title: 'On télécharge ta photo...' });
            
            try {
                const base64 = await new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.onload = () => resolve(reader.result);
                    reader.onerror = reject;
                    reader.readAsDataURL(file);
                });
                
                const res = await fetch(`${API_URL}/upload-avatar`, {
                    method: 'POST',
                    headers: authHeaders(),
                    body: JSON.stringify({ image: base64, contentType: file.type })
                });
                
                const data = await res.json();
                if (!res.ok) throw new Error(data.error || 'Erreur upload');
                
                const name = document.getElementById('profile-display-name').value || user?.email?.split('@')[0] || 'U';
                updateAllAvatars(data.avatarUrl, name.charAt(0).toUpperCase());
                showToast({ type: 'success', title: 'Nouvelle tête ! 📸' });
            } catch (e) {
                showToast({ type: 'error', title: 'Erreur', message: e.message });
            }
            
            input.value = '';
        }

        async function saveProfile() {
            const btn = document.getElementById('save-profile-btn');
            const displayName = document.getElementById('profile-display-name').value.trim();
            const bio = document.getElementById('profile-bio').value.trim();
            const birthday = document.getElementById('profile-birthday').value || null;
            
            btn.disabled = true;
            btn.textContent = 'Enregistrement...';
            
            try {
                const res = await fetch(`${API_URL}/user-profile`, {
                    method: 'PUT',
                    headers: authHeaders(),
                    body: JSON.stringify({ display_name: displayName || null, bio: bio || null, birthday })
                });
                
                if (!res.ok) throw new Error((await res.json()).error || 'Erreur');
                
                document.getElementById('profile-name').textContent = displayName || user?.email?.split('@')[0] || 'Utilisateur';
                document.getElementById('profile-bio-display').textContent = bio || '';
                showToast({ type: 'success', title: 'C\'est enregistré !' });
            } catch (e) {
                showToast({ type: 'error', title: 'Erreur', message: e.message });
            } finally {
                btn.disabled = false;
                btn.textContent = '💾 Enregistrer';
            }
        }
        
        // ===== BIRTHDAY HELPERS =====
        async function loadUpcomingBirthdaysHint() {
            try {
                const res = await fetch(`${API_URL}/contacts?action=birthdays`, { headers: authHeaders() });
                if (!res.ok) return;
                
                const data = await res.json();
                const contacts = data.contacts || [];
                const birthdays = contacts.filter(c => c.contact?.birthday);
                
                if (birthdays.length === 0) {
                    document.getElementById('upcoming-birthdays-hint').textContent = 'Aucun anniversaire enregistré';
                    return;
                }
                
                // Find next birthday
                const today = new Date();
                today.setHours(0, 0, 0, 0);
                
                const upcoming = birthdays.map(c => {
                    const [_, month, day] = c.contact.birthday.split('-').map(Number);
                    const thisYear = new Date(today.getFullYear(), month - 1, day);
                    
                    let nextBirthday = thisYear;
                    if (thisYear < today) {
                        nextBirthday = new Date(today.getFullYear() + 1, month - 1, day);
                    }
                    
                    const diffTime = nextBirthday - today;
                    const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                    
                    return { ...c, daysUntil: diffDays };
                }).sort((a, b) => a.daysUntil - b.daysUntil);
                
                const next = upcoming[0];
                const name = next.contact.display_name || next.contact.email?.split('@')[0] || 'Contact';
                
                if (next.daysUntil === 0) {
                    document.getElementById('upcoming-birthdays-hint').textContent = `🎉 ${name} fête son anniversaire aujourd'hui !`;
                } else if (next.daysUntil === 1) {
                    document.getElementById('upcoming-birthdays-hint').textContent = `Demain : anniversaire de ${name}`;
                } else if (next.daysUntil <= 7) {
                    document.getElementById('upcoming-birthdays-hint').textContent = `Dans ${next.daysUntil} jours : anniversaire de ${name}`;
                } else {
                    document.getElementById('upcoming-birthdays-hint').textContent = `${birthdays.length} anniversaire${birthdays.length > 1 ? 's' : ''} enregistré${birthdays.length > 1 ? 's' : ''}`;
                }
            } catch (e) {
                console.error('Load birthdays hint error:', e);
            }
        }

        // ===== DRAFTS SYSTEM =====
        const DRAFT_KEY_APP_POST = 'cinq_draft_post_app';
        const DRAFT_KEY_CHAT_PREFIX = 'cinq_draft_chat_';
        const DRAFT_SAVE_DELAY = 500; // ms
        let draftSaveTimeout = null;
        let chatDraftSaveTimeout = null;
        
        function saveDraftPost() {
            const textarea = document.getElementById('post-content');
            if (!textarea) return;
            
            const content = textarea.value.trim();
            if (content) {
                localStorage.setItem(DRAFT_KEY_APP_POST, JSON.stringify({
                    content: textarea.value,
                    imageUrl: currentImageUrl || null,
                    savedAt: Date.now()
                }));
            } else {
                localStorage.removeItem(DRAFT_KEY_APP_POST);
            }
        }
        
        function restoreDraftPost() {
            try {
                const saved = localStorage.getItem(DRAFT_KEY_APP_POST);
                if (!saved) return;
                
                const draft = JSON.parse(saved);
                const textarea = document.getElementById('post-content');
                const charCount = document.getElementById('char-count');
                const postBtn = document.getElementById('post-btn');
                
                if (draft.content && textarea) {
                    textarea.value = draft.content;
                    const len = draft.content.length;
                    charCount.textContent = `${len}/280`;
                    
                    charCount.classList.remove('warning', 'error');
                    if (len > 250) charCount.classList.add('error');
                    else if (len > 220) charCount.classList.add('warning');
                    
                    postBtn.disabled = len === 0 || len > 280;
                }
                
                if (draft.imageUrl) {
                    currentImageUrl = draft.imageUrl;
                    const preview = document.getElementById('image-preview');
                    const img = document.getElementById('preview-img');
                    if (preview && img) {
                        img.src = draft.imageUrl;
                        preview.classList.add('visible');
                    }
                }
                
                if (draft.content) {
                    showToast({ type: 'success', message: '📝 Brouillon restauré' });
                }
            } catch (e) {
                console.error('Error restoring post draft:', e);
                localStorage.removeItem(DRAFT_KEY_APP_POST);
            }
        }
        
        function clearDraftPost() {
            localStorage.removeItem(DRAFT_KEY_APP_POST);
        }
        
        function scheduleDraftPostSave() {
            clearTimeout(draftSaveTimeout);
            draftSaveTimeout = setTimeout(saveDraftPost, DRAFT_SAVE_DELAY);
        }
        
        // Chat drafts per contact
        function saveChatDraft(contactId, content) {
            if (!contactId) return;
            const key = DRAFT_KEY_CHAT_PREFIX + contactId;
            if (content && content.trim()) {
                localStorage.setItem(key, JSON.stringify({
                    content: content,
                    savedAt: Date.now()
                }));
            } else {
                localStorage.removeItem(key);
            }
        }
        
        function restoreChatDraft(contactId) {
            if (!contactId) return '';
            try {
                const key = DRAFT_KEY_CHAT_PREFIX + contactId;
                const saved = localStorage.getItem(key);
                if (!saved) return '';
                
                const draft = JSON.parse(saved);
                return draft.content || '';
            } catch (e) {
                return '';
            }
        }
        
        function clearChatDraft(contactId) {
            if (!contactId) return;
            localStorage.removeItem(DRAFT_KEY_CHAT_PREFIX + contactId);
        }
        
        function scheduleChatDraftSave(contactId, content) {
            clearTimeout(chatDraftSaveTimeout);
            chatDraftSaveTimeout = setTimeout(() => {
                saveChatDraft(contactId, content);
            }, DRAFT_SAVE_DELAY);
        }

        // ===== POSTS (FEED) =====
        // ===== MENTION AUTOCOMPLETE STATE =====
        let mentionAutocomplete = null;
        let mentionSearchTimeout = null;
        let mentionSelectedIndex = 0;
        let mentionStartPos = -1;
        let mentionTargetTextarea = null;
        
        function setupComposer() {
            const textarea = document.getElementById('post-content');
            const charCount = document.getElementById('char-count');
            const postBtn = document.getElementById('post-btn');
            
            // Create mention autocomplete dropdown for composer
            mentionAutocomplete = document.createElement('div');
            mentionAutocomplete.className = 'mention-autocomplete';
            mentionAutocomplete.id = 'mention-autocomplete';
            textarea.parentElement.style.position = 'relative';
            textarea.parentElement.appendChild(mentionAutocomplete);
            
            textarea.addEventListener('input', () => {
                const len = textarea.value.length;
                charCount.textContent = `${len}/280`;
                charCount.classList.remove('warning', 'error');
                if (len > 250) charCount.classList.add('error');
                else if (len > 220) charCount.classList.add('warning');
                postBtn.disabled = len === 0 || len > 280;
                
                // Check for @mention trigger
                handleMentionInput(textarea);
                
                // Auto-save draft
                scheduleDraftPostSave();
            });
            
            textarea.addEventListener('keydown', (e) => {
                // Handle autocomplete navigation
                if (mentionAutocomplete && mentionAutocomplete.classList.contains('visible')) {
                    if (e.key === 'ArrowDown') {
                        e.preventDefault();
                        navigateMentionAutocomplete(1);
                        return;
                    }
                    if (e.key === 'ArrowUp') {
                        e.preventDefault();
                        navigateMentionAutocomplete(-1);
                        return;
                    }
                    if (e.key === 'Enter' || e.key === 'Tab') {
                        e.preventDefault();
                        selectMentionItem();
                        return;
                    }
                    if (e.key === 'Escape') {
                        e.preventDefault();
                        hideMentionAutocomplete();
                        return;
                    }
                }
                
                if ((e.ctrlKey || e.metaKey) && e.key === 'Enter') {
                    e.preventDefault();
                    if (!postBtn.disabled) submitPost();
                }
            });
            
            // Hide autocomplete on blur (with delay for click)
            textarea.addEventListener('blur', () => {
                setTimeout(() => hideMentionAutocomplete(), 200);
            });
        }
        
        // ===== MENTION AUTOCOMPLETE FUNCTIONS =====
        function handleMentionInput(textarea) {
            mentionTargetTextarea = textarea;
            const cursorPos = textarea.selectionStart;
            const text = textarea.value.substring(0, cursorPos);
            
            // Find @ before cursor
            const atIndex = text.lastIndexOf('@');
            
            if (atIndex === -1) {
                hideMentionAutocomplete();
                return;
            }
            
            // Check if @ is start of word (preceded by space, newline, or start of text)
            if (atIndex > 0 && !/\s/.test(text[atIndex - 1])) {
                hideMentionAutocomplete();
                return;
            }
            
            // Get the partial username after @
            const partialUsername = text.substring(atIndex + 1);
            
            // Don't show if there's a space after @ (completed mention)
            if (partialUsername.includes(' ') || partialUsername.includes('\n')) {
                hideMentionAutocomplete();
                return;
            }
            
            mentionStartPos = atIndex;
            
            // Debounce search
            clearTimeout(mentionSearchTimeout);
            mentionSearchTimeout = setTimeout(() => {
                searchMentions(partialUsername, textarea);
            }, 150);
        }
        
        async function searchMentions(query, textarea) {
            // Use contacts from memory (already loaded in contacts array)
            if (!contacts || contacts.length === 0) {
                hideMentionAutocomplete();
                return;
            }
            
            // Filter contacts by query
            const queryLower = query.toLowerCase();
            const matches = contacts.filter(contact => {
                const displayName = contact.display_name || '';
                const email = contact.email || '';
                const username = email.split('@')[0];
                
                return displayName.toLowerCase().includes(queryLower) ||
                       username.toLowerCase().includes(queryLower);
            }).slice(0, 5); // Max 5 suggestions
            
            if (matches.length === 0) {
                hideMentionAutocomplete();
                return;
            }
            
            // Render autocomplete
            mentionSelectedIndex = 0;
            renderMentionAutocomplete(matches, textarea);
        }
        
        function renderMentionAutocomplete(contactsList, textarea) {
            if (!mentionAutocomplete) return;
            
            mentionAutocomplete.innerHTML = contactsList.map((contact, index) => {
                const displayName = contact.display_name || contact.email?.split('@')[0] || 'User';
                const username = contact.email?.split('@')[0] || '';
                const initial = displayName[0].toUpperCase();
                
                return `
                    <div class="mention-item ${index === mentionSelectedIndex ? 'selected' : ''}"
                         data-username="${escapeHtml(username)}"
                         onclick="selectMention('${escapeHtml(username)}')">
                        <div class="mention-item-avatar">${initial}</div>
                        <div class="mention-item-info">
                            <span class="mention-item-name">${escapeHtml(displayName)}</span>
                            <span class="mention-item-username">@${escapeHtml(username)}</span>
                        </div>
                    </div>
                `;
            }).join('');
            
            // Position autocomplete below textarea
            const rect = textarea.getBoundingClientRect();
            const parentRect = textarea.parentElement.getBoundingClientRect();
            mentionAutocomplete.style.top = (textarea.offsetTop + textarea.offsetHeight + 4) + 'px';
            mentionAutocomplete.style.left = '0';
            mentionAutocomplete.classList.add('visible');
        }
        
        function navigateMentionAutocomplete(direction) {
            if (!mentionAutocomplete) return;
            const items = mentionAutocomplete.querySelectorAll('.mention-item');
            if (items.length === 0) return;
            
            items[mentionSelectedIndex]?.classList.remove('selected');
            mentionSelectedIndex = (mentionSelectedIndex + direction + items.length) % items.length;
            items[mentionSelectedIndex]?.classList.add('selected');
            items[mentionSelectedIndex]?.scrollIntoView({ block: 'nearest' });
        }
        
        function selectMentionItem() {
            if (!mentionAutocomplete) return;
            const items = mentionAutocomplete.querySelectorAll('.mention-item');
            const selectedItem = items[mentionSelectedIndex];
            if (selectedItem) {
                const username = selectedItem.dataset.username;
                selectMention(username);
            }
        }
        
        function selectMention(username) {
            if (!mentionTargetTextarea) return;
            const textarea = mentionTargetTextarea;
            const cursorPos = textarea.selectionStart;
            const textBefore = textarea.value.substring(0, mentionStartPos);
            const textAfter = textarea.value.substring(cursorPos);
            
            // Insert the mention
            textarea.value = textBefore + '@' + username + ' ' + textAfter;
            
            // Move cursor after mention
            const newPos = mentionStartPos + username.length + 2;
            textarea.setSelectionRange(newPos, newPos);
            textarea.focus();
            
            // Trigger input event to update char count
            textarea.dispatchEvent(new Event('input'));
            
            hideMentionAutocomplete();
        }
        
        function hideMentionAutocomplete() {
            if (mentionAutocomplete) {
                mentionAutocomplete.classList.remove('visible');
            }
            mentionStartPos = -1;
        }
        
        function triggerFileUpload() {
            document.getElementById('file-input').click();
        }
        
        async function handleFileSelect(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const validTypes = ['image/jpeg', 'image/png', 'image/gif', 'image/webp'];
            if (!validTypes.includes(file.type)) {
                showToast({ type: 'error', message: 'Ce format ne passe pas (essaie JPG, PNG ou GIF)' });
                return;
            }
            
            if (file.size > 5 * 1024 * 1024) {
                showToast({ type: 'error', message: 'Image trop lourde ! Max 5 Mo' });
                return;
            }
            
            const reader = new FileReader();
            reader.onload = async (e) => {
                showImagePreview(e.target.result);
                await uploadImage(e.target.result, file.type);
            };
            reader.readAsDataURL(file);
        }
        
        async function uploadImage(base64Data, contentType) {
            const progress = document.getElementById('upload-progress');
            progress.style.display = 'block';
            
            try {
                const res = await fetch(`${API_URL}/upload-image`, {
                    method: 'POST',
                    headers: authHeaders(),
                    body: JSON.stringify({ image: base64Data, contentType })
                });
                
                const data = await res.json();
                if (!res.ok) throw new Error(data.error || 'Erreur upload');
                
                currentImageUrl = data.url;
                showToast({ type: 'success', message: '📷 Image prête !' });
            } catch (e) {
                showToast({ type: 'error', message: e.message });
                removeImage();
            } finally {
                progress.style.display = 'none';
            }
        }
        
        function showImagePreview(url) {
            const preview = document.getElementById('image-preview');
            const img = document.getElementById('preview-img');
            img.src = url;
            img.onload = () => preview.classList.add('visible');
            img.onerror = () => preview.classList.remove('visible');
        }
        
        function removeImage() {
            document.getElementById('image-preview').classList.remove('visible');
            document.getElementById('preview-img').src = '';
            document.getElementById('file-input').value = '';
            currentImageUrl = null;
        }

        async function submitPost() {
            const content = document.getElementById('post-content').value.trim();
            if (!content) return;
            
            const postBtn = document.getElementById('post-btn');
            postBtn.disabled = true;
            postBtn.textContent = '...';
            
            try {
                const body = { content };
                if (currentImageUrl) body.image_url = currentImageUrl;
                
                const res = await fetch(`${API_URL}/posts`, {
                    method: 'POST',
                    headers: authHeaders(),
                    body: JSON.stringify(body)
                });
                
                const data = await res.json();
                if (!res.ok) throw new Error(data.error || 'Erreur');
                
                posts.unshift(data.post);
                renderPosts();
                
                document.getElementById('post-content').value = '';
                document.getElementById('char-count').textContent = '0/280';
                removeImage();
                
                // Clear saved draft after successful post
                clearDraftPost();
                
                showToast({ type: 'success', message: 'Envoyé à tes 5 !' });
                
                // Onboarding: check progress after posting
                setTimeout(checkOnboardingProgress, 500);
            } catch (e) {
                showToast({ type: 'error', message: e.message });
            } finally {
                postBtn.disabled = false;
                postBtn.textContent = 'Poster';
            }
        }

        async function loadPosts() {
            const container = document.getElementById('posts-list');
            container.setAttribute('aria-busy', 'true');
            
            try {
                const res = await fetch(`${API_URL}/posts`, { headers: authHeaders() });
                const data = await res.json();
                if (!res.ok) throw new Error(data.error || 'Erreur');
                posts = data.posts || [];
                renderPosts();
            } catch (e) {
                container.innerHTML = `
                    <div class="empty-state" role="status">
                        <div class="empty-state-icon" aria-hidden="true">😵</div>
                        <div class="empty-state-title">Oups, ça a planté</div>
                        <div style="color:var(--color-text-muted)">Rafraîchis la page, ça devrait passer</div>
                    </div>
                `;
            } finally {
                container.setAttribute('aria-busy', 'false');
            }
        }

        function renderPosts() {
            const container = document.getElementById('posts-list');
            container.setAttribute('aria-busy', 'false');
            
            if (posts.length === 0) {
                container.innerHTML = `
                    <div class="empty-state" role="status">
                        <div class="empty-state-icon" aria-hidden="true">🌱</div>
                        <div class="empty-state-title">C'est calme ici</div>
                        <div style="color:var(--color-text-muted);max-width:300px;margin:0 auto;">
                            Brise la glace ! Poste un truc, ou ajoute tes proches pour voir ce qu'ils racontent.
                        </div>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = posts.map((post, index) => {
                const author = post.author || {};
                const isOwn = post.user_id === user.id;
                const avatarUrl = author.avatar_url;
                const initial = (author.display_name || author.email || '?')[0].toUpperCase();
                const displayName = author.display_name || author.email?.split('@')[0] || 'Anonyme';
                const time = formatTime(post.created_at);
                
                const avatarHtml = avatarUrl 
                    ? `<img data-src="${escapeHtml(avatarUrl)}" alt="" loading="lazy" class="lazy-image">`
                    : `<span aria-hidden="true">${initial}</span>`;
                
                const imageHtml = post.image_url ? `
                    <div class="post-image lazy-image-container">
                        <img data-src="${escapeHtml(post.image_url)}" alt="Image partagée par ${escapeHtml(displayName)}" onclick="openImageModal('${escapeHtml(post.image_url)}')" role="button" tabindex="0" onkeydown="if(event.key==='Enter')openImageModal('${escapeHtml(post.image_url)}')" loading="lazy" class="lazy-image">
                    </div>
                ` : '';
                
                const menuHtml = isOwn ? `
                    <button class="post-menu-btn" onclick="togglePostMenu('${post.id}')" type="button" aria-label="Options du post" aria-haspopup="menu" aria-expanded="false"><span aria-hidden="true">⋮</span></button>
                    <div class="post-menu" id="menu-${post.id}" role="menu">
                        <button class="post-menu-item" onclick="deletePost('${post.id}')" type="button" role="menuitem"><span aria-hidden="true">🗑️</span> Supprimer</button>
                    </div>
                ` : '';
                
                // Build status HTML if available
                const statusEmoji = author.status_emoji;
                const statusText = author.status_text;
                const statusHtml = (statusEmoji || statusText) ? `
                    <div class="post-author-status">
                        ${statusEmoji ? `<span class="post-author-status-emoji">${statusEmoji}</span>` : ''}
                        ${statusText ? `<span class="post-author-status-text">${escapeHtml(statusText)}</span>` : ''}
                    </div>
                ` : '';
                
                return `
                    <article class="post-card" data-post-id="${post.id}" aria-posinset="${index + 1}" aria-setsize="${posts.length}">
                        <div class="post-header">
                            <div class="post-author">
                                <div class="post-avatar ${isOwn ? 'own' : ''}" aria-hidden="true">${avatarHtml}</div>
                                <div>
                                    <span class="post-author-name">
                                        ${escapeHtml(displayName)}
                                        ${isOwn ? '<span class="you-badge">(toi)</span>' : ''}
                                    </span>
                                    ${statusHtml}
                                    <div class="post-time"><time datetime="${post.created_at}">${time}</time></div>
                                </div>
                            </div>
                            ${menuHtml}
                        </div>
                        <div class="post-content">${renderMentions(post.content)}</div>
                        ${imageHtml}
                    </article>
                `;
            }).join('');
            
            // Observe lazy images after render
            requestAnimationFrame(() => observeLazyImages());
        }
        
        function togglePostMenu(postId) {
            // Close other menus and update their aria-expanded
            document.querySelectorAll('.post-menu.open').forEach(m => {
                if (m.id !== `menu-${postId}`) {
                    m.classList.remove('open');
                    const btn = m.previousElementSibling;
                    if (btn) btn.setAttribute('aria-expanded', 'false');
                }
            });
            
            const menu = document.getElementById(`menu-${postId}`);
            const isOpen = menu.classList.toggle('open');
            const btn = menu.previousElementSibling;
            if (btn) btn.setAttribute('aria-expanded', isOpen ? 'true' : 'false');
        }
        
        async function deletePost(postId) {
            if (!confirm('Supprimer ce post ?')) return;
            
            try {
                const res = await fetch(`${API_URL}/posts?id=${postId}`, {
                    method: 'DELETE',
                    headers: authHeaders()
                });
                if (!res.ok) throw new Error((await res.json()).error || 'Erreur');
                posts = posts.filter(p => p.id !== postId);
                renderPosts();
                showToast({ type: 'success', message: 'Post supprimé' });
            } catch (e) {
                showToast({ type: 'error', message: e.message });
            }
        }
        
        function openImageModal(url) {
            event.stopPropagation();
            document.getElementById('modal-image').src = url;
            document.getElementById('image-modal').classList.add('open');
        }
        
        function closeImageModal() {
            document.getElementById('image-modal').classList.remove('open');
        }
        
        // ===== STORIES BAR =====
        async function loadStoriesBar() {
            try {
                const res = await fetch(`${API_URL}/stories`, { headers: authHeaders() });
                
                if (!res.ok) {
                    console.warn('Stories API not available yet');
                    return;
                }
                
                const data = await res.json();
                const grouped = data.grouped || [];
                
                renderStoriesBar(grouped);
                
                // Update own avatar in story ring
                if (currentUser?.avatar_url) {
                    const ownAvatar = document.getElementById('story-own-avatar');
                    if (ownAvatar) {
                        ownAvatar.innerHTML = `<img src="${escapeHtml(currentUser.avatar_url)}" alt="">`;
                    }
                } else if (currentUser?.display_name || currentUser?.email) {
                    const initial = (currentUser.display_name || currentUser.email).charAt(0).toUpperCase();
                    const ownAvatar = document.getElementById('story-own-avatar');
                    if (ownAvatar) {
                        ownAvatar.textContent = initial;
                    }
                }
            } catch (e) {
                console.warn('Error loading stories:', e);
            }
        }
        
        function renderStoriesBar(grouped) {
            const container = document.getElementById('stories-list-inline');
            if (!container) return;
            
            // Filter out own stories (we already show "Ta story" button)
            const othersStories = grouped.filter(g => !g.isOwn);
            
            if (othersStories.length === 0) {
                container.innerHTML = '';
                return;
            }
            
            container.innerHTML = othersStories.map(group => {
                const avatar = group.user?.avatar_url 
                    ? `<img src="${escapeHtml(group.user.avatar_url)}" alt="">`
                    : escapeHtml(getInitialFromName(group.user?.display_name || group.user?.email));
                
                const name = group.user?.display_name || group.user?.email?.split('@')[0] || 'Anonyme';
                const truncatedName = name.length > 8 ? name.substring(0, 8) + '…' : name;
                
                return `
                    <a href="/stories.html" class="story-ring-item" aria-label="Voir les stories de ${escapeHtml(name)}">
                        <div class="story-ring-wrapper">
                            <div class="story-ring-avatar">${avatar}</div>
                        </div>
                        <span class="story-ring-label">${escapeHtml(truncatedName)}</span>
                    </a>
                `;
            }).join('');
        }
        
        function getInitialFromName(name) {
            if (!name) return '?';
            return name.charAt(0).toUpperCase();
        }

        // ===== CONTACTS =====
        async function loadContacts() {
            try {
                const res = await fetch(`${API_URL}/contacts`, { headers: authHeaders() });
                const data = await res.json();
                
                if (res.status === 401) { logout(); return; }
                
                contacts = data.contacts || [];
                
                for (const contact of contacts) {
                    if (!lastMessageIds[contact.contact_user_id]) {
                        try {
                            const msgRes = await fetch(`${API_URL}/messages?contact_id=${contact.contact_user_id}&limit=1`, { headers: authHeaders() });
                            const msgData = await msgRes.json();
                            if (msgData.messages?.length > 0) {
                                lastMessageIds[contact.contact_user_id] = msgData.messages[msgData.messages.length - 1].id;
                            }
                        } catch (e) {}
                    }
                }
                
                renderContacts();
                loadSuggestions();
                loadArchivedContacts();
            } catch (e) {
                showToast({ type: 'error', title: 'Oups', message: 'Impossible de charger tes contacts. Réseau ?' });
            }
        }
        
        // ===== ARCHIVED CONTACTS =====
        async function loadArchivedContacts() {
            try {
                const res = await fetch(`${API_URL}/contacts?archived=true`, { headers: authHeaders() });
                const data = await res.json();
                
                if (res.status === 401) return;
                
                archivedContacts = data.contacts || [];
                renderArchivedContacts();
            } catch (e) {
                console.error('Error loading archived contacts:', e);
            }
        }
        
        function renderArchivedContacts() {
            const section = document.getElementById('archived-section');
            const list = document.getElementById('archived-list');
            const countEl = document.getElementById('archived-count');
            
            // Show/hide section based on archived count
            if (archivedContacts.length === 0) {
                section.style.display = 'none';
                return;
            }
            
            section.style.display = 'block';
            countEl.textContent = archivedContacts.length;
            
            list.innerHTML = '';
            
            archivedContacts.forEach(contact => {
                const name = contact.contact?.display_name || contact.contact?.email?.split('@')[0] || '?';
                const initial = name.charAt(0).toUpperCase();
                const avatarUrl = contact.contact?.avatar_url;
                
                const card = document.createElement('div');
                card.className = 'archived-contact-card';
                card.setAttribute('role', 'listitem');
                
                // Avatar
                const avatarDiv = document.createElement('div');
                avatarDiv.className = 'archived-contact-avatar';
                if (avatarUrl) {
                    const img = document.createElement('img');
                    img.src = avatarUrl;
                    img.alt = '';
                    img.loading = 'lazy';
                    avatarDiv.appendChild(img);
                } else {
                    avatarDiv.textContent = initial;
                }
                
                // Info
                const infoDiv = document.createElement('div');
                infoDiv.className = 'archived-contact-info';
                
                const nameDiv = document.createElement('div');
                nameDiv.className = 'archived-contact-name';
                nameDiv.textContent = name;
                
                const hintDiv = document.createElement('div');
                hintDiv.className = 'archived-contact-hint';
                hintDiv.textContent = 'Conversation archivée';
                
                infoDiv.appendChild(nameDiv);
                infoDiv.appendChild(hintDiv);
                
                // Unarchive button
                const unarchiveBtn = document.createElement('button');
                unarchiveBtn.className = 'unarchive-btn';
                unarchiveBtn.type = 'button';
                unarchiveBtn.setAttribute('aria-label', `Désarchiver ${name}`);
                unarchiveBtn.innerHTML = `
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M12 19V5"/><path d="M5 12l7-7 7 7"/>
                    </svg>
                    Restaurer
                `;
                unarchiveBtn.onclick = () => unarchiveContact(contact.id, name);
                
                card.appendChild(avatarDiv);
                card.appendChild(infoDiv);
                card.appendChild(unarchiveBtn);
                
                list.appendChild(card);
            });
        }
        
        function toggleArchivedSection() {
            const header = document.getElementById('archived-header');
            const list = document.getElementById('archived-list');
            
            const isExpanded = header.classList.toggle('expanded');
            list.classList.toggle('visible', isExpanded);
            header.setAttribute('aria-expanded', isExpanded);
        }
        
        async function toggleArchiveContact() {
            if (!currentChatContact) return;
            
            const contactId = currentChatContact.id;
            const isCurrentlyArchived = currentChatContact.archived || false;
            const name = currentChatContact.contact?.display_name || currentChatContact.contact?.email?.split('@')[0] || 'Contact';
            
            try {
                const res = await fetch(`${API_URL}/contacts?id=${contactId}&action=archive`, {
                    method: 'PATCH',
                    headers: authHeaders()
                });
                
                const data = await res.json();
                
                if (!res.ok) {
                    throw new Error(data.error || 'Erreur');
                }
                
                // Update UI
                const archiveBtn = document.getElementById('chat-archive-btn');
                if (data.archived) {
                    archiveBtn.classList.add('archived');
                    archiveBtn.setAttribute('aria-label', 'Désarchiver cette conversation');
                    archiveBtn.setAttribute('title', 'Désarchiver');
                    showToast({ type: 'success', message: `${name} archivé` });
                    closeChat();
                } else {
                    archiveBtn.classList.remove('archived');
                    archiveBtn.setAttribute('aria-label', 'Archiver cette conversation');
                    archiveBtn.setAttribute('title', 'Archiver');
                    showToast({ type: 'success', message: `${name} restauré` });
                }
                
                // Refresh contacts lists
                loadContacts();
                
            } catch (e) {
                showToast({ type: 'error', message: e.message });
            }
        }
        
        async function unarchiveContact(contactId, name) {
            try {
                const res = await fetch(`${API_URL}/contacts?id=${contactId}&action=archive`, {
                    method: 'PATCH',
                    headers: authHeaders()
                });
                
                const data = await res.json();
                
                if (!res.ok) {
                    throw new Error(data.error || 'Erreur');
                }
                
                showToast({ type: 'success', message: `${name} restauré !` });
                
                // Refresh contacts lists
                loadContacts();
                
            } catch (e) {
                showToast({ type: 'error', message: e.message });
            }
        }

        // ===== MUTE CONTACT =====
        function openMuteModal() {
            if (!currentChatContact) return;
            
            const modal = document.getElementById('mute-modal');
            const contactNameEl = document.getElementById('mute-contact-name');
            const currentStatusEl = document.getElementById('mute-current-status');
            const currentTextEl = document.getElementById('mute-current-text');
            const unmuteBtn = document.getElementById('unmute-btn');
            const optionBtns = document.querySelectorAll('.mute-option-btn');
            
            const name = currentChatContact.contact?.display_name || currentChatContact.contact?.email?.split('@')[0] || 'Contact';
            contactNameEl.textContent = name;
            
            // Reset UI
            optionBtns.forEach(btn => btn.classList.remove('selected'));
            
            // Check if currently muted
            const isMuted = currentChatContact.is_muted || false;
            const mutedUntil = currentChatContact.muted_until;
            
            if (isMuted && mutedUntil) {
                currentStatusEl.classList.remove('hidden');
                unmuteBtn.style.display = 'block';
                
                const mutedDate = new Date(mutedUntil);
                if (mutedDate.getFullYear() >= 9999) {
                    currentTextEl.textContent = 'En sourdine indéfiniment';
                } else {
                    currentTextEl.textContent = `En sourdine jusqu'au ${formatMuteDate(mutedDate)}`;
                }
            } else {
                currentStatusEl.classList.add('hidden');
                unmuteBtn.style.display = 'none';
            }
            
            openModal('mute-modal');
        }
        
        function closeMuteModal() {
            closeModal('mute-modal');
        }
        
        function formatMuteDate(date) {
            const now = new Date();
            const diff = date - now;
            
            // If less than 24h, show time only
            if (diff < 24 * 60 * 60 * 1000) {
                return date.toLocaleTimeString('fr-FR', { hour: '2-digit', minute: '2-digit' });
            }
            
            // Otherwise show date and time
            return date.toLocaleDateString('fr-FR', { 
                day: 'numeric', 
                month: 'short',
                hour: '2-digit', 
                minute: '2-digit' 
            });
        }
        
        async function setMuteDuration(duration) {
            if (!currentChatContact) return;
            
            const contactId = currentChatContact.id;
            const name = currentChatContact.contact?.display_name || currentChatContact.contact?.email?.split('@')[0] || 'Contact';
            
            try {
                const res = await fetch(`${API_URL}/contacts?id=${contactId}&action=mute&duration=${duration}`, {
                    method: 'PATCH',
                    headers: authHeaders()
                });
                
                const data = await res.json();
                
                if (!res.ok) {
                    throw new Error(data.error || 'Erreur');
                }
                
                // Update current contact state
                currentChatContact.is_muted = data.is_muted;
                currentChatContact.muted_until = data.muted_until;
                
                // Update UI
                updateMuteButton(data.is_muted);
                
                // Show toast
                if (data.is_muted) {
                    const durationText = {
                        '1h': '1 heure',
                        '8h': '8 heures',
                        '24h': '24 heures',
                        'forever': 'indéfiniment'
                    }[duration] || duration;
                    showToast({ type: 'success', message: `🔇 ${name} en sourdine pour ${durationText}` });
                } else {
                    showToast({ type: 'success', message: `🔔 Notifications réactivées pour ${name}` });
                }
                
                closeMuteModal();
                
                // Refresh contacts to update badges
                loadContacts();
                
            } catch (e) {
                showToast({ type: 'error', message: e.message });
            }
        }
        
        function updateMuteButton(isMuted) {
            const muteBtn = document.getElementById('chat-mute-btn');
            if (!muteBtn) return;
            
            if (isMuted) {
                muteBtn.classList.add('muted');
                muteBtn.setAttribute('aria-label', 'Réactiver les notifications');
                muteBtn.setAttribute('title', 'En sourdine');
            } else {
                muteBtn.classList.remove('muted');
                muteBtn.setAttribute('aria-label', 'Mettre en sourdine');
                muteBtn.setAttribute('title', 'Sourdine');
            }
        }

        // ===== PRIVATE NOTES =====
        function openPrivateNoteModal() {
            if (!currentChatContact) return;
            
            const modal = document.getElementById('private-note-modal');
            const textarea = document.getElementById('private-note-textarea');
            const contactNameEl = document.getElementById('private-note-contact-name');
            
            const name = currentChatContact.contact?.display_name || currentChatContact.contact?.email?.split('@')[0] || 'Contact';
            contactNameEl.textContent = `Note sur ${name}`;
            
            // Load existing note
            textarea.value = currentChatContact.private_note || '';
            
            modal.classList.add('open');
            modal.setAttribute('aria-hidden', 'false');
            
            setTimeout(() => textarea.focus(), 100);
        }
        
        function closePrivateNoteModal() {
            const modal = document.getElementById('private-note-modal');
            modal.classList.remove('open');
            modal.setAttribute('aria-hidden', 'true');
        }
        
        async function savePrivateNote() {
            if (!currentChatContact) return;
            
            const textarea = document.getElementById('private-note-textarea');
            const noteValue = textarea.value.trim();
            const contactId = currentChatContact.id;
            const name = currentChatContact.contact?.display_name || currentChatContact.contact?.email?.split('@')[0] || 'Contact';
            
            try {
                const res = await fetch(`${API_URL}/contacts?id=${contactId}&action=note`, {
                    method: 'PATCH',
                    headers: {
                        ...authHeaders(),
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ private_note: noteValue || null })
                });
                
                const data = await res.json();
                
                if (!res.ok) {
                    throw new Error(data.error || 'Erreur lors de la sauvegarde');
                }
                
                // Update local contact data
                currentChatContact.private_note = data.private_note;
                
                // Update contacts array
                const contactIndex = contacts.findIndex(c => c.id === contactId);
                if (contactIndex !== -1) {
                    contacts[contactIndex].private_note = data.private_note;
                }
                
                // Update note button state
                updateNoteButtonState();
                
                closePrivateNoteModal();
                showToast({ 
                    type: 'success', 
                    message: noteValue ? 'Note enregistrée 📝' : 'Note supprimée',
                    duration: 2000 
                });
                
            } catch (e) {
                showToast({ type: 'error', message: e.message });
            }
        }
        
        function updateNoteButtonState() {
            const noteBtn = document.getElementById('chat-note-btn');
            if (!noteBtn || !currentChatContact) return;
            
            const hasNote = !!currentChatContact.private_note;
            noteBtn.classList.toggle('has-note', hasNote);
            noteBtn.setAttribute('title', hasNote ? 'Note privée (1)' : 'Note privée');
        }

        // ===== CONVERSATION EXPORT =====
        function openExportModal() {
            if (!currentChatContact) return;
            
            const modal = document.getElementById('export-modal');
            const contactName = currentChatContact.contact?.display_name || 
                               currentChatContact.contact?.email?.split('@')[0] || 
                               'Contact';
            
            document.getElementById('export-contact-display').textContent = contactName;
            modal.classList.add('open');
            modal.setAttribute('aria-hidden', 'false');
        }
        
        function closeExportModal() {
            const modal = document.getElementById('export-modal');
            modal.classList.remove('open');
            modal.setAttribute('aria-hidden', 'true');
        }
        
        async function exportConversation(format) {
            if (!currentChatContact) return;
            
            const contactName = currentChatContact.contact?.display_name || 
                               currentChatContact.contact?.email?.split('@')[0] || 
                               'Contact';
            
            // Fetch all messages for this contact
            try {
                showToast({ type: 'info', message: 'Préparation de l\'export...', duration: 2000 });
                
                const res = await fetch(`${API_URL}/messages?contact_id=${currentChatContact.id}&limit=10000`, {
                    headers: authHeaders()
                });
                
                if (!res.ok) throw new Error('Erreur lors de la récupération des messages');
                
                const messages = await res.json();
                
                if (!messages || messages.length === 0) {
                    showToast({ type: 'warning', message: 'Aucun message à exporter', duration: 2000 });
                    return;
                }
                
                // Sort messages by date (oldest first)
                messages.sort((a, b) => new Date(a.created_at) - new Date(b.created_at));
                
                const currentUserEmail = localStorage.getItem('cinq-email') || 'Moi';
                const currentUserName = localStorage.getItem('cinq-display-name') || currentUserEmail.split('@')[0];
                
                if (format === 'txt') {
                    exportAsTxt(messages, contactName, currentUserName);
                } else if (format === 'pdf') {
                    exportAsPdf(messages, contactName, currentUserName);
                }
                
                closeExportModal();
                showToast({ type: 'success', message: `Conversation exportée en ${format.toUpperCase()} 📥`, duration: 3000 });
                
            } catch (e) {
                console.error('Export error:', e);
                showToast({ type: 'error', message: 'Erreur lors de l\'export', duration: 3000 });
            }
        }
        
        function formatMessageDate(dateStr) {
            const date = new Date(dateStr);
            const options = { 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric', 
                hour: '2-digit', 
                minute: '2-digit' 
            };
            return date.toLocaleDateString('fr-FR', options);
        }
        
        function exportAsTxt(messages, contactName, currentUserName) {
            const date = new Date().toLocaleDateString('fr-FR');
            let content = `═══════════════════════════════════════════════════\n`;
            content += `  CONVERSATION CINQ\n`;
            content += `  Avec : ${contactName}\n`;
            content += `  Exporté le : ${date}\n`;
            content += `  Nombre de messages : ${messages.length}\n`;
            content += `═══════════════════════════════════════════════════\n\n`;
            
            let currentDate = '';
            
            messages.forEach(msg => {
                const msgDate = new Date(msg.created_at);
                const dateLabel = msgDate.toLocaleDateString('fr-FR', { 
                    weekday: 'long', 
                    year: 'numeric', 
                    month: 'long', 
                    day: 'numeric' 
                });
                
                // Add date separator if new day
                if (dateLabel !== currentDate) {
                    currentDate = dateLabel;
                    content += `\n─── ${dateLabel} ───\n\n`;
                }
                
                const time = msgDate.toLocaleTimeString('fr-FR', { 
                    hour: '2-digit', 
                    minute: '2-digit' 
                });
                
                const sender = msg.is_from_me ? currentUserName : contactName;
                const indicator = msg.is_from_me ? '→' : '←';
                
                // Handle different message types
                let messageText = '';
                if (msg.content_type === 'ping') {
                    messageText = '👋 [Coucou]';
                } else if (msg.content_type === 'voice') {
                    messageText = '🎤 [Message vocal]';
                } else if (msg.content_type === 'image') {
                    messageText = '📷 [Image]';
                } else if (msg.content_type === 'gif') {
                    messageText = '🎬 [GIF]';
                } else {
                    messageText = msg.content || '';
                }
                
                content += `[${time}] ${indicator} ${sender}:\n${messageText}\n\n`;
            });
            
            content += `\n═══════════════════════════════════════════════════\n`;
            content += `  Fin de la conversation\n`;
            content += `  Généré par Cinq — cinq.app\n`;
            content += `═══════════════════════════════════════════════════\n`;
            
            // Download file
            const blob = new Blob([content], { type: 'text/plain;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `cinq-conversation-${contactName.replace(/[^a-zA-Z0-9]/g, '_')}-${new Date().toISOString().split('T')[0]}.txt`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }
        
        function exportAsPdf(messages, contactName, currentUserName) {
            const date = new Date().toLocaleDateString('fr-FR');
            
            // Build HTML content for PDF
            let html = `
<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>Conversation Cinq - ${contactName}</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f5f5f5;
            padding: 40px;
            line-height: 1.5;
        }
        .header {
            background: linear-gradient(135deg, #8b5cf6, #6366f1);
            color: white;
            padding: 30px;
            border-radius: 16px;
            margin-bottom: 30px;
            text-align: center;
        }
        .header h1 { font-size: 24px; margin-bottom: 8px; }
        .header p { opacity: 0.9; font-size: 14px; }
        .stats { 
            display: flex; 
            justify-content: center; 
            gap: 30px; 
            margin-top: 20px;
            font-size: 12px;
        }
        .stats span { 
            background: rgba(255,255,255,0.2); 
            padding: 6px 12px; 
            border-radius: 20px; 
        }
        .date-separator {
            text-align: center;
            color: #666;
            font-size: 12px;
            font-weight: 600;
            margin: 20px 0;
            padding: 10px;
            background: #e5e5e5;
            border-radius: 8px;
        }
        .message {
            display: flex;
            margin-bottom: 12px;
            flex-direction: column;
        }
        .message.sent { align-items: flex-end; }
        .message.received { align-items: flex-start; }
        .message-bubble {
            max-width: 70%;
            padding: 12px 16px;
            border-radius: 18px;
            position: relative;
        }
        .message.sent .message-bubble {
            background: linear-gradient(135deg, #8b5cf6, #6366f1);
            color: white;
            border-bottom-right-radius: 4px;
        }
        .message.received .message-bubble {
            background: white;
            color: #333;
            border-bottom-left-radius: 4px;
            border: 1px solid #e5e5e5;
        }
        .message-content { word-wrap: break-word; }
        .message-meta {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-top: 4px;
            font-size: 11px;
            opacity: 0.7;
        }
        .message.sent .message-meta { justify-content: flex-end; }
        .footer {
            text-align: center;
            margin-top: 40px;
            padding: 20px;
            color: #999;
            font-size: 12px;
            border-top: 1px solid #e5e5e5;
        }
        @media print {
            body { padding: 20px; }
            .header { break-inside: avoid; }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>💬 Conversation avec ${escapeHtml(contactName)}</h1>
        <p>Exportée le ${date}</p>
        <div class="stats">
            <span>📨 ${messages.length} messages</span>
            <span>📅 ${messages.length > 0 ? new Date(messages[0].created_at).toLocaleDateString('fr-FR') : '-'} → ${messages.length > 0 ? new Date(messages[messages.length-1].created_at).toLocaleDateString('fr-FR') : '-'}</span>
        </div>
    </div>
    <div class="messages">`;
            
            let currentDate = '';
            
            messages.forEach(msg => {
                const msgDate = new Date(msg.created_at);
                const dateLabel = msgDate.toLocaleDateString('fr-FR', { 
                    weekday: 'long', 
                    year: 'numeric', 
                    month: 'long', 
                    day: 'numeric' 
                });
                
                // Add date separator if new day
                if (dateLabel !== currentDate) {
                    currentDate = dateLabel;
                    html += `<div class="date-separator">📅 ${dateLabel}</div>`;
                }
                
                const time = msgDate.toLocaleTimeString('fr-FR', { 
                    hour: '2-digit', 
                    minute: '2-digit' 
                });
                
                const sender = msg.is_from_me ? currentUserName : contactName;
                const msgClass = msg.is_from_me ? 'sent' : 'received';
                
                // Handle different message types
                let messageText = '';
                if (msg.content_type === 'ping') {
                    messageText = '👋 Coucou !';
                } else if (msg.content_type === 'voice') {
                    messageText = '🎤 Message vocal';
                } else if (msg.content_type === 'image') {
                    messageText = '📷 Image';
                } else if (msg.content_type === 'gif') {
                    messageText = '🎬 GIF';
                } else {
                    messageText = escapeHtml(msg.content || '');
                }
                
                html += `
        <div class="message ${msgClass}">
            <div class="message-bubble">
                <div class="message-content">${messageText}</div>
                <div class="message-meta">
                    <span>${sender}</span>
                    <span>•</span>
                    <span>${time}</span>
                </div>
            </div>
        </div>`;
            });
            
            html += `
    </div>
    <div class="footer">
        <p>💜 Généré par <strong>Cinq</strong> — L'anti-réseau social</p>
        <p>cinq.app</p>
    </div>
</body>
</html>`;
            
            // Open in new window for printing/saving as PDF
            const printWindow = window.open('', '_blank');
            printWindow.document.write(html);
            printWindow.document.close();
            
            // Auto-trigger print dialog
            setTimeout(() => {
                printWindow.print();
            }, 500);
        }

        function renderContacts() {
            const grid = document.getElementById('contacts-grid');
            grid.innerHTML = '';

            for (let i = 0; i < 5; i++) {
                const contact = contacts[i];
                const slot = document.createElement('div');
                slot.className = `contact-slot ${contact ? 'filled' : 'empty'}`;
                slot.tabIndex = 0;
                slot.setAttribute('role', 'listitem');
                
                if (contact) {
                    const name = contact.contact?.display_name || contact.contact?.email?.split('@')[0] || '?';
                    const initial = name.charAt(0).toUpperCase();
                    const avatarUrl = contact.contact?.avatar_url;
                    const unread = unreadCounts[contact.contact_user_id] || 0;
                    const isFavorite = contact.is_favorite || false;
                    
                    const favoriteText = isFavorite ? ' (favori)' : '';
                    const unreadText = unread > 0 ? `, ${unread} message${unread > 1 ? 's' : ''} non lu${unread > 1 ? 's' : ''}` : '';
                    slot.setAttribute('aria-label', `${escapeHtml(name)}${favoriteText}${unreadText}. Appuie pour ouvrir la conversation`);
                    
                    // Favorite button
                    const favoriteBtn = document.createElement('button');
                    favoriteBtn.className = `favorite-btn${isFavorite ? ' is-favorite' : ''}`;
                    favoriteBtn.setAttribute('aria-label', isFavorite ? 'Retirer des favoris' : 'Ajouter aux favoris');
                    favoriteBtn.setAttribute('title', isFavorite ? 'Retirer des favoris' : 'Ajouter aux favoris');
                    favoriteBtn.type = 'button';
                    const starSpan = document.createElement('span');
                    starSpan.className = 'favorite-star';
                    starSpan.textContent = isFavorite ? '★' : '☆';
                    starSpan.setAttribute('aria-hidden', 'true');
                    favoriteBtn.appendChild(starSpan);
                    favoriteBtn.onclick = (e) => {
                        e.stopPropagation();
                        toggleFavorite(contact.id, isFavorite);
                    };
                    slot.appendChild(favoriteBtn);
                    
                    // SECURITY: Use DOM methods instead of innerHTML to prevent XSS
                    const avatarSlot = document.createElement('div');
                    avatarSlot.className = 'contact-avatar-slot';
                    avatarSlot.setAttribute('aria-hidden', 'true');
                    if (avatarUrl) {
                        const img = document.createElement('img');
                        img.dataset.src = avatarUrl;
                        img.alt = '';
                        img.loading = 'lazy';
                        img.className = 'lazy-image';
                        avatarSlot.appendChild(img);
                    } else {
                        const span = document.createElement('span');
                        span.setAttribute('aria-hidden', 'true');
                        span.textContent = initial;
                        avatarSlot.appendChild(span);
                    }
                    
                    const nameDiv = document.createElement('div');
                    nameDiv.className = 'contact-name';
                    nameDiv.setAttribute('aria-hidden', 'true');
                    nameDiv.textContent = name;
                    
                    slot.appendChild(avatarSlot);
                    slot.appendChild(nameDiv);
                    
                    // Add status if available
                    const statusEmoji = contact.contact?.status_emoji;
                    const statusText = contact.contact?.status_text;
                    if (statusEmoji || statusText) {
                        const statusDiv = document.createElement('div');
                        statusDiv.className = 'contact-status';
                        statusDiv.setAttribute('aria-hidden', 'true');
                        if (statusEmoji) {
                            const emojiSpan = document.createElement('span');
                            emojiSpan.className = 'contact-status-emoji';
                            emojiSpan.textContent = statusEmoji;
                            statusDiv.appendChild(emojiSpan);
                        }
                        if (statusText) {
                            const textSpan = document.createElement('span');
                            textSpan.className = 'contact-status-text';
                            textSpan.textContent = statusText;
                            statusDiv.appendChild(textSpan);
                        }
                        slot.appendChild(statusDiv);
                    }
                    
                    // Add last seen status
                    const lastSeenAt = contact.contact?.last_seen_at;
                    const lastSeenInfo = formatLastSeen(lastSeenAt);
                    const lastSeenDiv = document.createElement('div');
                    lastSeenDiv.className = 'contact-last-seen' + (lastSeenInfo.isOnline ? ' online' : '');
                    lastSeenDiv.setAttribute('aria-hidden', 'true');
                    
                    const dot = document.createElement('span');
                    dot.className = 'contact-last-seen-dot';
                    lastSeenDiv.appendChild(dot);
                    
                    const lastSeenText = document.createElement('span');
                    lastSeenText.className = 'contact-last-seen-text';
                    lastSeenText.textContent = lastSeenInfo.text;
                    lastSeenDiv.appendChild(lastSeenText);
                    
                    slot.appendChild(lastSeenDiv);
                    
                    if (unread > 0) {
                        const badge = document.createElement('div');
                        badge.className = 'unread-badge';
                        badge.setAttribute('aria-hidden', 'true');
                        badge.textContent = unread > 9 ? '9+' : unread;
                        slot.appendChild(badge);
                    }
                    
                    // Add muted badge if contact is muted
                    if (contact.is_muted) {
                        const mutedBadge = document.createElement('div');
                        mutedBadge.className = 'contact-muted-badge';
                        mutedBadge.setAttribute('aria-hidden', 'true');
                        mutedBadge.setAttribute('title', 'Notifications en sourdine');
                        mutedBadge.textContent = '🔇';
                        slot.appendChild(mutedBadge);
                    }
                    
                    slot.onclick = () => openChat(contact);
                    slot.onkeydown = (e) => { if (e.key === 'Enter' || e.key === ' ') { e.preventDefault(); openChat(contact); } };
                } else {
                    slot.setAttribute('aria-label', `Emplacement ${i + 1} vide. Appuie pour ajouter un contact`);
                    const plusSpan = document.createElement('span');
                    plusSpan.className = 'empty-plus';
                    plusSpan.setAttribute('aria-hidden', 'true');
                    plusSpan.textContent = '+';
                    slot.appendChild(plusSpan);
                    slot.onclick = () => openAddContactModal();
                    slot.onkeydown = (e) => { if (e.key === 'Enter' || e.key === ' ') { e.preventDefault(); openAddContactModal(); } };
                }
                
                grid.appendChild(slot);
            }

            document.getElementById('contact-count').textContent = `${contacts.length}/5`;
            
            // Observe lazy images after render
            requestAnimationFrame(() => observeLazyImages());
        }

        // ===== TOGGLE FAVORITE =====
        async function toggleFavorite(contactId, currentStatus) {
            try {
                const res = await fetch(`${API_URL}/contacts?id=${contactId}`, {
                    method: 'PATCH',
                    headers: authHeaders()
                });
                
                if (res.status === 401) { logout(); return; }
                
                const data = await res.json();
                if (!res.ok) {
                    showToast({ type: 'error', title: 'Oups', message: data.error || 'Impossible de modifier le favori' });
                    return;
                }
                
                // Update local contacts array
                const contactIndex = contacts.findIndex(c => c.id === contactId);
                if (contactIndex !== -1) {
                    contacts[contactIndex].is_favorite = data.is_favorite;
                    
                    // Re-sort contacts: favorites first, then by created_at
                    contacts.sort((a, b) => {
                        if (a.is_favorite && !b.is_favorite) return -1;
                        if (!a.is_favorite && b.is_favorite) return 1;
                        return new Date(a.created_at) - new Date(b.created_at);
                    });
                }
                
                // Re-render contacts
                renderContacts();
                
                // Show feedback
                const action = data.is_favorite ? 'ajouté aux' : 'retiré des';
                showToast({ 
                    type: 'success', 
                    message: `Contact ${action} favoris ⭐`, 
                    duration: 2000 
                });
                
                // Haptic feedback
                if (navigator.vibrate) navigator.vibrate(50);
                
            } catch (e) {
                showToast({ type: 'error', title: 'Oups', message: 'Erreur réseau. Réessaie.' });
            }
        }

        // ===== SUGGESTIONS =====
        let suggestions = [];
        
        async function loadSuggestions() {
            const list = document.getElementById('suggestions-list');
            const section = document.getElementById('suggestions-section');
            
            // Only show suggestions if user has fewer than 5 contacts
            if (contacts.length >= 5) {
                section.style.display = 'none';
                return;
            }
            
            section.style.display = 'block';
            list.innerHTML = '<div class="suggestions-empty" id="suggestions-loading"><span class="loading-spinner"></span> Chargement des suggestions...</div>';
            
            try {
                const res = await fetch(`${API_URL}/suggestions`, { headers: authHeaders() });
                const data = await res.json();
                
                if (res.status === 401) { logout(); return; }
                
                suggestions = data.suggestions || [];
                renderSuggestions(data.message);
            } catch (e) {
                list.innerHTML = '<div class="suggestions-empty">Impossible de charger les suggestions</div>';
            }
        }
        
        function renderSuggestions(emptyMessage) {
            const list = document.getElementById('suggestions-list');
            
            if (!suggestions || suggestions.length === 0) {
                list.innerHTML = `<div class="suggestions-empty">${escapeHtml(emptyMessage || 'Pas de suggestions pour le moment')}</div>`;
                return;
            }
            
            list.innerHTML = '';
            
            suggestions.forEach(s => {
                const card = document.createElement('div');
                card.className = 'suggestion-card';
                card.setAttribute('role', 'listitem');
                card.dataset.userId = s.user.id;
                
                const name = s.user.display_name || s.user.email?.split('@')[0] || 'Utilisateur';
                const initial = name.charAt(0).toUpperCase();
                
                // Avatar
                const avatarDiv = document.createElement('div');
                avatarDiv.className = 'suggestion-avatar';
                if (s.user.avatar_url) {
                    const img = document.createElement('img');
                    img.src = s.user.avatar_url;
                    img.alt = '';
                    img.loading = 'lazy';
                    avatarDiv.appendChild(img);
                } else {
                    avatarDiv.textContent = initial;
                }
                
                // Info section
                const infoDiv = document.createElement('div');
                infoDiv.className = 'suggestion-info';
                
                const nameDiv = document.createElement('div');
                nameDiv.className = 'suggestion-name';
                nameDiv.textContent = name;
                
                const mutualDiv = document.createElement('div');
                mutualDiv.className = 'suggestion-mutual';
                
                // Mutual contact avatars
                if (s.mutualContacts && s.mutualContacts.length > 0) {
                    const avatarsDiv = document.createElement('div');
                    avatarsDiv.className = 'suggestion-mutual-avatars';
                    
                    s.mutualContacts.slice(0, 3).forEach(mc => {
                        const miniAvatar = document.createElement('div');
                        miniAvatar.className = 'mini-avatar';
                        if (mc.avatar_url) {
                            const img = document.createElement('img');
                            img.src = mc.avatar_url;
                            img.alt = '';
                            miniAvatar.appendChild(img);
                        } else {
                            miniAvatar.textContent = (mc.display_name || '?').charAt(0).toUpperCase();
                        }
                        avatarsDiv.appendChild(miniAvatar);
                    });
                    
                    mutualDiv.appendChild(avatarsDiv);
                }
                
                const mutualText = document.createElement('span');
                mutualText.textContent = s.mutualCount === 1 
                    ? '1 ami en commun' 
                    : `${s.mutualCount} amis en commun`;
                mutualDiv.appendChild(mutualText);
                
                infoDiv.appendChild(nameDiv);
                infoDiv.appendChild(mutualDiv);
                
                // Actions
                const actionsDiv = document.createElement('div');
                actionsDiv.className = 'suggestion-actions';
                
                const ignoreBtn = document.createElement('button');
                ignoreBtn.className = 'suggestion-btn ignore';
                ignoreBtn.type = 'button';
                ignoreBtn.setAttribute('aria-label', 'Ignorer cette suggestion');
                ignoreBtn.innerHTML = '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>';
                ignoreBtn.onclick = () => ignoreSuggestion(s.user.id, card);
                
                const addBtn = document.createElement('button');
                addBtn.className = 'suggestion-btn add';
                addBtn.type = 'button';
                addBtn.setAttribute('aria-label', 'Ajouter ce contact');
                addBtn.innerHTML = '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>';
                addBtn.onclick = () => addSuggestionAsContact(s.user.id, s.user.email, card);
                
                actionsDiv.appendChild(ignoreBtn);
                actionsDiv.appendChild(addBtn);
                
                card.appendChild(avatarDiv);
                card.appendChild(infoDiv);
                card.appendChild(actionsDiv);
                
                list.appendChild(card);
            });
        }
        
        async function addSuggestionAsContact(userId, email, cardElement) {
            const addBtn = cardElement.querySelector('.suggestion-btn.add');
            addBtn.disabled = true;
            
            try {
                const res = await fetch(`${API_URL}/contacts`, {
                    method: 'POST',
                    headers: authHeaders(),
                    body: JSON.stringify({ contactId: userId })
                });
                
                const data = await res.json();
                
                if (!res.ok) {
                    throw new Error(data.error || 'Erreur lors de l\'ajout');
                }
                
                // Remove card with animation
                cardElement.style.transform = 'translateX(100%)';
                cardElement.style.opacity = '0';
                setTimeout(() => {
                    cardElement.remove();
                    suggestions = suggestions.filter(s => s.user.id !== userId);
                    if (suggestions.length === 0) {
                        renderSuggestions('Bravo ! Tu as ajouté toutes les suggestions');
                    }
                }, 300);
                
                showToast({ type: 'success', message: 'Contact ajouté !' });
                
                // Refresh contacts
                loadContacts();
                
            } catch (e) {
                showToast({ type: 'error', message: e.message });
                addBtn.disabled = false;
            }
        }
        
        async function ignoreSuggestion(userId, cardElement) {
            const ignoreBtn = cardElement.querySelector('.suggestion-btn.ignore');
            ignoreBtn.disabled = true;
            
            try {
                const res = await fetch(`${API_URL}/suggestions`, {
                    method: 'POST',
                    headers: authHeaders(),
                    body: JSON.stringify({ userId })
                });
                
                if (!res.ok) {
                    const data = await res.json();
                    throw new Error(data.error || 'Erreur');
                }
                
                // Remove card with animation
                cardElement.style.transform = 'translateX(-100%)';
                cardElement.style.opacity = '0';
                setTimeout(() => {
                    cardElement.remove();
                    suggestions = suggestions.filter(s => s.user.id !== userId);
                    if (suggestions.length === 0) {
                        renderSuggestions('Plus de suggestions pour le moment');
                    }
                }, 300);
                
            } catch (e) {
                showToast({ type: 'error', message: e.message });
                ignoreBtn.disabled = false;
            }
        }

        // ===== CHAT =====
        let typingTimeout = null;
        let isTyping = false;
        
        function setupChatInput() {
            const input = document.getElementById('chat-input');
            const btn = document.getElementById('send-btn');
            const charCount = document.getElementById('chat-char-count');
            
            input.addEventListener('input', () => {
                btn.disabled = !input.value.trim();
                
                // Update character counter
                const len = input.value.length;
                charCount.textContent = `${len}/280`;
                charCount.classList.remove('warning', 'error');
                if (len > 250) charCount.classList.add('error');
                else if (len > 220) charCount.classList.add('warning');
                
                // Typing indicator logic - broadcast typing state
                if (input.value.trim() && !isTyping) {
                    isTyping = true;
                    broadcastTypingState(true);
                }
                
                // Clear existing timeout
                if (typingTimeout) clearTimeout(typingTimeout);
                
                // Set timeout to stop typing indicator after 2 seconds of inactivity
                typingTimeout = setTimeout(() => {
                    if (isTyping) {
                        isTyping = false;
                        broadcastTypingState(false);
                    }
                }, 2000);
                
                // Auto-save chat draft
                if (currentChatContact) {
                    scheduleChatDraftSave(currentChatContact.contact_user_id, input.value);
                }
            });
            
            input.addEventListener('keypress', (e) => {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    sendMessage();
                }
            });
            
            // Stop typing when input loses focus
            input.addEventListener('blur', () => {
                if (isTyping) {
                    isTyping = false;
                    if (typingTimeout) clearTimeout(typingTimeout);
                    broadcastTypingState(false);
                }
            });
        }
        
        // ===== SUPABASE REALTIME INITIALIZATION =====
        function initSupabaseRealtime() {
            if (typeof supabase === 'undefined' || !supabase.createClient) {
                console.warn('Supabase client not loaded');
                return;
            }
            
            try {
                supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
                console.debug('Supabase Realtime initialized');
            } catch (e) {
                console.warn('Failed to initialize Supabase:', e);
            }
        }
        
        // Subscribe to typing channel for a specific chat
        function subscribeToTypingChannel(contactId) {
            if (!supabaseClient || !user) return;
            
            // Unsubscribe from previous channel if exists
            unsubscribeFromTypingChannel();
            
            // Create a unique channel name for this conversation (sorted IDs for consistency)
            const ids = [user.id, contactId].sort();
            const channelName = `typing:${ids[0]}:${ids[1]}`;
            
            typingChannel = supabaseClient.channel(channelName, {
                config: { broadcast: { self: false } }
            });
            
            typingChannel
                .on('broadcast', { event: 'typing' }, (payload) => {
                    // Only show indicator if it's from the contact (not ourselves)
                    if (payload.payload.userId !== user.id) {
                        showTypingIndicator(payload.payload.isTyping, payload.payload.userName);
                    }
                })
                .subscribe((status) => {
                    console.debug('Typing channel status:', status);
                });
        }
        
        // Unsubscribe from typing channel
        function unsubscribeFromTypingChannel() {
            if (typingChannel) {
                supabaseClient.removeChannel(typingChannel);
                typingChannel = null;
            }
        }
        
        // Broadcast typing state via Supabase Realtime
        function broadcastTypingState(typing) {
            if (!typingChannel || !user || !currentChatContact) {
                console.debug('Typing state (local only):', typing);
                return;
            }
            
            const userName = user.email?.split('@')[0] || 'Quelqu\'un';
            
            typingChannel.send({
                type: 'broadcast',
                event: 'typing',
                payload: {
                    userId: user.id,
                    userName: userName,
                    isTyping: typing,
                    timestamp: Date.now()
                }
            }).catch(e => console.debug('Typing broadcast error:', e));
        }
        
        // Show/hide typing indicator from contact
        function showTypingIndicator(show = true, userName = null) {
            const indicator = document.getElementById('typing-indicator');
            const label = document.getElementById('typing-label');
            const container = document.getElementById('chat-messages');
            
            if (!indicator) return;
            
            if (show) {
                // Update indicator to show who's typing
                if (userName && label) {
                    label.textContent = `${userName} écrit...`;
                    indicator.setAttribute('aria-label', `${userName} est en train d'écrire`);
                } else if (label) {
                    label.textContent = 'écrit...';
                }
                indicator.classList.add('visible');
                // Scroll to show typing indicator
                container.scrollTo({
                    top: container.scrollHeight,
                    behavior: 'smooth'
                });
            } else {
                indicator.classList.remove('visible');
            }
        }
        
        let lastFocusedElement = null;
        
        function openChat(contact) {
            lastFocusedElement = document.activeElement;
            currentChatContact = contact;
            unreadCounts[contact.contact_user_id] = 0;
            renderContacts();
            
            const name = contact.contact?.display_name || contact.contact?.email?.split('@')[0] || 'Contact';
            const avatarUrl = contact.contact?.avatar_url;
            const initial = name.charAt(0).toUpperCase();
            
            document.getElementById('chat-contact-name').textContent = name;
            
            // Display contact status and last seen in chat header
            const statusEmoji = contact.contact?.status_emoji;
            const statusText = contact.contact?.status_text;
            const lastSeenAt = contact.contact?.last_seen_at;
            const chatStatus = document.getElementById('chat-contact-status');
            
            // Build status display with last seen
            let statusHtml = '';
            
            // First show user status if available
            if (statusEmoji || statusText) {
                statusHtml += `${statusEmoji ? `<span>${statusEmoji}</span>` : ''}${statusText ? `<span>${escapeHtml(statusText)}</span>` : ''}`;
            }
            
            // Add last seen info
            const lastSeenInfo = formatLastSeen(lastSeenAt);
            if (statusHtml) {
                statusHtml += `<span style="margin: 0 4px; opacity: 0.5;">•</span>`;
            }
            statusHtml += `<span class="chat-last-seen ${lastSeenInfo.isOnline ? 'online' : ''}">`;
            statusHtml += `<span class="chat-last-seen-dot"></span>`;
            statusHtml += `<span>${escapeHtml(lastSeenInfo.text)}</span>`;
            statusHtml += `</span>`;
            
            chatStatus.innerHTML = statusHtml;
            chatStatus.style.display = 'flex';
            
            const chatAvatar = document.getElementById('chat-contact-avatar');
            chatAvatar.innerHTML = avatarUrl 
                ? `<img src="${avatarUrl}" alt="">`
                : `<span aria-hidden="true">${initial}</span>`;
            
            const chatPanel = document.getElementById('chat-panel');
            const chatOverlay = document.getElementById('chat-overlay');
            
            chatPanel.classList.add('open');
            chatPanel.setAttribute('aria-hidden', 'false');
            chatOverlay.classList.add('open');
            
            // Focus on chat input and restore any saved draft
            setTimeout(() => {
                const chatInput = document.getElementById('chat-input');
                const sendBtn = document.getElementById('send-btn');
                const savedDraft = restoreChatDraft(contact.contact_user_id);
                if (savedDraft) {
                    chatInput.value = savedDraft;
                    sendBtn.disabled = !savedDraft.trim();
                }
                chatInput.focus();
            }, 100);
            
            // Setup focus trap
            setupFocusTrap(chatPanel);
            
            // Subscribe to typing channel for this conversation
            subscribeToTypingChannel(contact.contact_user_id);
            
            loadMessages();
            loadPinnedMessages();
            loadReminders();
            messagePollingInterval = setInterval(loadMessages, 3000);
            
            // Reset pinned messages section state
            document.getElementById('pinned-messages-section').classList.remove('open');
            document.getElementById('chat-pin-btn').setAttribute('aria-expanded', 'false');
            
            // Update archive button state
            const archiveBtn = document.getElementById('chat-archive-btn');
            const isArchived = contact.archived || false;
            archiveBtn.classList.toggle('archived', isArchived);
            archiveBtn.setAttribute('aria-label', isArchived ? 'Désarchiver cette conversation' : 'Archiver cette conversation');
            archiveBtn.setAttribute('title', isArchived ? 'Désarchiver' : 'Archiver');
            
            // Update mute button state
            const isMuted = contact.is_muted || false;
            updateMuteButton(isMuted);
            
            // Update private note button state
            updateNoteButtonState();
            
            // Show quick replies when chat opens
            showQuickReplies();
        }

        function closeChat() {
            // Save current chat draft before closing
            if (currentChatContact) {
                const chatInput = document.getElementById('chat-input');
                if (chatInput && chatInput.value.trim()) {
                    saveChatDraft(currentChatContact.contact_user_id, chatInput.value);
                }
            }
            
            const chatPanel = document.getElementById('chat-panel');
            const chatOverlay = document.getElementById('chat-overlay');
            
            chatPanel.classList.remove('open');
            chatPanel.setAttribute('aria-hidden', 'true');
            chatOverlay.classList.remove('open');
            
            // Broadcast that we stopped typing before closing
            if (isTyping) {
                isTyping = false;
                broadcastTypingState(false);
            }
            
            // Unsubscribe from typing channel
            unsubscribeFromTypingChannel();
            
            // Stop any playing audio
            if (currentAudioPlayer) {
                currentAudioPlayer.pause();
                currentAudioPlayer = null;
            }
            
            // Cancel any ongoing voice recording
            if (mediaRecorder && mediaRecorder.state === 'recording') {
                mediaRecorder.stop();
            }
            cancelVoiceMessage();
            
            currentChatContact = null;
            if (messagePollingInterval) {
                clearInterval(messagePollingInterval);
                messagePollingInterval = null;
            }
            
            // Reset pinned messages
            pinnedMessages = [];
            pinnedMessageIds = new Set();
            document.getElementById('pinned-messages-section').classList.remove('open');
            
            // Reset reminders
            reminders = [];
            reminderMessageIds = new Set();
            
            // Hide quick replies
            hideQuickReplies();
            
            // Restore focus
            if (lastFocusedElement) {
                lastFocusedElement.focus();
                lastFocusedElement = null;
            }
        }
        
        // ===== FOCUS TRAP FOR MODALS =====
        function setupFocusTrap(container) {
            const focusableSelectors = 'button:not([disabled]), [href], input:not([disabled]), select:not([disabled]), textarea:not([disabled]), [tabindex]:not([tabindex="-1"])';
            
            container.addEventListener('keydown', function trapFocus(e) {
                if (e.key !== 'Tab') return;
                
                const focusableElements = container.querySelectorAll(focusableSelectors);
                const firstFocusable = focusableElements[0];
                const lastFocusable = focusableElements[focusableElements.length - 1];
                
                if (e.shiftKey && document.activeElement === firstFocusable) {
                    e.preventDefault();
                    lastFocusable.focus();
                } else if (!e.shiftKey && document.activeElement === lastFocusable) {
                    e.preventDefault();
                    firstFocusable.focus();
                }
            });
        }

        async function loadMessages() {
            if (!currentChatContact) return;
            
            try {
                const res = await fetch(`${API_URL}/messages?contact_id=${currentChatContact.contact_user_id}`, { headers: authHeaders() });
                const data = await res.json();
                
                const messages = data.messages || [];
                if (messages.length > 0) {
                    lastMessageIds[currentChatContact.contact_user_id] = messages[messages.length - 1].id;
                }
                
                renderMessages(messages);
            } catch (e) {}
        }

        function renderMessages(messages) {
            const container = document.getElementById('chat-messages');
            const wasAtBottom = container.scrollHeight - container.scrollTop <= container.clientHeight + 50;
            const contactName = currentChatContact?.contact?.display_name || 'Contact';
            
            // Preserve typing indicator state
            const typingIndicator = document.getElementById('typing-indicator');
            const wasTypingVisible = typingIndicator?.classList.contains('visible');
            
            let lastDate = null;
            let html = '';
            
            messages.forEach((msg, index) => {
                const isSent = msg.sender_id === user.id;
                const sender = isSent ? 'Toi' : contactName;
                const msgDate = new Date(msg.created_at);
                const msgDateStr = msgDate.toDateString();
                
                // Add date separator if new day
                if (msgDateStr !== lastDate) {
                    lastDate = msgDateStr;
                    html += `<div class="chat-date-separator" aria-label="Messages du ${formatDateSeparator(msg.created_at)}"><span>${formatDateSeparator(msg.created_at)}</span></div>`;
                }
                
                if (msg.is_ping) {
                    html += `<div class="chat-message ping" role="article" aria-label="${sender} a envoyé un coucou"><span aria-hidden="true">👋</span></div>`;
                } else if (msg.sticker_id) {
                    // Sticker message
                    let receiptHtml = '';
                    if (isSent) {
                        const readStatus = msg.read_at ? 'read' : 'delivered';
                        const checkIcon = `<svg viewBox="0 0 16 11" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M1 5.5L5 9.5L14.5 1"/></svg>`;
                        const doubleCheckIcon = `<svg viewBox="0 0 20 11" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M1 5.5L5 9.5L14.5 1"/><path d="M5 5.5L9 9.5L18.5 1"/></svg>`;
                        receiptHtml = `<span class="chat-read-receipt ${readStatus}" aria-label="${msg.read_at ? 'Lu' : 'Envoyé'}">${msg.read_at ? doubleCheckIcon : checkIcon}</span>`;
                    }
                    
                    const stickerName = getStickerName(msg.sticker_id);
                    html += `
                        <div class="chat-message sticker ${isSent ? 'sent' : 'received'}" id="msg-${msg.id}" role="article" aria-label="${sender} a envoyé un sticker ${stickerName}">
                            <div class="chat-message-actions">
                                ${getPinButtonHtml(msg.id)}
                            </div>
                            <div class="sticker-content">
                                <img src="/assets/stickers/${escapeHtml(msg.sticker_id)}.svg" alt="${stickerName}" loading="lazy">
                            </div>
                            <div class="chat-message-meta">
                                <span class="chat-message-time">${formatMessageTime(msg.created_at)}</span>
                                ${receiptHtml}
                            </div>
                        </div>
                    `;
                } else if (msg.gif_url) {
                    // GIF message
                    let receiptHtml = '';
                    if (isSent) {
                        const readStatus = msg.read_at ? 'read' : 'delivered';
                        const checkIcon = `<svg viewBox="0 0 16 11" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M1 5.5L5 9.5L14.5 1"/></svg>`;
                        const doubleCheckIcon = `<svg viewBox="0 0 20 11" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M1 5.5L5 9.5L14.5 1"/><path d="M5 5.5L9 9.5L18.5 1"/></svg>`;
                        receiptHtml = `<span class="chat-read-receipt ${readStatus}" aria-label="${msg.read_at ? 'Lu' : 'Envoyé'}">${msg.read_at ? doubleCheckIcon : checkIcon}</span>`;
                    }
                    
                    html += `
                        <div class="chat-message gif ${isSent ? 'sent' : 'received'}" id="msg-${msg.id}" role="article" aria-label="${sender} a envoyé un GIF">
                            <div class="chat-message-actions">
                                ${getPinButtonHtml(msg.id)}
                            </div>
                            <div class="gif-content giphy-content-gif">
                                <img src="${escapeHtml(msg.gif_url)}" alt="GIF" loading="lazy">
                                <span class="giphy-badge">GIF</span>
                            </div>
                            <div class="chat-message-meta">
                                <span class="chat-message-time">${formatMessageTime(msg.created_at)}</span>
                                ${receiptHtml}
                            </div>
                        </div>
                    `;
                } else if (msg.voice_url) {
                    // Voice message
                    const duration = msg.voice_duration || 0;
                    const mins = Math.floor(duration / 60);
                    const secs = Math.floor(duration % 60);
                    const durationStr = `${mins}:${secs.toString().padStart(2, '0')}`;
                    const waveformData = msg.voice_waveform || [];
                    
                    // Build read receipt for sent messages
                    let receiptHtml = '';
                    if (isSent) {
                        const readStatus = msg.read_at ? 'read' : 'delivered';
                        const checkIcon = `<svg viewBox="0 0 16 11" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M1 5.5L5 9.5L14.5 1"/></svg>`;
                        const doubleCheckIcon = `<svg viewBox="0 0 20 11" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M1 5.5L5 9.5L14.5 1"/><path d="M5 5.5L9 9.5L18.5 1"/></svg>`;
                        receiptHtml = `<span class="chat-read-receipt ${readStatus}" aria-label="${msg.read_at ? 'Lu' : 'Envoyé'}">${msg.read_at ? doubleCheckIcon : checkIcon}</span>`;
                    }
                    
                    html += `
                        <div class="chat-message ${isSent ? 'sent' : 'received'}" id="msg-${msg.id}" role="article" aria-label="${sender} a envoyé un message vocal de ${durationStr}">
                            <div class="chat-message-actions">
                                ${getPinButtonHtml(msg.id)}
                            </div>
                            <div class="chat-message-content">
                                <div class="voice-message">
                                    <button class="voice-play-btn" id="voice-play-${msg.id}" onclick="playVoiceMessage('${msg.id}', '${escapeHtml(msg.voice_url)}')" type="button" aria-label="Écouter le message vocal">
                                        ${getPlayIcon()}
                                    </button>
                                    <div class="voice-waveform" id="voice-waveform-${msg.id}">
                                        ${renderVoiceWaveform(waveformData, msg.id)}
                                    </div>
                                    <span class="voice-duration" id="voice-duration-${msg.id}" data-duration="${duration}">${durationStr}</span>
                                </div>
                            </div>
                            <div class="chat-message-meta">
                                <span class="chat-message-time">${formatMessageTime(msg.created_at)}</span>
                                ${receiptHtml}
                            </div>
                        </div>
                    `;
                } else if (msg.file_url) {
                    // File attachment message
                    let receiptHtml = '';
                    if (isSent) {
                        const readStatus = msg.read_at ? 'read' : 'delivered';
                        const checkIcon = `<svg viewBox="0 0 16 11" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M1 5.5L5 9.5L14.5 1"/></svg>`;
                        const doubleCheckIcon = `<svg viewBox="0 0 20 11" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M1 5.5L5 9.5L14.5 1"/><path d="M5 5.5L9 9.5L18.5 1"/></svg>`;
                        receiptHtml = `<span class="chat-read-receipt ${readStatus}" aria-label="${msg.read_at ? 'Lu' : 'Envoyé'}">${msg.read_at ? doubleCheckIcon : checkIcon}</span>`;
                    }
                    
                    html += `
                        <div class="chat-message ${isSent ? 'sent' : 'received'}" id="msg-${msg.id}" role="article" aria-label="${sender} a envoyé un fichier">
                            <div class="chat-message-actions">
                                ${getPinButtonHtml(msg.id)}
                            </div>
                            <div class="chat-message-content">
                                ${renderFileAttachment(msg.file_url, msg.file_name, msg.file_size, msg.file_type)}
                            </div>
                            <div class="chat-message-meta">
                                <span class="chat-message-time">${formatMessageTime(msg.created_at)}</span>
                                ${receiptHtml}
                            </div>
                        </div>
                    `;
                } else if (msg.location_lat && msg.location_lng) {
                    // Location message
                    let receiptHtml = '';
                    if (isSent) {
                        const readStatus = msg.read_at ? 'read' : 'delivered';
                        const checkIcon = `<svg viewBox="0 0 16 11" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M1 5.5L5 9.5L14.5 1"/></svg>`;
                        const doubleCheckIcon = `<svg viewBox="0 0 20 11" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M1 5.5L5 9.5L14.5 1"/><path d="M5 5.5L9 9.5L18.5 1"/></svg>`;
                        receiptHtml = `<span class="chat-read-receipt ${readStatus}" aria-label="${msg.read_at ? 'Lu' : 'Envoyé'}">${msg.read_at ? doubleCheckIcon : checkIcon}</span>`;
                    }
                    
                    html += `
                        <div class="chat-message location ${isSent ? 'sent' : 'received'}" id="msg-${msg.id}" role="article" aria-label="${sender} a partagé sa position">
                            <div class="chat-message-actions">
                                ${getPinButtonHtml(msg.id)}
                            </div>
                            ${renderLocationMessage(msg, isSent)}
                            <div class="chat-message-meta">
                                <span class="chat-message-time">${formatMessageTime(msg.created_at)}</span>
                                ${receiptHtml}
                            </div>
                        </div>
                    `;
                } else {
                    // Build read receipt for sent messages
                    let receiptHtml = '';
                    if (isSent) {
                        const readStatus = msg.read_at ? 'read' : 'delivered';
                        const checkIcon = `<svg viewBox="0 0 16 11" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M1 5.5L5 9.5L14.5 1"/></svg>`;
                        const doubleCheckIcon = `<svg viewBox="0 0 20 11" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M1 5.5L5 9.5L14.5 1"/><path d="M5 5.5L9 9.5L18.5 1"/></svg>`;
                        receiptHtml = `<span class="chat-read-receipt ${readStatus}" aria-label="${msg.read_at ? 'Lu' : 'Envoyé'}">${msg.read_at ? doubleCheckIcon : checkIcon}</span>`;
                    }
                    
                    // Build reply quote HTML if this message is a reply
                    let replyQuoteHtml = '';
                    if (msg.reply_to && msg.reply_to.id) {
                        const replyContent = msg.reply_to.is_ping 
                            ? '👋 Coucou' 
                            : (msg.reply_to.content || '').slice(0, 60) + ((msg.reply_to.content || '').length > 60 ? '…' : '');
                        const replyAuthor = msg.reply_to.is_mine ? 'Toi' : contactName;
                        replyQuoteHtml = `
                            <div class="reply-quote" onclick="scrollToMessage('${msg.reply_to.id}')" role="button" tabindex="0" aria-label="Voir le message original">
                                <span class="reply-quote-author">${escapeHtml(replyAuthor)}</span>
                                <span class="reply-quote-text">${escapeHtml(replyContent)}</span>
                            </div>
                        `;
                    }
                    
                    html += `
                        <div class="chat-message ${isSent ? 'sent' : 'received'}" id="msg-${msg.id}" role="article" aria-label="${sender} dit">
                            <div class="chat-message-actions">
                                ${getPinButtonHtml(msg.id)}
                            </div>
                            ${replyQuoteHtml}
                            <div class="chat-message-content">${renderMentions(msg.content)}</div>
                            <div class="chat-message-meta">
                                <span class="chat-message-time">${formatMessageTime(msg.created_at)}</span>
                                ${receiptHtml}
                            </div>
                        </div>
                    `;
                }
            });
            
            // Add typing indicator at the end
            html += `
                <div class="typing-indicator${wasTypingVisible ? ' visible' : ''}" id="typing-indicator" aria-live="polite" aria-label="En train d'écrire">
                    <span class="typing-indicator-label" id="typing-label">écrit...</span>
                    <div class="typing-dots">
                        <div class="typing-dot"></div>
                        <div class="typing-dot"></div>
                        <div class="typing-dot"></div>
                    </div>
                </div>
            `;
            
            container.innerHTML = html;

            // Smooth scroll to bottom
            if (wasAtBottom) {
                container.scrollTo({
                    top: container.scrollHeight,
                    behavior: 'smooth'
                });
            }
        }

        async function sendMessage() {
            const inputArea = document.getElementById('chat-input-area');
            
            // Check if we're sending a voice message
            if (inputArea.classList.contains('voice-mode') && voiceAudioBlob) {
                await sendVoiceMessage();
                return;
            }
            
            // Check if we're sending a file attachment
            if (inputArea.classList.contains('file-mode') && pendingFileAttachment) {
                await sendFileMessage();
                return;
            }
            
            const input = document.getElementById('chat-input');
            const content = input.value.trim();
            if (!content || !currentChatContact) return;

            const btn = document.getElementById('send-btn');
            btn.disabled = true;
            
            // Stop typing indicator
            if (isTyping) {
                isTyping = false;
                if (typingTimeout) clearTimeout(typingTimeout);
                broadcastTypingState(false);
            }
            
            // Add sending animation
            btn.classList.add('sending');
            triggerHaptic('tap');
            
            // Optimistic update - show message immediately
            const optimisticMsg = {
                id: 'temp-' + Date.now(),
                sender_id: user.id,
                content: content,
                created_at: new Date().toISOString(),
                is_ping: false,
                read_at: null,
                _sending: true,
                reply_to_id: replyingTo?.id || null,
                reply_to: replyingTo ? { ...replyingTo } : null
            };
            
            // Store reply info before clearing
            const replyToId = replyingTo?.id || null;
            
            addOptimisticMessage(optimisticMsg);
            input.value = '';
            clearReplyingTo(); // Clear reply state after capturing
            
            // Reset character counter
            const charCount = document.getElementById('chat-char-count');
            if (charCount) {
                charCount.textContent = '0/280';
                charCount.classList.remove('warning', 'error');
            }
            
            // Clear saved chat draft after sending
            if (currentChatContact) {
                clearChatDraft(currentChatContact.contact_user_id);
            }

            try {
                const messageData = { contact_id: currentChatContact.contact_user_id, content };
                if (replyToId) {
                    messageData.reply_to_id = replyToId;
                }
                
                const res = await fetch(`${API_URL}/messages`, {
                    method: 'POST',
                    headers: authHeaders(),
                    body: JSON.stringify(messageData)
                });
                
                if (!res.ok) throw new Error('Échec envoi');
                
                triggerHaptic('success');
                // Refresh to get the real message with proper ID
                loadMessages();
            } catch (e) {
                triggerHaptic('error');
                showToast({ type: 'error', message: 'Message pas parti. Réessaie ?' });
                // Remove optimistic message on error
                removeOptimisticMessage(optimisticMsg.id);
            } finally {
                setTimeout(() => btn.classList.remove('sending'), 500);
                btn.disabled = !input.value.trim();
            }
        }
        
        // Add a message optimistically before server confirms
        function addOptimisticMessage(msg) {
            const container = document.getElementById('chat-messages');
            
            const msgEl = document.createElement('div');
            msgEl.className = 'chat-message sent';
            msgEl.id = `msg-${msg.id}`;
            msgEl.setAttribute('role', 'article');
            msgEl.setAttribute('aria-label', 'Toi dit');
            
            const checkIcon = `<svg viewBox="0 0 16 11" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M1 5.5L5 9.5L14.5 1"/></svg>`;
            
            msgEl.innerHTML = `
                <div class="chat-message-content">${renderMentions(msg.content)}</div>
                <div class="chat-message-meta">
                    <span class="chat-message-time">${formatMessageTime(msg.created_at)}</span>
                    <span class="chat-read-receipt sent" aria-label="Envoi en cours">${checkIcon}</span>
                </div>
            `;
            
            container.appendChild(msgEl);
            
            // Smooth scroll to the new message
            container.scrollTo({
                top: container.scrollHeight,
                behavior: 'smooth'
            });
        }
        
        // Remove an optimistic message (on error)
        function removeOptimisticMessage(msgId) {
            const msgEl = document.getElementById(`msg-${msgId}`);
            if (msgEl) {
                msgEl.style.opacity = '0';
                msgEl.style.transform = 'translateX(20px)';
                setTimeout(() => msgEl.remove(), 300);
            }
        }

        // ===== PINNED MESSAGES =====
        let pinnedMessages = [];
        let pinnedMessageIds = new Set();
        
        async function loadPinnedMessages() {
            if (!currentChatContact) return;
            
            try {
                const res = await fetch(`${API_URL}/pinned-messages?contact_id=${currentChatContact.contact_user_id}`, { 
                    headers: authHeaders() 
                });
                
                if (!res.ok) {
                    pinnedMessages = [];
                    pinnedMessageIds = new Set();
                    updatePinnedMessagesUI();
                    return;
                }
                
                const data = await res.json();
                pinnedMessages = data.pinned_messages || [];
                pinnedMessageIds = new Set(pinnedMessages.map(pm => pm.id));
                updatePinnedMessagesUI();
            } catch (e) {
                console.error('Failed to load pinned messages:', e);
                pinnedMessages = [];
                pinnedMessageIds = new Set();
                updatePinnedMessagesUI();
            }
        }
        
        function updatePinnedMessagesUI() {
            const pinBtn = document.getElementById('chat-pin-btn');
            const pinCount = document.getElementById('pin-count');
            const listContainer = document.getElementById('pinned-messages-list');
            const contactName = currentChatContact?.contact?.display_name || 'Contact';
            
            // Update pin count badge
            if (pinnedMessages.length > 0) {
                pinCount.textContent = pinnedMessages.length;
                pinCount.style.display = 'flex';
                pinBtn.classList.add('has-pins');
            } else {
                pinCount.style.display = 'none';
                pinBtn.classList.remove('has-pins');
            }
            
            // Render pinned messages list
            if (pinnedMessages.length === 0) {
                listContainer.innerHTML = `
                    <div class="pinned-messages-empty">
                        Aucun message épinglé
                    </div>
                `;
                return;
            }
            
            let html = '';
            pinnedMessages.forEach(msg => {
                const isSent = msg.sender_id === user.id;
                const sender = isSent ? 'Toi' : contactName;
                let contentPreview = '';
                
                if (msg.is_ping) {
                    contentPreview = '👋 Coucou';
                } else if (msg.sticker_id) {
                    contentPreview = '🎨 Sticker';
                } else if (msg.gif_url) {
                    contentPreview = '🖼️ GIF';
                } else if (msg.file_url) {
                    contentPreview = '📎 ' + (msg.file_name || 'Fichier');
                } else {
                    contentPreview = msg.content || '';
                }
                
                html += `
                    <div class="pinned-message-item" onclick="scrollToMessage('${msg.id}')" data-msg-id="${msg.id}">
                        <div class="pinned-message-content">
                            <div class="pinned-message-text">${escapeHtml(contentPreview)}</div>
                            <div class="pinned-message-meta">${sender} • ${formatMessageTime(msg.created_at)}</div>
                        </div>
                        <button class="pinned-message-unpin" onclick="event.stopPropagation(); unpinMessage('${msg.id}')" type="button" aria-label="Désépingler">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/>
                            </svg>
                        </button>
                    </div>
                `;
            });
            
            listContainer.innerHTML = html;
        }
        
        function togglePinnedMessagesSection() {
            const section = document.getElementById('pinned-messages-section');
            const pinBtn = document.getElementById('chat-pin-btn');
            const isOpen = section.classList.contains('open');
            
            if (isOpen) {
                section.classList.remove('open');
                pinBtn.setAttribute('aria-expanded', 'false');
            } else {
                section.classList.add('open');
                pinBtn.setAttribute('aria-expanded', 'true');
            }
        }
        
        function scrollToMessage(messageId) {
            const msgEl = document.getElementById(`msg-${messageId}`);
            if (msgEl) {
                // Close pinned section
                document.getElementById('pinned-messages-section').classList.remove('open');
                document.getElementById('chat-pin-btn').setAttribute('aria-expanded', 'false');
                
                // Scroll to message
                msgEl.scrollIntoView({ behavior: 'smooth', block: 'center' });
                
                // Highlight animation
                msgEl.style.transition = 'all 0.3s';
                msgEl.style.boxShadow = '0 0 0 3px var(--color-brand)';
                setTimeout(() => {
                    msgEl.style.boxShadow = '';
                }, 1500);
            }
        }
        
        async function pinMessage(messageId) {
            if (!currentChatContact) return;
            
            try {
                const res = await fetch(`${API_URL}/pinned-messages`, {
                    method: 'POST',
                    headers: authHeaders(),
                    body: JSON.stringify({ 
                        message_id: messageId, 
                        contact_id: currentChatContact.contact_user_id 
                    })
                });
                
                if (!res.ok) {
                    const data = await res.json();
                    showToast({ type: 'error', message: data.error || 'Impossible d\'épingler' });
                    return;
                }
                
                // Update local state
                pinnedMessageIds.add(messageId);
                
                // Reload pinned messages
                await loadPinnedMessages();
                
                // Update pin button on message
                updateMessagePinButton(messageId, true);
                
                showToast({ type: 'success', message: 'Message épinglé 📌' });
                triggerHaptic('success');
            } catch (e) {
                console.error('Pin failed:', e);
                showToast({ type: 'error', message: 'Erreur lors de l\'épinglage' });
            }
        }
        
        async function unpinMessage(messageId) {
            try {
                const res = await fetch(`${API_URL}/pinned-messages?message_id=${messageId}`, {
                    method: 'DELETE',
                    headers: authHeaders()
                });
                
                if (!res.ok) {
                    showToast({ type: 'error', message: 'Impossible de désépingler' });
                    return;
                }
                
                // Update local state
                pinnedMessageIds.delete(messageId);
                
                // Reload pinned messages
                await loadPinnedMessages();
                
                // Update pin button on message
                updateMessagePinButton(messageId, false);
                
                showToast({ type: 'success', message: 'Message désépinglé' });
                triggerHaptic('tap');
            } catch (e) {
                console.error('Unpin failed:', e);
                showToast({ type: 'error', message: 'Erreur lors de la suppression' });
            }
        }
        
        function togglePinMessage(messageId) {
            if (pinnedMessageIds.has(messageId)) {
                unpinMessage(messageId);
            } else {
                pinMessage(messageId);
            }
        }
        
        function updateMessagePinButton(messageId, isPinned) {
            const btn = document.querySelector(`[data-pin-msg-id="${messageId}"]`);
            if (btn) {
                if (isPinned) {
                    btn.classList.add('pinned');
                    btn.setAttribute('aria-label', 'Désépingler');
                } else {
                    btn.classList.remove('pinned');
                    btn.setAttribute('aria-label', 'Épingler');
                }
            }
        }
        
        function getPinButtonHtml(messageId) {
            const isPinned = pinnedMessageIds.has(messageId);
            const hasReminder = reminderMessageIds.has(messageId);
            const isStarred = starredMessageIds.has(messageId);
            return `
                <button class="message-action-btn ${isStarred ? 'starred' : ''}" 
                        onclick="toggleStarMessage('${messageId}')" 
                        data-star-msg-id="${messageId}"
                        type="button" 
                        aria-label="${isStarred ? 'Retirer des favoris' : 'Ajouter aux favoris'}">
                    <svg viewBox="0 0 24 24" fill="${isStarred ? 'currentColor' : 'none'}" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/>
                    </svg>
                </button>
                <button class="message-action-btn ${isPinned ? 'pinned' : ''}" 
                        onclick="togglePinMessage('${messageId}')" 
                        data-pin-msg-id="${messageId}"
                        type="button" 
                        aria-label="${isPinned ? 'Désépingler' : 'Épingler'}">
                    <svg viewBox="0 0 24 24" fill="${isPinned ? 'currentColor' : 'none'}" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <line x1="12" y1="17" x2="12" y2="22"/><path d="M5 17h14v-1.76a2 2 0 0 0-1.11-1.79l-1.78-.9A2 2 0 0 1 15 10.76V6h1a2 2 0 0 0 0-4H8a2 2 0 0 0 0 4h1v4.76a2 2 0 0 1-1.11 1.79l-1.78.9A2 2 0 0 0 5 15.24Z"/>
                    </svg>
                </button>
                <button class="message-action-btn ${hasReminder ? 'has-reminder' : ''}" 
                        onclick="openReminderModal('${messageId}')" 
                        data-reminder-msg-id="${messageId}"
                        type="button" 
                        aria-label="${hasReminder ? 'Modifier le rappel' : 'Programmer un rappel'}">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/>
                    </svg>
                </button>
                <button class="message-action-btn" 
                        onclick="openForwardModal('${messageId}')" 
                        data-forward-msg-id="${messageId}"
                        type="button" 
                        aria-label="Transférer ce message">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <polyline points="15 17 20 12 15 7"/>
                        <path d="M4 18v-2a4 4 0 0 1 4-4h12"/>
                    </svg>
                </button>
                <button class="message-action-btn reply-btn" 
                        onclick="setReplyingTo('${messageId}')" 
                        data-reply-msg-id="${messageId}"
                        type="button" 
                        aria-label="Répondre à ce message">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <polyline points="9 17 4 12 9 7"/>
                        <path d="M20 18v-2a4 4 0 0 0-4-4H4"/>
                    </svg>
                </button>
            `;
        }

        // ===== REPLY TO MESSAGE =====
        
        // Set the message being replied to
        function setReplyingTo(messageId) {
            // Find the message in the current messages list
            const container = document.getElementById('chat-messages');
            const msgEl = document.getElementById(`msg-${messageId}`);
            
            if (!msgEl) return;
            
            // Get message content from the DOM
            const contentEl = msgEl.querySelector('.chat-message-content');
            const content = contentEl ? contentEl.textContent.trim() : '';
            const isPing = msgEl.classList.contains('ping');
            const isSent = msgEl.classList.contains('sent');
            
            replyingTo = {
                id: messageId,
                content: isPing ? '👋 Coucou' : content,
                is_mine: isSent
            };
            
            renderReplyPreview();
            document.getElementById('chat-input')?.focus();
        }
        
        // Clear the reply state
        function clearReplyingTo() {
            replyingTo = null;
            renderReplyPreview();
        }
        
        // Render the reply preview above the input
        function renderReplyPreview() {
            let preview = document.getElementById('reply-preview');
            const inputArea = document.getElementById('chat-input-area');
            
            // Create preview element if it doesn't exist
            if (!preview && inputArea) {
                preview = document.createElement('div');
                preview.id = 'reply-preview';
                preview.className = 'reply-preview';
                inputArea.insertBefore(preview, inputArea.firstChild);
            }
            
            if (!preview) return;
            
            if (!replyingTo) {
                preview.classList.add('hidden');
                preview.innerHTML = '';
                return;
            }
            
            const contactName = currentChatContact?.contact?.display_name || 
                              currentChatContact?.contact?.email?.split('@')[0] || 'Contact';
            const authorName = replyingTo.is_mine ? 'Toi' : contactName;
            const content = (replyingTo.content || '').slice(0, 80) + ((replyingTo.content || '').length > 80 ? '…' : '');
            
            preview.innerHTML = `
                <div class="reply-preview-content">
                    <div class="reply-preview-bar"></div>
                    <div class="reply-preview-text">
                        <span class="reply-preview-author">${escapeHtml(authorName)}</span>
                        <span class="reply-preview-message">${escapeHtml(content)}</span>
                    </div>
                    <button class="reply-preview-close" onclick="clearReplyingTo()" type="button" aria-label="Annuler la réponse">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/>
                        </svg>
                    </button>
                </div>
            `;
            preview.classList.remove('hidden');
        }
        
        // Scroll to a specific message and highlight it
        function scrollToMessage(messageId) {
            const msgEl = document.getElementById(`msg-${messageId}`);
            if (msgEl) {
                msgEl.scrollIntoView({ behavior: 'smooth', block: 'center' });
                msgEl.classList.add('highlight-flash');
                setTimeout(() => msgEl.classList.remove('highlight-flash'), 1500);
            }
        }

        // ===== STARRED MESSAGES =====
        let starredMessageIds = new Set();
        
        function loadStarredMessageIds() {
            try {
                const stored = localStorage.getItem('cinq_starred_messages');
                if (stored) {
                    const data = JSON.parse(stored);
                    starredMessageIds = new Set(data.map(m => m.id));
                }
            } catch (e) {
                console.error('Failed to load starred messages:', e);
                starredMessageIds = new Set();
            }
        }
        
        function getStarredMessages() {
            try {
                const stored = localStorage.getItem('cinq_starred_messages');
                return stored ? JSON.parse(stored) : [];
            } catch (e) {
                return [];
            }
        }
        
        function saveStarredMessages(messages) {
            try {
                localStorage.setItem('cinq_starred_messages', JSON.stringify(messages));
                starredMessageIds = new Set(messages.map(m => m.id));
            } catch (e) {
                console.error('Failed to save starred messages:', e);
            }
        }
        
        function starMessage(messageId) {
            if (!currentChatContact) return;
            
            // Find the message in current chat
            const msgEl = document.getElementById(`msg-${messageId}`);
            if (!msgEl) return;
            
            const contentEl = msgEl.querySelector('.chat-message-content');
            const isSent = msgEl.classList.contains('sent');
            const contactName = currentChatContact?.contact?.display_name || 'Contact';
            
            // Determine message content/type
            let content = '';
            let type = 'text';
            let preview = '';
            
            if (msgEl.classList.contains('ping')) {
                type = 'ping';
                content = '👋';
                preview = '👋 Coucou';
            } else if (msgEl.classList.contains('sticker')) {
                type = 'sticker';
                const img = msgEl.querySelector('.sticker-content img');
                content = img ? img.src : '';
                preview = '🎨 Sticker';
            } else if (msgEl.classList.contains('gif')) {
                type = 'gif';
                const img = msgEl.querySelector('.gif-content img');
                content = img ? img.src : '';
                preview = '🖼️ GIF';
            } else if (msgEl.querySelector('.voice-message')) {
                type = 'voice';
                const playBtn = msgEl.querySelector('.voice-play-btn');
                content = playBtn ? playBtn.getAttribute('onclick')?.match(/'([^']+\.webm)'/)?.[1] || '' : '';
                preview = '🎤 Message vocal';
            } else if (msgEl.querySelector('.file-attachment')) {
                type = 'file';
                const fileName = msgEl.querySelector('.file-attachment-name');
                content = fileName ? fileName.textContent : 'Fichier';
                preview = '📎 ' + content;
            } else if (msgEl.classList.contains('location')) {
                type = 'location';
                preview = '📍 Position';
            } else if (contentEl) {
                content = contentEl.textContent || contentEl.innerText || '';
                preview = content.length > 100 ? content.substring(0, 100) + '...' : content;
            }
            
            const timeEl = msgEl.querySelector('.chat-message-time');
            const timeText = timeEl ? timeEl.textContent : '';
            
            const starredMessage = {
                id: messageId,
                content: content,
                preview: preview,
                type: type,
                isSent: isSent,
                senderName: isSent ? 'Toi' : contactName,
                contactId: currentChatContact.contact_user_id,
                contactName: contactName,
                starredAt: new Date().toISOString(),
                messageTime: timeText
            };
            
            const messages = getStarredMessages();
            // Check if already starred
            if (!messages.find(m => m.id === messageId)) {
                messages.unshift(starredMessage); // Add at beginning
                saveStarredMessages(messages);
                updateStarButton(messageId, true);
                showToast({ type: 'success', message: 'Message ajouté aux favoris ⭐' });
                triggerHaptic('success');
            }
        }
        
        function unstarMessage(messageId) {
            const messages = getStarredMessages();
            const filtered = messages.filter(m => m.id !== messageId);
            saveStarredMessages(filtered);
            updateStarButton(messageId, false);
            showToast({ type: 'success', message: 'Message retiré des favoris' });
            triggerHaptic('tap');
        }
        
        function toggleStarMessage(messageId) {
            if (starredMessageIds.has(messageId)) {
                unstarMessage(messageId);
            } else {
                starMessage(messageId);
            }
        }
        
        function updateStarButton(messageId, isStarred) {
            const btn = document.querySelector(`[data-star-msg-id="${messageId}"]`);
            if (btn) {
                if (isStarred) {
                    btn.classList.add('starred');
                    btn.setAttribute('aria-label', 'Retirer des favoris');
                    btn.querySelector('svg').setAttribute('fill', 'currentColor');
                } else {
                    btn.classList.remove('starred');
                    btn.setAttribute('aria-label', 'Ajouter aux favoris');
                    btn.querySelector('svg').setAttribute('fill', 'none');
                }
            }
        }
        
        // Load starred message IDs on init
        loadStarredMessageIds();

        // ===== REMINDERS =====
        let reminders = [];
        let reminderMessageIds = new Set();
        let currentReminderMessageId = null;
        let currentReminderMessageContent = null;
        let selectedReminderTime = null;
        
        async function loadReminders() {
            if (!currentChatContact) return;
            
            try {
                const res = await fetch(`${API_URL}/reminders?contact_id=${currentChatContact.contact_user_id}`, { 
                    headers: authHeaders() 
                });
                
                if (!res.ok) {
                    reminders = [];
                    reminderMessageIds = new Set();
                    return;
                }
                
                const data = await res.json();
                reminders = data.reminders || [];
                reminderMessageIds = new Set(reminders.map(r => r.message_id));
                
                // Update UI to show reminder badges
                updateReminderBadges();
            } catch (e) {
                console.error('Failed to load reminders:', e);
                reminders = [];
                reminderMessageIds = new Set();
            }
        }
        
        function updateReminderBadges() {
            // Update reminder buttons on messages
            document.querySelectorAll('[data-reminder-msg-id]').forEach(btn => {
                const msgId = btn.dataset.reminderMsgId;
                if (reminderMessageIds.has(msgId)) {
                    btn.classList.add('has-reminder');
                    btn.setAttribute('aria-label', 'Modifier le rappel');
                } else {
                    btn.classList.remove('has-reminder');
                    btn.setAttribute('aria-label', 'Programmer un rappel');
                }
            });
            
            // Add reminder badges to messages
            reminders.forEach(reminder => {
                const msgEl = document.getElementById(`msg-${reminder.message_id}`);
                if (msgEl && !msgEl.querySelector('.reminder-badge')) {
                    const badge = document.createElement('div');
                    badge.className = 'reminder-badge';
                    badge.innerHTML = '⏰';
                    badge.title = formatReminderTime(reminder.remind_at);
                    msgEl.appendChild(badge);
                }
            });
        }
        
        function formatReminderTime(isoDate) {
            const date = new Date(isoDate);
            const now = new Date();
            const tomorrow = new Date(now);
            tomorrow.setDate(tomorrow.getDate() + 1);
            
            const isToday = date.toDateString() === now.toDateString();
            const isTomorrow = date.toDateString() === tomorrow.toDateString();
            
            const timeStr = date.toLocaleTimeString('fr-FR', { hour: '2-digit', minute: '2-digit' });
            
            if (isToday) return `Aujourd'hui à ${timeStr}`;
            if (isTomorrow) return `Demain à ${timeStr}`;
            
            return date.toLocaleDateString('fr-FR', { 
                weekday: 'short', 
                day: 'numeric', 
                month: 'short',
                hour: '2-digit',
                minute: '2-digit'
            });
        }
        
        function openReminderModal(messageId) {
            // Find the message content
            const msgEl = document.getElementById(`msg-${messageId}`);
            let messageContent = '';
            
            if (msgEl) {
                const contentEl = msgEl.querySelector('.chat-message-content');
                if (contentEl) {
                    messageContent = contentEl.textContent.substring(0, 100);
                } else if (msgEl.classList.contains('ping')) {
                    messageContent = '👋 Coucou';
                } else if (msgEl.classList.contains('sticker')) {
                    messageContent = '🎨 Sticker';
                } else if (msgEl.classList.contains('gif')) {
                    messageContent = '🖼️ GIF';
                }
            }
            
            currentReminderMessageId = messageId;
            currentReminderMessageContent = messageContent;
            selectedReminderTime = null;
            
            // Check if there's already a reminder for this message
            const existingReminder = reminders.find(r => r.message_id === messageId);
            if (existingReminder) {
                // Show existing reminder with option to delete
                showExistingReminderModal(existingReminder);
                return;
            }
            
            // Setup modal
            document.getElementById('reminder-message-preview').textContent = messageContent || 'Message';
            document.getElementById('reminder-message-id').value = messageId;
            document.getElementById('reminder-note').value = '';
            document.getElementById('reminder-datetime').value = '';
            document.getElementById('reminder-custom-time').style.display = 'none';
            document.getElementById('reminder-save-btn').disabled = true;
            
            // Reset quick option selection
            document.querySelectorAll('.reminder-quick-btn').forEach(btn => {
                btn.classList.remove('selected');
            });
            
            // Set minimum datetime to now
            const now = new Date();
            now.setMinutes(now.getMinutes() + 5);
            document.getElementById('reminder-datetime').min = now.toISOString().slice(0, 16);
            
            // Open modal
            const modal = document.getElementById('reminder-modal');
            modal.classList.add('open');
            modal.setAttribute('aria-hidden', 'false');
            
            triggerHaptic?.('tap');
        }
        
        function showExistingReminderModal(reminder) {
            const modal = document.getElementById('reminder-modal');
            const title = document.getElementById('reminder-modal-title');
            const preview = document.getElementById('reminder-message-preview');
            
            preview.innerHTML = `
                <div style="margin-bottom: var(--space-2);">
                    <strong>Rappel programmé</strong>
                </div>
                <div>📅 ${formatReminderTime(reminder.remind_at)}</div>
                ${reminder.note ? `<div style="margin-top: var(--space-2); font-style: italic;">📝 ${escapeHtml(reminder.note)}</div>` : ''}
            `;
            
            // Hide quick options and show delete button
            document.querySelector('.reminder-quick-options').style.display = 'none';
            document.getElementById('reminder-custom-time').style.display = 'none';
            document.querySelector('label[for="reminder-note"]').style.display = 'none';
            document.getElementById('reminder-note').style.display = 'none';
            
            const actionsDiv = document.querySelector('.reminder-actions');
            actionsDiv.innerHTML = `
                <button class="reminder-cancel-btn" onclick="closeReminderModal()" type="button">Fermer</button>
                <button class="reminder-save-btn" onclick="deleteReminder('${reminder.id}')" type="button" style="background: var(--color-error);">
                    🗑️ Supprimer le rappel
                </button>
            `;
            
            modal.classList.add('open');
            modal.setAttribute('aria-hidden', 'false');
        }
        
        function closeReminderModal() {
            const modal = document.getElementById('reminder-modal');
            modal.classList.remove('open');
            modal.setAttribute('aria-hidden', 'true');
            
            currentReminderMessageId = null;
            currentReminderMessageContent = null;
            selectedReminderTime = null;
            
            // Reset modal state for next use
            document.querySelector('.reminder-quick-options').style.display = 'grid';
            document.querySelector('label[for="reminder-note"]').style.display = 'block';
            document.getElementById('reminder-note').style.display = 'block';
            
            const actionsDiv = document.querySelector('.reminder-actions');
            actionsDiv.innerHTML = `
                <button class="reminder-cancel-btn" onclick="closeReminderModal()" type="button">Annuler</button>
                <button class="reminder-save-btn" id="reminder-save-btn" onclick="saveReminder()" type="button" disabled>
                    <span aria-hidden="true">⏰</span> Créer le rappel
                </button>
            `;
        }
        
        function selectReminderQuick(minutes) {
            selectedReminderTime = new Date();
            selectedReminderTime.setMinutes(selectedReminderTime.getMinutes() + minutes);
            
            // Update UI
            document.querySelectorAll('.reminder-quick-btn').forEach(btn => {
                btn.classList.toggle('selected', btn.dataset.minutes === String(minutes));
            });
            
            // Hide custom time input
            document.getElementById('reminder-custom-time').style.display = 'none';
            
            // Enable save button
            document.getElementById('reminder-save-btn').disabled = false;
            
            triggerHaptic?.('tap');
        }
        
        function toggleCustomReminder() {
            const customTime = document.getElementById('reminder-custom-time');
            const isVisible = customTime.style.display !== 'none';
            
            // Toggle visibility
            customTime.style.display = isVisible ? 'none' : 'block';
            
            // Deselect other options
            document.querySelectorAll('.reminder-quick-btn').forEach(btn => {
                if (btn.dataset.value !== 'custom') {
                    btn.classList.remove('selected');
                } else {
                    btn.classList.toggle('selected', !isVisible);
                }
            });
            
            if (!isVisible) {
                // Focus the datetime input
                document.getElementById('reminder-datetime').focus();
                selectedReminderTime = null;
                document.getElementById('reminder-save-btn').disabled = true;
            }
            
            triggerHaptic?.('tap');
        }
        
        // Listen for datetime input changes
        document.addEventListener('DOMContentLoaded', () => {
            const datetimeInput = document.getElementById('reminder-datetime');
            if (datetimeInput) {
                datetimeInput.addEventListener('change', (e) => {
                    const value = e.target.value;
                    if (value) {
                        selectedReminderTime = new Date(value);
                        document.getElementById('reminder-save-btn').disabled = false;
                    } else {
                        selectedReminderTime = null;
                        document.getElementById('reminder-save-btn').disabled = true;
                    }
                });
            }
        });
        
        async function saveReminder() {
            if (!currentReminderMessageId || !selectedReminderTime || !currentChatContact) {
                showToast({ type: 'error', message: 'Sélectionne une heure pour le rappel' });
                return;
            }
            
            const note = document.getElementById('reminder-note').value.trim();
            const saveBtn = document.getElementById('reminder-save-btn');
            saveBtn.disabled = true;
            saveBtn.textContent = '⏳ Création...';
            
            try {
                const res = await fetch(`${API_URL}/reminders`, {
                    method: 'POST',
                    headers: authHeaders(),
                    body: JSON.stringify({
                        message_id: currentReminderMessageId,
                        contact_id: currentChatContact.contact_user_id,
                        remind_at: selectedReminderTime.toISOString(),
                        note: note || null
                    })
                });
                
                const data = await res.json();
                
                if (!res.ok) {
                    throw new Error(data.error || 'Erreur lors de la création du rappel');
                }
                
                // Update local state
                reminders.push(data.reminder);
                reminderMessageIds.add(currentReminderMessageId);
                
                // Update UI
                updateReminderBadges();
                
                closeReminderModal();
                
                showToast({ 
                    type: 'success', 
                    title: '⏰ Rappel créé !',
                    message: formatReminderTime(selectedReminderTime.toISOString())
                });
                triggerHaptic?.('success');
                
            } catch (e) {
                console.error('Failed to create reminder:', e);
                showToast({ type: 'error', message: e.message || 'Erreur lors de la création du rappel' });
                saveBtn.disabled = false;
                saveBtn.innerHTML = '<span aria-hidden="true">⏰</span> Créer le rappel';
            }
        }
        
        async function deleteReminder(reminderId) {
            try {
                const res = await fetch(`${API_URL}/reminders?id=${reminderId}`, {
                    method: 'DELETE',
                    headers: authHeaders()
                });
                
                if (!res.ok) {
                    throw new Error('Erreur lors de la suppression');
                }
                
                // Update local state
                const reminder = reminders.find(r => r.id === reminderId);
                if (reminder) {
                    reminderMessageIds.delete(reminder.message_id);
                    reminders = reminders.filter(r => r.id !== reminderId);
                    
                    // Remove badge from message
                    const msgEl = document.getElementById(`msg-${reminder.message_id}`);
                    if (msgEl) {
                        const badge = msgEl.querySelector('.reminder-badge');
                        if (badge) badge.remove();
                    }
                    
                    // Update button
                    const btn = document.querySelector(`[data-reminder-msg-id="${reminder.message_id}"]`);
                    if (btn) {
                        btn.classList.remove('has-reminder');
                        btn.setAttribute('aria-label', 'Programmer un rappel');
                    }
                }
                
                closeReminderModal();
                
                showToast({ type: 'success', message: 'Rappel supprimé' });
                triggerHaptic?.('tap');
                
            } catch (e) {
                console.error('Failed to delete reminder:', e);
                showToast({ type: 'error', message: 'Erreur lors de la suppression' });
            }
        }

        // ===== FORWARD MESSAGES =====
        let currentForwardMessageId = null;
        let currentForwardMessageContent = null;
        let selectedForwardContactId = null;
        
        function openForwardModal(messageId) {
            currentForwardMessageId = messageId;
            selectedForwardContactId = null;
            
            // Get message content
            const msgEl = document.getElementById(`msg-${messageId}`);
            if (!msgEl) return;
            
            const contentEl = msgEl.querySelector('.chat-message-content');
            const stickerEl = msgEl.querySelector('.sticker-content');
            const gifEl = msgEl.querySelector('.gif-content');
            const voiceEl = msgEl.querySelector('.voice-message');
            const fileEl = msgEl.querySelector('.file-attachment');
            const locationEl = msgEl.querySelector('.location-content');
            
            let previewContent = '';
            
            if (contentEl && contentEl.textContent.trim()) {
                currentForwardMessageContent = contentEl.textContent.trim();
                previewContent = escapeHtml(currentForwardMessageContent);
            } else if (stickerEl) {
                currentForwardMessageContent = '[Sticker]';
                previewContent = '🎨 Sticker';
            } else if (gifEl) {
                currentForwardMessageContent = '[GIF]';
                previewContent = '🎬 GIF';
            } else if (voiceEl) {
                currentForwardMessageContent = '[Message vocal]';
                previewContent = '🎤 Message vocal';
            } else if (fileEl) {
                currentForwardMessageContent = '[Fichier]';
                previewContent = '📎 Fichier';
            } else if (locationEl) {
                currentForwardMessageContent = '[Position]';
                previewContent = '📍 Position';
            } else if (msgEl.classList.contains('ping')) {
                currentForwardMessageContent = '[Coucou]';
                previewContent = '👋 Coucou';
            } else {
                currentForwardMessageContent = '[Message]';
                previewContent = 'Message';
            }
            
            // Update preview in modal
            document.getElementById('forward-message-content').innerHTML = previewContent;
            document.getElementById('forward-message-id').value = messageId;
            
            // Render contacts list (excluding current chat contact)
            renderForwardContactsList();
            
            // Reset button state
            const sendBtn = document.getElementById('forward-send-btn');
            sendBtn.disabled = true;
            
            // Show modal
            const modal = document.getElementById('forward-modal');
            modal.classList.add('open');
            modal.setAttribute('aria-hidden', 'false');
            
            triggerHaptic?.('tap');
        }
        
        function closeForwardModal() {
            const modal = document.getElementById('forward-modal');
            modal.classList.remove('open');
            modal.setAttribute('aria-hidden', 'true');
            
            currentForwardMessageId = null;
            currentForwardMessageContent = null;
            selectedForwardContactId = null;
        }
        
        function renderForwardContactsList() {
            const container = document.getElementById('forward-contacts-list');
            
            // Filter out current chat contact and archived contacts
            const availableContacts = contacts.filter(c => 
                c.contact_user_id !== currentChatContact?.contact_user_id
            );
            
            if (availableContacts.length === 0) {
                container.innerHTML = `
                    <div class="forward-empty-contacts">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/>
                            <circle cx="9" cy="7" r="4"/>
                            <path d="M23 21v-2a4 4 0 0 0-3-3.87"/>
                            <path d="M16 3.13a4 4 0 0 1 0 7.75"/>
                        </svg>
                        <p>Aucun autre contact disponible</p>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = availableContacts.map(contact => {
                const name = contact.contact?.display_name || contact.contact?.email?.split('@')[0] || 'Contact';
                const email = contact.contact?.email || '';
                const initial = name.charAt(0).toUpperCase();
                
                return `
                    <div class="forward-contact-item" 
                         data-contact-id="${contact.contact_user_id}"
                         onclick="selectForwardContact('${contact.contact_user_id}')"
                         role="option"
                         aria-selected="false">
                        <div class="forward-contact-avatar">${escapeHtml(initial)}</div>
                        <div class="forward-contact-info">
                            <div class="forward-contact-name">${escapeHtml(name)}</div>
                            <div class="forward-contact-email">${escapeHtml(email)}</div>
                        </div>
                        <div class="forward-contact-check">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round">
                                <polyline points="20 6 9 17 4 12"/>
                            </svg>
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        function selectForwardContact(contactId) {
            selectedForwardContactId = contactId;
            
            // Update visual selection
            document.querySelectorAll('.forward-contact-item').forEach(item => {
                const isSelected = item.dataset.contactId === contactId;
                item.classList.toggle('selected', isSelected);
                item.setAttribute('aria-selected', isSelected ? 'true' : 'false');
            });
            
            // Enable send button
            document.getElementById('forward-send-btn').disabled = false;
            
            triggerHaptic?.('tap');
        }
        
        async function confirmForwardMessage() {
            if (!selectedForwardContactId || !currentForwardMessageId) return;
            
            const btn = document.getElementById('forward-send-btn');
            btn.disabled = true;
            btn.innerHTML = `
                <svg class="spin" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <circle cx="12" cy="12" r="10" stroke-dasharray="32" stroke-dashoffset="32"/>
                </svg>
                Transfert...
            `;
            
            try {
                // Get original message data
                const msgEl = document.getElementById(`msg-${currentForwardMessageId}`);
                const contentEl = msgEl?.querySelector('.chat-message-content');
                const stickerEl = msgEl?.querySelector('.sticker-content img');
                const gifEl = msgEl?.querySelector('.gif-content img');
                const voiceEl = msgEl?.querySelector('.voice-message');
                const locationEl = msgEl?.querySelector('.location-content');
                
                // Prepare forward message
                let forwardData = {
                    contact_id: selectedForwardContactId,
                    is_forwarded: true
                };
                
                // Determine message type and add appropriate data
                if (contentEl && contentEl.textContent.trim()) {
                    forwardData.content = `↪️ ${contentEl.textContent.trim()}`;
                } else if (stickerEl) {
                    const stickerId = stickerEl.src.split('/').pop().replace('.svg', '');
                    forwardData.sticker_id = stickerId;
                } else if (gifEl) {
                    forwardData.gif_url = gifEl.src;
                    forwardData.content = '↪️ [GIF transféré]';
                } else if (voiceEl) {
                    // Voice messages can't be easily forwarded, send as text
                    forwardData.content = '↪️ [Message vocal transféré]';
                } else if (locationEl) {
                    forwardData.content = '↪️ [Position transférée]';
                } else if (msgEl?.classList.contains('ping')) {
                    forwardData.content = '↪️ [Coucou transféré] 👋';
                } else {
                    forwardData.content = '↪️ [Message transféré]';
                }
                
                const res = await fetch(`${API_URL}/messages`, {
                    method: 'POST',
                    headers: authHeaders(),
                    body: JSON.stringify(forwardData)
                });
                
                if (!res.ok) {
                    throw new Error('Échec du transfert');
                }
                
                closeForwardModal();
                
                // Find contact name for toast
                const targetContact = contacts.find(c => c.contact_user_id === selectedForwardContactId);
                const contactName = targetContact?.contact?.display_name || 'Contact';
                
                showToast({ 
                    type: 'success', 
                    message: `Message transféré à ${contactName} ↪️` 
                });
                triggerHaptic?.('success');
                
            } catch (e) {
                console.error('Forward failed:', e);
                showToast({ 
                    type: 'error', 
                    message: 'Échec du transfert. Réessaie ?' 
                });
                triggerHaptic?.('error');
                
                // Reset button
                btn.disabled = false;
                btn.innerHTML = `
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <polyline points="15 17 20 12 15 7"/>
                        <path d="M4 18v-2a4 4 0 0 1 4-4h12"/>
                    </svg>
                    Transférer
                `;
            }
        }

        // ===== VOICE MESSAGES =====
        let mediaRecorder = null;
        let audioChunks = [];
        let voiceRecordingTimer = null;
        let voiceRecordingStart = null;
        let voiceAudioBlob = null;
        let voiceAudioDuration = 0;
        let currentAudioPlayer = null;
        let audioAnalyserData = [];
        
        async function toggleVoiceRecording() {
            const btn = document.getElementById('voice-btn');
            
            if (btn.classList.contains('recording')) {
                stopVoiceRecording();
            } else {
                await startVoiceRecording();
            }
        }
        
        async function startVoiceRecording() {
            const btn = document.getElementById('voice-btn');
            
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ 
                    audio: { 
                        echoCancellation: true,
                        noiseSuppression: true,
                        sampleRate: 44100
                    } 
                });
                
                // Determine best supported format
                const mimeType = MediaRecorder.isTypeSupported('audio/webm;codecs=opus') 
                    ? 'audio/webm;codecs=opus' 
                    : MediaRecorder.isTypeSupported('audio/mp4') 
                        ? 'audio/mp4' 
                        : 'audio/webm';
                
                mediaRecorder = new MediaRecorder(stream, { mimeType });
                audioChunks = [];
                audioAnalyserData = [];
                
                // Setup audio analyser for waveform
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                const source = audioContext.createMediaStreamSource(stream);
                const analyser = audioContext.createAnalyser();
                analyser.fftSize = 256;
                source.connect(analyser);
                
                // Capture waveform data periodically
                const dataArray = new Uint8Array(analyser.frequencyBinCount);
                const captureWaveform = () => {
                    if (mediaRecorder && mediaRecorder.state === 'recording') {
                        analyser.getByteFrequencyData(dataArray);
                        const avg = dataArray.reduce((a, b) => a + b, 0) / dataArray.length;
                        audioAnalyserData.push(Math.min(100, avg * 2));
                        requestAnimationFrame(captureWaveform);
                    }
                };
                
                mediaRecorder.ondataavailable = (e) => {
                    if (e.data.size > 0) {
                        audioChunks.push(e.data);
                    }
                };
                
                mediaRecorder.onstop = () => {
                    stream.getTracks().forEach(track => track.stop());
                    audioContext.close();
                    
                    voiceAudioBlob = new Blob(audioChunks, { type: mimeType });
                    
                    // Calculate duration
                    const audio = new Audio();
                    audio.src = URL.createObjectURL(voiceAudioBlob);
                    audio.onloadedmetadata = () => {
                        voiceAudioDuration = audio.duration;
                        URL.revokeObjectURL(audio.src);
                        showVoicePreview();
                    };
                    // Fallback if metadata doesn't load
                    setTimeout(() => {
                        if (!voiceAudioDuration) {
                            voiceAudioDuration = (Date.now() - voiceRecordingStart) / 1000;
                            showVoicePreview();
                        }
                    }, 500);
                };
                
                mediaRecorder.start(100); // Capture in 100ms chunks
                captureWaveform();
                
                btn.classList.add('recording');
                voiceRecordingStart = Date.now();
                
                // Start timer
                updateVoiceTimer();
                voiceRecordingTimer = setInterval(updateVoiceTimer, 100);
                
                // Show cancel hint
                document.getElementById('voice-cancel-hint').classList.add('visible');
                
                triggerHaptic('tap');
                
                // Auto-stop after 60 seconds
                setTimeout(() => {
                    if (mediaRecorder && mediaRecorder.state === 'recording') {
                        stopVoiceRecording();
                        showToast({ type: 'info', message: 'Max 1 minute par message vocal' });
                    }
                }, 60000);
                
            } catch (e) {
                console.error('Microphone error:', e);
                if (e.name === 'NotAllowedError') {
                    showToast({ type: 'error', title: 'Micro bloqué', message: 'Autorise l\'accès au micro dans les paramètres' });
                } else {
                    showToast({ type: 'error', message: 'Impossible d\'accéder au micro' });
                }
            }
        }
        
        function stopVoiceRecording() {
            const btn = document.getElementById('voice-btn');
            
            if (mediaRecorder && mediaRecorder.state === 'recording') {
                mediaRecorder.stop();
            }
            
            btn.classList.remove('recording');
            clearInterval(voiceRecordingTimer);
            document.getElementById('voice-cancel-hint').classList.remove('visible');
            
            triggerHaptic('success');
        }
        
        function updateVoiceTimer() {
            if (!voiceRecordingStart) return;
            const elapsed = Math.floor((Date.now() - voiceRecordingStart) / 1000);
            const mins = Math.floor(elapsed / 60);
            const secs = elapsed % 60;
            document.getElementById('voice-timer').textContent = `${mins}:${secs.toString().padStart(2, '0')}`;
        }
        
        function showVoicePreview() {
            const inputArea = document.getElementById('chat-input-area');
            const waveformEl = document.getElementById('voice-preview-waveform');
            const durationEl = document.getElementById('voice-preview-duration');
            const sendBtn = document.getElementById('send-btn');
            
            // Generate waveform bars from analyser data
            waveformEl.innerHTML = '';
            const barCount = 30;
            const step = Math.max(1, Math.floor(audioAnalyserData.length / barCount));
            
            for (let i = 0; i < barCount; i++) {
                const dataIndex = Math.min(i * step, audioAnalyserData.length - 1);
                const height = audioAnalyserData[dataIndex] || 20;
                const bar = document.createElement('div');
                bar.className = 'voice-preview-bar';
                bar.style.height = `${Math.max(4, height * 0.24)}px`;
                waveformEl.appendChild(bar);
            }
            
            // Format duration
            const mins = Math.floor(voiceAudioDuration / 60);
            const secs = Math.floor(voiceAudioDuration % 60);
            durationEl.textContent = `${mins}:${secs.toString().padStart(2, '0')}`;
            
            // Show preview, enable send
            inputArea.classList.add('voice-mode');
            sendBtn.disabled = false;
        }
        
        function cancelVoiceMessage() {
            const inputArea = document.getElementById('chat-input-area');
            const sendBtn = document.getElementById('send-btn');
            const chatInput = document.getElementById('chat-input');
            
            voiceAudioBlob = null;
            voiceAudioDuration = 0;
            audioAnalyserData = [];
            
            inputArea.classList.remove('voice-mode');
            sendBtn.disabled = !chatInput.value.trim();
            
            // Reset timer display
            document.getElementById('voice-timer').textContent = '0:00';
            
            triggerHaptic('tap');
        }
        
        // ===== FILE ATTACHMENTS =====
        let pendingFileAttachment = null;
        
        const FILE_ICONS = {
            pdf: '📕',
            doc: '📘',
            docx: '📘',
            xls: '📗',
            xlsx: '📗',
            ppt: '📙',
            pptx: '📙',
            txt: '📄',
            csv: '📊',
            rtf: '📄',
            zip: '📦',
            rar: '📦',
            '7z': '📦',
            gz: '📦',
            tar: '📦',
            json: '📋',
            xml: '📋',
        };
        
        const FILE_TYPE_LABELS = {
            pdf: 'PDF',
            doc: 'Word',
            docx: 'Word',
            xls: 'Excel',
            xlsx: 'Excel',
            ppt: 'PowerPoint',
            pptx: 'PowerPoint',
            txt: 'Texte',
            csv: 'CSV',
            rtf: 'RTF',
            zip: 'ZIP',
            rar: 'RAR',
            '7z': '7-Zip',
            gz: 'GZip',
            tar: 'TAR',
            json: 'JSON',
            xml: 'XML',
        };
        
        function formatFileSize(bytes) {
            if (bytes === 0) return '0 o';
            const k = 1024;
            const sizes = ['o', 'Ko', 'Mo', 'Go'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(1)) + ' ' + sizes[i];
        }
        
        function getFileExtension(filename) {
            return filename.split('.').pop().toLowerCase();
        }
        
        function getFileIcon(ext) {
            return FILE_ICONS[ext] || '📄';
        }
        
        function getFileTypeLabel(ext) {
            return FILE_TYPE_LABELS[ext] || ext.toUpperCase();
        }
        
        async function handleFileSelect(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            // Reset input so same file can be selected again
            event.target.value = '';
            
            // Validate file size (10MB max)
            const maxSize = 10 * 1024 * 1024;
            if (file.size > maxSize) {
                showToast({ type: 'error', title: 'Fichier trop grand', message: 'Taille max: 10 Mo' });
                return;
            }
            
            // Get file info
            const ext = getFileExtension(file.name);
            const icon = getFileIcon(ext);
            const typeLabel = getFileTypeLabel(ext);
            const sizeFormatted = formatFileSize(file.size);
            
            // Store pending file
            pendingFileAttachment = {
                file: file,
                name: file.name,
                size: file.size,
                type: file.type,
                ext: ext
            };
            
            // Update preview UI
            const iconEl = document.getElementById('file-preview-icon');
            const nameEl = document.getElementById('file-preview-name');
            const metaEl = document.getElementById('file-preview-meta');
            const inputArea = document.getElementById('chat-input-area');
            const sendBtn = document.getElementById('send-btn');
            
            iconEl.textContent = icon;
            iconEl.className = `file-preview-icon ${ext}`;
            nameEl.textContent = file.name;
            metaEl.textContent = `${typeLabel} • ${sizeFormatted}`;
            
            // Switch to file mode
            inputArea.classList.add('file-mode');
            inputArea.classList.remove('voice-mode');
            sendBtn.disabled = false;
            
            triggerHaptic('tap');
        }
        
        function cancelFileAttachment() {
            const inputArea = document.getElementById('chat-input-area');
            const sendBtn = document.getElementById('send-btn');
            const chatInput = document.getElementById('chat-input');
            
            pendingFileAttachment = null;
            
            inputArea.classList.remove('file-mode');
            sendBtn.disabled = !chatInput.value.trim();
            
            triggerHaptic('tap');
        }
        
        async function sendFileMessage() {
            if (!pendingFileAttachment || !currentChatContact) return;
            
            const sendBtn = document.getElementById('send-btn');
            const attachBtn = document.getElementById('attach-btn');
            sendBtn.disabled = true;
            sendBtn.classList.add('sending');
            attachBtn.classList.add('uploading');
            
            try {
                // Convert file to base64
                const base64 = await new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.onload = () => resolve(reader.result);
                    reader.onerror = reject;
                    reader.readAsDataURL(pendingFileAttachment.file);
                });
                
                // Upload file
                const uploadRes = await fetch(`${API_URL}/upload`, {
                    method: 'POST',
                    headers: authHeaders(),
                    body: JSON.stringify({
                        file: base64,
                        contentType: pendingFileAttachment.type,
                        fileName: pendingFileAttachment.name
                    })
                });
                
                if (!uploadRes.ok) {
                    const data = await uploadRes.json();
                    throw new Error(data.error || 'Échec upload');
                }
                
                const uploadData = await uploadRes.json();
                
                // Send message with file attachment info
                const messageContent = `📎 ${uploadData.fileName}`;
                const res = await fetch(`${API_URL}/messages`, {
                    method: 'POST',
                    headers: authHeaders(),
                    body: JSON.stringify({
                        contact_id: currentChatContact.contact_user_id,
                        content: messageContent,
                        file_url: uploadData.url,
                        file_name: uploadData.fileName,
                        file_size: uploadData.fileSize,
                        file_type: uploadData.fileType
                    })
                });
                
                if (!res.ok) throw new Error('Échec envoi');
                
                // Clear file state
                cancelFileAttachment();
                
                triggerHaptic('success');
                showToast({ type: 'success', message: '📎 Fichier envoyé !' });
                
                // Refresh messages
                loadMessages();
                
            } catch (e) {
                console.error('File send error:', e);
                triggerHaptic('error');
                showToast({ type: 'error', title: 'Échec envoi', message: e.message || 'Réessaie ?' });
            } finally {
                sendBtn.classList.remove('sending');
                attachBtn.classList.remove('uploading');
                const chatInput = document.getElementById('chat-input');
                const inputArea = document.getElementById('chat-input-area');
                sendBtn.disabled = !chatInput.value.trim() && !inputArea.classList.contains('file-mode');
            }
        }
        
        // Render file attachment in chat message
        function renderFileAttachment(fileUrl, fileName, fileSize, fileType) {
            const ext = fileType || getFileExtension(fileName);
            const icon = getFileIcon(ext);
            const typeLabel = getFileTypeLabel(ext);
            const sizeFormatted = formatFileSize(fileSize || 0);
            
            return `
                <a href="${escapeHtml(fileUrl)}" target="_blank" rel="noopener noreferrer" class="file-attachment" download="${escapeHtml(fileName)}">
                    <div class="file-attachment-icon ${ext}">${icon}</div>
                    <div class="file-attachment-info">
                        <div class="file-attachment-name">${escapeHtml(fileName)}</div>
                        <div class="file-attachment-meta">
                            <span>${typeLabel}</span>
                            <span>•</span>
                            <span>${sizeFormatted}</span>
                        </div>
                    </div>
                    <div class="file-attachment-download">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                            <polyline points="7 10 12 15 17 10"/>
                            <line x1="12" y1="15" x2="12" y2="3"/>
                        </svg>
                    </div>
                </a>
            `;
        }
        
        async function sendVoiceMessage() {
            if (!voiceAudioBlob || !currentChatContact) return;
            
            const sendBtn = document.getElementById('send-btn');
            sendBtn.disabled = true;
            sendBtn.classList.add('sending');
            
            try {
                // Convert to base64
                const base64 = await new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.onload = () => resolve(reader.result);
                    reader.onerror = reject;
                    reader.readAsDataURL(voiceAudioBlob);
                });
                
                // Send to API
                const res = await fetch(`${API_URL}/messages`, {
                    method: 'POST',
                    headers: authHeaders(),
                    body: JSON.stringify({
                        contact_id: currentChatContact.contact_user_id,
                        voice_data: base64,
                        voice_duration: voiceAudioDuration,
                        voice_waveform: audioAnalyserData.slice(0, 50) // Send first 50 samples for waveform
                    })
                });
                
                if (!res.ok) throw new Error('Échec envoi');
                
                // Clear voice state
                cancelVoiceMessage();
                
                triggerHaptic('success');
                showToast({ type: 'success', message: '🎤 Message vocal envoyé !' });
                
                // Refresh messages
                loadMessages();
                
            } catch (e) {
                triggerHaptic('error');
                showToast({ type: 'error', message: 'Le vocal n\'est pas parti. Réessaie ?' });
                const inputArea = document.getElementById('chat-input-area');
                sendBtn.disabled = !inputArea.classList.contains('voice-mode');
            } finally {
                sendBtn.classList.remove('sending');
            }
        }
        
        // Play voice message
        function playVoiceMessage(msgId, audioUrl) {
            const playBtn = document.getElementById(`voice-play-${msgId}`);
            const waveformEl = document.getElementById(`voice-waveform-${msgId}`);
            const durationEl = document.getElementById(`voice-duration-${msgId}`);
            
            // Stop any currently playing audio
            if (currentAudioPlayer) {
                currentAudioPlayer.pause();
                currentAudioPlayer.currentTime = 0;
                
                // Reset previous player UI
                const prevBtn = document.querySelector('.voice-play-btn.playing');
                if (prevBtn) {
                    prevBtn.classList.remove('playing');
                    prevBtn.innerHTML = getPlayIcon();
                }
                
                // Reset previous waveform
                document.querySelectorAll('.voice-waveform-bar.played').forEach(bar => {
                    bar.classList.remove('played');
                });
                
                // If clicking same message, just stop
                if (currentAudioPlayer.dataset.msgId === msgId) {
                    currentAudioPlayer = null;
                    return;
                }
            }
            
            // Create and play audio
            const audio = new Audio(audioUrl);
            audio.dataset.msgId = msgId;
            currentAudioPlayer = audio;
            
            playBtn.classList.add('playing');
            playBtn.innerHTML = getPauseIcon();
            
            const bars = waveformEl.querySelectorAll('.voice-waveform-bar');
            const totalDuration = parseFloat(durationEl.dataset.duration) || audio.duration || 1;
            
            audio.ontimeupdate = () => {
                const progress = audio.currentTime / totalDuration;
                const activeBar = Math.floor(progress * bars.length);
                
                bars.forEach((bar, i) => {
                    bar.classList.toggle('played', i < activeBar);
                    bar.classList.toggle('active', i === activeBar);
                });
                
                // Update displayed time
                const remaining = totalDuration - audio.currentTime;
                const mins = Math.floor(remaining / 60);
                const secs = Math.floor(remaining % 60);
                durationEl.textContent = `${mins}:${secs.toString().padStart(2, '0')}`;
            };
            
            audio.onended = () => {
                playBtn.classList.remove('playing');
                playBtn.innerHTML = getPlayIcon();
                bars.forEach(bar => {
                    bar.classList.remove('played', 'active');
                });
                
                // Restore original duration display
                const mins = Math.floor(totalDuration / 60);
                const secs = Math.floor(totalDuration % 60);
                durationEl.textContent = `${mins}:${secs.toString().padStart(2, '0')}`;
                
                currentAudioPlayer = null;
            };
            
            audio.onerror = () => {
                showToast({ type: 'error', message: 'Impossible de lire le vocal' });
                playBtn.classList.remove('playing');
                playBtn.innerHTML = getPlayIcon();
                currentAudioPlayer = null;
            };
            
            audio.play().catch(e => {
                console.error('Audio play error:', e);
                playBtn.classList.remove('playing');
                playBtn.innerHTML = getPlayIcon();
                currentAudioPlayer = null;
            });
        }
        
        function getPlayIcon() {
            return `<svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor" aria-hidden="true"><polygon points="5 3 19 12 5 21 5 3"/></svg>`;
        }
        
        function getPauseIcon() {
            return `<svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor" aria-hidden="true"><rect x="6" y="4" width="4" height="16"/><rect x="14" y="4" width="4" height="16"/></svg>`;
        }
        
        // Generate waveform HTML for voice message
        function renderVoiceWaveform(waveformData, msgId) {
            const barCount = 25;
            let bars = '';
            
            if (waveformData && waveformData.length > 0) {
                const step = Math.max(1, Math.floor(waveformData.length / barCount));
                for (let i = 0; i < barCount; i++) {
                    const dataIndex = Math.min(i * step, waveformData.length - 1);
                    const height = waveformData[dataIndex] || 20;
                    bars += `<div class="voice-waveform-bar" style="height: ${Math.max(4, height * 0.32)}px"></div>`;
                }
            } else {
                // Default waveform if no data
                for (let i = 0; i < barCount; i++) {
                    const height = 8 + Math.sin(i * 0.5) * 6 + Math.random() * 8;
                    bars += `<div class="voice-waveform-bar" style="height: ${height}px"></div>`;
                }
            }
            
            return bars;
        }

        async function sendPing() {
            if (!currentChatContact) return;
            
            const btn = document.querySelector('.ping-btn');
            btn.classList.add('pinged');
            triggerHaptic('ping');
            
            // Optimistic ping
            const optimisticPing = {
                id: 'temp-ping-' + Date.now(),
                sender_id: user.id,
                content: '👋',
                created_at: new Date().toISOString(),
                is_ping: true
            };
            
            const container = document.getElementById('chat-messages');
            const pingEl = document.createElement('div');
            pingEl.className = 'chat-message ping';
            pingEl.id = `msg-${optimisticPing.id}`;
            pingEl.setAttribute('role', 'article');
            pingEl.setAttribute('aria-label', 'Tu as envoyé un coucou');
            pingEl.innerHTML = '<span aria-hidden="true">👋</span>';
            container.appendChild(pingEl);
            container.scrollTo({ top: container.scrollHeight, behavior: 'smooth' });
            
            try {
                await fetch(`${API_URL}/messages`, {
                    method: 'POST',
                    headers: authHeaders(),
                    body: JSON.stringify({ contact_id: currentChatContact.contact_user_id, is_ping: true })
                });
                // Refresh to sync with server
                loadMessages();
            } catch (e) {
                triggerHaptic('error');
                showToast({ type: 'error', message: 'Le ping n\'est pas passé 😕' });
                removeOptimisticMessage(optimisticPing.id);
            } finally {
                setTimeout(() => btn.classList.remove('pinged'), 600);
            }
        }

        // ===== STICKERS =====
        const STICKER_NAMES = {
            'cinq': 'Cinq',
            'love': 'Cœur',
            'hug': 'Câlin',
            'laugh': 'Rire',
            'thinking': 'Pensif',
            'fire': 'Feu',
            'star': 'Étoile',
            'party': 'Fête',
            'cool': 'Cool',
            'sleepy': 'Fatigué',
            'coffee': 'Café',
            'sad': 'Triste'
        };
        
        function getStickerName(stickerId) {
            return STICKER_NAMES[stickerId] || stickerId;
        }
        
        function toggleStickerPicker() {
            const picker = document.getElementById('sticker-picker');
            const btn = document.getElementById('sticker-btn');
            const isOpen = picker.classList.contains('open');
            
            if (isOpen) {
                closeStickerPicker();
            } else {
                picker.classList.add('open');
                btn.classList.add('active');
                btn.setAttribute('aria-expanded', 'true');
                triggerHaptic('tap');
            }
        }
        
        function closeStickerPicker() {
            const picker = document.getElementById('sticker-picker');
            const btn = document.getElementById('sticker-btn');
            picker.classList.remove('open');
            btn.classList.remove('active');
            btn.setAttribute('aria-expanded', 'false');
        }
        
        // ===== GIF FUNCTIONS =====
        function toggleGifPicker() {
            const btn = document.getElementById('gif-btn');
            
            if (window.CinqGiphy?.isOpen()) {
                window.CinqGiphy.closePicker();
                btn.classList.remove('active');
            } else {
                // Close sticker picker if open
                closeStickerPicker();
                
                window.CinqGiphy?.openPicker((gif) => {
                    sendGif(gif);
                }, btn);
                btn.classList.add('active');
                triggerHaptic?.('tap');
            }
        }
        
        async function sendGif(gif) {
            if (!currentChatContact || !gif) return;
            
            const btn = document.getElementById('gif-btn');
            btn.classList.remove('active');
            triggerHaptic?.('tap');
            
            // Get the GIF URL
            const gifUrl = gif.images.original?.url || gif.images.standard?.url;
            
            // Optimistic GIF display
            const optimisticGif = {
                id: 'temp-gif-' + Date.now(),
                sender_id: user.id,
                gif_url: gifUrl,
                created_at: new Date().toISOString()
            };
            
            const container = document.getElementById('chat-messages');
            const gifEl = document.createElement('div');
            gifEl.className = 'chat-message gif sent';
            gifEl.id = `msg-${optimisticGif.id}`;
            gifEl.setAttribute('role', 'article');
            gifEl.setAttribute('aria-label', `Tu as envoyé un GIF`);
            
            const checkIcon = `<svg viewBox="0 0 16 11" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M1 5.5L5 9.5L14.5 1"/></svg>`;
            
            gifEl.innerHTML = `
                <div class="gif-content giphy-content-gif">
                    <img src="${escapeHtml(gifUrl)}" alt="GIF" loading="lazy">
                    <span class="giphy-badge">GIF</span>
                </div>
                <div class="chat-message-meta">
                    <span class="chat-message-time">${formatMessageTime(optimisticGif.created_at)}</span>
                    <span class="chat-read-receipt sent" aria-label="Envoi en cours">${checkIcon}</span>
                </div>
            `;
            
            container.appendChild(gifEl);
            container.scrollTo({ top: container.scrollHeight, behavior: 'smooth' });
            
            try {
                await fetch(`${API_URL}/messages`, {
                    method: 'POST',
                    headers: authHeaders(),
                    body: JSON.stringify({ 
                        contact_id: currentChatContact.contact_user_id, 
                        gif_url: gifUrl 
                    })
                });
                triggerHaptic?.('success');
                // Refresh to sync with server
                loadMessages();
            } catch (e) {
                triggerHaptic?.('error');
                showToast({ type: 'error', message: 'Le GIF n\'est pas passé 😕' });
                removeOptimisticMessage?.(optimisticGif.id);
            }
        }
        
        async function sendSticker(stickerId) {
            if (!currentChatContact) return;
            
            closeStickerPicker();
            triggerHaptic('tap');
            
            // Optimistic sticker
            const optimisticSticker = {
                id: 'temp-sticker-' + Date.now(),
                sender_id: user.id,
                sticker_id: stickerId,
                created_at: new Date().toISOString()
            };
            
            const container = document.getElementById('chat-messages');
            const stickerEl = document.createElement('div');
            stickerEl.className = 'chat-message sticker sent';
            stickerEl.id = `msg-${optimisticSticker.id}`;
            stickerEl.setAttribute('role', 'article');
            stickerEl.setAttribute('aria-label', `Tu as envoyé un sticker ${getStickerName(stickerId)}`);
            
            const checkIcon = `<svg viewBox="0 0 16 11" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M1 5.5L5 9.5L14.5 1"/></svg>`;
            
            stickerEl.innerHTML = `
                <div class="sticker-content">
                    <img src="/assets/stickers/${escapeHtml(stickerId)}.svg" alt="${getStickerName(stickerId)}" loading="lazy">
                </div>
                <div class="chat-message-meta">
                    <span class="chat-message-time">${formatMessageTime(optimisticSticker.created_at)}</span>
                    <span class="chat-read-receipt sent" aria-label="Envoi en cours">${checkIcon}</span>
                </div>
            `;
            
            container.appendChild(stickerEl);
            container.scrollTo({ top: container.scrollHeight, behavior: 'smooth' });
            
            try {
                await fetch(`${API_URL}/messages`, {
                    method: 'POST',
                    headers: authHeaders(),
                    body: JSON.stringify({ 
                        contact_id: currentChatContact.contact_user_id, 
                        sticker_id: stickerId 
                    })
                });
                triggerHaptic('success');
                // Refresh to sync with server
                loadMessages();
            } catch (e) {
                triggerHaptic('error');
                showToast({ type: 'error', message: 'Le sticker n\'est pas passé 😕' });
                removeOptimisticMessage(optimisticSticker.id);
            }
        }
        
        // ===== LOCATION SHARING =====
        async function sendLocation() {
            if (!currentChatContact) return;
            
            const btn = document.getElementById('location-btn');
            
            // Check if geolocation is available
            if (!navigator.geolocation) {
                showToast({ type: 'error', message: 'Géolocalisation non disponible sur cet appareil' });
                return;
            }
            
            // Show loading state
            btn.classList.add('loading');
            btn.disabled = true;
            triggerHaptic('tap');
            
            try {
                const position = await new Promise((resolve, reject) => {
                    navigator.geolocation.getCurrentPosition(resolve, reject, {
                        enableHighAccuracy: true,
                        timeout: 10000,
                        maximumAge: 60000
                    });
                });
                
                const lat = position.coords.latitude;
                const lng = position.coords.longitude;
                const accuracy = Math.round(position.coords.accuracy);
                
                // Generate static map URL (using OpenStreetMap tiles)
                const zoom = 15;
                const mapUrl = `https://staticmap.openstreetmap.de/staticmap.php?center=${lat},${lng}&zoom=${zoom}&size=400x200&maptype=osmarenderer&markers=${lat},${lng},red-pushpin`;
                
                // Optimistic location message
                const optimisticLocation = {
                    id: 'temp-location-' + Date.now(),
                    sender_id: user.id,
                    location_lat: lat,
                    location_lng: lng,
                    location_accuracy: accuracy,
                    created_at: new Date().toISOString()
                };
                
                const container = document.getElementById('chat-messages');
                const locationEl = document.createElement('div');
                locationEl.className = 'chat-message location sent';
                locationEl.id = `msg-${optimisticLocation.id}`;
                locationEl.setAttribute('role', 'article');
                locationEl.setAttribute('aria-label', 'Tu as partagé ta position');
                
                const checkIcon = `<svg viewBox="0 0 16 11" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M1 5.5L5 9.5L14.5 1"/></svg>`;
                const mapsLink = `https://www.openstreetmap.org/?mlat=${lat}&mlon=${lng}#map=17/${lat}/${lng}`;
                
                locationEl.innerHTML = `
                    <div class="location-content">
                        <div class="location-map">
                            <img src="${escapeHtml(mapUrl)}" alt="Position partagée" loading="lazy" onerror="this.parentElement.innerHTML='<div style=\\'display:flex;align-items:center;justify-content:center;height:100%;color:var(--color-text-muted);\\'>🗺️ Carte</div>'">
                            <div class="location-map-overlay">
                                <a href="${escapeHtml(mapsLink)}" target="_blank" rel="noopener noreferrer" class="location-map-link">
                                    <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"/><polyline points="15 3 21 3 21 9"/><line x1="10" y1="14" x2="21" y2="3"/></svg>
                                    Ouvrir
                                </a>
                            </div>
                        </div>
                        <div class="location-info">
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"/>
                                <circle cx="12" cy="10" r="3"/>
                            </svg>
                            <span>Ma position${accuracy ? ` (±${accuracy}m)` : ''}</span>
                        </div>
                    </div>
                    <div class="chat-message-meta">
                        <span class="chat-message-time">${formatMessageTime(optimisticLocation.created_at)}</span>
                        <span class="chat-read-receipt sent" aria-label="Envoi en cours">${checkIcon}</span>
                    </div>
                `;
                
                container.appendChild(locationEl);
                container.scrollTo({ top: container.scrollHeight, behavior: 'smooth' });
                
                // Send to server
                await fetch(`${API_URL}/messages`, {
                    method: 'POST',
                    headers: authHeaders(),
                    body: JSON.stringify({ 
                        contact_id: currentChatContact.contact_user_id, 
                        location_lat: lat,
                        location_lng: lng,
                        location_accuracy: accuracy
                    })
                });
                
                triggerHaptic('success');
                loadMessages();
                
            } catch (error) {
                triggerHaptic('error');
                
                let errorMessage = 'Impossible de récupérer ta position';
                if (error.code === 1) {
                    errorMessage = 'Accès à la position refusé. Autorise la géolocalisation.';
                } else if (error.code === 2) {
                    errorMessage = 'Position indisponible. Vérifie ton GPS.';
                } else if (error.code === 3) {
                    errorMessage = 'Délai dépassé. Réessaie.';
                }
                
                showToast({ type: 'error', message: errorMessage });
            } finally {
                btn.classList.remove('loading');
                btn.disabled = false;
            }
        }
        
        // Helper to render location message HTML
        function renderLocationMessage(msg, isSent) {
            const lat = msg.location_lat;
            const lng = msg.location_lng;
            const accuracy = msg.location_accuracy;
            const zoom = 15;
            const mapUrl = `https://staticmap.openstreetmap.de/staticmap.php?center=${lat},${lng}&zoom=${zoom}&size=400x200&maptype=osmarenderer&markers=${lat},${lng},red-pushpin`;
            const mapsLink = `https://www.openstreetmap.org/?mlat=${lat}&mlon=${lng}#map=17/${lat}/${lng}`;
            
            return `
                <div class="location-content">
                    <div class="location-map">
                        <img src="${escapeHtml(mapUrl)}" alt="Position partagée" loading="lazy" onerror="this.parentElement.innerHTML='<div style=\\'display:flex;align-items:center;justify-content:center;height:100%;color:var(--color-text-muted);\\'>🗺️ Carte</div>'">
                        <div class="location-map-overlay">
                            <a href="${escapeHtml(mapsLink)}" target="_blank" rel="noopener noreferrer" class="location-map-link">
                                <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"/><polyline points="15 3 21 3 21 9"/><line x1="10" y1="14" x2="21" y2="3"/></svg>
                                Ouvrir
                            </a>
                        </div>
                    </div>
                    <div class="location-info">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"/>
                            <circle cx="12" cy="10" r="3"/>
                        </svg>
                        <span>${isSent ? 'Ma position' : 'Position partagée'}${accuracy ? ` (±${accuracy}m)` : ''}</span>
                    </div>
                </div>
            `;
        }
        
        // Close sticker picker when clicking outside
        document.addEventListener('click', function(e) {
            const picker = document.getElementById('sticker-picker');
            const btn = document.getElementById('sticker-btn');
            if (picker && btn && !picker.contains(e.target) && !btn.contains(e.target)) {
                closeStickerPicker();
            }
        });

        // ===== QUICK REPLIES =====
        let quickRepliesCollapsed = false;
        
        function showQuickReplies() {
            const quickReplies = document.getElementById('quick-replies');
            if (quickReplies && !quickRepliesCollapsed) {
                quickReplies.classList.add('visible');
            }
        }
        
        function hideQuickReplies() {
            const quickReplies = document.getElementById('quick-replies');
            if (quickReplies) {
                quickReplies.classList.remove('visible');
            }
        }
        
        function toggleQuickReplies() {
            const quickReplies = document.getElementById('quick-replies');
            const toggleBtn = document.getElementById('quick-replies-toggle');
            
            if (!quickReplies || !toggleBtn) return;
            
            quickRepliesCollapsed = !quickRepliesCollapsed;
            
            if (quickRepliesCollapsed) {
                quickReplies.classList.remove('visible');
                toggleBtn.classList.add('expanded');
                toggleBtn.setAttribute('aria-expanded', 'false');
                toggleBtn.setAttribute('aria-label', 'Afficher les réponses rapides');
            } else {
                quickReplies.classList.add('visible');
                toggleBtn.classList.remove('expanded');
                toggleBtn.setAttribute('aria-expanded', 'true');
                toggleBtn.setAttribute('aria-label', 'Masquer les réponses rapides');
            }
            
            triggerHaptic('tap');
        }
        
        async function sendQuickReply(text) {
            if (!currentChatContact || !text) return;
            
            triggerHaptic('tap');
            
            // Optimistic message
            const optimisticMsg = {
                id: 'temp-qr-' + Date.now(),
                sender_id: user.id,
                content: text,
                created_at: new Date().toISOString()
            };
            
            const container = document.getElementById('chat-messages');
            const msgEl = document.createElement('div');
            msgEl.className = 'chat-message sent';
            msgEl.id = `msg-${optimisticMsg.id}`;
            msgEl.setAttribute('role', 'article');
            msgEl.setAttribute('aria-label', `Tu as envoyé : ${text}`);
            
            const checkIcon = `<svg viewBox="0 0 16 11" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M1 5.5L5 9.5L14.5 1"/></svg>`;
            
            msgEl.innerHTML = `
                <div class="chat-message-content">${escapeHtml(text)}</div>
                <div class="chat-message-meta">
                    <span class="chat-message-time">${formatMessageTime(optimisticMsg.created_at)}</span>
                    <span class="chat-read-receipt sent" aria-label="Envoi en cours">${checkIcon}</span>
                </div>
            `;
            
            container.appendChild(msgEl);
            container.scrollTo({ top: container.scrollHeight, behavior: 'smooth' });
            
            // Hide quick replies after sending
            hideQuickReplies();
            
            try {
                await fetch(`${API_URL}/messages`, {
                    method: 'POST',
                    headers: authHeaders(),
                    body: JSON.stringify({ 
                        contact_id: currentChatContact.contact_user_id, 
                        content: text 
                    })
                });
                triggerHaptic('success');
                // Refresh to sync with server
                loadMessages();
            } catch (e) {
                triggerHaptic('error');
                showToast({ type: 'error', message: 'Le message n\'est pas passé 😕' });
                removeOptimisticMessage(optimisticMsg.id);
            }
        }

        // ===== POLLING =====
        function startPolling() {
            contactPollingInterval = setInterval(checkForNewMessages, 10000);
        }
        
        function stopPolling() {
            if (contactPollingInterval) clearInterval(contactPollingInterval);
            if (messagePollingInterval) clearInterval(messagePollingInterval);
        }

        async function checkForNewMessages() {
            for (const contact of contacts) {
                try {
                    const res = await fetch(`${API_URL}/messages?contact_id=${contact.contact_user_id}&limit=1`, { headers: authHeaders() });
                    const data = await res.json();
                    
                    if (data.messages?.length > 0) {
                        const latestMsg = data.messages[data.messages.length - 1];
                        const lastKnown = lastMessageIds[contact.contact_user_id];
                        
                        if (latestMsg.id !== lastKnown && latestMsg.sender_id !== user.id) {
                            lastMessageIds[contact.contact_user_id] = latestMsg.id;
                            
                            if (!currentChatContact || currentChatContact.contact_user_id !== contact.contact_user_id) {
                                unreadCounts[contact.contact_user_id] = (unreadCounts[contact.contact_user_id] || 0) + 1;
                                renderContacts();
                                
                                const senderName = contact.contact?.email?.split('@')[0] || 'Contact';
                                showToast({
                                    type: 'notification',
                                    title: `Nouveau message de ${senderName}`,
                                    message: latestMsg.is_ping ? '👋' : latestMsg.content.substring(0, 50),
                                    onClick: () => openChat(contact)
                                });
                            }
                        }
                    }
                } catch (e) {
                    // Silently fail polling - not critical, just log for debugging
                    console.debug('Polling failed for contact:', contact.contact_user_id, e.message);
                }
            }
        }

        // ===== SEARCH =====
        function openSearch() {
            const overlay = document.getElementById('search-overlay');
            const input = document.getElementById('search-input');
            overlay.classList.add('open');
            setTimeout(() => input.focus(), 100);
            document.body.style.overflow = 'hidden';
        }
        
        function closeSearch() {
            const overlay = document.getElementById('search-overlay');
            overlay.classList.remove('open');
            document.getElementById('search-input').value = '';
            document.getElementById('search-results').innerHTML = `
                <div class="search-hint">
                    <p>Tape au moins 2 caractères pour rechercher</p>
                    <p style="margin-top: var(--space-2);">Raccourci : <kbd>Ctrl</kbd> + <kbd>K</kbd></p>
                </div>
            `;
            document.body.style.overflow = '';
        }
        
        function setSearchType(type) {
            currentSearchType = type;
            document.querySelectorAll('.search-tab').forEach(tab => {
                tab.classList.toggle('active', tab.dataset.type === type);
            });
            
            // Re-run search with new type
            const query = document.getElementById('search-input').value.trim();
            if (query.length >= 2) {
                performSearch(query);
            }
        }
        
        function initSearch() {
            const input = document.getElementById('search-input');
            
            input.addEventListener('input', (e) => {
                const query = e.target.value.trim();
                
                // Clear previous timeout
                if (searchTimeout) clearTimeout(searchTimeout);
                
                if (query.length < 2) {
                    document.getElementById('search-results').innerHTML = `
                        <div class="search-hint">
                            <p>Tape au moins 2 caractères pour rechercher</p>
                            <p style="margin-top: var(--space-2);">Raccourci : <kbd>Ctrl</kbd> + <kbd>K</kbd></p>
                        </div>
                    `;
                    return;
                }
                
                // Debounce search
                searchTimeout = setTimeout(() => performSearch(query), 300);
            });
            
            // Keyboard shortcut Ctrl+K or Cmd+K
            document.addEventListener('keydown', (e) => {
                if ((e.ctrlKey || e.metaKey) && e.key === 'k') {
                    e.preventDefault();
                    const overlay = document.getElementById('search-overlay');
                    if (overlay.classList.contains('open')) {
                        closeSearch();
                    } else {
                        openSearch();
                    }
                }
            });
        }
        
        async function performSearch(query) {
            const resultsEl = document.getElementById('search-results');
            
            if (isSearching) return;
            isSearching = true;
            
            resultsEl.innerHTML = '<div class="search-loading"><div class="loading-spinner"></div></div>';
            
            try {
                const typeParam = currentSearchType !== 'all' ? `&type=${currentSearchType}` : '';
                const res = await fetch(`${API_URL}/search?q=${encodeURIComponent(query)}${typeParam}`, { 
                    headers: authHeaders() 
                });
                
                if (!res.ok) {
                    const data = await res.json();
                    throw new Error(data.error || 'Erreur de recherche');
                }
                
                const data = await res.json();
                renderSearchResults(data, query);
            } catch (e) {
                resultsEl.innerHTML = `
                    <div class="search-empty">
                        <div class="search-empty-icon">😵</div>
                        <p>${escapeHtml(e.message)}</p>
                    </div>
                `;
            } finally {
                isSearching = false;
            }
        }
        
        function renderSearchResults(data, query) {
            const resultsEl = document.getElementById('search-results');
            const hasContacts = data.contacts && data.contacts.length > 0;
            const hasPosts = data.posts && data.posts.length > 0;
            
            if (!hasContacts && !hasPosts) {
                resultsEl.innerHTML = `
                    <div class="search-empty">
                        <div class="search-empty-icon">🔍</div>
                        <p>Aucun résultat pour "${escapeHtml(query)}"</p>
                    </div>
                `;
                return;
            }
            
            let html = '';
            
            // Contacts section
            if (hasContacts && (currentSearchType === 'all' || currentSearchType === 'contacts')) {
                html += `
                    <div class="search-section">
                        <div class="search-section-title">
                            <span>👥 Contacts</span>
                            <span class="search-section-count">${data.contacts.length}</span>
                        </div>
                `;
                
                data.contacts.forEach(contact => {
                    const name = contact.display_name || contact.email?.split('@')[0] || 'Contact';
                    const initial = name.charAt(0).toUpperCase();
                    const highlightedName = highlightQuery(name, query);
                    const highlightedEmail = contact.email ? highlightQuery(contact.email, query) : '';
                    
                    html += `
                        <div class="search-result-item" onclick="goToContactFromSearch('${contact.id}')">
                            <div class="search-result-avatar">
                                ${contact.avatar_url 
                                    ? `<img src="${escapeHtml(contact.avatar_url)}" alt="">` 
                                    : initial}
                            </div>
                            <div class="search-result-info">
                                <div class="search-result-name">${highlightedName}</div>
                                <div class="search-result-meta">${highlightedEmail}${contact.mutual ? ' • 🤝 Mutuel' : ''}</div>
                            </div>
                        </div>
                    `;
                });
                
                html += '</div>';
            }
            
            // Posts section
            if (hasPosts && (currentSearchType === 'all' || currentSearchType === 'posts')) {
                html += `
                    <div class="search-section">
                        <div class="search-section-title">
                            <span>📝 Posts</span>
                            <span class="search-section-count">${data.posts.length}</span>
                        </div>
                `;
                
                data.posts.forEach(post => {
                    const author = post.author || {};
                    const authorName = author.display_name || author.email?.split('@')[0] || 'Utilisateur';
                    const initial = authorName.charAt(0).toUpperCase();
                    const highlightedContent = highlightQuery(post.content.substring(0, 150), query);
                    const timeAgo = formatTime(post.created_at);
                    
                    html += `
                        <div class="search-result-item" onclick="goToPostFromSearch('${post.id}')">
                            <div class="search-result-avatar">
                                ${author.avatar_url 
                                    ? `<img src="${escapeHtml(author.avatar_url)}" alt="">` 
                                    : initial}
                            </div>
                            <div class="search-result-info">
                                <div class="search-result-name">
                                    ${escapeHtml(authorName)}
                                    ${post.isOwn ? '<span style="color:var(--color-success);font-size:var(--text-xs);margin-left:var(--space-1);">(toi)</span>' : ''}
                                </div>
                                <div class="search-result-meta">${timeAgo}</div>
                                <div class="search-result-preview">${highlightedContent}${post.content.length > 150 ? '...' : ''}</div>
                            </div>
                        </div>
                    `;
                });
                
                html += '</div>';
            }
            
            resultsEl.innerHTML = html;
        }
        
        function highlightQuery(text, query) {
            if (!text || !query) return escapeHtml(text || '');
            
            const escaped = escapeHtml(text);
            const regex = new RegExp(`(${escapeHtml(query)})`, 'gi');
            return escaped.replace(regex, '<mark>$1</mark>');
        }
        
        function goToContactFromSearch(contactId) {
            closeSearch();
            switchTab('contacts');
            
            // Find the contact and open chat
            const contact = contacts.find(c => c.contact_user_id === contactId);
            if (contact) {
                setTimeout(() => openChat(contact), 300);
            }
        }
        
        function goToPostFromSearch(postId) {
            closeSearch();
            switchTab('feed');
            
            // Scroll to post
            setTimeout(() => {
                const postEl = document.querySelector(`[data-post-id="${postId}"]`);
                if (postEl) {
                    postEl.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    postEl.classList.add('new-post');
                    setTimeout(() => postEl.classList.remove('new-post'), 1000);
                }
            }, 300);
        }

        // ===== MODALS =====
        function openModal(modalId, focusSelector) {
            const modal = document.getElementById(modalId);
            lastFocusedElement = document.activeElement;
            modal.classList.add('open');
            modal.setAttribute('aria-hidden', 'false');
            setupFocusTrap(modal);
            
            // Focus first focusable element or specified selector
            setTimeout(() => {
                const focusTarget = focusSelector ? modal.querySelector(focusSelector) : modal.querySelector('button, input, [tabindex="0"]');
                if (focusTarget) focusTarget.focus();
            }, 100);
        }
        
        function closeModal(modalId) {
            const modal = document.getElementById(modalId);
            modal.classList.remove('open');
            modal.setAttribute('aria-hidden', 'true');
            
            if (lastFocusedElement) {
                lastFocusedElement.focus();
                lastFocusedElement = null;
            }
        }
        
        function openGiftModal() {
            document.getElementById('gift-content').innerHTML = `<button class="save-btn" style="width:100%;" onclick="createGift()" type="button">Générer un code</button>`;
            openModal('gift-modal', '.save-btn');
        }
        
        function closeGiftModal() {
            closeModal('gift-modal');
        }

        // Store last gift URL for copy function (avoids inline onclick with URL)
        let lastGiftUrl = null;
        
        async function createGift() {
            const contentEl = document.getElementById('gift-content');
            contentEl.innerHTML = '<div class="loading-spinner" style="margin:var(--space-8) auto;"></div>';
            
            try {
                const res = await fetch(`${API_URL}/gift?action=create`, { method: 'POST', headers: authHeaders() });
                const data = await res.json();
                if (!res.ok) throw new Error(data.error || 'Erreur');

                // SECURITY: Store URL in variable, use DOM methods to prevent XSS
                lastGiftUrl = data.gift.shareUrl;
                
                contentEl.innerHTML = '';
                
                const codeDisplay = document.createElement('div');
                codeDisplay.className = 'gift-code-display';
                const codeDiv = document.createElement('div');
                codeDiv.className = 'gift-code';
                codeDiv.textContent = data.gift.code; // Safe: textContent escapes
                codeDisplay.appendChild(codeDiv);
                
                const copyBtn = document.createElement('button');
                copyBtn.className = 'save-btn';
                copyBtn.style.width = '100%';
                copyBtn.type = 'button';
                copyBtn.setAttribute('aria-label', 'Copier le lien d\'invitation');
                copyBtn.innerHTML = '<span aria-hidden="true">📋</span> Copier le lien';
                copyBtn.onclick = () => copyGift(lastGiftUrl);
                
                const expiryP = document.createElement('p');
                expiryP.style.cssText = 'font-size:var(--text-xs);color:var(--color-text-muted);margin-top:var(--space-4);text-align:center;';
                expiryP.textContent = 'Valable 30 jours';
                
                contentEl.appendChild(codeDisplay);
                contentEl.appendChild(copyBtn);
                contentEl.appendChild(expiryP);
            } catch (e) {
                // SECURITY: Use DOM methods to prevent XSS from error messages
                contentEl.innerHTML = '';
                
                const errorP = document.createElement('p');
                errorP.style.cssText = 'color:var(--color-error);text-align:center;';
                errorP.textContent = e.message; // Safe: textContent escapes
                
                const retryBtn = document.createElement('button');
                retryBtn.className = 'save-btn';
                retryBtn.style.cssText = 'width:100%;margin-top:var(--space-4);';
                retryBtn.textContent = 'Réessayer';
                retryBtn.onclick = createGift;
                
                contentEl.appendChild(errorP);
                contentEl.appendChild(retryBtn);
            }
        }

        async function copyGift(url) {
            try {
                await navigator.clipboard.writeText(url);
                showToast({ type: 'success', title: 'Copié !', message: 'Lien copié' });
            } catch (e) {
                showToast({ type: 'error', message: 'Impossible de copier' });
            }
        }

        function openAddContactModal() {
            document.getElementById('contact-id-input').value = '';
            document.getElementById('add-contact-error').style.display = 'none';
            document.getElementById('my-id').textContent = user?.id || 'Non disponible';
            openModal('add-contact-modal', '#contact-id-input');
        }
        
        function closeAddContactModal() {
            closeModal('add-contact-modal');
        }

        async function addContact() {
            const contactId = document.getElementById('contact-id-input').value.trim();
            const errorEl = document.getElementById('add-contact-error');
            const btn = document.getElementById('add-contact-btn');
            
            errorEl.style.display = 'none';
            
            if (!contactId) {
                errorEl.textContent = 'Entre un ID';
                errorEl.style.display = 'block';
                return;
            }

            if (contactId === user.id) {
                errorEl.textContent = 'Tu ne peux pas t\'ajouter toi-même !';
                errorEl.style.display = 'block';
                return;
            }

            btn.disabled = true;
            btn.textContent = 'Ajout...';

            try {
                const res = await fetch(`${API_URL}/contacts`, {
                    method: 'POST',
                    headers: authHeaders(),
                    body: JSON.stringify({ contactId })
                });
                const data = await res.json();
                if (!res.ok) throw new Error(data.error || 'Erreur');

                closeAddContactModal();
                
                // Check if this is the 5th contact BEFORE loading (current contacts + 1)
                const willBeFifthContact = contacts.length === 4;
                
                await loadContacts();
                
                // 🎊 Celebrate 5th contact with confetti!
                if (willBeFifthContact && window.CinqConfetti) {
                    const wasFifth = await CinqConfetti.triggerFifthContactIfNeeded();
                    if (wasFifth) {
                        showToast({ type: 'success', title: '🎊 Cercle complet !', message: 'Tu as tes 5 proches !' });
                    } else {
                        showToast({ type: 'success', title: 'Contact ajouté !', message: 'Dis-lui bonjour 👋' });
                    }
                } else {
                    showToast({ type: 'success', title: 'Contact ajouté !', message: 'Dis-lui bonjour 👋' });
                }
                
                // Onboarding: check progress after adding contact
                setTimeout(() => {
                    checkOnboardingProgress();
                    if (!onboardingState.hasPost && localStorage.getItem('cinq_onboarding_completed') !== 'true') {
                        showToast({ type: 'info', title: '🎯 Bien joué !', message: 'Plus qu\'à poster ton premier message !' });
                    }
                }, 500);
            } catch (e) {
                errorEl.textContent = e.message;
                errorEl.style.display = 'block';
            } finally {
                btn.disabled = false;
                btn.textContent = 'Ajouter';
            }
        }

        async function copyMyId() {
            const textEl = document.getElementById('copy-id-text');
            try {
                await navigator.clipboard.writeText(user.id);
                textEl.textContent = 'Copié !';
                setTimeout(() => textEl.textContent = 'Copier mon ID', 2000);
            } catch (e) {
                showToast({ type: 'error', message: 'Impossible de copier' });
            }
        }

        function openDeleteAccountModal() {
            document.getElementById('delete-confirmation-input').value = '';
            document.getElementById('delete-account-error').style.display = 'none';
            openModal('delete-account-modal', '#delete-confirmation-input');
        }
        
        function closeDeleteAccountModal() {
            closeModal('delete-account-modal');
        }

        async function deleteAccount() {
            const confirmation = document.getElementById('delete-confirmation-input').value.trim();
            const errorEl = document.getElementById('delete-account-error');
            const btn = document.getElementById('delete-account-btn');
            
            if (confirmation !== 'SUPPRIMER') {
                errorEl.textContent = 'Tape exactement SUPPRIMER pour confirmer';
                errorEl.style.display = 'block';
                return;
            }
            
            errorEl.style.display = 'none';
            btn.disabled = true;
            btn.textContent = 'Suppression...';
            
            try {
                const res = await fetch(`${API_URL}/user-profile`, {
                    method: 'DELETE',
                    headers: authHeaders(),
                    body: JSON.stringify({ confirmation: 'SUPPRIMER' })
                });
                
                if (!res.ok) throw new Error((await res.json()).error || 'Erreur');
                
                stopPolling();
                localStorage.removeItem('cinq_session');
                localStorage.removeItem('cinq_user');
                
                showToast({ type: 'success', title: 'Compte supprimé', message: 'Adieu ! 👋', duration: 3000 });
                setTimeout(() => { window.location.href = '/'; }, 2000);
            } catch (e) {
                errorEl.textContent = e.message;
                errorEl.style.display = 'block';
                btn.disabled = false;
                btn.textContent = 'Supprimer définitivement';
            }
        }

        async function exportData() {
            const btn = document.getElementById('export-data-btn');
            const titleEl = btn.querySelector('.settings-btn-title');
            btn.disabled = true;
            titleEl.textContent = 'Export en cours...';
            
            try {
                const res = await fetch(`${API_URL}/user-profile?action=export`, { headers: authHeaders() });
                if (!res.ok) throw new Error('Erreur lors de l\'export');
                
                const data = await res.json();
                const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `cinq-data-export-${new Date().toISOString().split('T')[0]}.json`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                
                showToast({ type: 'success', title: 'C\'est téléchargé ! 📦' });
            } catch (e) {
                showToast({ type: 'error', message: e.message });
            } finally {
                btn.disabled = false;
                titleEl.textContent = 'Exporter mes données';
            }
        }

        function logout() {
            stopPolling();
            stopHeartbeat();
            localStorage.removeItem('cinq_session');
            localStorage.removeItem('cinq_user');
            window.location.href = '/login.html';
        }

        // ===== UTILS =====
        // formatTime() now provided by /js/shared.js
        
        // Smart time formatting for chat messages
        function formatMessageTime(dateStr) {
            const date = new Date(dateStr);
            const now = new Date();
            const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
            const yesterday = new Date(today);
            yesterday.setDate(yesterday.getDate() - 1);
            const messageDate = new Date(date.getFullYear(), date.getMonth(), date.getDate());
            
            const timeStr = date.toLocaleTimeString('fr-FR', { hour: '2-digit', minute: '2-digit' });
            
            if (messageDate.getTime() === today.getTime()) {
                return timeStr;
            }
            if (messageDate.getTime() === yesterday.getTime()) {
                return `Hier ${timeStr}`;
            }
            
            const diffDays = Math.floor((today - messageDate) / (1000 * 60 * 60 * 24));
            if (diffDays < 7) {
                const dayName = date.toLocaleDateString('fr-FR', { weekday: 'short' });
                return `${dayName} ${timeStr}`;
            }
            
            return date.toLocaleDateString('fr-FR', { day: 'numeric', month: 'short' }) + ' ' + timeStr;
        }
        
        // Format date for date separators
        function formatDateSeparator(dateStr) {
            const date = new Date(dateStr);
            const now = new Date();
            const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
            const yesterday = new Date(today);
            yesterday.setDate(yesterday.getDate() - 1);
            const messageDate = new Date(date.getFullYear(), date.getMonth(), date.getDate());
            
            if (messageDate.getTime() === today.getTime()) return "Aujourd'hui";
            if (messageDate.getTime() === yesterday.getTime()) return "Hier";
            
            const diffDays = Math.floor((today - messageDate) / (1000 * 60 * 60 * 24));
            if (diffDays < 7) {
                return date.toLocaleDateString('fr-FR', { weekday: 'long' });
            }
            
            return date.toLocaleDateString('fr-FR', { day: 'numeric', month: 'long', year: now.getFullYear() !== date.getFullYear() ? 'numeric' : undefined });
        }
        
        // Format last seen timestamp for contacts
        function formatLastSeen(lastSeenAt) {
            if (!lastSeenAt) return { text: 'Hors ligne', isOnline: false };
            
            const lastSeen = new Date(lastSeenAt);
            const now = new Date();
            const diffMs = now - lastSeen;
            const diffMinutes = Math.floor(diffMs / (1000 * 60));
            const diffHours = Math.floor(diffMs / (1000 * 60 * 60));
            const diffDays = Math.floor(diffMs / (1000 * 60 * 60 * 24));
            
            // Online if seen within last 2 minutes
            if (diffMinutes < 2) {
                return { text: 'En ligne', isOnline: true };
            }
            
            // Just now (2-5 minutes)
            if (diffMinutes < 5) {
                return { text: 'À l\'instant', isOnline: false };
            }
            
            // Minutes (5-59)
            if (diffMinutes < 60) {
                return { text: `Vu il y a ${diffMinutes} min`, isOnline: false };
            }
            
            // Hours (1-23)
            if (diffHours < 24) {
                return { text: `Vu il y a ${diffHours}h`, isOnline: false };
            }
            
            // Yesterday
            if (diffDays === 1) {
                return { text: 'Vu hier', isOnline: false };
            }
            
            // Days (2-6)
            if (diffDays < 7) {
                return { text: `Vu il y a ${diffDays}j`, isOnline: false };
            }
            
            // Weeks
            const diffWeeks = Math.floor(diffDays / 7);
            if (diffWeeks < 4) {
                return { text: `Vu il y a ${diffWeeks} sem.`, isOnline: false };
            }
            
            // More than a month
            return { text: 'Vu il y a longtemps', isOnline: false };
        }
        
        // escapeHtml() now provided by /js/shared.js

        // ===== KEYBOARD SHORTCUTS =====
        // See KEYBOARD-SHORTCUTS.md for full documentation
        document.addEventListener('keydown', (e) => {
            const isInputFocused = ['INPUT', 'TEXTAREA', 'SELECT'].includes(document.activeElement?.tagName);
            const isMod = e.ctrlKey || e.metaKey;
            
            // Escape: Close modals/overlays (works even in inputs)
            if (e.key === 'Escape') {
                closeImageModal();
                if (document.getElementById('search-overlay').classList.contains('open')) closeSearch();
                else if (currentChatContact) closeChat();
                else if (document.getElementById('gift-modal').classList.contains('open')) closeGiftModal();
                else if (document.getElementById('add-contact-modal').classList.contains('open')) closeAddContactModal();
                else if (document.getElementById('delete-account-modal').classList.contains('open')) closeDeleteAccountModal();
                document.querySelectorAll('.post-menu.open').forEach(m => m.classList.remove('open'));
                return;
            }
            
            // Skip shortcuts if typing in an input
            if (isInputFocused) return;
            
            // Ctrl+1-5: Quick switch to contact chat
            if (isMod && e.key >= '1' && e.key <= '5') {
                e.preventDefault();
                const contactIndex = parseInt(e.key) - 1;
                if (contacts[contactIndex]) {
                    openChat(contacts[contactIndex]);
                    showToast({ type: 'info', message: `Chat avec ${contacts[contactIndex].contact?.display_name || 'Contact ' + (contactIndex + 1)}`, duration: 1500 });
                } else {
                    showToast({ type: 'warning', message: `Pas de contact en position ${e.key}`, duration: 1500 });
                }
                return;
            }
            
            // Ctrl+N: New message (switch to contacts tab)
            if (isMod && e.key.toLowerCase() === 'n') {
                e.preventDefault();
                switchTab('contacts');
                showToast({ type: 'info', message: 'Choisis un contact pour écrire', duration: 2000 });
                return;
            }
            
            // Ctrl+F: Open search
            if (isMod && e.key.toLowerCase() === 'f') {
                e.preventDefault();
                openSearch();
                return;
            }
        });
        
        // ===== MICRO-ANIMATIONS: RIPPLE EFFECT =====
        document.addEventListener('click', (e) => {
            const btn = e.target.closest('.btn-ripple');
            if (!btn) return;
            
            // Check for reduced motion preference
            if (window.matchMedia('(prefers-reduced-motion: reduce)').matches) return;
            
            const rect = btn.getBoundingClientRect();
            const x = ((e.clientX - rect.left) / rect.width) * 100;
            const y = ((e.clientY - rect.top) / rect.height) * 100;
            
            btn.style.setProperty('--ripple-x', `${x}%`);
            btn.style.setProperty('--ripple-y', `${y}%`);
            
            btn.classList.remove('rippling');
            void btn.offsetWidth; // Trigger reflow
            btn.classList.add('rippling');
            
            setTimeout(() => btn.classList.remove('rippling'), 600);
        });
        
        // ===== HAPTIC FEEDBACK =====
        // triggerHaptic() now provided by /js/shared.js
        
        // Close menus on outside click
        document.addEventListener('click', (e) => {
            if (!e.target.closest('.post-menu') && !e.target.closest('.post-menu-btn')) {
                document.querySelectorAll('.post-menu.open').forEach(m => m.classList.remove('open'));
            }
        });

        // ===== PUSH NOTIFICATIONS =====
        const VAPID_PUBLIC_KEY = 'BFvUbvZkUNjbCf_lea-V2FGiVLhAdyAXaUC5CUWYlwmCkejWxefzR3rvqJI4DOj_M1Gh664VGVYRo0SEJ-94faM';

        async function initPushNotifications() {
            if (!('serviceWorker' in navigator) || !('PushManager' in window)) return;

            try {
                const registration = await navigator.serviceWorker.register('/service-worker.js');
                const existingSubscription = await registration.pushManager.getSubscription();
                if (existingSubscription) return;
                setTimeout(() => askForNotificationPermission(registration), 3000);
            } catch (err) {}
        }

        async function askForNotificationPermission(registration) {
            if (Notification.permission === 'denied') return;
            if (Notification.permission === 'granted') {
                await subscribeToPush(registration);
                return;
            }

            showToast({
                type: 'info',
                title: '🔔 Notifications',
                message: 'Active-les pour savoir quand tes 5 t\'écrivent',
                duration: 6000,
                onClick: async () => {
                    const permission = await Notification.requestPermission();
                    if (permission === 'granted') {
                        await subscribeToPush(registration);
                        showToast({ type: 'success', title: 'Notifs activées !', message: 'Tu sauras quand tes proches t\'écrivent' });
                    }
                }
            });
        }

        async function subscribeToPush(registration) {
            try {
                const subscription = await registration.pushManager.subscribe({
                    userVisibleOnly: true,
                    applicationServerKey: urlBase64ToUint8Array(VAPID_PUBLIC_KEY)
                });
                await fetch(`${API_URL}/push-subscribe`, {
                    method: 'POST',
                    headers: authHeaders(),
                    body: JSON.stringify({ subscription: subscription.toJSON() })
                });
            } catch (err) {}
        }

        function urlBase64ToUint8Array(base64String) {
            const padding = '='.repeat((4 - base64String.length % 4) % 4);
            const base64 = (base64String + padding).replace(/-/g, '+').replace(/_/g, '/');
            const rawData = window.atob(base64);
            const outputArray = new Uint8Array(rawData.length);
            for (let i = 0; i < rawData.length; ++i) {
                outputArray[i] = rawData.charCodeAt(i);
            }
            return outputArray;
        }

        // ===== ONBOARDING SYSTEM =====
        let onboardingState = {
            hasPhoto: false,
            hasContact: false,
            hasPost: false,
            completed: false
        };
        
        function initOnboarding() {
            const isNewUser = localStorage.getItem('cinq_new_user') === 'true';
            const onboardingCompleted = localStorage.getItem('cinq_onboarding_completed') === 'true';
            
            if (isNewUser && !onboardingCompleted) {
                // Show welcome overlay
                setTimeout(() => {
                    showOnboardingOverlay();
                }, 500);
            } else if (!onboardingCompleted) {
                // Check progress and show checklist if not complete
                checkOnboardingProgress();
            }
        }
        
        function showOnboardingOverlay() {
            const overlay = document.getElementById('onboarding-overlay');
            overlay.classList.add('open');
            
            // Trap focus in overlay
            const firstBtn = overlay.querySelector('.onboarding-btn');
            if (firstBtn) firstBtn.focus();
        }
        
        function hideOnboardingOverlay() {
            document.getElementById('onboarding-overlay').classList.remove('open');
        }
        
        function startOnboarding() {
            hideOnboardingOverlay();
            localStorage.removeItem('cinq_new_user');
            
            // Show the floating checklist
            setTimeout(() => {
                showOnboardingChecklist();
                checkOnboardingProgress();
            }, 300);
            
            // Guide user to add photo first
            setTimeout(() => {
                showTooltipHint('profile-avatar', 'Commence par ajouter ta photo ! 📸', 'bottom');
                switchTab('profil');
            }, 800);
        }
        
        function skipOnboarding() {
            hideOnboardingOverlay();
            localStorage.removeItem('cinq_new_user');
            localStorage.setItem('cinq_onboarding_completed', 'true');
            showToast({ type: 'info', title: '👍 Pas de souci !', message: 'Tu peux explorer librement.' });
        }
        
        function showOnboardingChecklist() {
            const checklist = document.getElementById('onboarding-checklist');
            if (localStorage.getItem('cinq_onboarding_completed') !== 'true') {
                checklist.classList.add('visible');
            }
        }
        
        function hideOnboardingChecklist() {
            document.getElementById('onboarding-checklist').classList.remove('visible');
        }
        
        function checkOnboardingProgress() {
            // Check if user has avatar
            const avatarImg = document.querySelector('#profile-avatar img');
            onboardingState.hasPhoto = avatarImg && avatarImg.src && !avatarImg.src.includes('undefined');
            
            // Check if user has contacts
            onboardingState.hasContact = contacts.length > 0;
            
            // Check if user has posts (own posts)
            onboardingState.hasPost = posts.some(p => p.user_id === user?.id);
            
            // Update UI
            updateOnboardingUI();
            
            // Check completion
            if (onboardingState.hasPhoto && onboardingState.hasContact && onboardingState.hasPost) {
                completeOnboarding();
            }
        }
        
        function updateOnboardingUI() {
            const photoEl = document.getElementById('checklist-photo');
            const contactEl = document.getElementById('checklist-contact');
            const postEl = document.getElementById('checklist-post');
            
            if (onboardingState.hasPhoto) photoEl.classList.add('completed');
            else photoEl.classList.remove('completed');
            
            if (onboardingState.hasContact) contactEl.classList.add('completed');
            else contactEl.classList.remove('completed');
            
            if (onboardingState.hasPost) postEl.classList.add('completed');
            else postEl.classList.remove('completed');
            
            // Update progress
            const completed = [onboardingState.hasPhoto, onboardingState.hasContact, onboardingState.hasPost].filter(Boolean).length;
            const progressFill = document.getElementById('onboarding-progress-fill');
            const progressText = document.getElementById('onboarding-progress-text');
            
            progressFill.style.width = `${(completed / 3) * 100}%`;
            progressText.textContent = `${completed}/3 complétés`;
        }
        
        function completeOnboarding() {
            if (onboardingState.completed) return;
            onboardingState.completed = true;
            localStorage.setItem('cinq_onboarding_completed', 'true');
            
            // Hide checklist with celebration
            setTimeout(() => {
                hideOnboardingChecklist();
                showToast({ 
                    type: 'success', 
                    title: '🎉 Bravo !', 
                    message: 'Tu as terminé ton setup. Profite de ton espace !',
                    duration: 5000
                });
            }, 500);
        }
        
        // Navigation helpers for onboarding
        function goToProfileForPhoto() {
            switchTab('profil');
            setTimeout(() => {
                const profileAvatar = document.getElementById('profile-avatar');
                if (profileAvatar) {
                    profileAvatar.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    profileAvatar.classList.add('pulse-indicator');
                    setTimeout(() => profileAvatar.classList.remove('pulse-indicator'), 3000);
                }
            }, 300);
        }
        
        function goToContactsForAdd() {
            switchTab('contacts');
            setTimeout(() => {
                const emptySlot = document.querySelector('.contact-slot.empty');
                if (emptySlot) {
                    emptySlot.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    emptySlot.classList.add('pulse-indicator');
                    setTimeout(() => emptySlot.classList.remove('pulse-indicator'), 3000);
                }
            }, 300);
        }
        
        function goToFeedForPost() {
            switchTab('feed');
            setTimeout(() => {
                const composer = document.querySelector('.composer-textarea');
                if (composer) {
                    composer.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    composer.focus();
                    composer.parentElement.classList.add('pulse-indicator');
                    setTimeout(() => composer.parentElement.classList.remove('pulse-indicator'), 3000);
                }
            }, 300);
        }
        
        // Tooltip hints system
        let activeTooltip = null;
        
        function showTooltipHint(elementId, message, position = 'bottom') {
            hideTooltipHint();
            
            const targetEl = document.getElementById(elementId);
            if (!targetEl) return;
            
            const tooltip = document.createElement('div');
            tooltip.className = `tooltip-hint ${position}`;
            tooltip.innerHTML = `
                ${message}
                <button class="tooltip-hint-close" onclick="hideTooltipHint()" aria-label="Fermer">&times;</button>
            `;
            
            document.body.appendChild(tooltip);
            
            // Position the tooltip
            const rect = targetEl.getBoundingClientRect();
            const tooltipRect = tooltip.getBoundingClientRect();
            
            if (position === 'bottom') {
                tooltip.style.top = `${rect.bottom + 12}px`;
                tooltip.style.left = `${rect.left + (rect.width / 2) - (tooltipRect.width / 2)}px`;
            } else if (position === 'top') {
                tooltip.style.top = `${rect.top - tooltipRect.height - 12}px`;
                tooltip.style.left = `${rect.left + (rect.width / 2) - (tooltipRect.width / 2)}px`;
            }
            
            // Show with animation
            requestAnimationFrame(() => {
                tooltip.classList.add('visible');
            });
            
            activeTooltip = tooltip;
            
            // Auto-hide after 8 seconds
            setTimeout(() => hideTooltipHint(), 8000);
        }
        
        function hideTooltipHint() {
            if (activeTooltip) {
                activeTooltip.classList.remove('visible');
                setTimeout(() => {
                    if (activeTooltip && activeTooltip.parentNode) {
                        activeTooltip.parentNode.removeChild(activeTooltip);
                    }
                    activeTooltip = null;
                }, 300);
            }
        }
        
        // Hook into existing functions to track progress
        const originalUploadAvatar = uploadAvatar;
        uploadAvatar = async function(input) {
            await originalUploadAvatar.call(this, input);
            // Check progress after avatar upload
            setTimeout(() => {
                checkOnboardingProgress();
                if (!onboardingState.hasContact && localStorage.getItem('cinq_onboarding_completed') !== 'true') {
                    showToast({ type: 'info', title: '👍 Photo ajoutée !', message: 'Maintenant, invite tes proches !' });
                }
            }, 1000);
        };

        // ===== THEME TOGGLE =====
        function initTheme() {
            // Check localStorage first
            const savedTheme = localStorage.getItem('cinq_theme');
            if (savedTheme) {
                document.documentElement.setAttribute('data-theme', savedTheme);
                updateThemeColor(savedTheme);
                return;
            }
            
            // Check system preference
            if (window.matchMedia && window.matchMedia('(prefers-color-scheme: light)').matches) {
                document.documentElement.setAttribute('data-theme', 'light');
                updateThemeColor('light');
            }
        }
        
        const THEMES = ['dark', 'light', 'auto'];
        
        function getSystemPreference() {
            return window.matchMedia && window.matchMedia('(prefers-color-scheme: light)').matches ? 'light' : 'dark';
        }
        
        function getEffectiveTheme(pref) {
            return pref === 'auto' ? getSystemPreference() : (pref || 'dark');
        }
        
        function toggleTheme() {
            const html = document.documentElement;
            const currentPref = localStorage.getItem('cinq_theme') || 'dark';
            const currentIndex = THEMES.indexOf(currentPref);
            const nextPref = THEMES[(currentIndex + 1) % THEMES.length];
            const effective = getEffectiveTheme(nextPref);
            
            // Add transition class for smooth animation
            html.classList.add('theme-transitioning');
            
            html.setAttribute('data-theme', effective);
            html.setAttribute('data-theme-preference', nextPref);
            localStorage.setItem('cinq_theme', nextPref);
            updateThemeColor(effective);
            
            // Remove transition class after animation
            setTimeout(() => html.classList.remove('theme-transitioning'), 400);
            
            // Haptic feedback on mobile (if supported)
            if ('vibrate' in navigator) {
                navigator.vibrate(10);
            }
        }
        
        function setTheme(theme) {
            if (!THEMES.includes(theme)) return;
            const html = document.documentElement;
            const effective = getEffectiveTheme(theme);
            
            html.classList.add('theme-transitioning');
            html.setAttribute('data-theme', effective);
            html.setAttribute('data-theme-preference', theme);
            localStorage.setItem('cinq_theme', theme);
            updateThemeColor(effective);
            setTimeout(() => html.classList.remove('theme-transitioning'), 400);
        }
        
        function updateThemeColor(theme) {
            const meta = document.getElementById('theme-color-meta');
            if (meta) {
                meta.setAttribute('content', theme === 'light' ? '#faf9f7' : '#0e0e12');
            }
        }
        
        // Listen for system theme changes (affects auto mode)
        if (window.matchMedia) {
            window.matchMedia('(prefers-color-scheme: light)').addEventListener('change', (e) => {
                const pref = localStorage.getItem('cinq_theme');
                if (pref === 'auto' || !pref) {
                    const html = document.documentElement;
                    const effective = e.matches ? 'light' : 'dark';
                    html.classList.add('theme-transitioning');
                    html.setAttribute('data-theme', effective);
                    updateThemeColor(effective);
                    setTimeout(() => html.classList.remove('theme-transitioning'), 400);
                }
            });
        }
        
        // Remove theme-loading class after initial render
        requestAnimationFrame(() => {
            requestAnimationFrame(() => {
                document.documentElement.classList.remove('theme-loading');
            });
        });
        
        // ===== MOBILE KEYBOARD HANDLING =====
        function initMobileKeyboard() {
            // Use Visual Viewport API for better keyboard handling
            if ('visualViewport' in window) {
                const viewport = window.visualViewport;
                let keyboardOpen = false;
                
                viewport.addEventListener('resize', () => {
                    // Keyboard is considered open if viewport height shrinks significantly
                    const heightDiff = window.innerHeight - viewport.height;
                    const isKeyboardNowOpen = heightDiff > 150;
                    
                    if (isKeyboardNowOpen !== keyboardOpen) {
                        keyboardOpen = isKeyboardNowOpen;
                        document.body.classList.toggle('keyboard-open', keyboardOpen);
                        
                        // Scroll active input into view
                        if (keyboardOpen && document.activeElement) {
                            setTimeout(() => {
                                document.activeElement.scrollIntoView({ 
                                    behavior: 'smooth', 
                                    block: 'center' 
                                });
                            }, 100);
                        }
                    }
                });
            }
            
            // Ensure chat input stays visible when keyboard opens
            const chatInput = document.getElementById('chat-input');
            if (chatInput) {
                chatInput.addEventListener('focus', () => {
                    setTimeout(() => {
                        chatInput.scrollIntoView({ behavior: 'smooth', block: 'end' });
                    }, 300);
                });
            }
        }
        
        initMobileKeyboard();
        
        // ===== SCHEDULED MESSAGES =====
        const SCHEDULED_MESSAGES_KEY = 'cinq_scheduled_messages';
        let scheduledMessages = [];
        let scheduledCheckInterval = null;
        
        function loadScheduledMessages() {
            try {
                const stored = localStorage.getItem(SCHEDULED_MESSAGES_KEY);
                scheduledMessages = stored ? JSON.parse(stored) : [];
                // Filter out expired messages that weren't sent
                const now = Date.now();
                scheduledMessages = scheduledMessages.filter(m => m.scheduledAt > now - 60000);
                saveScheduledMessages();
            } catch (e) {
                console.error('Error loading scheduled messages:', e);
                scheduledMessages = [];
            }
            updateScheduledUI();
        }
        
        function saveScheduledMessages() {
            try {
                localStorage.setItem(SCHEDULED_MESSAGES_KEY, JSON.stringify(scheduledMessages));
            } catch (e) {
                console.error('Error saving scheduled messages:', e);
            }
        }
        
        function updateScheduledUI() {
            // Update button badge
            const countEl = document.getElementById('scheduled-count');
            const btn = document.getElementById('schedule-btn');
            const count = scheduledMessages.length;
            
            if (count > 0) {
                countEl.textContent = count;
                countEl.style.display = 'flex';
                btn.classList.add('has-scheduled');
            } else {
                countEl.style.display = 'none';
                btn.classList.remove('has-scheduled');
            }
            
            // Update chat indicator for current contact
            updateChatScheduledIndicator();
            
            // Render scheduled list in modal
            renderScheduledList();
        }
        
        function updateChatScheduledIndicator() {
            const indicator = document.getElementById('chat-scheduled-indicator');
            const textEl = document.getElementById('chat-scheduled-text');
            
            if (!currentChatContact || !indicator) return;
            
            const contactScheduled = scheduledMessages.filter(
                m => m.contactId === currentChatContact.contact_user_id
            );
            
            if (contactScheduled.length > 0) {
                indicator.classList.add('visible');
                textEl.textContent = contactScheduled.length === 1 
                    ? '1 message programmé' 
                    : `${contactScheduled.length} messages programmés`;
            } else {
                indicator.classList.remove('visible');
            }
        }
        
        function renderScheduledList() {
            const list = document.getElementById('scheduled-list');
            if (!list) return;
            
            if (scheduledMessages.length === 0) {
                list.innerHTML = '';
                return;
            }
            
            // Sort by scheduled time
            const sorted = [...scheduledMessages].sort((a, b) => a.scheduledAt - b.scheduledAt);
            
            list.innerHTML = sorted.map(msg => {
                const date = new Date(msg.scheduledAt);
                const dateStr = formatScheduledDate(date);
                const timeStr = date.toLocaleTimeString('fr-FR', { hour: '2-digit', minute: '2-digit' });
                const contactName = msg.contactName || 'Contact';
                const preview = msg.content.length > 40 ? msg.content.substring(0, 40) + '…' : msg.content;
                
                return `
                    <div class="scheduled-item" role="listitem">
                        <div class="scheduled-item-icon">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <circle cx="12" cy="12" r="10"/>
                                <polyline points="12 6 12 12 16 14"/>
                            </svg>
                        </div>
                        <div class="scheduled-item-content">
                            <div class="scheduled-item-message">${escapeHtml(preview)}</div>
                            <div class="scheduled-item-meta">
                                <span class="scheduled-item-contact">→ ${escapeHtml(contactName)}</span>
                                <span class="scheduled-item-time">
                                    <svg width="10" height="10" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <rect x="3" y="4" width="18" height="18" rx="2" ry="2"/>
                                        <line x1="16" y1="2" x2="16" y2="6"/>
                                        <line x1="8" y1="2" x2="8" y2="6"/>
                                    </svg>
                                    ${dateStr} ${timeStr}
                                </span>
                            </div>
                        </div>
                        <button class="scheduled-item-delete" onclick="deleteScheduledMessage('${msg.id}')" type="button" aria-label="Supprimer">
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/>
                            </svg>
                        </button>
                    </div>
                `;
            }).join('');
        }
        
        function formatScheduledDate(date) {
            const now = new Date();
            const tomorrow = new Date(now);
            tomorrow.setDate(tomorrow.getDate() + 1);
            
            if (date.toDateString() === now.toDateString()) {
                return "Aujourd'hui";
            } else if (date.toDateString() === tomorrow.toDateString()) {
                return "Demain";
            } else {
                return date.toLocaleDateString('fr-FR', { day: 'numeric', month: 'short' });
            }
        }
        
        function openScheduleModal() {
            const modal = document.getElementById('schedule-modal');
            const messageInput = document.getElementById('schedule-message');
            const dateInput = document.getElementById('schedule-date');
            const timeInput = document.getElementById('schedule-time');
            const charCount = document.getElementById('schedule-char-count');
            
            // Pre-fill message from chat input if available
            const chatInput = document.getElementById('chat-input');
            if (chatInput && chatInput.value.trim()) {
                messageInput.value = chatInput.value.trim();
            } else {
                messageInput.value = '';
            }
            
            // Update character counter
            const len = messageInput.value.length;
            if (charCount) {
                charCount.textContent = `${len}/280`;
                charCount.classList.remove('warning', 'error');
                if (len > 250) charCount.classList.add('error');
                else if (len > 220) charCount.classList.add('warning');
            }
            
            // Setup character counter listener if not already done
            if (!messageInput.hasAttribute('data-char-listener')) {
                messageInput.setAttribute('data-char-listener', 'true');
                messageInput.addEventListener('input', () => {
                    const l = messageInput.value.length;
                    if (charCount) {
                        charCount.textContent = `${l}/280`;
                        charCount.classList.remove('warning', 'error');
                        if (l > 250) charCount.classList.add('error');
                        else if (l > 220) charCount.classList.add('warning');
                    }
                });
            }
            
            // Set default date/time (1 hour from now)
            const defaultTime = new Date(Date.now() + 60 * 60 * 1000);
            dateInput.value = defaultTime.toISOString().split('T')[0];
            timeInput.value = defaultTime.toTimeString().slice(0, 5);
            
            // Set minimum date to today
            dateInput.min = new Date().toISOString().split('T')[0];
            
            modal.classList.add('open');
            modal.setAttribute('aria-hidden', 'false');
            messageInput.focus();
            
            renderScheduledList();
        }
        
        function closeScheduleModal() {
            const modal = document.getElementById('schedule-modal');
            modal.classList.remove('open');
            modal.setAttribute('aria-hidden', 'true');
        }
        
        function setQuickSchedule(preset) {
            const dateInput = document.getElementById('schedule-date');
            const timeInput = document.getElementById('schedule-time');
            const now = new Date();
            let target;
            
            switch (preset) {
                case '1h':
                    target = new Date(now.getTime() + 60 * 60 * 1000);
                    break;
                case '3h':
                    target = new Date(now.getTime() + 3 * 60 * 60 * 1000);
                    break;
                case 'tomorrow-9':
                    target = new Date(now);
                    target.setDate(target.getDate() + 1);
                    target.setHours(9, 0, 0, 0);
                    break;
                case 'tomorrow-20':
                    target = new Date(now);
                    target.setDate(target.getDate() + 1);
                    target.setHours(20, 0, 0, 0);
                    break;
                default:
                    return;
            }
            
            dateInput.value = target.toISOString().split('T')[0];
            timeInput.value = target.toTimeString().slice(0, 5);
            
            triggerHaptic('tap');
        }
        
        function scheduleMessage() {
            const messageInput = document.getElementById('schedule-message');
            const dateInput = document.getElementById('schedule-date');
            const timeInput = document.getElementById('schedule-time');
            
            const content = messageInput.value.trim();
            if (!content) {
                showToast({ type: 'error', message: 'Écris un message à programmer' });
                messageInput.focus();
                return;
            }
            
            if (!currentChatContact) {
                showToast({ type: 'error', message: 'Ouvre une conversation d\'abord' });
                return;
            }
            
            const dateStr = dateInput.value;
            const timeStr = timeInput.value;
            
            if (!dateStr || !timeStr) {
                showToast({ type: 'error', message: 'Choisis une date et une heure' });
                return;
            }
            
            const scheduledAt = new Date(`${dateStr}T${timeStr}`).getTime();
            
            if (scheduledAt <= Date.now()) {
                showToast({ type: 'error', message: 'Choisis un moment dans le futur' });
                return;
            }
            
            const contactName = currentChatContact.contact?.display_name || 
                               currentChatContact.contact?.email?.split('@')[0] || 
                               'Contact';
            
            const newMessage = {
                id: 'scheduled-' + Date.now() + '-' + Math.random().toString(36).substr(2, 9),
                contactId: currentChatContact.contact_user_id,
                contactName: contactName,
                content: content,
                scheduledAt: scheduledAt,
                createdAt: Date.now()
            };
            
            scheduledMessages.push(newMessage);
            saveScheduledMessages();
            updateScheduledUI();
            
            // Clear the chat input if the message came from there
            const chatInput = document.getElementById('chat-input');
            if (chatInput && chatInput.value.trim() === content) {
                chatInput.value = '';
                document.getElementById('send-btn').disabled = true;
            }
            
            closeScheduleModal();
            triggerHaptic('success');
            
            const formattedTime = new Date(scheduledAt).toLocaleString('fr-FR', {
                day: 'numeric',
                month: 'short',
                hour: '2-digit',
                minute: '2-digit'
            });
            
            showToast({ 
                type: 'success', 
                title: 'Message programmé',
                message: `Sera envoyé le ${formattedTime}`
            });
        }
        
        function deleteScheduledMessage(msgId) {
            scheduledMessages = scheduledMessages.filter(m => m.id !== msgId);
            saveScheduledMessages();
            updateScheduledUI();
            triggerHaptic('tap');
            showToast({ type: 'info', message: 'Message programmé supprimé' });
        }
        
        async function sendScheduledMessage(msg) {
            try {
                const res = await fetch(`${API_URL}/messages`, {
                    method: 'POST',
                    headers: authHeaders(),
                    body: JSON.stringify({ 
                        contact_id: msg.contactId, 
                        content: msg.content 
                    })
                });
                
                if (!res.ok) throw new Error('Échec envoi');
                
                // Remove from scheduled
                scheduledMessages = scheduledMessages.filter(m => m.id !== msg.id);
                saveScheduledMessages();
                updateScheduledUI();
                
                // Show notification
                showToast({ 
                    type: 'success', 
                    title: 'Message envoyé',
                    message: `→ ${msg.contactName}`
                });
                
                // Refresh messages if viewing this contact
                if (currentChatContact && currentChatContact.contact_user_id === msg.contactId) {
                    loadMessages();
                }
                
                return true;
            } catch (e) {
                console.error('Failed to send scheduled message:', e);
                showToast({ 
                    type: 'error', 
                    title: 'Échec d\'envoi',
                    message: `Message pour ${msg.contactName} non envoyé`
                });
                return false;
            }
        }
        
        function checkScheduledMessages() {
            const now = Date.now();
            const toSend = scheduledMessages.filter(m => m.scheduledAt <= now);
            
            toSend.forEach(msg => {
                sendScheduledMessage(msg);
            });
        }
        
        function startScheduledMessagesChecker() {
            // Check every 30 seconds
            scheduledCheckInterval = setInterval(checkScheduledMessages, 30000);
            // Also check immediately
            checkScheduledMessages();
        }
        
        function stopScheduledMessagesChecker() {
            if (scheduledCheckInterval) {
                clearInterval(scheduledCheckInterval);
                scheduledCheckInterval = null;
            }
        }
        
        // Initialize scheduled messages
        loadScheduledMessages();
        startScheduledMessagesChecker();
        
        // Update indicator when opening a chat
        const originalOpenChat = openChat;
        openChat = function(contact) {
            originalOpenChat(contact);
            setTimeout(updateChatScheduledIndicator, 100);
        };
        
        // Close modal on overlay click
        document.getElementById('schedule-modal')?.addEventListener('click', (e) => {
            if (e.target.classList.contains('modal-overlay')) {
                closeScheduleModal();
            }
        });
        
        // Close export modal on overlay click
        document.getElementById('export-modal')?.addEventListener('click', (e) => {
            if (e.target.classList.contains('modal-overlay')) {
                closeExportModal();
            }
        });
        
        // ===== HEARTBEAT (Last Seen) =====
        let heartbeatInterval = null;
        
        async function sendHeartbeat() {
            try {
                const token = getToken();
                if (!token) return;
                
                await fetch(`${API_URL}/heartbeat`, {
                    method: 'POST',
                    headers: authHeaders()
                });
            } catch (e) {
                // Silently fail - heartbeat is not critical
                console.debug('Heartbeat error:', e);
            }
        }
        
        function startHeartbeat() {
            // Send initial heartbeat
            sendHeartbeat();
            
            // Send heartbeat every 30 seconds
            heartbeatInterval = setInterval(sendHeartbeat, 30000);
            
            // Also send heartbeat on visibility change (when tab becomes active)
            document.addEventListener('visibilitychange', () => {
                if (document.visibilityState === 'visible') {
                    sendHeartbeat();
                }
            });
        }
        
        function stopHeartbeat() {
            if (heartbeatInterval) {
                clearInterval(heartbeatInterval);
                heartbeatInterval = null;
            }
        }
        
        // Start heartbeat when init completes
        const originalInit = init;
        init = async function() {
            await originalInit();
            startHeartbeat();
        };
        
        // ===== INIT =====
        init();
    </script>
    
    <script src="/pwa-install.min.js" defer></script>
    <script src="/animations.min.js" defer></script>
    <script src="/js/offline-db.min.js" defer></script>
    <script src="/js/notifications.js" defer></script>
    <script src="/js/analytics.js" defer></script>
    <script>
        // VAPID Public Key for push notifications
        window.CINQ_VAPID_PUBLIC_KEY = 'BFvUbvZkUNjbCf_lea-V2FGiVLhAdyAXaUC5CUWYlwmCkejWxefzR3rvqJI4DOj_M1Gh664VGVYRo0SEJ-94faM';
        
        // Initialize notifications when user is authenticated
        document.addEventListener('DOMContentLoaded', function() {
            if (window.CinqNotifications) {
                // Check if user is logged in (has session)
                const hasSession = localStorage.getItem('cinq_session');
                if (hasSession) {
                    window.CinqNotifications.init({
                        vapidPublicKey: window.CINQ_VAPID_PUBLIC_KEY
                    });
                }
            }
        });
    </script>
    
    <!-- i18n -->
    <script src="/js/i18n.js"></script>
    <script>
        // Update texts on language change
        window.addEventListener('i18n:loaded', updateAppTexts);
        window.addEventListener('i18n:changed', updateAppTexts);
        
        function updateAppTexts() {
            document.title = 'Cinq — ' + i18n.t('app.yourSpace');
            
            // Update nav items
            const navLabels = {
                'tab-feed': 'nav.feed',
                'tab-settings': 'nav.settings'
            };
            
            for (const [id, key] of Object.entries(navLabels)) {
                const el = document.getElementById(id);
                if (el) {
                    const label = el.querySelector('.nav-label');
                    if (label) label.textContent = i18n.t(key);
                }
            }
            
            // Update theme texts
            const themeLabel = document.querySelector('.settings-theme .setting-label');
            if (themeLabel) themeLabel.textContent = i18n.t('theme.dark');
            
            // Update logout button
            const logoutBtn = document.querySelector('.logout-btn .btn-text');
            if (logoutBtn) logoutBtn.textContent = i18n.t('nav.logout');
        }
        
        // Language switcher in header
        const langSwitcher = document.createElement('div');
        langSwitcher.id = 'app-lang-switcher';
        langSwitcher.innerHTML = `
            <style>
                #app-lang-switcher {
                    position: fixed;
                    top: var(--space-4);
                    right: calc(var(--space-4) + 50px);
                    z-index: 100;
                    display: flex;
                    gap: 4px;
                }
                #app-lang-switcher .lang-btn {
                    padding: 4px 8px;
                    background: var(--color-bg-tertiary);
                    border: 1px solid var(--color-border);
                    border-radius: var(--radius-md);
                    cursor: pointer;
                    font-size: 11px;
                    font-weight: 500;
                    color: var(--color-text-secondary);
                    transition: all 0.2s;
                }
                #app-lang-switcher .lang-btn.active {
                    background: var(--color-brand-muted);
                    border-color: var(--color-brand);
                    color: var(--color-brand);
                }
                #app-lang-switcher .lang-btn:hover {
                    background: var(--color-bg-elevated);
                    border-color: var(--color-border-active);
                }
            </style>
            <button class="lang-btn" data-lang="fr" aria-label="Français">FR</button>
            <button class="lang-btn" data-lang="en" aria-label="English">EN</button>
        `;
        document.body.appendChild(langSwitcher);
        
        langSwitcher.querySelectorAll('.lang-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                if (window.i18n) {
                    i18n.setLanguage(btn.dataset.lang);
                    langSwitcher.querySelectorAll('.lang-btn').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                }
            });
        });
        
        window.addEventListener('i18n:loaded', () => {
            const lang = i18n.getLang();
            langSwitcher.querySelectorAll('.lang-btn').forEach(b => {
                b.classList.toggle('active', b.dataset.lang === lang);
            });
        });
    </script>
    
    <!-- Easter Eggs 🥚 -->
    <script src="/js/easter-eggs.min.js" defer></script>
    <!-- View Transitions -->
    <script defer src="/js/view-transitions.min.js"></script>
</body>
</html>
