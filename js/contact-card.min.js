"use strict";!function(e){const t={width:600,height:340,padding:32,qrSize:180,avatarSize:80,borderRadius:24,profileUrlBase:"https://cinq.app/profile.html"},a={dark:{background:"#1a1a2e",backgroundGradient:null,text:"#ffffff",textSecondary:"#a0a0b8",accent:"#6366f1",qrDark:"#1a1a2e",qrLight:"#ffffff"},light:{background:"#ffffff",backgroundGradient:null,text:"#1a1a2e",textSecondary:"#6b7280",accent:"#6366f1",qrDark:"#1a1a2e",qrLight:"#ffffff"},gradient:{background:null,backgroundGradient:["#1a1a2e","#312e81"],text:"#ffffff",textSecondary:"#c4b5fd",accent:"#a855f7",qrDark:"#1a1a2e",qrLight:"#ffffff"},aurora:{background:null,backgroundGradient:["#0f172a","#1e3a5f","#312e81"],text:"#ffffff",textSecondary:"#94a3b8",accent:"#38bdf8",qrDark:"#0f172a",qrLight:"#ffffff"}};function n(e,t,a,n,r,c){e.beginPath(),e.moveTo(t+c,a),e.lineTo(t+n-c,a),e.quadraticCurveTo(t+n,a,t+n,a+c),e.lineTo(t+n,a+r-c),e.quadraticCurveTo(t+n,a+r,t+n-c,a+r),e.lineTo(t+c,a+r),e.quadraticCurveTo(t,a+r,t,a+r-c),e.lineTo(t,a+c),e.quadraticCurveTo(t,a,t+c,a),e.closePath()}async function r(r,c={}){await async function(){if(!e.QRCode)return new Promise((e,t)=>{const a=document.createElement("script");a.src="https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js",a.onload=()=>e(),a.onerror=()=>t(new Error("Failed to load QRCode library")),document.head.appendChild(a)})}();const o=a[c.theme]||a.dark,i=c.width||t.width,l=c.height||t.height,d=t.padding,s=t.qrSize,f=t.avatarSize,g=document.createElement("canvas");g.width=i,g.height=l;const h=g.getContext("2d");if(o.backgroundGradient){const e=h.createLinearGradient(0,0,i,l),t=o.backgroundGradient;t.forEach((a,n)=>{e.addColorStop(n/(t.length-1),a)}),h.fillStyle=e}else h.fillStyle=o.background;n(h,0,0,i,l,t.borderRadius),h.fill(),h.globalAlpha=.03;for(let e=0;e<5e3;e++){const e=Math.random()*i,t=Math.random()*l;h.fillStyle=Math.random()>.5?"#fff":"#000",h.fillRect(e,t,1,1)}h.globalAlpha=1,h.fillStyle=o.accent,h.fillRect(0,0,6,l);const m=`${t.profileUrlBase}?id=${encodeURIComponent(r.id)}&source=card`,u=document.createElement("canvas");await QRCode.toCanvas(u,m,{width:s,margin:1,color:{dark:o.qrDark,light:o.qrLight},errorCorrectionLevel:"M"});const p=i-d-s,y=(l-s)/2;h.fillStyle="#ffffff",n(h,p-12,y-12,s+24,s+24,16),h.fill(),h.drawImage(u,p,y,s,s);const b=i-d-s-d-d-20,v=d+16,C=v,w=d+10;if(h.save(),h.beginPath(),h.arc(C+f/2,w+f/2,f/2,0,2*Math.PI),h.closePath(),h.clip(),r.avatar_url)try{const e=await(x=r.avatar_url,new Promise((e,t)=>{const a=new Image;a.crossOrigin="anonymous",a.onload=()=>e(a),a.onerror=()=>t(new Error("Failed to load image")),a.src=x}));h.drawImage(e,C,w,f,f)}catch(e){const t=h.createLinearGradient(C,w,C+f,w+f);t.addColorStop(0,"#6366f1"),t.addColorStop(1,"#a855f7"),h.fillStyle=t,h.fillRect(C,w,f,f)}else{const e=h.createLinearGradient(C,w,C+f,w+f);e.addColorStop(0,"#6366f1"),e.addColorStop(1,"#a855f7"),h.fillStyle=e,h.fillRect(C,w,f,f)}var x;if(h.restore(),!r.avatar_url){const e=(r.display_name||"?")[0].toUpperCase();h.fillStyle="#ffffff",h.font=`bold ${.5*f}px "Space Grotesk", sans-serif`,h.textAlign="center",h.textBaseline="middle",h.fillText(e,C+f/2,w+f/2)}h.textAlign="left",h.fillStyle=o.text,h.font='bold 28px "Space Grotesk", sans-serif';const k=w+f+32,S=r.display_name||"Utilisateur";let T=S;for(;h.measureText(T).width>b&&T.length>3;)T=T.slice(0,-1);if(T!==S&&(T=T.slice(0,-2)+"..."),h.fillText(T,v,k),r.bio){h.fillStyle=o.textSecondary,h.font='400 15px "Inter", sans-serif';const e=function(e,t,a){const n=t.split(" "),r=[];let c="";for(const t of n){const n=c?`${c} ${t}`:t;e.measureText(n).width>a&&c?(r.push(c),c=t):c=n}return c&&r.push(c),r}(h,r.bio,b),t=3,a=k+24;for(let n=0;n<Math.min(e.length,t);n++){let r=e[n];n===t-1&&e.length>t&&(r=r.slice(0,-3)+"..."),h.fillText(r,v,a+20*n)}}return h.fillStyle=o.textSecondary,h.font='600 14px "Space Grotesk", sans-serif',h.textAlign="left",h.fillText("cinq.app",v,l-d),h.fillStyle=o.textSecondary,h.font='400 11px "Inter", sans-serif',h.textAlign="center",h.fillText("Scanne pour me contacter",p+s/2,l-d+4),g}async function c(e,t={}){return(await r(e,t)).toDataURL("image/png",1)}async function o(e,t={}){const a=await r(e,t);return new Promise(e=>{a.toBlob(t=>e(t),"image/png",1)})}async function i(e,t){const a=document.getElementById("card-loading"),n=document.getElementById("contact-card-image");a&&(a.style.display="flex"),n&&(n.style.display="none");try{const r=await c(e,{theme:t});n&&(n.onload=()=>{a&&(a.style.display="none"),n.style.display="block"},n.src=r);const o=document.getElementById("contact-card-modal");o&&(o.dataset.cardDataUrl=r)}catch(e){console.error("Card generation error:",e),a&&(a.innerHTML='<span style="color: var(--color-error);">❌ Erreur de génération</span>')}}async function l(){if(!document.getElementById("contact-card-modal"))return;const t=e._contactCardProfile,a=e._contactCardTheme||"dark";if(t)try{const e=await c(t,{theme:a}),n=document.createElement("a"),r=(t.display_name||"contact").replace(/[^a-z0-9]/gi,"-").toLowerCase();n.download=`cinq-card-${r}.png`,n.href=e,n.click(),"function"==typeof triggerHaptic&&triggerHaptic("success"),"function"==typeof showToast&&showToast({message:"Carte téléchargée !",type:"success"})}catch(e){console.error("Download error:",e),"function"==typeof showToast&&showToast({message:"Erreur lors du téléchargement",type:"error"})}}e.CinqContactCard={generateContactCard:r,generateContactCardDataUrl:c,generateContactCardBlob:o,showContactCardModal:async function(t){const a=document.getElementById("contact-card-modal");a&&a.remove();const n=document.createElement("div");n.id="contact-card-modal",n.className="contact-card-modal",n.innerHTML='\n            <div class="contact-card-backdrop" onclick="window.CinqContactCard.closeModal()"></div>\n            <div class="contact-card-content" role="dialog" aria-labelledby="contact-card-title" aria-modal="true">\n                <button class="contact-card-close" onclick="window.CinqContactCard.closeModal()" aria-label="Fermer">\n                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">\n                        <line x1="18" y1="6" x2="6" y2="18"></line>\n                        <line x1="6" y1="6" x2="18" y2="18"></line>\n                    </svg>\n                </button>\n                \n                <div class="contact-card-header">\n                    <h2 id="contact-card-title">Ma carte de visite</h2>\n                    <p class="contact-card-subtitle">Partage ta carte digitale</p>\n                </div>\n                \n                <div class="contact-card-preview">\n                    <div class="contact-card-loading" id="card-loading">\n                        <div class="contact-card-spinner"></div>\n                        <span>Génération de la carte...</span>\n                    </div>\n                    <img id="contact-card-image" class="contact-card-image" alt="Carte de visite" style="display: none;">\n                </div>\n                \n                <div class="contact-card-themes" id="card-themes">\n                    <span class="theme-label">Style :</span>\n                    <button class="theme-btn active" data-theme="dark" aria-label="Thème sombre">\n                        <span class="theme-preview" style="background: linear-gradient(135deg, #1a1a2e, #1a1a2e);"></span>\n                    </button>\n                    <button class="theme-btn" data-theme="gradient" aria-label="Thème gradient">\n                        <span class="theme-preview" style="background: linear-gradient(135deg, #1a1a2e, #312e81);"></span>\n                    </button>\n                    <button class="theme-btn" data-theme="aurora" aria-label="Thème aurora">\n                        <span class="theme-preview" style="background: linear-gradient(135deg, #0f172a, #38bdf8);"></span>\n                    </button>\n                    <button class="theme-btn" data-theme="light" aria-label="Thème clair">\n                        <span class="theme-preview" style="background: linear-gradient(135deg, #ffffff, #f3f4f6);"></span>\n                    </button>\n                </div>\n                \n                <div class="contact-card-actions">\n                    <button class="contact-card-btn contact-card-btn-secondary" onclick="window.CinqContactCard.downloadCard()">\n                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">\n                            <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>\n                            <polyline points="7 10 12 15 17 10"></polyline>\n                            <line x1="12" y1="15" x2="12" y2="3"></line>\n                        </svg>\n                        Télécharger PNG\n                    </button>\n                    <button class="contact-card-btn contact-card-btn-primary" onclick="window.CinqContactCard.shareCard()">\n                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">\n                            <circle cx="18" cy="5" r="3"></circle>\n                            <circle cx="6" cy="12" r="3"></circle>\n                            <circle cx="18" cy="19" r="3"></circle>\n                            <line x1="8.59" y1="13.51" x2="15.42" y2="17.49"></line>\n                            <line x1="15.41" y1="6.51" x2="8.59" y2="10.49"></line>\n                        </svg>\n                        Partager\n                    </button>\n                </div>\n            </div>\n        ',document.body.appendChild(n),n.dataset.profileId=t.id,n.dataset.displayName=t.display_name||"profile",e._contactCardProfile=t,e._contactCardTheme="dark",requestAnimationFrame(()=>{n.classList.add("contact-card-visible")});const r=n.querySelectorAll(".theme-btn");r.forEach(a=>{a.addEventListener("click",async()=>{r.forEach(e=>e.classList.remove("active")),a.classList.add("active"),e._contactCardTheme=a.dataset.theme,await i(t,a.dataset.theme)})}),await i(t,"dark");const c=n.querySelector(".contact-card-btn");c&&c.focus()},closeModal:function(){const t=document.getElementById("contact-card-modal");t&&(t.classList.remove("contact-card-visible"),setTimeout(()=>{t.remove(),delete e._contactCardProfile,delete e._contactCardTheme},300))},downloadCard:l,shareCard:async function(){const t=e._contactCardProfile,a=e._contactCardTheme||"dark";if(!t)return;const n=t.display_name||"mon profil";if(navigator.share&&navigator.canShare)try{const e=await o(t,{theme:a}),r=(t.display_name||"contact").replace(/[^a-z0-9]/gi,"-").toLowerCase(),c=new File([e],`cinq-card-${r}.png`,{type:"image/png"});if(navigator.canShare({files:[c]}))return await navigator.share({title:`Carte Cinq - ${n}`,text:"Ma carte de visite Cinq. Scanne le QR code pour me contacter !",files:[c]}),void("function"==typeof triggerHaptic&&triggerHaptic("success"))}catch(e){"AbortError"!==e.name&&console.warn("File share failed:",e)}await l()},themes:Object.keys(a),config:t}}(window);