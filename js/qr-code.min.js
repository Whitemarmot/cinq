"use strict";!function(e){const n={size:256,margin:2,darkColor:"#1a1a2e",lightColor:"#ffffff",errorCorrectionLevel:"M",profileUrlBase:"https://cinq.app/profile.html"};async function r(){if(!e.QRCode)return new Promise((e,n)=>{const r=document.createElement("script");r.src="https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js",r.onload=()=>e(),r.onerror=()=>n(new Error("Failed to load QRCode library")),document.head.appendChild(r)})}async function a(e){await r();const a={type:"cinq_contact",version:1,id:e.id,name:e.display_name,avatar:e.avatar_url||null,timestamp:Date.now()},o=`cinq://contact/${btoa(JSON.stringify(a))}`,t={width:n.size,margin:n.margin,color:{dark:n.darkColor,light:n.lightColor},errorCorrectionLevel:"M"};try{return await QRCode.toDataURL(o,t)}catch(e){throw console.error("Contact QR Code generation failed:",e),new Error("Impossible de g√©n√©rer le QR code contact")}}let o=null,t=null,i=null;async function s(n,r,a,s){try{await async function(){if(!e.jsQR)return new Promise((e,n)=>{const r=document.createElement("script");r.src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.min.js",r.onload=()=>e(),r.onerror=()=>n(new Error("Failed to load jsQR library")),document.head.appendChild(r)})}();const c={video:{facingMode:"environment",width:{ideal:1280},height:{ideal:720}}};o=await navigator.mediaDevices.getUserMedia(c),n.srcObject=o,n.setAttribute("playsinline",!0),await n.play(),i=a;const d=r.getContext("2d",{willReadFrequently:!0});function m(){if(o){if(n.readyState===n.HAVE_ENOUGH_DATA){r.width=n.videoWidth,r.height=n.videoHeight,d.drawImage(n,0,0,r.width,r.height);const e=d.getImageData(0,0,r.width,r.height),a=jsQR(e.data,e.width,e.height,{inversionAttempts:"dontInvert"});if(a&&a.data){const e=l(a.data);if(e&&i)return void i(e)}}t=requestAnimationFrame(m)}}t=requestAnimationFrame(m)}catch(u){console.error("QR Scanner error:",u),s&&("NotAllowedError"===u.name?s(new Error("Acc√®s √† la cam√©ra refus√©. Autorise l'acc√®s dans les param√®tres.")):"NotFoundError"===u.name?s(new Error("Aucune cam√©ra d√©tect√©e sur cet appareil.")):s(new Error("Impossible d'acc√©der √† la cam√©ra.")))}}function c(){t&&(cancelAnimationFrame(t),t=null),o&&(o.getTracks().forEach(e=>e.stop()),o=null),i=null}function l(e){if(e.startsWith("cinq://contact/"))try{const n=e.replace("cinq://contact/",""),r=JSON.parse(atob(n));if("cinq_contact"===r.type&&r.id)return{type:"contact",userId:r.id,displayName:r.name,avatarUrl:r.avatar,source:"qr_scan"}}catch(e){console.warn("Failed to parse cinq:// URL:",e)}if(e.includes("/profile.html?id=")||e.includes("/profile?id="))try{const n=new URL(e),r=n.searchParams.get("id"),a=n.searchParams.get("user");if(r||a)return{type:"profile",userId:r,username:a,source:"qr_scan"}}catch(e){console.warn("Failed to parse profile URL:",e)}return/^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$/i.test(e)?{type:"userId",userId:e,source:"qr_scan"}:null}function d(){c();const e=document.getElementById("qr-scanner-modal");e&&(e.classList.remove("qr-modal-visible"),setTimeout(()=>e.remove(),300))}e.CinqQR={generateProfileQRCode:async function(e,a={}){await r();const o=`${n.profileUrlBase}?id=${encodeURIComponent(e)}&source=qr`,t={width:a.size||n.size,margin:a.margin||n.margin,color:{dark:a.darkColor||n.darkColor,light:a.lightColor||n.lightColor},errorCorrectionLevel:a.errorCorrectionLevel||n.errorCorrectionLevel};try{return await QRCode.toDataURL(o,t)}catch(e){throw console.error("QR Code generation failed:",e),new Error("Impossible de g√©n√©rer le QR code")}},generateProfileQRCodeToCanvas:async function(e,a,o={}){await r();const t=`${n.profileUrlBase}?id=${encodeURIComponent(a)}&source=qr`,i={width:o.size||n.size,margin:o.margin||n.margin,color:{dark:o.darkColor||n.darkColor,light:o.lightColor||n.lightColor},errorCorrectionLevel:o.errorCorrectionLevel||n.errorCorrectionLevel};await QRCode.toCanvas(e,t,i)},generateContactQRCode:a,startQRScanner:s,stopQRScanner:c,parseQRCodeData:l,showProfileQRModal:async function(e){const n=document.getElementById("qr-modal");n&&n.remove();const r=document.createElement("div");r.id="qr-modal",r.className="qr-modal",r.innerHTML=`\n            <div class="qr-modal-backdrop" onclick="window.CinqQR.closeQRModal()"></div>\n            <div class="qr-modal-content" role="dialog" aria-labelledby="qr-modal-title" aria-modal="true">\n                <button class="qr-modal-close" onclick="window.CinqQR.closeQRModal()" aria-label="Fermer">\n                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">\n                        <line x1="18" y1="6" x2="6" y2="18"></line>\n                        <line x1="6" y1="6" x2="18" y2="18"></line>\n                    </svg>\n                </button>\n                \n                <div class="qr-modal-header">\n                    <h2 id="qr-modal-title">Mon QR Code</h2>\n                    <p class="qr-modal-subtitle">Scanne ce code pour ajouter mon profil</p>\n                </div>\n                \n                <div class="qr-code-container">\n                    <div class="qr-code-loading">\n                        <div class="qr-spinner"></div>\n                        <span>G√©n√©ration...</span>\n                    </div>\n                    <img id="qr-code-image" class="qr-code-image" alt="QR Code de profil" style="display: none;">\n                </div>\n                \n                <div class="qr-profile-info">\n                    <div class="qr-avatar">\n                        ${e.avatar_url?`<img src="${escapeHtml(e.avatar_url)}" alt="">`:`<span>${(e.display_name||"?")[0].toUpperCase()}</span>`}\n                    </div>\n                    <span class="qr-display-name">${escapeHtml(e.display_name)}</span>\n                </div>\n                \n                <div class="qr-modal-actions">\n                    <button class="qr-btn qr-btn-secondary" onclick="window.CinqQR.downloadQRCode()">\n                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">\n                            <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>\n                            <polyline points="7 10 12 15 17 10"></polyline>\n                            <line x1="12" y1="15" x2="12" y2="3"></line>\n                        </svg>\n                        T√©l√©charger\n                    </button>\n                    <button class="qr-btn qr-btn-primary" onclick="window.CinqQR.shareQRCode()">\n                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">\n                            <circle cx="18" cy="5" r="3"></circle>\n                            <circle cx="6" cy="12" r="3"></circle>\n                            <circle cx="18" cy="19" r="3"></circle>\n                            <line x1="8.59" y1="13.51" x2="15.42" y2="17.49"></line>\n                            <line x1="15.41" y1="6.51" x2="8.59" y2="10.49"></line>\n                        </svg>\n                        Partager\n                    </button>\n                </div>\n            </div>\n        `,document.body.appendChild(r),requestAnimationFrame(()=>{r.classList.add("qr-modal-visible")});try{const n=await a(e),o=document.getElementById("qr-code-image"),t=r.querySelector(".qr-code-loading");o.onload=()=>{t.style.display="none",o.style.display="block"},o.src=n,r.dataset.qrDataUrl=n,r.dataset.displayName=e.display_name}catch(e){console.error("QR generation error:",e),r.querySelector(".qr-code-loading").innerHTML=`\n                <span style="color: var(--color-error);">‚ùå ${e.message}</span>\n            `}const o=r.querySelectorAll("button");o.length>0&&o[0].focus()},closeQRModal:function(){const e=document.getElementById("qr-modal");e&&(e.classList.remove("qr-modal-visible"),setTimeout(()=>e.remove(),300))},downloadQRCode:function(){const e=document.getElementById("qr-modal");if(!e||!e.dataset.qrDataUrl)return;const n=document.createElement("a");n.download=`cinq-qr-${e.dataset.displayName||"profile"}.png`,n.href=e.dataset.qrDataUrl,n.click(),"function"==typeof triggerHaptic&&triggerHaptic("success"),"function"==typeof showToast&&showToast({message:"QR code t√©l√©charg√© !",type:"success"})},shareQRCode:async function(){const e=document.getElementById("qr-modal");if(!e||!e.dataset.qrDataUrl)return;const r=e.dataset.displayName||"mon profil";if(navigator.share&&navigator.canShare){try{const n=await fetch(e.dataset.qrDataUrl),a=await n.blob(),o=new File([a],`cinq-qr-${r}.png`,{type:"image/png"});if(navigator.canShare({files:[o]}))return await navigator.share({title:`QR Code Cinq - ${r}`,text:"Scanne ce QR code pour m'ajouter sur Cinq !",files:[o]}),void("function"==typeof triggerHaptic&&triggerHaptic("success"))}catch(e){"AbortError"!==e.name&&console.warn("File share failed, trying URL share:",e)}try{return void await navigator.share({title:`Profil Cinq - ${r}`,text:"Ajoute-moi sur Cinq !",url:`${n.profileUrlBase}?source=share`})}catch(e){if("AbortError"===e.name)return}}try{await navigator.clipboard.writeText(`${n.profileUrlBase}?source=share`),"function"==typeof showToast&&showToast({message:"Lien copi√© !",type:"success"})}catch(e){console.error("Share/copy failed:",e)}},showScannerModal:function(e){const n=document.getElementById("qr-scanner-modal");n&&(c(),n.remove());const r=document.createElement("div");r.id="qr-scanner-modal",r.className="qr-modal",r.innerHTML='\n            <div class="qr-modal-backdrop" onclick="window.CinqQR.closeScannerModal()"></div>\n            <div class="qr-modal-content qr-scanner-content" role="dialog" aria-labelledby="qr-scanner-title" aria-modal="true">\n                <button class="qr-modal-close" onclick="window.CinqQR.closeScannerModal()" aria-label="Fermer">\n                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">\n                        <line x1="18" y1="6" x2="6" y2="18"></line>\n                        <line x1="6" y1="6" x2="18" y2="18"></line>\n                    </svg>\n                </button>\n                \n                <div class="qr-modal-header">\n                    <h2 id="qr-scanner-title">Scanner un QR Code</h2>\n                    <p class="qr-modal-subtitle">Pointe la cam√©ra vers un QR code Cinq</p>\n                </div>\n                \n                <div class="qr-scanner-container">\n                    <video id="qr-scanner-video" playsinline></video>\n                    <canvas id="qr-scanner-canvas" style="display: none;"></canvas>\n                    <div class="qr-scanner-overlay">\n                        <div class="qr-scanner-frame"></div>\n                    </div>\n                    <div class="qr-scanner-status" id="qr-scanner-status">\n                        <div class="qr-spinner"></div>\n                        <span>Initialisation de la cam√©ra...</span>\n                    </div>\n                </div>\n                \n                <div class="qr-scanner-instructions">\n                    <p>üì± Demande √† ton ami d\'afficher son QR code Cinq</p>\n                </div>\n            </div>\n        ',document.body.appendChild(r),requestAnimationFrame(()=>{r.classList.add("qr-modal-visible")});const a=document.getElementById("qr-scanner-video"),o=document.getElementById("qr-scanner-canvas"),t=document.getElementById("qr-scanner-status");s(a,o,n=>{t.innerHTML='\n                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="var(--color-success)" stroke-width="2">\n                        <polyline points="20 6 9 17 4 12"></polyline>\n                    </svg>\n                    <span style="color: var(--color-success);">Contact trouv√© !</span>\n                ',"function"==typeof triggerHaptic&&triggerHaptic("success"),c(),setTimeout(()=>{d(),e&&e(n)},800)},e=>{t.innerHTML=`\n                    <span style="color: var(--color-error);">‚ùå ${e.message}</span>\n                `}),a.addEventListener("playing",()=>{t.style.display="none"})},closeScannerModal:d,config:n}}(window);