"use strict";const CinqOfflineDB=function(){const e={MESSAGES:"pending-messages",CONTACTS:"contacts-cache",ACTIONS:"pending-actions",SYNC_META:"sync-metadata"};let n=null,t=!1;async function o(){return t&&n?n:new Promise((o,r)=>{const s=indexedDB.open("cinq-offline-db",1);s.onerror=()=>{console.error("[OfflineDB] Failed to open database:",s.error),r(s.error)},s.onsuccess=()=>{n=s.result,t=!0,console.log("[OfflineDB] Database initialized"),n.onerror=e=>{console.error("[OfflineDB] Database error:",e.target.error)},n.onversionchange=()=>{n.close(),t=!1,console.log("[OfflineDB] Database version changed, please reload")},o(n)},s.onupgradeneeded=n=>{const t=n.target.result;if(console.log("[OfflineDB] Upgrading database schema..."),!t.objectStoreNames.contains(e.MESSAGES)){const n=t.createObjectStore(e.MESSAGES,{keyPath:"id",autoIncrement:!0});n.createIndex("contact_id","contact_id",{unique:!1}),n.createIndex("created_at","created_at",{unique:!1}),n.createIndex("status","status",{unique:!1})}if(!t.objectStoreNames.contains(e.CONTACTS)){const n=t.createObjectStore(e.CONTACTS,{keyPath:"id"});n.createIndex("email","email",{unique:!0}),n.createIndex("cached_at","cached_at",{unique:!1})}if(!t.objectStoreNames.contains(e.ACTIONS)){const n=t.createObjectStore(e.ACTIONS,{keyPath:"id",autoIncrement:!0});n.createIndex("type","type",{unique:!1}),n.createIndex("created_at","created_at",{unique:!1}),n.createIndex("priority","priority",{unique:!1})}t.objectStoreNames.contains(e.SYNC_META)||t.createObjectStore(e.SYNC_META,{keyPath:"key"})}})}function r(e,t="readonly"){if(!n)throw new Error("Database not initialized");return n.transaction(e,t)}function s(e,n="readonly"){return r(e,n).objectStore(e)}async function i(){return await o(),new Promise((n,t)=>{const o=s(e.MESSAGES).index("status").getAll("pending");o.onsuccess=()=>n(o.result),o.onerror=()=>t(o.error)})}async function a(){return await o(),new Promise((n,t)=>{const o=s(e.MESSAGES).index("status").count("pending");o.onsuccess=()=>n(o.result),o.onerror=()=>t(o.error)})}async function c(n,t,r={}){return await o(),new Promise((o,i)=>{const a=s(e.MESSAGES,"readwrite"),c=a.get(n);c.onsuccess=()=>{const e=c.result;if(!e)return void i(new Error("Message not found"));const s={...e,...r,status:t,updated_at:(new Date).toISOString()},d=a.put(s);d.onsuccess=()=>{S("message-status-changed",{id:n,status:t}),o()},d.onerror=()=>i(d.error)},c.onerror=()=>i(c.error)})}async function d(n){return await o(),new Promise((t,o)=>{const r=s(e.MESSAGES,"readwrite").delete(n);r.onsuccess=()=>{S("message-removed",{id:n}),t()},r.onerror=()=>o(r.error)})}async function u(){return await o(),new Promise((n,t)=>{const o=s(e.ACTIONS).index("status").getAll("pending");o.onsuccess=()=>{const e=o.result.sort((e,n)=>e.priority-n.priority);n(e)},o.onerror=()=>t(o.error)})}async function l(n){return await o(),new Promise((t,o)=>{const r=s(e.ACTIONS,"readwrite").delete(n);r.onsuccess=()=>t(),r.onerror=()=>o(r.error)})}async function f(n){return await o(),new Promise((t,o)=>{const r=s(e.SYNC_META).get(n);r.onsuccess=()=>t(r.result?.value),r.onerror=()=>o(r.error)})}async function g(e){if("serviceWorker"in navigator&&(window.SyncManager,1))try{const n=await navigator.serviceWorker.ready;await n.sync.register(e),console.log("[OfflineDB] Sync registered:",e)}catch(e){console.warn("[OfflineDB] Sync registration failed:",e)}else console.log("[OfflineDB] Background sync not supported")}function S(e,n){window.dispatchEvent(new CustomEvent(`cinq-offline:${e}`,{detail:n}))}async function y(){const e=await i(),n={sent:0,failed:0};if(0===e.length)return console.log("[OfflineDB] No messages to sync"),n;console.log(`[OfflineDB] Syncing ${e.length} messages...`);for(const t of e)try{await c(t.id,"sending");const e=await(window.Cinq?.getAccessToken());if(!e)throw new Error("No auth token");const o=await fetch("/.netlify/functions/messages",{method:"POST",headers:{Authorization:`Bearer ${e}`,"Content-Type":"application/json"},body:JSON.stringify({contact_id:t.contact_id,content:t.content,is_ping:t.is_ping})}),r=await o.json();if(!r.success)throw new Error(r.error||"Failed to send");await d(t.id),n.sent++,S("message-sent",{id:t.id,serverMessage:r.message})}catch(e){console.error("[OfflineDB] Failed to send message:",t.id,e),await c(t.id,"pending",{retries:t.retries+1,last_error:e.message}),n.failed++}return console.log("[OfflineDB] Sync complete:",n),S("sync-complete",{type:"messages",results:n}),n}async function p(){const e=await u(),n={success:0,failed:0};if(0===e.length)return n;console.log(`[OfflineDB] Syncing ${e.length} actions...`);for(const t of e)try{const e=await(window.Cinq?.getAccessToken()),o={"Content-Type":"application/json"};e&&(o.Authorization=`Bearer ${e}`);const r=await fetch(t.endpoint,{method:t.method,headers:o,body:t.body?JSON.stringify(t.body):null});if(!r.ok)throw new Error(`HTTP ${r.status}`);await l(t.id),n.success++}catch(e){console.error("[OfflineDB] Action failed:",t.id,e),n.failed++}return n}async function w(){await o();const[e,n,t]=await Promise.all([a(),u().then(e=>e.length),f("lastSuccessfulSync")]);return{pendingMessages:e,pendingActions:n,lastSync:t,isOnline:navigator.onLine}}async function m(){const e=await w(),n=e.pendingMessages+e.pendingActions;if(0===n){const e=document.getElementById("offline-queue-indicator");return void(e&&e.classList.add("hidden"))}const t=function(){let e=document.getElementById("offline-queue-indicator");if(!e){e=document.createElement("div"),e.id="offline-queue-indicator",e.className="offline-queue-indicator",e.innerHTML='\n        <span class="offline-queue-icon">ðŸ“¤</span>\n        <span class="offline-queue-count">0</span>\n        <span class="offline-queue-text">en attente</span>\n      ',document.body.appendChild(e);const n=document.createElement("style");n.textContent="\n        .offline-queue-indicator {\n          position: fixed;\n          top: 16px;\n          right: 16px;\n          background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);\n          color: white;\n          padding: 8px 12px;\n          border-radius: 20px;\n          font-size: 13px;\n          font-weight: 500;\n          display: flex;\n          align-items: center;\n          gap: 6px;\n          z-index: 9999;\n          box-shadow: 0 4px 12px rgba(0,0,0,0.3);\n          animation: slideIn 0.3s ease-out;\n          cursor: pointer;\n        }\n        .offline-queue-indicator.syncing {\n          background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);\n        }\n        .offline-queue-indicator.syncing .offline-queue-icon {\n          animation: spin 1s linear infinite;\n        }\n        @keyframes slideIn {\n          from { transform: translateX(100%); opacity: 0; }\n          to { transform: translateX(0); opacity: 1; }\n        }\n        @keyframes spin {\n          from { transform: rotate(0deg); }\n          to { transform: rotate(360deg); }\n        }\n        .offline-queue-indicator.hidden {\n          display: none;\n        }\n      ",document.head.appendChild(n)}return e}();t.classList.remove("hidden"),t.querySelector(".offline-queue-count").textContent=n,t.querySelector(".offline-queue-text").textContent="en attente"}return window.addEventListener("online",async()=>{console.log("[OfflineDB] Back online, triggering sync..."),await y(),await p(),await m()}),window.addEventListener("offline",()=>{console.log("[OfflineDB] Gone offline"),m()}),"serviceWorker"in navigator&&navigator.serviceWorker.addEventListener("message",async e=>{const{type:n}=e.data||{};if("SYNC_MESSAGES"===n){const n=await y();e.ports?.[0]?.postMessage({results:n})}if("SYNC_ACTIONS"===n){const n=await p();e.ports?.[0]?.postMessage({results:n})}"SYNC_STATUS"===n&&await m()}),{init:o,queueMessage:async function(n){await o();const t={contact_id:n.contact_id,content:n.content||null,is_ping:n.is_ping||!1,status:"pending",created_at:(new Date).toISOString(),retries:0,last_error:null};return new Promise((n,o)=>{const r=s(e.MESSAGES,"readwrite").add(t);r.onsuccess=()=>{const e=r.result;console.log("[OfflineDB] Message queued:",e),g("sync-messages"),S("message-queued",{id:e,...t}),n(e)},r.onerror=()=>o(r.error)})},getPendingMessages:i,getQueuedCount:a,updateMessageStatus:c,removeSentMessage:d,clearSentMessages:async function(){return await o(),new Promise((n,t)=>{const o=s(e.MESSAGES,"readwrite").index("status").openCursor("sent");o.onsuccess=e=>{const t=e.target.result;t?(t.delete(),t.continue()):n()},o.onerror=()=>t(o.error)})},cacheContacts:async function(n){await o();const t=(new Date).toISOString();return new Promise((o,s)=>{const i=r(e.CONTACTS,"readwrite"),a=i.objectStore(e.CONTACTS);a.clear(),n.forEach(e=>{a.add({...e,cached_at:t})}),i.oncomplete=()=>{console.log("[OfflineDB] Contacts cached:",n.length),o()},i.onerror=()=>s(i.error)})},getCachedContacts:async function(){return await o(),new Promise((n,t)=>{const o=s(e.CONTACTS).getAll();o.onsuccess=()=>n(o.result),o.onerror=()=>t(o.error)})},queueAction:async function(n){await o();const t={type:n.type,endpoint:n.endpoint,method:n.method||"POST",body:n.body||null,priority:n.priority||5,created_at:(new Date).toISOString(),status:"pending",retries:0};return new Promise((o,r)=>{const i=s(e.ACTIONS,"readwrite").add(t);i.onsuccess=()=>{const e=i.result;g("sync-actions"),S("action-queued",{id:e,type:n.type}),o(e)},i.onerror=()=>r(i.error)})},getPendingActions:u,removeAction:l,setSyncMeta:async function(n,t){return await o(),new Promise((o,r)=>{const i=s(e.SYNC_META,"readwrite").put({key:n,value:t,updated_at:(new Date).toISOString()});i.onsuccess=()=>o(),i.onerror=()=>r(i.error)})},getSyncMeta:f,syncMessages:y,syncActions:p,registerSync:g,getStatus:w,updateQueueIndicator:m,STORES:e}}();window.CinqOfflineDB=CinqOfflineDB;