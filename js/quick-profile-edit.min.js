 'use strict'; const QuickProfileEdit = (function() { const CONFIG = { maxBioLength: 160, successCloseDelay: 1500, let overlay = null; let currentProfile = null; let onUpdateCallback = null; function haptic(type = 'medium') { if (!CONFIG.enableHaptics) return; try { if (window.navigator && window.navigator.vibrate) { const patterns = { light: [10], medium: [20], heavy: [30], success: [20, 50, 20] }; window.navigator.vibrate(patterns[type] || [20]); } } catch (e) { } } function createModal() { overlay = document.createElement('div'); overlay.className = 'quick-profile-overlay'; overlay.setAttribute('aria-hidden', 'true'); modal = document.createElement('div'); modal.className = 'quick-profile-modal'; modal.setAttribute('role', 'dialog'); modal.setAttribute('aria-modal', 'true'); modal.setAttribute('aria-labelledby', 'quick-profile-title'); modal.innerHTML = ` <!-- Form View --> <div class="quick-profile-form-view"> <header class="quick-profile-header"> <h2 class="quick-profile-title" id="quick-profile-title"> <span class="quick-profile-title-icon">✏️</span> Modifier le profil </h2> <button class="quick-profile-close" aria-label="Fermer" data-action="close"> <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"> <path d="M18 6L6 18M6 6l12 12"/> </svg> </button> </header> <div class="quick-profile-content"> <!-- Avatar Section --> <div class="quick-profile-avatar-section"> <div class="quick-profile-avatar-wrapper"> <div class="quick-profile-avatar" id="qpe-avatar" data-action="toggle-emoji-picker"> <span id="qpe-avatar-display">?</span> </div> <button class="quick-profile-avatar-edit" data-action="toggle-emoji-picker" aria-label="Changer l'avatar"> <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"> <path d="M11 4H4a2 2 0 00-2 2v14a2 2 0 002 2h14a2 2 0 002-2v-7"/> <path d="M18.5 2.5a2.121 2.121 0 013 3L12 15l-4 1 1-4 9.5-9.5z"/> </svg> </button> </div> <span class="quick-profile-avatar-hint">Clique pour changer</span> <!-- Emoji Picker --> <div class="quick-profile-emoji-picker" id="qpe-emoji-picker" role="listbox" aria-label="Choisir un emoji"> ${CONFIG.avatarEmojis.map(emoji => ` <button class="quick-profile-emoji-btn" data-emoji="${emoji}" role="option" aria-label="${emoji}"> ${emoji} </button> `).join('')} </div> </div> <!-- Name Field --> <div class="quick-profile-field"> <label class="quick-profile-label" for="qpe-name">Nom d'affichage</label> <input type="text" class="quick-profile-input" id="qpe-name" name="display_name" placeholder="Comment veux-tu t'appeler ?" maxlength="${CONFIG.maxNameLength}" autocomplete="nickname" > <span class="quick-profile-char-count" id="qpe-name-count">0/${CONFIG.maxNameLength}</span> </div> <!-- Bio Field --> <div class="quick-profile-field"> <label class="quick-profile-label" for="qpe-bio">Bio</label> <textarea class="quick-profile-input quick-profile-textarea" id="qpe-bio" name="bio" placeholder="Décris-toi en quelques mots..." maxlength="${CONFIG.maxBioLength}" ></textarea> <span class="quick-profile-char-count" id="qpe-bio-count">0/${CONFIG.maxBioLength}</span> </div> </div> <footer class="quick-profile-footer"> <button class="quick-profile-btn quick-profile-btn-cancel" data-action="close"> Annuler </button> <button class="quick-profile-btn quick-profile-btn-save" id="qpe-save" data-action="save"> <span class="btn-text">Enregistrer</span> </button> </footer> </div> <!-- Success View --> <div class="quick-profile-success" id="qpe-success"> <div class="quick-profile-success-icon">✓</div> <p class="quick-profile-success-text">Profil mis à jour !</p> <p class="quick-profile-success-subtext">Tes modifications sont enregistrées.</p> </div> `; document.body.appendChild(overlay); document.body.appendChild(modal); bindEvents(); } function bindEvents() { overlay.addEventListener('click', close); modal.addEventListener('click', (e) => { const action = e.target.closest('[data-action]')?.getAttribute('data-action'); switch(action) { case 'close': close(); break; case 'toggle-emoji-picker': toggleEmojiPicker(); break; case 'save': save(); break; } const emoji = e.target.closest('[data-emoji]')?.getAttribute('data-emoji'); if (emoji) { selectEmoji(emoji); } }); const nameInput = modal.querySelector('#qpe-name'); const bioInput = modal.querySelector('#qpe-bio'); nameInput.addEventListener('input', () => updateCharCount('name', nameInput.value.length)); bioInput.addEventListener('input', () => updateCharCount('bio', bioInput.value.length)); document.addEventListener('keydown', handleKeydown); } function handleKeydown(e) { if (!modal || !modal.classList.contains('active')) return; if (e.key === 'Escape') { e.preventDefault(); close(); } if ((e.ctrlKey || e.metaKey) && e.key === 'Enter') { e.preventDefault(); save(); } } function toggleEmojiPicker() { const picker = modal.querySelector('#qpe-emoji-picker'); picker.classList.toggle('active'); haptic('light'); } function selectEmoji(emoji) { const display = modal.querySelector('#qpe-avatar-display'); display.textContent = emoji; modal.querySelectorAll('.quick-profile-emoji-btn').forEach(btn => { btn.classList.toggle('selected', btn.getAttribute('data-emoji') === emoji); }); const picker = modal.querySelector('#qpe-emoji-picker'); picker.classList.remove('active'); haptic('medium'); } function updateCharCount(field, count) { const max = field === 'name' ? CONFIG.maxNameLength : CONFIG.maxBioLength; const countEl = modal.querySelector(`#qpe-${field}-count`); countEl.textContent = `${count}/${max}`; countEl.classList.remove('warning', 'error'); if (count >= max) { countEl.classList.add('error'); } else if (count >= max * 0.9) { countEl.classList.add('warning'); } } function showSuccess() { const formView = modal.querySelector('.quick-profile-form-view'); const successView = modal.querySelector('#qpe-success'); formView.style.display = 'none'; successView.classList.add('active'); haptic('success'); setTimeout(() => { close(); }, CONFIG.successCloseDelay); } function resetModal() { const formView = modal.querySelector('.quick-profile-form-view'); const successView = modal.querySelector('#qpe-success'); formView.style.display = ''; successView.classList.remove('active'); modal.querySelector('#qpe-emoji-picker').classList.remove('active'); } function setLoading(loading) { const saveBtn = modal.querySelector('#qpe-save'); const btnText = saveBtn.querySelector('.btn-text'); isSaving = loading; saveBtn.disabled = loading; if (loading) { btnText.innerHTML = '<span class="spinner"></span>'; } else { btnText.textContent = 'Enregistrer'; } } async function save() { if (isSaving) return; const nameInput = modal.querySelector('#qpe-name'); const bioInput = modal.querySelector('#qpe-bio'); const avatarDisplay = modal.querySelector('#qpe-avatar-display'); const updates = { display_name: nameInput.value.trim(), bio: bioInput.value.trim(), avatar_emoji: avatarDisplay.textContent.trim() }; if (!updates.display_name) { nameInput.focus(); nameInput.classList.add('error'); setTimeout(() => nameInput.classList.remove('error'), 1000); return; } setLoading(true); try { if (typeof UserProfile !== 'undefined' && UserProfile.updateProfile) { await UserProfile.updateProfile(updates); } else { const token = await getAccessToken(); if (!token) { throw new Error('Non authentifié'); } const response = await fetch('/.netlify/functions/user-profile', { method: 'PATCH', headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` }, body: JSON.stringify(updates) }); const data = await response.json(); if (!response.ok || !data.success) { throw new Error(data.error || 'Erreur lors de la sauvegarde'); } } currentProfile = { ...currentProfile, ...updates }; if (onUpdateCallback) { onUpdateCallback(currentProfile); } updatePageAvatars(updates); showSuccess(); } catch (err) { console.error('Quick Profile Edit error:', err); const footer = modal.querySelector('.quick-profile-footer'); const existingError = footer.querySelector('.error-msg'); if (existingError) existingError.remove(); const errorEl = document.createElement('p'); errorEl.className = 'error-msg'; errorEl.style.cssText = 'color: var(--color-error, #ef4444); font-size: 0.875rem; text-align: center; width: 100%; margin-bottom: 0.5rem;'; errorEl.textContent = err.message || 'Erreur lors de la sauvegarde'; footer.prepend(errorEl); setTimeout(() => errorEl.remove(), 3000); } finally { setLoading(false); } } async function getAccessToken() { if (typeof UserProfile !== 'undefined' && UserProfile.getSession) { const session = UserProfile.getSession(); return session?.access_token || null; } if (typeof window.Cinq !== 'undefined' && window.Cinq.getAccessToken) { return await window.Cinq.getAccessToken(); } try { const storageKey = 'sb-guioxfulihyehrwytxce-auth-token'; const stored = localStorage.getItem(storageKey); if (stored) { const parsed = JSON.parse(stored); return parsed?.access_token || null; } } catch (e) { } return null; } function updatePageAvatars(updates) { const headerAvatar = document.querySelector('.header-profile-avatar'); if (headerAvatar && updates.avatar_emoji) { const display = headerAvatar.querySelector('span:not(.edit-hint)') || headerAvatar; if (!headerAvatar.querySelector('img')) { display.textContent = updates.avatar_emoji; } } const composerAvatar = document.querySelector('.composer-avatar'); if (composerAvatar && updates.avatar_emoji) { composerAvatar.textContent = updates.avatar_emoji; } if (updates.display_name) { document.querySelectorAll('.composer-user, .current-user-name').forEach(el => { el.textContent = updates.display_name; }); } } function open(profile = {}, options = {}) { if (!modal) { createModal(); } resetModal(); currentProfile = profile; onUpdateCallback = options.onUpdate || null; const nameInput = modal.querySelector('#qpe-name'); const bioInput = modal.querySelector('#qpe-bio'); const avatarDisplay = modal.querySelector('#qpe-avatar-display'); nameInput.value = profile.display_name || ''; bioInput.value = profile.bio || ''; avatarDisplay.textContent = profile.avatar_emoji || getInitial(profile.display_name || profile.email || '?'); updateCharCount('name', nameInput.value.length); updateCharCount('bio', bioInput.value.length); modal.querySelectorAll('.quick-profile-emoji-btn').forEach(btn => { btn.classList.toggle('selected', btn.getAttribute('data-emoji') === profile.avatar_emoji); }); overlay.classList.add('active'); modal.classList.add('active'); document.body.style.overflow = 'hidden'; setTimeout(() => nameInput.focus(), 100); haptic('light'); } function close() { if (!modal) return; overlay.classList.remove('active'); modal.classList.remove('active'); document.body.style.overflow = ''; haptic('light'); } function getInitial(str) { if (!str) return '?'; return str.charAt(0).toUpperCase(); } function init() { document.querySelectorAll('.header-profile-avatar').forEach(avatar => { avatar.addEventListener('click', async (e) => { e.preventDefault(); let profile = {}; if (typeof UserProfile !== 'undefined') { try { profile = await UserProfile.loadProfile(); } catch (err) { profile = UserProfile.profile || {}; } } open(profile); }); }); } if (document.readyState === 'loading') { document.addEventListener('DOMContentLoaded', init); } else { init(); } return { open, close, init }; })(); if (typeof module !== 'undefined' && module.exports) { module.exports = QuickProfileEdit; } 