"use strict";const CinqDrafts=function(){const t="cinq_drafts";let e=[],n=null,o=null,i=!1;function l(){try{e.length>10&&(e=e.slice(0,10)),localStorage.setItem(t,JSON.stringify(e))}catch(t){console.error("[Drafts] Failed to save drafts:",t)}}function s(t){const o=(new Date).toISOString();if(n){const i=e.findIndex(t=>t.id===n);if(i>=0)return e[i]={...e[i],...t,updatedAt:o},l(),e[i]}const i={id:"draft_"+Date.now()+"_"+Math.random().toString(36).substr(2,9),content:t.content||"",imageUrl:t.imageUrl||null,gifUrl:t.gifUrl||null,poll:t.poll||null,createdAt:o,updatedAt:o};return e.unshift(i),n=i.id,l(),m(),i}function a(t){e=e.filter(e=>e.id!==t),n===t&&(n=null),l(),m(),i&&g()}function r(t){return e.find(e=>e.id===t)||null}function c(){const t=document.getElementById("post-content")?.value||"",e=document.getElementById("preview-img"),n=document.getElementById("gif-preview-img"),o=e?.src&&e.src!==window.location.href?e.src:null,i=n?.src&&n.src!==window.location.href?n.src:null;let l=null;const s=document.getElementById("poll-composer");if(s&&s.classList.contains("visible")){const t=[];document.querySelectorAll("#poll-options-list .poll-option-input input").forEach(e=>{e.value.trim()&&t.push(e.value.trim())}),t.length>=2&&(l={options:t})}return{content:t,imageUrl:o,gifUrl:i,poll:l}}function d(t){const e=document.getElementById("post-content"),o=document.getElementById("image-preview"),i=document.getElementById("preview-img"),l=document.getElementById("gif-preview"),s=document.getElementById("gif-preview-img"),a=document.getElementById("char-count"),r=document.getElementById("post-btn");if(e&&(e.value=t.content||"",e.dispatchEvent(new Event("input"))),a){const e=(t.content||"").length;a.textContent=`${e}/1000`,a.classList.toggle("warning",e>900),a.classList.toggle("error",e>1e3)}if(r&&(r.disabled=!(t.content&&t.content.trim())),t.imageUrl&&i&&o?(i.src=t.imageUrl,o.style.display="block",l&&(l.style.display="none")):o&&(o.style.display="none"),t.gifUrl&&s&&l?(s.src=t.gifUrl,l.style.display="block",o&&(o.style.display="none"),void 0!==window.selectedGif&&(window.selectedGif={url:t.gifUrl})):l&&(l.style.display="none",void 0!==window.selectedGif&&(window.selectedGif=null)),t.poll&&t.poll.options){const e=document.getElementById("poll-composer"),n=document.getElementById("poll-btn");if(e){e.classList.add("visible"),n&&n.classList.add("active");const o=document.getElementById("poll-options-list");o&&(o.innerHTML="",t.poll.options.forEach((t,e)=>{const n=document.createElement("div");var i;n.className="poll-option-input",n.dataset.index=e,n.innerHTML=`\n              <span class="poll-option-number">${e+1}</span>\n              <input type="text" placeholder="Option ${e+1}" maxlength="100" value="${i=t,String(i).replace(/&/g,"&amp;").replace(/"/g,"&quot;").replace(/'/g,"&#39;").replace(/</g,"&lt;").replace(/>/g,"&gt;")}">\n              ${e>=2?'<button class="poll-remove-option" onclick="removePollOption(this)" aria-label="Supprimer">Ã—</button>':""}\n            `,o.appendChild(n)}))}}n=t.id}function u(){o&&clearTimeout(o),o=setTimeout(()=>{const t=c();(t.content.trim()||t.imageUrl||t.gifUrl||t.poll)&&(s(t),function(){const t=document.getElementById("autosave-indicator");t&&(t.classList.add("visible"),setTimeout(()=>{t.classList.remove("visible")},1500))}())},1e3)}function m(){const t=document.getElementById("drafts-btn"),n=document.getElementById("drafts-count");if(t&&n){const t=e.length;n.textContent=t,n.style.display=t>0?"flex":"none"}}function p(){const t=document.getElementById("drafts-modal");t&&(t.classList.add("open"),document.body.style.overflow="hidden",i=!0,g())}function f(){const t=document.getElementById("drafts-modal");t&&(t.classList.remove("open"),document.body.style.overflow="",i=!1)}function g(){const t=document.getElementById("drafts-list");t&&(0!==e.length?t.innerHTML=e.map((t,e)=>{t.imageUrl||t.gifUrl;const o=t.poll&&t.poll.options;let i="";t.imageUrl?i='<span class="draft-media-indicator" title="Avec image">ğŸ“·</span>':t.gifUrl&&(i='<span class="draft-media-indicator" title="Avec GIF">GIF</span>'),o&&(i+='<span class="draft-media-indicator" title="Avec sondage">ğŸ“Š</span>');const l=t.id===n;return`\n        <div class="draft-item ${l?"active":""}" data-draft-id="${t.id}" style="animation-delay: ${.05*e}s;">\n          <div class="draft-item-content" onclick="CinqDrafts.restoreDraft('${t.id}')">\n            <div class="draft-item-preview">\n              ${function(t){const e=document.createElement("div");return e.textContent=t,e.innerHTML}(function(t,e=100){return!t||t.length<=e?t||"":t.substring(0,e).trim()+"..."}(t.content,120))||'<em style="opacity: 0.5;">Post vide</em>'}\n            </div>\n            <div class="draft-item-meta">\n              <span class="draft-item-time">${function(t){const e=new Date(t),n=new Date,o=Math.floor((n-e)/1e3);return o<60?"Ã€ l'instant":o<3600?`Il y a ${Math.floor(o/60)} min`:o<86400?`Il y a ${Math.floor(o/3600)}h`:o<604800?`Il y a ${Math.floor(o/86400)}j`:e.toLocaleDateString("fr-FR",{day:"numeric",month:"short"})}(t.updatedAt)}</span>\n              ${i}\n              ${l?'<span class="draft-active-badge">En cours</span>':""}\n            </div>\n          </div>\n          <button \n            class="draft-item-delete" \n            onclick="event.stopPropagation(); CinqDrafts.deleteDraft('${t.id}')" \n            aria-label="Supprimer ce brouillon"\n            title="Supprimer"\n          >\n            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">\n              <polyline points="3 6 5 6 21 6"></polyline>\n              <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>\n            </svg>\n          </button>\n        </div>\n      `}).join(""):t.innerHTML='\n        <div class="drafts-empty">\n          <div class="drafts-empty-icon">ğŸ“</div>\n          <div class="drafts-empty-title">Aucun brouillon</div>\n          <div class="drafts-empty-text">\n            Tes posts non publiÃ©s seront sauvegardÃ©s automatiquement ici.\n          </div>\n        </div>\n      ')}return{init:function(){!function(){try{const n=localStorage.getItem(t);return e=n?JSON.parse(n):[],e=e.filter(t=>t&&t.content&&t.content.trim()),e}catch(t){return console.error("[Drafts] Failed to load drafts:",t),e=[],[]}}(),m();const n=document.getElementById("post-content");n&&n.addEventListener("input",u);const o=document.getElementById("drafts-modal");o&&o.addEventListener("click",t=>{t.target===o&&f()}),document.addEventListener("keydown",t=>{"Escape"===t.key&&i&&f(),t.ctrlKey&&t.shiftKey&&"D"===t.key&&(t.preventDefault(),p())}),console.log("[Drafts] Module initialized with",e.length,"drafts")},saveDraft:s,deleteDraft:a,getDrafts:function(){return e},getDraft:r,clearCurrentDraft:function(){n&&a(n),n=null},openModal:p,closeModal:f,restoreDraft:function(t){const e=r(t);e&&(d(e),f(),setTimeout(()=>{document.getElementById("post-content")?.focus()},100),"function"==typeof showToast&&showToast({type:"success",message:"ğŸ“ Brouillon restaurÃ©"}))},scheduleAutosave:u,getComposerState:c}}();"loading"===document.readyState?document.addEventListener("DOMContentLoaded",()=>CinqDrafts.init()):CinqDrafts.init();